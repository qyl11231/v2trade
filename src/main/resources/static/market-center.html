<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæƒ…ä¸­å¿ƒ - V2 Trade</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.9.21/dist/css/layui.css">
    <!-- TradingView Lightweight Charts - Professional Trading Terminal Chart Library -->
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js" 
            onerror="console.error('LightweightChartsåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')"></script>
    <!-- SockJS and STOMP.js for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #0b0e14;
            color: #eaecef;
            height: 100vh;
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨å…¨å±€Header */
        .global-header {
            background: #161a1e;
            border-bottom: 1px solid #2a2e34;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
            flex-shrink: 0;
        }
        
        .global-header .logo {
            font-size: 16px;
            font-weight: 700;
            color: #f0b90b;
            letter-spacing: 0.5px;
        }
        
        .global-header-stats {
            display: flex;
            gap: 24px;
            font-size: 12px;
        }
        
        .global-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .global-stat-label {
            color: #848e9c;
            font-size: 11px;
        }
        
        .global-stat-value {
            color: #eaecef;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        /* ä¸»å®¹å™¨å¸ƒå±€ */
        .main-container {
            display: grid;
            grid-template-columns: 240px 1fr 300px;
            height: calc(100vh - 48px);
            gap: 1px;
            background: #2a2e34;
        }
        
        .panel {
            background: #161a1e;
            overflow: hidden;
        }
        
        /* ========== å·¦ä¾§ Trading Pairs ========== */
        .symbols-panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2a2e34;
        }
        
        .symbols-header {
            padding: 16px 16px 12px;
            border-bottom: 1px solid #2a2e34;
            background: #1a1e23;
        }
        
        .symbols-header-title {
            font-size: 12px;
            color: #848e9c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .symbols-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .symbols-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .symbols-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .symbols-list::-webkit-scrollbar-thumb {
            background: #2a2e34;
            border-radius: 2px;
        }
        
        .symbols-list::-webkit-scrollbar-thumb:hover {
            background: #3a3e44;
        }
        
        .symbol-item {
            padding: 12px;
            margin-bottom: 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }
        
        .symbol-item:hover {
            background: #1e2228;
        }
        
        .symbol-item.active {
            background: #1e2228;
            border-left: 3px solid #f0b90b;
        }
        
        .symbol-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #f0b90b;
        }
        
        .symbol-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        
        .symbol-name {
            font-weight: 600;
            font-size: 13px;
            color: #eaecef;
            flex: 1;
            min-width: 0;
        }
        
        .symbol-item.active .symbol-name {
            color: #f0b90b;
            font-weight: 700;
        }
        
        .symbol-price {
            font-size: 13px;
            font-weight: 600;
            color: #eaecef;
            font-variant-numeric: tabular-nums;
            text-align: right;
        }
        
        .symbol-change {
            font-size: 12px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 3px;
            min-width: 65px;
            text-align: right;
            font-variant-numeric: tabular-nums;
            flex-shrink: 0;
        }
        
        .symbol-change.up {
            color: #0ecb81;
            background: rgba(14, 203, 129, 0.15);
        }
        
        .symbol-change.down {
            color: #f6465d;
            background: rgba(246, 70, 93, 0.15);
        }
        
        .symbol-item.active .symbol-change.up {
            background: rgba(14, 203, 129, 0.25);
            color: #0ecb81;
        }
        
        .symbol-item.active .symbol-change.down {
            background: rgba(246, 70, 93, 0.25);
            color: #f6465d;
        }
        
        
        /* ========== ä¸­å¤® Chart Section ========== */
        .chart-panel {
            display: flex;
            flex-direction: column;
            background: #161a1e;
        }
        
        /* Chart Header */
        .chart-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2e34;
            background: #1a1e23;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .chart-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .chart-symbol-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }
        
        .chart-symbol {
            font-size: 24px;
            font-weight: 700;
            color: #eaecef;
            letter-spacing: 0.3px;
        }
        
        .chart-price {
            font-size: 20px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .chart-price.up {
            color: #0ecb81;
        }
        
        .chart-price.down {
            color: #f6465d;
        }
        
        .chart-change {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            font-variant-numeric: tabular-nums;
        }
        
        .chart-change.up {
            color: #0ecb81;
            background: rgba(14, 203, 129, 0.15);
        }
        
        .chart-change.down {
            color: #f6465d;
            background: rgba(246, 70, 93, 0.15);
        }
        
        .timeframe-selector {
            display: flex;
            gap: 2px;
            background: #0b0e14;
            padding: 2px;
            border-radius: 4px;
            border: 1px solid #2a2e34;
        }
        
        .timeframe-btn {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.15s ease;
            color: #848e9c;
            background: transparent;
            border: none;
            font-family: inherit;
        }
        
        .timeframe-btn:hover {
            color: #eaecef;
            background: #1e2228;
        }
        
        .timeframe-btn.active {
            color: #eaecef;
            background: #2a2e34;
            box-shadow: 0 0 0 1px #3a3e44;
        }
        
        /* Chart Main Area */
        .chart-main {
            flex: 1;
            position: relative;
            background: #0b0e14;
            overflow: hidden;
        }
        
        .chart-canvas-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .chart-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* TradingView Chart Container */
        #tv-chart-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* OHLC Tooltip */
        .chart-tooltip {
            position: absolute;
            background: rgba(22, 26, 30, 0.95);
            border: 1px solid #2a2e34;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin: 2px 0;
        }
        
        .tooltip-label {
            color: #848e9c;
            font-size: 11px;
        }
        
        .tooltip-value {
            color: #eaecef;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        .tooltip-value.up {
            color: #0ecb81;
        }
        
        .tooltip-value.down {
            color: #f6465d;
        }
        
        .tooltip-divider {
            height: 1px;
            background: #2a2e34;
            margin: 6px 0;
        }
        
        /* Loading Skeleton */
        .chart-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0b0e14;
            display: none;
        }
        
        .chart-skeleton.active {
            display: block;
        }
        
        .skeleton-grid {
            width: 100%;
            height: 100%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .skeleton-line {
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(42, 46, 52, 0.5) 20%, 
                rgba(42, 46, 52, 0.5) 80%, 
                transparent 100%);
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        .chart-loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #848e9c;
            font-size: 13px;
            display: none;
        }
        
        .chart-skeleton.active ~ .chart-loading-text {
            display: block;
        }
        
        /* Chart Footer */
        .chart-footer {
            padding: 10px 20px;
            border-top: 1px solid #2a2e34;
            background: #1a1e23;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #848e9c;
            flex-shrink: 0;
        }
        
        .chart-footer-left {
            display: flex;
            gap: 20px;
        }
        
        .chart-footer-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .chart-footer-label {
            color: #848e9c;
        }
        
        .chart-footer-value {
            color: #eaecef;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.connected {
            background: #0ecb81;
            box-shadow: 0 0 6px rgba(14, 203, 129, 0.5);
            animation: status-pulse 2s ease-in-out infinite;
        }
        
        .status-dot.disconnected {
            background: #f6465d;
            box-shadow: 0 0 6px rgba(246, 70, 93, 0.5);
        }
        
        @keyframes status-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ========== å³ä¾§ Market Info ========== */
        .market-info-panel {
            display: flex;
            flex-direction: column;
            border-left: 1px solid #2a2e34;
        }
        
        .market-info-header {
            padding: 16px 16px 12px;
            border-bottom: 1px solid #2a2e34;
            background: #1a1e23;
        }
        
        .market-info-title {
            font-size: 12px;
            color: #848e9c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .market-info-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .market-info-content::-webkit-scrollbar {
            width: 4px;
        }
        
        .market-info-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .market-info-content::-webkit-scrollbar-thumb {
            background: #2a2e34;
            border-radius: 2px;
        }
        
        .market-info-content::-webkit-scrollbar-thumb:hover {
            background: #3a3e44;
        }
        
        .market-stat-card {
            background: #1a1e23;
            border: 1px solid #2a2e34;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .market-stat-label {
            font-size: 11px;
            color: #848e9c;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .market-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #eaecef;
            font-variant-numeric: tabular-nums;
        }
        
        .market-stat-value.up {
            color: #0ecb81;
        }
        
        .market-stat-value.down {
            color: #f6465d;
        }
        
        .market-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        
        .market-mini-stat {
            background: #1a1e23;
            border: 1px solid #2a2e34;
            border-radius: 4px;
            padding: 10px;
        }
        
        .market-mini-stat-label {
            font-size: 10px;
            color: #848e9c;
            margin-bottom: 4px;
        }
        
        .market-mini-stat-value {
            font-size: 13px;
            font-weight: 600;
            color: #eaecef;
            font-variant-numeric: tabular-nums;
        }
        
        .market-mini-stat-value.up {
            color: #0ecb81;
        }
        
        .market-mini-stat-value.down {
            color: #f6465d;
        }
        
        /* Loading State */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #848e9c;
            font-size: 12px;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #848e9c;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- å…¨å±€Header -->
    <header class="global-header">
        <div class="logo">ğŸ“Š Market Center</div>
        <div class="global-header-stats">
            <div class="global-stat">
                <span class="global-stat-label">24h Volume:</span>
                <span class="global-stat-value" id="headerVolume">-</span>
            </div>
            <div class="global-stat">
                <span class="global-stat-label">Status:</span>
                <span class="global-stat-value" id="headerStatus" style="color: #0ecb81;">â— Live</span>
            </div>
        </div>
    </header>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§ Trading Pairs -->
        <div class="panel symbols-panel">
            <div class="symbols-header">
                <div class="symbols-header-title">Trading Pairs</div>
            </div>
            <div class="symbols-list" id="symbolList">
                <div class="loading-state">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ä¸­å¤® Chart Section -->
        <div class="panel chart-panel">
            <!-- Chart Header -->
            <div class="chart-header">
                <div class="chart-header-left">
                    <div class="chart-symbol-info">
                        <span class="chart-symbol" id="currentSymbol">-</span>
                        <span class="chart-price" id="currentPrice">$0.00</span>
                        <span class="chart-change" id="currentChange">+0.00%</span>
                    </div>
                </div>
                <div class="timeframe-selector" id="timeframeSelector">
                    <button class="timeframe-btn active" data-tf="1m">1m</button>
                    <button class="timeframe-btn" data-tf="5m">5m</button>
                    <button class="timeframe-btn" data-tf="15m">15m</button>
                    <button class="timeframe-btn" data-tf="30m">30m</button>
                    <button class="timeframe-btn" data-tf="1h">1h</button>
                    <button class="timeframe-btn" data-tf="4h">4h</button>
                </div>
            </div>

            <!-- Chart Main -->
            <div class="chart-main">
                <div class="chart-skeleton active" id="chartSkeleton">
                    <div class="skeleton-grid">
                        <div class="skeleton-line" style="height: 20%;"></div>
                        <div class="skeleton-line" style="height: 15%;"></div>
                        <div class="skeleton-line" style="height: 18%;"></div>
                        <div class="skeleton-line" style="height: 12%;"></div>
                        <div class="skeleton-line" style="height: 15%;"></div>
                        <div class="skeleton-line" style="height: 20%;"></div>
                    </div>
                </div>
                <div class="chart-loading-text">åŠ è½½Kçº¿æ•°æ®ä¸­...</div>
                <div class="chart-canvas-wrapper">
                    <div id="tv-chart-container"></div>
                    <canvas id="chartCanvas" class="chart-canvas" style="display: none;"></canvas>
                </div>
                <!-- OHLC Tooltip -->
                <div id="chartTooltip" class="chart-tooltip">
                    <div class="tooltip-row">
                        <span class="tooltip-label">Time</span>
                        <span class="tooltip-value" id="tooltipTime">--</span>
                    </div>
                    <div class="tooltip-divider"></div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Open</span>
                        <span class="tooltip-value" id="tooltipOpen">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">High</span>
                        <span class="tooltip-value up" id="tooltipHigh">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Low</span>
                        <span class="tooltip-value down" id="tooltipLow">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Close</span>
                        <span class="tooltip-value" id="tooltipClose">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Volume</span>
                        <span class="tooltip-value" id="tooltipVolume">--</span>
                    </div>
                </div>
            </div>

            <!-- Chart Footer -->
            <div class="chart-footer">
                <div class="chart-footer-left">
                    <div class="chart-footer-item">
                        <span class="chart-footer-label">Last Update:</span>
                        <span class="chart-footer-value" id="statusTime">--:--:--</span>
                    </div>
                    <div class="chart-footer-item">
                        <span class="chart-footer-label">Timeframe:</span>
                        <span class="chart-footer-value" id="statusTimeframe">1m</span>
                    </div>
                </div>
                <div class="connection-status">
                    <span class="status-dot connected" id="statusIndicator"></span>
                    <span class="chart-footer-value" id="statusConnection">Connected</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ Market Info -->
        <div class="panel market-info-panel">
            <div class="market-info-header">
                <div class="market-info-title">Market Info</div>
            </div>
            <div class="market-info-content">
                <div class="market-stat-card">
                    <div class="market-stat-label">24h High</div>
                    <div class="market-stat-value up" id="statTodayHigh">-</div>
                </div>
                <div class="market-stat-card">
                    <div class="market-stat-label">24h Low</div>
                    <div class="market-stat-value down" id="statTodayLow">-</div>
                </div>
                <div class="market-stat-card">
                    <div class="market-stat-label">24h Change</div>
                    <div class="market-stat-value" id="statTodayChange">-</div>
                </div>
                <div class="market-stat-card">
                    <div class="market-stat-label">24h Volume</div>
                    <div class="market-stat-value" id="statTodayVolume">-</div>
                </div>
                
                <div class="market-stats-grid">
                    <div class="market-mini-stat">
                        <div class="market-mini-stat-label">Symbol</div>
                        <div class="market-mini-stat-value" id="statusSymbol">-</div>
                    </div>
                    <div class="market-mini-stat">
                        <div class="market-mini-stat-label">Latency</div>
                        <div class="market-mini-stat-value" id="statusDelay">â‰ˆ 0.5s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/layui@2.9.21/dist/layui.js"></script>
    <script src="/js/common.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!checkLogin()) {
            window.location.href = '/login.html';
        }

        // å…¨å±€å˜é‡
        let activeSymbol = null;
        let activeMarketType = null;  // ä¿å­˜å½“å‰äº¤æ˜“å¯¹çš„å¸‚åœºç±»å‹
        let activeTimeframe = '1m';
        let klinesData = [];
        let stompClient = null;
        let socket = null;
        let currentChange = 0;
        const chartSkeleton = document.getElementById('chartSkeleton');

        // å­˜å‚¨æ‰€æœ‰äº¤æ˜“å¯¹ä¿¡æ¯ï¼ˆsymbol -> {symbol, marketType}ï¼‰
        let symbolInfoMap = {};
        
        // TradingView Lightweight Charts å®ä¾‹
        let tvChart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let tooltipElement = null;
        
        // å›¾è¡¨äº¤äº’çŠ¶æ€
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        // ========== æ•°æ®çª—å£ç®¡ç† ==========
        /**
         * Data Window Management
         * ç®¡ç†å·²åŠ è½½çš„æ•°æ®èŒƒå›´ï¼Œé˜²æ­¢é‡å¤è¯·æ±‚
         */
        const dataWindow = {
            // å·²åŠ è½½æ•°æ®çš„æ—¶é—´èŒƒå›´ï¼ˆæ¯«ç§’çº§UTCæ—¶é—´æˆ³ï¼‰
            leftBoundary: null,   // æœ€æ—©æ•°æ®çš„æ—¶é—´æˆ³
            rightBoundary: null,  // æœ€æ–°æ•°æ®çš„æ—¶é—´æˆ³
            
            // æ­£åœ¨åŠ è½½çš„æ—¶é—´èŒƒå›´ï¼ˆé˜²é‡å¤è¯·æ±‚ï¼‰
            pendingRequests: new Set(),
            
            // é‡ç½®æ•°æ®çª—å£
            reset: function() {
                this.leftBoundary = null;
                this.rightBoundary = null;
                this.pendingRequests.clear();
            },
            
            // æ›´æ–°è¾¹ç•Œï¼ˆæ•°æ®åŠ è½½åï¼‰
            updateBoundaries: function(data) {
                if (!data || data.length === 0) return;
                const firstTime = data[0].timestamp;
                const lastTime = data[data.length - 1].timestamp;
                
                if (this.leftBoundary === null || firstTime < this.leftBoundary) {
                    this.leftBoundary = firstTime;
                }
                if (this.rightBoundary === null || lastTime > this.rightBoundary) {
                    this.rightBoundary = lastTime;
                }
            },
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´æ—©çš„æ•°æ®
            shouldLoadEarlier: function(visibleStartTimeMs, thresholdBars) {
                if (this.leftBoundary === null) return false;
                
                // è®¡ç®—é˜ˆå€¼æ—¶é—´ï¼ˆthresholdBarsæ ¹Kçº¿çš„æ—¶é—´è·¨åº¦ï¼‰
                const timeframeMs = getTimeframeMs(activeTimeframe);
                const thresholdMs = thresholdBars * timeframeMs;
                
                // å¦‚æœå¯è§èŒƒå›´çš„å¼€å§‹æ—¶é—´æ¥è¿‘æˆ–è¶…è¿‡å·¦è¾¹ç•Œï¼Œéœ€è¦åŠ è½½
                return visibleStartTimeMs <= (this.leftBoundary + thresholdMs);
            },
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å®æ—¶æ¨¡å¼ï¼ˆæ¥è¿‘æœ€æ–°æ•°æ®ï¼‰
            isNearRealtime: function(visibleEndTimeMs, thresholdBars) {
                if (this.rightBoundary === null) return false;
                
                const timeframeMs = getTimeframeMs(activeTimeframe);
                const thresholdMs = thresholdBars * timeframeMs;
                // Date.now() è¿”å›UTCæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰
                const now = Date.now();
                
                // å¦‚æœå¯è§èŒƒå›´æ¥è¿‘æœ€æ–°æ•°æ®ï¼Œä¸”æœ€æ–°æ•°æ®æ¥è¿‘å½“å‰æ—¶é—´ï¼Œåˆ™è®¤ä¸ºæ˜¯å®æ—¶æ¨¡å¼
                return (visibleEndTimeMs >= (this.rightBoundary - thresholdMs)) &&
                       ((now - this.rightBoundary) < timeframeMs * 2);
            }
        };
        
        // è·å–æ—¶é—´å‘¨æœŸå¯¹åº”çš„æ¯«ç§’æ•°
        function getTimeframeMs(timeframe) {
            const timeframeMsMap = {
                '1m': 60000,
                '5m': 300000,
                '15m': 900000,
                '30m': 1800000,
                '1h': 3600000,
                '4h': 14400000,
                '1d': 86400000
            };
            return timeframeMsMap[timeframe] || 60000;
        }
        
        // Auto-Scroll çŠ¶æ€ç®¡ç†
        let isAutoScrollEnabled = true;  // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼ˆè·Ÿéšæœ€æ–°æ•°æ®ï¼‰
        let autoScrollCheckTimer = null;

        // åˆå§‹åŒ– TradingView Chart
        function initTradingViewChart() {
            const container = document.getElementById('tv-chart-container');
            if (!container) {
                console.warn('å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½
            if (typeof LightweightCharts === 'undefined') {
                console.error('TradingView Lightweight Charts åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #848e9c;">å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (tvChart) {
                try {
                    tvChart.remove();
                } catch (e) {
                    console.warn('æ¸…ç†æ—§å›¾è¡¨æ—¶å‡ºé”™:', e);
                }
            }
            
            try {
                // åˆ›å»ºæ–°å›¾è¡¨
                tvChart = LightweightCharts.createChart(container, {
                    layout: {
                        background: { type: 'solid', color: '#0b0e14' },
                        textColor: '#848e9c',
                        fontSize: 12,
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif'
                    },
                    width: container.clientWidth,
                    height: container.clientHeight,
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false,
                        rightOffset: 12,
                        barSpacing: 3,
                        fixLeftEdge: false,
                        lockVisibleTimeRangeOnResize: false,
                        rightBarStaysOnScroll: true,
                        borderVisible: false,
                        borderColor: '#2a2e39',
                        visible: true,
                        // é‡æ„ï¼šåç«¯å·²ç»Ÿä¸€ä½¿ç”¨UTCï¼Œå‰ç«¯æ˜¾ç¤ºæ—¶JavaScriptè‡ªåŠ¨æ ¹æ®ç³»ç»Ÿæ—¶åŒºè½¬æ¢
                        tickMarkFormatter: function(time, tickMarkType, locale) {
                            // TradingViewä¼ å…¥çš„timeæ˜¯ç§’çº§UTCæ—¶é—´æˆ³
                            // åç«¯å·²ç»Ÿä¸€ä½¿ç”¨UTCï¼ŒJavaScriptçš„Dateå¯¹è±¡ä¼šè‡ªåŠ¨æ ¹æ®ç³»ç»Ÿæ—¶åŒºæ˜¾ç¤º
                            const utcTimestampMs = time * 1000; // è½¬æ¢ä¸ºæ¯«ç§’çº§UTCæ—¶é—´æˆ³
                            const date = new Date(utcTimestampMs); // ç›´æ¥ä½¿ç”¨UTCæ—¶é—´æˆ³ï¼ŒJavaScriptä¼šè‡ªåŠ¨è½¬æ¢
                            
                            // ä½¿ç”¨æœ¬åœ°æ—¶åŒºæ–¹æ³•æå–æ—¶é—´ï¼ˆç³»ç»Ÿæ—¶åŒºä¸ºUTC+8ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸ºä¸Šæµ·æ—¶åŒºï¼‰
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            
                            // æ ¹æ®æ—¶é—´å‘¨æœŸè¿”å›ä¸åŒçš„æ ¼å¼
                            if (activeTimeframe === '1d') {
                                return year + '-' + month + '-' + day;
                            } else if (activeTimeframe === '4h' || activeTimeframe === '1h') {
                                return month + '-' + day + ' ' + hours + ':' + minutes;
                            } else {
                                // 1m, 5m, 15m, 30m æ˜¾ç¤º æœˆ-æ—¥ æ—¶:åˆ†
                                return month + '-' + day + ' ' + hours + ':' + minutes;
                            }
                        }
                    },
                    grid: {
                        vertLines: { color: '#1a1e23', style: 0 },
                        horzLines: { color: '#1a1e23', style: 0 }
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                        vertLine: {
                            color: '#2a2e34',
                            width: 1,
                            style: 2,
                            labelBackgroundColor: '#161a1e',
                            // ç¦ç”¨Xè½´æ—¶é—´æ ‡ç­¾çš„æ˜¾ç¤ºï¼Œé¿å…ä¸Tooltipå†²çª
                            labelVisible: false
                        },
                        horzLine: {
                            color: '#2a2e34',
                            width: 1,
                            style: 2,
                            labelBackgroundColor: '#161a1e'
                        }
                    },
                    rightPriceScale: {
                        borderColor: '#2a2e34',
                        textColor: '#848e9c',
                        entireTextOnly: false,
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.1
                        }
                    },
                    handleScroll: {
                        mouseWheel: true,
                        pressedMouseMove: true,
                        horzTouchDrag: true,
                        vertTouchDrag: true
                    },
                    handleScale: {
                        axisPressedMouseMove: true,
                        axisDoubleClickReset: true,
                        axisTouchDrag: true,
                        mouseWheel: true,
                        pinch: true
                    }
                });
                
                // éªŒè¯å›¾è¡¨å¯¹è±¡æ˜¯å¦åˆ›å»ºæˆåŠŸ
                if (!tvChart || typeof tvChart.addCandlestickSeries !== 'function') {
                    throw new Error('å›¾è¡¨å¯¹è±¡åˆ›å»ºå¤±è´¥ï¼ŒAPIæ–¹æ³•ä¸å­˜åœ¨');
                }
                
                // åˆ›å»ºKçº¿ç³»åˆ—
                candlestickSeries = tvChart.addCandlestickSeries({
                    upColor: '#0ecb81',
                    downColor: '#f6465d',
                    borderVisible: false,
                    wickUpColor: '#0ecb81',
                    wickDownColor: '#f6465d',
                    priceLineVisible: false,
                    lastValueVisible: true
                });
                
                // åˆ›å»ºæˆäº¤é‡ç³»åˆ—ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // volumeSeries = tvChart.addHistogramSeries({
                //     color: '#26a69a',
                //     priceFormat: {
                //         type: 'volume',
                //     },
                //     priceScaleId: '',
                //     scaleMargins: {
                //         top: 0.8,
                //         bottom: 0,
                //     },
                // });
                
                // åˆå§‹åŒ– Tooltip
                tooltipElement = document.getElementById('chartTooltip');
                
                // ç»‘å®šé¼ æ ‡äº‹ä»¶ - Crosshair å’Œ Tooltip
                container.addEventListener('mousemove', handleChartMouseMove);
                container.addEventListener('mouseleave', handleChartMouseLeave);
                container.addEventListener('dblclick', handleChartDoubleClick);
                
                // å“åº”å¼è°ƒæ•´
                const resizeObserver = new ResizeObserver(function(entries) {
                    if (tvChart && entries.length > 0) {
                        const { width, height } = entries[0].contentRect;
                        tvChart.applyOptions({ width, height });
                    }
                });
                resizeObserver.observe(container);
                
                // çª—å£å¤§å°è°ƒæ•´
                window.addEventListener('resize', function() {
                    if (tvChart && container) {
                        tvChart.applyOptions({
                            width: container.clientWidth,
                            height: container.clientHeight
                        });
                    }
                });
                
                console.log('TradingView å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('åˆå§‹åŒ– TradingView å›¾è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #f6465d;">å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</div>';
                tvChart = null;
                candlestickSeries = null;
            }
        }
        
        // å¤„ç†å›¾è¡¨é¼ æ ‡ç§»åŠ¨ - Crosshair å’Œ Tooltip
        function handleChartMouseMove(e) {
            if (!tvChart || !candlestickSeries || !tooltipElement || klinesData.length === 0) return;
            
            const container = document.getElementById('tv-chart-container');
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            try {
                // è·å–åæ ‡å¯¹åº”çš„æ—¶é—´ï¼ˆTradingView è¿”å›ç§’çº§UTCæ—¶é—´æˆ³ï¼‰
                const timeAtCoordinate = tvChart.timeScale().coordinateToTime(x);
                if (!timeAtCoordinate || timeAtCoordinate < 0) {
                    tooltipElement.style.display = 'none';
                    return;
                }
                
                // TradingViewçš„coordinateToTimeè¿”å›çš„æ˜¯UTCæ—¶é—´çš„ç§’çº§æ—¶é—´æˆ³
                // è½¬æ¢ä¸ºæ¯«ç§’çº§æ—¶é—´æˆ³ç”¨äºæŸ¥æ‰¾å’Œæ˜¾ç¤º
                const timeMs = timeAtCoordinate * 1000;
                
                // æ‰¾åˆ°å¯¹åº”çš„Kçº¿æ•°æ®ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œå…è®¸å°èŒƒå›´è¯¯å·®ï¼‰
                const klineIndex = findKlineByTime(timeMs);
                
                if (klineIndex >= 0 && klineIndex < klinesData.length) {
                    const kline = klinesData[klineIndex];
                    
                    // ç›´æ¥ä½¿ç”¨Kçº¿çš„timestampï¼ˆåç«¯è¿”å›çš„UTCæ—¶é—´æˆ³ï¼‰ï¼Œè€Œä¸æ˜¯åæ ‡è½¬æ¢çš„æ—¶é—´
                    // è¿™æ ·å¯ä»¥ç¡®ä¿Tooltipæ˜¾ç¤ºçš„æ—¶é—´ä¸Kçº¿å®é™…æ—¶é—´å®Œå…¨ä¸€è‡´ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
                    updateTooltip(kline, kline.timestamp, x, y, rect);
                    
                    // æ˜¾ç¤º Tooltip
                    tooltipElement.style.display = 'block';
                } else {
                    tooltipElement.style.display = 'none';
                }
            } catch (err) {
                // é™é»˜å¤„ç†é”™è¯¯
                tooltipElement.style.display = 'none';
            }
        }
        
        // æŸ¥æ‰¾å¯¹åº”æ—¶é—´çš„Kçº¿ç´¢å¼•ï¼ˆä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–ï¼‰
        function findKlineByTime(targetTimeMs) {
            if (klinesData.length === 0) return -1;
            
            // å¦‚æœç›®æ ‡æ—¶é—´åœ¨æ•°æ®èŒƒå›´å¤–ï¼Œè¿”å›æœ€è¿‘çš„è¾¹ç•Œ
            if (targetTimeMs < klinesData[0].timestamp) {
                return 0;
            }
            if (targetTimeMs > klinesData[klinesData.length - 1].timestamp) {
                return klinesData.length - 1;
            }
            
            // äºŒåˆ†æŸ¥æ‰¾æœ€æ¥è¿‘çš„Kçº¿
            let left = 0;
            let right = klinesData.length - 1;
            let closestIndex = 0;
            let minDiff = Infinity;
            
            while (left <= right) {
                const mid = Math.floor((left + right) / 2);
                const midTime = klinesData[mid].timestamp;
                const diff = Math.abs(midTime - targetTimeMs);
                
                if (diff < minDiff) {
                    minDiff = diff;
                    closestIndex = mid;
                }
                
                if (midTime === targetTimeMs) {
                    return mid;
                } else if (midTime < targetTimeMs) {
                    left = mid + 1;
                } else {
                    right = mid - 1;
                }
            }
            
            return closestIndex;
        }
        
        // ========== æ—¶é—´æ ¼å¼åŒ–å·¥å…· ==========
        /**
         * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå­—ç¬¦ä¸²
         * æ³¨æ„ï¼šåç«¯è¿”å›çš„timestampå·²ç»æ˜¯UTCæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œç›´æ¥ä½¿ç”¨UTCæ–¹æ³•æ ¼å¼åŒ–å³å¯
         * æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss
         * 
         * @param {number} timestampMs æ¯«ç§’çº§æ—¶é—´æˆ³ï¼ˆåç«¯è¿”å›çš„UTCæ—¶é—´æˆ³ï¼‰
         * @returns {string} æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
         */
        /**
         * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºæ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¤‡ç”¨å‡½æ•°ï¼Œä¸»è¦ç”¨äºå…¼å®¹å’Œè°ƒè¯•ï¼‰
         * é‡æ„ï¼šåç«¯å·²ç»Ÿä¸€ä½¿ç”¨UTCï¼Œå‰ç«¯åº”ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„timeå­—æ®µ
         * 
         * @param {number} timestampMs æ¯«ç§’çº§UTCæ—¶é—´æˆ³
         * @returns {string} æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²ï¼ˆUTCæ—¶åŒºï¼Œè½¬æ¢ä¸ºä¸Šæµ·æ—¶åŒºæ˜¾ç¤ºï¼‰
         */
        function formatTimeUTC(timestampMs) {
            if (!timestampMs || isNaN(timestampMs)) {
                console.error('formatTimeUTC: æ— æ•ˆçš„æ—¶é—´æˆ³', timestampMs);
                return 'Invalid Time';
            }
            
            // é‡æ„ï¼šåç«¯è¿”å›çš„æ˜¯UTCæ—¶é—´æˆ³ï¼ŒJavaScriptçš„Dateå¯¹è±¡ä¼šè‡ªåŠ¨æ ¹æ®ç³»ç»Ÿæ—¶åŒºæ˜¾ç¤º
            // ç›´æ¥ä½¿ç”¨UTCæ—¶é—´æˆ³ï¼ŒJavaScriptä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒºï¼ˆç³»ç»Ÿæ—¶åŒºä¸ºUTC+8ï¼‰
            const date = new Date(timestampMs);
            
            // ä½¿ç”¨æœ¬åœ°æ—¶åŒºæ–¹æ³•æå–æ—¶é—´ï¼ˆç³»ç»Ÿæ—¶åŒºä¸ºUTC+8ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸ºä¸Šæµ·æ—¶åŒºï¼‰
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        /**
         * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå®Œæ•´å­—ç¬¦ä¸²ï¼ˆå¤‡ç”¨å‡½æ•°ï¼‰
         * æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨åç«¯è¿”å›çš„timeStringå­—æ®µ
         */
        function formatTimeUTCFull(timestampMs) {
            return formatTimeUTC(timestampMs);
        }
        
        // æ›´æ–° Tooltip å†…å®¹
        /**
         * æ›´æ–°Tooltipæ˜¾ç¤ºå†…å®¹
         * 
         * @param {Object} kline Kçº¿æ•°æ®å¯¹è±¡
         * @param {number} displayTimeMs è¦æ˜¾ç¤ºçš„æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ï¼Œç”¨äºç¡®ä¿ä¸Xè½´æ—¶é—´ä¸€è‡´
         * @param {number} mouseX é¼ æ ‡Xåæ ‡
         * @param {number} mouseY é¼ æ ‡Yåæ ‡
         * @param {DOMRect} containerRect å®¹å™¨è¾¹ç•ŒçŸ©å½¢
         */
        function updateTooltip(kline, displayTimeMs, mouseX, mouseY, containerRect) {
            if (!tooltipElement || !kline) return;
            
            // é‡æ„ï¼šåç«¯è¿”å›çš„å­—æ®µåä»timeStringæ”¹ä¸ºtimeï¼Œä¸”å·²ä½¿ç”¨TimeUtil.formatAsShanghaiString()è½¬æ¢
            // æ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼ˆä¸Šæµ·æ—¶åŒºï¼ŒUTC+8ï¼‰
            const timeStr = kline.time || (kline.timestamp ? formatTimeUTCFull(kline.timestamp) : '');
            
            document.getElementById('tooltipTime').textContent = timeStr;
            document.getElementById('tooltipOpen').textContent = kline.open.toFixed(2);
            document.getElementById('tooltipHigh').textContent = kline.high.toFixed(2);
            document.getElementById('tooltipLow').textContent = kline.low.toFixed(2);
            document.getElementById('tooltipClose').textContent = kline.close.toFixed(2);
            
            // è®¾ç½®æ¶¨è·Œé¢œè‰²
            const openEl = document.getElementById('tooltipOpen');
            const closeEl = document.getElementById('tooltipClose');
            if (kline.close >= kline.open) {
                closeEl.classList.add('up');
                closeEl.classList.remove('down');
            } else {
                closeEl.classList.add('down');
                closeEl.classList.remove('up');
            }
            
            if (kline.volume !== undefined) {
                document.getElementById('tooltipVolume').textContent = formatVolume(kline.volume);
            } else {
                document.getElementById('tooltipVolume').textContent = '-';
            }
            
            // å®šä½ Tooltipï¼ˆå›ºå®šåœ¨å›¾è¡¨é¡¶éƒ¨ï¼‰
            const tooltipRect = tooltipElement.getBoundingClientRect();
            const tooltipX = mouseX + 10;
            const tooltipY = 10; // å›ºå®šåœ¨é¡¶éƒ¨
            
            // é˜²æ­¢è¶…å‡ºå³è¾¹ç•Œ
            if (tooltipX + tooltipRect.width > containerRect.width) {
                tooltipElement.style.left = (mouseX - tooltipRect.width - 10) + 'px';
            } else {
                tooltipElement.style.left = tooltipX + 'px';
            }
            tooltipElement.style.top = tooltipY + 'px';
        }
        
        // å¤„ç†å›¾è¡¨é¼ æ ‡ç¦»å¼€
        function handleChartMouseLeave() {
            if (tooltipElement) {
                tooltipElement.style.display = 'none';
            }
        }
        
        // å¤„ç†å›¾è¡¨åŒå‡» - è§†å›¾é‡ç½®
        function handleChartDoubleClick() {
            if (!tvChart || !klinesData || klinesData.length === 0) return;
            
            // é‡ç½®è§†å›¾ï¼Œæ˜¾ç¤ºæœ€æ–°æ•°æ®
            tvChart.timeScale().fitContent();
        }

        // æ˜¾ç¤º/éšè—LoadingçŠ¶æ€
        function showChartLoading(show) {
            if (show) {
                chartSkeleton.classList.add('active');
            } else {
                chartSkeleton.classList.remove('active');
            }
        }

        // æ ¹æ®å¸‚åœºç±»å‹æ ¼å¼åŒ–äº¤æ˜“å¯¹ç¬¦å·ï¼ˆSWAPåˆçº¦æ·»åŠ -SWAPåç¼€ï¼‰
        function formatSymbolForDisplay(symbol, marketType) {
            if (marketType === 'SWAP') {
                return symbol + '-SWAP';
            }
            return symbol;
        }
        
        // æ ¹æ®å¸‚åœºç±»å‹æ ¼å¼åŒ–äº¤æ˜“å¯¹ç¬¦å·ç”¨äºAPIè°ƒç”¨ï¼ˆSWAPåˆçº¦æ·»åŠ -SWAPåç¼€ï¼‰
        function formatSymbolForApi(symbol, marketType) {
            if (marketType === 'SWAP') {
                return symbol + '-SWAP';
            }
            return symbol;
        }

        // åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨
        function loadSymbolList() {
            return request({
                url: '/api/market-subscription/list?enabled=1'
            }).then(function(res) {
                if (res.data && res.data.length > 0) {
                    const symbolList = document.getElementById('symbolList');
                    symbolList.innerHTML = '';
                    
                    // æ¸…ç©ºå¹¶é‡æ–°æ„å»º symbolInfoMap
                    symbolInfoMap = {};
                    
                    res.data.forEach(function(item) {
                        // ä¿å­˜äº¤æ˜“å¯¹ä¿¡æ¯
                        symbolInfoMap[item.symbol] = {
                            symbol: item.symbol,
                            marketType: item.marketType || 'SPOT'
                        };
                        
                        const div = document.createElement('div');
                        div.className = 'symbol-item';
                        div.dataset.symbol = item.symbol;
                        
                        const change = parseFloat(item.todayChange) || 0;
                        const changeClass = change >= 0 ? 'up' : 'down';
                        const changeText = change >= 0 ? '+' : '';
                        const formattedChange = changeText + Math.abs(change).toFixed(2) + '%';
                        
                        // æ ¼å¼åŒ–æ˜¾ç¤ºåç§°ï¼ˆSWAPåˆçº¦æ˜¾ç¤ºä¸º symbol-SWAPï¼‰
                        const displaySymbol = formatSymbolForDisplay(item.symbol, item.marketType);
                        
                        // æ ¼å¼åŒ–ä»·æ ¼
                        const price = item.currentPrice || 0;
                        const formattedPrice = price > 0 ? '$' + price.toFixed(2) : '-';
                        
                        // æ ¼å¼åŒ–24hç»Ÿè®¡
                        const todayHigh = item.todayHigh || 0;
                        const todayLow = item.todayLow || 0;
                        const todayVolume = item.todayVolume || 0;
                        const formattedHigh = todayHigh > 0 ? '$' + todayHigh.toFixed(2) : '-';
                        const formattedLow = todayLow > 0 ? '$' + todayLow.toFixed(2) : '-';
                        const formattedVolume = todayVolume > 0 ? formatVolume(todayVolume) : '-';
                        
                        div.innerHTML = `
                            <div class="symbol-item-row">
                                <span class="symbol-name">${displaySymbol}</span>
                            </div>
                            <div class="symbol-item-row">
                                <span class="symbol-change ${changeClass}">${formattedChange}</span>
                            </div>
                        `;
                        
                        div.onclick = function() {
                            selectSymbol(item.symbol, item.marketType);
                        };
                        
                        symbolList.appendChild(div);
                    });
                    
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                    if (res.data.length > 0) {
                        selectSymbol(res.data[0].symbol, res.data[0].marketType);
                    }
                } else {
                    document.getElementById('symbolList').innerHTML = '<div class="empty-state">æš‚æ— äº¤æ˜“å¯¹</div>';
                }
            }).catch(function(err) {
                console.error('åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨å¤±è´¥:', err);
                document.getElementById('symbolList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            });
        }

        // é€‰æ‹©äº¤æ˜“å¯¹
        function selectSymbol(symbol, marketType) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥marketTypeï¼Œä»symbolInfoMapè·å–
            if (!marketType && symbolInfoMap[symbol]) {
                marketType = symbolInfoMap[symbol].marketType;
            } else if (!marketType) {
                marketType = 'SPOT';  // é»˜è®¤å€¼
            }
            
            // æ›´æ–°UI
            document.querySelectorAll('.symbol-item').forEach(function(el) {
                el.classList.remove('active');
            });
            document.querySelectorAll('.symbol-item').forEach(function(el) {
                if (el.dataset.symbol === symbol) {
                    el.classList.add('active');
                }
            });
            
            activeSymbol = symbol;
            activeMarketType = marketType;
            
            // æ ¼å¼åŒ–æ˜¾ç¤ºç¬¦å·ï¼ˆSWAPåˆçº¦æ˜¾ç¤ºä¸º symbol-SWAPï¼‰
            const displaySymbol = formatSymbolForDisplay(symbol, marketType);
            document.getElementById('currentSymbol').innerText = displaySymbol;
            document.getElementById('statusSymbol').innerText = displaySymbol;
            
            // æ ¼å¼åŒ–APIè°ƒç”¨ç¬¦å·ï¼ˆSWAPåˆçº¦ä½¿ç”¨ symbol-SWAPï¼‰
            const apiSymbol = formatSymbolForApi(symbol, marketType);
            
            // æ–­å¼€æ—§çš„WebSocketè¿æ¥
            disconnectWebSocket();
            
            // æ˜¾ç¤ºLoading
            showChartLoading(true);
            
            // é‡ç½®æ•°æ®çª—å£ï¼ˆåˆ‡æ¢äº¤æ˜“å¯¹æˆ–å‘¨æœŸæ—¶ï¼‰
            dataWindow.reset();
            isAutoScrollEnabled = true;
            
            // åˆå§‹åŒ–å›¾è¡¨ï¼ˆå¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼‰
            if (!tvChart) {
                initTradingViewChart();
            }
            
            // åŠ è½½Kçº¿æ•°æ®ï¼ˆä½¿ç”¨APIæ ¼å¼çš„symbolï¼‰
            loadKlines(apiSymbol, activeTimeframe);
            
            // åŠ è½½ä»Šæ—¥ç»Ÿè®¡ï¼ˆä½¿ç”¨APIæ ¼å¼çš„symbolï¼‰
            loadTodayStats(apiSymbol);
            
            // è¿æ¥WebSocketï¼ˆä½¿ç”¨åŸå§‹symbolï¼Œæ ¹æ®å®é™…WebSocketåè®®å¯èƒ½éœ€è¦è°ƒæ•´ï¼‰
            connectWebSocket(apiSymbol);
        }

        // å‘¨æœŸé€‰æ‹©
        document.querySelectorAll('.timeframe-btn').forEach(function(el) {
            el.addEventListener('click', function() {
                document.querySelectorAll('.timeframe-btn').forEach(function(e) {
                    e.classList.remove('active');
                });
                el.classList.add('active');
                activeTimeframe = el.dataset.tf;
                
                document.getElementById('statusTimeframe').innerText = activeTimeframe;
                
                if (activeSymbol) {
                    showChartLoading(true);
                    // ä½¿ç”¨APIæ ¼å¼çš„symbol
                    const apiSymbol = formatSymbolForApi(activeSymbol, activeMarketType);
                    loadKlines(apiSymbol, activeTimeframe);
                }
            });
        });

        // ========== ç³»ç»Ÿçº§é‡æ„ï¼šKçº¿æ•°æ®åŠ è½½ç­–ç•¥ ==========
        // æ ¸å¿ƒåŸåˆ™ï¼š
        // 1. è¿›å…¥é¡µé¢æ—¶åˆå§‹åŒ–æŸ¥è¯¢æœ€æ–°çš„200æ ¹Kçº¿
        // 2. ç”¨æˆ·æ‹–åŠ¨è¶…å‡ºèŒƒå›´æ—¶ï¼ŒæŒ‰éœ€åŠ è½½æ›´å¤šæ•°æ®
        // 3. ä¿è¯æ•°æ®è¿ç»­æ€§ï¼šä»æœ€æ—§æ—¶é—´ç‚¹-1åˆ†é’Ÿå¼€å§‹æŸ¥è¯¢200æ ¹
        
        const INITIAL_KLINE_LIMIT = 200;  // åˆå§‹åŠ è½½200æ ¹Kçº¿
        const LOAD_MORE_LIMIT = 200;      // æ¯æ¬¡åŠ è½½æ›´å¤šæ—¶ä¹ŸåŠ è½½200æ ¹
        
        /**
         * åˆå§‹åŒ–åŠ è½½Kçº¿æ•°æ®ï¼ˆé¡µé¢é¦–æ¬¡åŠ è½½æˆ–åˆ‡æ¢äº¤æ˜“å¯¹/å‘¨æœŸæ—¶è°ƒç”¨ï¼‰
         * æŸ¥è¯¢æœ€æ–°çš„200æ ¹Kçº¿
         */
        function loadKlines(symbol, timeframe) {
            const now = Date.now();
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼šæŸ¥è¯¢æœ€æ–°çš„200æ ¹Kçº¿ï¼ˆä¸éœ€è¦fromï¼Œåç«¯ä¼šè¿”å›æœ€æ–°çš„ï¼‰
            const params = new URLSearchParams();
            params.append('symbol', symbol);
            params.append('interval', timeframe);
            params.append('to', now);
            params.append('limit', INITIAL_KLINE_LIMIT);
            
            request({
                url: '/api/market/kline?' + params.toString(),
                method: 'GET'
            }).then(function(res) {
                showChartLoading(false);
                
                // è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºAPIå“åº”ï¼ˆåŒ…å«è¯¦ç»†çš„æ—¶é—´æˆ³ä¿¡æ¯ï¼‰
                if (res.data && res.data.length > 0) {
                    const firstItem = res.data[0];
                    const lastItem = res.data[res.data.length - 1];
                    console.log('[loadKlines] ğŸ“Š APIå“åº”:', {
                        code: res.code,
                        message: res.message,
                        æ•°æ®æ•°é‡: res.data.length,
                        äº¤æ˜“å¯¹: symbol,
                        å‘¨æœŸ: timeframe,
                        ç¬¬ä¸€æ¡æ•°æ®: {
                            timestamp: firstItem.timestamp,
                            timestampç±»å‹: typeof firstItem.timestamp,
                            æ—¶é—´å­—ç¬¦ä¸²: firstItem.timestamp ? new Date(firstItem.timestamp).toISOString() : 'N/A',
                            time: firstItem.time,
                            open: firstItem.open, high: firstItem.high, low: firstItem.low, close: firstItem.close
                        },
                        æœ€åä¸€æ¡æ•°æ®: {
                            timestamp: lastItem.timestamp,
                            æ—¶é—´å­—ç¬¦ä¸²: lastItem.timestamp ? new Date(lastItem.timestamp).toISOString() : 'N/A'
                        }
                    });
                } else {
                    console.log('[loadKlines] ğŸ“Š APIå“åº”: æ— æ•°æ®', {
                        code: res.code,
                        message: res.message,
                        æ•°æ®æ•°é‡: 0
                    });
                }
                
                if (res.data && res.data.length > 0) {
                    // é‡ç½®æ•°æ®çª—å£
                    dataWindow.reset();
                    
                    // ç»˜åˆ¶Kçº¿æ•°æ®ï¼ˆåˆå§‹åŠ è½½ï¼Œè‡ªåŠ¨é€‚é…è§†å›¾ï¼‰
                    drawKlines(res.data, true);
                    
                    // è®¾ç½®å†å²æ•°æ®åŠ è½½ç›‘å¬å™¨ï¼ˆç”¨æˆ·æ‹–åŠ¨æ—¶è§¦å‘ï¼‰
                    if (tvChart) {
                        setupHistoricalDataLoading();
                    }
                    
                    // æ›´æ–°å½“å‰ä»·æ ¼å’Œæ¶¨è·Œ
                    const lastKline = klinesData[klinesData.length - 1];
                    updatePriceDisplay(lastKline.close);
                    
                    // é‡æ„ï¼šä½¿ç”¨åç«¯è¿”å›çš„timeå­—æ®µï¼ˆå·²ä»timeStringæ”¹ä¸ºtimeï¼‰
                    const timeStr = lastKline.time || '';
                    document.getElementById('statusTime').innerText = timeStr;
                } else {
                    if (candlestickSeries) {
                        candlestickSeries.setData([]);
                    }
                    dataWindow.reset();
                }
            }).catch(function(err) {
                showChartLoading(false);
                console.error('åŠ è½½Kçº¿å¤±è´¥:', err);
                layui.layer.msg('åŠ è½½Kçº¿å¤±è´¥', {icon: 2});
            });
        }

        // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
        function updatePriceDisplay(price) {
            const priceEl = document.getElementById('currentPrice');
            const changeEl = document.getElementById('currentChange');
            
            priceEl.innerText = '$' + price.toFixed(2);
            
            // æ ¹æ®æ¶¨è·Œè®¾ç½®é¢œè‰²
            if (klinesData.length >= 2) {
                const prevClose = klinesData[klinesData.length - 2].close;
                const change = ((price - prevClose) / prevClose) * 100;
                currentChange = change;
                
                const changeText = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                changeEl.innerText = changeText;
                
                // æ›´æ–°æ ·å¼
                priceEl.className = 'chart-price ' + (change >= 0 ? 'up' : 'down');
                changeEl.className = 'chart-change ' + (change >= 0 ? 'up' : 'down');
            }
        }

        // ========== ç»˜åˆ¶Kçº¿æ•°æ® ==========
        /**
         * ç»˜åˆ¶Kçº¿æ•°æ®åˆ°å›¾è¡¨
         * 
         * @param {Array} data Kçº¿æ•°æ®æ•°ç»„ï¼ˆåç«¯è¿”å›çš„æ•°æ®ï¼Œåº”è¯¥å·²ç»æŒ‰æ—¶é—´å‡åºæ’åˆ—ï¼‰
         * @param {boolean} shouldFitContent æ˜¯å¦è‡ªåŠ¨é€‚é…è§†å›¾ï¼ˆé»˜è®¤trueï¼Œåˆå§‹åŠ è½½æ—¶ä½¿ç”¨ï¼‰
         */
        function drawKlines(data, shouldFitContent) {
            if (!data || data.length === 0) {
                if (candlestickSeries) {
                    candlestickSeries.setData([]);
                }
                // é‡ç½®æ•°æ®çª—å£
                dataWindow.reset();
                return;
            }
            
            // ========== ç³»ç»Ÿçº§é‡æ„ï¼šç®€åŒ–å‰ç«¯æ•°æ®å¤„ç† ==========
            // åç«¯ä¿è¯è¿”å›å‡åºæ•°æ®ï¼ˆä»æ—§åˆ°æ–°ï¼‰ï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨ï¼Œä¸åšä»»ä½•æ’åºæ“ä½œ
            // å›¾è¡¨æ˜¾ç¤ºï¼šå·¦ä¾§æ˜¯æ—§æ•°æ®ï¼Œå³ä¾§æ˜¯æ–°æ•°æ®ï¼ˆæ—¶é—´ä»å·¦åˆ°å³é€’å¢ï¼‰
            
            // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®ï¼ˆå·²ç»æŒ‰æ—¶é—´å‡åºæ’åˆ—ï¼‰
            // ç¡®ä¿ timestamp æ˜¯æ•°å­—ç±»å‹
            klinesData = data.map(function(k) {
                if (typeof k.timestamp === 'string') {
                    k.timestamp = parseInt(k.timestamp, 10);
                }
                return k;
            });
            
            // æ›´æ–°æ•°æ®çª—å£è¾¹ç•Œï¼ˆç¡®ä¿ timestamp æ˜¯æ•°å­—ï¼‰
            const normalizedData = data.map(function(k) {
                if (typeof k.timestamp === 'string') {
                    k.timestamp = parseInt(k.timestamp, 10);
                }
                return k;
            });
            dataWindow.updateBoundaries(normalizedData);
            
            // ç¡®ä¿å›¾è¡¨å·²åˆå§‹åŒ–
            if (!tvChart) {
                initTradingViewChart();
            }
            
            if (!candlestickSeries) {
                return;
            }
            
            // è½¬æ¢æ•°æ®æ ¼å¼ä¸º TradingView æ ¼å¼
            // æ³¨æ„ï¼šåç«¯è¿”å›çš„timestampæ˜¯UTCæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼ŒTradingViewéœ€è¦ç§’çº§æ—¶é—´æˆ³
            const chartData = data.map(function(k) {
                // é¦–å…ˆæ£€æŸ¥æ•´ä¸ªå¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
                if (!k || typeof k !== 'object') {
                    console.error('æ— æ•ˆçš„æ•°æ®å¯¹è±¡:', k);
                    return null;
                }
                
                // ç¡®ä¿ timestamp æ˜¯æ•°å­—ç±»å‹ï¼ˆé˜²æ­¢JSONååºåˆ—åŒ–åæ˜¯å­—ç¬¦ä¸²ï¼‰
                let timestampMs = k.timestamp;
                if (timestampMs == null) {
                    console.error('æ—¶é—´æˆ³ä¸º null æˆ– undefined:', k);
                    return null;
                }
                if (typeof timestampMs === 'string') {
                    timestampMs = parseInt(timestampMs, 10);
                }
                timestampMs = Number(timestampMs);
                
                // å¦‚æœæ—¶é—´æˆ³çœ‹èµ·æ¥æ˜¯ç§’çº§ï¼ˆå°äº 10000000000ï¼‰ï¼Œè½¬æ¢ä¸ºæ¯«ç§’çº§
                // æ­£å¸¸çš„æ—¶é—´æˆ³ï¼š2026å¹´ = 1735689600000 (æ¯«ç§’) = 1735689600 (ç§’)
                if (timestampMs > 0 && timestampMs < 10000000000) {
                    // å¯èƒ½æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºæ¯«ç§’çº§
                    console.warn('[drawKlines] âš ï¸ æ—¶é—´æˆ³å¯èƒ½æ˜¯ç§’çº§ï¼Œè½¬æ¢ä¸ºæ¯«ç§’çº§:', timestampMs, '->', timestampMs * 1000);
                    timestampMs = timestampMs * 1000;
                }
                
                // éªŒè¯æ—¶é—´æˆ³æœ‰æ•ˆæ€§ï¼ˆå¿…é¡»æ˜¯åˆç†çš„æ¯«ç§’çº§æ—¶é—´æˆ³ï¼‰
                const MIN_VALID_TIMESTAMP_MS = 946684800000; // 2000-01-01 00:00:00 UTC (æ¯«ç§’çº§)
                if (isNaN(timestampMs) || timestampMs <= 0 || !isFinite(timestampMs)) {
                    console.error('[drawKlines] âŒ æ— æ•ˆçš„æ—¶é—´æˆ³:', k.timestamp, 'è½¬æ¢å:', timestampMs, 'åŸå§‹æ•°æ®:', k);
                    return null;
                }
                if (timestampMs < MIN_VALID_TIMESTAMP_MS) {
                    console.error('[drawKlines] âŒ æ—¶é—´æˆ³è¿‡å°ï¼ˆå¯èƒ½æ˜¯1970å¹´ï¼‰:', timestampMs, 'æ—¥æœŸ:', new Date(timestampMs).toISOString(), 'åŸå§‹æ•°æ®:', k);
                    return null;
                }
                
                // éªŒè¯å¹¶è½¬æ¢ä»·æ ¼æ•°æ®ï¼ˆä½¿ç”¨ Number è€Œä¸æ˜¯ parseFloatï¼Œæ›´ä¸¥æ ¼ï¼‰
                const open = (k.open != null && k.open !== '') ? Number(k.open) : NaN;
                const high = (k.high != null && k.high !== '') ? Number(k.high) : NaN;
                const low = (k.low != null && k.low !== '') ? Number(k.low) : NaN;
                const close = (k.close != null && k.close !== '') ? Number(k.close) : NaN;
                
                // éªŒè¯ä»·æ ¼æ•°æ®æœ‰æ•ˆæ€§ï¼ˆç¡®ä¿æ˜¯æœ‰æ•ˆæ•°å­—ä¸”æœ‰é™ï¼‰
                if (isNaN(open) || !isFinite(open) || 
                    isNaN(high) || !isFinite(high) || 
                    isNaN(low) || !isFinite(low) || 
                    isNaN(close) || !isFinite(close)) {
                    console.error('æ— æ•ˆçš„ä»·æ ¼æ•°æ®:', {
                        open: k.open, high: k.high, low: k.low, close: k.close,
                        è½¬æ¢å: {open, high, low, close},
                        åŸå§‹æ•°æ®: k
                    });
                    return null;
                }
                
                // éªŒè¯ä»·æ ¼é€»è¾‘ï¼ˆhigh >= low, high >= open, high >= close, low <= open, low <= closeï¼‰
                if (high < low || high < open || high < close || low > open || low > close) {
                    console.warn('ä»·æ ¼æ•°æ®é€»è¾‘é”™è¯¯:', {open, high, low, close, original: k});
                    // ä¸è¿”å› nullï¼Œè€Œæ˜¯ä¿®æ­£æ•°æ®
                    const correctedHigh = Math.max(open, high, close);
                    const correctedLow = Math.min(open, low, close);
                    return {
                        time: Math.floor(timestampMs / 1000),
                        open: open,
                        high: correctedHigh,
                        low: correctedLow,
                        close: close
                    };
                }
                
                // è®¡ç®—ç§’çº§æ—¶é—´æˆ³
                const timeSec = Math.floor(timestampMs / 1000);
                
                // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ‰€æœ‰å€¼éƒ½ä¸æ˜¯ nullã€NaN æˆ– Infinity
                if (timeSec == null || isNaN(timeSec) || !isFinite(timeSec) || timeSec <= 0 ||
                    open == null || isNaN(open) || !isFinite(open) ||
                    high == null || isNaN(high) || !isFinite(high) ||
                    low == null || isNaN(low) || !isFinite(low) ||
                    close == null || isNaN(close) || !isFinite(close)) {
                    console.error('æœ€ç»ˆéªŒè¯å¤±è´¥ï¼Œæ•°æ®åŒ…å«æ— æ•ˆå€¼:', {
                        timeSec, open, high, low, close, timestampMs, åŸå§‹æ•°æ®: k
                    });
                    return null;
                }
                
                return {
                    time: timeSec, // åç«¯è¿”å›çš„æ˜¯æ¯«ç§’çº§UTCæ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºç§’çº§
                    open: open,
                    high: high,
                    low: low,
                    close: close
                };
            }).filter(function(item) {
                // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®ï¼ˆnull æˆ–åŒ…å«æ— æ•ˆå€¼çš„å¯¹è±¡ï¼‰
                if (item === null) return false;
                if (isNaN(item.time) || item.time <= 0) return false;
                if (isNaN(item.open) || isNaN(item.high) || isNaN(item.low) || isNaN(item.close)) return false;
                return true;
            });
            
            // è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºç¬¬ä¸€æ¡å’Œæœ€åä¸€æ¡æ•°æ®ï¼ˆåŒ…å«åŸå§‹æ—¶é—´æˆ³ï¼‰
            if (chartData.length > 0) {
                const firstItem = chartData[0];
                const lastItem = chartData[chartData.length - 1];
                console.log('[drawKlines] âœ… æ•°æ®è½¬æ¢æˆåŠŸ:', {
                    æ€»æ•°: chartData.length,
                    ç¬¬ä¸€æ¡: {
                        time: firstItem.time,
                        æ—¶é—´å­—ç¬¦ä¸²: new Date(firstItem.time * 1000).toISOString(),
                        åŸå§‹timestamp: data[0] ? data[0].timestamp : 'N/A',
                        open: firstItem.open, high: firstItem.high, low: firstItem.low, close: firstItem.close
                    },
                    æœ€åä¸€æ¡: {
                        time: lastItem.time,
                        æ—¶é—´å­—ç¬¦ä¸²: new Date(lastItem.time * 1000).toISOString(),
                        åŸå§‹timestamp: data[data.length - 1] ? data[data.length - 1].timestamp : 'N/A'
                    }
                });
            } else {
                console.warn('[drawKlines] âš ï¸ è­¦å‘Šï¼šè½¬æ¢åæ•°æ®ä¸ºç©ºï¼ŒåŸå§‹æ•°æ®æ•°é‡:', data ? data.length : 0);
            }
            
            // è®¾ç½®Kçº¿æ•°æ®ï¼ˆæœ€ç»ˆéªŒè¯ï¼Œç¡®ä¿æ²¡æœ‰ null å€¼ä¸”æ—¶é—´æˆ³åˆç†ï¼‰
            if (chartData.length > 0) {
                // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ•°ç»„ä¸­æ²¡æœ‰ä»»ä½• null å€¼æˆ–æ— æ•ˆå€¼ï¼Œä¸”æ—¶é—´æˆ³åˆç†ï¼ˆä¸èƒ½æ˜¯1970å¹´ï¼‰
                const MIN_VALID_TIMESTAMP = 946684800; // 2000-01-01 00:00:00 UTC (ç§’çº§)
                const finalData = chartData.filter(function(item, index) {
                    if (!item) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹ä¸º null');
                        return false;
                    }
                    if (item.time == null || isNaN(item.time) || item.time <= 0 || !isFinite(item.time)) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹æ—¶é—´æˆ³æ— æ•ˆ:', item.time);
                        return false;
                    }
                    // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åˆç†ï¼ˆä¸èƒ½æ˜¯1970å¹´ï¼‰
                    if (item.time < MIN_VALID_TIMESTAMP) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹æ—¶é—´æˆ³è¿‡å°ï¼ˆå¯èƒ½æ˜¯1970å¹´ï¼‰:', item.time, 'æ—¥æœŸ:', new Date(item.time * 1000).toISOString());
                        return false;
                    }
                    if (item.open == null || isNaN(item.open) || !isFinite(item.open)) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹ open æ— æ•ˆ:', item.open);
                        return false;
                    }
                    if (item.high == null || isNaN(item.high) || !isFinite(item.high)) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹ high æ— æ•ˆ:', item.high);
                        return false;
                    }
                    if (item.low == null || isNaN(item.low) || !isFinite(item.low)) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹ low æ— æ•ˆ:', item.low);
                        return false;
                    }
                    if (item.close == null || isNaN(item.close) || !isFinite(item.close)) {
                        console.error('[drawKlines] âŒ ç¬¬', index, 'é¡¹ close æ— æ•ˆ:', item.close);
                        return false;
                    }
                    return true;
                });
                
                if (finalData.length > 0) {
                    console.log('[drawKlines] âœ… æœ€ç»ˆéªŒè¯é€šè¿‡ï¼Œå‡†å¤‡æ¸²æŸ“', finalData.length, 'æ ¹Kçº¿ï¼ˆè¿‡æ»¤æ‰', chartData.length - finalData.length, 'æ ¹æ— æ•ˆæ•°æ®ï¼‰');
                    // å†æ¬¡æ£€æŸ¥ç¬¬ä¸€æ¡æ•°æ®
                    if (finalData[0]) {
                        console.log('[drawKlines] ç¬¬ä¸€æ¡æœ‰æ•ˆæ•°æ®:', {
                            time: finalData[0].time,
                            æ—¶é—´: new Date(finalData[0].time * 1000).toISOString(),
                            open: finalData[0].open, high: finalData[0].high, low: finalData[0].low, close: finalData[0].close
                        });
                    }
                    try {
                        candlestickSeries.setData(finalData);
                        console.log('[drawKlines] âœ… setData è°ƒç”¨æˆåŠŸ');
                    } catch (err) {
                        console.error('[drawKlines] âŒ setData å¤±è´¥:', err);
                        console.error('[drawKlines] å¤±è´¥çš„æ•°æ®ï¼ˆå‰3æ¡ï¼‰:', finalData.slice(0, 3));
                        console.error('[drawKlines] å¤±è´¥çš„æ•°æ®ï¼ˆå3æ¡ï¼‰:', finalData.slice(-3));
                    }
                } else {
                    console.error('[drawKlines] âŒ é”™è¯¯ï¼šæœ€ç»ˆéªŒè¯åæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼ŒåŸå§‹æ•°æ®æ•°é‡:', chartData.length);
                    console.error('[drawKlines] åŸå§‹æ•°æ®ç¤ºä¾‹ï¼ˆå‰3æ¡ï¼‰:', chartData.slice(0, 3));
                    candlestickSeries.setData([]);
                }
            } else {
                console.error('[drawKlines] âŒ é”™è¯¯ï¼šæ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯ä»¥æ¸²æŸ“');
                candlestickSeries.setData([]);
            }
            
            // å¦‚æœæœ‰æˆäº¤é‡æ•°æ®ï¼Œä¹Ÿæ›´æ–°æˆäº¤é‡ç³»åˆ—
            // if (volumeSeries && sortedData[0].volume !== undefined) {
            //     const volumeData = sortedData.map(function(k) {
            //         return {
            //             time: Math.floor(k.timestamp / 1000),
            //             value: k.volume,
            //             color: k.close >= k.open ? '#0ecb81' : '#f6465d'
            //         };
            //     });
            //     volumeSeries.setData(volumeData);
            // }
            
            // æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦è‡ªåŠ¨é€‚é…è§†å›¾
            if (shouldFitContent !== false) {
                // å…ˆé€‚é…å†…å®¹ä»¥æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                tvChart.timeScale().fitContent();
                // ç„¶åæ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆå³ä¾§ï¼‰ï¼Œç¡®ä¿æœ€æ–°Kçº¿åœ¨å³ä¾§å¯è§
                // scrollToPosition(-1, false) è¡¨ç¤ºæ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆ-1è¡¨ç¤ºæœ€åä¸€ä¸ªä½ç½®ï¼‰
                setTimeout(function() {
                    if (tvChart) {
                        tvChart.timeScale().scrollToPosition(-1, false);
                    }
                }, 100);
                // å¯ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼ˆå®æ—¶æ¨¡å¼ï¼‰
                enableAutoScroll();
            }
        }

        // åŠ è½½ä»Šæ—¥ç»Ÿè®¡
        function loadTodayStats(symbol) {
            request({
                url: '/api/market/kline/today-stats?symbol=' + symbol
            }).then(function(res) {
                if (res.data) {
                    const stats = res.data;
                    
                    // æ›´æ–°Headerç»Ÿè®¡
                    document.getElementById('headerVolume').innerText = formatVolume(stats.todayVolume || 0);
                    
                    // æ›´æ–°å³ä¾§ç»Ÿè®¡
                    document.getElementById('statTodayHigh').innerText = '$' + (stats.todayHigh || 0).toFixed(2);
                    document.getElementById('statTodayLow').innerText = '$' + (stats.todayLow || 0).toFixed(2);
                    
                    const change = stats.todayChange || 0;
                    const changeText = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                    const changeEl = document.getElementById('statTodayChange');
                    changeEl.innerText = changeText;
                    changeEl.className = 'market-stat-value ' + (change >= 0 ? 'up' : 'down');
                    
                    document.getElementById('statTodayVolume').innerText = formatVolume(stats.todayVolume || 0);
                }
            }).catch(function(err) {
                console.error('åŠ è½½ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', err);
            });
        }

        // æ ¼å¼åŒ–æˆäº¤é‡
        function formatVolume(volume) {
            if (volume >= 1000000000) {
                return (volume / 1000000000).toFixed(2) + 'B';
            } else if (volume >= 1000000) {
                return (volume / 1000000).toFixed(2) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(2) + 'K';
            }
            return volume.toFixed(2);
        }

        // è¿æ¥WebSocket
        function connectWebSocket(symbol) {
            try {
                socket = new SockJS('/ws/market');
                stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function(frame) {
                    console.log('[WebSocket] è¿æ¥æˆåŠŸï¼Œè®¢é˜…äº¤æ˜“å¯¹:', symbol);
                    updateConnectionStatus(true);
                    
                    // è®¢é˜…Kçº¿æ•°æ®
                    stompClient.subscribe('/topic/kline/' + symbol, function(message) {
                        try {
                            const kline = JSON.parse(message.body);
                            console.log('[WebSocket] æ”¶åˆ°Kçº¿æ•°æ®:', {
                                symbol: kline.symbol,
                                interval: kline.interval,
                                timestamp: kline.timestamp,
                                close: kline.close
                            });
                            handleRealtimeKline(kline);
                        } catch (err) {
                            console.error('[WebSocket] è§£æKçº¿æ•°æ®å¤±è´¥:', err, message.body);
                        }
                    });
                }, function(error) {
                    console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                    updateConnectionStatus(false);
                    setTimeout(function() {
                        if (activeSymbol) {
                            const apiSymbol = formatSymbolForApi(activeSymbol, activeMarketType);
                            connectWebSocket(apiSymbol);
                        }
                    }, 3000);
                });
            } catch (err) {
                console.error('WebSocketè¿æ¥å¼‚å¸¸:', err);
                updateConnectionStatus(false);
            }
        }

        // æ–­å¼€WebSocket
        function disconnectWebSocket() {
            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
            }
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        // ========== å®æ—¶Kçº¿å¤„ç† ==========
        /**
         * å¤„ç†å®æ—¶Kçº¿æ•°æ®
         * æ™ºèƒ½æ›´æ–°ï¼šä»…åœ¨å®æ—¶æ¨¡å¼ä¸‹è‡ªåŠ¨æ»šåŠ¨ï¼Œå†å²æ¨¡å¼ä¸‹é™é»˜æ›´æ–°æ•°æ®
         */
        function handleRealtimeKline(kline) {
            // è·å–APIæ ¼å¼çš„symbolç”¨äºæ¯”è¾ƒ
            const apiSymbol = formatSymbolForApi(activeSymbol, activeMarketType);
            if (!activeSymbol || kline.symbol !== apiSymbol || kline.interval !== activeTimeframe) {
                return;
            }
            
            if (!candlestickSeries || !tvChart) return;
            
            // ç¡®ä¿ timestamp æ˜¯æ•°å­—ç±»å‹
            let timestampMs = kline.timestamp;
            if (timestampMs == null) {
                console.error('[handleRealtimeKline] âŒ æ—¶é—´æˆ³ä¸º null æˆ– undefined:', kline);
                return;
            }
            if (typeof timestampMs === 'string') {
                timestampMs = parseInt(timestampMs, 10);
            }
            timestampMs = Number(timestampMs);
            
            if (isNaN(timestampMs) || timestampMs <= 0 || !isFinite(timestampMs)) {
                console.error('[handleRealtimeKline] âŒ æ— æ•ˆçš„æ—¶é—´æˆ³:', kline.timestamp, 'è½¬æ¢å:', timestampMs, 'åŸå§‹æ•°æ®:', kline);
                return;
            }
            
            // åç«¯è¿”å›çš„timestampæ˜¯UTCæ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œè½¬æ¢ä¸ºTradingViewéœ€è¦çš„ç§’çº§
            const time = Math.floor(timestampMs / 1000);
            
            // éªŒè¯å¹¶è½¬æ¢ä»·æ ¼æ•°æ®ï¼ˆä½¿ç”¨ Number è€Œä¸æ˜¯ parseFloatï¼Œæ›´ä¸¥æ ¼ï¼‰
            const open = (kline.open != null && kline.open !== '') ? Number(kline.open) : NaN;
            const high = (kline.high != null && kline.high !== '') ? Number(kline.high) : NaN;
            const low = (kline.low != null && kline.low !== '') ? Number(kline.low) : NaN;
            const close = (kline.close != null && kline.close !== '') ? Number(kline.close) : NaN;
            
            // éªŒè¯ä»·æ ¼æ•°æ®æœ‰æ•ˆæ€§ï¼ˆç¡®ä¿æ˜¯æœ‰æ•ˆæ•°å­—ä¸”æœ‰é™ï¼‰
            if (isNaN(open) || !isFinite(open) || 
                isNaN(high) || !isFinite(high) || 
                isNaN(low) || !isFinite(low) || 
                isNaN(close) || !isFinite(close)) {
                console.error('[handleRealtimeKline] âŒ æ— æ•ˆçš„ä»·æ ¼æ•°æ®:', {
                    open: kline.open, high: kline.high, low: kline.low, close: kline.close,
                    è½¬æ¢å: {open, high, low, close},
                    åŸå§‹æ•°æ®: kline
                });
                return;
            }
            
            // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ‰€æœ‰å€¼éƒ½ä¸æ˜¯ nullã€NaN æˆ– Infinity
            if (time == null || isNaN(time) || !isFinite(time) || time <= 0 || 
                open == null || isNaN(open) || !isFinite(open) || 
                high == null || isNaN(high) || !isFinite(high) || 
                low == null || isNaN(low) || !isFinite(low) || 
                close == null || isNaN(close) || !isFinite(close)) {
                console.error('[handleRealtimeKline] âŒ æœ€ç»ˆéªŒè¯å¤±è´¥ï¼Œæ•°æ®åŒ…å« nullã€NaN æˆ– Infinity:', {
                    time, open, high, low, close, timestampMs, åŸå§‹æ•°æ®: kline
                });
                return;
            }
            
            const chartKline = {
                time: time,
                open: open,
                high: high,
                low: low,
                close: close
            };
            
            // æ›´æ–° kline å¯¹è±¡çš„ timestamp ä¸ºæ•°å­—ç±»å‹
            kline.timestamp = timestampMs;
            
            // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç›¸åŒæ—¶é—´çš„Kçº¿
            let updated = false;
            let isNewKline = false;
            
            if (klinesData.length > 0) {
                const lastKline = klinesData[klinesData.length - 1];
                if (lastKline.timestamp === timestampMs) {
                    // æ›´æ–°æœ€åä¸€æ ¹Kçº¿ï¼ˆKçº¿è¿˜æœªå®Œæˆï¼‰
                    klinesData[klinesData.length - 1] = kline;
                    try {
                        candlestickSeries.update(chartKline);
                        updated = true;
                    } catch (err) {
                        console.error('[handleRealtimeKline] âŒ update å¤±è´¥:', err, 'æ•°æ®:', chartKline);
                    }
                } else if (timestampMs > lastKline.timestamp) {
                    // æ–°å¢Kçº¿ï¼ˆæ–°çš„ä¸€æ ¹Kçº¿å¼€å§‹ï¼‰
                    klinesData.push(kline);
                    isNewKline = true;
                    
                    // æ›´æ–°æ•°æ®çª—å£è¾¹ç•Œ
                    dataWindow.updateBoundaries([kline]);
                    
                    // é™åˆ¶æ•°æ®é‡ï¼ˆä¿ç•™æœ€æ–°çš„2000æ ¹ï¼Œä¸åˆå§‹åŠ è½½å’ŒåŠ è½½æ›´å¤šä¿æŒä¸€è‡´ï¼‰
                    const MAX_KLINES = 2000;
                    if (klinesData.length > MAX_KLINES) {
                        // åˆ é™¤æœ€æ—§çš„æ•°æ®ï¼Œä¿ç•™æœ€æ–°çš„2000æ ¹
                        const removeCount = klinesData.length - MAX_KLINES;
                        klinesData = klinesData.slice(removeCount);
                        // æ›´æ–°å·¦è¾¹ç•Œ
                        if (klinesData.length > 0) {
                            dataWindow.leftBoundary = klinesData[0].timestamp;
                        }
                    }
                    
                    try {
                        candlestickSeries.update(chartKline);
                        updated = true;
                    } catch (err) {
                        console.error('[handleRealtimeKline] âŒ update å¤±è´¥:', err, 'æ•°æ®:', chartKline);
                    }
                }
            } else {
                // é¦–æ¬¡æ•°æ®
                klinesData.push(kline);
                dataWindow.updateBoundaries([kline]);
                try {
                    candlestickSeries.update(chartKline);
                    updated = true;
                    isNewKline = true;
                } catch (err) {
                    console.error('[handleRealtimeKline] âŒ update å¤±è´¥:', err, 'æ•°æ®:', chartKline);
                }
            }
            
            if (updated) {
                // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
            updatePriceDisplay(kline.close);
                
                // é‡æ„ï¼šä½¿ç”¨åç«¯è¿”å›çš„timeå­—æ®µï¼ˆå·²ä»timeStringæ”¹ä¸ºtimeï¼‰
                const timeStr = kline.time || (kline.timestamp ? formatTimeUTCFull(kline.timestamp) : '');
                document.getElementById('statusTime').innerText = timeStr;
                
                // å¦‚æœå¯ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼Œä¸”æ˜¯æ–°Kçº¿ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®
                if (isAutoScrollEnabled && isNewKline) {
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ•°æ®å·²æ›´æ–°
                    setTimeout(function() {
                        if (tvChart && isAutoScrollEnabled) {
                            // æ»šåŠ¨åˆ°æœ€æ–°æ•°æ®
                            tvChart.timeScale().scrollToPosition(-1, false);
                        }
                    }, 50);
                }
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusConnection');
            
            if (connected) {
                indicator.className = 'status-dot connected';
                statusText.innerText = 'Connected';
                document.getElementById('headerStatus').innerText = 'â— Live';
                document.getElementById('headerStatus').style.color = '#0ecb81';
            } else {
                indicator.className = 'status-dot disconnected';
                statusText.innerText = 'Disconnected';
                document.getElementById('headerStatus').innerText = 'â— Offline';
                document.getElementById('headerStatus').style.color = '#f6465d';
            }
        }

        // ========== å†å²æ•°æ®è‡ªåŠ¨åŠ è½½ç³»ç»Ÿ ==========
        /**
         * è®¾ç½®å†å²æ•°æ®è‡ªåŠ¨åŠ è½½ç›‘å¬å™¨
         * ç›‘å¬æ—¶é—´è½´å˜åŒ–ï¼Œæ™ºèƒ½åŠ è½½å†å²æ•°æ®
         */
        function setupHistoricalDataLoading() {
            if (!tvChart) return;
            
            // é˜²æŠ–ï¼šé¿å…é¢‘ç¹è§¦å‘
            let debounceTimer = null;
            const DEBOUNCE_DELAY = 300; // 300msé˜²æŠ–
            
            // ç›‘å¬æ—¶é—´è½´å¯è§èŒƒå›´å˜åŒ–
            tvChart.timeScale().subscribeVisibleTimeRangeChange(function() {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (debounceTimer) {
                    clearTimeout(debounceTimer);
                }
                
                // é˜²æŠ–å¤„ç†
                debounceTimer = setTimeout(function() {
                    handleTimeScaleChange();
                }, DEBOUNCE_DELAY);
            });
        }
        
        /**
         * å¤„ç†æ—¶é—´è½´å˜åŒ–äº‹ä»¶
         * 1. æ£€æµ‹æ˜¯å¦éœ€è¦åŠ è½½å†å²æ•°æ®
         * 2. æ£€æµ‹æ˜¯å¦åº”è¯¥æ¢å¤å®æ—¶æ¨¡å¼
         */
        function handleTimeScaleChange() {
            if (!tvChart || !activeSymbol || isLoadingMore) return;
            
            try {
                const visibleRange = tvChart.timeScale().getVisibleRange();
                if (!visibleRange || !visibleRange.from === null || !visibleRange.to === null) {
                    return;
                }
                
                // è½¬æ¢ä¸ºæ¯«ç§’çº§æ—¶é—´æˆ³
                const visibleStartTimeMs = Math.floor(visibleRange.from) * 1000;
                const visibleEndTimeMs = Math.floor(visibleRange.to) * 1000;
                
                // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´æ—©çš„å†å²æ•°æ®
                // é˜ˆå€¼ï¼šå½“è·ç¦»å·¦è¾¹ç•Œè¿˜æœ‰5æ ¹Kçº¿æ—¶ï¼Œå¼€å§‹åŠ è½½
                const LOAD_THRESHOLD_BARS = 5;
                if (dataWindow.shouldLoadEarlier(visibleStartTimeMs, LOAD_THRESHOLD_BARS)) {
                    loadEarlierKlines(visibleStartTimeMs);
                }
                
                // 2. æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¢å¤å®æ—¶æ¨¡å¼ï¼ˆAuto-Scrollï¼‰
                // é˜ˆå€¼ï¼šå½“æ¥è¿‘æœ€æ–°æ•°æ®æ—¶ï¼Œå¯ç”¨Auto-Scroll
                const REALTIME_THRESHOLD_BARS = 3;
                const shouldEnableAutoScroll = dataWindow.isNearRealtime(visibleEndTimeMs, REALTIME_THRESHOLD_BARS);
                
                if (shouldEnableAutoScroll && !isAutoScrollEnabled) {
                    enableAutoScroll();
                } else if (!shouldEnableAutoScroll && isAutoScrollEnabled) {
                    disableAutoScroll();
                }
            } catch (error) {
                console.error('å¤„ç†æ—¶é—´è½´å˜åŒ–å¤±è´¥:', error);
            }
        }
        
        /**
         * å¯ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼ˆå®æ—¶æ¨¡å¼ï¼‰
         * å›¾è¡¨è‡ªåŠ¨è·Ÿéšæœ€æ–°æ•°æ®
         */
        function enableAutoScroll() {
            isAutoScrollEnabled = true;
            console.log('åˆ‡æ¢åˆ°å®æ—¶æ¨¡å¼ï¼šå¯ç”¨Auto-Scroll');
        }
        
        /**
         * ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼ˆå†å²æ¨¡å¼ï¼‰
         * ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å†å²æ•°æ®ï¼Œä¸è‡ªåŠ¨æ»šåŠ¨
         */
        function disableAutoScroll() {
            isAutoScrollEnabled = false;
            console.log('åˆ‡æ¢åˆ°å†å²æ¨¡å¼ï¼šç¦ç”¨Auto-Scroll');
        }
        
        // ========== å†å²æ•°æ®åŠ è½½ ==========
        let isLoadingMore = false;
        let lastLoadRequestId = 0;
        
        /**
         * åŠ è½½æ›´æ—©çš„Kçº¿æ•°æ®ï¼ˆç”¨æˆ·æ‹–åŠ¨è¶…å‡ºå½“å‰æ•°æ®èŒƒå›´æ—¶è°ƒç”¨ï¼‰
         * 
         * é€»è¾‘ï¼š
         * 1. ä»å½“å‰æœ€æ—§çš„æ—¶é—´ç‚¹å¾€å‰æ¨1åˆ†é’Ÿä½œä¸ºèµ·å§‹ç‚¹
         * 2. æŸ¥è¯¢200æ ¹Kçº¿ï¼ˆå‡åºï¼‰
         * 3. ç¡®ä¿æ•°æ®è¿ç»­æ€§ï¼šæ–°æ•°æ®çš„æœ€æ™šæ—¶é—´åº”è¯¥ç­‰äºç°æœ‰æ•°æ®æœ€æ—©æ—¶é—´-1åˆ†é’Ÿ
         * 
         * @param {number} visibleStartTimeMs å½“å‰å¯è§èŒƒå›´çš„å¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         */
        function loadEarlierKlines(visibleStartTimeMs) {
            if (klinesData.length === 0 || isLoadingMore) {
                return;
            }
            
            // è·å–å½“å‰æœ€æ—§çš„Kçº¿æ—¶é—´
            const oldestKlineTime = klinesData[0].timestamp;
            const timeframeMs = getTimeframeMs(activeTimeframe);
            
            // ========== é‡æ„ï¼šå†å²æ•°æ®åŠ è½½æ—¶é—´è®¡ç®—ï¼ˆåç«¯å·²ç»Ÿä¸€ä½¿ç”¨UTCï¼‰ ==========
            // åç«¯å·²ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´æˆ³ï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨UTCæ—¶é—´æˆ³ï¼Œæ— éœ€æ—¶åŒºè½¬æ¢
            // é€»è¾‘ï¼šä»æœ€æ—§æ—¶é—´-1ä¸ªå‘¨æœŸå¼€å§‹ï¼Œå¾€å‰æŸ¥è¯¢200æ ¹Kçº¿
            
            // è®¡ç®—UTCæ—¶é—´æˆ³ï¼ˆåç«¯æœŸæœ›UTCæ—¶é—´æˆ³ï¼‰
            const loadTo = oldestKlineTime - timeframeMs; // to = æœ€æ—§æ—¶é—´ - 1ä¸ªå‘¨æœŸï¼ˆUTCæ—¶é—´æˆ³ï¼‰
            const loadFrom = loadTo - (LOAD_MORE_LIMIT * timeframeMs); // from = to - 200ä¸ªå‘¨æœŸï¼ˆUTCæ—¶é—´æˆ³ï¼‰
            
            // ç”Ÿæˆè¯·æ±‚IDï¼ˆåŸºäºæ—¶é—´èŒƒå›´ï¼‰ï¼Œç”¨äºé˜²é‡å¤
            const requestId = `${Math.floor(loadFrom / 1000)}-${Math.floor(loadTo / 1000)}`;
            if (dataWindow.pendingRequests.has(requestId)) {
                console.log(`[åŠ è½½æ›´å¤š] è·³è¿‡é‡å¤è¯·æ±‚: from=${loadFrom}, to=${loadTo}`);
                return;
            }
            
            // æ£€æŸ¥æ—¶é—´èŒƒå›´æ˜¯å¦åˆç†
            if (loadFrom >= loadTo || loadFrom < 0) {
                console.warn(`[åŠ è½½æ›´å¤š] æ—¶é—´èŒƒå›´ä¸åˆç†: from=${loadFrom}, to=${loadTo}`);
                return;
            }
            
            isLoadingMore = true;
            dataWindow.pendingRequests.add(requestId);
            
            // æ—¥å¿—ï¼šæ˜¾ç¤ºUTCæ—¶é—´æˆ³ï¼ˆåç«¯å·²ç»Ÿä¸€ä½¿ç”¨UTCï¼‰
            console.log(`[åŠ è½½æ›´å¤š] æ—¶é—´è®¡ç®—ï¼ˆUTCæ—¶é—´æˆ³ï¼‰:`);
            console.log(`  - æœ€æ—§Kçº¿æ—¶é—´æˆ³(UTC): ${oldestKlineTime} (${new Date(oldestKlineTime).toISOString()})`);
            console.log(`  - æŸ¥è¯¢å‚æ•° to(UTC): ${loadTo} (${new Date(loadTo).toISOString()})`);
            console.log(`  - æŸ¥è¯¢å‚æ•° from(UTC): ${loadFrom} (${new Date(loadFrom).toISOString()})`);
            
            // ä½¿ç”¨APIæ ¼å¼çš„symbol
            const apiSymbol = formatSymbolForApi(activeSymbol, activeMarketType);
            const params = new URLSearchParams();
            params.append('symbol', apiSymbol);
            params.append('interval', activeTimeframe);
            params.append('from', loadFrom); // å‘é€UTCæ—¶é—´æˆ³
            params.append('to', loadTo);     // å‘é€UTCæ—¶é—´æˆ³
            params.append('limit', LOAD_MORE_LIMIT); // åŠ è½½200æ ¹Kçº¿
            
            request({
                url: '/api/market/kline?' + params.toString(),
                method: 'GET'
            }).then(function(res) {
                if (res.data && res.data.length > 0) {
                    // åç«¯å·²ç»è¿”å›å‡åºæ•°æ®ï¼ˆä»æ—§åˆ°æ–°ï¼‰ï¼Œç¡®ä¿ timestamp æ˜¯æ•°å­—ç±»å‹
                    const newData = res.data.map(function(k) {
                        if (typeof k.timestamp === 'string') {
                            k.timestamp = parseInt(k.timestamp, 10);
                        }
                        return k;
                    });
                    
                    // ç®€åŒ–æ—¥å¿—ï¼šåªä½¿ç”¨UTCæ—¶é—´æˆ³å’ŒUTCæ—¶é—´å­—ç¬¦ä¸²
                    if (newData.length > 0) {
                        const firstTimestamp = newData[0].timestamp;
                        const lastTimestamp = newData[newData.length - 1].timestamp;
                        console.log(`[åŠ è½½æ›´å¤š] åç«¯è¿”å›æ•°æ®éªŒè¯ï¼ˆUTCæ—¶é—´æˆ³ï¼‰:`);
                        console.log(`  - è¿”å›æ•°é‡: ${newData.length} æ ¹`);
                        console.log(`  - ç¬¬ä¸€æ¡æ—¶é—´æˆ³: ${firstTimestamp} (${new Date(firstTimestamp).toISOString()})`);
                        console.log(`  - æœ€åä¸€æ¡æ—¶é—´æˆ³: ${lastTimestamp} (${new Date(lastTimestamp).toISOString()})`);
                        
                        // æ£€æŸ¥æ•°æ®è¿ç»­æ€§ï¼šæ–°æ•°æ®å†…éƒ¨æ˜¯å¦è¿ç»­
                        for (let i = 1; i < newData.length; i++) {
                            const gap = newData[i].timestamp - newData[i-1].timestamp;
                            if (Math.abs(gap - timeframeMs) > timeframeMs / 2) {
                                console.warn(`  âš ï¸ æ–°æ•°æ®å†…éƒ¨ä¸è¿ç»­ï¼šç¬¬${i-1}æ¡åˆ°ç¬¬${i}æ¡é—´éš”${gap}msï¼ŒæœŸæœ›${timeframeMs}ms`);
                            }
                        }
                        
                        // æ£€æŸ¥ä¸ç°æœ‰æ•°æ®çš„è¿ç»­æ€§ï¼ˆUTCæ—¶é—´æˆ³ç›´æ¥æ¯”è¾ƒï¼Œä»…ç”¨äºæ—¥å¿—ï¼‰
                        const lastTime = newData[newData.length - 1].timestamp;
                        const timeGap = oldestKlineTime - lastTime;
                        const expectedGap = timeframeMs; // åº”è¯¥ç›¸å·®1ä¸ªå‘¨æœŸ
                        console.log(`  - ä¸ç°æœ‰æ•°æ®çš„æ—¶é—´é—´éš”: ${timeGap}ms (æœŸæœ›: ${expectedGap}msï¼Œå³1ä¸ªå‘¨æœŸ)`);
                    }
                    
                    // æ•°æ®è¿ç»­æ€§æ£€æŸ¥ï¼šæ–°æ•°æ®çš„æœ€æ™šæ—¶é—´åº”è¯¥å°äºç°æœ‰æ•°æ®çš„æœ€æ—©æ—¶é—´
                    // å¦‚æœæ–°æ•°æ®çš„æœ€æ™šæ—¶é—´ >= ç°æœ‰æ•°æ®æœ€æ—©æ—¶é—´ï¼Œè¯´æ˜æœ‰é‡å ï¼Œéœ€è¦è¿‡æ»¤
                    const existingFirstTime = klinesData[0].timestamp;
                    const lastNewDataTime = newData[newData.length - 1].timestamp;
                    
                    // è¿‡æ»¤æ‰æ—¶é—´å¤§äºç­‰äºexistingFirstTimeçš„æ•°æ®ï¼ˆå»é‡ï¼‰
                    const filteredNewData = newData.filter(function(k) {
                        return k.timestamp < existingFirstTime;
                    });
                    
                    if (filteredNewData.length > 0) {
                        // ä¿å­˜å½“å‰å¯è§èŒƒå›´ï¼ˆç”¨äºä¿æŒæ»šåŠ¨ä½ç½®ï¼‰
                        const currentVisibleRange = tvChart.timeScale().getVisibleRange();
                        const oldFirstTime = klinesData[0].timestamp;
                        
                        // å°†æ–°æ•°æ®prependåˆ°ç°æœ‰æ•°æ®ï¼ˆæ–°æ•°æ®åœ¨å‰ï¼Œå› ä¸ºæ—¶é—´æ›´æ—©ï¼‰
                        klinesData = filteredNewData.concat(klinesData);
                        
                        // é™åˆ¶æ€»æ•°æ®é‡ï¼ˆæœ€å¤šä¿ç•™2000æ ¹ï¼Œé¿å…å†…å­˜é—®é¢˜ï¼‰
                        const MAX_KLINES = 2000;
                        if (klinesData.length > MAX_KLINES) {
                            // ä¿ç•™æœ€æ–°çš„2000æ ¹ï¼ˆåˆ é™¤æœ€æ—§çš„æ•°æ®ï¼‰
                            const removeCount = klinesData.length - MAX_KLINES;
                            klinesData = klinesData.slice(removeCount);
                        }
                        
                        // æ›´æ–°æ•°æ®çª—å£è¾¹ç•Œ
                        dataWindow.updateBoundaries(filteredNewData);
                        
                        // æ›´æ–°å›¾è¡¨æ•°æ®
                        const chartData = klinesData.map(function(k) {
                            // é¦–å…ˆæ£€æŸ¥æ•´ä¸ªå¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
                            if (!k || typeof k !== 'object') {
                                return null;
                            }
                            
                            // ç¡®ä¿ timestamp æ˜¯æ•°å­—ç±»å‹
                            let timestampMs = k.timestamp;
                            if (timestampMs == null) {
                                return null;
                            }
                            if (typeof timestampMs === 'string') {
                                timestampMs = parseInt(timestampMs, 10);
                            }
                            timestampMs = Number(timestampMs);
                            
                            // éªŒè¯æ—¶é—´æˆ³æœ‰æ•ˆæ€§
                            if (isNaN(timestampMs) || timestampMs <= 0 || !isFinite(timestampMs)) {
                                return null;
                            }
                            
                            // éªŒè¯å¹¶è½¬æ¢ä»·æ ¼æ•°æ®ï¼ˆä½¿ç”¨ Number è€Œä¸æ˜¯ parseFloatï¼Œæ›´ä¸¥æ ¼ï¼‰
                            const open = (k.open != null && k.open !== '') ? Number(k.open) : NaN;
                            const high = (k.high != null && k.high !== '') ? Number(k.high) : NaN;
                            const low = (k.low != null && k.low !== '') ? Number(k.low) : NaN;
                            const close = (k.close != null && k.close !== '') ? Number(k.close) : NaN;
                            
                            // éªŒè¯ä»·æ ¼æ•°æ®æœ‰æ•ˆæ€§ï¼ˆç¡®ä¿æ˜¯æœ‰æ•ˆæ•°å­—ä¸”æœ‰é™ï¼‰
                            if (isNaN(open) || !isFinite(open) || 
                                isNaN(high) || !isFinite(high) || 
                                isNaN(low) || !isFinite(low) || 
                                isNaN(close) || !isFinite(close)) {
                                return null;
                            }
                            
                            // è®¡ç®—ç§’çº§æ—¶é—´æˆ³
                            const timeSec = Math.floor(timestampMs / 1000);
                            
                            // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ‰€æœ‰å€¼éƒ½ä¸æ˜¯ nullã€NaN æˆ– Infinity
                            if (timeSec == null || isNaN(timeSec) || !isFinite(timeSec) || timeSec <= 0 ||
                                open == null || isNaN(open) || !isFinite(open) ||
                                high == null || isNaN(high) || !isFinite(high) ||
                                low == null || isNaN(low) || !isFinite(low) ||
                                close == null || isNaN(close) || !isFinite(close)) {
                                return null;
                            }
                            
                            return {
                                time: timeSec, // TradingViewä½¿ç”¨ç§’çº§æ—¶é—´æˆ³
                                open: open,
                                high: high,
                                low: low,
                                close: close
                            };
                        }).filter(function(item) {
                            // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®ï¼ˆnull æˆ–åŒ…å«æ— æ•ˆå€¼çš„å¯¹è±¡ï¼‰
                            if (item === null) return false;
                            if (item.time == null || isNaN(item.time) || !isFinite(item.time) || item.time <= 0) return false;
                            if (item.open == null || isNaN(item.open) || !isFinite(item.open)) return false;
                            if (item.high == null || isNaN(item.high) || !isFinite(item.high)) return false;
                            if (item.low == null || isNaN(item.low) || !isFinite(item.low)) return false;
                            if (item.close == null || isNaN(item.close) || !isFinite(item.close)) return false;
                            return true;
                        });
                        
                        if (candlestickSeries && tvChart) {
                            // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ²¡æœ‰ null å€¼
                            const finalData = chartData.filter(function(item) {
                                if (!item) return false;
                                if (item.time == null || isNaN(item.time) || item.time <= 0) return false;
                                if (item.open == null || isNaN(item.open)) return false;
                                if (item.high == null || isNaN(item.high)) return false;
                                if (item.low == null || isNaN(item.low)) return false;
                                if (item.close == null || isNaN(item.close)) return false;
                                return true;
                            });
                            
                            // ä½¿ç”¨setDataæ›´æ–°å…¨éƒ¨æ•°æ®ï¼ˆTradingViewä¼šè‡ªåŠ¨ä¼˜åŒ–æ¸²æŸ“ï¼‰
                            try {
                                candlestickSeries.setData(finalData);
                            } catch (err) {
                                console.error('[loadEarlierKlines] âŒ setData å¤±è´¥:', err, 'æ•°æ®æ•°é‡:', finalData.length);
                            }
                            
                            // ä¿æŒæ»šåŠ¨ä½ç½®ï¼šè®¡ç®—æ—¶é—´åç§»å¹¶è°ƒæ•´å¯è§èŒƒå›´
                            if (currentVisibleRange && oldFirstTime !== klinesData[0].timestamp) {
                                const newFirstTime = Math.floor(klinesData[0].timestamp / 1000);
                                const oldFirstTimeSec = Math.floor(oldFirstTime / 1000);
                                const timeOffset = oldFirstTimeSec - newFirstTime;
                                
                                // è°ƒæ•´å¯è§èŒƒå›´ï¼Œä¿æŒç”¨æˆ·å½“å‰æŸ¥çœ‹çš„ä½ç½®
                                tvChart.timeScale().setVisibleRange({
                                    from: currentVisibleRange.from + timeOffset,
                                    to: currentVisibleRange.to + timeOffset
                                });
                            }
                        }
                        
                        console.log(`[åŠ è½½æ›´å¤š] æˆåŠŸåŠ è½½ ${filteredNewData.length} æ ¹Kçº¿ï¼Œå½“å‰æ€»æ•°: ${klinesData.length}`);
                    }
                }
                
                isLoadingMore = false;
                dataWindow.pendingRequests.delete(requestId);
            }).catch(function(err) {
                console.error('[åŠ è½½æ›´å¤š] åŠ è½½å¤±è´¥:', err);
                isLoadingMore = false;
                dataWindow.pendingRequests.delete(requestId);
            });
        }

        // å®æ—¶æ›´æ–°è¡Œæƒ…ä¿¡æ¯çš„å®šæ—¶å™¨
        let marketDataRefreshTimer = null;
        
        // å¯åŠ¨å®æ—¶è¡Œæƒ…æ›´æ–°
        function startMarketDataRefresh() {
            // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡è¡Œæƒ…æ•°æ®
            if (marketDataRefreshTimer) {
                clearInterval(marketDataRefreshTimer);
            }
            marketDataRefreshTimer = setInterval(function() {
                refreshSymbolListMarketData();
            }, 5000);
        }
        
        // åœæ­¢å®æ—¶è¡Œæƒ…æ›´æ–°
        function stopMarketDataRefresh() {
            if (marketDataRefreshTimer) {
                clearInterval(marketDataRefreshTimer);
                marketDataRefreshTimer = null;
            }
        }
        
        // åˆ·æ–°äº¤æ˜“å¯¹åˆ—è¡¨çš„è¡Œæƒ…æ•°æ®ï¼ˆåªæ›´æ–°æ•°æ®ï¼Œä¸é‡æ–°åˆ›å»ºDOMï¼‰
        function refreshSymbolListMarketData() {
            request({
                url: '/api/market-subscription/list?enabled=1'
            }).then(function(res) {
                if (res.data && res.data.length > 0) {
                    res.data.forEach(function(item) {
                        // æ›´æ–° symbolInfoMap
                        symbolInfoMap[item.symbol] = {
                            symbol: item.symbol,
                            marketType: item.marketType || 'SPOT'
                        };
                        
                        // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
                        const symbolItem = document.querySelector(`.symbol-item[data-symbol="${item.symbol}"]`);
                        if (!symbolItem) return;
                        
                        // æ›´æ–°ä»·æ ¼å’Œæ¶¨è·Œå¹…
                        const change = parseFloat(item.todayChange) || 0;
                        const changeClass = change >= 0 ? 'up' : 'down';
                        const changeText = (change >= 0 ? '+' : '') + Math.abs(change).toFixed(2) + '%';
                        
                        // æ ¼å¼åŒ–æ˜¾ç¤ºåç§°
                        const displaySymbol = formatSymbolForDisplay(item.symbol, item.marketType);
                        
                        // æ ¼å¼åŒ–ä»·æ ¼
                        const price = item.currentPrice || 0;
                        const formattedPrice = price > 0 ? '$' + price.toFixed(2) : '-';
                        
                        // æ ¼å¼åŒ–24hç»Ÿè®¡
                        const todayHigh = item.todayHigh || 0;
                        const todayLow = item.todayLow || 0;
                        const todayVolume = item.todayVolume || 0;
                        const formattedHigh = todayHigh > 0 ? '$' + todayHigh.toFixed(2) : '-';
                        const formattedLow = todayLow > 0 ? '$' + todayLow.toFixed(2) : '-';
                        const formattedVolume = todayVolume > 0 ? formatVolume(todayVolume) : '-';
                        
                        // æ›´æ–°DOMï¼ˆä¿æŒé€‰ä¸­çŠ¶æ€ï¼‰
                        const isActive = symbolItem.classList.contains('active');
                        symbolItem.innerHTML = `
                            <div class="symbol-item-row">
                                <span class="symbol-name">${displaySymbol}</span>
                            </div>
                            <div class="symbol-item-row">
                                <span class="symbol-change ${changeClass}">${changeText}</span>
                            </div>
                        `;
                        
                        // æ¢å¤é€‰ä¸­çŠ¶æ€
                        if (isActive) {
                            symbolItem.classList.add('active');
                        }
                        
                        // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                        symbolItem.onclick = function() {
                            selectSymbol(item.symbol, item.marketType);
                        };
                    });
                }
            }).catch(function(err) {
                console.error('åˆ·æ–°è¡Œæƒ…æ•°æ®å¤±è´¥:', err);
            });
        }
        
        // ç­‰å¾…é¡µé¢å’Œåº“å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–å›¾è¡¨
        function initializePage() {
            // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦å·²åŠ è½½
            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts åº“æœªåŠ è½½');
                // å°è¯•å»¶è¿ŸåŠ è½½
                setTimeout(function() {
                    if (typeof LightweightCharts !== 'undefined') {
                        initTradingViewChart();
                        loadSymbolList().then(function() {
                            startMarketDataRefresh();
                        });
                    } else {
                        console.error('LightweightCharts åº“åŠ è½½è¶…æ—¶');
                        const container = document.getElementById('tv-chart-container');
                        if (container) {
                            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #f6465d; padding: 20px; text-align: center;"><div>å›¾è¡¨åº“åŠ è½½å¤±è´¥<br/>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢</div></div>';
                        }
                    }
                }, 1000);
                return;
            }
            
            // åº“å·²åŠ è½½ï¼Œæ­£å¸¸åˆå§‹åŒ–
            initTradingViewChart();
            loadSymbolList().then(function() {
                startMarketDataRefresh();
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            // DOMå·²ç»åŠ è½½å®Œæˆ
            initializePage();
        }
        
        // é¡µé¢å¸è½½æ—¶åœæ­¢å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            stopMarketDataRefresh();
        });
    </script>
</body>
</html>