# ç­–ç•¥é˜¶æ®µ2ï¼šå¼€å‘è§„èŒƒä¸ä»»åŠ¡æ¸…å•

> **åŸºäºæ–‡æ¡£**ï¼š
> - `ç­–ç•¥é˜¶æ®µ2è§„åˆ’.md` - é˜¶æ®µ2ç›®æ ‡ä¸æµç¨‹
>
> **ç‰ˆæœ¬**ï¼šv1.0  
> **åˆ›å»ºæ—¶é—´**ï¼š2024

---

## ğŸ“‹ ç›®å½•

1. [å¼€å‘è§„èŒƒ](#å¼€å‘è§„èŒƒ)
2. [å¼€å‘ä»»åŠ¡æ¸…å•](#å¼€å‘ä»»åŠ¡æ¸…å•)
3. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)
4. [é£é™©ä¸æ³¨æ„äº‹é¡¹](#é£é™©ä¸æ³¨æ„äº‹é¡¹)

---

## ä¸€ã€å¼€å‘è§„èŒƒ

### 1.1 æ¶æ„è§„èŒƒ

#### 1.1.1 æ¨¡å—åˆ’åˆ†ï¼ˆå¿…é¡»éµå¾ªï¼‰

é˜¶æ®µ2å¿…é¡»å®ç°ä»¥ä¸‹5ä¸ªæ ¸å¿ƒæ¨¡å—ï¼ŒèŒè´£è¾¹ç•Œæ¸…æ™°ï¼š

| æ¨¡å— | èŒè´£ | ç¦æ­¢è¡Œä¸º |
|------|------|---------|
| **DecisionEngine** | å†³ç­–å…¥å£ï¼Œåè°ƒæ•´ä¸ªå†³ç­–æµç¨‹ | ä¸ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ |
| **DecisionContextBuilder** | ä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼Œæ„å»ºå†³ç­–ä¸Šä¸‹æ–‡ | ä¸ä¿®æ”¹æ•°æ®ï¼Œåªè¯»æ“ä½œï¼Œæ„å»ºå¿«ç…§ |
| **GuardChain** | å†³ç­–é—¨ç¦é“¾ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸å†³ç­– | ä¸ä¿®æ”¹æ•°æ®ï¼Œä¸ç”Ÿæˆå†³ç­–ï¼Œåªåšæ ¡éªŒ |
| **IntentResolver** | æ„å›¾æ¨å¯¼å™¨ï¼Œçº¯å‡½æ•°æ¨å¯¼æ„å›¾ | ä¸è®¿é—®æ•°æ®åº“ï¼Œä¸ä¿®æ”¹çŠ¶æ€ï¼Œçº¯è®¡ç®— |
| **IntentRecorder** | æ„å›¾è®°å½•å™¨ï¼Œå†³ç­–è½åº“ | ä¸ä¿®æ”¹æ•°æ®ï¼Œåªå†™ä¸€æ¬¡ï¼Œä¸å›æ»š |

#### 1.1.2 æ¨¡å—ä¾èµ–å…³ç³»

```
DecisionEngine
    â†“
DecisionContextBuilder â†’ GuardChain â†’ IntentResolver
    â†“                                    â†“
IntentRecorder â† â† â† â† â† â† â† â† â† â† â† â† â†
```

**ä¾èµ–è§„åˆ™**ï¼š
- ä¸Šå±‚æ¨¡å—å¯ä»¥è°ƒç”¨ä¸‹å±‚æ¨¡å—
- åŒå±‚æ¨¡å—ç¦æ­¢ç›¸äº’è°ƒç”¨
- ç¦æ­¢å¾ªç¯ä¾èµ–

#### 1.1.3 åŒ…ç»“æ„è§„èŒƒ

```
com.qyl.v2trade.business.strategy.decision
â”œâ”€â”€ engine              # å†³ç­–å¼•æ“
â”‚   â””â”€â”€ DecisionEngine
â”œâ”€â”€ context             # ä¸Šä¸‹æ–‡æ„å»º
â”‚   â”œâ”€â”€ DecisionContextBuilder
â”‚   â””â”€â”€ model
â”‚       â””â”€â”€ DecisionContext
â”œâ”€â”€ guard               # å†³ç­–é—¨ç¦
â”‚   â””â”€â”€ GuardChain
â”œâ”€â”€ resolver            # æ„å›¾æ¨å¯¼
â”‚   â”œâ”€â”€ IntentResolver
â”‚   â””â”€â”€ model
â”‚       â””â”€â”€ DecisionResult
â””â”€â”€ recorder            # æ„å›¾è®°å½•
    â”œâ”€â”€ IntentRecorder
    â””â”€â”€ model
        â””â”€â”€ StrategyIntentRecord
```

---

### 1.2 ç¼–ç è§„èŒƒ

#### 1.2.1 å‘½åè§„èŒƒ

**ç±»å‘½å**ï¼š
- æ¥å£ï¼š`I` å‰ç¼€ï¼ˆå¯é€‰ï¼‰æˆ–ç›´æ¥ä½¿ç”¨æè¿°æ€§åç§°
- å®ç°ç±»ï¼š`Impl` åç¼€
- æ¨¡å‹ç±»ï¼š`Context`ã€`Result`ã€`Record` ç­‰åç¼€æ˜ç¡®è¯­ä¹‰
- æšä¸¾ï¼šä½¿ç”¨ `Enum` åç¼€

**æ–¹æ³•å‘½å**ï¼š
- æ„å»ºæ–¹æ³•ï¼š`build`ã€`buildContext`
- æ ¡éªŒæ–¹æ³•ï¼š`check`ã€`validate`ã€`isAllowed`
- æ¨å¯¼æ–¹æ³•ï¼š`resolve`ã€`resolveIntent`
- è®°å½•æ–¹æ³•ï¼š`record`ã€`saveIntent`

**å˜é‡å‘½å**ï¼š
- ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼Œé¿å…ç¼©å†™
- é›†åˆç±»å‹ä½¿ç”¨å¤æ•°ï¼š`guards`ã€`results`
- å¸ƒå°”å€¼ä½¿ç”¨ `is`ã€`has`ã€`should` å‰ç¼€

#### 1.2.2 æ³¨é‡Šè§„èŒƒ

**ç±»æ³¨é‡Š**ï¼ˆå¿…é¡»ï¼‰ï¼š
```java
/**
 * å†³ç­–å¼•æ“
 * 
 * <p>èŒè´£ï¼š
 * <ul>
 *   <li>åè°ƒæ•´ä¸ªå†³ç­–æµç¨‹</li>
 *   <li>äº‹ä»¶é©±åŠ¨è§¦å‘å†³ç­–</li>
 *   <li>ä¿è¯å†³ç­–çš„åŸå­æ€§å’Œå¹‚ç­‰æ€§</li>
 * </ul>
 * 
 * <p>é˜¶æ®µ2çº¦æŸï¼š
 * <ul>
 *   <li>ä¸ä¿®æ”¹ logic_state</li>
 *   <li>ä¸å‘é€äº¤æ˜“æŒ‡ä»¤</li>
 *   <li>åªå†™ strategy_intent_record</li>
 * </ul>
 * 
 * @author å¼€å‘è€…åç§°
 * @since 1.0
 */
public class DecisionEngine {
    // ...
}
```

**æ–¹æ³•æ³¨é‡Š**ï¼ˆå¿…é¡»ï¼‰ï¼š
```java
/**
 * æ‰§è¡Œå†³ç­–
 * 
 * @param instance ç­–ç•¥å®ä¾‹
 * @param trigger è§¦å‘äº‹ä»¶
 * @return å†³ç­–ç»“æœï¼Œå¦‚æœå†³ç­–è¢«æ‹’ç»è¿”å›null
 * @throws IllegalArgumentException å¦‚æœå‚æ•°æ— æ•ˆ
 */
public DecisionResult execute(StrategyInstance instance, DecisionTrigger trigger) {
    // ...
}
```

**å…³é”®é€»è¾‘æ³¨é‡Š**ï¼ˆå¿…é¡»ï¼‰ï¼š
```java
// é˜¶æ®µ2æ ¸å¿ƒçº¦æŸï¼šä¸ä¿®æ”¹logic_stateï¼Œåªå†™intent_record
// çŠ¶æ€ä¿®æ”¹ç”±é˜¶æ®µ3è´Ÿè´£
intentRecorder.record(result);
```

#### 1.2.3 å¼‚å¸¸å¤„ç†è§„èŒƒ

**å¼‚å¸¸ç±»å‹é€‰æ‹©**ï¼š
- `IllegalArgumentException`ï¼šå‚æ•°æ ¡éªŒå¤±è´¥
- `IllegalStateException`ï¼šçŠ¶æ€ä¸åˆæ³•ï¼ˆå¦‚ä¸å…è®¸å†³ç­–ï¼‰
- `BusinessException`ï¼šä¸šåŠ¡é€»è¾‘å¼‚å¸¸ï¼ˆè‡ªå®šä¹‰ï¼‰
- `DataAccessException`ï¼šæ•°æ®åº“è®¿é—®å¼‚å¸¸ï¼ˆSpringæ¡†æ¶ï¼‰

**å¼‚å¸¸å¤„ç†åŸåˆ™**ï¼š
```java
// âœ… æ­£ç¡®ï¼šæ˜ç¡®çš„å¼‚å¸¸ä¿¡æ¯å’Œæ¢å¤å»ºè®®
if (instance == null) {
    throw new IllegalArgumentException("ç­–ç•¥å®ä¾‹ä¸èƒ½ä¸ºnull");
}

// âœ… æ­£ç¡®ï¼šå†³ç­–å¤±è´¥ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å›nullæˆ–HOLD
if (!guardChain.isAllowed(context)) {
    log.debug("å†³ç­–è¢«é—¨ç¦æ‹’ç»: strategyId={}, tradingPairId={}",
        instance.getStrategyId(), instance.getTradingPairId());
    return DecisionResult.hold("é—¨ç¦æ ¡éªŒæœªé€šè¿‡");
}

// âŒ é”™è¯¯ï¼šåæ‰å¼‚å¸¸
try {
    executeDecision(instance);
} catch (Exception e) {
    // ä»€ä¹ˆéƒ½ä¸åš
}
```

#### 1.2.4 æ—¥å¿—è§„èŒƒ

**æ—¥å¿—çº§åˆ«**ï¼š
- `ERROR`ï¼šç³»ç»Ÿé”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
- `WARN`ï¼šè­¦å‘Šï¼Œå¯èƒ½çš„é—®é¢˜ä½†ä¸å½±å“åŠŸèƒ½
- `INFO`ï¼šå…³é”®ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹ï¼ˆå†³ç­–ç”Ÿæˆã€è½åº“ï¼‰
- `DEBUG`ï¼šè¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆä¸Šä¸‹æ–‡æ„å»ºã€é—¨ç¦æ ¡éªŒï¼‰

**æ—¥å¿—æ ¼å¼**ï¼š
```java
// âœ… æ­£ç¡®ï¼šåŒ…å«å…³é”®ä¸Šä¸‹æ–‡ä¿¡æ¯
log.info("ç­–ç•¥å†³ç­–å®Œæˆ: strategyId={}, tradingPairId={}, action={}, qty={}",
    strategyId, tradingPairId, result.getAction(), result.getQty());

// âœ… æ­£ç¡®ï¼šå¼‚å¸¸æ—¥å¿—åŒ…å«å®Œæ•´å †æ ˆ
log.error("å†³ç­–æ‰§è¡Œå¤±è´¥: strategyId={}, tradingPairId={}",
    strategyId, tradingPairId, e);

// âŒ é”™è¯¯ï¼šç¼ºå°‘ä¸Šä¸‹æ–‡
log.info("å†³ç­–å®Œæˆ");
```

---

### 1.3 æ•°æ®è®¿é—®è§„èŒƒ

#### 1.3.1 å†³ç­–è®°å½•é“å¾‹

**é“å¾‹1ï¼šåªå†™ä¸€æ¬¡ï¼Œä¸å›æ»šï¼Œä¸è¦†ç›–**

```java
// âœ… æ­£ç¡®ï¼šå†³ç­–è®°å½•åªå†™ä¸€æ¬¡
intentRecorder.record(result); // åªå†™ä¸€æ¬¡

// âŒ é”™è¯¯ï¼šæ›´æ–°å†å²è®°å½•
intentRecordMapper.updateById(record); // ç¦æ­¢ï¼

// âŒ é”™è¯¯ï¼šåˆ é™¤å†å²è®°å½•
intentRecordMapper.deleteById(recordId); // ç¦æ­¢ï¼
```

**é“å¾‹2ï¼šå†³ç­–è®°å½•å¿…é¡»åŸå­æ€§**

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
@Transactional
public void record(DecisionResult result) {
    StrategyIntentRecord record = convertToRecord(result);
    intentRecordMapper.insert(record);
}

// âŒ é”™è¯¯ï¼šè·¨è¡¨æ“ä½œä¸ä½¿ç”¨äº‹åŠ¡
public void record(DecisionResult result) {
    intentRecordMapper.insert(record);
    // å…¶ä»–æ“ä½œ...
}
```

**é“å¾‹3ï¼šç¦æ­¢åœ¨é˜¶æ®µ2ä¿®æ”¹logic_state**

```java
// âŒ é”™è¯¯ï¼šé˜¶æ®µ2ç¦æ­¢ä¿®æ”¹çŠ¶æ€
logicStateMapper.updateById(state); // ç¦æ­¢ï¼

// âœ… æ­£ç¡®ï¼šåªè¯»çŠ¶æ€
LogicState state = instance.getLogicState();
if (state.getPhase() == LogicPhaseEnum.IDLE) {
    // åŸºäºçŠ¶æ€åšå†³ç­–
}
```

#### 1.3.2 ä¿¡å·æ¶ˆè´¹è§„èŒƒ

**LATEST_ONLY æ¨¡å¼**ï¼š
- åªè¯»å–æœ€æ–°çš„ ACTIVE ä¿¡å·æ„å›¾
- ä¸æ¶ˆè´¹ä¿¡å·ï¼Œä¸ä¿®æ”¹ signal_intent çŠ¶æ€
- ä¿¡å·æ„å›¾æ˜¯"å½“å‰æ„å›¾"ï¼Œä¸æ˜¯"æ“ä½œæŒ‡ä»¤"

```java
// âœ… æ­£ç¡®ï¼šåªè¯»æœ€æ–°ä¿¡å·æ„å›¾
SignalIntent latestIntent = signalIntentService.getLatestActive(
    strategyId, tradingPairId
);

// âŒ é”™è¯¯ï¼šæ¶ˆè´¹ä¿¡å·
signalIntentService.consume(intentId); // ç¦æ­¢ï¼

// âŒ é”™è¯¯ï¼šä¿®æ”¹ä¿¡å·çŠ¶æ€
signalIntent.setStatus(IntentStatus.CONSUMED); // ç¦æ­¢ï¼
```

---

### 1.4 é˜¶æ®µè¾¹ç•Œè§„èŒƒï¼ˆæ ¸å¿ƒçº¦æŸï¼‰

#### 1.4.1 é˜¶æ®µ2å…è®¸çš„æ“ä½œ

| æ“ä½œç±»å‹ | å…è®¸ | è¯´æ˜ |
|---------|------|------|
| è¯»å– StrategyInstance | âœ… | è·å–ç­–ç•¥å®ä¾‹ |
| è¯»å– logic_state | âœ… | è¯»å–é€»è¾‘çŠ¶æ€ï¼ˆåªè¯»ï¼‰ |
| è¯»å– signal_intent | âœ… | è¯»å–æœ€æ–°ä¿¡å·æ„å›¾ï¼ˆåªè¯»ï¼‰ |
| è¯»å–è¡Œæƒ…æ•°æ® | âœ… | è¯»å–æœ€æ–°è¡Œæƒ…ï¼ˆåªè¯»ï¼‰ |
| è¯»å–æŒ‡æ ‡æ•°æ® | âœ… | è¯»å–æœ€æ–°æŒ‡æ ‡ï¼ˆåªè¯»ï¼‰ |
| å†™å…¥ strategy_intent_record | âœ… | è®°å½•å†³ç­–æ„å›¾ï¼ˆå”¯ä¸€å‰¯ä½œç”¨ï¼‰ |
| è®¡ç®—ä¸‹å•æ•°é‡ | âœ… | åŸºäºç­–ç•¥å‚æ•°è®¡ç®— |
| åˆ¤æ–­äº¤æ˜“æ–¹å‘ | âœ… | åŸºäºä¿¡å·å’Œæ¡ä»¶åˆ¤æ–­ |

#### 1.4.2 é˜¶æ®µ2ç¦æ­¢çš„æ“ä½œ

| æ“ä½œç±»å‹ | ç¦æ­¢ | åŸå›  |
|---------|------|------|
| è¯»å–/å†™å…¥ logic_state | âŒ | çŠ¶æ€ä¿®æ”¹å±äºé˜¶æ®µ3 |
| æ¶ˆè´¹ä¿¡å· | âŒ | ä¿¡å·æ¶ˆè´¹å±äºé˜¶æ®µ3 |
| ä¿®æ”¹ signal_intent çŠ¶æ€ | âŒ | ä¿¡å·çŠ¶æ€ç®¡ç†å±äºé˜¶æ®µ3 |
| å‘é€äº¤æ˜“æŒ‡ä»¤ | âŒ | äº¤æ˜“æ‰§è¡Œå±äºé˜¶æ®µ3 |
| åˆ¤æ–­è´¦æˆ·ä½™é¢ | âŒ | èµ„é‡‘è£å†³å±äºæ›´ä¸‹æ¸¸ |
| å¤„ç†å¤±è´¥é‡è¯• | âŒ | å†³ç­–æ˜¯å£°æ˜ï¼Œä¸æ˜¯å‘½ä»¤ |
| å®šæ—¶æ‰«æ | âŒ | å¿…é¡»äº‹ä»¶é©±åŠ¨ |

#### 1.4.3 ä»£ç æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

- [ ] æ²¡æœ‰ä¿®æ”¹ `logic_state` è¡¨
- [ ] æ²¡æœ‰æ¶ˆè´¹ä¿¡å·æˆ–ä¿®æ”¹ `signal_intent` çŠ¶æ€
- [ ] æ²¡æœ‰å‘é€äº¤æ˜“æŒ‡ä»¤
- [ ] æ²¡æœ‰åˆ¤æ–­è´¦æˆ·ä½™é¢
- [ ] æ²¡æœ‰ä½¿ç”¨å®šæ—¶å™¨è§¦å‘å†³ç­–
- [ ] æ‰€æœ‰å†³ç­–è®°å½•éƒ½åªå†™ä¸€æ¬¡
- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æœ‰å¼‚å¸¸å¤„ç†
- [ ] å†³ç­–å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼ˆæ— å‰¯ä½œç”¨ï¼‰

---

### 1.5 æµ‹è¯•è§„èŒƒ

#### 1.5.1 å•å…ƒæµ‹è¯•è¦æ±‚

**è¦†ç›–ç‡è¦æ±‚**ï¼šæ ¸å¿ƒæ¨¡å—å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

**æµ‹è¯•ç±»å‘½å**ï¼š`{ClassName}Test`

**æµ‹è¯•æ–¹æ³•å‘½å**ï¼š`test{MethodName}_{Scenario}_{ExpectedResult}`

**ç¤ºä¾‹**ï¼š
```java
public class IntentResolverTest {
    
    @Test
    public void testResolve_WithSignalIntent_ReturnOpenIntent() {
        // Given: æœ‰ä¿¡å·æ„å›¾ï¼ŒçŠ¶æ€ä¸ºç©ºä»“
        DecisionContext context = createContext()
            .withSignalIntent(createBuyIntent())
            .withLogicState(createIdleState())
            .build();
        
        // When: æ¨å¯¼æ„å›¾
        DecisionResult result = resolver.resolve(context);
        
        // Then: è¿”å›å¼€ä»“æ„å›¾
        assertThat(result.getAction()).isEqualTo(IntentAction.OPEN);
        assertThat(result.getQty()).isGreaterThan(BigDecimal.ZERO);
    }
    
    @Test
    public void testResolve_WithoutSignal_ReturnHoldIntent() {
        // Given: æ— ä¿¡å·æ„å›¾
        DecisionContext context = createContext()
            .withSignalIntent(null)
            .build();
        
        // When: æ¨å¯¼æ„å›¾
        DecisionResult result = resolver.resolve(context);
        
        // Then: è¿”å›æŒæœ‰æ„å›¾
        assertThat(result.getAction()).isEqualTo(IntentAction.HOLD);
    }
}
```

#### 1.5.2 é›†æˆæµ‹è¯•è¦æ±‚

**æµ‹è¯•åœºæ™¯**ï¼š
1. ä¿¡å·åˆ°è¾¾è§¦å‘å†³ç­–
2. è¡Œæƒ…å˜åŒ–è§¦å‘å†³ç­–
3. é—¨ç¦æ‹’ç»å†³ç­–
4. å†³ç­–è®°å½•è½åº“
5. äº‹ä»¶é©±åŠ¨æœºåˆ¶

**ç¤ºä¾‹**ï¼š
```java
@SpringBootTest
public class DecisionEngineIntegrationTest {
    
    @Test
    public void testExecute_OnSignalArrival_GenerateIntentRecord() {
        // Given: ç­–ç•¥å®ä¾‹å·²å¯åŠ¨ï¼Œä¿¡å·åˆ°è¾¾
        StrategyInstance instance = createInstance();
        SignalIntent signal = createSignal();
        
        // When: è§¦å‘å†³ç­–
        DecisionResult result = engine.execute(instance, 
            DecisionTrigger.signal(signal));
        
        // Then: ç”Ÿæˆå†³ç­–è®°å½•
        assertThat(result).isNotNull();
        assertThat(result.getAction()).isNotEqualTo(IntentAction.HOLD);
        
        // Then: è®°å½•å·²è½åº“
        List<StrategyIntentRecord> records = intentRecordMapper
            .selectByStrategyAndPair(strategyId, tradingPairId);
        assertThat(records).hasSize(1);
    }
}
```

#### 1.5.3 é˜¶æ®µè¾¹ç•Œæµ‹è¯•

**å¿…é¡»æµ‹è¯•**ï¼šé˜¶æ®µ2ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨

```java
@Test
public void testExecute_Phase2Boundary_NoLogicStateModified() {
    // Given: ç­–ç•¥å®ä¾‹
    StrategyInstance instance = createInstance();
    LogicState originalState = instance.getLogicState();
    
    // When: æ‰§è¡Œå†³ç­–ï¼ˆé˜¶æ®µ2ï¼‰
    engine.execute(instance, DecisionTrigger.signal(createSignal()));
    
    // Then: logic_state æœªè¢«ä¿®æ”¹
    LogicState currentState = logicStateMapper.selectByStrategyAndPair(
        strategyId, tradingPairId
    );
    assertThat(currentState.getPhase())
        .isEqualTo(originalState.getPhase());
    assertThat(currentState.getLogicPositionQty())
        .isEqualTo(originalState.getLogicPositionQty());
}
```

---

## äºŒã€å¼€å‘ä»»åŠ¡æ¸…å•

### 2.1 ä»»åŠ¡åˆ†ç»„

#### ç»„1ï¼šæ•°æ®å±‚ä¸å®ä½“ç±»ï¼ˆP0 - åŸºç¡€ï¼‰

#### ç»„2ï¼šæ ¸å¿ƒæ¨¡å—å®ç°ï¼ˆP0 - æ ¸å¿ƒï¼‰

#### ç»„3ï¼šäº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼ˆP0 - é›†æˆï¼‰

#### ç»„4ï¼šæµ‹è¯•ä¸æ–‡æ¡£ï¼ˆP1 - è´¨é‡ï¼‰

---

### 2.2 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### ğŸ“¦ ç»„1ï¼šæ•°æ®å±‚ä¸å®ä½“ç±»

##### ä»»åŠ¡1.1ï¼šåˆ›å»º StrategyIntentRecord å®ä½“ç±»

**ä»»åŠ¡æè¿°**ï¼š
åˆ›å»º `StrategyIntentRecord` å®ä½“ç±»ï¼Œæ˜ å°„ `strategy_intent_record` è¡¨ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- ä½¿ç”¨ MyBatis-Plus æ³¨è§£
- å­—æ®µæ˜ å°„å®Œæ•´
- æšä¸¾ç±»å‹å®šä¹‰ï¼ˆIntentActionEnumï¼‰
- è‡ªåŠ¨å¡«å……å­—æ®µï¼ˆcreated_atï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] å®ä½“ç±»å­—æ®µä¸è¡¨ç»“æ„ä¸€è‡´
- [ ] æšä¸¾ç±»å‹æ­£ç¡®å®šä¹‰
- [ ] è‡ªåŠ¨å¡«å……é…ç½®æ­£ç¡®
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š0.5å¤©

**ä¾èµ–**ï¼šæ— 

---

##### ä»»åŠ¡1.2ï¼šåˆ›å»º StrategyIntentRecordMapper

**ä»»åŠ¡æè¿°**ï¼š
åˆ›å»º `StrategyIntentRecordMapper`ï¼Œæä¾›å†³ç­–è®°å½•æŸ¥è¯¢å’Œæ’å…¥æ–¹æ³•ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- ç»§æ‰¿ `BaseMapper<StrategyIntentRecord>`
- å®ç°æŒ‰ç­–ç•¥ID+äº¤æ˜“å¯¹IDæŸ¥è¯¢
- å®ç°æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
- å®ç°åˆ†é¡µæŸ¥è¯¢

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] Mapperæ¥å£å®šä¹‰å®Œæ•´
- [ ] æ ¸å¿ƒæŸ¥è¯¢æ–¹æ³•æ­£ç¡®
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š0.5å¤©

**ä¾èµ–**ï¼šä»»åŠ¡1.1

---

##### ä»»åŠ¡1.3ï¼šåˆ›å»ºæšä¸¾ç±»å‹

**ä»»åŠ¡æè¿°**ï¼š
åˆ›å»ºå†³ç­–ç›¸å…³çš„æšä¸¾ç±»å‹ã€‚

**æšä¸¾åˆ—è¡¨**ï¼š
- `IntentActionEnum`ï¼šOPEN, CLOSE, ADD, REDUCE, REVERSE, HOLD
- `IntentDirectionEnum`ï¼šBUY, SELL, FLAT, REVERSEï¼ˆç”¨äºsignal_intentï¼‰
- `IntentStatusEnum`ï¼šACTIVE, CONSUMED, EXPIRED, IGNOREDï¼ˆç”¨äºsignal_intentï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æšä¸¾ç±»å‹å®šä¹‰å®Œæ•´
- [ ] æšä¸¾å€¼ä¸æ•°æ®åº“ä¸€è‡´
- [ ] æœ‰æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜

**å·¥ä½œé‡**ï¼š0.5å¤©

**ä¾èµ–**ï¼šæ— 

---

#### ğŸ“¦ ç»„2ï¼šæ ¸å¿ƒæ¨¡å—å®ç°

##### ä»»åŠ¡2.1ï¼šå®ç° DecisionContext æ¨¡å‹ç±»

**ä»»åŠ¡æè¿°**ï¼š
åˆ›å»ºå†³ç­–ä¸Šä¸‹æ–‡æ¨¡å‹ç±»ï¼ŒåŒ…å«å†³ç­–æ‰€éœ€çš„æ‰€æœ‰åªè¯»æ•°æ®ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ï¼ˆimmutableï¼‰
- åŒ…å«ï¼šstrategyIdã€tradingPairIdã€symbolã€logicStateã€paramã€signalIntentã€marketSnapshotã€indicatorsSnapshot
- æä¾›ä¾¿æ·çš„æŸ¥è¯¢æ–¹æ³•

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ç±»è®¾è®¡ä¸ºä¸å¯å˜
- [ ] å­—æ®µå®Œæ•´
- [ ] æœ‰ä¾¿æ·æŸ¥è¯¢æ–¹æ³•
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š1å¤©

**ä¾èµ–**ï¼šä»»åŠ¡1.3

---

##### ä»»åŠ¡2.2ï¼šå®ç° DecisionContextBuilder

**ä»»åŠ¡æè¿°**ï¼š
å®ç°ä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼Œä»ç­–ç•¥å®ä¾‹æ„å»ºå†³ç­–ä¸Šä¸‹æ–‡ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- å®ç° `buildContext(StrategyInstance, DecisionTrigger)` æ–¹æ³•
- åªè¯»æ“ä½œï¼Œä¸ä¿®æ”¹æ•°æ®
- è·å–æœ€æ–°ä¿¡å·æ„å›¾ï¼ˆLATEST_ONLYï¼‰
- è·å–æœ€æ–°è¡Œæƒ…æ•°æ®
- è·å–æœ€æ–°æŒ‡æ ‡æ•°æ®ï¼ˆå¯é€‰ï¼Œå¯å…ˆMockï¼‰
- å¼‚å¸¸å¤„ç†å®Œå–„

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
public DecisionContext buildContext(StrategyInstance instance, 
                                    DecisionTrigger trigger) {
    // 1. è·å–ç­–ç•¥IDã€äº¤æ˜“å¯¹IDã€symbol
    // 2. è·å–logic_stateå¿«ç…§
    // 3. è·å–paramå¿«ç…§
    // 4. è·å–æœ€æ–°signal_intentï¼ˆLATEST_ONLYï¼Œåªè¯»ï¼‰
    // 5. è·å–æœ€æ–°è¡Œæƒ…æ•°æ®
    // 6. è·å–æœ€æ–°æŒ‡æ ‡æ•°æ®ï¼ˆå¯é€‰ï¼‰
    // 7. ç»„è£…æˆDecisionContext
    // 8. è¿”å›
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡
- [ ] åªè¯»å–æœ€æ–°ä¿¡å·æ„å›¾ï¼ˆä¸æ¶ˆè´¹ï¼‰
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

**å·¥ä½œé‡**ï¼š2å¤©

**ä¾èµ–**ï¼šä»»åŠ¡2.1

---

##### ä»»åŠ¡2.3ï¼šå®ç° DecisionResult æ¨¡å‹ç±»

**ä»»åŠ¡æè¿°**ï¼š
åˆ›å»ºå†³ç­–ç»“æœæ¨¡å‹ç±»ï¼ŒåŒ…å«å†³ç­–æ„å›¾å’Œç›¸å…³ä¿¡æ¯ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- åŒ…å«ï¼šintentActionã€calculatedQtyã€decisionReasonã€signalId
- æä¾›ä¾¿æ·çš„æ„é€ æ–¹æ³•ï¼ˆHOLDã€OPENã€CLOSEç­‰ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ¨¡å‹ç±»è®¾è®¡åˆç†
- [ ] å­—æ®µå®Œæ•´
- [ ] æœ‰ä¾¿æ·æ„é€ æ–¹æ³•
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š0.5å¤©

**ä¾èµ–**ï¼šä»»åŠ¡1.3

---

##### ä»»åŠ¡2.4ï¼šå®ç° GuardChain

**ä»»åŠ¡æè¿°**ï¼š
å®ç°å†³ç­–é—¨ç¦é“¾ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸è¿›å…¥å†³ç­–ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- å®ç° `isAllowed(DecisionContext)` æ–¹æ³•
- ä¸‰é“ç¡¬æ€§é—¨ç¦ï¼š
  1. logic_state.phase æ˜¯å¦å…è®¸å†³ç­–
  2. æ˜¯å¦å­˜åœ¨å¯è§ signal / market trigger
  3. æ˜¯å¦ä¸ä¸Šä¸€æ¬¡ intent å†²çªï¼ˆé˜²æŠ–ï¼‰
- ä»»ä¸€å¤±è´¥è¿”å›falseï¼Œå¹¶è®°å½•åŸå› 

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
public GuardResult isAllowed(DecisionContext context) {
    // 1. æ£€æŸ¥logic_state.phaseæ˜¯å¦å…è®¸å†³ç­–
    if (!isPhaseAllowed(context.getLogicState().getPhase())) {
        return GuardResult.reject("é˜¶æ®µä¸å…è®¸å†³ç­–");
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯è§trigger
    if (!hasVisibleTrigger(context)) {
        return GuardResult.reject("æ— å¯è§è§¦å‘æº");
    }
    
    // 3. æ£€æŸ¥æ˜¯å¦ä¸ä¸Šä¸€æ¬¡intentå†²çªï¼ˆé˜²æŠ–ï¼‰
    if (isConflictWithLastIntent(context)) {
        return GuardResult.reject("ä¸ä¸Šä¸€æ¬¡å†³ç­–å†²çª");
    }
    
    return GuardResult.allow();
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ä¸‰é“é—¨ç¦éƒ½èƒ½æ­£ç¡®æ ¡éªŒ
- [ ] é—¨ç¦å¤±è´¥æ—¶è¿”å›æ˜ç¡®åŸå› 
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

**å·¥ä½œé‡**ï¼š2å¤©

**ä¾èµ–**ï¼šä»»åŠ¡2.1

---

##### ä»»åŠ¡2.5ï¼šå®ç° IntentResolver

**ä»»åŠ¡æè¿°**ï¼š
å®ç°æ„å›¾æ¨å¯¼å™¨ï¼Œçº¯å‡½æ•°æ¨å¯¼å†³ç­–æ„å›¾ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- å®ç° `resolve(DecisionContext)` æ–¹æ³•
- çº¯å‡½æ•°ï¼šæ— å‰¯ä½œç”¨ï¼Œä¸è®¿é—®æ•°æ®åº“
- æ”¯æŒ FOLLOW_SIGNAL æ¨¡å¼ï¼šç›´æ¥è·Ÿéšä¿¡å·
- æ”¯æŒ INTENT_DRIVEN æ¨¡å¼ï¼šåŸºäºä¿¡å·å’Œæ¡ä»¶åˆ¤æ–­
- è®¡ç®—ä¸‹å•æ•°é‡ï¼ˆåŸºäºç­–ç•¥å‚æ•°ï¼‰
- åˆ¤æ–­äº¤æ˜“æ–¹å‘ï¼ˆåŸºäºä¿¡å·å’Œæ¡ä»¶ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
public DecisionResult resolve(DecisionContext context) {
    // 1. åˆ¤æ–­å†³ç­–æ¨¡å¼
    if (context.getDecisionMode() == DecisionMode.FOLLOW_SIGNAL) {
        return resolveFollowSignal(context);
    } else {
        return resolveIntentDriven(context);
    }
}

private DecisionResult resolveFollowSignal(DecisionContext context) {
    // ç›´æ¥è·Ÿéšä¿¡å·æ„å›¾
    SignalIntent signal = context.getSignalIntent();
    if (signal == null) {
        return DecisionResult.hold("æ— ä¿¡å·æ„å›¾");
    }
    
    // æ ¹æ®ä¿¡å·æ–¹å‘æ¨å¯¼æ„å›¾
    IntentAction action = convertSignalToAction(signal);
    BigDecimal qty = calculateQty(context);
    
    return DecisionResult.builder()
        .action(action)
        .qty(qty)
        .reason("è·Ÿéšä¿¡å·: " + signal.getIntentDirection())
        .signalId(signal.getId())
        .build();
}

private DecisionResult resolveIntentDriven(DecisionContext context) {
    // åŸºäºä¿¡å·å’Œæ¡ä»¶åˆ¤æ–­
    // 1. æ£€æŸ¥å…¥åœºæ¡ä»¶
    // 2. æ£€æŸ¥é€€å‡ºæ¡ä»¶
    // 3. æ¨å¯¼æ„å›¾
    // 4. è®¡ç®—æ•°é‡
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®æ¨å¯¼æ„å›¾
- [ ] çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨
- [ ] æ”¯æŒä¸¤ç§å†³ç­–æ¨¡å¼
- [ ] èƒ½æ­£ç¡®è®¡ç®—ä¸‹å•æ•°é‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%

**å·¥ä½œé‡**ï¼š3-4å¤©

**ä¾èµ–**ï¼šä»»åŠ¡2.1, ä»»åŠ¡2.3

---

##### ä»»åŠ¡2.6ï¼šå®ç° IntentRecorder

**ä»»åŠ¡æè¿°**ï¼š
å®ç°æ„å›¾è®°å½•å™¨ï¼Œå°†å†³ç­–ç»“æœè½åº“ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- å®ç° `record(DecisionResult, DecisionContext)` æ–¹æ³•
- åªå†™ä¸€æ¬¡ï¼Œä¸å›æ»šï¼Œä¸è¦†ç›–
- ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
- å¼‚å¸¸å¤„ç†å®Œå–„

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
@Transactional
public void record(DecisionResult result, DecisionContext context) {
    // 1. è½¬æ¢ä¸ºStrategyIntentRecord
    StrategyIntentRecord record = convertToRecord(result, context);
    
    // 2. æ’å…¥æ•°æ®åº“ï¼ˆåªå†™ä¸€æ¬¡ï¼‰
    intentRecordMapper.insert(record);
    
    // 3. è®°å½•æ—¥å¿—
    log.info("å†³ç­–è®°å½•å·²è½åº“: strategyId={}, tradingPairId={}, action={}",
        context.getStrategyId(), context.getTradingPairId(), result.getAction());
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®è®°å½•å†³ç­–
- [ ] åªå†™ä¸€æ¬¡ï¼Œä¸è¦†ç›–
- [ ] äº‹åŠ¡ä¿è¯åŸå­æ€§
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š1å¤©

**ä¾èµ–**ï¼šä»»åŠ¡1.2, ä»»åŠ¡2.3

---

##### ä»»åŠ¡2.7ï¼šå®ç° DecisionEngine

**ä»»åŠ¡æè¿°**ï¼š
å®ç°å†³ç­–å¼•æ“ï¼Œåè°ƒæ•´ä¸ªå†³ç­–æµç¨‹ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- å®ç° `execute(StrategyInstance, DecisionTrigger)` æ–¹æ³•
- åè°ƒæ‰€æœ‰æ¨¡å—ï¼šContextBuilder â†’ GuardChain â†’ IntentResolver â†’ IntentRecorder
- å¼‚å¸¸å¤„ç†ï¼šéƒ¨åˆ†å¤±è´¥ä¸å½±å“å…¶ä»–å®ä¾‹
- æ—¥å¿—è®°å½•å®Œæ•´

**æ ¸å¿ƒæµç¨‹**ï¼š
```java
public DecisionResult execute(StrategyInstance instance, 
                               DecisionTrigger trigger) {
    try {
        // 1. æ„å»ºå†³ç­–ä¸Šä¸‹æ–‡
        DecisionContext context = contextBuilder.buildContext(instance, trigger);
        
        // 2. é—¨ç¦æ ¡éªŒ
        GuardResult guardResult = guardChain.isAllowed(context);
        if (!guardResult.isAllowed()) {
            log.debug("å†³ç­–è¢«é—¨ç¦æ‹’ç»: strategyId={}, reason={}",
                instance.getStrategyId(), guardResult.getReason());
            return DecisionResult.hold(guardResult.getReason());
        }
        
        // 3. æ„å›¾æ¨å¯¼ï¼ˆçº¯å‡½æ•°ï¼‰
        DecisionResult result = intentResolver.resolve(context);
        
        // 4. å†³ç­–è½åº“ï¼ˆå”¯ä¸€å‰¯ä½œç”¨ï¼‰
        if (result.getAction() != IntentAction.HOLD) {
            intentRecorder.record(result, context);
        }
        
        return result;
        
    } catch (Exception e) {
        log.error("å†³ç­–æ‰§è¡Œå¤±è´¥: strategyId={}, tradingPairId={}",
            instance.getStrategyId(), instance.getTradingPairId(), e);
        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å›HOLD
        return DecisionResult.hold("å†³ç­–æ‰§è¡Œå¼‚å¸¸: " + e.getMessage());
    }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®åè°ƒæ•´ä¸ªå†³ç­–æµç¨‹
- [ ] é—¨ç¦æ‹’ç»æ—¶è¿”å›HOLD
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„
- [ ] æ—¥å¿—è®°å½•å®Œæ•´
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š2å¤©

**ä¾èµ–**ï¼šä»»åŠ¡2.2, ä»»åŠ¡2.4, ä»»åŠ¡2.5, ä»»åŠ¡2.6

---

#### ğŸ“¦ ç»„3ï¼šäº‹ä»¶é©±åŠ¨æœºåˆ¶

##### ä»»åŠ¡3.1ï¼šå®ç° DecisionTrigger æ¨¡å‹ç±»

**ä»»åŠ¡æè¿°**ï¼š
åˆ›å»ºå†³ç­–è§¦å‘äº‹ä»¶æ¨¡å‹ç±»ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- æ”¯æŒå¤šç§è§¦å‘ç±»å‹ï¼šSIGNALã€MARKETã€INDICATOR
- åŒ…å«è§¦å‘æºä¿¡æ¯
- æä¾›ä¾¿æ·çš„æ„é€ æ–¹æ³•

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ¨¡å‹ç±»è®¾è®¡åˆç†
- [ ] æ”¯æŒå¤šç§è§¦å‘ç±»å‹
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š0.5å¤©

**ä¾èµ–**ï¼šæ— 

---

##### ä»»åŠ¡3.2ï¼šå®ç°äº‹ä»¶ç›‘å¬å™¨

**ä»»åŠ¡æè¿°**ï¼š
å®ç°äº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬ä¿¡å·åˆ°è¾¾ã€è¡Œæƒ…å˜åŒ–ç­‰äº‹ä»¶ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- ç›‘å¬ signal_intent æ–°è®°å½•äº‹ä»¶
- ç›‘å¬è¡Œæƒ…ä»·æ ¼å˜åŒ–äº‹ä»¶
- ç›‘å¬æŒ‡æ ‡è®¡ç®—å®Œæˆäº‹ä»¶ï¼ˆå¯é€‰ï¼‰
- äº‹ä»¶åˆ°è¾¾æ—¶è§¦å‘å†³ç­–

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®ç›‘å¬äº‹ä»¶
- [ ] äº‹ä»¶åˆ°è¾¾æ—¶è§¦å‘å†³ç­–
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š2å¤©

**ä¾èµ–**ï¼šä»»åŠ¡2.7, ä»»åŠ¡3.1

---

##### ä»»åŠ¡3.3ï¼šå®ç°å†³ç­–è°ƒåº¦å™¨ï¼ˆå¯é€‰ï¼‰

**ä»»åŠ¡æè¿°**ï¼š
å®ç°å†³ç­–è°ƒåº¦å™¨ï¼Œæä¾›æ‰‹åŠ¨è§¦å‘å†³ç­–çš„æ¥å£ã€‚

**æŠ€æœ¯è¦æ±‚**ï¼š
- æä¾›æ‰‹åŠ¨è§¦å‘å†³ç­–çš„æ¥å£
- æ”¯æŒæŒ‰ç­–ç•¥IDè§¦å‘
- æ”¯æŒæŒ‰äº¤æ˜“å¯¹IDè§¦å‘
- æ”¯æŒè§¦å‘æ‰€æœ‰ç­–ç•¥å®ä¾‹
- å¼‚å¸¸å¤„ç†å®Œå–„

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®æ‰‹åŠ¨è§¦å‘å†³ç­–
- [ ] æ”¯æŒå¤šç§è§¦å‘æ–¹å¼
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š1å¤©

**ä¾èµ–**ï¼šä»»åŠ¡2.7

---

#### ğŸ“¦ ç»„4ï¼šæµ‹è¯•ä¸æ–‡æ¡£

##### ä»»åŠ¡4.1ï¼šç¼–å†™å•å…ƒæµ‹è¯•

**ä»»åŠ¡æè¿°**ï¼š
ä¸ºæ ¸å¿ƒæ¨¡å—ç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•ã€‚

**æµ‹è¯•è¦†ç›–**ï¼š
- DecisionContextBuilderï¼šâ‰¥ 80%
- GuardChainï¼šâ‰¥ 80%
- IntentResolverï¼šâ‰¥ 80%
- IntentRecorderï¼šâ‰¥ 80%
- DecisionEngineï¼šâ‰¥ 70%

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æ ¸å¿ƒæ¨¡å—éƒ½æœ‰å•å…ƒæµ‹è¯•
- [ ] è¦†ç›–ç‡è¾¾æ ‡
- [ ] æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ­£å¸¸æµç¨‹å’Œå¼‚å¸¸æµç¨‹
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š4å¤©

**ä¾èµ–**ï¼šç»„2, ç»„3

---

##### ä»»åŠ¡4.2ï¼šç¼–å†™é›†æˆæµ‹è¯•

**ä»»åŠ¡æè¿°**ï¼š
ç¼–å†™é›†æˆæµ‹è¯•ï¼ŒéªŒè¯å®Œæ•´çš„å†³ç­–æµç¨‹ã€‚

**æµ‹è¯•åœºæ™¯**ï¼š
1. ä¿¡å·åˆ°è¾¾è§¦å‘å†³ç­–
2. è¡Œæƒ…å˜åŒ–è§¦å‘å†³ç­–
3. é—¨ç¦æ‹’ç»å†³ç­–
4. å†³ç­–è®°å½•è½åº“
5. äº‹ä»¶é©±åŠ¨æœºåˆ¶
6. é˜¶æ®µè¾¹ç•Œæµ‹è¯•ï¼ˆä¸äº§ç”Ÿå‰¯ä½œç”¨ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•åœºæ™¯éƒ½æœ‰æµ‹è¯•ç”¨ä¾‹
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] é˜¶æ®µè¾¹ç•Œæµ‹è¯•é€šè¿‡

**å·¥ä½œé‡**ï¼š3å¤©

**ä¾èµ–**ï¼šç»„3

---

##### ä»»åŠ¡4.3ï¼šç¼–å†™APIæ–‡æ¡£

**ä»»åŠ¡æè¿°**ï¼š
ä¸ºæ ¸å¿ƒç±»å’Œæ–¹æ³•ç¼–å†™JavaDocæ–‡æ¡£ã€‚

**æ–‡æ¡£è¦æ±‚**ï¼š
- æ‰€æœ‰publicç±»å’Œæ–¹æ³•éƒ½æœ‰æ³¨é‡Š
- æ³¨é‡ŠåŒ…å«èŒè´£è¯´æ˜ã€å‚æ•°è¯´æ˜ã€è¿”å›å€¼è¯´æ˜ã€å¼‚å¸¸è¯´æ˜
- å…³é”®é€»è¾‘æœ‰æ³¨é‡Šè¯´æ˜

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰public APIéƒ½æœ‰æ–‡æ¡£
- [ ] æ–‡æ¡£æ¸…æ™°å®Œæ•´
- [ ] å¯ä»¥é€šè¿‡IDEç”ŸæˆAPIæ–‡æ¡£

**å·¥ä½œé‡**ï¼š1å¤©

**ä¾èµ–**ï¼šç»„2, ç»„3

---

## ä¸‰ã€éªŒæ”¶æ ‡å‡†

### 3.1 åŠŸèƒ½éªŒæ”¶

#### âœ… å†³ç­–æµç¨‹éªŒæ”¶

- [ ] ä¿¡å·åˆ°è¾¾æ—¶èƒ½æ­£ç¡®è§¦å‘å†³ç­–
- [ ] è¡Œæƒ…å˜åŒ–æ—¶èƒ½æ­£ç¡®è§¦å‘å†³ç­–
- [ ] é—¨ç¦æ ¡éªŒèƒ½æ­£ç¡®æ‹’ç»ä¸å…è®¸çš„å†³ç­–
- [ ] æ„å›¾æ¨å¯¼èƒ½æ­£ç¡®ç”Ÿæˆå†³ç­–ç»“æœ
- [ ] å†³ç­–è®°å½•èƒ½æ­£ç¡®è½åº“

#### âœ… å†³ç­–æ¨¡å¼éªŒæ”¶

- [ ] FOLLOW_SIGNAL æ¨¡å¼èƒ½æ­£ç¡®è·Ÿéšä¿¡å·
- [ ] INTENT_DRIVEN æ¨¡å¼èƒ½æ­£ç¡®åŸºäºæ¡ä»¶åˆ¤æ–­
- [ ] ä¸¤ç§æ¨¡å¼éƒ½èƒ½æ­£ç¡®è®¡ç®—ä¸‹å•æ•°é‡

#### âœ… äº‹ä»¶é©±åŠ¨éªŒæ”¶

- [ ] ä¿¡å·åˆ°è¾¾äº‹ä»¶èƒ½æ­£ç¡®è§¦å‘å†³ç­–
- [ ] è¡Œæƒ…å˜åŒ–äº‹ä»¶èƒ½æ­£ç¡®è§¦å‘å†³ç­–
- [ ] æ‰‹åŠ¨è§¦å‘æ¥å£èƒ½æ­£å¸¸å·¥ä½œ
- [ ] ä¸ä¾èµ–å®šæ—¶å™¨æ‰«æ

### 3.2 é˜¶æ®µè¾¹ç•ŒéªŒæ”¶

#### âœ… å‰¯ä½œç”¨éªŒæ”¶

- [ ] `logic_state` è¡¨æ— ä¿®æ”¹
- [ ] `signal_intent` çŠ¶æ€æ— å˜åŒ–
- [ ] æ²¡æœ‰å‘é€äº¤æ˜“æŒ‡ä»¤
- [ ] æ²¡æœ‰åˆ¤æ–­è´¦æˆ·ä½™é¢
- [ ] åªå†™ `strategy_intent_record` è¡¨

#### âœ… æ•°æ®å®Œæ•´æ€§éªŒæ”¶

- [ ] æ¯ä¸ªå†³ç­–éƒ½æœ‰å®Œæ•´çš„è®°å½•
- [ ] å†³ç­–è®°å½•åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
- [ ] å†³ç­–è®°å½•åªå†™ä¸€æ¬¡ï¼Œä¸è¦†ç›–
- [ ] å†³ç­–è®°å½•å¯å›æ”¾ã€å¯è¿½æº¯

### 3.3 æ€§èƒ½éªŒæ”¶

- [ ] å•ä¸ªå†³ç­–æ‰§è¡Œè€—æ—¶ < 100ms
- [ ] å¹¶å‘å†³ç­–ä¸äº’ç›¸å½±å“
- [ ] äº‹ä»¶å¤„ç†ä¸é˜»å¡ä¸»æµç¨‹

### 3.4 ä»£ç è´¨é‡éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ— ä¸¥é‡ä»£ç å¼‚å‘³
- [ ] ç¬¦åˆç¼–ç è§„èŒƒ

---

## å››ã€é£é™©ä¸æ³¨æ„äº‹é¡¹

### 4.1 æŠ€æœ¯é£é™©

#### é£é™©1ï¼šé‡å¤å†³ç­–

**é£é™©æè¿°**ï¼šåŒä¸€äº‹ä»¶è§¦å‘å¤šæ¬¡å†³ç­–ï¼Œå¯¼è‡´é‡å¤è®°å½•ã€‚

**åº”å¯¹æªæ–½**ï¼š
- ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼ˆGuardChainä¸­çš„å†²çªæ£€æµ‹ï¼‰
- äº‹ä»¶å»é‡ï¼ˆäº‹ä»¶ç›‘å¬å™¨ä¸­å®ç°ï¼‰
- å¹‚ç­‰æ€§ä¿è¯ï¼ˆå†³ç­–è®°å½•å”¯ä¸€æ€§æ ¡éªŒï¼‰

#### é£é™©2ï¼šå†³ç­–ä¸ä¸€è‡´

**é£é™©æè¿°**ï¼šç³»ç»Ÿé‡å¯åå†³ç­–ç»“æœä¸ä¸€è‡´ã€‚

**åº”å¯¹æªæ–½**ï¼š
- æ‰€æœ‰å†³ç­–ä¾æ®éƒ½æ¥è‡ªåªè¯»å¿«ç…§
- å†³ç­–è®°å½•åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
- å†³ç­–å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼ˆæ— å‰¯ä½œç”¨ï¼‰

#### é£é™©3ï¼šäº‹ä»¶ä¸¢å¤±

**é£é™©æè¿°**ï¼šäº‹ä»¶åˆ°è¾¾æ—¶ç³»ç»Ÿå¼‚å¸¸ï¼Œå¯¼è‡´å†³ç­–æœªæ‰§è¡Œã€‚

**åº”å¯¹æªæ–½**ï¼š
- äº‹ä»¶æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼‰
- å¼‚å¸¸å¤„ç†å®Œå–„ï¼Œè®°å½•æ—¥å¿—
- æä¾›æ‰‹åŠ¨è§¦å‘æ¥å£ä½œä¸ºè¡¥å¿

### 4.2 ä¸šåŠ¡é£é™©

#### é£é™©1ï¼šå†³ç­–å»¶è¿Ÿ

**é£é™©æè¿°**ï¼šäº‹ä»¶åˆ°è¾¾åå†³ç­–æ‰§è¡Œå»¶è¿Ÿï¼Œå½±å“ç­–ç•¥æ•ˆæœã€‚

**åº”å¯¹æªæ–½**ï¼š
- äº‹ä»¶å¤„ç†å¼‚æ­¥åŒ–ï¼ˆå¯é€‰ï¼‰
- ä¼˜åŒ–å†³ç­–æµç¨‹ï¼Œå‡å°‘IOæ“ä½œ
- ç›‘æ§å†³ç­–æ‰§è¡Œæ—¶é—´

#### é£é™©2ï¼šå†³ç­–é”™è¯¯

**é£é™©æè¿°**ï¼šå†³ç­–é€»è¾‘é”™è¯¯å¯¼è‡´é”™è¯¯æ„å›¾ã€‚

**åº”å¯¹æªæ–½**ï¼š
- å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- å†³ç­–è®°å½•åŒ…å«å†³ç­–åŸå› ï¼Œä¾¿äºå¤ç›˜
- æä¾›å†³ç­–å›æ”¾åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### 4.3 å¼€å‘æ³¨æ„äº‹é¡¹

1. **ä¸¥æ ¼éµå®ˆé˜¶æ®µè¾¹ç•Œ**ï¼šé˜¶æ®µ2ä¸åšé˜¶æ®µ3çš„äº‹æƒ…
2. **å†³ç­–æ˜¯å£°æ˜**ï¼šå†³ç­–æ˜¯"æˆ‘æƒ³åšä»€ä¹ˆ"ï¼Œä¸æ˜¯"æˆ‘è¦åšä»€ä¹ˆ"
3. **çº¯å‡½æ•°è®¾è®¡**ï¼šæ„å›¾æ¨å¯¼å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨
4. **äº‹ä»¶é©±åŠ¨**ï¼šå¿…é¡»äº‹ä»¶é©±åŠ¨ï¼Œç¦æ­¢å®šæ—¶æ‰«æ
5. **åªå†™ä¸€æ¬¡**ï¼šå†³ç­–è®°å½•åªå†™ä¸€æ¬¡ï¼Œä¸å›æ»šï¼Œä¸è¦†ç›–

---

## äº”ã€å¼€å‘é¡ºåºå»ºè®®

### æ¨èå¼€å‘é¡ºåº

```
ç¬¬1å‘¨ï¼š
1. ä»»åŠ¡1.1-1.3ï¼ˆæ•°æ®å±‚ä¸æšä¸¾ï¼‰ â†’ 1.5å¤©
2. ä»»åŠ¡2.1ï¼ˆDecisionContextï¼‰ â†’ 1å¤©
3. ä»»åŠ¡2.2ï¼ˆDecisionContextBuilderï¼‰ â†’ 2å¤©
4. ä»»åŠ¡2.3ï¼ˆDecisionResultï¼‰ â†’ 0.5å¤©
5. ä»»åŠ¡2.4ï¼ˆGuardChainï¼‰ â†’ 2å¤©

ç¬¬2å‘¨ï¼š
6. ä»»åŠ¡2.5ï¼ˆIntentResolverï¼‰ â†’ 3-4å¤©
7. ä»»åŠ¡2.6ï¼ˆIntentRecorderï¼‰ â†’ 1å¤©
8. ä»»åŠ¡2.7ï¼ˆDecisionEngineï¼‰ â†’ 2å¤©

ç¬¬3å‘¨ï¼š
9. ä»»åŠ¡3.1ï¼ˆDecisionTriggerï¼‰ â†’ 0.5å¤©
10. ä»»åŠ¡3.2ï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰ â†’ 2å¤©
11. ä»»åŠ¡3.3ï¼ˆå†³ç­–è°ƒåº¦å™¨ï¼Œå¯é€‰ï¼‰ â†’ 1å¤©
12. ä»»åŠ¡4.1ï¼ˆå•å…ƒæµ‹è¯•ï¼‰ â†’ 4å¤©

ç¬¬4å‘¨ï¼š
13. ä»»åŠ¡4.2ï¼ˆé›†æˆæµ‹è¯•ï¼‰ â†’ 3å¤©
14. ä»»åŠ¡4.3ï¼ˆæ–‡æ¡£ï¼‰ â†’ 1å¤©
15. ä»£ç å®¡æŸ¥ä¸ä¼˜åŒ– â†’ 2å¤©
```

**æ€»å·¥ä½œé‡**ï¼šçº¦18-22å¤©ï¼ˆ4å‘¨ï¼‰

---

## å…­ã€å®Œæˆæ ‡å¿—

é˜¶æ®µ2å®Œæˆçš„æ ‡å¿—ï¼š

1. âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ
2. âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
3. âœ… ä»£ç å®¡æŸ¥é€šè¿‡
4. âœ… æ–‡æ¡£å®Œæ•´
5. âœ… ä¿¡å·åˆ°è¾¾æ—¶èƒ½è‡ªåŠ¨è§¦å‘å†³ç­–
6. âœ… å†³ç­–è®°å½•èƒ½æ­£ç¡®è½åº“
7. âœ… é˜¶æ®µè¾¹ç•Œæµ‹è¯•é€šè¿‡ï¼ˆæ— å‰¯ä½œç”¨ï¼‰

**é˜¶æ®µ2ç»“æŸçš„å”¯ä¸€æ ‡å¿—**ï¼š

> **ç­–ç•¥å·²"è®¤çŸ¥"ï¼Œä½†è¿˜æ²¡"è¡ŒåŠ¨"**

---

## ä¸ƒã€ä¸é˜¶æ®µ1çš„è¡”æ¥

### 7.1 æ•°æ®æµè¡”æ¥

```
é˜¶æ®µ1è¾“å‡ºï¼ˆStrategyInstanceï¼‰
    â†“
é˜¶æ®µ2è¾“å…¥ï¼ˆDecisionContextï¼‰
    â†“
é˜¶æ®µ2è¾“å‡ºï¼ˆStrategyIntentRecordï¼‰
    â†“
é˜¶æ®µ3è¾“å…¥ï¼ˆå¾…å®ç°ï¼‰
```

### 7.2 æ¨¡å—è¡”æ¥

- **DecisionEngine** ä» **StrategyRuntimeRegistry** è·å–ç­–ç•¥å®ä¾‹
- **DecisionContextBuilder** ä½¿ç”¨é˜¶æ®µ1åˆ›å»ºçš„ **StrategyInstance**
- **IntentRecorder** å†™å…¥ **strategy_intent_record** è¡¨ï¼ˆé˜¶æ®µ3ä¼šè¯»å–ï¼‰

### 7.3 çŠ¶æ€ç®¡ç†è¡”æ¥

- é˜¶æ®µ2åªè¯» **logic_state**ï¼ˆæ¥è‡ªé˜¶æ®µ1ï¼‰
- é˜¶æ®µ2ä¸ä¿®æ”¹ **logic_state**ï¼ˆç”±é˜¶æ®µ3è´Ÿè´£ï¼‰
- é˜¶æ®µ2å†™å…¥ **strategy_intent_record**ï¼ˆé˜¶æ®µ3ä¼šè¯»å–å¹¶æ›´æ–°çŠ¶æ€ï¼‰

---

## å…«ã€æ‰©å±•æ€§è®¾è®¡

### 8.1 æ”¯æŒæ›´å¤šè§¦å‘æº

å½“å‰è®¾è®¡æ”¯æŒï¼š
- ä¿¡å·è§¦å‘ï¼ˆsignal_intentï¼‰
- è¡Œæƒ…è§¦å‘ï¼ˆmarket price changeï¼‰
- æŒ‡æ ‡è§¦å‘ï¼ˆindicator calculationï¼‰

æœªæ¥å¯æ‰©å±•ï¼š
- æ—¶é—´è§¦å‘ï¼ˆç‰¹å®šæ—¶é—´ç‚¹ï¼‰
- ç»„åˆè§¦å‘ï¼ˆå¤šä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³ï¼‰

### 8.2 æ”¯æŒæ›´å¤šå†³ç­–æ¨¡å¼

å½“å‰è®¾è®¡æ”¯æŒï¼š
- FOLLOW_SIGNALï¼ˆå®Œå…¨è·Ÿéšä¿¡å·ï¼‰
- INTENT_DRIVENï¼ˆä¿¡å·ä½œä¸ºæ„å›¾ï¼‰

æœªæ¥å¯æ‰©å±•ï¼š
- è‡ªå®šä¹‰å†³ç­–æ¨¡å¼
- å¤šç­–ç•¥ç»„åˆå†³ç­–

### 8.3 æ”¯æŒæ›´å¤šæ¡ä»¶ç±»å‹

å½“å‰è®¾è®¡æ”¯æŒï¼š
- ä»·æ ¼æ¡ä»¶
- ä¿¡å·æ–¹å‘æ¡ä»¶

æœªæ¥å¯æ‰©å±•ï¼š
- æŠ€æœ¯æŒ‡æ ‡æ¡ä»¶ï¼ˆRSIã€MACDç­‰ï¼‰
- è‡ªå®šä¹‰æ¡ä»¶è¡¨è¾¾å¼

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ