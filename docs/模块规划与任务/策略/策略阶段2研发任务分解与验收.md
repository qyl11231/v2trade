# ç­–ç•¥é˜¶æ®µ2ï¼ˆDecision Engineï¼‰ç ”å‘ä»»åŠ¡åˆ†è§£ä¸éªŒæ”¶

> **åŸºäºæ–‡æ¡£**ï¼š`ç­–ç•¥é˜¶æ®µ2ï¼ˆDecision Engineï¼‰è§„åˆ’ v3.1.md`  
> **ç‰ˆæœ¬**ï¼šv1.0  
> **åˆ›å»ºæ—¶é—´**ï¼š2024  
> **è´Ÿè´£äºº**ï¼šV2-Trade æ¶æ„å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [P0ä»»åŠ¡åˆ†è§£ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰](#p0ä»»åŠ¡åˆ†è§£æ ¸å¿ƒåŠŸèƒ½)
2. [ä»£ç ç»“æ„å»ºè®®](#ä»£ç ç»“æ„å»ºè®®)
3. [äº‹ä»¶å¥‘çº¦è®¾è®¡](#äº‹ä»¶å¥‘çº¦è®¾è®¡)
4. [å¹‚ç­‰é”®è§„åˆ™](#å¹‚ç­‰é”®è§„åˆ™)
5. [å­—æ®µè§„èŒƒ](#å­—æ®µè§„èŒƒ)
6. [éªŒæ”¶ç”¨ä¾‹](#éªŒæ”¶ç”¨ä¾‹)
7. [P1/P2æ¼”è¿›å»ºè®®](#p1p2æ¼”è¿›å»ºè®®)

---

## ä¸€ã€P0ä»»åŠ¡åˆ†è§£ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

### ğŸ¯ ä»»åŠ¡ç»„1ï¼šåŸºç¡€è®¾æ–½å±‚ï¼ˆFoundationï¼‰

#### ä»»åŠ¡1.1ï¼šåˆ›å»ºå†³ç­–ç›¸å…³å®ä½“ç±»å’Œæšä¸¾

**ç›®æ ‡**ï¼šåˆ›å»ºé˜¶æ®µ2æ‰€éœ€çš„æ•°æ®æ¨¡å‹å’Œæšä¸¾ç±»å‹

**èŒƒå›´**ï¼š
- `StrategyIntentRecord` å®ä½“ç±»
- `IntentActionEnum` æšä¸¾ï¼ˆOPEN/CLOSE/ADD/REDUCE/REVERSE/HOLDï¼‰
- `DecisionTriggerTypeEnum` æšä¸¾ï¼ˆSIGNAL/INDICATOR/BAR/PRICEï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸æ–°å¢æ•°æ®åº“è¡¨
- ä¸ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/model/entity/StrategyIntentRecord.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/common/constants/IntentActionEnum.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/common/constants/DecisionTriggerTypeEnum.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- æ— å¤–éƒ¨ä¾èµ–

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæšä¸¾å€¼ä¸æ•°æ®åº“å­—æ®µä¸åŒ¹é…
- è§„é¿ï¼šæšä¸¾å€¼å¿…é¡»ä¸SQLæ³¨é‡Šä¸­çš„å€¼å®Œå…¨ä¸€è‡´

**å·¥ä½œé‡**ï¼š0.5å¤©

---

#### ä»»åŠ¡1.2ï¼šåˆ›å»º StrategyIntentRecordMapper

**ç›®æ ‡**ï¼šæä¾›å†³ç­–è®°å½•çš„æ•°æ®åº“è®¿é—®æ¥å£

**èŒƒå›´**ï¼š
- åŸºç¡€CRUDï¼ˆç»§æ‰¿BaseMapperï¼‰
- æŒ‰ç­–ç•¥ID+äº¤æ˜“å¯¹IDæŸ¥è¯¢
- æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼ˆç”¨äºå›æ”¾ï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸æä¾›UPDATE/DELETEæ–¹æ³•ï¼ˆé˜¶æ®µ2åªINSERTï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/mapper/StrategyIntentRecordMapper.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- MyBatis-Plus

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæŸ¥è¯¢æ€§èƒ½é—®é¢˜
- è§„é¿ï¼šä½¿ç”¨åˆé€‚çš„ç´¢å¼•ï¼ˆstrategy_id + trading_pair_id + created_atï¼‰

**å·¥ä½œé‡**ï¼š0.5å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„2ï¼šäº‹ä»¶ä¸è·¯ç”±å±‚ï¼ˆEvent & Routingï¼‰

#### ä»»åŠ¡2.1ï¼šå®šä¹‰å››ç±»å†³ç­–äº‹ä»¶

**ç›®æ ‡**ï¼šå®šä¹‰é˜¶æ®µ2éœ€è¦è®¢é˜…çš„å››ç±»äº‹ä»¶

**èŒƒå›´**ï¼š
- `SignalIntentActivatedEvent`ï¼ˆä¿¡å·æ„å›¾æ¿€æ´»äº‹ä»¶ï¼‰
- `IndicatorComputedEvent`ï¼ˆæŒ‡æ ‡è®¡ç®—å®Œæˆäº‹ä»¶ï¼‰
- `BarClosedEvent`ï¼ˆKçº¿é—­åˆäº‹ä»¶ï¼‰
- `PriceTriggeredDecisionEvent`ï¼ˆä»·æ ¼é˜ˆå€¼ç©¿è¶Šäº‹ä»¶ï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°äº‹ä»¶å‘å¸ƒé€»è¾‘ï¼ˆç”±ä¸Šæ¸¸æ¨¡å—å‘å¸ƒï¼‰
- ä¸å®ç°äº‹ä»¶å­˜å‚¨ï¼ˆäº‹ä»¶æ˜¯å†…å­˜ä¸­çš„ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/event/SignalIntentActivatedEvent.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/event/IndicatorComputedEvent.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/event/BarClosedEvent.java`ï¼ˆæ–°å»ºï¼Œå¯èƒ½å·²å­˜åœ¨ï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/event/PriceTriggeredDecisionEvent.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- Spring Eventsï¼ˆApplicationEventï¼‰
- æŒ‡æ ‡æ¨¡å—ï¼ˆIndicatorComputedEventå¯èƒ½å·²å­˜åœ¨ï¼‰
- èšåˆæ¨¡å—ï¼ˆBarClosedEventå¯èƒ½å·²å­˜åœ¨ï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šäº‹ä»¶å­—æ®µä¸å®Œæ•´ï¼Œæ— æ³•å®šä½ç­–ç•¥å®ä¾‹
- è§„é¿ï¼šäº‹ä»¶å¿…é¡»åŒ…å« `tradingPairId` å’Œ `userId`ï¼ˆç”¨äºè·¯ç”±ï¼‰

**å·¥ä½œé‡**ï¼š1å¤©

---

#### ä»»åŠ¡2.2ï¼šå®ç° StripedExecutorï¼ˆä¸²è¡Œæ‰§è¡Œå™¨ï¼‰

**ç›®æ ‡**ï¼šä¿è¯åŒä¸€StrategyInstanceçš„å†³ç­–ä¸²è¡Œæ‰§è¡Œ

**èŒƒå›´**ï¼š
- åŸºäº `strategyId + tradingPairId` åšhashåˆ†ç‰‡
- æ¯ä¸ªåˆ†ç‰‡ä½¿ç”¨å•çº¿ç¨‹é˜Ÿåˆ—
- æ”¯æŒåŠ¨æ€çº¿ç¨‹æ± å¤§å°é…ç½®

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°å…¨å±€é”ï¼ˆä½¿ç”¨åˆ†ç‰‡é”å³å¯ï¼‰
- ä¸å®ç°ä»»åŠ¡ä¼˜å…ˆçº§ï¼ˆFIFOå³å¯ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/executor/StripedExecutor.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/executor/InstanceKey.java`ï¼ˆæ–°å»ºï¼Œç”¨äºhashï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- Javaå¹¶å‘åŒ…ï¼ˆExecutorServiceï¼‰
- Springé…ç½®

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šçº¿ç¨‹æ± å¤§å°é…ç½®ä¸å½“å¯¼è‡´é˜»å¡
- è§„é¿ï¼šé»˜è®¤çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°ï¼Œæ”¯æŒé…ç½®è°ƒæ•´

**å·¥ä½œé‡**ï¼š1.5å¤©

---

#### ä»»åŠ¡2.3ï¼šå®ç° DecisionEventRouterï¼ˆäº‹ä»¶è·¯ç”±å™¨ï¼‰

**ç›®æ ‡**ï¼šè®¢é˜…å››ç±»äº‹ä»¶ï¼Œè·¯ç”±åˆ°å¯¹åº”çš„StrategyInstance

**èŒƒå›´**ï¼š
- è®¢é˜…å››ç±»å†³ç­–äº‹ä»¶
- æ ¹æ®äº‹ä»¶ä¸­çš„ `tradingPairId` æŸ¥æ‰¾å—å½±å“çš„ç­–ç•¥å®ä¾‹
- æŠ•é€’åˆ° StripedExecutor æ‰§è¡Œ

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°äº‹ä»¶è¿‡æ»¤ï¼ˆæ‰€æœ‰äº‹ä»¶éƒ½è·¯ç”±ï¼‰
- ä¸å®ç°äº‹ä»¶æŒä¹…åŒ–ï¼ˆäº‹ä»¶æ˜¯å†…å­˜ä¸­çš„ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/router/DecisionEventRouter.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/router/StrategyInstanceLocator.java`ï¼ˆæ–°å»ºï¼Œç”¨äºæŸ¥æ‰¾å®ä¾‹ï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- Spring Eventsï¼ˆ@EventListenerï¼‰
- StrategyRuntimeRegistryï¼ˆé˜¶æ®µ1å·²å®ç°ï¼‰
- StripedExecutorï¼ˆä»»åŠ¡2.2ï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæ‰¾ä¸åˆ°ç­–ç•¥å®ä¾‹å¯¼è‡´äº‹ä»¶ä¸¢å¤±
- è§„é¿ï¼šè®°å½•WARNæ—¥å¿—ï¼Œä½†ä¸æŠ›å¼‚å¸¸ï¼ˆå…è®¸ç­–ç•¥æœªå¯åŠ¨çš„æƒ…å†µï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„3ï¼šå†³ç­–ä¸Šä¸‹æ–‡å±‚ï¼ˆContextï¼‰

#### ä»»åŠ¡3.1ï¼šå®ç° DecisionContextï¼ˆä¸å¯å˜ä¸Šä¸‹æ–‡ï¼‰

**ç›®æ ‡**ï¼šåˆ›å»ºå†³ç­–æ—¶çš„ä¸å¯å˜å¿«ç…§å¯¹è±¡

**èŒƒå›´**ï¼š
- åŒ…å«æ‰€æœ‰å†³ç­–æ‰€éœ€çš„æ•°æ®å¿«ç…§
- ä½¿ç”¨ä¸å¯å˜å¯¹è±¡è®¾è®¡ï¼ˆImmutableï¼‰
- æä¾›ä¾¿æ·çš„è®¿é—®æ–¹æ³•

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸åŒ…å«å¯å˜çš„ä¸šåŠ¡é€»è¾‘
- ä¸åŒ…å«æ•°æ®åº“è¿æ¥

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/DecisionContext.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/snapshot/LogicStateSnapshot.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/snapshot/ParamSnapshot.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/snapshot/SignalSnapshot.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/snapshot/IndicatorSnapshot.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/snapshot/BarSnapshot.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/context/snapshot/PriceSnapshot.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- æ— å¤–éƒ¨ä¾èµ–ï¼ˆçº¯æ•°æ®æ¨¡å‹ï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šå¿«ç…§æ•°æ®ä¸ä¸€è‡´ï¼ˆæ—¶é—´ç‚¹ä¸åŒï¼‰
- è§„é¿ï¼šAtomicSampleråœ¨åŒä¸€æ—¶é—´ç‚¹é‡‡é›†æ‰€æœ‰æ•°æ®

**å·¥ä½œé‡**ï¼š2å¤©

---

#### ä»»åŠ¡3.2ï¼šå®ç° AtomicSamplerï¼ˆåŸå­é‡‡æ ·å™¨ï¼‰

**ç›®æ ‡**ï¼šåœ¨å†³ç­–æ—¶ç‚¹é‡‡é›†æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡æ•°æ®

**èŒƒå›´**ï¼š
- è¯»å– `strategy_logic_state`ï¼ˆå½“å‰çŠ¶æ€ï¼‰
- è¯»å– `strategy_param`ï¼ˆç­–ç•¥å‚æ•°ï¼‰
- è¯»å– `signal_intent`ï¼ˆæœ€æ–°ä¿¡å·ï¼ŒLATEST_ONLYï¼‰
- è¯»å– `indicator_value`ï¼ˆæœ€æ–°æŒ‡æ ‡å€¼ï¼‰
- è¯»å–Kçº¿æ•°æ®ï¼ˆå¦‚æœBarè§¦å‘ï¼‰
- è¯»å–æœ€æ–°ä»·æ ¼ï¼ˆä»å†…å­˜å¿«ç…§ï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸ä¿®æ”¹ä»»ä½•æ•°æ®ï¼ˆåªè¯»ï¼‰
- ä¸ç¼“å­˜æ•°æ®ï¼ˆæ¯æ¬¡å†³ç­–éƒ½é‡æ–°é‡‡é›†ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/sampler/AtomicSampler.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/sampler/IndicatorSnapshotLoader.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/sampler/PriceSnapshotLoader.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- StrategyLogicStateMapper
- StrategyParamMapper
- SignalIntentMapperï¼ˆéœ€è¦æ–°å»ºæˆ–ä½¿ç”¨ç°æœ‰ï¼‰
- IndicatorValueRepositoryï¼ˆæŒ‡æ ‡æ¨¡å—ï¼‰
- è¡Œæƒ…æ¨¡å—ï¼ˆä»·æ ¼å¿«ç…§ï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæ•°æ®é‡‡é›†è€—æ—¶è¿‡é•¿
- è§„é¿ï¼šä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼Œé¿å…N+1é—®é¢˜
- é£é™©ï¼šæ•°æ®ä¸å­˜åœ¨å¯¼è‡´å†³ç­–å¤±è´¥
- è§„é¿ï¼šå…è®¸éƒ¨åˆ†æ•°æ®ä¸ºç©ºï¼Œåœ¨GuardChainä¸­æ ¡éªŒ

**å·¥ä½œé‡**ï¼š3å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„4ï¼šé—¨ç¦å±‚ï¼ˆGuard Chainï¼‰

#### ä»»åŠ¡4.1ï¼šå®ç° GuardChainï¼ˆé—¨ç¦é“¾ï¼‰

**ç›®æ ‡**ï¼šåœ¨å†³ç­–å‰è¿›è¡Œå¤šå±‚æ ¡éªŒ

**èŒƒå›´**ï¼š
- PhaseGateï¼ˆé˜¶æ®µé—¨ç¦ï¼‰
- StalenessGateï¼ˆæ—¶æ•ˆé—¨ç¦ï¼‰
- DedupGateï¼ˆå»é‡é—¨ç¦ï¼‰
- SanityGateï¼ˆåˆç†æ€§é—¨ç¦ï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°ä¸šåŠ¡é€»è¾‘ï¼ˆåªåšæ ¡éªŒï¼‰
- ä¸ä¿®æ”¹æ•°æ®ï¼ˆåªè¯»æ ¡éªŒï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/guard/GuardChain.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/guard/Gate.java`ï¼ˆæ¥å£ï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/guard/PhaseGate.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/guard/StalenessGate.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/guard/DedupGate.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/guard/SanityGate.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- Redisï¼ˆç”¨äºDedupGateçš„ç¼“å­˜ï¼‰
- DecisionContext

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šRedisä¸å¯ç”¨æ—¶å»é‡å¤±æ•ˆ
- è§„é¿ï¼šRedisä¸å¯ç”¨æ—¶é™çº§åˆ°å†…å­˜ç¼“å­˜ï¼ˆå¸¦TTLï¼‰
- é£é™©ï¼šå»é‡é”®è®¾è®¡ä¸å½“å¯¼è‡´è¯¯åˆ¤
- è§„é¿ï¼šä½¿ç”¨å®Œæ•´çš„è§¦å‘æºä¿¡æ¯æ„å»ºå»é‡é”®

**å·¥ä½œé‡**ï¼š3å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„5ï¼šç­–ç•¥é€»è¾‘å±‚ï¼ˆStrategy Logicï¼‰

#### ä»»åŠ¡5.1ï¼šå®šä¹‰ StrategyLogic æ¥å£

**ç›®æ ‡**ï¼šå®šä¹‰ç­–ç•¥é€»è¾‘çš„æŠ½è±¡æ¥å£

**èŒƒå›´**ï¼š
- `DecisionResult decide(DecisionContext ctx)` æ–¹æ³•
- çº¯å‡½æ•°è®¾è®¡ï¼ˆæ— å‰¯ä½œç”¨ï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°å…·ä½“ç­–ç•¥é€»è¾‘ï¼ˆç”±å®ç°ç±»å®Œæˆï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/StrategyLogic.java`ï¼ˆæ¥å£ï¼Œæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/DecisionResult.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- æ— å¤–éƒ¨ä¾èµ–

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæ¥å£è®¾è®¡ä¸åˆç†å¯¼è‡´æ‰©å±•å›°éš¾
- è§„é¿ï¼šæ¥å£ä¿æŒç®€å•ï¼ŒåªåŒ…å«æ ¸å¿ƒæ–¹æ³•

**å·¥ä½œé‡**ï¼š0.5å¤©

---

#### ä»»åŠ¡5.2ï¼šå®ç° StrategyLogicRegistryï¼ˆç­–ç•¥é€»è¾‘æ³¨å†Œè¡¨ï¼‰

**ç›®æ ‡**ï¼šæŒ‰ç­–ç•¥ç±»å‹è·¯ç”±åˆ°å¯¹åº”çš„ç­–ç•¥é€»è¾‘å®ç°

**èŒƒå›´**ï¼š
- æ³¨å†Œç­–ç•¥é€»è¾‘å®ç°
- æŒ‰ `strategy_type` è·¯ç”±
- æ”¯æŒåŠ¨æ€æ³¨å†Œ

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°å…·ä½“ç­–ç•¥é€»è¾‘ï¼ˆç”±å®ç°ç±»å®Œæˆï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/StrategyLogicRegistry.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- Spring Beanç®¡ç†

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæ‰¾ä¸åˆ°ç­–ç•¥é€»è¾‘å®ç°
- è§„é¿ï¼šæ‰¾ä¸åˆ°æ—¶è¿”å›é»˜è®¤å®ç°ï¼ˆHOLDï¼‰

**å·¥ä½œé‡**ï¼š1å¤©

---

#### ä»»åŠ¡5.3ï¼šå®ç° SignalDrivenStrategyLogicï¼ˆä¿¡å·é©±åŠ¨ç­–ç•¥ï¼‰

**ç›®æ ‡**ï¼šå®ç°ä¿¡å·é©±åŠ¨çš„ç­–ç•¥é€»è¾‘

**èŒƒå›´**ï¼š
- è¯»å–ä¿¡å·æ„å›¾ï¼ˆLATEST_ONLYï¼‰
- æ ¹æ®ä¿¡å·æ–¹å‘å†³å®šåŠ¨ä½œ
- ç©ºä»“æ—¶ï¼šä¿¡å·BUY â†’ OPEN LONGï¼Œä¿¡å·SELL â†’ OPEN SHORT
- æŒä»“æ—¶ï¼šåå‘ä¿¡å· â†’ CLOSE/REVERSE

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸è€ƒè™‘æŒ‡æ ‡æ¡ä»¶ï¼ˆçº¯ä¿¡å·é©±åŠ¨ï¼‰
- ä¸è®¡ç®—å¤æ‚ä»“ä½ï¼ˆä½¿ç”¨base_order_ratioï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/impl/SignalDrivenStrategyLogic.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- DecisionContext
- StrategyParamï¼ˆè¯»å–base_order_ratioï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šä¿¡å·ä¸ºç©ºæ—¶å†³ç­–å¤±è´¥
- è§„é¿ï¼šä¿¡å·ä¸ºç©ºæ—¶è¿”å›HOLDï¼ˆç”±GuardChainæå‰æ‹¦æˆªï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

#### ä»»åŠ¡5.4ï¼šå®ç° IndicatorDrivenStrategyLogicï¼ˆæŒ‡æ ‡é©±åŠ¨ç­–ç•¥ï¼‰

**ç›®æ ‡**ï¼šå®ç°æŒ‡æ ‡é©±åŠ¨çš„ç­–ç•¥é€»è¾‘

**èŒƒå›´**ï¼š
- è¯»å–æŒ‡æ ‡å€¼ï¼ˆä»IndicatorSnapshotï¼‰
- è§£æentry_conditionå’Œexit_conditionï¼ˆJSONï¼‰
- æ ¹æ®æ¡ä»¶åˆ¤æ–­å†³å®šåŠ¨ä½œ

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°å¤æ‚çš„æŒ‡æ ‡ç»„åˆï¼ˆMVPåªæ”¯æŒç®€å•æ¡ä»¶ï¼‰
- ä¸å®ç°è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆä½¿ç”¨ç°æœ‰æŒ‡æ ‡ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/impl/IndicatorDrivenStrategyLogic.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/condition/ConditionEvaluator.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/condition/EntryConditionEvaluator.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/condition/ExitConditionEvaluator.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- DecisionContext
- JSONè§£æï¼ˆJacksonï¼‰
- æŒ‡æ ‡æ¨¡å—ï¼ˆIndicatorValueï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šæ¡ä»¶è§£æå¤±è´¥
- è§„é¿ï¼šè§£æå¤±è´¥æ—¶è¿”å›HOLDï¼Œè®°å½•ERRORæ—¥å¿—
- é£é™©ï¼šæŒ‡æ ‡å€¼ä¸å­˜åœ¨
- è§„é¿ï¼šç”±GuardChainæå‰æ‹¦æˆª

**å·¥ä½œé‡**ï¼š4å¤©

---

#### ä»»åŠ¡5.5ï¼šå®ç° HybridStrategyLogicï¼ˆæ··åˆç­–ç•¥ï¼‰

**ç›®æ ‡**ï¼šå®ç°ä¿¡å·+æŒ‡æ ‡çš„æ··åˆç­–ç•¥é€»è¾‘

**èŒƒå›´**ï¼š
- åŒæ—¶è€ƒè™‘ä¿¡å·å’ŒæŒ‡æ ‡
- æ”¯æŒALL/ANYæ¨¡å¼
- ä¿¡å·å’ŒæŒ‡æ ‡éƒ½æ»¡è¶³ï¼ˆALLï¼‰æˆ–ä»»ä¸€æ»¡è¶³ï¼ˆANYï¼‰æ—¶è§¦å‘

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°å¤æ‚çš„æƒé‡è®¡ç®—ï¼ˆMVPåªæ”¯æŒALL/ANYï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/logic/impl/HybridStrategyLogic.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- SignalDrivenStrategyLogicï¼ˆå¤ç”¨ï¼‰
- IndicatorDrivenStrategyLogicï¼ˆå¤ç”¨ï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šé€»è¾‘å¤æ‚å¯¼è‡´æ€§èƒ½é—®é¢˜
- è§„é¿ï¼šä½¿ç”¨çŸ­è·¯æ±‚å€¼ï¼ˆANYæ¨¡å¼ï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„6ï¼šè½åº“å±‚ï¼ˆRecordingï¼‰

#### ä»»åŠ¡6.1ï¼šå®ç° IntentRecorderï¼ˆè½åº“å™¨ï¼‰

**ç›®æ ‡**ï¼šå°†å†³ç­–ç»“æœå†™å…¥ `strategy_intent_record` è¡¨

**èŒƒå›´**ï¼š
- åªå†™å…¥åŠ¨ä½œæ„å›¾ï¼ˆOPEN/CLOSE/ADD/REDUCE/REVERSEï¼‰
- HOLDä¸è½åº“ï¼ˆåªè®°å½•metrics/logï¼‰
- `decision_reason` å¿…é¡»æ˜¯ç»“æ„åŒ–JSON

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°UPDATE/DELETEï¼ˆåªINSERTï¼‰
- ä¸å®ç°æ‰¹é‡å†™å…¥ï¼ˆå•æ¡å†™å…¥å³å¯ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/recorder/IntentRecorder.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/recorder/DecisionReasonBuilder.java`ï¼ˆæ–°å»ºï¼Œç”¨äºæ„å»ºreason JSONï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- StrategyIntentRecordMapper
- JSONåºåˆ—åŒ–ï¼ˆJacksonï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šreason JSONæ ¼å¼ä¸è§„èŒƒ
- è§„é¿ï¼šä½¿ç”¨ç»“æ„åŒ–Builderï¼Œç¡®ä¿æ ¼å¼ä¸€è‡´
- é£é™©ï¼šå†™å…¥å¤±è´¥å¯¼è‡´å†³ç­–ä¸¢å¤±
- è§„é¿ï¼šè®°å½•ERRORæ—¥å¿—ï¼Œä½†ä¸æŠ›å¼‚å¸¸ï¼ˆå…è®¸é‡è¯•ï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„7ï¼šä»·æ ¼è§¦å‘æœåŠ¡ï¼ˆPrice Triggerï¼‰

#### ä»»åŠ¡7.1ï¼šå®ç° PriceTriggerServiceï¼ˆä»·æ ¼é˜ˆå€¼æœåŠ¡ï¼‰

**ç›®æ ‡**ï¼šå®ç°ä»·æ ¼ç¨€ç–åŒ–è§¦å‘æœºåˆ¶

**èŒƒå›´**ï¼š
- è®¢é˜…ä»·æ ¼tickï¼ˆåªæ›´æ–°å¿«ç…§ï¼Œä¸è§¦å‘å†³ç­–ï¼‰
- ç›‘å¬ä»·æ ¼é˜ˆå€¼ï¼ˆTP/SL/çªç ´ä»·ä½ï¼‰
- ä»·æ ¼ç©¿è¶Šé˜ˆå€¼æ—¶ç”Ÿæˆ `PriceTriggeredDecisionEvent`
- å®ç°cooldownæœºåˆ¶ï¼ˆé˜²æ­¢æŠ–åŠ¨ï¼‰
- å®ç°é˜ˆå€¼æ³¨é”€è§„åˆ™ï¼ˆæŒä»“å¹³ä»“åæ³¨é”€ï¼‰

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸ç›´æ¥è§¦å‘å†³ç­–ï¼ˆåªå‘å¸ƒäº‹ä»¶ï¼‰
- ä¸å®ç°å¤æ‚çš„ç§»åŠ¨æ­¢æŸï¼ˆMVPåªæ”¯æŒå›ºå®šé˜ˆå€¼ï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/price/PriceTriggerService.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/price/PriceThreshold.java`ï¼ˆæ–°å»ºï¼‰
- `src/main/java/com/qyl/v2trade/business/strategy/decision/price/PriceThresholdRegistry.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- è¡Œæƒ…æ¨¡å—ï¼ˆä»·æ ¼è®¢é˜…ï¼‰
- Spring Eventsï¼ˆå‘å¸ƒPriceTriggeredDecisionEventï¼‰
- StrategyLogicStateï¼ˆè¯»å–æŒä»“ä¿¡æ¯ï¼Œç”¨äºæ³¨é”€é˜ˆå€¼ï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šä»·æ ¼æŠ–åŠ¨å¯¼è‡´é‡å¤è§¦å‘
- è§„é¿ï¼šä½¿ç”¨cooldownæœºåˆ¶ï¼ˆå¦‚5ç§’å†…ä¸é‡å¤è§¦å‘ï¼‰
- é£é™©ï¼šé˜ˆå€¼æœªæ³¨é”€å¯¼è‡´è¯¯è§¦å‘
- è§„é¿ï¼šæŒä»“å¹³ä»“åç«‹å³æ³¨é”€ç›¸å…³é˜ˆå€¼

**å·¥ä½œé‡**ï¼š3å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„8ï¼šå†³ç­–å¼•æ“å…¥å£ï¼ˆDecision Engineï¼‰

#### ä»»åŠ¡8.1ï¼šå®ç° DecisionEngineï¼ˆå†³ç­–å¼•æ“ï¼‰

**ç›®æ ‡**ï¼šæ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œå®ç°å®Œæ•´çš„å†³ç­–æµç¨‹

**èŒƒå›´**ï¼š
- æ¥æ”¶å†³ç­–ä»»åŠ¡ï¼ˆä»StripedExecutorï¼‰
- è°ƒç”¨AtomicSampleré‡‡é›†ä¸Šä¸‹æ–‡
- è°ƒç”¨GuardChainè¿›è¡Œæ ¡éªŒ
- è°ƒç”¨StrategyLogicè®¡ç®—å†³ç­–
- è°ƒç”¨IntentRecorderè½åº“

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°ä¸šåŠ¡é€»è¾‘ï¼ˆç”±StrategyLogicå®ç°ï¼‰
- ä¸ä¿®æ”¹çŠ¶æ€ï¼ˆåªè¯»+å†™intent_recordï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/engine/DecisionEngine.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- AtomicSampler
- GuardChain
- StrategyLogicRegistry
- IntentRecorder

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šå†³ç­–æµç¨‹å¼‚å¸¸å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- è§„é¿ï¼šä½¿ç”¨äº‹åŠ¡ï¼ˆåªè¯»äº‹åŠ¡+å†™intent_recordï¼‰
- é£é™©ï¼šå†³ç­–è€—æ—¶è¿‡é•¿
- è§„é¿ï¼šè®°å½•metricsï¼Œç›‘æ§å†³ç­–è€—æ—¶

**å·¥ä½œé‡**ï¼š2å¤©

---

### ğŸ¯ ä»»åŠ¡ç»„9ï¼šæŒ‡æ ‡ä¸ç›‘æ§ï¼ˆObservabilityï¼‰

#### ä»»åŠ¡9.1ï¼šå®ç°å†³ç­–æŒ‡æ ‡æ”¶é›†

**ç›®æ ‡**ï¼šæ”¶é›†å†³ç­–ç›¸å…³çš„metrics

**èŒƒå›´**ï¼š
- å†³ç­–æ€»æ•°ï¼ˆæŒ‰è§¦å‘æºåˆ†ç±»ï¼‰
- å†³ç­–è€—æ—¶ï¼ˆP50/P95/P99ï¼‰
- é—¨ç¦æ‹¦æˆªæ¬¡æ•°ï¼ˆæŒ‰é—¨ç¦ç±»å‹åˆ†ç±»ï¼‰
- HOLDæ¬¡æ•°ï¼ˆä¸è½åº“ï¼‰
- è½åº“æˆåŠŸ/å¤±è´¥æ¬¡æ•°

**ä¸åšä»€ä¹ˆ**ï¼š
- ä¸å®ç°å¤æ‚çš„å‘Šè­¦ï¼ˆåªæ”¶é›†metricsï¼‰

**éœ€è¦æ”¹çš„ç±»**ï¼š
- `src/main/java/com/qyl/v2trade/business/strategy/decision/observability/DecisionMetrics.java`ï¼ˆæ–°å»ºï¼‰

**ä¾èµ–æ¨¡å—**ï¼š
- Micrometerï¼ˆSpring Boot Actuatorï¼‰

**é£é™©ç‚¹ä¸è§„é¿**ï¼š
- é£é™©ï¼šmetricsè¿‡å¤šå¯¼è‡´æ€§èƒ½é—®é¢˜
- è§„é¿ï¼šä½¿ç”¨å¼‚æ­¥æ”¶é›†ï¼Œä¸é˜»å¡ä¸»æµç¨‹

**å·¥ä½œé‡**ï¼š1å¤©

---

## äºŒã€ä»£ç ç»“æ„å»ºè®®

### 2.1 ç›®å½•æ ‘ç»“æ„

```
src/main/java/com/qyl/v2trade/business/strategy/decision/
â”œâ”€â”€ event/                          # å†³ç­–äº‹ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ SignalIntentActivatedEvent.java
â”‚   â”œâ”€â”€ IndicatorComputedEvent.java
â”‚   â”œâ”€â”€ BarClosedEvent.java
â”‚   â””â”€â”€ PriceTriggeredDecisionEvent.java
â”‚
â”œâ”€â”€ executor/                       # ä¸²è¡Œæ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ StripedExecutor.java
â”‚   â””â”€â”€ InstanceKey.java
â”‚
â”œâ”€â”€ router/                         # äº‹ä»¶è·¯ç”±
â”‚   â”œâ”€â”€ DecisionEventRouter.java
â”‚   â””â”€â”€ StrategyInstanceLocator.java
â”‚
â”œâ”€â”€ context/                        # å†³ç­–ä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ DecisionContext.java
â”‚   â””â”€â”€ snapshot/
â”‚       â”œâ”€â”€ LogicStateSnapshot.java
â”‚       â”œâ”€â”€ ParamSnapshot.java
â”‚       â”œâ”€â”€ SignalSnapshot.java
â”‚       â”œâ”€â”€ IndicatorSnapshot.java
â”‚       â”œâ”€â”€ BarSnapshot.java
â”‚       â””â”€â”€ PriceSnapshot.java
â”‚
â”œâ”€â”€ sampler/                        # åŸå­é‡‡æ ·å™¨
â”‚   â”œâ”€â”€ AtomicSampler.java
â”‚   â”œâ”€â”€ IndicatorSnapshotLoader.java
â”‚   â””â”€â”€ PriceSnapshotLoader.java
â”‚
â”œâ”€â”€ guard/                          # é—¨ç¦é“¾
â”‚   â”œâ”€â”€ GuardChain.java
â”‚   â”œâ”€â”€ Gate.java
â”‚   â”œâ”€â”€ PhaseGate.java
â”‚   â”œâ”€â”€ StalenessGate.java
â”‚   â”œâ”€â”€ DedupGate.java
â”‚   â””â”€â”€ SanityGate.java
â”‚
â”œâ”€â”€ logic/                          # ç­–ç•¥é€»è¾‘
â”‚   â”œâ”€â”€ StrategyLogic.java
â”‚   â”œâ”€â”€ StrategyLogicRegistry.java
â”‚   â”œâ”€â”€ DecisionResult.java
â”‚   â”œâ”€â”€ condition/
â”‚   â”‚   â”œâ”€â”€ ConditionEvaluator.java
â”‚   â”‚   â”œâ”€â”€ EntryConditionEvaluator.java
â”‚   â”‚   â””â”€â”€ ExitConditionEvaluator.java
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ SignalDrivenStrategyLogic.java
â”‚       â”œâ”€â”€ IndicatorDrivenStrategyLogic.java
â”‚       â””â”€â”€ HybridStrategyLogic.java
â”‚
â”œâ”€â”€ recorder/                       # è½åº“å™¨
â”‚   â”œâ”€â”€ IntentRecorder.java
â”‚   â””â”€â”€ DecisionReasonBuilder.java
â”‚
â”œâ”€â”€ price/                          # ä»·æ ¼è§¦å‘æœåŠ¡
â”‚   â”œâ”€â”€ PriceTriggerService.java
â”‚   â”œâ”€â”€ PriceThreshold.java
â”‚   â””â”€â”€ PriceThresholdRegistry.java
â”‚
â”œâ”€â”€ engine/                         # å†³ç­–å¼•æ“
â”‚   â””â”€â”€ DecisionEngine.java
â”‚
â””â”€â”€ observability/                 # æŒ‡æ ‡ä¸ç›‘æ§
    â””â”€â”€ DecisionMetrics.java
```

### 2.2 æ ¸å¿ƒæ¥å£è®¾è®¡

#### DecisionEngineï¼ˆå†³ç­–å¼•æ“å…¥å£ï¼‰

```java
public class DecisionEngine {
    private final AtomicSampler sampler;
    private final GuardChain guardChain;
    private final StrategyLogicRegistry logicRegistry;
    private final IntentRecorder recorder;
    private final DecisionMetrics metrics;
    
    public void executeDecision(DecisionTask task) {
        // 1. é‡‡é›†ä¸Šä¸‹æ–‡
        DecisionContext ctx = sampler.sample(task);
        
        // 2. é—¨ç¦æ ¡éªŒ
        GuardResult guardResult = guardChain.check(ctx);
        if (!guardResult.isAllowed()) {
            metrics.recordGuardRejected(guardResult.getRejectedGate());
            return;
        }
        
        // 3. ç­–ç•¥é€»è¾‘è®¡ç®—
        StrategyLogic logic = logicRegistry.getLogic(ctx.getStrategyType());
        DecisionResult result = logic.decide(ctx);
        
        // 4. è½åº“ï¼ˆä»…åŠ¨ä½œæ„å›¾ï¼‰
        if (result.getAction() != IntentActionEnum.HOLD) {
            recorder.record(ctx, result);
            metrics.recordIntentRecorded(result.getAction());
        } else {
            metrics.recordHold();
        }
    }
}
```

#### StrategyLogicï¼ˆç­–ç•¥é€»è¾‘æ¥å£ï¼‰

```java
public interface StrategyLogic {
    /**
     * å†³ç­–è®¡ç®—ï¼ˆçº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ï¼‰
     * 
     * @param ctx å†³ç­–ä¸Šä¸‹æ–‡ï¼ˆä¸å¯å˜ï¼‰
     * @return å†³ç­–ç»“æœ
     */
    DecisionResult decide(DecisionContext ctx);
    
    /**
     * æ”¯æŒçš„ç­–ç•¥ç±»å‹
     */
    String getSupportedStrategyType();
}
```

#### GuardChainï¼ˆé—¨ç¦é“¾ï¼‰

```java
public class GuardChain {
    private final List<Gate> gates;
    
    public GuardResult check(DecisionContext ctx) {
        for (Gate gate : gates) {
            GuardResult result = gate.check(ctx);
            if (!result.isAllowed()) {
                return result;
            }
        }
        return GuardResult.allowed();
    }
}
```

---

## ä¸‰ã€äº‹ä»¶å¥‘çº¦è®¾è®¡

### 3.1 SignalIntentActivatedEventï¼ˆä¿¡å·æ„å›¾æ¿€æ´»äº‹ä»¶ï¼‰

```java
public class SignalIntentActivatedEvent extends ApplicationEvent {
    private final Long userId;
    private final Long strategyId;
    private final Long tradingPairId;
    private final Long signalIntentId;
    private final String intentDirection;  // BUY/SELL/FLAT/REVERSE
    private final LocalDateTime activatedAt;
    
    // æ„é€ å‡½æ•°ã€getter...
}
```

**è·¯ç”±è§„åˆ™**ï¼š
- æ ¹æ® `strategyId + tradingPairId` æŸ¥æ‰¾ StrategyInstance
- å¦‚æœæ‰¾ä¸åˆ°ï¼Œè®°å½•WARNæ—¥å¿—ï¼Œä¸æŠ›å¼‚å¸¸

---

### 3.2 IndicatorComputedEventï¼ˆæŒ‡æ ‡è®¡ç®—å®Œæˆäº‹ä»¶ï¼‰

```java
public class IndicatorComputedEvent extends ApplicationEvent {
    private final Long userId;
    private final Long tradingPairId;
    private final String indicatorCode;
    private final String indicatorVersion;
    private final LocalDateTime barTime;
    private final Map<String, BigDecimal> indicatorValues;
    
    // æ„é€ å‡½æ•°ã€getter...
}
```

**è·¯ç”±è§„åˆ™**ï¼š
- æ ¹æ® `tradingPairId` æŸ¥æ‰¾æ‰€æœ‰è®¢é˜…è¯¥æŒ‡æ ‡çš„ç­–ç•¥å®ä¾‹
- éœ€è¦æŸ¥è¯¢ `strategy_signal_subscription` è¡¨ï¼ˆå¦‚æœç­–ç•¥è®¢é˜…äº†è¯¥æŒ‡æ ‡ï¼‰
- å¦‚æœæ‰¾ä¸åˆ°ï¼Œè®°å½•DEBUGæ—¥å¿—ï¼ˆæ­£å¸¸æƒ…å†µï¼Œä¸æ˜¯æ‰€æœ‰ç­–ç•¥éƒ½è®¢é˜…æ‰€æœ‰æŒ‡æ ‡ï¼‰

---

### 3.3 BarClosedEventï¼ˆKçº¿é—­åˆäº‹ä»¶ï¼‰

```java
public class BarClosedEvent extends ApplicationEvent {
    private final Long tradingPairId;
    private final String timeframe;  // 1m/5m/15m/1h/1d
    private final LocalDateTime barCloseTime;
    private final BigDecimal open;
    private final BigDecimal high;
    private final BigDecimal low;
    private final BigDecimal close;
    private final BigDecimal volume;
    
    // æ„é€ å‡½æ•°ã€getter...
}
```

**è·¯ç”±è§„åˆ™**ï¼š
- æ ¹æ® `tradingPairId` æŸ¥æ‰¾æ‰€æœ‰åœ¨è¯¥äº¤æ˜“å¯¹ä¸Šè¿è¡Œçš„ç­–ç•¥å®ä¾‹
- éœ€è¦æŸ¥è¯¢ `strategy_symbol` è¡¨

---

### 3.4 PriceTriggeredDecisionEventï¼ˆä»·æ ¼é˜ˆå€¼ç©¿è¶Šäº‹ä»¶ï¼‰

```java
public class PriceTriggeredDecisionEvent extends ApplicationEvent {
    private final Long strategyId;
    private final Long tradingPairId;
    private final String triggerType;  // TAKE_PROFIT/STOP_LOSS/BREAKOUT
    private final BigDecimal triggerPrice;
    private final BigDecimal currentPrice;
    private final LocalDateTime triggeredAt;
    
    // æ„é€ å‡½æ•°ã€getter...
}
```

**è·¯ç”±è§„åˆ™**ï¼š
- æ ¹æ® `strategyId + tradingPairId` ç›´æ¥å®šä½ StrategyInstance
- å¦‚æœæ‰¾ä¸åˆ°ï¼Œè®°å½•WARNæ—¥å¿—ï¼ˆå¯èƒ½æ˜¯ç­–ç•¥å·²åœæ­¢ï¼‰

---

## å››ã€å¹‚ç­‰é”®è§„åˆ™

### 4.1 å¹‚ç­‰é”®ç»„æˆè§„åˆ™

**é€šç”¨æ ¼å¼**ï¼š`{triggerType}:{strategyId}:{tradingPairId}:{uniqueKey}`

#### SignalIntentActivatedEvent

```
dedupKey = "SIGNAL:{strategyId}:{tradingPairId}:{signalIntentId}"
```

**è¯´æ˜**ï¼šåŒä¸€ä¸ª `signalIntentId` åªè§¦å‘ä¸€æ¬¡å†³ç­–

---

#### IndicatorComputedEvent

```
dedupKey = "INDICATOR:{strategyId}:{tradingPairId}:{indicatorCode}:{barTime}"
```

**è¯´æ˜**ï¼šåŒä¸€ä¸ªæŒ‡æ ‡åœ¨åŒä¸€ä¸ªbaræ—¶é—´åªè§¦å‘ä¸€æ¬¡å†³ç­–

---

#### BarClosedEvent

```
dedupKey = "BAR:{strategyId}:{tradingPairId}:{timeframe}:{barCloseTime}"
```

**è¯´æ˜**ï¼šåŒä¸€æ ¹Kçº¿åªè§¦å‘ä¸€æ¬¡å†³ç­–

---

#### PriceTriggeredDecisionEvent

```
dedupKey = "PRICE:{strategyId}:{tradingPairId}:{triggerType}:{cooldownWindow}"
```

**è¯´æ˜**ï¼š
- `cooldownWindow` = `triggeredAt` å‘ä¸‹å–æ•´åˆ°cooldownå‘¨æœŸï¼ˆå¦‚5ç§’ï¼‰
- åŒä¸€ä¸ªcooldownçª—å£å†…åªè§¦å‘ä¸€æ¬¡

**ç¤ºä¾‹**ï¼š
```
triggeredAt = 2024-01-01 10:00:03.500
cooldown = 5ç§’
cooldownWindow = 2024-01-01 10:00:00
dedupKey = "PRICE:1:101:STOP_LOSS:2024-01-01T10:00:00"
```

---

### 4.2 å»é‡ç¼“å­˜è®¾è®¡

**å­˜å‚¨**ï¼šRedisï¼ˆä¼˜å…ˆï¼‰æˆ–å†…å­˜ç¼“å­˜ï¼ˆé™çº§ï¼‰

**Keyæ ¼å¼**ï¼š`strategy:decision:dedup:{dedupKey}`

**Value**ï¼š`{timestamp}`ï¼ˆè§¦å‘æ—¶é—´æˆ³ï¼‰

**TTL**ï¼š
- SIGNAL: 1å°æ—¶
- INDICATOR: 1å°æ—¶
- BAR: 24å°æ—¶ï¼ˆåŒä¸€æ ¹Kçº¿ä¸ä¼šé‡å¤ï¼‰
- PRICE: cooldownæ—¶é—´ + 1ç§’ï¼ˆå¦‚6ç§’ï¼‰

**å»é‡é€»è¾‘**ï¼š
```java
public boolean isDuplicate(String dedupKey) {
    String cacheKey = "strategy:decision:dedup:" + dedupKey;
    String existing = redis.get(cacheKey);
    if (existing != null) {
        return true;  // å·²å­˜åœ¨ï¼Œé‡å¤
    }
    redis.setex(cacheKey, ttl, String.valueOf(System.currentTimeMillis()));
    return false;  // ä¸å­˜åœ¨ï¼Œéé‡å¤
}
```

---

## äº”ã€å­—æ®µè§„èŒƒ

### 5.1 strategy_intent_record å†™å…¥å­—æ®µè§„èŒƒ

#### å¿…å¡«å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ¥æº |
|------|------|------|------|
| `user_id` | BIGINT | ç”¨æˆ·ID | DecisionContext.userId |
| `strategy_id` | BIGINT | ç­–ç•¥ID | DecisionContext.strategyId |
| `trading_pair_id` | BIGINT | äº¤æ˜“å¯¹ID | DecisionContext.tradingPairId |
| `signal_id` | BIGINT | è§¦å‘ä¿¡å·IDï¼ˆå¯ç©ºï¼‰ | DecisionContext.signalSnapshot.signalIntentId |
| `intent_action` | VARCHAR(32) | å†³ç­–æ„å›¾ | DecisionResult.action |
| `calculated_qty` | DECIMAL(20,8) | è®¡ç®—å‡ºçš„æ•°é‡ | DecisionResult.calculatedQty |
| `decision_reason` | VARCHAR(255) | å†³ç­–åŸå› ï¼ˆJSONï¼‰ | DecisionReasonBuilder.build() |
| `created_at` | DATETIME | å†³ç­–æ—¶é—´ | LocalDateTime.now() |

#### decision_reason JSON æœ€ä½å¿…å«å­—æ®µ

```json
{
  "trigger": {
    "type": "SIGNAL|INDICATOR|BAR|PRICE",
    "source": "signalIntentId|indicatorCode|barCloseTime|triggerType",
    "timestamp": "2024-01-01T10:00:00"
  },
  "logicStateBefore": {
    "phase": "IDLE|OPENED|...",
    "positionSide": "FLAT|LONG|SHORT",
    "positionQty": "0.0",
    "avgEntryPrice": "65000.00"
  },
  "snapshots": {
    "signal": {
      "intentId": 123,
      "direction": "BUY",
      "activatedAt": "2024-01-01T10:00:00"
    },
    "indicator": {
      "code": "RSI_14",
      "value": 30.5,
      "barTime": "2024-01-01T10:00:00"
    },
    "bar": {
      "timeframe": "1h",
      "closeTime": "2024-01-01T10:00:00",
      "close": "65000.00"
    },
    "price": {
      "current": "65000.00",
      "timestamp": "2024-01-01T10:00:00.500"
    }
  },
  "paramsDigest": {
    "initialCapital": "10000.00",
    "baseOrderRatio": "0.1",
    "takeProfitRatio": "0.05",
    "stopLossRatio": "0.02"
  },
  "guardResult": {
    "passed": true,
    "rejectedGate": null
  }
}
```

**è¯´æ˜**ï¼š
- æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼ˆæ ¹æ®è§¦å‘æºä¸åŒï¼Œéƒ¨åˆ†å­—æ®µå¯èƒ½ä¸ºç©ºï¼‰
- `snapshots` ä¸­åªåŒ…å«å®é™…ä½¿ç”¨çš„æ•°æ®ï¼ˆå¦‚ä¿¡å·è§¦å‘æ—¶ï¼Œindicatorå¯èƒ½ä¸ºç©ºï¼‰
- `paramsDigest` å¯é€‰ï¼Œç”¨äºå›æ”¾æ—¶éªŒè¯å‚æ•°æ˜¯å¦å˜åŒ–

---

## å…­ã€éªŒæ”¶ç”¨ä¾‹

### 6.1 å¹‚ç­‰æ€§éªŒæ”¶

#### ç”¨ä¾‹1.1ï¼šåŒä¸€ä¿¡å·é‡å¤è§¦å‘100æ¬¡åªå†™1æ¡è®°å½•

**å‰ç½®æ¡ä»¶**ï¼š
- ç­–ç•¥å·²å¯åŠ¨ï¼ˆé˜¶æ®µ1å®Œæˆï¼‰
- ä¿¡å·æ„å›¾å·²æ¿€æ´»ï¼ˆsignal_intentè¡¨æœ‰ACTIVEè®°å½•ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘å¸ƒ `SignalIntentActivatedEvent` 100æ¬¡ï¼ˆç›¸åŒsignalIntentIdï¼‰
2. ç­‰å¾…æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæˆ
3. æŸ¥è¯¢ `strategy_intent_record` è¡¨

**é¢„æœŸç»“æœ**ï¼š
- åªæœ‰1æ¡è®°å½•
- `signal_id` = signalIntentId
- `intent_action` = OPENï¼ˆæˆ–å…¶ä»–åŠ¨ä½œï¼‰
- `decision_reason` ä¸­åŒ…å« `trigger.type = "SIGNAL"`

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```java
@Test
public void testSignalDeduplication() {
    Long signalIntentId = 123L;
    SignalIntentActivatedEvent event = new SignalIntentActivatedEvent(...);
    
    // å‘å¸ƒ100æ¬¡
    for (int i = 0; i < 100; i++) {
        eventPublisher.publishEvent(event);
    }
    
    // ç­‰å¾…å¤„ç†å®Œæˆ
    await().atMost(10, SECONDS).until(() -> {
        return intentRecordMapper.count(...) == 1;
    });
    
    // éªŒè¯
    StrategyIntentRecord record = intentRecordMapper.selectOne(...);
    assertThat(record.getSignalId()).isEqualTo(signalIntentId);
    assertThat(record.getIntentAction()).isEqualTo(IntentActionEnum.OPEN);
}
```

---

### 6.2 ä»·æ ¼æ­¢æŸéªŒæ”¶

#### ç”¨ä¾‹2.1ï¼šä»·æ ¼ç©¿è¶Šæ­¢æŸé˜ˆå€¼åªäº§ç”Ÿ1æ¡CLOSEï¼ˆæŠ–åŠ¨ä¸é‡å¤ï¼‰

**å‰ç½®æ¡ä»¶**ï¼š
- ç­–ç•¥å·²å¯åŠ¨ï¼ŒæŒä»“LONG 0.1 BTC
- æ­¢æŸä»·æ ¼ = 64000 USDT
- å½“å‰ä»·æ ¼ = 65000 USDT

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä»·æ ¼ä»65000å¿«é€Ÿä¸‹è·Œåˆ°63900ï¼ˆç©¿è¶Šæ­¢æŸï¼‰
2. ä»·æ ¼åœ¨63900-64100ä¹‹é—´æŠ–åŠ¨ï¼ˆ10ç§’å†…ï¼‰
3. ç­‰å¾…ä»·æ ¼ç¨³å®š
4. æŸ¥è¯¢ `strategy_intent_record` è¡¨

**é¢„æœŸç»“æœ**ï¼š
- åªæœ‰1æ¡CLOSEè®°å½•
- `intent_action` = CLOSE
- `decision_reason` ä¸­åŒ…å« `trigger.type = "PRICE"` å’Œ `trigger.triggerType = "STOP_LOSS"`
- ä»·æ ¼æŠ–åŠ¨æœŸé—´ä¸äº§ç”Ÿæ–°è®°å½•ï¼ˆcooldownç”Ÿæ•ˆï¼‰

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```java
@Test
public void testPriceStopLossDeduplication() {
    // è®¾ç½®æ­¢æŸ
    priceTriggerService.registerThreshold(
        strategyId, tradingPairId, 
        PriceThreshold.stopLoss(64000.0, 5)  // 5ç§’cooldown
    );
    
    // æ¨¡æ‹Ÿä»·æ ¼ç©¿è¶Š
    priceService.updatePrice(tradingPairId, 63900.0);
    Thread.sleep(100);
    priceService.updatePrice(tradingPairId, 64050.0);  // æŠ–åŠ¨
    Thread.sleep(100);
    priceService.updatePrice(tradingPairId, 63950.0);  // æŠ–åŠ¨
    
    // ç­‰å¾…å¤„ç†å®Œæˆ
    await().atMost(5, SECONDS).until(() -> {
        return intentRecordMapper.count(...) == 1;
    });
    
    // éªŒè¯
    StrategyIntentRecord record = intentRecordMapper.selectOne(...);
    assertThat(record.getIntentAction()).isEqualTo(IntentActionEnum.CLOSE);
    assertThat(parseReason(record.getDecisionReason()))
        .extracting("trigger.type", "trigger.triggerType")
        .containsExactly("PRICE", "STOP_LOSS");
}
```

---

### 6.3 Baré—­åˆéªŒæ”¶

#### ç”¨ä¾‹3.1ï¼šåŒä¸€æ ¹barCloseTimeä¸é‡å¤å†³ç­–ï¼›ä¸‹ä¸€æ ¹èƒ½å†æ¬¡å†³ç­–

**å‰ç½®æ¡ä»¶**ï¼š
- ç­–ç•¥å·²å¯åŠ¨
- ç­–ç•¥è®¢é˜…1å°æ—¶Kçº¿

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘å¸ƒ `BarClosedEvent`ï¼ˆbarCloseTime = 2024-01-01 10:00:00ï¼‰10æ¬¡
2. ç­‰å¾…å¤„ç†å®Œæˆ
3. æŸ¥è¯¢è®°å½•æ•°
4. å‘å¸ƒä¸‹ä¸€æ ¹Kçº¿ `BarClosedEvent`ï¼ˆbarCloseTime = 2024-01-01 11:00:00ï¼‰
5. æŸ¥è¯¢è®°å½•æ•°

**é¢„æœŸç»“æœ**ï¼š
- æ­¥éª¤3ï¼šåªæœ‰1æ¡è®°å½•
- æ­¥éª¤5ï¼šæœ‰2æ¡è®°å½•ï¼ˆåŒä¸€æ ¹ä¸é‡å¤ï¼Œä¸‹ä¸€æ ¹èƒ½å†æ¬¡å†³ç­–ï¼‰

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```java
@Test
public void testBarClosedDeduplication() {
    LocalDateTime barTime1 = LocalDateTime.of(2024, 1, 1, 10, 0, 0);
    LocalDateTime barTime2 = LocalDateTime.of(2024, 1, 1, 11, 0, 0);
    
    // å‘å¸ƒåŒä¸€æ ¹Kçº¿10æ¬¡
    for (int i = 0; i < 10; i++) {
        eventPublisher.publishEvent(new BarClosedEvent(..., barTime1));
    }
    
    await().atMost(5, SECONDS).until(() -> {
        return intentRecordMapper.count(...) == 1;
    });
    
    // å‘å¸ƒä¸‹ä¸€æ ¹Kçº¿
    eventPublisher.publishEvent(new BarClosedEvent(..., barTime2));
    
    await().atMost(5, SECONDS).until(() -> {
        return intentRecordMapper.count(...) == 2;
    });
}
```

---

### 6.4 æŒ‡æ ‡é©±åŠ¨éªŒæ”¶

#### ç”¨ä¾‹4.1ï¼šæŒ‡æ ‡å€¼æ›´æ–°è§¦å‘å†³ç­–ï¼Œreasonä¸­èƒ½çœ‹åˆ°indicatorä¿¡æ¯

**å‰ç½®æ¡ä»¶**ï¼š
- ç­–ç•¥å·²å¯åŠ¨ï¼Œç±»å‹ä¸ºINDICATOR_DRIVEN
- ç­–ç•¥è®¢é˜…RSI_14æŒ‡æ ‡
- å…¥åœºæ¡ä»¶ï¼šRSI < 30

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘å¸ƒ `IndicatorComputedEvent`ï¼ˆRSI_14 = 25ï¼‰
2. ç­‰å¾…å¤„ç†å®Œæˆ
3. æŸ¥è¯¢ `strategy_intent_record` è¡¨

**é¢„æœŸç»“æœ**ï¼š
- æœ‰1æ¡OPENè®°å½•
- `decision_reason` ä¸­åŒ…å«ï¼š
  - `trigger.type = "INDICATOR"`
  - `trigger.source = "RSI_14"`
  - `snapshots.indicator.code = "RSI_14"`
  - `snapshots.indicator.value = 25.0`
  - `snapshots.indicator.barTime` = æŒ‡æ ‡è®¡ç®—çš„baræ—¶é—´

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```java
@Test
public void testIndicatorDrivenDecision() {
    IndicatorComputedEvent event = new IndicatorComputedEvent(
        userId, tradingPairId, "RSI_14", "1.0",
        barTime, Map.of("RSI", BigDecimal.valueOf(25.0))
    );
    
    eventPublisher.publishEvent(event);
    
    await().atMost(5, SECONDS).until(() -> {
        return intentRecordMapper.count(...) > 0;
    });
    
    StrategyIntentRecord record = intentRecordMapper.selectOne(...);
    Map<String, Object> reason = parseReason(record.getDecisionReason());
    
    assertThat(reason)
        .extracting(
            "trigger.type",
            "trigger.source",
            "snapshots.indicator.code",
            "snapshots.indicator.value"
        )
        .containsExactly("INDICATOR", "RSI_14", "RSI_14", 25.0);
}
```

---

### 6.5 ç©ºä»“/æŒä»“åˆ†æµéªŒæ”¶

#### ç”¨ä¾‹5.1ï¼šFLATåªå…è®¸OPENï¼›æŒä»“å…è®¸CLOSE/REDUCE/ADD

**å‰ç½®æ¡ä»¶**ï¼š
- ç­–ç•¥å·²å¯åŠ¨

**æµ‹è¯•æ­¥éª¤**ï¼š
1. **ç©ºä»“çŠ¶æ€**ï¼ˆlogic_position_side = FLATï¼‰ï¼š
   - å‘å¸ƒä¿¡å·BUYäº‹ä»¶
   - æŸ¥è¯¢è®°å½•ï¼ŒéªŒè¯action = OPEN
   - å‘å¸ƒä¿¡å·SELLäº‹ä»¶ï¼ˆå°è¯•å¹³ä»“ï¼‰
   - æŸ¥è¯¢è®°å½•ï¼ŒéªŒè¯æ²¡æœ‰CLOSEè®°å½•ï¼ˆç©ºä»“ä¸èƒ½å¹³ä»“ï¼‰

2. **æŒä»“çŠ¶æ€**ï¼ˆlogic_position_side = LONG, qty > 0ï¼‰ï¼š
   - å‘å¸ƒæ­¢æŸä»·æ ¼ç©¿è¶Šäº‹ä»¶
   - æŸ¥è¯¢è®°å½•ï¼ŒéªŒè¯action = CLOSE
   - å‘å¸ƒæ­¢ç›ˆä»·æ ¼ç©¿è¶Šäº‹ä»¶ï¼ˆéƒ¨åˆ†æ­¢ç›ˆï¼‰
   - æŸ¥è¯¢è®°å½•ï¼ŒéªŒè¯action = REDUCE

**é¢„æœŸç»“æœ**ï¼š
- ç©ºä»“æ—¶ï¼šåªèƒ½OPENï¼Œä¸èƒ½CLOSE/REDUCE/ADD
- æŒä»“æ—¶ï¼šå¯ä»¥CLOSE/REDUCE/ADD/REVERSEï¼Œä¸èƒ½OPENï¼ˆé™¤éå…ˆå¹³ä»“ï¼‰

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```java
@Test
public void testPositionStateGate() {
    // æµ‹è¯•ç©ºä»“çŠ¶æ€
    logicState.setLogicPositionSideEnum(LogicDirectionEnum.FLAT);
    logicState.setLogicPositionQty(BigDecimal.ZERO);
    
    // å°è¯•å¼€ä»“ï¼ˆåº”è¯¥æˆåŠŸï¼‰
    eventPublisher.publishEvent(new SignalIntentActivatedEvent(..., "BUY"));
    await().atMost(5, SECONDS).until(() -> {
        return intentRecordMapper.count(...) == 1;
    });
    StrategyIntentRecord record1 = intentRecordMapper.selectOne(...);
    assertThat(record1.getIntentAction()).isEqualTo(IntentActionEnum.OPEN);
    
    // å°è¯•å¹³ä»“ï¼ˆåº”è¯¥è¢«é—¨ç¦æ‹¦æˆªï¼‰
    eventPublisher.publishEvent(new SignalIntentActivatedEvent(..., "SELL"));
    Thread.sleep(2, SECONDS);
    assertThat(intentRecordMapper.count(...)).isEqualTo(1);  // æ²¡æœ‰æ–°è®°å½•
    
    // æµ‹è¯•æŒä»“çŠ¶æ€
    logicState.setLogicPositionSideEnum(LogicDirectionEnum.LONG);
    logicState.setLogicPositionQty(BigDecimal.valueOf(0.1));
    
    // å°è¯•å¹³ä»“ï¼ˆåº”è¯¥æˆåŠŸï¼‰
    eventPublisher.publishEvent(new PriceTriggeredDecisionEvent(..., "STOP_LOSS"));
    await().atMost(5, SECONDS).until(() -> {
        return intentRecordMapper.count(...) == 2;
    });
    StrategyIntentRecord record2 = intentRecordMapper.selectLast(...);
    assertThat(record2.getIntentAction()).isEqualTo(IntentActionEnum.CLOSE);
}
```

---

### 6.6 HOLDä¸è½åº“éªŒæ”¶

#### ç”¨ä¾‹6.1ï¼šæ¡ä»¶ä¸æ»¡è¶³æ—¶è¡¨ä¸­ä¸æ–°å¢è®°å½•ï¼Œä½†metrics/logæœ‰ç»Ÿè®¡

**å‰ç½®æ¡ä»¶**ï¼š
- ç­–ç•¥å·²å¯åŠ¨
- å…¥åœºæ¡ä»¶ï¼šRSI < 30

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å‘å¸ƒ `IndicatorComputedEvent`ï¼ˆRSI_14 = 50ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼‰
2. ç­‰å¾…å¤„ç†å®Œæˆ
3. æŸ¥è¯¢ `strategy_intent_record` è¡¨
4. æŸ¥è¯¢metricsï¼ˆHOLDæ¬¡æ•°ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- è¡¨ä¸­æ²¡æœ‰æ–°è®°å½•
- metricsä¸­ `decision.hold.count` å¢åŠ 1
- æ—¥å¿—ä¸­æœ‰INFOçº§åˆ«è®°å½•ï¼š"å†³ç­–ç»“æœï¼šHOLDï¼ŒåŸå› ï¼šå…¥åœºæ¡ä»¶ä¸æ»¡è¶³"

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```java
@Test
public void testHoldNotRecorded() {
    int initialCount = intentRecordMapper.count(...);
    double initialHoldCount = metrics.getHoldCount();
    
    // å‘å¸ƒä¸æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶
    eventPublisher.publishEvent(new IndicatorComputedEvent(
        ..., "RSI_14", ..., Map.of("RSI", BigDecimal.valueOf(50.0))
    ));
    
    await().atMost(5, SECONDS).until(() -> {
        return metrics.getHoldCount() > initialHoldCount;
    });
    
    // éªŒè¯æ²¡æœ‰æ–°è®°å½•
    assertThat(intentRecordMapper.count(...)).isEqualTo(initialCount);
    
    // éªŒè¯metricså¢åŠ 
    assertThat(metrics.getHoldCount()).isGreaterThan(initialHoldCount);
}
```

---

## ä¸ƒã€P1/P2æ¼”è¿›å»ºè®®

### P1ï¼šå¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

#### ä»»åŠ¡P1.1ï¼šæ”¯æŒæ›´å¤šæŒ‡æ ‡æ¡ä»¶

**ç›®æ ‡**ï¼šæ‰©å±•IndicatorDrivenStrategyLogicæ”¯æŒæ›´å¤šæŒ‡æ ‡

**èŒƒå›´**ï¼š
- MACDäº¤å‰
- å‡çº¿ç³»ç»Ÿï¼ˆMA5/MA10/MA20ï¼‰
- å¸ƒæ—å¸¦çªç ´

**å·¥ä½œé‡**ï¼š3å¤©

---

#### ä»»åŠ¡P1.2ï¼šå®ç°ç§»åŠ¨æ­¢æŸ

**ç›®æ ‡**ï¼šåœ¨PriceTriggerServiceä¸­æ”¯æŒç§»åŠ¨æ­¢æŸ

**èŒƒå›´**ï¼š
- è·Ÿè¸ªæœ€é«˜ä»·ï¼ˆåšå¤šï¼‰æˆ–æœ€ä½ä»·ï¼ˆåšç©ºï¼‰
- åŠ¨æ€è°ƒæ•´æ­¢æŸä»·æ ¼
- æ”¯æŒå›æ’¤ç™¾åˆ†æ¯”

**å·¥ä½œé‡**ï¼š2å¤©

---

#### ä»»åŠ¡P1.3ï¼šå†³ç­–å›æ”¾åŠŸèƒ½

**ç›®æ ‡**ï¼šåŸºäº `strategy_intent_record` å®ç°å†³ç­–å›æ”¾

**èŒƒå›´**ï¼š
- è¯»å–å†å²å†³ç­–è®°å½•
- è§£æ `decision_reason` JSON
- å¯è§†åŒ–å†³ç­–è¿‡ç¨‹

**å·¥ä½œé‡**ï¼š3å¤©

---

### P2ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

#### ä»»åŠ¡P2.1ï¼šæ‰¹é‡å†³ç­–ä¼˜åŒ–

**ç›®æ ‡**ï¼šä¼˜åŒ–å¤šä¸ªç­–ç•¥å®ä¾‹çš„å†³ç­–æ€§èƒ½

**èŒƒå›´**ï¼š
- æ‰¹é‡æŸ¥è¯¢æŒ‡æ ‡å€¼
- æ‰¹é‡æŸ¥è¯¢ä¿¡å·æ„å›¾
- å¹¶è¡Œæ‰§è¡Œä¸åŒå®ä¾‹çš„å†³ç­–ï¼ˆä½†åŒä¸€å®ä¾‹ä»ä¸²è¡Œï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

#### ä»»åŠ¡P2.2ï¼šå†³ç­–ç»“æœç¼“å­˜

**ç›®æ ‡**ï¼šç¼“å­˜ç›¸åŒä¸Šä¸‹æ–‡ä¸‹çš„å†³ç­–ç»“æœ

**èŒƒå›´**ï¼š
- ç¼“å­˜DecisionResultï¼ˆå¸¦TTLï¼‰
- ä¸Šä¸‹æ–‡hashä½œä¸ºç¼“å­˜key
- é€‚ç”¨äºæŒ‡æ ‡é©±åŠ¨çš„ç­–ç•¥ï¼ˆæŒ‡æ ‡å€¼ä¸å˜æ—¶å†³ç­–ç»“æœä¸å˜ï¼‰

**å·¥ä½œé‡**ï¼š2å¤©

---

## å…«ã€äº¤ä»˜ç‰©æ¸…å•

### 8.1 ä»£ç äº¤ä»˜ç‰©

- [ ] æ‰€æœ‰P0ä»»åŠ¡çš„ä»£ç å®ç°
- [ ] å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ â‰¥ 80%ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆ6ä¸ªéªŒæ”¶ç”¨ä¾‹ï¼‰
- [ ] JavaDocæ–‡æ¡£

### 8.2 æ–‡æ¡£äº¤ä»˜ç‰©

- [ ] æ¶æ„è®¾è®¡æ–‡æ¡£
- [ ] APIæ¥å£æ–‡æ¡£
- [ ] äº‹ä»¶å¥‘çº¦æ–‡æ¡£
- [ ] éƒ¨ç½²è¿ç»´æ–‡æ¡£

### 8.3 é…ç½®äº¤ä»˜ç‰©

- [ ] Springé…ç½®ï¼ˆBeanå®šä¹‰ï¼‰
- [ ] Redisé…ç½®ï¼ˆå»é‡ç¼“å­˜ï¼‰
- [ ] Metricsé…ç½®ï¼ˆPrometheusï¼‰

---

## ä¹ã€å¼€å‘é¡ºåºå»ºè®®

### ç¬¬1å‘¨ï¼šåŸºç¡€è®¾æ–½ + äº‹ä»¶è·¯ç”±

1. ä»»åŠ¡1.1-1.2ï¼ˆå®ä½“ç±»å’ŒMapperï¼‰â†’ 1å¤©
2. ä»»åŠ¡2.1ï¼ˆäº‹ä»¶å®šä¹‰ï¼‰â†’ 1å¤©
3. ä»»åŠ¡2.2ï¼ˆStripedExecutorï¼‰â†’ 1.5å¤©
4. ä»»åŠ¡2.3ï¼ˆDecisionEventRouterï¼‰â†’ 2å¤©

### ç¬¬2å‘¨ï¼šä¸Šä¸‹æ–‡ + é—¨ç¦

5. ä»»åŠ¡3.1ï¼ˆDecisionContextï¼‰â†’ 2å¤©
6. ä»»åŠ¡3.2ï¼ˆAtomicSamplerï¼‰â†’ 3å¤©
7. ä»»åŠ¡4.1ï¼ˆGuardChainï¼‰â†’ 3å¤©

### ç¬¬3å‘¨ï¼šç­–ç•¥é€»è¾‘ + è½åº“

8. ä»»åŠ¡5.1-5.2ï¼ˆStrategyLogicæ¥å£å’ŒRegistryï¼‰â†’ 1.5å¤©
9. ä»»åŠ¡5.3ï¼ˆSignalDrivenStrategyLogicï¼‰â†’ 2å¤©
10. ä»»åŠ¡5.4ï¼ˆIndicatorDrivenStrategyLogicï¼‰â†’ 4å¤©
11. ä»»åŠ¡5.5ï¼ˆHybridStrategyLogicï¼‰â†’ 2å¤©
12. ä»»åŠ¡6.1ï¼ˆIntentRecorderï¼‰â†’ 2å¤©

### ç¬¬4å‘¨ï¼šä»·æ ¼è§¦å‘ + å¼•æ“æ•´åˆ + æµ‹è¯•

13. ä»»åŠ¡7.1ï¼ˆPriceTriggerServiceï¼‰â†’ 3å¤©
14. ä»»åŠ¡8.1ï¼ˆDecisionEngineï¼‰â†’ 2å¤©
15. ä»»åŠ¡9.1ï¼ˆDecisionMetricsï¼‰â†’ 1å¤©
16. é›†æˆæµ‹è¯•ï¼ˆ6ä¸ªéªŒæ”¶ç”¨ä¾‹ï¼‰â†’ 3å¤©
17. ä»£ç å®¡æŸ¥ä¸ä¼˜åŒ– â†’ 2å¤©

**æ€»å·¥ä½œé‡**ï¼šçº¦25-28å¤©ï¼ˆ4-5å‘¨ï¼‰

---

## åã€å…³é”®é£é™©ä¸åº”å¯¹ç­–ç•¥

### 10.1 æŠ€æœ¯é£é™©

#### é£é™©1ï¼šäº‹ä»¶ä¸¢å¤±

**é£é™©æè¿°**ï¼šäº‹ä»¶å‘å¸ƒåï¼Œå¦‚æœç³»ç»Ÿå¼‚å¸¸ï¼Œäº‹ä»¶å¯èƒ½ä¸¢å¤±ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- äº‹ä»¶å‘å¸ƒä½¿ç”¨Spring Eventsï¼ˆåŒæ­¥ï¼‰ï¼Œç¡®ä¿å‘å¸ƒæˆåŠŸ
- å…³é”®äº‹ä»¶ï¼ˆå¦‚ä»·æ ¼è§¦å‘ï¼‰å¯ä»¥è€ƒè™‘æŒä¹…åŒ–ï¼ˆP1ä¼˜åŒ–ï¼‰
- è®°å½•äº‹ä»¶å‘å¸ƒæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

#### é£é™©2ï¼šå»é‡å¤±æ•ˆ

**é£é™©æè¿°**ï¼šRedisä¸å¯ç”¨æ—¶ï¼Œå»é‡æœºåˆ¶å¤±æ•ˆï¼Œå¯èƒ½äº§ç”Ÿé‡å¤å†³ç­–ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- Redisä¸å¯ç”¨æ—¶é™çº§åˆ°å†…å­˜ç¼“å­˜ï¼ˆCaffeineï¼Œå¸¦TTLï¼‰
- æ•°æ®åº“å±‚é¢ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼ˆstrategy_id + trading_pair_id + created_at + trigger_hashï¼‰
- å®šæœŸæ£€æŸ¥é‡å¤è®°å½•ï¼ˆP1ä¼˜åŒ–ï¼‰

#### é£é™©3ï¼šå†³ç­–æ€§èƒ½é—®é¢˜

**é£é™©æè¿°**ï¼šå†³ç­–æµç¨‹è€—æ—¶è¿‡é•¿ï¼Œå½±å“å®æ—¶æ€§ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- ä½¿ç”¨StripedExecutorä¿è¯ä¸²è¡Œï¼Œé¿å…é”ç«äº‰
- æ‰¹é‡æŸ¥è¯¢æ•°æ®ï¼ˆé¿å…N+1é—®é¢˜ï¼‰
- è®°å½•å†³ç­–è€—æ—¶metricsï¼Œç›‘æ§P50/P95/P99
- å¼‚æ­¥å¤„ç†éå…³é”®è·¯å¾„ï¼ˆå¦‚metricsæ”¶é›†ï¼‰

#### é£é™©4ï¼šæ•°æ®ä¸ä¸€è‡´

**é£é™©æè¿°**ï¼šAtomicSampleré‡‡é›†çš„æ•°æ®æ—¶é—´ç‚¹ä¸ä¸€è‡´ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- æ‰€æœ‰æ•°æ®é‡‡é›†åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆï¼ˆåªè¯»äº‹åŠ¡ï¼‰
- ä½¿ç”¨æ•°æ®åº“å¿«ç…§è¯»ï¼ˆMySQLçš„REPEATABLE READï¼‰
- è®°å½•æ•°æ®é‡‡é›†æ—¶é—´æˆ³ï¼Œåœ¨reasonä¸­ä½“ç°

---

### 10.2 ä¸šåŠ¡é£é™©

#### é£é™©1ï¼šä»·æ ¼æŠ–åŠ¨å¯¼è‡´è¯¯è§¦å‘

**é£é™©æè¿°**ï¼šä»·æ ¼åœ¨é˜ˆå€¼é™„è¿‘æŠ–åŠ¨ï¼Œå¯¼è‡´é‡å¤è§¦å‘ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- ä½¿ç”¨cooldownæœºåˆ¶ï¼ˆå¦‚5ç§’å†…ä¸é‡å¤è§¦å‘ï¼‰
- ä»·æ ¼é˜ˆå€¼ä½¿ç”¨"ç©¿è¶Š"è€Œé"è¾¾åˆ°"ï¼ˆé¿å…è¾¹ç•ŒæŠ–åŠ¨ï¼‰
- è®°å½•è§¦å‘ä»·æ ¼å’Œå½“å‰ä»·æ ¼ï¼Œä¾¿äºå¤ç›˜

#### é£é™©2ï¼šä¿¡å·è¿‡æœŸå¯¼è‡´è¯¯å†³ç­–

**é£é™©æè¿°**ï¼šä½¿ç”¨è¿‡æœŸçš„ä¿¡å·è¿›è¡Œå†³ç­–ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- GuardChainä¸­çš„StalenessGateæ ¡éªŒä¿¡å·æ—¶æ•ˆ
- ä¿¡å·æ—¶æ•ˆé…ç½®åŒ–ï¼ˆå¦‚30ç§’å†…æœ‰æ•ˆï¼‰
- åœ¨reasonä¸­è®°å½•ä¿¡å·æ—¶é—´ï¼Œä¾¿äºå®¡è®¡

#### é£é™©3ï¼šæŒ‡æ ‡å€¼æœªå°±ç»ª

**é£é™©æè¿°**ï¼šæŒ‡æ ‡è®¡ç®—å»¶è¿Ÿï¼Œå†³ç­–æ—¶æŒ‡æ ‡å€¼ä¸å­˜åœ¨ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- GuardChainä¸­çš„StalenessGateæ ¡éªŒæŒ‡æ ‡æ˜¯å¦å°±ç»ª
- æŒ‡æ ‡æœªå°±ç»ªæ—¶è¿”å›HOLDï¼Œä¸è½åº“
- è®°å½•WARNæ—¥å¿—ï¼Œä½†ä¸æŠ›å¼‚å¸¸

---

### 10.3 è¿ç»´é£é™©

#### é£é™©1ï¼šå†³ç­–è¡¨æ•°æ®é‡è¿‡å¤§

**é£é™©æè¿°**ï¼šé•¿æœŸè¿è¡Œåï¼Œ`strategy_intent_record` è¡¨æ•°æ®é‡è¿‡å¤§ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- å®šæœŸå½’æ¡£å†å²æ•°æ®ï¼ˆP1ä¼˜åŒ–ï¼‰
- ä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼ŒP1ä¼˜åŒ–ï¼‰
- åªä¿ç•™æœ€è¿‘Nå¤©çš„æ•°æ®ç”¨äºå›æ”¾

#### é£é™©2ï¼šRediså†…å­˜å ç”¨è¿‡å¤§

**é£é™©æè¿°**ï¼šå»é‡ç¼“å­˜å ç”¨è¿‡å¤šRediså†…å­˜ã€‚

**åº”å¯¹ç­–ç•¥**ï¼š
- åˆç†è®¾ç½®TTLï¼ˆSIGNAL/INDICATOR: 1å°æ—¶ï¼ŒBAR: 24å°æ—¶ï¼ŒPRICE: cooldown+1ç§’ï¼‰
- å®šæœŸæ¸…ç†è¿‡æœŸkeyï¼ˆRedisè‡ªåŠ¨è¿‡æœŸï¼‰
- ç›‘æ§Rediså†…å­˜ä½¿ç”¨

---

## åä¸€ã€ä¾èµ–å…³ç³»å›¾

### 11.1 æ¨¡å—ä¾èµ–

```
DecisionEventRouter
    â†“
StripedExecutor
    â†“
DecisionEngine
    â†“
AtomicSampler â†’ GuardChain â†’ StrategyLogicRegistry
    â†“                              â†“
IntentRecorder â† â† â† â† â† â† â† â† â† â† â†
```

### 11.2 å¤–éƒ¨ä¾èµ–

```
é˜¶æ®µ2æ¨¡å—
    â†“
â”œâ”€â”€ é˜¶æ®µ1æ¨¡å—ï¼ˆStrategyRuntimeRegistry, StrategyInstanceï¼‰
â”œâ”€â”€ ä¿¡å·æ¨¡å—ï¼ˆsignal_intentè¡¨ï¼‰
â”œâ”€â”€ æŒ‡æ ‡æ¨¡å—ï¼ˆindicator_valueè¡¨, IndicatorComputedEventï¼‰
â”œâ”€â”€ è¡Œæƒ…æ¨¡å—ï¼ˆä»·æ ¼å¿«ç…§, BarClosedEventï¼‰
â””â”€â”€ åŸºç¡€è®¾æ–½ï¼ˆRedis, MySQL, Spring Eventsï¼‰
```

---

## åäºŒã€éªŒæ”¶æ ‡å‡†æ€»ç»“

### 12.1 åŠŸèƒ½éªŒæ”¶

- [ ] âœ… å››ç±»è§¦å‘æºéƒ½èƒ½æ­£ç¡®è§¦å‘å†³ç­–
- [ ] âœ… åªæœ‰åŠ¨ä½œæ„å›¾æ‰è½åº“ï¼ˆHOLDä¸è½åº“ï¼‰
- [ ] âœ… å†³ç­–reasonåŒ…å«å®Œæ•´çš„ç»“æ„åŒ–JSON
- [ ] âœ… å¹‚ç­‰æ€§æˆç«‹ï¼ˆåŒä¸€è§¦å‘ä¸é‡å¤ï¼‰
- [ ] âœ… ä»·æ ¼é˜ˆå€¼ç©¿è¶Šèƒ½è§¦å‘ï¼ˆå¸¦cooldownï¼‰
- [ ] âœ… ç©ºä»“/æŒä»“åˆ†æµæ­£ç¡®

### 12.2 æ€§èƒ½éªŒæ”¶

- [ ] âœ… å•ä¸ªå†³ç­–è€—æ—¶ < 100msï¼ˆP95ï¼‰
- [ ] âœ… å¹¶å‘å†³ç­–ä¸äº’ç›¸å½±å“
- [ ] âœ… äº‹ä»¶å¤„ç†ä¸é˜»å¡ä¸»æµç¨‹

### 12.3 è´¨é‡éªŒæ”¶

- [ ] âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] âœ… é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] âœ… ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] âœ… æ— ä¸¥é‡ä»£ç å¼‚å‘³

### 12.4 æ–‡æ¡£éªŒæ”¶

- [ ] âœ… æ¶æ„è®¾è®¡æ–‡æ¡£å®Œæ•´
- [ ] âœ… APIæ¥å£æ–‡æ¡£å®Œæ•´
- [ ] âœ… äº‹ä»¶å¥‘çº¦æ–‡æ¡£å®Œæ•´
- [ ] âœ… éƒ¨ç½²è¿ç»´æ–‡æ¡£å®Œæ•´

---

## åä¸‰ã€å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆä»·æ ¼è§¦å‘éœ€è¦cooldownï¼Ÿ

**A**: å› ä¸ºä»·æ ¼åœ¨é˜ˆå€¼é™„è¿‘å¯èƒ½æŠ–åŠ¨ï¼Œå¦‚æœä¸åŠ cooldownï¼Œä¼šåœ¨çŸ­æ—¶é—´å†…äº§ç”Ÿå¤§é‡å†³ç­–è®°å½•ï¼Œå¯¼è‡´ï¼š
- æ•°æ®åº“å†™å…¥å‹åŠ›å¤§
- å†³ç­–è¡¨æ•°æ®é‡çˆ†ç‚¸
- ä¸‹æ¸¸æ‰§è¡Œæ¨¡å—å¤„ç†ä¸è¿‡æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨cooldownçª—å£ï¼ˆå¦‚5ç§’ï¼‰ï¼ŒåŒä¸€çª—å£å†…åªè§¦å‘ä¸€æ¬¡ã€‚

---

### Q2: ä¸ºä»€ä¹ˆåŒä¸€StrategyInstanceå¿…é¡»ä¸²è¡Œæ‰§è¡Œï¼Ÿ

**A**: å› ä¸ºï¼š
- å†³ç­–ä¾èµ– `strategy_logic_state`ï¼Œå¦‚æœå¹¶å‘æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€è¯»å–ä¸ä¸€è‡´
- å»é‡æœºåˆ¶éœ€è¦ä¿è¯åŒä¸€è§¦å‘åªå¤„ç†ä¸€æ¬¡
- é¿å…ç«æ€æ¡ä»¶å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨StripedExecutorï¼ŒæŒ‰ `strategyId + tradingPairId` åšhashåˆ†ç‰‡ã€‚

---

### Q3: å¦‚æœRedisä¸å¯ç”¨ï¼Œå»é‡è¿˜èƒ½å·¥ä½œå—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†éœ€è¦é™çº§ï¼š
- ä¼˜å…ˆä½¿ç”¨Redisï¼ˆåˆ†å¸ƒå¼ï¼Œå¤šå®ä¾‹å…±äº«ï¼‰
- Redisä¸å¯ç”¨æ—¶é™çº§åˆ°å†…å­˜ç¼“å­˜ï¼ˆCaffeineï¼Œå•å®ä¾‹æœ‰æ•ˆï¼‰
- æ•°æ®åº“å±‚é¢ä½¿ç”¨å”¯ä¸€ç´¢å¼•ä½œä¸ºæœ€åé˜²çº¿

---

### Q4: decision_reason JSONå¤ªå¤§æ€ä¹ˆåŠï¼Ÿ

**A**: 
- å½“å‰è®¾è®¡ï¼šVARCHAR(255)ï¼Œå¯èƒ½ä¸å¤Ÿ
- å»ºè®®ï¼šæ”¹ä¸ºTEXTç±»å‹ï¼ˆP1ä¼˜åŒ–ï¼‰
- æˆ–è€…ï¼šåªä¿ç•™å…³é”®ä¿¡æ¯ï¼Œè¯¦ç»†ä¿¡æ¯å­˜åˆ°æ‰©å±•è¡¨ï¼ˆP2ä¼˜åŒ–ï¼‰

---

### Q5: å¦‚ä½•éªŒè¯é˜¶æ®µ2æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ

**A**: æœ€ç®€å•çš„æ–¹æ³•ï¼š
1. æŸ¥çœ‹ `strategy_intent_record` è¡¨æ˜¯å¦æœ‰æ–°è®°å½•
2. æŸ¥çœ‹ `decision_reason` JSONæ˜¯å¦å®Œæ•´
3. æŸ¥çœ‹metricsï¼ˆå†³ç­–æ€»æ•°ã€è€—æ—¶ç­‰ï¼‰
4. æŸ¥çœ‹æ—¥å¿—ï¼ˆå†³ç­–æµç¨‹æ—¥å¿—ï¼‰

---

## åå››ã€é™„å½•

### 14.1 ç´¢å¼•å»ºè®®ï¼ˆå¯é€‰å¢å¼ºï¼‰

è™½ç„¶é»˜è®¤å®ç°ä¸ä¾èµ–æ–°å¢ç´¢å¼•ï¼Œä½†ä»¥ä¸‹ç´¢å¼•å¯ä»¥æå‡æ€§èƒ½ï¼š

```sql
-- å†³ç­–è®°å½•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_intent_strategy_pair_time 
ON strategy_intent_record(strategy_id, trading_pair_id, created_at DESC);

-- ä¿¡å·æ„å›¾æŸ¥è¯¢ç´¢å¼•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE INDEX idx_signal_intent_strategy_pair_status 
ON signal_intent(strategy_id, trading_pair_id, intent_status, received_at DESC);

-- æŒ‡æ ‡å€¼æŸ¥è¯¢ç´¢å¼•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE INDEX idx_indicator_value_pair_time 
ON indicator_value(trading_pair_id, bar_time DESC);
```

---

### 14.2 é…ç½®ç¤ºä¾‹

#### application.yml

```yaml
strategy:
  decision:
    # StripedExecutoré…ç½®
    executor:
      core-pool-size: 4
      max-pool-size: 8
      queue-capacity: 1000
    
    # å»é‡ç¼“å­˜é…ç½®
    dedup:
      redis-enabled: true
      ttl:
        signal: 3600  # 1å°æ—¶
        indicator: 3600  # 1å°æ—¶
        bar: 86400  # 24å°æ—¶
        price: 6  # cooldown + 1ç§’
    
    # ä»·æ ¼è§¦å‘é…ç½®
    price-trigger:
      cooldown-seconds: 5
      threshold-check-interval-ms: 100
```

---

### 14.3 MetricsæŒ‡æ ‡æ¸…å•

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| `strategy.decision.total` | Counter | å†³ç­–æ€»æ•°ï¼ˆæŒ‰è§¦å‘æºåˆ†ç±»ï¼‰ |
| `strategy.decision.duration` | Timer | å†³ç­–è€—æ—¶ï¼ˆP50/P95/P99ï¼‰ |
| `strategy.decision.guard.rejected` | Counter | é—¨ç¦æ‹¦æˆªæ¬¡æ•°ï¼ˆæŒ‰é—¨ç¦ç±»å‹åˆ†ç±»ï¼‰ |
| `strategy.decision.hold.count` | Counter | HOLDæ¬¡æ•° |
| `strategy.decision.recorded` | Counter | è½åº“æˆåŠŸæ¬¡æ•°ï¼ˆæŒ‰actionåˆ†ç±»ï¼‰ |
| `strategy.decision.record.failed` | Counter | è½åº“å¤±è´¥æ¬¡æ•° |

---

### 14.4 æ—¥å¿—è§„èŒƒ

#### å†³ç­–æµç¨‹æ—¥å¿—

```java
// äº‹ä»¶æ¥æ”¶
log.info("å†³ç­–äº‹ä»¶æ¥æ”¶: triggerType={}, strategyId={}, tradingPairId={}", 
    triggerType, strategyId, tradingPairId);

// é—¨ç¦æ‹¦æˆª
log.debug("å†³ç­–è¢«é—¨ç¦æ‹¦æˆª: strategyId={}, tradingPairId={}, gate={}, reason={}", 
    strategyId, tradingPairId, gate, reason);

// å†³ç­–å®Œæˆ
log.info("å†³ç­–å®Œæˆ: strategyId={}, tradingPairId={}, action={}, qty={}", 
    strategyId, tradingPairId, action, qty);

// è½åº“æˆåŠŸ
log.info("å†³ç­–è®°å½•å·²è½åº“: strategyId={}, tradingPairId={}, recordId={}", 
    strategyId, tradingPairId, recordId);

// è½åº“å¤±è´¥
log.error("å†³ç­–è®°å½•è½åº“å¤±è´¥: strategyId={}, tradingPairId={}", 
    strategyId, tradingPairId, e);
```

---

## åäº”ã€æ€»ç»“

### 15.1 æ ¸å¿ƒä»·å€¼

é˜¶æ®µ2ï¼ˆDecision Engineï¼‰çš„æ ¸å¿ƒä»·å€¼ï¼š

1. **å¯å›æ”¾**ï¼šæ¯æ¬¡å†³ç­–éƒ½æœ‰å®Œæ•´çš„reason JSONï¼Œå¯ä»¥å¤ç›˜
2. **å¯å®¡è®¡**ï¼šæ‰€æœ‰å†³ç­–éƒ½è®°å½•åœ¨æ¡ˆï¼Œä¾¿äºå®¡è®¡
3. **å¯æ‰©å±•**ï¼šæ’ä»¶åŒ–è®¾è®¡ï¼Œæ”¯æŒæ–°å¢ç­–ç•¥ç±»å‹å’ŒæŒ‡æ ‡
4. **å¯ç»´æŠ¤**ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼ŒèŒè´£å•ä¸€

### 15.2 å…³é”®çº¦æŸ

å¿…é¡»ä¸¥æ ¼éµå®ˆçš„çº¦æŸï¼š

1. âœ… åªå†™ `strategy_intent_record`ï¼ˆINSERT onlyï¼‰
2. âœ… åªè½åº“åŠ¨ä½œæ„å›¾ï¼ˆHOLDä¸è½åº“ï¼‰
3. âœ… ä¸ä¿®æ”¹ `strategy_logic_state`
4. âœ… äº‹ä»¶é©±åŠ¨ï¼ˆç¦æ­¢å®šæ—¶æ‰«æï¼‰
5. âœ… ä»·æ ¼ç¨€ç–åŒ–ï¼ˆcooldownæœºåˆ¶ï¼‰
6. âœ… ä¸²è¡Œæ‰§è¡Œï¼ˆStripedExecutorï¼‰
7. âœ… å¹‚ç­‰å»é‡ï¼ˆdedupKey + ç¼“å­˜ï¼‰

### 15.3 å®Œæˆæ ‡å¿—

é˜¶æ®µ2å®Œæˆçš„æ ‡å¿—ï¼š

> **ç­–ç•¥å·²"è®¤çŸ¥"ï¼Œä½†è¿˜æ²¡"è¡ŒåŠ¨"**

å…·ä½“è¡¨ç°ï¼š
- âœ… å››ç±»è§¦å‘æºéƒ½èƒ½è§¦å‘å†³ç­–
- âœ… å†³ç­–è®°å½•èƒ½æ­£ç¡®è½åº“
- âœ… å†³ç­–reasonåŒ…å«å®Œæ•´ä¿¡æ¯
- âœ… å¹‚ç­‰æ€§æˆç«‹
- âœ… æ‰€æœ‰éªŒæ”¶ç”¨ä¾‹é€šè¿‡

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024  
**ç»´æŠ¤è€…**ï¼šV2-Trade æ¶æ„å›¢é˜Ÿ

---

> ğŸ’¡ **æç¤º**ï¼šæœ¬æ–‡æ¡£æ˜¯é˜¶æ®µ2çš„å®Œæ•´ç ”å‘æŒ‡å—ï¼Œå¼€å‘è¿‡ç¨‹ä¸­å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒï¼š
> - `ç­–ç•¥é˜¶æ®µ2ï¼ˆDecision Engineï¼‰è§„åˆ’ v3.1.md` - ä¸šåŠ¡è§„åˆ’
> - `ç­–ç•¥é˜¶æ®µ1å¼€å‘è§„èŒƒä¸ä»»åŠ¡.md` - é˜¶æ®µ1å®ç°å‚è€ƒ
> - ç°æœ‰ä»£ç åº“ - äº†è§£é¡¹ç›®æ¶æ„å’Œç¼–ç è§„èŒƒ