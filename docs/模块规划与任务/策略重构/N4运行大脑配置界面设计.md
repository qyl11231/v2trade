# N4 运行大脑规则配置界面设计（落地版）

面向 N4 阶段的策略实例运行大脑配置 UI，参考原型 `runtim_n4_engineering_with_exit.html` 与 JSON 规范示例（`策略运行大脑json.md`）。目标：让量化/运营可视化配置 Entry/Exit 多因子规则，导出可直接写入 `strategy_instance.runtimeRules` 的 JSON。

## 1. 背景与目标
- 支持三类大脑：趋势(1) / 马丁(2) / 网格(3)。
- 支持 Entry/Exit 双规则集；entryType/exitType = `all` 或 `weight`。
- 因子来源于指标库（含 price/signal 视作内置指标）；可配置参数、权重、启用状态。
- 导出 JSON 符合规范，可直接落库；校验与提示清晰。

## 2. 主要界面信息架构（对应原型）
- 左侧卡片
  - rulesType 下拉
  - Entry/Exit 类型选择（all/weight），阈值输入（仅 weight 可编辑）
  - Entry 因子列表、Exit 因子列表（可选中、高亮、删除）
  - “添加因子/退出因子”按钮，打开指标选择弹窗
- 右侧卡片
  - 因子编辑器：名称、indicatorCode、dataSource（只读）、enabled、params 动态表单、scope(longWeight/shortWeight)
  - 导出/复制/重置按钮
  - JSON 预览
- 指标弹窗
  - 搜索输入 + 列表（code/name/source/params），点击“选择”写回并新建因子

## 3. 前端状态结构 → 导出 JSON 映射
- state 根
  - rulesType: "1" | "2" | "3"
  - entryRules: { entryType, threshold?, factorList[] }
  - exitRules: { exitType, threshold?, factorList[] }
  - _ui: { selectedRuleSet: "entry"|"exit", selectedFactorId }
- factor
  - factorId, enabled, name
  - indicator { code, dataSource, params }
  - scope { longWeight, shortWeight }（weight 模式使用；all 模式保留但不参与判定）
- 导出 runtimeRules
  - rulesType: Number(state.rulesType)
  - entryRules/exitRules: entryType/exitType，threshold（仅 weight），factorList 映射
  - version/notes/brainParams：从页面额外输入或默认值（可后续扩展）

## 4. 指标模块对接
- 指标库来源：后端接口 / 配置中心（无则回退本地 INDICATOR_LIBRARY 示例）
- 指标定义：{ code, name, dataSource, params[{k,t,options?,d}] }
- 表单生成：根据 params 渲染 select/number 等；变更写回 factor.params
- dataSource 由指标定义带出；切换指标时重置 params 默认值与 dataSource
- 将 price/signal 以指标形式下发（如 price_breakout, signal_confirm）

## 5. 交互流程要点
- 选中因子：列表高亮，右侧编辑器渲染该因子
- Entry/Exit 编辑切换：更新 _ui 标记并刷新列表高亮
- 添加因子：打开指标弹窗 → 选择 → 生成 factor（默认 scope long=20/short=-20）并选中
- 删除因子：从对应列表移除，若当前选中则清空选中
- JSON 预览：任意改动即同步；权重模式显示“理论最大/最小得分”提示
- 重置：恢复默认 state（rulesType=1，entry/exit weight，阈值 30/-30 等）

## 6. 校验与提示
- Entry 至少 1 个因子，否则禁止导出/复制
- Exit 可为空但提示风险
- weight 模式建议 longEnterScore > 0，shortEnterScore < 0（提示但不强制）
- all 模式隐藏阈值输入；导出时不含 threshold 字段

## 7. all vs weight 模式处理
- all：所有 enabled 因子 condition 必须满足；threshold 不下发
- weight：累计 longWeight/shortWeight 与阈值比较；显示“启用因子数/理论得分”提示

## 8. 示例引用
- 直接引用 `策略运行大脑json.md` 中三份示例（趋势/网格/马丁），作为“导出样例/默认模板”。
- 若需要条件 DSL，可沿用示例中的结构化 condition 形式；当前 UI 可先聚焦权重模式，后续补充 condition 编辑器。

## 9. 开发最小落地清单
- 前端
  - 状态模型与映射（见第 3 节）
  - 指标弹窗 + 搜索 + 选择
  - 因子列表/编辑器/阈值/提示/JSON 预览/导出复制
  - all/weight 动态显隐阈值
  - 重置与校验
- 后端/配置
  - 指标库接口（含 price/signal 内置指标）
  - runtimeRules 存取（strategy_instance.runtimeRules）
  - 可选：condition DSL 校验（如采用 all+condition）

## 10. 风险与扩展
- condition 编辑器尚未实现时，all 模式需约定默认 condition；建议后续补上结构化 DSL 表单
- 指标库需与行情/状态源匹配（dataSource 路由）；缺失指标需同步补实现
- version/notes/brainParams 在 UI 中预留输入，便于兼容灰度

## 11. 后续行动
- 确认是否先上线 weight 模式（与现有原型一致），all+condition 在下一步补齐
- 接口对接：获取指标库、提交/回填 runtimeRules
- 将本设计文档随迭代进入 Jira 子任务，驱动 UI 与后端同步开发

