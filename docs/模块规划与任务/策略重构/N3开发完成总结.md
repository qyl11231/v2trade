# N3 é˜¶æ®µå¼€å‘å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„ä»»åŠ¡

### Task 1ï¼šçŠ¶æ€å®ä½“ä¸ Mapper âœ…
- âœ… `StrategyLogicState` å®ä½“ç±»
- âœ… `StrategyLogicStateMapper` æ¥å£
- âœ… MyBatis XML æ˜ å°„æ–‡ä»¶ï¼ˆåŒ…å« UPSERT æ–¹æ³•ï¼‰

### Task 2ï¼šçŠ¶æ€é˜¶æ®µä¸çŠ¶æ€æ¨¡å‹ âœ…
- âœ… `StrategyPhase` æšä¸¾ï¼ˆIDLE/OPEN_PENDING/OPENED ç­‰ï¼‰
- âœ… `StrategyState` å†…å­˜æ¨¡å‹ï¼ˆå«å˜åŒ–æ£€æµ‹é€»è¾‘ï¼‰

### Task 3ï¼šå¿«ç…§æ¨¡å‹ âœ…
- âœ… `LatestPriceSnapshot`ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
- âœ… `LatestBarSnapshot`ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
- âœ… `LatestSignalSnapshot`ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰

### Task 4ï¼šä¸²è¡Œæ‰§è¡Œå™¨ âœ…
- âœ… `StripedSerialExecutor`ï¼ˆæŒ‰ instanceId å“ˆå¸Œåˆ†ç‰‡ï¼Œä¿è¯ä¸²è¡Œï¼‰

### Task 5ï¼šçŠ¶æ€æŒä¹…åŒ–ä»“åº“ âœ…
- âœ… `StrategyStateRepository`ï¼ˆloadOrInit + persistIfChangedï¼‰

### Task 6ï¼šçŠ¶æ€æœº âœ…
- âœ… `StrategyStateMachine`ï¼ˆN3 æœ€å°å®ç°ï¼Œä¸æ¨è¿› phaseï¼‰

### Task 7ï¼šç­–ç•¥è¿è¡Œæ—¶ âœ…
- âœ… `StrategyRuntime`ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼Œä¸²è¡Œå¤„ç†äº‹ä»¶ï¼‰

### Task 8ï¼šRuntime ç®¡ç†å™¨ âœ…
- âœ… `StrategyRuntimeManager`ï¼ˆå¯åŠ¨è£…è½½ã€ç®¡ç† runtimeï¼‰

### Task 9ï¼šè¿æ¥ N2 ä¸ N3 âœ…
- âœ… ä¿®æ”¹ `TriggerDispatcher`ï¼ˆåˆ†å‘åˆ° RuntimeManagerï¼‰

### Task 10ï¼šæŸ¥è¯¢ API âœ…
- âœ… `StrategyRuntimeController`ï¼ˆè¿è¡Œæ€æŸ¥è¯¢æ¥å£ï¼‰

---

## ğŸ“ å·²åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

### å®ä½“ä¸ Mapper
- `src/main/java/com/qyl/v2trade/business/strategy/model/entity/StrategyLogicState.java`
- `src/main/java/com/qyl/v2trade/business/strategy/mapper/StrategyLogicStateMapper.java`
- `src/main/resources/mapper/StrategyLogicStateMapper.xml`

### çŠ¶æ€æ¨¡å‹
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/state/StrategyPhase.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/state/StrategyState.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/state/StrategyStateMachine.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/state/StrategyStateRepository.java`

### å¿«ç…§æ¨¡å‹
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/snapshot/LatestPriceSnapshot.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/snapshot/LatestBarSnapshot.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/snapshot/LatestSignalSnapshot.java`

### è¿è¡Œæ—¶æ ¸å¿ƒ
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/dispatch/StripedSerialExecutor.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/runtime/StrategyRuntime.java`
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/manager/StrategyRuntimeManager.java`

### API
- `src/main/java/com/qyl/v2trade/business/strategy/runtime/api/StrategyRuntimeController.java`

### æ•°æ®åº“è„šæœ¬
- `src/main/resources/sql/strategy_n3_index.sql`

---

## ğŸ”§ éœ€è¦æ‰§è¡Œçš„æ•°æ®åº“æ“ä½œ

### 1. æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆå¿…é¡»ï¼‰

æ‰§è¡Œ SQL è„šæœ¬ï¼š`src/main/resources/sql/strategy_n3_index.sql`

```sql
-- æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆç¡®ä¿ä¸€ä¸ª instance åªèƒ½æœ‰ä¸€æ¡å½“å‰å¿«ç…§ï¼‰
ALTER TABLE strategy_logic_state 
ADD UNIQUE KEY uk_instance (strategy_instance_id);

-- æ·»åŠ ç´¢å¼•ï¼ˆç”¨äºæŸ¥è¯¢ä¼˜åŒ–ï¼‰
CREATE INDEX idx_strategy_logic_state_user_id ON strategy_logic_state(user_id);
CREATE INDEX idx_strategy_logic_state_strategy_id ON strategy_logic_state(strategy_id);
CREATE INDEX idx_strategy_logic_state_trading_pair_id ON strategy_logic_state(trading_pair_id);
CREATE INDEX idx_strategy_logic_state_phase ON strategy_logic_state(state_phase);
```

**æ³¨æ„**ï¼šå¦‚æœè¡¨å·²æœ‰æ•°æ®ï¼Œéœ€è¦å…ˆæ¸…ç†é‡å¤æ•°æ®ï¼ˆç¡®ä¿æ¯ä¸ª `strategy_instance_id` åªæœ‰ä¸€æ¡è®°å½•ï¼‰

---

## ğŸš€ å¯åŠ¨éªŒè¯

### 1. å¯åŠ¨æœåŠ¡

å¯åŠ¨ååº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
INFO  StrategyRuntimeManager - å¼€å§‹åˆå§‹åŒ– StrategyRuntimeManager...
INFO  StrategyRuntimeManager - å‘ç° X ä¸ªå¯ç”¨çš„ç­–ç•¥å®ä¾‹
INFO  StrategyRuntimeManager - Runtime å·²åˆ›å»º: instanceId=XX, phase=IDLE
INFO  StrategyRuntimeManager - StrategyRuntimeManager åˆå§‹åŒ–å®Œæˆ: runtimeCount=X/X
INFO  StripedSerialExecutor - StripedSerialExecutor åˆå§‹åŒ–å®Œæˆ: stripeCount=X
```

### 2. éªŒè¯ API

```bash
# æŸ¥è¯¢æ‰€æœ‰å®ä¾‹çš„è¿è¡Œæ€
curl http://localhost:8080/api/strategy/runtime/state/list

# æŸ¥è¯¢å•ä¸ªå®ä¾‹çš„è¿è¡Œæ€è¯¦æƒ…
curl http://localhost:8080/api/strategy/runtime/state/1
```

### 3. éªŒè¯äº‹ä»¶å¤„ç†

å‘é€æµ‹è¯•äº‹ä»¶ï¼ˆä½¿ç”¨ N2 çš„æµ‹è¯•æ¥å£ï¼‰ï¼š

```bash
# æµ‹è¯• K çº¿é—­åˆäº‹ä»¶
curl -X POST "http://localhost:8080/api/strategy/trigger/test/bar-close?tradingPairId=1&timeframe=5m"

# æµ‹è¯•ä¿¡å·äº‹ä»¶
curl -X POST "http://localhost:8080/api/strategy/trigger/test/signal?signalConfigId=1&signalId=test-001"
```

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹ runtime äº‹ä»¶æ—¥å¿—
grep "STRATEGY_RUNTIME" logs/application.log | grep "runtime_event"
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š

```
STRATEGY_RUNTIME runtime_event {"instanceId":1,"userId":1,"phase":"IDLE","stripe":0,"seq":1,"type":"BAR_CLOSE",...}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“å”¯ä¸€çº¦æŸ

**å¿…é¡»æ‰§è¡Œ** `strategy_n3_index.sql` è„šæœ¬ï¼Œå¦åˆ™ UPSERT å¯èƒ½å¤±è´¥ã€‚

### 2. æ—¥å¿—é…ç½®

ç¡®ä¿ `log4j2.xml` ä¸­é…ç½®äº† `STRATEGY_RUNTIME` loggerï¼š

```xml
<Logger name="STRATEGY_RUNTIME" level="INFO" additivity="false">
    <AppenderRef ref="Console"/>
    <AppenderRef ref="File"/>
</Logger>
```

### 3. N3 é˜¶æ®µ 6 æ¡çº¢çº¿ï¼ˆå¿…é¡»éµå®ˆï¼‰

1. âœ… Runtime ä¸å¾—ç”¨å…¬å…±çº¿ç¨‹æ± ï¼ˆå·²é€šè¿‡ StripedSerialExecutor ä¿è¯ï¼‰
2. âœ… ä¸å¾—åœ¨ Runtime æŸ¥ DBï¼ˆæ‰€æœ‰æ•°æ®å¯åŠ¨æ—¶æ³¨å…¥ï¼‰
3. âœ… ä¸å¾—é«˜é¢‘ update stateï¼ˆå·²å®ç°å˜åŒ–æ£€æµ‹ï¼‰
4. âœ… ä¸å¾—æ“…è‡ªæ¨è¿› phaseï¼ˆN3 åªæ›´æ–° lastEventTimeï¼‰
5. âœ… ä¸å¾—å†™ pnlï¼ˆN3 é˜¶æ®µç»Ÿä¸€å†™ NULLï¼‰
6. âœ… ä¸å¾—ç ´å instance ä¸²è¡Œï¼ˆå·²é€šè¿‡ StripedSerialExecutor ä¿è¯ï¼‰

### 4. BAR_CLOSE äº‹ä»¶ K çº¿æ•°æ®

**å½“å‰å®ç°**ï¼š`StrategyTrigger` ä¸­æš‚æœªåŒ…å« K çº¿çš„ OHLC æ•°æ®ï¼Œ`LatestBarSnapshot` çš„ OHLC å­—æ®µä¸º nullã€‚

**åç»­æ‰©å±•**ï¼ˆå¯é€‰ï¼‰ï¼š
- æ–¹æ¡ˆ Aï¼šæ‰©å±• `StrategyTrigger`ï¼Œæ·»åŠ  `barOpen/barHigh/barLow/barClose/barVolume` å­—æ®µ
- æ–¹æ¡ˆ Bï¼šåœ¨ `BarClosedIngressAdapter` ä¸­ä¼ é€’å®Œæ•´çš„ `AggregatedKLine` å¯¹è±¡
- æ–¹æ¡ˆ Cï¼šä»å…¶ä»–æ•°æ®æºï¼ˆå¦‚ç¼“å­˜ï¼‰è·å– K çº¿æ•°æ®

**N3 é˜¶æ®µ**ï¼šå…ˆä¿è¯åŠŸèƒ½è·‘é€šï¼ŒOHLC æ•°æ®å¯ä»¥åç»­è¡¥å……ã€‚

---

## ğŸ“Š éªŒæ”¶æ£€æŸ¥æ¸…å•

### å¯åŠ¨è£…è½½éªŒæ”¶
- [ ] æœåŠ¡å¯åŠ¨æ—¶ï¼Œæ‰€æœ‰ enabled å®ä¾‹éƒ½åˆ›å»ºäº† runtime
- [ ] æœ‰ state è®°å½•çš„å®ä¾‹æ­£ç¡®æ¢å¤çŠ¶æ€
- [ ] æ²¡æœ‰ state è®°å½•çš„å®ä¾‹è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆIDLE/FLAT/0ï¼‰
- [ ] API `/api/strategy/runtime/state/list` è¿”å›æ­£ç¡®æ•°æ®

### äº‹ä»¶å¤„ç†éªŒæ”¶
- [ ] BAR_CLOSE äº‹ä»¶èƒ½æ­£ç¡®è·¯ç”±åˆ° runtime
- [ ] PRICE äº‹ä»¶èƒ½æ­£ç¡®è·¯ç”±åˆ° runtime
- [ ] SIGNAL äº‹ä»¶èƒ½æ­£ç¡®è·¯ç”±åˆ° runtime
- [ ] æ—¥å¿—ä¸­èƒ½çœ‹åˆ° `runtime_event` è¾“å‡º

### ä¸²è¡Œæ€§éªŒæ”¶
- [ ] åŒä¸€ instance çš„äº‹ä»¶å¤„ç†åºå·ï¼ˆseqï¼‰ä¸¥æ ¼é€’å¢
- [ ] æ‰€æœ‰äº‹ä»¶éƒ½åœ¨åŒä¸€ä¸ª stripe ä¸­å¤„ç†
- [ ] æ— äº‹ä»¶äº¤é”™ï¼ˆå¯é€šè¿‡æ—¥å¿—éªŒè¯ï¼‰

### çŠ¶æ€æŒä¹…åŒ–éªŒæ”¶
- [ ] é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºåˆå§‹çŠ¶æ€ï¼ˆIDLE/FLAT/0ï¼‰
- [ ] çŠ¶æ€å˜åŒ–æ—¶æ‰å†™åº“ï¼ˆå˜åŒ–æ£€æµ‹ç”Ÿæ•ˆï¼‰
- [ ] PRICE é«˜é¢‘ä¸‹ä¸ä¼šé¢‘ç¹å†™åº“

### é‡å¯æ¢å¤éªŒæ”¶
- [ ] é‡å¯å runtime çŠ¶æ€ä¸ DB ä¸€è‡´
- [ ] é‡å¯åèƒ½ç»§ç»­æ¥æ”¶æ–°äº‹ä»¶

---

## ğŸ”„ ä¸ N2 çš„é›†æˆ

### äº‹ä»¶æµç¨‹

```
N2: Ingress -> Dedup -> Router -> TriggerDispatcher
                                    â†“
N3: RuntimeManager.dispatch() -> StrategyRuntime.onTrigger()
                                    â†“
    StripedSerialExecutor.execute() -> StrategyRuntime.handle()
                                    â†“
    æ›´æ–°å¿«ç…§ + çŠ¶æ€æœº + æŒä¹…åŒ– + æ‰“å°æ—¥å¿—
```

### å…¼å®¹æ€§

- âœ… N2 çš„ `TriggerLogger` ä»ç„¶å¯ç”¨ï¼ˆN3 é˜¶æ®µå¯é€‰ï¼‰
- âœ… N3 çš„ `RuntimeManager` å¦‚æœä¸å­˜åœ¨ï¼ŒN2 ä¼šé™çº§åˆ°åªæ‰“å°æ—¥å¿—
- âœ… ä¸¤ä¸ªé˜¶æ®µå¯ä»¥å¹³æ»‘è¿‡æ¸¡

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **K çº¿æ•°æ®ä¼ é€’**ï¼šæ‰©å±• `StrategyTrigger` ä»¥åŒ…å«å®Œæ•´çš„ K çº¿ OHLC æ•°æ®
2. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ  Micrometer Metricsï¼ˆé˜Ÿåˆ—é•¿åº¦ã€å¤„ç†å»¶è¿Ÿç­‰ï¼‰
3. **åŠ¨æ€ç®¡ç†**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ /ç§»é™¤ runtimeï¼ˆå®ä¾‹å¯ç”¨/ç¦ç”¨æ—¶ï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…å‹æµ‹ç»“æœè°ƒæ•´ stripe æ•°é‡å’Œé˜Ÿåˆ—å¤§å°

---

## ğŸ¯ æ€»ç»“

N3 é˜¶æ®µæ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å®ç°ï¼š

- âœ… **æ´»ç€**ï¼šæ¯ä¸ª enabled å®ä¾‹éƒ½æœ‰ runtime
- âœ… **è®°å¿†**ï¼šçŠ¶æ€å¯æŒä¹…åŒ–ã€å¯æ¢å¤
- âœ… **æœ‰åº**ï¼šåŒä¸€ instance ä¸¥æ ¼ä¸²è¡Œ

**N3 ä¸åšå†³ç­–ã€ä¸å†™ intentã€ä¸æ¥çœŸå®ä¸‹å•**ã€‚æ‰€æœ‰ä»£ç éƒ½ä¸¥æ ¼éµå®ˆ 6 æ¡çº¢çº¿ï¼Œä¸ºåç»­ N4/N5/N6/N7 é˜¶æ®µæ‰“ä¸‹åšå®åŸºç¡€ã€‚

---

**å¼€å‘å®Œæˆæ—¶é—´**ï¼š2024-01-XX  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

