下面这份是**可直接存档的产品规范文档**，语义、边界、验收都已经“封死”，不会给后端或策略留下歧义。
我按**你当前系统成熟度**来写，不引入不必要的未来复杂度。

---

# 📘 实时价格订阅模块产品规范

**（Price Subscription Specification v1.0）**

---

## 1. 产品背景（Background）

当前系统已具备：

* 稳定的 **K 线体系（1m 及多级别聚合）**
* 独立的 **行情中心（Market Data Center）**
* 策略与风控已围绕 K 线运行

但系统仍缺少：

> **对“最新市场价格”的实时感知能力**

K 线只能反映离散时间点价格，无法满足：

* 秒级 / 毫秒级风控
* 即时止损 / 追价策略
* 前端实时行情展示

因此，需要一个**独立、轻量、只做一件事的实时价格订阅模块**。

---

## 2. 产品定位（一句话）

> **实时价格订阅模块是系统中“最新价格”的唯一权威来源。**

---

## 3. 模块职责边界（必须严格遵守）

### 3.1 模块负责（Do）

* 通过 WebSocket 订阅实时价格
* 解析并标准化价格数据
* 维护每个交易对的最新价格状态
* 向系统发布价格变更事件

### 3.2 模块不负责（Do NOT）

* ❌ K 线生成或聚合
* ❌ 行情校准或补拉
* ❌ 历史价格存储
* ❌ 交易或下单逻辑
* ❌ 策略决策

> **任何想把“计算 / 校准 / 存库”塞进本模块的行为，都是设计违规。**

---

## 4. 与行情中心其它模块的关系

```text
行情中心
├── K线系统（历史 / 聚合）
├── 行情校准（缺失补齐）
└── 实时价格订阅（本模块）
```

### 核心原则

* 实时价格 ≠ K 线
* 实时价格不反推 K 线
* 实时价格只提供“此刻”

---

## 5. 数据模型定义

### 5.1 实时价格事件（PriceTick）

```text
PriceTick
- symbol          交易对
- price           当前最新成交价
- timestamp       交易所时间戳
- source          行情来源
```

特性：

* 高频
* 无历史语义
* 后到覆盖前到（Latest-Wins）

---

### 5.2 最新价格状态（LatestPrice）

```text
LatestPrice
- symbol
- price
- timestamp
```

> **系统任意时刻查询到的最新价格，必须来自这里。**

---

## 6. 订阅机制规范

### 6.1 接入方式

* 协议：WebSocket
* 接入点：统一行情 WebSocket
* 订阅频道：

```text
channel = price.tick
```

---

### 6.2 消息消费规则（强制）

1. **只处理最新消息**
2. 时间戳旧于当前缓存 → 丢弃
3. 不做重排、不做等待、不做补拉
4. 消息处理必须无阻塞

---

## 7. 内部处理流程（标准）

```text
WebSocket Message
        ↓
解码（Decoder）
        ↓
PriceTick
        ↓
更新 LatestPrice（内存）
        ↓
发布 PriceChangedEvent
```

---

## 8. 事件发布规范

### 8.1 价格变更事件

```text
PriceChangedEvent
- symbol
- price
- timestamp
```

### 8.2 事件语义

> **“该交易对的最新价格已更新”**

不包含：

* 涨跌判断
* 阈值判断
* 策略含义

---

## 9. 性能与技术约束（验收级）

| 项目     | 要求    |
| ------ | ----- |
| 单条处理耗时 | < 1ms |
| 内存分配   | 零或极低  |
| 丢包容忍   | 可     |
| 顺序保证   | 不要求   |
| 重连能力   | 必须    |

---

## 10. 数据存储策略（明确结论）

### v1 版本决策

> ❌ 不写入 QuestDB
> ❌ 不写入 MySQL
> ✔ 仅维护内存最新状态

原因：

* 历史价值为零
* 已由 K 线承担历史责任
* 保证模块极简与高性能

---

## 11. 对外接口（逻辑层）

### 11.1 查询接口（同步）

```text
getLatestPrice(symbol)
```

### 11.2 订阅接口（事件）

```text
subscribe PriceChangedEvent
```

---

## 12. 异常与容错策略

| 场景    | 处理方式   |
| ----- | ------ |
| WS 断连 | 自动重连   |
| 消息乱序  | 时间戳覆盖  |
| 高频抖动  | 原样透传   |
| 行情中断  | 保留最后价格 |

---

## 13. 产品验收标准（必须全部满足）

* 系统可稳定接收实时价格
* 最新价格可随时查询
* 策略与风控能即时感知价格变化
* 不影响现有 K 线系统
* 模块职责无污染

---

## 14. 未来扩展（不属于 v1）

* Tick 历史存储
* 秒线生成
* 订单簿接入
* 价格异常检测

---

## 15. 设计底线声明（重要）

> **实时价格订阅模块必须保持“只做一件事”的洁癖。**
> **它是系统的神经末梢，不是大脑。**
