# 价格订阅问题排查指南

## 问题现象
- BTC-USDT-SWAP 交易对显示订阅成功
- 但一直没有收到价格变化推送

## 排查步骤

### 1. 检查WebSocket连接状态
查看启动日志，确认：
```
价格订阅WebSocket 连接已建立: wss://ws.okx.com:8443/ws/v5/public
发送价格订阅消息成功: symbols=[BTC-USDT-SWAP]
```

### 2. 检查订阅确认
查看是否有订阅成功的确认消息（OKX会返回subscribe event响应）

### 3. 检查消息接收
查看日志：
```
价格订阅收到消息，开始路由: messageLength=xxx
```

如果看不到这条日志，说明：
- WebSocket连接可能有问题
- 或者消息没有到达handleMessage方法

### 4. 检查ChannelRouter路由
查看日志：
```
路由消息到Channel: channelType=PRICE
```

如果看到：
```
未找到对应的 Channel: channelType=PRICE, 已注册的Channel类型=[KLINE]
```
说明PriceChannel没有注册到ChannelRouter。

### 5. 检查PriceChannel处理
查看日志：
```
PriceChannel收到消息: messageLength=xxx
价格Tick事件已发布: symbol=BTC-USDT-SWAP, price=xxx, timestamp=xxx
```

如果没有看到"PriceChannel收到消息"，说明路由失败。

### 6. 检查LatestPriceService
查看日志：
```
LatestPriceService已订阅PriceTick事件
价格已更新: symbol=BTC-USDT-SWAP, price=xxx, timestamp=xxx
```

## 常见问题

### 问题1：PriceChannel未注册到ChannelRouter
**症状**：日志显示"未找到对应的 Channel: channelType=PRICE"
**原因**：PriceChannel只在ExchangeWebSocketManager的Bean创建时注册，但PriceWebSocketManager使用不同的ChannelRouter实例
**解决**：确保ChannelRouter是单例Bean，且PriceChannel在两个WebSocketManager创建前已注册

### 问题2：ChannelRouter实例不一致
**症状**：PriceChannel已注册，但仍找不到Channel
**原因**：PriceWebSocketManager和ExchangeWebSocketManager使用了不同的ChannelRouter实例
**解决**：确保ChannelRouter是@Bean单例，且两个WebSocketManager注入的是同一个实例

### 问题3：消息格式不匹配
**症状**：PriceChannel收到消息，但解析失败
**原因**：OKX ticker消息格式与预期不符
**解决**：查看PriceChannel的错误日志，检查实际消息格式

### 问题4：PriceEventBus未注入
**症状**：PriceChannel发布事件时出错
**原因**：PriceEventBus未正确注入
**解决**：检查PriceEventBus Bean是否创建

## 启用DEBUG日志

在 `application.yml` 中添加：
```yaml
logging:
  level:
    com.qyl.v2trade.market.subscription: DEBUG
```

## 关键日志点

1. **连接建立**：`价格订阅WebSocket 连接已建立`
2. **订阅发送**：`发送价格订阅消息成功`
3. **消息接收**：`价格订阅收到消息，开始路由`
4. **路由处理**：`路由消息到Channel: channelType=PRICE`
5. **Channel处理**：`PriceChannel收到消息`
6. **事件发布**：`价格Tick事件已发布`
7. **价格更新**：`价格已更新`

