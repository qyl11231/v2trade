很好，这一步**非常关键**。
你现在要做的是把“已经定型的小而强的模块”**正式写进系统级产品规范**，而不是停留在技术讨论层。

下面是一份**可直接存档、可评审、可验收的产品规范文档（MD）**，内容是**基于你当前系统状态**、**不引入多余复杂性**、**严格单一职责**。

---

# 📘 产品规范：多级别 K 线聚合模块（K-Line Aggregation Service）

> **版本**：v1.0
> **状态**：已设计 / 待实现
> **所属系统**：行情数据中心（Market Data Center）
> **定位级别**：基础设施 · 领域核心模块

---

## 一、模块背景与产品定位

### 1.1 背景

当前系统已具备：

* 稳定的一分钟（1m）K 线实时订阅能力
* 行情校准模块已确保 1m K 线的唯一性与连续性
* 策略、风控、前端均依赖多周期 K 线（5m / 15m / 30m / 1h / 4h）

因此，需要一个**工业级、可信、可复用**的模块：

> **从唯一可信的 1m K 线源，生成多级别聚合 K 线，并作为系统的唯一派生源。**

---

### 1.2 产品定位（一句话）

> **多级别 K 线聚合模块是行情中心内负责“时间维度升维”的唯一计算节点。**

---

### 1.3 模块边界（极其重要）

✅ **模块负责：**

* 接收 1m K 线流
* 按时间窗口实时聚合
* 产出多级别 K 线事件
* 写入行情数据库（QuestDB）
* 向下游发布聚合完成事件

❌ **模块不负责：**

* 行情订阅（由行情订阅模块负责）
* 行情校准 / 补拉
* 策略决策逻辑
* 指标计算
* 前端查询 API

---

## 二、核心设计原则

| 原则          | 说明                  |
| ----------- | ------------------- |
| 单一可信源       | 所有聚合仅来源于已校准的 1m K 线 |
| 单一职责        | 聚合 ≠ 存储 ≠ 通知        |
| Append-only | 不更新历史聚合结果           |
| 事件驱动        | 聚合完成即事件             |
| 毫秒级延迟       | 聚合与通知总耗时 < 10ms     |
| 可回放         | 支持历史 1m 数据重放        |

---

## 三、输入与输出定义

### 3.1 输入（唯一）

```text
输入源：1m K 线（实时流）
状态：已校准、连续、唯一
```

字段：

* symbol
* timestamp（分钟整点）
* open / high / low / close
* volume

---

### 3.2 输出（多级别）

支持周期（v1）：

* 5m
* 15m
* 30m
* 1h
* 4h

输出形式：

1. **聚合 K 线事件**
2. **写入 QuestDB 对应表**

---

## 四、系统结构设计

```text
┌──────────────────────┐
│ 1m KLine Stream      │
│ (Calibrated)         │
└─────────┬────────────┘
          ▼
┌──────────────────────┐
│ KLine Aggregator     │
│ (Pure Compute)       │
└─────────┬────────────┘
          ▼
┌──────────────────────┐
│ Aggregation Event    │
└──────┬────────┬──────┘
       ▼        ▼
┌──────────┐ ┌──────────┐
│ Persistor│ │ Notifier │
│ QuestDB  │ │ Strategy │
└──────────┘ └──────────┘
```

---

## 五、核心功能说明

### 5.1 实时聚合机制

* 以 **symbol + period** 维护内存 bucket
* 每收到一根 1m K 线：

  * 判断所属聚合窗口
  * 更新 OHLCV
  * 窗口结束时生成聚合结果

---

### 5.2 聚合完成事件

```java
AggregatedKLine {
  symbol
  period
  timestamp
  open
  high
  low
  close
  volume
}
```

该对象为：

* **不可变**
* **可序列化**
* **事件语义**

---

### 5.3 数据库存储（QuestDB）

#### 表设计规范

* 每个周期一张表
* append-only
* WAL enabled
* 不允许 update/delete

示例：

```sql
kline_15m
kline_1h
```

---

### 5.4 通知机制

* 聚合完成即通知
* 通知对象为 `AggregatedKLine`
* 支持多消费者：

  * 策略实例
  * 风控模块
  * 前端缓存层

---

## 六、性能与稳定性指标（验收标准）

| 项目            | 指标          |
| ------------- | ----------- |
| 单 symbol 聚合延迟 | < 2 ms      |
| 写库延迟（异步）      | < 50 ms     |
| 聚合正确率         | 100%        |
| 重启后一致性        | 不产生重复聚合     |
| GC 压力         | 近似 0（无频繁分配） |

---

## 七、异常与边界处理

| 场景      | 处理策略            |
| ------- | --------------- |
| 1m 数据延迟 | 等待，不提前聚合        |
| 时间乱序    | 拒绝处理（由校准模块修复）   |
| 重启      | 由校准模块补齐 1m 后再聚合 |
| 重复 1m   | 忽略              |

---

## 八、与其他模块关系

| 模块   | 关系        |
| ---- | --------- |
| 行情订阅 | 上游        |
| 行情校准 | 前置保障      |
| 策略系统 | 下游消费者     |
| 前端行情 | 读 QuestDB |
| 回测系统 | 可复用聚合逻辑   |

---

## 九、当前状态与下一步

### 当前状态

* 架构已定
* 1m 数据已稳定
* 不引入校准逻辑
* 不引入复杂依赖

### 下一步

* Java 实现 Aggregator
* QuestDB 写入模块
* 事件总线接入
* 策略消费验证

---

## 十、产品结语（重要）

> **该模块是行情系统中“时间维度”的唯一解释者。**

一旦落地，其输出即成为：

* 策略信号基础
* 风控依据
* 前端展示来源
