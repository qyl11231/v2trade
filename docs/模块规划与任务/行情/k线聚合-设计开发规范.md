# ğŸ“ Kçº¿èšåˆæ¨¡å— - è®¾è®¡å¼€å‘è§„èŒƒ

> **ç‰ˆæœ¬**ï¼šv1.0  
> **çŠ¶æ€**ï¼šè®¾è®¡é˜¶æ®µ  
> **æ‰€å±ç³»ç»Ÿ**ï¼šè¡Œæƒ…æ•°æ®ä¸­å¿ƒï¼ˆMarket Data Centerï¼‰  
> **åŸºäºæ–‡æ¡£**ï¼š`kçº¿èšåˆ.md`ï¼ˆäº§å“è§„èŒƒï¼‰

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#æ ¸å¿ƒè®¾è®¡åŸåˆ™)
   - [åŸåˆ™1ï¼šæ•°æ®å”¯ä¸€æ€§ä¿è¯](#åŸåˆ™1æ•°æ®å”¯ä¸€æ€§ä¿è¯æ•°æ®çœŸç†)
   - [åŸåˆ™2ï¼šæ•°æ®ä¸å¯æ›´æ–°ï¼ˆAppend-Onlyï¼‰](#åŸåˆ™2æ•°æ®ä¸å¯æ›´æ–°append-only)
   - [åŸåˆ™3ï¼šæ—¶é—´å¯¹é½ä¿è¯](#åŸåˆ™3æ—¶é—´å¯¹é½ä¿è¯)
2. [æŠ€æœ¯æ¶æ„è®¾è®¡](#ä¸€æŠ€æœ¯æ¶æ„è®¾è®¡)
3. [æ•°æ®æ¨¡å‹è®¾è®¡](#äºŒæ•°æ®æ¨¡å‹è®¾è®¡)
4. [æ ¸å¿ƒç®—æ³•è®¾è®¡](#ä¸‰æ ¸å¿ƒç®—æ³•è®¾è®¡)
5. [æ¥å£è®¾è®¡](#å››æ¥å£è®¾è®¡)
6. [æ•°æ®åº“è®¾è®¡](#äº”æ•°æ®åº“è®¾è®¡)
7. [äº‹ä»¶è®¾è®¡](#å…­äº‹ä»¶è®¾è®¡)
8. [æ€§èƒ½è®¾è®¡](#ä¸ƒæ€§èƒ½è®¾è®¡)
9. [å¼‚å¸¸å¤„ç†è®¾è®¡](#å…«å¼‚å¸¸å¤„ç†è®¾è®¡)
10. [æµ‹è¯•è®¾è®¡](#ä¹æµ‹è¯•è®¾è®¡)
11. [ä»»åŠ¡æ‹†è§£](#åä»»åŠ¡æ‹†è§£)

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### åŸåˆ™1ï¼šæ•°æ®å”¯ä¸€æ€§ä¿è¯ï¼ˆæ•°æ®çœŸç†ï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼šå¦‚æœè¯¥å‘¨æœŸåœ¨å…¶æ‰€åœ¨çº§åˆ«å·²ç»å­˜åœ¨ï¼Œç»ä¸é‡å¤æ’å…¥

**å®ç°æœºåˆ¶ï¼ˆä¸‰å±‚é˜²æŠ¤ï¼‰**ï¼š
- âœ… **ç¬¬ä¸€å±‚ï¼ˆåº”ç”¨å±‚-æ‰«ææ—¶ï¼‰**ï¼šæ‰«ææœªå®Œæˆçª—å£æ—¶æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
- âœ… **ç¬¬äºŒå±‚ï¼ˆåº”ç”¨å±‚-å†™å…¥å‰ï¼‰**ï¼šå†™å…¥å‰å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
- âœ… **ç¬¬ä¸‰å±‚ï¼ˆæ•°æ®åº“å±‚-å”¯ä¸€çº¦æŸï¼‰**ï¼š`(symbol, ts)` å”¯ä¸€çº¦æŸï¼Œé˜²æ­¢å¹¶å‘å†²çª
- âœ… **å¹‚ç­‰æ€§ä¿è¯**ï¼šæ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼ˆä¸äº§ç”Ÿé‡å¤æ•°æ®ï¼‰
- âœ… **æ‰€æœ‰å†™å…¥è·¯å¾„éƒ½éµå¾ªæ­¤åŸåˆ™**ï¼š
  - å®æ—¶èšåˆï¼šå†™å…¥å‰æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰+ æ•°æ®åº“çº¦æŸï¼ˆç¬¬ä¸‰å±‚ï¼‰
  - å†å²è¡¥é½ï¼šæ‰«ææ—¶æ£€æŸ¥ï¼ˆç¬¬ä¸€å±‚ï¼‰+ å†™å…¥å‰æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰+ æ•°æ®åº“çº¦æŸï¼ˆç¬¬ä¸‰å±‚ï¼‰
  - æ‰¹é‡å›æ”¾ï¼šæ¯ä¸ªçª—å£å†™å…¥å‰æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰+ æ•°æ®åº“çº¦æŸï¼ˆç¬¬ä¸‰å±‚ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// å†™å…¥å‰å¿…é¡»æ£€æŸ¥
if (storageService.exists(symbol, period, timestamp)) {
    // å·²å­˜åœ¨ï¼Œç»ä¸å†™å…¥ï¼Œä¿è¯æ•°æ®å”¯ä¸€æ€§
    return false;
}
// ä¸å­˜åœ¨ï¼Œæ‰§è¡Œå†™å…¥
return storageService.save(aggregatedKLine);
```

### åŸåˆ™2ï¼šæ•°æ®ä¸å¯æ›´æ–°ï¼ˆAppend-Onlyï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼šèšåˆKçº¿ä¸€æ—¦å†™å…¥ï¼Œç»ä¸æ›´æ–°

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… **Append-Onlyæ¨¡å¼**ï¼šåªå…è®¸æ’å…¥ï¼Œä¸å…è®¸æ›´æ–°
- âœ… **å†å²æ•°æ®ä¸å¯å˜**ï¼šå·²èšåˆçš„Kçº¿æ•°æ®æ˜¯å†å²äº‹å®ï¼Œä¸å¯ä¿®æ”¹
- âœ… **ä¸æä¾›æ›´æ–°æ¥å£**ï¼šå­˜å‚¨æœåŠ¡ä¸æä¾›updateæ–¹æ³•
- âœ… **å¦‚æœæ•°æ®é”™è¯¯**ï¼šç”±æ ¡å‡†æ¨¡å—é‡æ–°èšåˆï¼Œè€Œä¸æ˜¯æ›´æ–°ç°æœ‰æ•°æ®

**å®ç°æ–¹å¼**ï¼š
- å­˜å‚¨æœåŠ¡æ¥å£ä¸æä¾› `update()` æ–¹æ³•
- æ•°æ®åº“å±‚é¢ï¼šåªå…è®¸INSERTï¼Œä¸å…è®¸UPDATE
- å¦‚æœå‘ç°æ•°æ®é”™è¯¯ï¼Œåˆ é™¤åé‡æ–°èšåˆï¼ˆç”±æ ¡å‡†æ¨¡å—è´Ÿè´£ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// âœ… æ­£ç¡®ï¼šåªæä¾›saveæ–¹æ³•ï¼Œä¸æä¾›updateæ–¹æ³•
public interface AggregatedKLineStorageService {
    boolean save(AggregatedKLine aggregatedKLine);  // åªå…è®¸æ’å…¥
    // âŒ ä¸æä¾›ï¼švoid update(AggregatedKLine aggregatedKLine);
}

// âŒ é”™è¯¯ï¼šä¸å…è®¸æ›´æ–°
// storageService.update(aggregatedKLine);  // ä¸å…è®¸

// âœ… æ­£ç¡®ï¼šå¦‚æœæ•°æ®é”™è¯¯ï¼Œåˆ é™¤åé‡æ–°èšåˆ
// 1. åˆ é™¤é”™è¯¯æ•°æ®ï¼ˆç”±æ ¡å‡†æ¨¡å—è´Ÿè´£ï¼‰
// 2. é‡æ–°èšåˆå¹¶æ’å…¥
```

### åŸåˆ™3ï¼šæ—¶é—´å¯¹é½ä¿è¯

**æ ¸å¿ƒè¦æ±‚**ï¼šæ‰€æœ‰æ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°å¯¹åº”å‘¨æœŸçš„èµ·å§‹æ—¶é—´

**å¯¹é½è§„åˆ™**ï¼š
- 5må‘¨æœŸï¼šå¯¹é½åˆ°5åˆ†é’Ÿè¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 10:05, 10:10ï¼‰
- 15må‘¨æœŸï¼šå¯¹é½åˆ°15åˆ†é’Ÿè¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 10:15, 10:30ï¼‰
- 30må‘¨æœŸï¼šå¯¹é½åˆ°30åˆ†é’Ÿè¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 10:30ï¼‰
- 1hå‘¨æœŸï¼šå¯¹é½åˆ°å°æ—¶è¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 11:00ï¼‰
- 4hå‘¨æœŸï¼šå¯¹é½åˆ°4å°æ—¶è¾¹ç•Œï¼ˆå¦‚ï¼š00:00, 04:00, 08:00ï¼‰

**å®ç°æ–¹å¼**ï¼š
- ä½¿ç”¨ `PeriodCalculator.alignTimestamp(timestamp, period)` ç¡®ä¿å¯¹é½
- æ‰€æœ‰èšåˆç»“æœçš„æ—¶é—´æˆ³å¿…é¡»ä½¿ç”¨æ­¤æ–¹æ³•å¯¹é½
- çª—å£èµ·å§‹æ—¶é—´è®¡ç®—æ—¶è‡ªåŠ¨å¯¹é½

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// è®¡ç®—çª—å£èµ·å§‹æ—¶é—´ï¼ˆè‡ªåŠ¨å¯¹é½ï¼‰
long windowStart = PeriodCalculator.calculateWindowStart(timestamp, period);

// ç”Ÿæˆèšåˆç»“æœæ—¶ï¼Œç¡®ä¿æ—¶é—´æˆ³å¯¹é½
long alignedTimestamp = PeriodCalculator.alignTimestamp(windowStart, period);
AggregatedKLine aggregated = new AggregatedKLine(
    symbol, period, alignedTimestamp, // å¯¹é½åçš„æ—¶é—´æˆ³
    open, high, low, close, volume, sourceKlineCount
);
```

**æ—¶é—´å¯¹é½ç¤ºä¾‹è¡¨**ï¼š

| åŸå§‹æ—¶é—´æˆ³ | å‘¨æœŸ | å¯¹é½åæ—¶é—´æˆ³ | è¯´æ˜ |
|-----------|------|-------------|------|
| 10:03:00 | 5m | 10:00:00 | å¯¹é½åˆ°5åˆ†é’Ÿè¾¹ç•Œ |
| 10:17:00 | 15m | 10:15:00 | å¯¹é½åˆ°15åˆ†é’Ÿè¾¹ç•Œ |
| 10:33:00 | 30m | 10:30:00 | å¯¹é½åˆ°30åˆ†é’Ÿè¾¹ç•Œ |
| 10:45:00 | 1h | 10:00:00 | å¯¹é½åˆ°å°æ—¶è¾¹ç•Œ |
| 14:30:00 | 4h | 12:00:00 | å¯¹é½åˆ°4å°æ—¶è¾¹ç•Œ |

---

## ä¸€ã€æŠ€æœ¯æ¶æ„è®¾è®¡

### 1.1 æ¨¡å—åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        èšåˆæœåŠ¡å±‚ (Aggregation)          â”‚
â”‚  - KlineAggregator (æ ¸å¿ƒèšåˆå™¨)          â”‚
â”‚  - AggregationBucket (èšåˆæ¡¶)           â”‚
â”‚  - PeriodCalculator (å‘¨æœŸè®¡ç®—å™¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        äº‹ä»¶å±‚ (Event)                    â”‚
â”‚  - AggregatedKLineEvent (èšåˆå®Œæˆäº‹ä»¶)   â”‚
â”‚  - AggregationEventPublisher (äº‹ä»¶å‘å¸ƒ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æŒä¹…åŒ–å±‚ (Persistence)              â”‚
â”‚  - AggregatedKLineStorageService        â”‚
â”‚  - QuestDBå†™å…¥æœåŠ¡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åŸºç¡€è®¾æ–½å±‚ (Infrastructure)       â”‚
â”‚  - MarketEventBus (äº‹ä»¶æ€»çº¿)             â”‚
â”‚  - QuestDBè¿æ¥æ±                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åŒ…ç»“æ„è®¾è®¡

```
com.qyl.v2trade.market.aggregation
â”œâ”€â”€ core/                           # æ ¸å¿ƒèšåˆé€»è¾‘
â”‚   â”œâ”€â”€ KlineAggregator.java        # èšåˆå™¨ä¸»ç±»
â”‚   â”œâ”€â”€ AggregationBucket.java      # èšåˆæ¡¶ï¼ˆå†…å­˜çŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ PeriodCalculator.java       # å‘¨æœŸè®¡ç®—å·¥å…·
â”‚   â””â”€â”€ AggregationWindow.java      # èšåˆçª—å£å®šä¹‰
â”œâ”€â”€ event/                          # äº‹ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ AggregatedKLineEvent.java   # èšåˆå®Œæˆäº‹ä»¶
â”‚   â””â”€â”€ AggregationEventPublisher.java  # äº‹ä»¶å‘å¸ƒå™¨
â”œâ”€â”€ persistence/                    # æŒä¹…åŒ–
â”‚   â”œâ”€â”€ AggregatedKLineStorageService.java
â”‚   â””â”€â”€ impl/
â”‚       â””â”€â”€ QuestDbAggregatedKLineStorageServiceImpl.java
â”œâ”€â”€ config/                         # é…ç½®
â”‚   â”œâ”€â”€ AggregationConfig.java      # èšåˆé…ç½®
â”‚   â””â”€â”€ SupportedPeriods.java      # æ”¯æŒçš„å‘¨æœŸå¸¸é‡
â””â”€â”€ listener/                       # äº‹ä»¶ç›‘å¬
    â””â”€â”€ KlineEventConsumer.java     # æ¶ˆè´¹1m Kçº¿äº‹ä»¶
```

### 1.3 ä¾èµ–å…³ç³»

**è¾“å…¥ä¾èµ–**ï¼š
- `MarketEventBus` - è®¢é˜…1m Kçº¿äº‹ä»¶
- `KlineEvent` - 1m Kçº¿äº‹ä»¶æ¨¡å‹

**è¾“å‡ºä¾èµ–**ï¼š
- `MarketEventBus` - å‘å¸ƒèšåˆå®Œæˆäº‹ä»¶
- `QuestDB` - å†™å…¥èšåˆKçº¿æ•°æ®

**ä¸ä¾èµ–**ï¼š
- âŒ è¡Œæƒ…è®¢é˜…æ¨¡å—ï¼ˆé€šè¿‡äº‹ä»¶æ€»çº¿è§£è€¦ï¼‰
- âŒ è¡Œæƒ…æ ¡å‡†æ¨¡å—ï¼ˆåªæ¶ˆè´¹å·²æ ¡å‡†çš„1mæ•°æ®ï¼‰
- âŒ ç­–ç•¥æ¨¡å—ï¼ˆåªå‘å¸ƒäº‹ä»¶ï¼Œä¸å…³å¿ƒæ¶ˆè´¹è€…ï¼‰

---

## äºŒã€æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 AggregatedKLineï¼ˆèšåˆKçº¿äº‹ä»¶ï¼‰

```java
package com.qyl.v2trade.market.aggregation.event;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * èšåˆKçº¿äº‹ä»¶ï¼ˆä¸å¯å˜ã€å¯åºåˆ—åŒ–ï¼‰
 * 
 * è¯­ä¹‰ï¼šä¸€æ ¹èšåˆå®Œæˆçš„Kçº¿ï¼Œæ—¶é—´çª—å£å·²å…³é—­
 */
public record AggregatedKLine(
    /**
     * äº¤æ˜“å¯¹ç¬¦å·ï¼ˆå¦‚ï¼šBTC-USDTï¼‰
     */
    String symbol,
    
    /**
     * Kçº¿å‘¨æœŸï¼ˆå¦‚ï¼š5m, 15m, 1hï¼‰
     */
    String period,
    
    /**
     * æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼ŒUTCï¼Œå¿…é¡»å¯¹é½åˆ°å‘¨æœŸèµ·å§‹ç‚¹ï¼‰
     * 
     * ã€é‡è¦ã€‘æ—¶é—´å¯¹é½è§„åˆ™ï¼š
     * - 5må‘¨æœŸï¼šå¿…é¡»å¯¹é½åˆ°5åˆ†é’Ÿè¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 10:05, 10:10ï¼‰
     * - 15må‘¨æœŸï¼šå¿…é¡»å¯¹é½åˆ°15åˆ†é’Ÿè¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 10:15, 10:30ï¼‰
     * - 30må‘¨æœŸï¼šå¿…é¡»å¯¹é½åˆ°30åˆ†é’Ÿè¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 10:30ï¼‰
     * - 1hå‘¨æœŸï¼šå¿…é¡»å¯¹é½åˆ°å°æ—¶è¾¹ç•Œï¼ˆå¦‚ï¼š10:00, 11:00ï¼‰
     * - 4hå‘¨æœŸï¼šå¿…é¡»å¯¹é½åˆ°4å°æ—¶è¾¹ç•Œï¼ˆå¦‚ï¼š00:00, 04:00, 08:00ï¼‰
     * 
     * ä½¿ç”¨ PeriodCalculator.alignTimestamp() ç¡®ä¿å¯¹é½
     */
    long timestamp,
    
    /**
     * å¼€ç›˜ä»·ï¼ˆçª—å£å†…ç¬¬ä¸€æ ¹1m Kçº¿çš„å¼€ç›˜ä»·ï¼‰
     */
    BigDecimal open,
    
    /**
     * æœ€é«˜ä»·ï¼ˆçª—å£å†…æ‰€æœ‰1m Kçº¿çš„æœ€é«˜ä»·ï¼‰
     */
    BigDecimal high,
    
    /**
     * æœ€ä½ä»·ï¼ˆçª—å£å†…æ‰€æœ‰1m Kçº¿çš„æœ€ä½ä»·ï¼‰
     */
    BigDecimal low,
    
    /**
     * æ”¶ç›˜ä»·ï¼ˆçª—å£å†…æœ€åä¸€æ ¹1m Kçº¿çš„æ”¶ç›˜ä»·ï¼‰
     */
    BigDecimal close,
    
    /**
     * æˆäº¤é‡ï¼ˆçª—å£å†…æ‰€æœ‰1m Kçº¿çš„æˆäº¤é‡ä¹‹å’Œï¼‰
     */
    BigDecimal volume,
    
    /**
     * èšåˆçš„1m Kçº¿æ•°é‡ï¼ˆç”¨äºéªŒè¯å®Œæ•´æ€§ï¼‰
     */
    int sourceKlineCount
) implements Serializable {
    
    /**
     * åˆ›å»ºèšåˆKçº¿äº‹ä»¶
     */
    public static AggregatedKLine of(
            String symbol,
            String period,
            long timestamp,
            BigDecimal open,
            BigDecimal high,
            BigDecimal low,
            BigDecimal close,
            BigDecimal volume,
            int sourceKlineCount) {
        return new AggregatedKLine(
                symbol, period, timestamp,
                open, high, low, close, volume,
                sourceKlineCount
        );
    }
}
```

### 2.2 AggregationBucketï¼ˆèšåˆæ¡¶ï¼‰

```java
package com.qyl.v2trade.market.aggregation.core;

import java.math.BigDecimal;

/**
 * èšåˆæ¡¶ï¼ˆå†…å­˜çŠ¶æ€ï¼‰
 * 
 * èŒè´£ï¼šç»´æŠ¤ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„èšåˆçŠ¶æ€
 * ç”Ÿå‘½å‘¨æœŸï¼šçª—å£å¼€å§‹ -> æŒç»­æ›´æ–° -> çª—å£ç»“æŸ -> ç”Ÿæˆèšåˆç»“æœ -> æ¸…ç†
 */
public class AggregationBucket {
    
    private final String symbol;
    private final String period;
    private final long windowStart;  // çª—å£èµ·å§‹æ—¶é—´æˆ³
    private final long windowEnd;     // çª—å£ç»“æŸæ—¶é—´æˆ³
    
    private BigDecimal open;          // ç¬¬ä¸€æ ¹Kçº¿çš„å¼€ç›˜ä»·
    private BigDecimal high;          // æœ€é«˜ä»·ï¼ˆæŒç»­æ›´æ–°ï¼‰
    private BigDecimal low;           // æœ€ä½ä»·ï¼ˆæŒç»­æ›´æ–°ï¼‰
    private BigDecimal close;         // æœ€åä¸€æ ¹Kçº¿çš„æ”¶ç›˜ä»·
    private BigDecimal volume;         // ç´¯è®¡æˆäº¤é‡
    private int klineCount;           // å·²èšåˆçš„1m Kçº¿æ•°é‡
    
    private boolean isComplete;       // çª—å£æ˜¯å¦å·²å…³é—­
    
    // æ„é€ å‡½æ•°ã€getter/setterã€èšåˆæ–¹æ³•...
}
```

### 2.3 å‘¨æœŸæšä¸¾

```java
package com.qyl.v2trade.market.aggregation.config;

/**
 * æ”¯æŒçš„èšåˆå‘¨æœŸ
 */
public enum SupportedPeriod {
    
    M5("5m", 5 * 60 * 1000L),      // 5åˆ†é’Ÿ
    M15("15m", 15 * 60 * 1000L),    // 15åˆ†é’Ÿ
    M30("30m", 30 * 60 * 1000L),    // 30åˆ†é’Ÿ
    H1("1h", 60 * 60 * 1000L),      // 1å°æ—¶
    H4("4h", 4 * 60 * 60 * 1000L);  // 4å°æ—¶
    
    private final String period;
    private final long durationMs;
    
    // æ„é€ å‡½æ•°ã€getter...
}
```

---

## ä¸‰ã€æ ¸å¿ƒç®—æ³•è®¾è®¡

### 3.1 èšåˆç®—æ³•

**æ ¸å¿ƒæµç¨‹**ï¼š

```
1. æ¥æ”¶1m Kçº¿äº‹ä»¶
2. è®¡ç®—è¯¥Kçº¿æ‰€å±çš„èšåˆçª—å£ï¼ˆæ¯ä¸ªå‘¨æœŸï¼‰
   - ä½¿ç”¨ PeriodCalculator.calculateWindowStart() è®¡ç®—çª—å£èµ·å§‹æ—¶é—´
   - ç¡®ä¿çª—å£èµ·å§‹æ—¶é—´å·²å¯¹é½åˆ°å‘¨æœŸè¾¹ç•Œ
3. æ‰¾åˆ°æˆ–åˆ›å»ºå¯¹åº”çš„AggregationBucket
4. æ›´æ–°BucketçŠ¶æ€ï¼š
   - open: ç¬¬ä¸€æ ¹Kçº¿çš„openï¼ˆä¿æŒä¸å˜ï¼‰
   - high: max(bucket.high, kline.high)
   - low: min(bucket.low, kline.low)
   - close: kline.closeï¼ˆæŒç»­æ›´æ–°ï¼‰
   - volume: bucket.volume + kline.volume
   - klineCount: bucket.klineCount + 1
5. åˆ¤æ–­çª—å£æ˜¯å¦ç»“æŸï¼š
   - å¦‚æœ kline.timestamp >= windowEndï¼Œçª—å£ç»“æŸ
6. çª—å£ç»“æŸæ—¶ï¼š
   - ç”ŸæˆAggregatedKLineäº‹ä»¶
     - ã€é‡è¦ã€‘æ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°çª—å£èµ·å§‹æ—¶é—´ï¼ˆä½¿ç”¨ PeriodCalculator.alignTimestamp()ï¼‰
   - ã€é‡è¦ã€‘å†™å…¥å‰æ£€æŸ¥ï¼šå¦‚æœè¯¥å‘¨æœŸåœ¨è¯¥çº§åˆ«å·²å­˜åœ¨ï¼Œè·³è¿‡å†™å…¥ï¼ˆä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼‰
   - å¦‚æœä¸å­˜åœ¨ï¼Œæ‰§è¡Œå†™å…¥
   - å‘å¸ƒäº‹ä»¶
   - æ¸…ç†Bucket
```

**å…³é”®åŸåˆ™**ï¼š
- âœ… **æ—¶é—´å¯¹é½**ï¼šæ‰€æœ‰èšåˆç»“æœçš„æ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°å¯¹åº”å‘¨æœŸçš„èµ·å§‹æ—¶é—´
- âœ… **æ•°æ®å”¯ä¸€æ€§**ï¼šå¦‚æœè¯¥å‘¨æœŸåœ¨è¯¥çº§åˆ«å·²å­˜åœ¨ï¼Œç»ä¸é‡å¤æ’å…¥

### 3.2 çª—å£è®¡ç®—ç®—æ³•

**æ ¸å¿ƒåŸåˆ™**ï¼šæ‰€æœ‰æ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°å¯¹åº”å‘¨æœŸçš„èµ·å§‹æ—¶é—´

```java
/**
 * è®¡ç®—æ—¶é—´æˆ³æ‰€å±çš„èšåˆçª—å£èµ·å§‹æ—¶é—´
 * 
 * ã€é‡è¦ã€‘æ—¶é—´å¯¹é½è§„åˆ™ï¼š
 * - æ‰€æœ‰èšåˆç»“æœçš„æ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°å¯¹åº”å‘¨æœŸçš„èµ·å§‹æ—¶é—´
 * - ä¾‹å¦‚ï¼š5må‘¨æœŸï¼Œ10:03çš„1m Kçº¿ -> å¯¹é½åˆ°10:00
 * - ä¾‹å¦‚ï¼š15må‘¨æœŸï¼Œ10:20çš„1m Kçº¿ -> å¯¹é½åˆ°10:15
 * - ä¾‹å¦‚ï¼š1hå‘¨æœŸï¼Œ10:45çš„1m Kçº¿ -> å¯¹é½åˆ°10:00
 * 
 * @param timestamp 1m Kçº¿æ—¶é—´æˆ³ï¼ˆå·²å¯¹é½åˆ°åˆ†é’Ÿï¼‰
 * @param period å‘¨æœŸï¼ˆ5m, 15mç­‰ï¼‰
 * @return çª—å£èµ·å§‹æ—¶é—´æˆ³ï¼ˆå·²å¯¹é½åˆ°å‘¨æœŸè¾¹ç•Œï¼‰
 */
public static long calculateWindowStart(long timestamp, SupportedPeriod period) {
    long durationMs = period.getDurationMs();
    // å¯¹é½åˆ°å‘¨æœŸè¾¹ç•Œï¼ˆå‘ä¸‹å–æ•´ï¼‰
    return (timestamp / durationMs) * durationMs;
}

/**
 * è®¡ç®—çª—å£ç»“æŸæ—¶é—´
 */
public static long calculateWindowEnd(long windowStart, SupportedPeriod period) {
    return windowStart + period.getDurationMs();
}

/**
 * å¯¹é½æ—¶é—´æˆ³åˆ°å‘¨æœŸèµ·å§‹æ—¶é—´
 * 
 * ã€é‡è¦ã€‘æ‰€æœ‰èšåˆKçº¿çš„æ—¶é—´æˆ³å¿…é¡»ä½¿ç”¨æ­¤æ–¹æ³•å¯¹é½
 * 
 * @param timestamp åŸå§‹æ—¶é—´æˆ³
 * @param period å‘¨æœŸ
 * @return å¯¹é½åçš„æ—¶é—´æˆ³ï¼ˆå‘¨æœŸèµ·å§‹æ—¶é—´ï¼‰
 */
public static long alignTimestamp(long timestamp, SupportedPeriod period) {
    return calculateWindowStart(timestamp, period);
}
```

**æ—¶é—´å¯¹é½ç¤ºä¾‹**ï¼š

| åŸå§‹æ—¶é—´æˆ³ | å‘¨æœŸ | å¯¹é½åæ—¶é—´æˆ³ | è¯´æ˜ |
|-----------|------|-------------|------|
| 10:03:00 | 5m | 10:00:00 | å¯¹é½åˆ°5åˆ†é’Ÿè¾¹ç•Œ |
| 10:17:00 | 15m | 10:15:00 | å¯¹é½åˆ°15åˆ†é’Ÿè¾¹ç•Œ |
| 10:33:00 | 30m | 10:30:00 | å¯¹é½åˆ°30åˆ†é’Ÿè¾¹ç•Œ |
| 10:45:00 | 1h | 10:00:00 | å¯¹é½åˆ°å°æ—¶è¾¹ç•Œ |
| 14:30:00 | 4h | 12:00:00 | å¯¹é½åˆ°4å°æ—¶è¾¹ç•Œ |

### 3.3 çª—å£ç»“æŸåˆ¤æ–­

```java
/**
 * åˆ¤æ–­1m Kçº¿æ˜¯å¦è§¦å‘çª—å£å…³é—­
 * 
 * è§„åˆ™ï¼šå½“æ”¶åˆ°çš„æ—¶é—´æˆ³ >= windowEnd æ—¶ï¼Œè¯´æ˜çª—å£å·²ç»“æŸ
 * 
 * ä¾‹å¦‚ï¼š5mçª—å£ [10:00, 10:05)
 * - æ”¶åˆ° 10:04 çš„Kçº¿ -> ä¸å…³é—­
 * - æ”¶åˆ° 10:05 çš„Kçº¿ -> å…³é—­çª—å£ï¼Œç”Ÿæˆ10:00-10:05çš„èšåˆKçº¿
 */
public boolean isWindowComplete(long klineTimestamp) {
    return klineTimestamp >= windowEnd;
}
```

### 3.4 å»é‡æœºåˆ¶

**æ ¸å¿ƒåŸåˆ™**ï¼šä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼Œç»ä¸é‡å¤æ’å…¥

**å†…å­˜å»é‡**ï¼š
- ä½¿ç”¨ `ConcurrentHashMap<String, AggregationBucket>` å­˜å‚¨æ´»è·ƒBucket
- Keyæ ¼å¼ï¼š`{symbol}_{period}_{windowStart}`
- ç›¸åŒKeyçš„1m Kçº¿åªæ›´æ–°ä¸€æ¬¡Bucket

**æ•°æ®åº“å»é‡ï¼ˆä¸‰å±‚é˜²æŠ¤ï¼‰**ï¼š

1. **ç¬¬ä¸€å±‚ï¼ˆåº”ç”¨å±‚-æ‰«ææ—¶ï¼‰**ï¼š
   - æ‰«ææœªå®Œæˆçª—å£æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨èšåˆæ•°æ®
   - ä½¿ç”¨ `exists(symbol, period, timestamp)` æ£€æŸ¥

2. **ç¬¬äºŒå±‚ï¼ˆåº”ç”¨å±‚-å†™å…¥å‰ï¼‰**ï¼š
   - å†™å…¥å‰å†æ¬¡æ£€æŸ¥QuestDBä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ `(symbol, ts)` çš„è®°å½•
   - ä½¿ç”¨ `exists(symbol, period, timestamp)` æ£€æŸ¥
   - **å¦‚æœå­˜åœ¨ï¼Œç»ä¸å†™å…¥**ï¼šè·³è¿‡å†™å…¥ï¼Œè®°å½•æ—¥å¿—ï¼Œä¿è¯æ•°æ®å”¯ä¸€æ€§

3. **ç¬¬ä¸‰å±‚ï¼ˆæ•°æ®åº“å±‚-å”¯ä¸€çº¦æŸï¼‰**ï¼š
   - æ•°æ®åº“å±‚é¢ï¼š`(symbol, ts)` å”¯ä¸€çº¦æŸ
   - å®ç°æ–¹å¼ï¼šé€šè¿‡åº”ç”¨å±‚æ£€æŸ¥å®ç°ï¼ˆQuestDBå¯èƒ½ä¸æ”¯æŒä¼ ç»ŸUNIQUEçº¦æŸï¼‰
   - ä½œç”¨ï¼šé˜²æ­¢å¹¶å‘å†™å…¥å¯¼è‡´çš„é‡å¤æ•°æ®ï¼Œä½œä¸ºå…œåº•ä¿éšœ

**å»é‡æ£€æŸ¥æ—¶æœº**ï¼š
1. å®æ—¶èšåˆï¼šçª—å£ç»“æŸæ—¶ï¼Œå†™å…¥å‰æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰
2. å†å²è¡¥é½ï¼šæ‰«ææ—¶æ£€æŸ¥ï¼ˆç¬¬ä¸€å±‚ï¼‰+ å†™å…¥å‰æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰
3. æ‰¹é‡å›æ”¾ï¼šæ¯ä¸ªçª—å£å†™å…¥å‰æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰

**å¹‚ç­‰æ€§ä¿è¯**ï¼š
- æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼ˆä¸äº§ç”Ÿé‡å¤æ•°æ®ï¼‰
- ä¸‰å±‚é˜²æŠ¤ç¡®ä¿æ•°æ®å”¯ä¸€æ€§ï¼ˆæ•°æ®çœŸç†ï¼‰

### 3.5 å¯åŠ¨æ—¶å†å²æ•°æ®è¡¥é½æœºåˆ¶

**é—®é¢˜åœºæ™¯**ï¼š
- ç³»ç»Ÿåœ¨æŸä¸ªæ—¶é—´ç‚¹å¯åŠ¨ï¼ˆä¾‹å¦‚ï¼š10:30å¯åŠ¨ï¼‰
- å¦‚æœè®¢é˜…1å°æ—¶Kçº¿ï¼Œå½“å‰çª—å£æ˜¯ [10:00, 11:00)
- ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œçª—å£å·²ç»è¿›è¡Œäº†30åˆ†é’Ÿï¼ˆ10:00-10:30çš„æ•°æ®å·²å­˜åœ¨ï¼‰
- å¦‚æœä¸è¡¥é½ï¼Œåªä¼šèšåˆ10:30ä¹‹åçš„æ•°æ®ï¼Œå¯¼è‡´10:00-10:30çš„æ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **å¯åŠ¨æ—¶æ‰«ææœªå®Œæˆçš„çª—å£**
   ```
   å¯¹äºæ¯ä¸ªæ”¯æŒçš„å‘¨æœŸï¼š
   - è®¡ç®—å½“å‰æ—¶é—´ç‚¹ä¹‹å‰çš„æ‰€æœ‰æœªå®Œæˆçª—å£
   - æ£€æŸ¥è¿™äº›çª—å£æ˜¯å¦å·²æœ‰èšåˆæ•°æ®
   - å¦‚æœæ²¡æœ‰ï¼Œä»QuestDBè¯»å–å¯¹åº”çš„1mæ•°æ®è¿›è¡Œèšåˆ
   ```

2. **çª—å£æ‰«æç®—æ³•**
   ```java
   /**
    * æ‰«æéœ€è¦è¡¥é½çš„å†å²çª—å£
    * 
    * @param symbol äº¤æ˜“å¯¹
    * @param period å‘¨æœŸ
    * @param currentTime å½“å‰æ—¶é—´æˆ³
    * @return éœ€è¦è¡¥é½çš„çª—å£åˆ—è¡¨ï¼ˆçª—å£èµ·å§‹æ—¶é—´æˆ³ï¼‰
    */
   public List<Long> scanIncompleteWindows(String symbol, SupportedPeriod period, long currentTime) {
       List<Long> incompleteWindows = new ArrayList<>();
       
       // è®¡ç®—å½“å‰çª—å£çš„èµ·å§‹æ—¶é—´
       long currentWindowStart = PeriodCalculator.calculateWindowStart(currentTime, period);
       
       // æ‰«ææ—¶é—´èŒƒå›´ï¼šä»æœ€æ—©å¯èƒ½çš„æ—¶é—´åˆ°å½“å‰çª—å£
       // é™åˆ¶ï¼šæœ€å¤šæ‰«ææœ€è¿‘24å°æ—¶ï¼ˆé¿å…å¯åŠ¨æ—¶åŠ è½½è¿‡å¤šæ•°æ®ï¼‰
       long scanStartTime = currentTime - (24 * 60 * 60 * 1000L);
       long scanWindowStart = PeriodCalculator.calculateWindowStart(scanStartTime, period);
       
       // éå†æ‰€æœ‰å¯èƒ½çš„çª—å£
       for (long windowStart = scanWindowStart; windowStart < currentWindowStart; windowStart += period.getDurationMs()) {
           // æ£€æŸ¥è¯¥çª—å£æ˜¯å¦å·²æœ‰èšåˆæ•°æ®
           if (!storageService.exists(symbol, period.getPeriod(), windowStart)) {
               incompleteWindows.add(windowStart);
           }
       }
       
       return incompleteWindows;
   }
   ```

3. **å†å²æ•°æ®èšåˆæµç¨‹**
   ```
   1. ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œè°ƒç”¨ initialize() æ–¹æ³•
   2. å¯¹äºæ¯ä¸ªäº¤æ˜“å¯¹å’Œæ¯ä¸ªå‘¨æœŸï¼š
      a. æ‰«ææœªå®Œæˆçš„çª—å£
      b. å¯¹äºæ¯ä¸ªæœªå®Œæˆçš„çª—å£ï¼š
         - ã€å…³é”®ã€‘æ£€æŸ¥è¯¥çª—å£çš„èšåˆæ•°æ®æ˜¯å¦å·²å­˜åœ¨
         - å¦‚æœå·²å­˜åœ¨ï¼Œè·³è¿‡ï¼ˆä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼Œä¸é‡å¤æ’å…¥ï¼‰
         - å¦‚æœä¸å­˜åœ¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
           - ä»QuestDBè¯»å–è¯¥çª—å£å†…çš„æ‰€æœ‰1m Kçº¿æ•°æ®
           - è¿›è¡Œèšåˆè®¡ç®—
           - ç”Ÿæˆèšåˆç»“æœï¼ˆæ—¶é—´æˆ³å¯¹é½åˆ°çª—å£èµ·å§‹æ—¶é—´ï¼‰
           - å†™å…¥QuestDBï¼ˆå†™å…¥å‰å†æ¬¡æ£€æŸ¥ï¼ŒåŒé‡ä¿è¯ï¼‰
           - ä¸å‘å¸ƒèšåˆå®Œæˆäº‹ä»¶ï¼ˆé¿å…é‡å¤é€šçŸ¥ä¸‹æ¸¸ï¼‰
   3. åˆå§‹åŒ–å®Œæˆåï¼Œå¼€å§‹å®æ—¶èšåˆ
   ```
   
   **é‡è¦åŸåˆ™**ï¼š
   - âœ… **æ•°æ®å”¯ä¸€æ€§ä¿è¯**ï¼šå¦‚æœè¯¥å‘¨æœŸåœ¨è¯¥çº§åˆ«å·²å­˜åœ¨ï¼Œç»ä¸é‡å¤æ’å…¥
   - âœ… **æ—¶é—´å¯¹é½ä¿è¯**ï¼šæ‰€æœ‰èšåˆç»“æœçš„æ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°å¯¹åº”å‘¨æœŸçš„èµ·å§‹æ—¶é—´
   - âœ… **åŒé‡æ£€æŸ¥æœºåˆ¶**ï¼šæ‰«ææ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œå†™å…¥å‰å†æ£€æŸ¥ä¸€æ¬¡

4. **æ€§èƒ½ä¼˜åŒ–**
   - **é™åˆ¶æ‰«æèŒƒå›´**ï¼šæœ€å¤šæ‰«ææœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼ˆå¯é…ç½®ï¼‰
   - **æ‰¹é‡å¤„ç†**ï¼šæ‰¹é‡è¯»å–1mæ•°æ®ï¼Œæ‰¹é‡èšåˆ
   - **å¼‚æ­¥æ‰§è¡Œ**ï¼šåˆå§‹åŒ–è¿‡ç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ç³»ç»Ÿå¯åŠ¨
   - **å¹‚ç­‰æ€§ä¿è¯**ï¼šå†™å…¥å‰æ£€æŸ¥ï¼Œé¿å…é‡å¤èšåˆ

5. **åˆå§‹åŒ–é…ç½®**
   ```java
   @ConfigurationProperties(prefix = "market.aggregation")
   public class AggregationConfig {
       /**
        * å¯åŠ¨æ—¶æ˜¯å¦è¡¥é½å†å²æ•°æ®
        */
       private boolean enableHistoryBackfill = true;
       
       /**
        * å†å²æ•°æ®æ‰«æèŒƒå›´ï¼ˆå°æ—¶ï¼‰
        */
       private int historyScanHours = 24;
       
       /**
        * åˆå§‹åŒ–æ˜¯å¦å¼‚æ­¥æ‰§è¡Œ
        */
       private boolean asyncInitialization = true;
   }
   ```

6. **åˆå§‹åŒ–æµç¨‹ç¤ºä¾‹**
   ```java
   @Component
   public class KlineAggregatorInitializer {
       
       @PostConstruct
       public void initialize() {
           if (config.isEnableHistoryBackfill()) {
               if (config.isAsyncInitialization()) {
                   // å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å¯åŠ¨
                   executorService.submit(this::doInitialize);
               } else {
                   // åŒæ­¥æ‰§è¡Œ
                   doInitialize();
               }
           }
       }
       
       private void doInitialize() {
           // 1. è·å–æ‰€æœ‰éœ€è¦èšåˆçš„äº¤æ˜“å¯¹
           List<String> symbols = getActiveSymbols();
           
           // 2. éå†æ¯ä¸ªäº¤æ˜“å¯¹å’Œå‘¨æœŸ
           for (String symbol : symbols) {
               for (SupportedPeriod period : SupportedPeriod.values()) {
                   // 3. æ‰«ææœªå®Œæˆçš„çª—å£ï¼ˆæ‰«ææ—¶å·²æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼‰
                   List<Long> incompleteWindows = scanIncompleteWindows(symbol, period);
                   
                   // 4. è¡¥é½æ¯ä¸ªçª—å£ï¼ˆå†™å…¥å‰å†æ¬¡æ£€æŸ¥ï¼ŒåŒé‡ä¿è¯ï¼‰
                   for (Long windowStart : incompleteWindows) {
                       // ç¡®ä¿windowStartå·²å¯¹é½åˆ°å‘¨æœŸè¾¹ç•Œ
                       long alignedWindowStart = PeriodCalculator.alignTimestamp(windowStart, period);
                       backfillWindow(symbol, period, alignedWindowStart);
                   }
               }
           }
       }
       
       private void backfillWindow(String symbol, SupportedPeriod period, long windowStart) {
           // ã€å…³é”®ã€‘1. æ£€æŸ¥è¯¥çª—å£çš„èšåˆæ•°æ®æ˜¯å¦å·²å­˜åœ¨
           // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼ˆä¸é‡å¤æ’å…¥ï¼‰
           if (storageService.exists(symbol, period.getPeriod(), windowStart)) {
               log.debug("èšåˆæ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡è¡¥é½: symbol={}, period={}, windowStart={}", 
                   symbol, period.getPeriod(), windowStart);
               return;
           }
           
           // 2. ä»QuestDBè¯»å–è¯¥çª—å£å†…çš„1mæ•°æ®
           long windowEnd = windowStart + period.getDurationMs();
           List<NormalizedKline> klines = queryService.queryKlines(
               symbol, "1m", windowStart, windowEnd
           );
           
           // 3. èšåˆè®¡ç®—
           AggregationBucket bucket = new AggregationBucket(symbol, period, windowStart, windowEnd);
           for (NormalizedKline kline : klines) {
               bucket.update(convertToKlineEvent(kline));
           }
           
           // 4. ç”Ÿæˆèšåˆç»“æœï¼ˆæ—¶é—´æˆ³å¿…é¡»å¯¹é½åˆ°çª—å£èµ·å§‹æ—¶é—´ï¼‰
           if (bucket.getKlineCount() > 0) {
               // ç¡®ä¿æ—¶é—´æˆ³å¯¹é½åˆ°å‘¨æœŸèµ·å§‹æ—¶é—´
               long alignedTimestamp = PeriodCalculator.alignTimestamp(windowStart, period);
               AggregatedKLine aggregated = bucket.toAggregatedKLine();
               // é‡æ–°è®¾ç½®æ—¶é—´æˆ³ï¼Œç¡®ä¿å¯¹é½
               aggregated = new AggregatedKLine(
                   aggregated.symbol(),
                   aggregated.period(),
                   alignedTimestamp,  // å¯¹é½åçš„æ—¶é—´æˆ³
                   aggregated.open(),
                   aggregated.high(),
                   aggregated.low(),
                   aggregated.close(),
                   aggregated.volume(),
                   aggregated.sourceKlineCount()
               );
               
               // 5. å†™å…¥QuestDBï¼ˆå†™å…¥å‰å†æ¬¡æ£€æŸ¥ï¼ŒåŒé‡ä¿è¯å¹‚ç­‰æ€§ï¼‰
               boolean saved = storageService.save(aggregated);
               if (saved) {
                   log.info("å†å²æ•°æ®è¡¥é½æˆåŠŸ: symbol={}, period={}, timestamp={}", 
                       symbol, period.getPeriod(), alignedTimestamp);
               } else {
                   log.warn("å†å²æ•°æ®è¡¥é½è·³è¿‡ï¼ˆå·²å­˜åœ¨ï¼‰: symbol={}, period={}, timestamp={}", 
                       symbol, period.getPeriod(), alignedTimestamp);
               }
               
               // 6. ä¸å‘å¸ƒäº‹ä»¶ï¼ˆé¿å…é‡å¤é€šçŸ¥ä¸‹æ¸¸ï¼‰
           }
       }
   }
   ```

---

## å››ã€æ¥å£è®¾è®¡

### 4.1 KlineAggregatorï¼ˆæ ¸å¿ƒæ¥å£ï¼‰

```java
package com.qyl.v2trade.market.aggregation.core;

import com.qyl.v2trade.market.model.event.KlineEvent;

/**
 * Kçº¿èšåˆå™¨æ¥å£
 */
public interface KlineAggregator {
    
    /**
     * å¤„ç†1m Kçº¿äº‹ä»¶
     * 
     * @param event 1m Kçº¿äº‹ä»¶
     */
    void onKlineEvent(KlineEvent event);
    
    /**
     * è·å–èšåˆç»Ÿè®¡ä¿¡æ¯
     */
    AggregationStats getStats();
    
    /**
     * æ¸…ç†è¿‡æœŸBucketï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
     */
    void cleanupExpiredBuckets();
    
    /**
     * åˆå§‹åŒ–å†å²æ•°æ®è¡¥é½ï¼ˆå¯åŠ¨æ—¶è°ƒç”¨ï¼‰
     * 
     * æ‰«æå¹¶è¡¥é½å¯åŠ¨å‰æœªå®Œæˆçš„èšåˆçª—å£
     * 
     * @param symbols éœ€è¦è¡¥é½çš„äº¤æ˜“å¯¹åˆ—è¡¨ï¼ˆå¦‚æœä¸ºç©ºï¼Œåˆ™è¡¥é½æ‰€æœ‰äº¤æ˜“å¯¹ï¼‰
     */
    void initializeHistoryBackfill(List<String> symbols);
    
    /**
     * è¡¥é½æŒ‡å®šçª—å£çš„å†å²æ•°æ®
     * 
     * @param symbol äº¤æ˜“å¯¹
     * @param period å‘¨æœŸ
     * @param windowStart çª—å£èµ·å§‹æ—¶é—´æˆ³
     */
    void backfillWindow(String symbol, SupportedPeriod period, long windowStart);
}
```

### 4.2 AggregatedKLineStorageServiceï¼ˆå­˜å‚¨æ¥å£ï¼‰

```java
package com.qyl.v2trade.market.aggregation.persistence;

import com.qyl.v2trade.market.aggregation.event.AggregatedKLine;

/**
 * èšåˆKçº¿å­˜å‚¨æœåŠ¡
 */
public interface AggregatedKLineStorageService {
    
    /**
     * å†™å…¥èšåˆKçº¿ï¼ˆå¹‚ç­‰ï¼‰
     * 
     * ã€é‡è¦ã€‘æ•°æ®å”¯ä¸€æ€§ä¿è¯ï¼š
     * - å†™å…¥å‰å¿…é¡»æ£€æŸ¥è¯¥å‘¨æœŸåœ¨è¯¥çº§åˆ«æ˜¯å¦å·²å­˜åœ¨
     * - å¦‚æœå·²å­˜åœ¨ï¼Œç»ä¸å†™å…¥ï¼Œè¿”å›falseï¼ˆä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼Œä¸é‡å¤æ’å…¥ï¼‰
     * - å¦‚æœä¸å­˜åœ¨ï¼Œæ‰§è¡Œå†™å…¥ï¼Œè¿”å›true
     * 
     * ã€é‡è¦ã€‘æ—¶é—´å¯¹é½ä¿è¯ï¼š
     * - ä¼ å…¥çš„aggregatedKLineçš„æ—¶é—´æˆ³å¿…é¡»å·²å¯¹é½åˆ°å‘¨æœŸèµ·å§‹æ—¶é—´
     * - ä½¿ç”¨ PeriodCalculator.alignTimestamp() ç¡®ä¿å¯¹é½
     * 
     * @param aggregatedKLine èšåˆKçº¿ï¼ˆæ—¶é—´æˆ³å¿…é¡»å·²å¯¹é½åˆ°å‘¨æœŸèµ·å§‹æ—¶é—´ï¼‰
     * @return æ˜¯å¦æˆåŠŸå†™å…¥ï¼ˆå¦‚æœå·²å­˜åœ¨è¿”å›falseï¼Œä¸é‡å¤æ’å…¥ï¼‰
     */
    boolean save(AggregatedKLine aggregatedKLine);
    
    /**
     * æ‰¹é‡å†™å…¥ï¼ˆç”¨äºå†å²æ•°æ®å›æ”¾ï¼‰
     */
    int batchSave(List<AggregatedKLine> aggregatedKLines);
    
    /**
     * æ£€æŸ¥æ˜¯å¦å­˜åœ¨
     */
    boolean exists(String symbol, String period, long timestamp);
}
```

### 4.3 AggregationEventPublisherï¼ˆäº‹ä»¶å‘å¸ƒæ¥å£ï¼‰

```java
package com.qyl.v2trade.market.aggregation.event;

import com.qyl.v2trade.market.aggregation.event.AggregatedKLine;

/**
 * èšåˆäº‹ä»¶å‘å¸ƒå™¨
 */
public interface AggregationEventPublisher {
    
    /**
     * å‘å¸ƒèšåˆå®Œæˆäº‹ä»¶
     */
    void publish(AggregatedKLine aggregatedKLine);
}
```

---

## äº”ã€æ•°æ®åº“è®¾è®¡

### 5.1 QuestDBè¡¨ç»“æ„

**è¡¨å‘½åè§„èŒƒ**ï¼š`kline_{period}`

**ç¤ºä¾‹è¡¨**ï¼š

```sql
-- 5åˆ†é’ŸKçº¿è¡¨
CREATE TABLE kline_5m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 15åˆ†é’ŸKçº¿è¡¨
CREATE TABLE kline_15m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 30åˆ†é’ŸKçº¿è¡¨
CREATE TABLE kline_30m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 1å°æ—¶Kçº¿è¡¨
CREATE TABLE kline_1h (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 4å°æ—¶Kçº¿è¡¨
CREATE TABLE kline_4h (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;
```

**ç´¢å¼•è®¾è®¡**ï¼š
- ä¸»é”®ï¼š`(symbol, ts)`ï¼ˆQuestDBè‡ªåŠ¨åˆ›å»ºï¼‰
- æŸ¥è¯¢ä¼˜åŒ–ï¼šæŒ‰symbolå’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢

**å”¯ä¸€çº¦æŸï¼ˆæ•°æ®åº“å±‚é¢ï¼‰**ï¼š
- **çº¦æŸå®šä¹‰**ï¼š`(symbol, ts)` å”¯ä¸€çº¦æŸ
- **å®ç°æ–¹å¼**ï¼š
  - QuestDBå±‚é¢ï¼šé€šè¿‡åº”ç”¨å±‚ä½¿ç”¨UPSERTæˆ–INSERTå‰æ£€æŸ¥å®ç°
  - åº”ç”¨å±‚ï¼šå†™å…¥å‰æ£€æŸ¥ `exists(symbol, period, timestamp)`
  - åŒé‡ä¿è¯ï¼šåº”ç”¨å±‚æ£€æŸ¥ + æ•°æ®åº“å±‚çº¦æŸ
- **çº¦æŸä½œç”¨**ï¼š
  - é˜²æ­¢å¹¶å‘å†™å…¥å¯¼è‡´çš„é‡å¤æ•°æ®
  - ä½œä¸ºåº”ç”¨å±‚æ£€æŸ¥çš„å…œåº•ä¿éšœ
  - ç¡®ä¿æ•°æ®å”¯ä¸€æ€§ï¼ˆæ•°æ®çœŸç†ï¼‰

**Append-Onlyçº¦æŸï¼ˆæ•°æ®åº“å±‚é¢ï¼‰**ï¼š
- **çº¦æŸå®šä¹‰**ï¼šåªå…è®¸INSERTï¼Œä¸å…è®¸UPDATE/DELETE
- **å®ç°æ–¹å¼**ï¼š
  - åº”ç”¨å±‚ï¼šä¸æä¾›update/deleteæ–¹æ³•
  - æ•°æ®åº“å±‚ï¼šåªæ‰§è¡ŒINSERTæ“ä½œï¼Œä¸æ‰§è¡ŒUPDATEæ“ä½œ
  - æƒé™æ§åˆ¶ï¼šå¦‚æœå¯èƒ½ï¼Œåœ¨æ•°æ®åº“å±‚é¢é™åˆ¶UPDATEæƒé™
- **çº¦æŸä½œç”¨**ï¼š
  - ä¿è¯å†å²æ•°æ®ä¸å¯å˜
  - ç¡®ä¿æ•°æ®å®Œæ•´æ€§
  - ç¬¦åˆæ—¶åºæ•°æ®ç‰¹æ€§ï¼ˆappend-onlyï¼‰

**æ—¶é—´å¯¹é½çº¦æŸ**ï¼š
- `ts` å¿…é¡»å¯¹é½åˆ°å‘¨æœŸè¾¹ç•Œï¼ˆä½¿ç”¨ `PeriodCalculator.alignTimestamp()` ç¡®ä¿å¯¹é½ï¼‰
- åº”ç”¨å±‚è´Ÿè´£å¯¹é½ï¼Œæ•°æ®åº“å±‚å­˜å‚¨å¯¹é½åçš„æ—¶é—´æˆ³

**æ•°æ®å”¯ä¸€æ€§ä¿è¯ï¼ˆä¸‰å±‚é˜²æŠ¤ï¼‰**ï¼š
1. **ç¬¬ä¸€å±‚ï¼ˆåº”ç”¨å±‚-æ‰«ææ—¶ï¼‰**ï¼šæ‰«ææœªå®Œæˆçª—å£æ—¶æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
2. **ç¬¬äºŒå±‚ï¼ˆåº”ç”¨å±‚-å†™å…¥å‰ï¼‰**ï¼šå†™å…¥å‰å†æ¬¡æ£€æŸ¥ `exists(symbol, period, timestamp)`
3. **ç¬¬ä¸‰å±‚ï¼ˆæ•°æ®åº“å±‚ï¼‰**ï¼š`(symbol, ts)` å”¯ä¸€çº¦æŸï¼Œé˜²æ­¢å¹¶å‘å†²çª

**æ•°æ®ä¸å¯æ›´æ–°ä¿è¯**ï¼š
1. **åº”ç”¨å±‚**ï¼šä¸æä¾›update/deleteæ–¹æ³•
2. **æ•°æ®åº“å±‚**ï¼šåªæ‰§è¡ŒINSERTæ“ä½œ
3. **æ•°æ®ä¿®æ­£**ï¼šå¦‚æœæ•°æ®é”™è¯¯ï¼Œç”±æ ¡å‡†æ¨¡å—åˆ é™¤åé‡æ–°èšåˆ

**æ³¨æ„**ï¼š
- QuestDBå¯èƒ½ä¸æ”¯æŒä¼ ç»Ÿçš„UNIQUEçº¦æŸè¯­æ³•
- éœ€è¦é€šè¿‡åº”ç”¨å±‚å®ç°å”¯ä¸€æ€§ä¿è¯
- ä½¿ç”¨UPSERTï¼ˆINSERT ... ON CONFLICTï¼‰æˆ–å†™å…¥å‰æ£€æŸ¥å®ç°
- ç¡®ä¿åªæ‰§è¡ŒINSERTæ“ä½œï¼Œä¸æ‰§è¡ŒUPDATEæ“ä½œ

### 5.2 åˆå§‹åŒ–SQL

åˆ›å»º `src/main/resources/sql/kline_aggregation_init.sql`ï¼š

```sql
-- Kçº¿èšåˆè¡¨åˆå§‹åŒ–è„šæœ¬
-- æ³¨æ„ï¼šQuestDBçš„çº¦æŸå®ç°æ–¹å¼ï¼Œé€šè¿‡åº”ç”¨å±‚ä¿è¯å”¯ä¸€æ€§

-- 5åˆ†é’ŸKçº¿è¡¨
-- å”¯ä¸€çº¦æŸï¼š(symbol, ts) - é€šè¿‡åº”ç”¨å±‚å®ç°
CREATE TABLE IF NOT EXISTS kline_5m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 15åˆ†é’ŸKçº¿è¡¨
-- å”¯ä¸€çº¦æŸï¼š(symbol, ts) - é€šè¿‡åº”ç”¨å±‚å®ç°
CREATE TABLE IF NOT EXISTS kline_15m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 30åˆ†é’ŸKçº¿è¡¨
-- å”¯ä¸€çº¦æŸï¼š(symbol, ts) - é€šè¿‡åº”ç”¨å±‚å®ç°
CREATE TABLE IF NOT EXISTS kline_30m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 1å°æ—¶Kçº¿è¡¨
-- å”¯ä¸€çº¦æŸï¼š(symbol, ts) - é€šè¿‡åº”ç”¨å±‚å®ç°
CREATE TABLE IF NOT EXISTS kline_1h (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- 4å°æ—¶Kçº¿è¡¨
-- å”¯ä¸€çº¦æŸï¼š(symbol, ts) - é€šè¿‡åº”ç”¨å±‚å®ç°
CREATE TABLE IF NOT EXISTS kline_4h (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    source_kline_count INT
) TIMESTAMP(ts) PARTITION BY DAY;

-- æ³¨æ„ï¼š
-- 1. QuestDBå¯èƒ½ä¸æ”¯æŒä¼ ç»Ÿçš„UNIQUEçº¦æŸè¯­æ³•
-- 2. å”¯ä¸€æ€§é€šè¿‡åº”ç”¨å±‚ä¿è¯ï¼š
--    - å†™å…¥å‰æ£€æŸ¥ï¼šSELECT COUNT(*) FROM table WHERE symbol = ? AND ts = ?
--    - å¦‚æœå­˜åœ¨åˆ™è·³è¿‡ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥
-- 3. æˆ–è€…ä½¿ç”¨UPSERTè¯­æ³•ï¼ˆå¦‚æœQuestDBæ”¯æŒï¼‰
```

---

## å…­ã€äº‹ä»¶è®¾è®¡

### 6.1 äº‹ä»¶æµ

```
1m KlineEvent (MarketEventBus)
    â†“
KlineEventConsumer (è®¢é˜…)
    â†“
KlineAggregator.onKlineEvent()
    â†“
èšåˆè®¡ç®—
    â†“
çª—å£ç»“æŸï¼Ÿ
    â”œâ”€ å¦ -> æ›´æ–°Bucketï¼Œç­‰å¾…
    â””â”€ æ˜¯ -> ç”ŸæˆAggregatedKLineEvent
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â†“               â†“
   å‘å¸ƒäº‹ä»¶         å†™å…¥QuestDB
   (EventBus)      (å¼‚æ­¥)
```

### 6.2 äº‹ä»¶è®¢é˜…

```java
@Component
public class KlineEventConsumer {
    
    private final KlineAggregator aggregator;
    
    @PostConstruct
    public void subscribe() {
        marketEventBus.subscribe(KlineEvent.class, this::handleKlineEvent);
    }
    
    private void handleKlineEvent(KlineEvent event) {
        // åªå¤„ç†1m Kçº¿
        if ("1m".equals(event.interval())) {
            aggregator.onKlineEvent(event);
        }
    }
}
```

### 6.3 äº‹ä»¶å‘å¸ƒ

```java
@Component
public class AggregationEventPublisherImpl implements AggregationEventPublisher {
    
    private final MarketEventBus eventBus;
    
    @Override
    public void publish(AggregatedKLine aggregatedKLine) {
        eventBus.publish(aggregatedKLine);
    }
}
```

---

## ä¸ƒã€æ€§èƒ½è®¾è®¡

### 7.1 å†…å­˜ç®¡ç†

**Bucketç®¡ç†**ï¼š
- ä½¿ç”¨ `ConcurrentHashMap` å­˜å‚¨æ´»è·ƒBucket
- Keyï¼š`{symbol}_{period}_{windowStart}`
- å®šæœŸæ¸…ç†è¿‡æœŸBucketï¼ˆçª—å£ç»“æŸè¶…è¿‡1å°æ—¶åï¼‰

**å†…å­˜ä¼°ç®—**ï¼š
- å•ä¸ªBucketï¼šçº¦200å­—èŠ‚
- 100ä¸ªäº¤æ˜“å¯¹ Ã— 5ä¸ªå‘¨æœŸ = 500ä¸ªBucket
- æ€»å†…å­˜ï¼šçº¦100KBï¼ˆå¯å¿½ç•¥ï¼‰

### 7.2 å¹¶å‘æ§åˆ¶

**çº¿ç¨‹å®‰å…¨**ï¼š
- `AggregationBucket` ä½¿ç”¨ `synchronized` æˆ– `AtomicReference` ä¿æŠ¤çŠ¶æ€
- `ConcurrentHashMap` ä¿è¯å¹¶å‘å®‰å…¨

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- èšåˆè®¡ç®—æ— é”åŒ–ï¼ˆä½¿ç”¨CASï¼‰
- å†™å…¥QuestDBå¼‚æ­¥åŒ–ï¼ˆä¸é˜»å¡èšåˆæµç¨‹ï¼‰

### 7.3 å»¶è¿Ÿæ§åˆ¶

**ç›®æ ‡**ï¼š
- èšåˆè®¡ç®—å»¶è¿Ÿï¼š< 2ms
- äº‹ä»¶å‘å¸ƒå»¶è¿Ÿï¼š< 1ms
- æ•°æ®åº“å†™å…¥å»¶è¿Ÿï¼š< 50msï¼ˆå¼‚æ­¥ï¼‰

**å®ç°**ï¼š
- èšåˆè®¡ç®—åŒæ­¥æ‰§è¡Œï¼ˆä¿è¯å®æ—¶æ€§ï¼‰
- æ•°æ®åº“å†™å…¥å¼‚æ­¥æ‰§è¡Œï¼ˆä½¿ç”¨çº¿ç¨‹æ± ï¼‰

---

## å…«ã€å¼‚å¸¸å¤„ç†è®¾è®¡

### 8.1 å¼‚å¸¸åœºæ™¯

| åœºæ™¯ | å¤„ç†ç­–ç•¥ |
|------|---------|
| 1mæ•°æ®å»¶è¿Ÿ | ç­‰å¾…ï¼Œä¸æå‰èšåˆï¼ˆçª—å£æœªç»“æŸï¼‰ |
| æ—¶é—´ä¹±åº | æ‹’ç»å¤„ç†ï¼Œè®°å½•æ—¥å¿—ï¼ˆç”±æ ¡å‡†æ¨¡å—ä¿®å¤ï¼‰ |
| é‡å¤1mæ•°æ® | å¿½ç•¥ï¼ˆBucketå·²åŒ…å«è¯¥æ—¶é—´æˆ³ï¼‰ |
| çª—å£ç¼ºå¤±æ•°æ® | æ­£å¸¸èšåˆï¼ˆä¸å¼ºåˆ¶å®Œæ•´æ€§æ£€æŸ¥ï¼‰ |
| QuestDBå†™å…¥å¤±è´¥ | é‡è¯•3æ¬¡ï¼Œå¤±è´¥åè®°å½•æ—¥å¿—ï¼Œä¸å½±å“åç»­èšåˆ |
| å†…å­˜æº¢å‡º | æ¸…ç†è¿‡æœŸBucketï¼Œè®°å½•å‘Šè­¦ |
| å¯åŠ¨æ—¶å†å²æ•°æ®ç¼ºå¤± | ä»QuestDBè¯»å–1mæ•°æ®è¡¥é½ï¼Œå¦‚æœ1mæ•°æ®ä¹Ÿä¸å­˜åœ¨åˆ™è·³è¿‡ï¼ˆç”±æ ¡å‡†æ¨¡å—è´Ÿè´£ï¼‰ |
| å¯åŠ¨æ—¶åˆå§‹åŒ–å¤±è´¥ | è®°å½•é”™è¯¯æ—¥å¿—ï¼Œç»§ç»­å¯åŠ¨ï¼Œä¸å½±å“å®æ—¶èšåˆ |
| èšåˆæ•°æ®é”™è¯¯ | ä¸æ›´æ–°ï¼Œç”±æ ¡å‡†æ¨¡å—åˆ é™¤åé‡æ–°èšåˆï¼ˆAppend-OnlyåŸåˆ™ï¼‰ |
| å°è¯•æ›´æ–°èšåˆæ•°æ® | æ‹’ç»ï¼Œè®°å½•æ—¥å¿—ï¼Œä¸æä¾›updateæ¥å£ |

### 8.2 ç›‘æ§æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**ï¼š
- èšåˆå»¶è¿Ÿï¼ˆP50, P95, P99ï¼‰
- èšåˆæˆåŠŸç‡
- å†™å…¥å¤±è´¥ç‡
- å†…å­˜ä½¿ç”¨é‡
- æ´»è·ƒBucketæ•°é‡

**å‘Šè­¦è§„åˆ™**ï¼š
- èšåˆå»¶è¿Ÿ > 10msï¼šå‘Šè­¦
- å†™å…¥å¤±è´¥ç‡ > 1%ï¼šå‘Šè­¦
- å†…å­˜ä½¿ç”¨ > 10MBï¼šå‘Šè­¦

---

## ä¹ã€æµ‹è¯•è®¾è®¡

### 9.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•ç±»**ï¼š
- `KlineAggregatorTest` - èšåˆé€»è¾‘æµ‹è¯•
- `PeriodCalculatorTest` - çª—å£è®¡ç®—æµ‹è¯•
- `AggregationBucketTest` - BucketçŠ¶æ€æ›´æ–°æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
1. æ­£å¸¸èšåˆæµç¨‹ï¼ˆ5mçª—å£èšåˆ5æ ¹1m Kçº¿ï¼‰
2. çª—å£è¾¹ç•Œè®¡ç®—ï¼ˆæ—¶é—´æˆ³å¯¹é½ï¼‰
3. OHLCVè®¡ç®—æ­£ç¡®æ€§
4. çª—å£ç»“æŸåˆ¤æ–­
5. é‡å¤æ•°æ®å»é‡
6. å¤šå‘¨æœŸå¹¶å‘èšåˆ

### 9.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. ç«¯åˆ°ç«¯æµç¨‹ï¼š1mäº‹ä»¶ -> èšåˆ -> äº‹ä»¶å‘å¸ƒ -> æ•°æ®åº“å†™å…¥
2. å†å²æ•°æ®å›æ”¾ï¼šæ‰¹é‡1mæ•°æ® -> æ‰¹é‡èšåˆ
3. å¼‚å¸¸æ¢å¤ï¼šé‡å¯åç»§ç»­èšåˆï¼ˆä¸é‡å¤ï¼‰

### 9.3 æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡**ï¼š
- å•symbolèšåˆååé‡ï¼š> 1000 events/s
- èšåˆå»¶è¿Ÿï¼šP99 < 2ms
- å†…å­˜å ç”¨ï¼š< 10MBï¼ˆ100ä¸ªäº¤æ˜“å¯¹ï¼‰

---

## åã€ä»»åŠ¡æ‹†è§£

### Phase 1: åŸºç¡€æ¶æ„æ­å»ºï¼ˆ2å¤©ï¼‰

#### ä»»åŠ¡1.1ï¼šåˆ›å»ºåŒ…ç»“æ„å’ŒåŸºç¡€ç±»
- [ ] åˆ›å»º `aggregation` åŒ…ç»“æ„
- [ ] åˆ›å»º `AggregatedKLine` äº‹ä»¶æ¨¡å‹
- [ ] åˆ›å»º `SupportedPeriod` æšä¸¾
- [ ] åˆ›å»º `PeriodCalculator` å·¥å…·ç±»
- **éªŒæ”¶æ ‡å‡†**ï¼šç±»ç»“æ„å®Œæ•´ï¼Œç¼–è¯‘é€šè¿‡

#### ä»»åŠ¡1.2ï¼šå®ç°AggregationBucket
- [ ] å®ç°BucketçŠ¶æ€ç®¡ç†ï¼ˆopen/high/low/close/volumeï¼‰
- [ ] å®ç°èšåˆæ›´æ–°é€»è¾‘
- [ ] å®ç°çª—å£ç»“æŸåˆ¤æ–­
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šæµ‹è¯•è¦†ç›–ç‡ > 80%

#### ä»»åŠ¡1.3ï¼šå®ç°PeriodCalculator
- [ ] å®ç°çª—å£èµ·å§‹æ—¶é—´è®¡ç®—
- [ ] å®ç°çª—å£ç»“æŸæ—¶é—´è®¡ç®—
- [ ] å®ç°æ—¶é—´æˆ³å¯¹é½é€»è¾‘
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šæ‰€æœ‰å‘¨æœŸè®¡ç®—æ­£ç¡®

### Phase 2: æ ¸å¿ƒèšåˆé€»è¾‘ï¼ˆ3.5å¤©ï¼‰

#### ä»»åŠ¡2.1ï¼šå®ç°KlineAggregatoræ ¸å¿ƒé€»è¾‘
- [ ] å®ç°Bucketç®¡ç†ï¼ˆåˆ›å»º/æŸ¥æ‰¾/æ¸…ç†ï¼‰
- [ ] å®ç°1mäº‹ä»¶å¤„ç†æµç¨‹
- [ ] å®ç°å¤šå‘¨æœŸå¹¶å‘èšåˆ
- [ ] å®ç°å»é‡æœºåˆ¶
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šèšåˆé€»è¾‘æ­£ç¡®ï¼Œæµ‹è¯•é€šè¿‡

#### ä»»åŠ¡2.2ï¼šå®ç°äº‹ä»¶è®¢é˜…å’Œå‘å¸ƒ
- [ ] å®ç° `KlineEventConsumer`ï¼ˆè®¢é˜…1mäº‹ä»¶ï¼‰
- [ ] å®ç° `AggregationEventPublisher`ï¼ˆå‘å¸ƒèšåˆäº‹ä»¶ï¼‰
- [ ] é›†æˆ `MarketEventBus`
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šäº‹ä»¶æµæ­£å¸¸ï¼Œæ— ä¸¢å¤±

#### ä»»åŠ¡2.3ï¼šå®ç°å†…å­˜ç®¡ç†å’Œæ¸…ç†
- [ ] å®ç°è¿‡æœŸBucketæ¸…ç†æœºåˆ¶
- [ ] å®ç°å®šæ—¶æ¸…ç†ä»»åŠ¡
- [ ] å®ç°å†…å­˜ç›‘æ§
- **éªŒæ”¶æ ‡å‡†**ï¼šå†…å­˜ç¨³å®šï¼Œæ— æ³„æ¼

#### ä»»åŠ¡2.4ï¼šå®ç°å¯åŠ¨æ—¶å†å²æ•°æ®è¡¥é½
- [ ] å®ç°çª—å£æ‰«æé€»è¾‘ï¼ˆæ‰«ææœªå®Œæˆçš„çª—å£ï¼‰
- [ ] å®ç°å†å²æ•°æ®è¯»å–ï¼ˆä»QuestDBè¯»å–1mæ•°æ®ï¼‰
- [ ] å®ç°å†å²æ•°æ®èšåˆï¼ˆæ‰¹é‡èšåˆï¼‰
- [ ] å®ç°åˆå§‹åŒ–é…ç½®ï¼ˆå¯é…ç½®æ‰«æèŒƒå›´ã€æ˜¯å¦å¯ç”¨ç­‰ï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šå¯åŠ¨æ—¶èƒ½æ­£ç¡®è¡¥é½å†å²æ•°æ®ï¼Œä¸äº§ç”Ÿé‡å¤èšåˆ

### Phase 3: æŒä¹…åŒ–å±‚ï¼ˆ2å¤©ï¼‰

#### ä»»åŠ¡3.1ï¼šåˆ›å»ºQuestDBè¡¨ç»“æ„
- [ ] ç¼–å†™è¡¨åˆå§‹åŒ–SQLï¼ˆ5ä¸ªå‘¨æœŸè¡¨ï¼‰
- [ ] æ‰§è¡ŒSQLåˆ›å»ºè¡¨
- [ ] éªŒè¯è¡¨ç»“æ„
- **éªŒæ”¶æ ‡å‡†**ï¼šæ‰€æœ‰è¡¨åˆ›å»ºæˆåŠŸ

#### ä»»åŠ¡3.2ï¼šå®ç°AggregatedKLineStorageService
- [ ] å®ç°å•æ¡å†™å…¥ï¼ˆå¹‚ç­‰ï¼‰
- [ ] å®ç°æ‰¹é‡å†™å…¥
- [ ] å®ç°å­˜åœ¨æ€§æ£€æŸ¥
- [ ] å®ç°å¼‚æ­¥å†™å…¥ï¼ˆçº¿ç¨‹æ± ï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šå†™å…¥æ­£ç¡®ï¼Œå¹‚ç­‰æ€§ä¿è¯

#### ä»»åŠ¡3.3ï¼šé›†æˆå­˜å‚¨æœåŠ¡
- [ ] åœ¨èšåˆå®Œæˆåè°ƒç”¨å­˜å‚¨æœåŠ¡
- [ ] å®ç°å†™å…¥å¤±è´¥é‡è¯•
- [ ] å®ç°å†™å…¥ç›‘æ§
- **éªŒæ”¶æ ‡å‡†**ï¼šæ•°æ®æ­£ç¡®å†™å…¥QuestDB

### Phase 4: é›†æˆå’Œä¼˜åŒ–ï¼ˆ2å¤©ï¼‰

#### ä»»åŠ¡4.1ï¼šé›†æˆåˆ°MarketDataCenter
- [ ] é…ç½®Spring Bean
- [ ] å¯åŠ¨æ—¶è‡ªåŠ¨è®¢é˜…äº‹ä»¶
- [ ] å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œå†å²æ•°æ®è¡¥é½
- [ ] éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
- [ ] éªŒè¯å¯åŠ¨æ—¶å†å²æ•°æ®è¡¥é½åŠŸèƒ½
- **éªŒæ”¶æ ‡å‡†**ï¼šå®æ—¶èšåˆæ­£å¸¸å·¥ä½œï¼Œå¯åŠ¨æ—¶å†å²æ•°æ®è¡¥é½æ­£å¸¸

#### ä»»åŠ¡4.2ï¼šæ€§èƒ½ä¼˜åŒ–
- [ ] ä¼˜åŒ–å¹¶å‘æ§åˆ¶ï¼ˆæ— é”åŒ–ï¼‰
- [ ] ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- [ ] ä¼˜åŒ–æ•°æ®åº“å†™å…¥ï¼ˆæ‰¹é‡ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šæ»¡è¶³æ€§èƒ½æŒ‡æ ‡

#### ä»»åŠ¡4.3ï¼šå¼‚å¸¸å¤„ç†å’Œç›‘æ§
- [ ] å®ç°å¼‚å¸¸å¤„ç†é€»è¾‘
- [ ] å®ç°ç›‘æ§æŒ‡æ ‡æ”¶é›†
- [ ] å®ç°å‘Šè­¦è§„åˆ™
- **éªŒæ”¶æ ‡å‡†**ï¼šå¼‚å¸¸åœºæ™¯å¤„ç†æ­£ç¡®

### Phase 5: æµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ2å¤©ï¼‰

#### ä»»åŠ¡5.1ï¼šå®Œæ•´æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•è¡¥å……
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å¼‚å¸¸åœºæ™¯æµ‹è¯•
- **éªŒæ”¶æ ‡å‡†**ï¼šæµ‹è¯•è¦†ç›–ç‡ > 85%

#### ä»»åŠ¡5.2ï¼šå†å²æ•°æ®å›æ”¾æ”¯æŒ
- [ ] å®ç°æ‰¹é‡èšåˆæ¥å£
- [ ] å®ç°å›æ”¾å·¥å…·
- [ ] æµ‹è¯•å›æ”¾åŠŸèƒ½
- **éªŒæ”¶æ ‡å‡†**ï¼šå†å²æ•°æ®å¯æ­£ç¡®èšåˆ

#### ä»»åŠ¡5.3ï¼šæ–‡æ¡£å®Œå–„
- [ ] æ›´æ–°æ¶æ„æ–‡æ¡£
- [ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£
- [ ] ç¼–å†™è¿ç»´æ–‡æ¡£
- **éªŒæ”¶æ ‡å‡†**ï¼šæ–‡æ¡£å®Œæ•´æ¸…æ™°

---

## åä¸€ã€éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [x] æ”¯æŒ5ä¸ªå‘¨æœŸèšåˆï¼ˆ5m, 15m, 30m, 1h, 4hï¼‰
- [x] å®æ—¶èšåˆå»¶è¿Ÿ < 2ms
- [x] èšåˆæ­£ç¡®ç‡ 100%
- [x] æ•°æ®æ­£ç¡®å†™å…¥QuestDB
- [x] äº‹ä»¶æ­£ç¡®å‘å¸ƒ
- [x] æ”¯æŒå†å²æ•°æ®å›æ”¾
- [x] å¯åŠ¨æ—¶å†å²æ•°æ®è¡¥é½æ­£å¸¸ï¼ˆè¡¥é½å¯åŠ¨å‰æœªå®Œæˆçš„çª—å£ï¼‰
- [x] æ•°æ®å”¯ä¸€æ€§ä¿è¯ï¼ˆä¸é‡å¤æ’å…¥ï¼‰
- [x] æ•°æ®ä¸å¯æ›´æ–°ï¼ˆAppend-Onlyï¼Œä¸æä¾›updateæ¥å£ï¼‰

### æ€§èƒ½éªŒæ”¶

- [x] å•symbolèšåˆååé‡ > 1000 events/s
- [x] èšåˆå»¶è¿Ÿ P99 < 2ms
- [x] æ•°æ®åº“å†™å…¥å»¶è¿Ÿ < 50msï¼ˆå¼‚æ­¥ï¼‰
- [x] å†…å­˜å ç”¨ < 10MBï¼ˆ100ä¸ªäº¤æ˜“å¯¹ï¼‰

### ç¨³å®šæ€§éªŒæ”¶

- [x] é‡å¯åä¸äº§ç”Ÿé‡å¤èšåˆ
- [x] å¼‚å¸¸åœºæ™¯å¤„ç†æ­£ç¡®
- [x] æ— å†…å­˜æ³„æ¼
- [x] ç›‘æ§æŒ‡æ ‡æ­£å¸¸

---

## åäºŒã€åç»­æ‰©å±•

### å¯æ‰©å±•ç‚¹

1. **æ–°å¢å‘¨æœŸ**ï¼šåªéœ€åœ¨ `SupportedPeriod` ä¸­æ·»åŠ æšä¸¾å€¼
2. **è‡ªå®šä¹‰èšåˆè§„åˆ™**ï¼šå¯æ‰©å±• `AggregationStrategy` æ¥å£
3. **èšåˆæŒ‡æ ‡**ï¼šå¯æ‰©å±•æ”¯æŒæ›´å¤šæŒ‡æ ‡ï¼ˆå¦‚VWAPï¼‰
4. **åˆ†å¸ƒå¼èšåˆ**ï¼šå¯æ‰©å±•æ”¯æŒå¤šå®ä¾‹èšåˆï¼ˆéœ€è¦çŠ¶æ€åŒæ­¥ï¼‰

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**ï¼š2025-01-15

