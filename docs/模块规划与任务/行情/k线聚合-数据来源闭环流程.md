# 📊 K线聚合模块 - 数据来源闭环流程

> **版本**：v1.0  
> **状态**：设计文档  
> **基于文档**：`k线聚合-设计开发规范.md`、`行情模块架构档案.md`

---

## 📋 目录

1. [流程总览](#一流程总览)
2. [详细流程说明](#二详细流程说明)
3. [数据流向图](#三数据流向图)
4. [关键节点说明](#四关键节点说明)
5. [数据一致性保证](#五数据一致性保证)

---

## 一、流程总览

### 1.1 完整闭环流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据来源闭环流程                                │
└─────────────────────────────────────────────────────────────────┘

【数据来源层】
OKX交易所 WebSocket
    ↓
行情订阅模块 (ExchangeWebSocketManager → KlineChannel)
    ↓
MarketEventBus (事件总线)
    ↓
┌─────────────────────────────────────────────────────────────────┐
│                   1m K线数据流                                    │
└─────────────────────────────────────────────────────────────────┘
    ↓
MarketDataCenter (行情数据中心)
    ↓
QuestDB (kline_1m表) ← 【唯一可信的1m数据源】
    ↓
┌─────────────────────────────────────────────────────────────────┐
│                   聚合处理层                                      │
└─────────────────────────────────────────────────────────────────┘
    ↓
K线聚合模块 (KlineAggregator)
    ├─ 实时聚合：订阅1m K线事件 → 聚合 → 写入
    └─ 历史补齐：从kline_1m读取 → 聚合 → 写入
    ↓
QuestDB (kline_5m, kline_15m, kline_30m, kline_1h, kline_4h)
    ↓
┌─────────────────────────────────────────────────────────────────┐
│                   数据消费层                                      │
└─────────────────────────────────────────────────────────────────┘
    ↓
策略模块 / 前端 / 风控模块
    ↓
┌─────────────────────────────────────────────────────────────────┐
│                   数据校准层（保障数据完整性）                      │
└─────────────────────────────────────────────────────────────────┘
    ↓
行情校准模块 (MarketCalibration)
    ├─ 检测缺失：扫描kline_1m表，发现缺失
    └─ 补齐数据：从OKX API拉取 → 写入kline_1m
    ↓
（回到1m数据流，形成闭环）
```

### 1.2 核心数据流

| 数据流 | 来源 | 目标 | 说明 |
|--------|------|------|------|
| **1m实时数据流** | OKX WebSocket | QuestDB (kline_1m) | 实时订阅，持续写入 |
| **1m历史数据流** | OKX REST API | QuestDB (kline_1m) | 校准模块补齐缺失数据 |
| **聚合实时流** | MarketEventBus (1m事件) | QuestDB (多周期表) | 实时聚合，窗口结束时写入 |
| **聚合历史流** | QuestDB (kline_1m) | QuestDB (多周期表) | 启动时补齐，历史回放 |
| **查询流** | QuestDB | 策略/前端 | 通过REST API查询 |

---

## 二、详细流程说明

### 2.1 阶段1：数据来源 → 1m K线存储

**流程**：

```
1. OKX交易所 WebSocket
   └─ 推送实时K线数据（candle1m频道）

2. 行情订阅模块
   ├─ ExchangeWebSocketManager：管理WebSocket连接
   ├─ ChannelRouter：路由消息到KlineChannel
   └─ KlineChannel：解析消息，转换为KlineEvent

3. MarketEventBus（事件总线）
   └─ 异步发布KlineEvent（解耦订阅和处理）

4. MarketDataCenter（行情数据中心）
   ├─ 订阅MarketEventBus的KlineEvent
   ├─ 去重处理（内存去重）
   └─ 调用QuestDbMarketStorageService写入

5. QuestDB (kline_1m表)
   └─ 存储1m K线数据（唯一可信的1m数据源）
```

**关键点**：
- ✅ 1m K线数据是**唯一可信源**，所有聚合都基于此
- ✅ 使用事件总线解耦，保证实时性
- ✅ 内存去重 + 数据库幂等写入，保证数据唯一性

---

### 2.2 阶段2：1m数据 → 多周期聚合

#### 2.2.1 实时聚合流程

**流程**：

```
1. KlineEventConsumer（事件消费者）
   ├─ 订阅MarketEventBus的KlineEvent
   └─ 过滤：只处理interval="1m"的事件

2. KlineAggregator（聚合器）
   ├─ 接收1m KlineEvent
   ├─ 计算该K线所属的聚合窗口（每个周期：5m, 15m, 30m, 1h, 4h）
   ├─ 找到或创建对应的AggregationBucket
   ├─ 更新Bucket状态（OHLCV）
   └─ 判断窗口是否结束

3. 窗口结束时
   ├─ 生成AggregatedKLine事件
   ├─ 时间戳对齐到周期起始时间
   ├─ 写入前检查：如果已存在，跳过（数据唯一性保证）
   ├─ 如果不存在，写入QuestDB（异步）
   └─ 发布AggregatedKLineEvent到MarketEventBus

4. QuestDB（多周期表）
   ├─ kline_5m
   ├─ kline_15m
   ├─ kline_30m
   ├─ kline_1h
   └─ kline_4h
```

**关键点**：
- ✅ 实时聚合：窗口结束时立即生成聚合结果
- ✅ 多周期并发：同时聚合5个周期
- ✅ 时间对齐：所有时间戳对齐到周期起始时间
- ✅ 数据唯一性：写入前检查，不重复插入

#### 2.2.2 历史数据补齐流程

**流程**：

```
1. 系统启动时
   └─ KlineAggregatorInitializer.initialize()

2. 扫描未完成的窗口
   ├─ 对于每个交易对和每个周期
   ├─ 扫描最近24小时内的未完成窗口
   └─ 检查每个窗口是否已有聚合数据

3. 对于未完成的窗口
   ├─ 检查：如果已存在，跳过（第一层检查）
   ├─ 从QuestDB (kline_1m) 读取该窗口内的所有1m数据
   ├─ 创建AggregationBucket
   ├─ 遍历1m数据，更新Bucket
   └─ 生成聚合结果

4. 写入QuestDB
   ├─ 时间戳对齐到窗口起始时间
   ├─ 写入前再次检查：如果已存在，跳过（第二层检查）
   └─ 如果不存在，执行写入（第三层：数据库唯一约束）

5. 不发布事件
   └─ 避免重复通知下游
```

**关键点**：
- ✅ 启动时自动补齐：确保启动前未完成的窗口被补齐
- ✅ 双重检查：扫描时检查 + 写入前检查
- ✅ 从1m数据源读取：保证数据来源的唯一性
- ✅ 不发布事件：避免重复通知

---

### 2.3 阶段3：聚合数据 → 数据消费

**流程**：

```
1. 策略模块 / 前端 / 风控模块
   └─ 通过REST API查询聚合K线数据

2. MarketDataController（查询控制器）
   └─ 提供REST API接口

3. QuestDbMarketQueryService（查询服务）
   ├─ 从QuestDB查询多周期K线数据
   └─ 支持时间范围查询、最新K线查询等

4. QuestDB（多周期表）
   └─ 返回查询结果
```

**关键点**：
- ✅ 统一查询接口：通过REST API提供查询
- ✅ 支持多周期查询：5m, 15m, 30m, 1h, 4h
- ✅ 高性能查询：QuestDB时序数据库优化

---

### 2.4 阶段4：数据校准（保障数据完整性）

**流程**：

```
1. MarketCalibrationScheduler（校准调度器）
   └─ 定时扫描（每10分钟）

2. MissingDataExecutor（缺失检测执行器）
   ├─ 扫描kline_1m表，检测缺失的K线
   └─ 记录缺失的时间戳

3. HistoricalKlineFetcher（历史数据拉取器）
   ├─ 从OKX REST API拉取缺失的1m K线数据
   └─ 转换为NormalizedKline

4. QuestDbMarketStorageService（存储服务）
   └─ 写入QuestDB (kline_1m表)

5. 触发聚合（可选）
   └─ 如果补齐了1m数据，可以触发重新聚合
```

**关键点**：
- ✅ 保障1m数据完整性：校准模块负责补齐缺失的1m数据
- ✅ 独立运行：校准模块与实时订阅完全解耦
- ✅ 幂等执行：支持重复执行，不会产生重复数据

---

## 三、数据流向图

### 3.1 完整数据流向

```
┌─────────────────────────────────────────────────────────────────────┐
│                        数据来源层                                    │
└─────────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
            ┌───────▼───────┐   ┌──────▼──────┐
            │ OKX WebSocket  │   │ OKX REST API│
            │ (实时订阅)     │   │ (历史补齐)  │
            └───────┬───────┘   └──────┬──────┘
                    │                   │
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │ 行情订阅模块       │
                    │ KlineChannel      │
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │ MarketEventBus    │
                    │ (事件总线)        │
                    └─────────┬─────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼────────┐   ┌────────▼────────┐   ┌───────▼────────┐
│MarketDataCenter│   │KlineAggregator  │   │MarketCalibration│
│ (1m存储)       │   │ (聚合处理)      │   │ (数据校准)      │
└───────┬────────┘   └────────┬────────┘   └───────┬────────┘
        │                     │                     │
        │                     │                     │
┌───────▼────────┐   ┌────────▼────────┐   ┌───────▼────────┐
│ QuestDB        │   │ QuestDB          │   │ QuestDB        │
│ kline_1m       │   │ kline_5m/15m等  │   │ kline_1m       │
│ (唯一可信源)   │   │ (聚合结果)      │   │ (补齐数据)     │
└───────┬────────┘   └────────┬────────┘   └─────────────────┘
        │                     │
        │                     │
        └──────────┬──────────┘
                   │
        ┌──────────▼──────────┐
        │ 数据消费层           │
        │ 策略/前端/风控       │
        └─────────────────────┘
```

### 3.2 实时聚合数据流

```
实时1m K线事件流：

OKX WebSocket
    ↓
KlineChannel (解析)
    ↓
MarketEventBus (发布KlineEvent)
    ↓
    ├─→ MarketDataCenter → QuestDB (kline_1m) [存储1m数据]
    │
    └─→ KlineEventConsumer → KlineAggregator
                                ↓
                        计算聚合窗口
                                ↓
                        更新AggregationBucket
                                ↓
                        窗口结束？
                                ├─ 否 → 继续等待
                                └─ 是 → 生成AggregatedKLine
                                          ↓
                                   写入QuestDB (多周期表)
                                          ↓
                                   发布AggregatedKLineEvent
```

### 3.3 历史数据补齐流

```
启动时历史数据补齐流：

系统启动
    ↓
KlineAggregatorInitializer.initialize()
    ↓
扫描未完成的窗口
    ↓
对于每个未完成的窗口：
    ├─ 检查：是否已存在聚合数据？
    │   ├─ 是 → 跳过
    │   └─ 否 → 继续
    │
    ├─ 从QuestDB (kline_1m) 读取1m数据
    │
    ├─ 聚合计算
    │
    ├─ 生成聚合结果（时间戳对齐）
    │
    └─ 写入QuestDB（写入前再次检查）
```

---

## 四、关键节点说明

### 4.1 数据来源节点

| 节点 | 说明 | 数据格式 |
|------|------|---------|
| **OKX WebSocket** | 实时K线数据源 | candle1m频道，JSON格式 |
| **OKX REST API** | 历史数据源（校准用） | REST API，JSON格式 |

### 4.2 数据存储节点

| 节点 | 说明 | 数据内容 |
|------|------|---------|
| **QuestDB (kline_1m)** | 1m K线数据存储 | 唯一可信的1m数据源 |
| **QuestDB (kline_5m)** | 5分钟聚合K线 | 从kline_1m聚合生成 |
| **QuestDB (kline_15m)** | 15分钟聚合K线 | 从kline_1m聚合生成 |
| **QuestDB (kline_30m)** | 30分钟聚合K线 | 从kline_1m聚合生成 |
| **QuestDB (kline_1h)** | 1小时聚合K线 | 从kline_1m聚合生成 |
| **QuestDB (kline_4h)** | 4小时聚合K线 | 从kline_1m聚合生成 |

### 4.3 数据处理节点

| 节点 | 说明 | 职责 |
|------|------|------|
| **MarketDataCenter** | 行情数据中心 | 接收1m K线事件，写入kline_1m表 |
| **KlineAggregator** | K线聚合器 | 从1m数据聚合生成多周期K线 |
| **MarketCalibration** | 行情校准模块 | 检测和补齐缺失的1m数据 |

### 4.4 数据消费节点

| 节点 | 说明 | 查询方式 |
|------|------|---------|
| **策略模块** | 策略决策 | REST API查询多周期K线 |
| **前端** | 前端展示 | REST API查询多周期K线 |
| **风控模块** | 风控计算 | REST API查询多周期K线 |

---

## 五、数据一致性保证

### 5.1 数据唯一性保证（三层防护）

| 层级 | 检查时机 | 实现方式 | 作用 |
|------|---------|---------|------|
| **第一层** | 扫描未完成窗口时 | `exists(symbol, period, timestamp)` | 提前过滤已存在的窗口 |
| **第二层** | 写入前 | `exists(symbol, period, timestamp)` | 写入前再次检查 |
| **第三层** | 数据库层面 | `(symbol, ts)` 唯一约束 | 防止并发冲突 |

### 5.2 数据完整性保证

| 保障机制 | 说明 | 实现方式 |
|---------|------|---------|
| **1m数据完整性** | 校准模块检测和补齐缺失的1m数据 | MissingDataExecutor |
| **聚合数据完整性** | 启动时补齐未完成的聚合窗口 | KlineAggregatorInitializer |
| **时间对齐保证** | 所有时间戳对齐到周期起始时间 | PeriodCalculator.alignTimestamp() |

### 5.3 数据不可更新保证（Append-Only）

| 原则 | 说明 | 实现方式 |
|------|------|---------|
| **只允许插入** | 聚合K线一旦写入，绝不更新 | 不提供update方法 |
| **历史数据不可变** | 已聚合的K线是历史事实 | Append-Only模式 |
| **数据修正** | 如果数据错误，删除后重新聚合 | 由校准模块负责 |

---

## 六、关键设计原则

### 6.1 单一可信源原则

- ✅ **1m K线是唯一可信源**：所有聚合都基于kline_1m表的数据
- ✅ **不直接订阅多周期**：所有多周期K线都从1m数据聚合生成
- ✅ **保证数据一致性**：避免多数据源导致的不一致

### 6.2 事件驱动原则

- ✅ **解耦订阅和处理**：通过MarketEventBus解耦
- ✅ **异步处理**：不阻塞WebSocket IO线程
- ✅ **可扩展**：易于添加新的消费者

### 6.3 幂等性原则

- ✅ **写入前检查**：避免重复插入
- ✅ **数据库唯一约束**：防止并发冲突
- ✅ **支持重复执行**：校准、补齐等操作可重复执行

### 6.4 Append-Only原则

- ✅ **历史数据不可变**：已聚合的K线不可更新
- ✅ **只允许插入**：不提供update/delete方法
- ✅ **数据修正**：删除后重新聚合

---

## 七、数据流时序图

### 7.1 实时聚合时序

```
时间轴 →

OKX WebSocket ──┐
                │
KlineChannel ───┼──→ MarketEventBus ──┐
                │                      │
                │                      ├─→ MarketDataCenter ──→ QuestDB (kline_1m)
                │                      │
                │                      └─→ KlineEventConsumer ──→ KlineAggregator
                │                                                      │
                │                                                      ├─→ 更新Bucket
                │                                                      │
                │                                                      └─→ 窗口结束？
                │                                                           │
                │                                                           ├─→ 生成聚合结果
                │                                                           │
                │                                                           └─→ 写入QuestDB (多周期表)
                │
                └──→ (持续推送)
```

### 7.2 启动时历史补齐时序

```
时间轴 →

系统启动
    │
    └─→ KlineAggregatorInitializer.initialize()
            │
            ├─→ 扫描未完成的窗口
            │       │
            │       └─→ 检查：是否已存在？
            │               │
            │               ├─→ 是 → 跳过
            │               │
            │               └─→ 否 → 从QuestDB (kline_1m) 读取
            │                           │
            │                           └─→ 聚合计算
            │                                   │
            │                                   └─→ 写入QuestDB (多周期表)
            │
            └─→ 开始实时聚合
```

---

## 八、数据闭环验证

### 8.1 闭环验证点

| 验证点 | 验证内容 | 验证方式 |
|--------|---------|---------|
| **1m数据完整性** | kline_1m表数据是否完整 | 校准模块检测缺失 |
| **聚合数据完整性** | 多周期表数据是否完整 | 启动时补齐未完成窗口 |
| **数据一致性** | 聚合数据是否正确 | 对比1m数据与聚合结果 |
| **数据唯一性** | 是否重复插入 | 写入前检查 + 数据库约束 |
| **时间对齐** | 时间戳是否对齐 | 使用PeriodCalculator验证 |

### 8.2 数据质量保证

| 质量指标 | 目标 | 保障机制 |
|---------|------|---------|
| **数据完整性** | 100% | 校准模块 + 启动时补齐 |
| **数据唯一性** | 100% | 三层防护机制 |
| **数据准确性** | 100% | 从唯一可信源聚合 |
| **时间对齐** | 100% | PeriodCalculator对齐 |

---

## 九、总结

### 9.1 核心流程

1. **数据来源**：OKX WebSocket → 行情订阅模块 → MarketEventBus
2. **1m存储**：MarketDataCenter → QuestDB (kline_1m)
3. **聚合处理**：KlineAggregator → QuestDB (多周期表)
4. **数据消费**：REST API → 策略/前端/风控
5. **数据校准**：MarketCalibration → 补齐缺失数据 → 回到1m存储

### 9.2 关键特性

- ✅ **单一可信源**：1m K线是唯一可信源
- ✅ **事件驱动**：通过事件总线解耦
- ✅ **幂等性**：三层防护保证数据唯一性
- ✅ **Append-Only**：历史数据不可变
- ✅ **自动补齐**：启动时自动补齐未完成窗口

### 9.3 数据流向总结

```
数据来源（OKX）
    ↓
1m存储（QuestDB kline_1m）← 【唯一可信源】
    ↓
聚合处理（KlineAggregator）
    ↓
多周期存储（QuestDB kline_5m/15m等）
    ↓
数据消费（策略/前端/风控）
    ↓
数据校准（MarketCalibration）→ 回到1m存储（闭环）
```

---

**文档维护者**：开发团队  
**最后更新**：2025-01-15

