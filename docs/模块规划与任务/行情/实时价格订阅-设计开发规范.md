# ğŸ“ å®æ—¶ä»·æ ¼è®¢é˜…æ¨¡å— - è®¾è®¡å¼€å‘è§„èŒƒ

> **ç‰ˆæœ¬**ï¼šv1.0  
> **çŠ¶æ€**ï¼šè®¾è®¡é˜¶æ®µ  
> **æ‰€å±ç³»ç»Ÿ**ï¼šè¡Œæƒ…æ•°æ®ä¸­å¿ƒï¼ˆMarket Data Centerï¼‰  
> **åŸºäºæ–‡æ¡£**ï¼š`è®¢é˜…ä»·æ ¼.md`ï¼ˆäº§å“è§„èŒƒï¼‰

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#æ ¸å¿ƒè®¾è®¡åŸåˆ™)
2. [æŠ€æœ¯æ¶æ„è®¾è®¡](#ä¸€æŠ€æœ¯æ¶æ„è®¾è®¡)
3. [æ•°æ®æ¨¡å‹è®¾è®¡](#äºŒæ•°æ®æ¨¡å‹è®¾è®¡)
4. [æ¥å£è®¾è®¡](#ä¸‰æ¥å£è®¾è®¡)
5. [äº‹ä»¶è®¾è®¡](#å››äº‹ä»¶è®¾è®¡)
6. [æ€§èƒ½è®¾è®¡](#äº”æ€§èƒ½è®¾è®¡)
7. [å¼‚å¸¸å¤„ç†è®¾è®¡](#å…­å¼‚å¸¸å¤„ç†è®¾è®¡)
8. [æµ‹è¯•è®¾è®¡](#ä¸ƒæµ‹è¯•è®¾è®¡)
9. [ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ](#å…«ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ)
10. [éªŒæ”¶æ ‡å‡†](#ä¹éªŒæ”¶æ ‡å‡†)
11. [è®¾è®¡åº•çº¿å£°æ˜](#åè®¾è®¡åº•çº¿å£°æ˜)

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### åŸåˆ™1ï¼šå•ä¸€èŒè´£ï¼ˆOnly One Thingï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼šå®æ—¶ä»·æ ¼è®¢é˜…æ¨¡å—åªåšä¸€ä»¶äº‹â€”â€”ç»´æŠ¤æœ€æ–°ä»·æ ¼çŠ¶æ€

**è®¾è®¡çº¦æŸ**ï¼š
- âœ… **åªç»´æŠ¤å†…å­˜çŠ¶æ€**ï¼šä¸å†™å…¥æ•°æ®åº“ï¼Œä¸å†™å…¥ç¼“å­˜
- âœ… **åªå‘å¸ƒäº‹ä»¶**ï¼šä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œä¸è¿›è¡Œä»·æ ¼è®¡ç®—
- âœ… **åªæä¾›æŸ¥è¯¢æ¥å£**ï¼šæä¾›åŒæ­¥æŸ¥è¯¢æœ€æ–°ä»·æ ¼çš„æ–¹æ³•
- âŒ **ä¸è´Ÿè´£å­˜å‚¨å†å²**ï¼šå†å²ä»·æ ¼ç”±Kçº¿ç³»ç»Ÿè´Ÿè´£
- âŒ **ä¸è´Ÿè´£è®¡ç®—**ï¼šä¸è®¡ç®—æ¶¨è·Œã€ä¸è®¡ç®—æŒ‡æ ‡
- âŒ **ä¸è´Ÿè´£ç­–ç•¥**ï¼šä¸è§¦å‘äº¤æ˜“ã€ä¸æ‰§è¡Œé£æ§

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// âœ… æ­£ç¡®ï¼šåªç»´æŠ¤æœ€æ–°çŠ¶æ€ï¼Œä¸å­˜å‚¨å†å²
public class LatestPriceService {
    // å†…å­˜çŠ¶æ€ï¼šConcurrentHashMap<String, LatestPrice>
    // åªæä¾› getLatestPrice(symbol) æ–¹æ³•
}

// âŒ é”™è¯¯ï¼šä¸è¦æ·»åŠ å­˜å‚¨åŠŸèƒ½
// public void saveToDatabase(PriceTick tick) { ... }  // ä¸å…è®¸
```

### åŸåˆ™2ï¼šæœ€æ–°è¦†ç›–ï¼ˆLatest-Winsï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼šååˆ°çš„ä»·æ ¼è¦†ç›–å…ˆåˆ°çš„ä»·æ ¼ï¼Œæ—¶é—´æˆ³æ—§çš„æ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒ

**å®ç°æœºåˆ¶**ï¼š
- âœ… **æ—¶é—´æˆ³è¿‡æ»¤**ï¼šæ—¶é—´æˆ³æ—§äºå½“å‰ç¼“å­˜ â†’ ä¸¢å¼ƒ
- âœ… **æ— é˜»å¡å¤„ç†**ï¼šæ¶ˆæ¯å¤„ç†å¿…é¡»æ— é˜»å¡ï¼Œå¿«é€Ÿå®Œæˆ
- âœ… **ä¸ç­‰å¾…æ’åº**ï¼šä¸åšé‡æ’ã€ä¸åšç­‰å¾…ã€ä¸åšè¡¥æ‹‰
- âœ… **åªå¤„ç†æœ€æ–°**ï¼šåªå¤„ç†æœ€æ–°æ¶ˆæ¯ï¼Œä¿è¯å®æ—¶æ€§

**ä»£ç ç¤ºä¾‹**ï¼š
```java
public void updatePrice(PriceTick tick) {
    LatestPrice current = priceCache.get(tick.symbol());
    
    // æ—¶é—´æˆ³è¿‡æ»¤ï¼šæ—§æ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒ
    if (current != null && tick.timestamp() < current.timestamp()) {
        log.debug("ä¸¢å¼ƒæ—§ä»·æ ¼: symbol={}, oldTimestamp={}, newTimestamp={}", 
                tick.symbol(), current.timestamp(), tick.timestamp());
        return;
    }
    
    // æ›´æ–°æœ€æ–°ä»·æ ¼ï¼ˆååˆ°è¦†ç›–å‰åˆ°ï¼‰
    priceCache.put(tick.symbol(), new LatestPrice(tick.symbol(), tick.price(), tick.timestamp()));
    
    // å‘å¸ƒäº‹ä»¶
    eventBus.publish(new PriceChangedEvent(tick.symbol(), tick.price(), tick.timestamp()));
}
```

### åŸåˆ™3ï¼šå†…å­˜å”¯ä¸€çŠ¶æ€ï¼ˆMemory-Onlyï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼šæœ€æ–°ä»·æ ¼çŠ¶æ€ä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¸æŒä¹…åŒ–

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… **ä»…å†…å­˜å­˜å‚¨**ï¼šä½¿ç”¨ ConcurrentHashMap ç»´æŠ¤çŠ¶æ€
- âœ… **åº”ç”¨é‡å¯ä¸¢å¤±**ï¼šåº”ç”¨é‡å¯åçŠ¶æ€ä¸¢å¤±ï¼Œé€šè¿‡WebSocketé‡æ–°è®¢é˜…æ¢å¤
- âŒ **ä¸å†™å…¥æ•°æ®åº“**ï¼šä¸å†™å…¥QuestDBã€MySQL
- âŒ **ä¸å†™å…¥ç¼“å­˜**ï¼šä¸å†™å…¥Redisï¼ˆé¿å…ä¸å¿…è¦çš„å»¶è¿Ÿï¼‰

**åŸå› **ï¼š
- å†å²ä»·å€¼ä¸ºé›¶ï¼ˆå·²æœ‰Kçº¿ç³»ç»Ÿï¼‰
- ä¿è¯æ¨¡å—æç®€ä¸é«˜æ€§èƒ½
- é™ä½ç³»ç»Ÿå¤æ‚åº¦

---

## ä¸€ã€æŠ€æœ¯æ¶æ„è®¾è®¡

### 1.1 æ¨¡å—åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è®¢é˜…å±‚ (Subscription)             â”‚
â”‚  - PriceChannel (ä»·æ ¼é¢‘é“)              â”‚
â”‚  - ChannelRouter (è·¯ç”±ï¼Œå¤ç”¨ç°æœ‰)        â”‚
â”‚  - ExchangeWebSocketManager (å¤ç”¨ç°æœ‰)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        äº‹ä»¶å±‚ (Event)                    â”‚
â”‚  - PriceTick (å†…éƒ¨äº‹ä»¶)                 â”‚
â”‚  - PriceChangedEvent (å¯¹å¤–äº‹ä»¶)         â”‚
â”‚  - MarketEventBus (å¤ç”¨ç°æœ‰)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æœåŠ¡å±‚ (Service)                  â”‚
â”‚  - LatestPriceService (æœ€æ–°ä»·æ ¼æœåŠ¡)     â”‚
â”‚  - PriceSubscriptionService (è®¢é˜…æœåŠ¡)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ¥å£å±‚ (API)                      â”‚
â”‚  - PriceQueryService (æŸ¥è¯¢æ¥å£)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åŒ…ç»“æ„è®¾è®¡

```
com.qyl.v2trade.market.subscription
â”œâ”€â”€ collector/
â”‚   â”œâ”€â”€ channel/
â”‚   â”‚   â”œâ”€â”€ MarketChannel.java (æ¥å£ï¼Œå·²æœ‰)
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚       â”œâ”€â”€ KlineChannel.java (å·²æœ‰)
â”‚   â”‚       â””â”€â”€ PriceChannel.java (æ–°å¢) â­
â”‚   â”œâ”€â”€ eventbus/
â”‚   â”‚   â””â”€â”€ MarketEventBus.java (æ¥å£ï¼Œå·²æœ‰)
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ ChannelRouter.java (è·¯ç”±ï¼Œå·²æœ‰ï¼Œéœ€æ‰©å±•)
â”‚   â””â”€â”€ websocket/
â”‚       â””â”€â”€ ExchangeWebSocketManager.java (å·²æœ‰)
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ LatestPriceService.java (æ–°å¢) â­
â”‚   â””â”€â”€ PriceQueryService.java (æ–°å¢) â­
â””â”€â”€ model/
    â””â”€â”€ event/
        â”œâ”€â”€ KlineEvent.java (å·²æœ‰)
        â”œâ”€â”€ PriceTick.java (æ–°å¢) â­
        â””â”€â”€ PriceChangedEvent.java (æ–°å¢) â­
```

### 1.3 ä¸ç°æœ‰æ¨¡å—çš„é›†æˆ

**å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**ï¼š
- âœ… **ChannelRouter**ï¼šå¤ç”¨è·¯ç”±æœºåˆ¶ï¼Œæ³¨å†ŒPriceChannel
- âœ… **ExchangeWebSocketManager**ï¼šå¤ç”¨WebSocketè¿æ¥ç®¡ç†
- âœ… **MarketEventBus**ï¼šå¤ç”¨äº‹ä»¶æ€»çº¿ï¼ˆéœ€æ‰©å±•æ”¯æŒPriceChangedEventï¼‰
- âœ… **MarketDataCenter**ï¼šå¤ç”¨è®¢é˜…é…ç½®åŠ è½½æœºåˆ¶

**ç‹¬ç«‹æ¨¡å—**ï¼š
- â­ **LatestPriceService**ï¼šç‹¬ç«‹çš„æœ€æ–°ä»·æ ¼æœåŠ¡
- â­ **PriceQueryService**ï¼šç‹¬ç«‹çš„æŸ¥è¯¢æ¥å£
- â­ **PriceChannel**ï¼šç‹¬ç«‹çš„ä»·æ ¼é¢‘é“å¤„ç†å™¨

---

## äºŒã€æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 PriceTickï¼ˆå†…éƒ¨äº‹ä»¶ï¼‰

**ç”¨é€”**ï¼šåœ¨è®¢é˜…æ¨¡å—å†…éƒ¨ä¼ é€’ä»·æ ¼æ•°æ®ï¼Œä»WebSocketæ¶ˆæ¯è§£æè€Œæ¥

**å®šä¹‰**ï¼š
```java
package com.qyl.v2trade.market.model.event;

import java.math.BigDecimal;

/**
 * å®æ—¶ä»·æ ¼Tickäº‹ä»¶ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
 * 
 * <p>ç”¨äºåœ¨è®¢é˜…æ¨¡å—å†…éƒ¨ä¼ é€’ä»·æ ¼æ•°æ®ï¼Œä»WebSocketæ¶ˆæ¯è§£æè€Œæ¥ã€‚
 * ä¸å¯¹å¤–æš´éœ²ï¼Œä»…ç”¨äºæ¨¡å—å†…éƒ¨æµè½¬ã€‚
 *
 * @author qyl
 */
public record PriceTick(
    /**
     * äº¤æ˜“å¯¹ç¬¦å·ï¼ˆäº¤æ˜“æ‰€æ ¼å¼ï¼Œå¦‚ï¼šBTC-USDT-SWAPï¼‰
     */
    String symbol,
    
    /**
     * å½“å‰æœ€æ–°æˆäº¤ä»·
     */
    BigDecimal price,
    
    /**
     * äº¤æ˜“æ‰€æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
     */
    long timestamp,
    
    /**
     * è¡Œæƒ…æ¥æºï¼ˆå¦‚ï¼šOKXï¼‰
     */
    String source
) {
    /**
     * åˆ›å»º PriceTick å®ä¾‹
     */
    public static PriceTick of(String symbol, BigDecimal price, long timestamp, String source) {
        return new PriceTick(symbol, price, timestamp, source);
    }
}
```

**ç‰¹æ€§**ï¼š
- é«˜é¢‘ï¼šæ¯ç§’å¯èƒ½æ”¶åˆ°å¤šæ¡
- æ— å†å²è¯­ä¹‰ï¼šåªä»£è¡¨"æ­¤åˆ»"çš„ä»·æ ¼
- ååˆ°è¦†ç›–å‰åˆ°ï¼ˆLatest-Winsï¼‰

### 2.2 LatestPriceï¼ˆçŠ¶æ€æ¨¡å‹ï¼‰

**ç”¨é€”**ï¼šç»´æŠ¤æ¯ä¸ªäº¤æ˜“å¯¹çš„æœ€æ–°ä»·æ ¼çŠ¶æ€

**å®šä¹‰**ï¼š
```java
package com.qyl.v2trade.market.subscription.service;

import java.math.BigDecimal;

/**
 * æœ€æ–°ä»·æ ¼çŠ¶æ€ï¼ˆä¸å¯å˜ï¼‰
 * 
 * <p>ç”¨äºåœ¨å†…å­˜ä¸­ç»´æŠ¤æ¯ä¸ªäº¤æ˜“å¯¹çš„æœ€æ–°ä»·æ ¼çŠ¶æ€ã€‚
 *
 * @author qyl
 */
public record LatestPrice(
    /**
     * äº¤æ˜“å¯¹ç¬¦å·
     */
    String symbol,
    
    /**
     * æœ€æ–°ä»·æ ¼
     */
    BigDecimal price,
    
    /**
     * æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
     */
    long timestamp
) {
    /**
     * åˆ›å»º LatestPrice å®ä¾‹
     */
    public static LatestPrice of(String symbol, BigDecimal price, long timestamp) {
        return new LatestPrice(symbol, price, timestamp);
    }
}
```

**å­˜å‚¨æ–¹å¼**ï¼š
- ä½¿ç”¨ `ConcurrentHashMap<String, LatestPrice>` å­˜å‚¨
- Keyï¼šäº¤æ˜“å¯¹ç¬¦å·ï¼ˆå¦‚ï¼šBTC-USDT-SWAPï¼‰
- Valueï¼šLatestPriceå®ä¾‹

### 2.3 PriceChangedEventï¼ˆå¯¹å¤–äº‹ä»¶ï¼‰

**ç”¨é€”**ï¼šå¯¹å¤–å‘å¸ƒä»·æ ¼å˜æ›´äº‹ä»¶ï¼Œä¾›ç­–ç•¥ã€é£æ§ç­‰æ¨¡å—è®¢é˜…

**å®šä¹‰**ï¼š
```java
package com.qyl.v2trade.market.model.event;

import java.math.BigDecimal;

/**
 * ä»·æ ¼å˜æ›´äº‹ä»¶ï¼ˆå¯¹å¤–å‘å¸ƒï¼‰
 * 
 * <p>ç”¨äºå‘ç³»ç»Ÿå…¶ä»–æ¨¡å—å‘å¸ƒä»·æ ¼å˜æ›´é€šçŸ¥ã€‚
 * è®¢é˜…è€…ï¼šç­–ç•¥æ¨¡å—ã€é£æ§æ¨¡å—ã€å‰ç«¯å±•ç¤ºç­‰ã€‚
 *
 * @author qyl
 */
public record PriceChangedEvent(
    /**
     * äº¤æ˜“å¯¹ç¬¦å·
     */
    String symbol,
    
    /**
     * æœ€æ–°ä»·æ ¼
     */
    BigDecimal price,
    
    /**
     * æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
     */
    long timestamp
) {
    /**
     * åˆ›å»º PriceChangedEvent å®ä¾‹
     */
    public static PriceChangedEvent of(String symbol, BigDecimal price, long timestamp) {
        return new PriceChangedEvent(symbol, price, timestamp);
    }
}
```

**äº‹ä»¶è¯­ä¹‰**ï¼š
- **å«ä¹‰**ï¼š"è¯¥äº¤æ˜“å¯¹çš„æœ€æ–°ä»·æ ¼å·²æ›´æ–°"
- **ä¸åŒ…å«**ï¼šæ¶¨è·Œåˆ¤æ–­ã€é˜ˆå€¼åˆ¤æ–­ã€ç­–ç•¥å«ä¹‰

---

## ä¸‰ã€æ¥å£è®¾è®¡

### 3.1 PriceChannelï¼ˆMarketChannelå®ç°ï¼‰

**æ¥å£**ï¼šå®ç° `MarketChannel` æ¥å£ï¼ˆå¤ç”¨ç°æœ‰æ¥å£ï¼‰

**èŒè´£**ï¼š
- è§£æOKX tickeræ¶ˆæ¯
- è½¬æ¢ä¸ºPriceTickäº‹ä»¶
- å‘å¸ƒåˆ°MarketEventBus

**å…³é”®æ–¹æ³•**ï¼š

```java
public class PriceChannel implements MarketChannel {
    
    @Override
    public String channelType() {
        return CHANNEL_TYPE_PRICE; // æ–°å¢å¸¸é‡
    }
    
    @Override
    public String buildSubscribeRaw(Set<String> symbols) {
        // æ„å»ºè®¢é˜…æ¶ˆæ¯ï¼š{"op":"subscribe","args":[{"channel":"ticker","instId":"BTC-USDT-SWAP"}]}
    }
    
    @Override
    public String buildUnsubscribeRaw(Set<String> symbols) {
        // æ„å»ºå–æ¶ˆè®¢é˜…æ¶ˆæ¯
    }
    
    @Override
    public void onMessage(String rawJson) {
        // è§£æOKX tickeræ¶ˆæ¯
        // è½¬æ¢ä¸ºPriceTick
        // å‘å¸ƒåˆ°EventBus
    }
}
```

**OKX Tickeræ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
  "arg": {
    "channel": "ticker",
    "instId": "BTC-USDT-SWAP"
  },
  "data": [{
    "instId": "BTC-USDT-SWAP",
    "last": "42000.5",
    "ts": "1710000000000"
  }]
}
```

**è§£æè§„åˆ™**ï¼š
- `data[0].last` â†’ priceï¼ˆæœ€æ–°æˆäº¤ä»·ï¼‰
- `data[0].ts` â†’ timestampï¼ˆæ—¶é—´æˆ³ï¼‰
- `arg.instId` â†’ symbolï¼ˆäº¤æ˜“å¯¹ç¬¦å·ï¼‰

### 3.2 LatestPriceServiceï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰

**èŒè´£**ï¼š
- ç»´æŠ¤å†…å­˜æœ€æ–°ä»·æ ¼çŠ¶æ€
- å¤„ç†PriceTickäº‹ä»¶
- å‘å¸ƒPriceChangedEventäº‹ä»¶

**æ¥å£å®šä¹‰**ï¼š

```java
package com.qyl.v2trade.market.subscription.service;

import com.qyl.v2trade.market.model.event.PriceTick;
import java.math.BigDecimal;
import java.util.Optional;

/**
 * æœ€æ–°ä»·æ ¼æœåŠ¡
 * 
 * <p>ç»´æŠ¤æ¯ä¸ªäº¤æ˜“å¯¹çš„æœ€æ–°ä»·æ ¼çŠ¶æ€ï¼ˆä»…å†…å­˜ï¼‰ã€‚
 *
 * @author qyl
 */
public interface LatestPriceService {
    
    /**
     * æ›´æ–°ä»·æ ¼ï¼ˆå¤„ç†PriceTickäº‹ä»¶ï¼‰
     * 
     * <p>è§„åˆ™ï¼š
     * <ul>
     *   <li>æ—¶é—´æˆ³æ—§äºå½“å‰ç¼“å­˜ â†’ ä¸¢å¼ƒ</li>
     *   <li>æ—¶é—´æˆ³æ–°äºæˆ–ç­‰äºå½“å‰ç¼“å­˜ â†’ æ›´æ–°</li>
     *   <li>æ›´æ–°åå‘å¸ƒPriceChangedEvent</li>
     * </ul>
     * 
     * @param tick PriceTickäº‹ä»¶
     */
    void updatePrice(PriceTick tick);
    
    /**
     * è·å–æœ€æ–°ä»·æ ¼ï¼ˆåŒæ­¥æŸ¥è¯¢ï¼‰
     * 
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     * @return LatestPriceï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›Optional.empty()
     */
    Optional<LatestPrice> getLatestPrice(String symbol);
    
    /**
     * è·å–æœ€æ–°ä»·æ ¼ï¼ˆåŒæ­¥æŸ¥è¯¢ï¼Œç®€åŒ–ç‰ˆï¼‰
     * 
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     * @return ä»·æ ¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›null
     */
    BigDecimal getPrice(String symbol);
    
    /**
     * è·å–æ‰€æœ‰äº¤æ˜“å¯¹çš„æœ€æ–°ä»·æ ¼
     * 
     * @return æ‰€æœ‰äº¤æ˜“å¯¹çš„æœ€æ–°ä»·æ ¼Map
     */
    Map<String, LatestPrice> getAllLatestPrices();
    
    /**
     * æ¸…é™¤æŒ‡å®šäº¤æ˜“å¯¹çš„ä»·æ ¼ï¼ˆç”¨äºå–æ¶ˆè®¢é˜…ï¼‰
     * 
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     */
    void removePrice(String symbol);
}
```

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `ConcurrentHashMap<String, LatestPrice>` å­˜å‚¨
- çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨ConcurrentHashMapä¿è¯å¹¶å‘å®‰å…¨
- æ—¶é—´æˆ³è¿‡æ»¤ï¼šæ—§æ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒ
- äº‹ä»¶å‘å¸ƒï¼šæ›´æ–°åå‘å¸ƒPriceChangedEvent

### 3.3 PriceQueryServiceï¼ˆæŸ¥è¯¢æ¥å£ï¼‰

**èŒè´£**ï¼šå¯¹å¤–æä¾›ä»·æ ¼æŸ¥è¯¢æ¥å£

**æ¥å£å®šä¹‰**ï¼š

```java
package com.qyl.v2trade.market.subscription.service;

import java.math.BigDecimal;
import java.util.Map;
import java.util.Optional;

/**
 * ä»·æ ¼æŸ¥è¯¢æœåŠ¡ï¼ˆå¯¹å¤–æ¥å£ï¼‰
 * 
 * <p>æä¾›åŒæ­¥æŸ¥è¯¢æœ€æ–°ä»·æ ¼çš„æ¥å£ï¼Œä¾›ç­–ç•¥ã€é£æ§ç­‰æ¨¡å—ä½¿ç”¨ã€‚
 *
 * @author qyl
 */
public interface PriceQueryService {
    
    /**
     * è·å–æœ€æ–°ä»·æ ¼
     * 
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     * @return æœ€æ–°ä»·æ ¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›Optional.empty()
     */
    Optional<BigDecimal> getLatestPrice(String symbol);
    
    /**
     * è·å–æœ€æ–°ä»·æ ¼ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
     * 
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     * @return LatestPriceï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›Optional.empty()
     */
    Optional<LatestPrice> getLatestPriceWithTimestamp(String symbol);
    
    /**
     * æ‰¹é‡è·å–æœ€æ–°ä»·æ ¼
     * 
     * @param symbols äº¤æ˜“å¯¹ç¬¦å·é›†åˆ
     * @return ä»·æ ¼Mapï¼ˆsymbol -> priceï¼‰ï¼Œä¸å­˜åœ¨çš„äº¤æ˜“å¯¹ä¸ä¼šå‡ºç°åœ¨Mapä¸­
     */
    Map<String, BigDecimal> getLatestPrices(Set<String> symbols);
    
    /**
     * æ£€æŸ¥äº¤æ˜“å¯¹æ˜¯å¦æœ‰ä»·æ ¼æ•°æ®
     * 
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     * @return trueè¡¨ç¤ºæœ‰ä»·æ ¼æ•°æ®
     */
    boolean hasPrice(String symbol);
}
```

**å®ç°æ–¹å¼**ï¼š
- å§”æ‰˜ç»™LatestPriceService
- æä¾›ç®€åŒ–æ¥å£ï¼Œéšè—å†…éƒ¨å®ç°

### 3.4 ChannelRouteræ‰©å±•

**æ‰©å±•ç‚¹**ï¼šåœ¨ `ChannelRouter.extractChannelType()` æ–¹æ³•ä¸­å¢åŠ tickeré¢‘é“è¯†åˆ«

```java
private String extractChannelType(JsonNode root) {
    JsonNode argNode = root.path("arg");
    if (!argNode.has("channel")) {
        return null;
    }

    String channel = argNode.get("channel").asText();

    // æ ¹æ® channel å‰ç¼€åˆ¤æ–­é¢‘é“ç±»å‹
    if (channel.startsWith("candle")) {
        return MarketChannel.CHANNEL_TYPE_KLINE;
    } else if ("ticker".equals(channel)) {
        return MarketChannel.CHANNEL_TYPE_PRICE; // â­ æ–°å¢
    } else if ("trades".equals(channel)) {
        return MarketChannel.CHANNEL_TYPE_TRADE;
    } else if (channel.startsWith("books")) {
        return MarketChannel.CHANNEL_TYPE_ORDERBOOK;
    }

    return null;
}
```

**MarketChannelå¸¸é‡æ‰©å±•**ï¼š
```java
public interface MarketChannel {
    String CHANNEL_TYPE_KLINE = "KLINE";
    String CHANNEL_TYPE_PRICE = "PRICE"; // â­ æ–°å¢
    String CHANNEL_TYPE_TICKER = "TICKER";
    String CHANNEL_TYPE_TRADE = "TRADE";
    String CHANNEL_TYPE_ORDERBOOK = "ORDERBOOK";
}
```

---

## å››ã€äº‹ä»¶è®¾è®¡

### 4.1 äº‹ä»¶æµ

```
WebSocket Message (ticker)
        â†“
PriceChannel.onMessage()
        â†“
è§£æ â†’ PriceTick
        â†“
PriceEventBus.publish(PriceTick)  // ä½¿ç”¨ç‹¬ç«‹çš„äº‹ä»¶æ€»çº¿
        â†“
LatestPriceService.updatePrice()
        â†“
æ›´æ–°å†…å­˜çŠ¶æ€ï¼ˆConcurrentHashMapï¼‰
        â†“
Spring EventPublisher.publish(PriceChangedEvent)  // å¯¹å¤–å‘å¸ƒäº‹ä»¶
        â†“
å¤–éƒ¨è®¢é˜…è€…ï¼ˆç­–ç•¥ã€é£æ§ã€å‰ç«¯ç­‰ï¼‰
```

### 4.2 äº‹ä»¶æ€»çº¿è®¾è®¡

**å†…éƒ¨äº‹ä»¶ï¼ˆPriceTickï¼‰**ï¼š
- ä½¿ç”¨ç°æœ‰çš„ `MarketEventBus`ï¼ˆéœ€è¦æ‰©å±•æ”¯æŒPriceTickï¼‰
- æˆ–è€…åˆ›å»ºç‹¬ç«‹çš„ `PriceEventBus`ï¼ˆæ¨èï¼Œä¿æŒç‹¬ç«‹æ€§ï¼‰

**å¯¹å¤–äº‹ä»¶ï¼ˆPriceChangedEventï¼‰**ï¼š
- ä½¿ç”¨Springçš„ `ApplicationEventPublisher`
- å®ç°å¼‚æ­¥äº‹ä»¶å‘å¸ƒï¼Œä¸é˜»å¡ä»·æ ¼æ›´æ–°æµç¨‹

**äº‹ä»¶æ€»çº¿æ‰©å±•æ–¹æ¡ˆï¼ˆæ¨èï¼‰**ï¼š

**æ–¹æ¡ˆ1ï¼šæ‰©å±•MarketEventBusï¼ˆä¸æ¨èï¼‰**
- éœ€è¦ä¿®æ”¹ç°æœ‰æ¥å£ï¼Œå½±å“Kçº¿è®¢é˜…
- è¿åå•ä¸€èŒè´£åŸåˆ™

**æ–¹æ¡ˆ2ï¼šåˆ›å»ºPriceEventBusï¼ˆæ¨èï¼‰â­**
- ç‹¬ç«‹çš„äº‹ä»¶æ€»çº¿ï¼Œä¸“é—¨å¤„ç†ä»·æ ¼äº‹ä»¶
- ä¿æŒæ¨¡å—ç‹¬ç«‹æ€§
- ä¸å½±å“ç°æœ‰Kçº¿è®¢é˜…

```java
package com.qyl.v2trade.market.subscription.collector.eventbus;

import com.qyl.v2trade.market.model.event.PriceTick;
import java.util.function.Consumer;

/**
 * ä»·æ ¼äº‹ä»¶æ€»çº¿æ¥å£ï¼ˆç‹¬ç«‹ï¼‰
 */
public interface PriceEventBus {
    void publish(PriceTick tick);
    void subscribe(Consumer<PriceTick> consumer);
    void unsubscribe(Consumer<PriceTick> consumer);
}
```

### 4.3 äº‹ä»¶å‘å¸ƒæ—¶æœº

**PriceChangedEventå‘å¸ƒè§„åˆ™**ï¼š
- âœ… **ä»·æ ¼æ›´æ–°æ—¶å‘å¸ƒ**ï¼šæ¯æ¬¡æ›´æ–°å†…å­˜çŠ¶æ€åç«‹å³å‘å¸ƒ
- âœ… **å¼‚æ­¥å‘å¸ƒ**ï¼šä½¿ç”¨Springå¼‚æ­¥äº‹ä»¶å‘å¸ƒï¼Œä¸é˜»å¡
- âœ… **åªå‘å¸ƒå˜æ›´**ï¼šå¦‚æœä»·æ ¼æœªå˜åŒ–ï¼ˆæ—¶é—´æˆ³è¿‡æ»¤ï¼‰ï¼Œä¸å‘å¸ƒäº‹ä»¶

**å‘å¸ƒä»£ç ç¤ºä¾‹**ï¼š
```java
public void updatePrice(PriceTick tick) {
    LatestPrice current = priceCache.get(tick.symbol());
    
    // æ—¶é—´æˆ³è¿‡æ»¤
    if (current != null && tick.timestamp() < current.timestamp()) {
        return; // ä¸å‘å¸ƒäº‹ä»¶
    }
    
    // æ›´æ–°çŠ¶æ€
    LatestPrice latest = LatestPrice.of(tick.symbol(), tick.price(), tick.timestamp());
    priceCache.put(tick.symbol(), latest);
    
    // å‘å¸ƒäº‹ä»¶ï¼ˆå¼‚æ­¥ï¼‰
    eventPublisher.publishEvent(PriceChangedEvent.of(tick.symbol(), tick.price(), tick.timestamp()));
}
```

---

## äº”ã€æ€§èƒ½è®¾è®¡

### 5.1 æ€§èƒ½è¦æ±‚ï¼ˆéªŒæ”¶çº§ï¼‰

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| å•æ¡å¤„ç†è€—æ—¶ | < 1ms |
| å†…å­˜åˆ†é… | é›¶æˆ–æä½ |
| ä¸¢åŒ…å®¹å¿ | å¯ |
| é¡ºåºä¿è¯ | ä¸è¦æ±‚ |
| é‡è¿èƒ½åŠ› | å¿…é¡» |

### 5.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**å†…å­˜ä¼˜åŒ–**ï¼š
- âœ… ä½¿ç”¨ `ConcurrentHashMap`ï¼šO(1)æŸ¥æ‰¾å’Œæ›´æ–°
- âœ… ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ï¼ˆrecordï¼‰ï¼šå‡å°‘å¯¹è±¡åˆ›å»º
- âœ… é¿å…ä¸å¿…è¦çš„å¯¹è±¡åˆ†é…ï¼šé‡ç”¨PriceTickå¯¹è±¡ï¼ˆå¦‚æœéœ€è¦ï¼‰

**å¤„ç†ä¼˜åŒ–**ï¼š
- âœ… æ—¶é—´æˆ³è¿‡æ»¤ï¼šå¿«é€Ÿä¸¢å¼ƒæ—§æ¶ˆæ¯ï¼Œé¿å…æ— æ•ˆå¤„ç†
- âœ… æ— é˜»å¡å¤„ç†ï¼šæ‰€æœ‰æ“ä½œå¿…é¡»æ— é˜»å¡
- âœ… å¼‚æ­¥äº‹ä»¶å‘å¸ƒï¼šä½¿ç”¨Springå¼‚æ­¥äº‹ä»¶ï¼Œä¸é˜»å¡ä»·æ ¼æ›´æ–°

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// âœ… é«˜æ•ˆï¼šç›´æ¥æ›´æ–°ï¼Œæ— é¢å¤–å¯¹è±¡åˆ›å»º
public void updatePrice(PriceTick tick) {
    LatestPrice current = priceCache.get(tick.symbol());
    
    // å¿«é€Ÿè¿‡æ»¤ï¼ˆO(1)ï¼‰
    if (current != null && tick.timestamp() < current.timestamp()) {
        return;
    }
    
    // ç›´æ¥æ›´æ–°ï¼ˆO(1)ï¼‰
    priceCache.put(tick.symbol(), LatestPrice.of(tick.symbol(), tick.price(), tick.timestamp()));
    
    // å¼‚æ­¥å‘å¸ƒï¼ˆä¸é˜»å¡ï¼‰
    eventPublisher.publishEvent(...);
}
```

---

## å…­ã€å¼‚å¸¸å¤„ç†è®¾è®¡

### 6.1 å¼‚å¸¸åœºæ™¯ä¸å¤„ç†ç­–ç•¥

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| WebSocketæ–­è¿ | è‡ªåŠ¨é‡è¿ï¼ˆå¤ç”¨ExchangeWebSocketManagerï¼‰ |
| æ¶ˆæ¯ä¹±åº | æ—¶é—´æˆ³è¦†ç›–ï¼ˆæ—§æ¶ˆæ¯ä¸¢å¼ƒï¼‰ |
| é«˜é¢‘æŠ–åŠ¨ | åŸæ ·é€ä¼ ï¼ˆä¸åšè¿‡æ»¤ï¼‰ |
| è¡Œæƒ…ä¸­æ–­ | ä¿ç•™æœ€åä»·æ ¼ |
| æ¶ˆæ¯è§£æå¤±è´¥ | è®°å½•æ—¥å¿—ï¼Œè·³è¿‡è¯¥æ¶ˆæ¯ |
| ä»·æ ¼å¼‚å¸¸å€¼ | è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œç»§ç»­å¤„ç† |

### 6.2 å¼‚å¸¸å¤„ç†ä»£ç ç¤ºä¾‹

```java
@Override
public void onMessage(String rawJson) {
    try {
        // è§£ææ¶ˆæ¯
        JsonNode root = objectMapper.readTree(rawJson);
        
        // æå–ä»·æ ¼æ•°æ®
        BigDecimal price = extractPrice(root);
        long timestamp = extractTimestamp(root);
        String symbol = extractSymbol(root);
        
        // ä»·æ ¼éªŒè¯ï¼ˆå¯é€‰ï¼‰
        if (price == null || price.compareTo(BigDecimal.ZERO) <= 0) {
            log.warn("ä»·æ ¼å¼‚å¸¸ï¼Œè·³è¿‡: symbol={}, price={}", symbol, price);
            return;
        }
        
        // åˆ›å»ºPriceTickå¹¶å‘å¸ƒ
        PriceTick tick = PriceTick.of(symbol, price, timestamp, "OKX");
        priceEventBus.publish(tick);
        
    } catch (Exception e) {
        log.error("å¤„ç†ä»·æ ¼æ¶ˆæ¯å¤±è´¥: {}", rawJson, e);
        // å¼‚å¸¸éš”ç¦»ï¼šå•ä¸ªæ¶ˆæ¯å¼‚å¸¸ä¸å½±å“å…¶ä»–æ¶ˆæ¯
    }
}
```

---

## ä¸ƒã€æµ‹è¯•è®¾è®¡

### 7.1 å•å…ƒæµ‹è¯•

**PriceChannelæµ‹è¯•**ï¼š
- âœ… OKX tickeræ¶ˆæ¯è§£ææ­£ç¡®æ€§
- âœ… å¼‚å¸¸æ¶ˆæ¯å¤„ç†
- âœ… è®¢é˜…/å–æ¶ˆè®¢é˜…æ¶ˆæ¯æ„å»º

**LatestPriceServiceæµ‹è¯•**ï¼š
- âœ… ä»·æ ¼æ›´æ–°é€»è¾‘
- âœ… æ—¶é—´æˆ³è¿‡æ»¤é€»è¾‘
- âœ… å¹¶å‘æ›´æ–°å®‰å…¨æ€§
- âœ… äº‹ä»¶å‘å¸ƒé€»è¾‘

**PriceQueryServiceæµ‹è¯•**ï¼š
- âœ… æŸ¥è¯¢æ¥å£æ­£ç¡®æ€§
- âœ… ä¸å­˜åœ¨äº¤æ˜“å¯¹çš„å¤„ç†
- âœ… æ‰¹é‡æŸ¥è¯¢é€»è¾‘

### 7.2 é›†æˆæµ‹è¯•

**ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
- âœ… WebSocketè¿æ¥ â†’ ä»·æ ¼æ›´æ–° â†’ äº‹ä»¶å‘å¸ƒ â†’ æŸ¥è¯¢æ¥å£
- âœ… é‡è¿åä»·æ ¼æ¢å¤
- âœ… å¤šäº¤æ˜“å¯¹å¹¶å‘è®¢é˜…

### 7.3 æ€§èƒ½æµ‹è¯•

**æ€§èƒ½æŒ‡æ ‡éªŒè¯**ï¼š
- âœ… å•æ¡æ¶ˆæ¯å¤„ç†è€—æ—¶ < 1ms
- âœ… å¹¶å‘æ›´æ–°æ€§èƒ½ï¼ˆ1000ä¸ªäº¤æ˜“å¯¹åŒæ—¶æ›´æ–°ï¼‰
- âœ… å†…å­˜å ç”¨ï¼ˆ1000ä¸ªäº¤æ˜“å¯¹çš„å†…å­˜å ç”¨ï¼‰

---

## å…«ã€ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

### 8.1 ä¸MarketDataCenterçš„é›†æˆ

**é›†æˆæ–¹å¼**ï¼š
- âœ… **å¤ç”¨è®¢é˜…é…ç½®**ï¼šä½¿ç”¨ `MarketSubscriptionConfig` åŠ è½½è®¢é˜…åˆ—è¡¨
- âœ… **å¤ç”¨WebSocketè¿æ¥**ï¼šä½¿ç”¨ `ExchangeWebSocketManager` ç®¡ç†è¿æ¥
- âœ… **ç‹¬ç«‹æœåŠ¡**ï¼šLatestPriceServiceç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–MarketDataCenter

**å¯åŠ¨æ–¹å¼**ï¼š
- ä»·æ ¼è®¢é˜…å¯ä»¥ç›´æ¥æ‰©å±•MarketDataCenterï¼Œåœ¨å¯åŠ¨æ—¶åŠ è½½ä»·æ ¼è®¢é˜…é…ç½®
- æˆ–è€…åˆ›å»ºç‹¬ç«‹çš„PriceSubscriptionServiceï¼ˆç®€åŒ–ç‰ˆï¼Œä»…è´Ÿè´£å¯åŠ¨ä»·æ ¼è®¢é˜…ï¼‰
- ä¸¤è€…å…±äº«WebSocketè¿æ¥ï¼ˆé€šè¿‡ExchangeWebSocketManagerï¼‰
- PriceChannelæ³¨å†Œåˆ°ChannelRouterï¼Œé€šè¿‡è·¯ç”±æœºåˆ¶å¤„ç†ä»·æ ¼æ¶ˆæ¯

**å¯åŠ¨é¡ºåº**ï¼š
1. ExchangeWebSocketManageråˆå§‹åŒ–ï¼ˆå»ºç«‹WebSocketè¿æ¥ï¼‰
2. ChannelRouteræ³¨å†ŒPriceChannel
3. MarketDataCenterå¯åŠ¨ï¼ˆåŠ è½½Kçº¿è®¢é˜…ï¼‰
4. ä»·æ ¼è®¢é˜…å¯åŠ¨ï¼ˆåŠ è½½ä»·æ ¼è®¢é˜…é…ç½®ï¼Œè°ƒç”¨marketIngestor.subscribe()ï¼‰
5. ä¸¤è€…å…±äº«åŒä¸€ä¸ªWebSocketè¿æ¥

### 8.2 ä¸ç­–ç•¥æ¨¡å—çš„é›†æˆ

**é›†æˆæ–¹å¼**ï¼š
- âœ… **äº‹ä»¶è®¢é˜…**ï¼šç­–ç•¥æ¨¡å—è®¢é˜… `PriceChangedEvent`
- âœ… **åŒæ­¥æŸ¥è¯¢**ï¼šç­–ç•¥æ¨¡å—è°ƒç”¨ `PriceQueryService.getLatestPrice()`

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// ç­–ç•¥æ¨¡å—è®¢é˜…ä»·æ ¼å˜æ›´äº‹ä»¶
@EventListener
public void onPriceChanged(PriceChangedEvent event) {
    // å¤„ç†ä»·æ ¼å˜æ›´
    if (event.price().compareTo(threshold) > 0) {
        // è§¦å‘äº¤æ˜“é€»è¾‘
    }
}

// ç­–ç•¥æ¨¡å—åŒæ­¥æŸ¥è¯¢ä»·æ ¼
BigDecimal currentPrice = priceQueryService.getLatestPrice("BTC-USDT-SWAP")
    .orElseThrow(() -> new RuntimeException("ä»·æ ¼ä¸å­˜åœ¨"));
```

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

### 9.1 åŠŸèƒ½éªŒæ”¶

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… ç³»ç»Ÿå¯ç¨³å®šæ¥æ”¶å®æ—¶ä»·æ ¼ï¼ˆé€šè¿‡WebSocketè®¢é˜…tickeré¢‘é“ï¼‰
- âœ… æœ€æ–°ä»·æ ¼å¯éšæ—¶æŸ¥è¯¢ï¼ˆé€šè¿‡PriceQueryService.getLatestPrice()ï¼‰
- âœ… ç­–ç•¥ä¸é£æ§èƒ½å³æ—¶æ„ŸçŸ¥ä»·æ ¼å˜åŒ–ï¼ˆé€šè¿‡PriceChangedEventäº‹ä»¶ï¼‰
- âœ… ä¸å½±å“ç°æœ‰Kçº¿ç³»ç»Ÿï¼ˆç‹¬ç«‹è¿è¡Œï¼Œå…±äº«WebSocketè¿æ¥ï¼‰
- âœ… æ¨¡å—èŒè´£æ— æ±¡æŸ“ï¼ˆä¸å­˜å‚¨ã€ä¸è®¡ç®—ã€ä¸å†³ç­–ï¼‰

**æ¥å£éªŒæ”¶**ï¼š
- âœ… `PriceQueryService.getLatestPrice(symbol)` è¿”å›æ­£ç¡®ä»·æ ¼
- âœ… `PriceQueryService.getLatestPriceWithTimestamp(symbol)` è¿”å›ä»·æ ¼å’Œæ—¶é—´æˆ³
- âœ… `PriceQueryService.getLatestPrices(symbols)` æ‰¹é‡æŸ¥è¯¢æ­£ç¡®
- âœ… `PriceChangedEvent` äº‹ä»¶æ­£å¸¸å‘å¸ƒå’Œè®¢é˜…

**è®¢é˜…éªŒæ”¶**ï¼š
- âœ… è®¢é˜…é…ç½®åŠ è½½æ­£ç¡®ï¼ˆåŸºäºMarketSubscriptionConfigï¼‰
- âœ… WebSocketè®¢é˜…tickeré¢‘é“æˆåŠŸ
- âœ… å–æ¶ˆè®¢é˜…åŠŸèƒ½æ­£å¸¸
- âœ… é‡è¿åè‡ªåŠ¨æ¢å¤è®¢é˜…

### 9.2 æ€§èƒ½éªŒæ”¶

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- âœ… å•æ¡æ¶ˆæ¯å¤„ç†è€—æ—¶ < 1msï¼ˆP99ï¼‰
- âœ… å†…å­˜å ç”¨ < 5MBï¼ˆ1000ä¸ªäº¤æ˜“å¯¹ï¼‰
- âœ… å¹¶å‘æ›´æ–°æ€§èƒ½æ­£å¸¸ï¼ˆ1000ä¸ªäº¤æ˜“å¯¹åŒæ—¶æ›´æ–°ï¼‰
- âœ… æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ < 0.1msï¼ˆP99ï¼‰

**æ€§èƒ½æµ‹è¯•æ–¹æ³•**ï¼š
- ä½¿ç”¨JMHè¿›è¡Œå•æ¡æ¶ˆæ¯å¤„ç†æ€§èƒ½æµ‹è¯•
- ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·ç›‘æ§å†…å­˜å ç”¨
- å¹¶å‘æ›´æ–°å‹åŠ›æµ‹è¯•ï¼ˆ1000ä¸ªäº¤æ˜“å¯¹ï¼Œ10000æ¬¡æ›´æ–°/ç§’ï¼‰
- æŸ¥è¯¢æ¥å£å‹åŠ›æµ‹è¯•ï¼ˆ10000æ¬¡æŸ¥è¯¢/ç§’ï¼‰

### 9.3 ç¨³å®šæ€§éªŒæ”¶

**å¼‚å¸¸åœºæ™¯**ï¼š
- âœ… WebSocketæ–­è¿åè‡ªåŠ¨é‡è¿
- âœ… é‡è¿åä»·æ ¼çŠ¶æ€æ¢å¤ï¼ˆé‡æ–°è®¢é˜…ï¼‰
- âœ… æ¶ˆæ¯ä¹±åºå¤„ç†æ­£ç¡®ï¼ˆæ—¶é—´æˆ³è¿‡æ»¤ï¼‰
- âœ… å¼‚å¸¸æ¶ˆæ¯ä¸å¯¼è‡´æœåŠ¡å´©æºƒ
- âœ… é«˜é¢‘æ¶ˆæ¯å¤„ç†ä¸é˜»å¡

**ç¨³å®šæ€§æµ‹è¯•æ–¹æ³•**ï¼š
- æ¨¡æ‹ŸWebSocketæ–­è¿ï¼ŒéªŒè¯é‡è¿æœºåˆ¶
- æ¨¡æ‹Ÿæ¶ˆæ¯ä¹±åºï¼ŒéªŒè¯æ—¶é—´æˆ³è¿‡æ»¤
- æ¨¡æ‹Ÿå¼‚å¸¸æ¶ˆæ¯ï¼ŒéªŒè¯å¼‚å¸¸éš”ç¦»
- é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼ˆ24å°æ—¶ï¼‰

### 9.4 é›†æˆéªŒæ”¶

**ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ**ï¼š
- âœ… ä¸MarketDataCenterå…±å­˜ï¼ˆå…±äº«WebSocketè¿æ¥ï¼‰
- âœ… ä¸Kçº¿è®¢é˜…äº’ä¸å½±å“
- âœ… ä¸ç­–ç•¥æ¨¡å—é›†æˆæ­£å¸¸ï¼ˆäº‹ä»¶è®¢é˜…å’ŒåŒæ­¥æŸ¥è¯¢ï¼‰
- âœ… åº”ç”¨å¯åŠ¨é¡ºåºæ­£ç¡®

**é›†æˆæµ‹è¯•æ–¹æ³•**ï¼š
- åŒæ—¶è¿è¡ŒKçº¿è®¢é˜…å’Œä»·æ ¼è®¢é˜…ï¼ŒéªŒè¯äº’ä¸å¹²æ‰°
- ç­–ç•¥æ¨¡å—è®¢é˜…PriceChangedEventï¼ŒéªŒè¯äº‹ä»¶æ¥æ”¶
- ç­–ç•¥æ¨¡å—è°ƒç”¨PriceQueryServiceï¼ŒéªŒè¯æŸ¥è¯¢æ­£ç¡®

### 9.5 ä»£ç è´¨é‡éªŒæ”¶

**ä»£ç è§„èŒƒ**ï¼š
- âœ… ä»£ç ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… å…³é”®é€»è¾‘æœ‰è¯¦ç»†æ³¨é‡Š
- âœ… æ— ä¸¥é‡ä»£ç å¼‚å‘³

**æ–‡æ¡£éªŒæ”¶**ï¼š
- âœ… ä»£ç æ³¨é‡Šå®Œæ•´
- âœ… æ¥å£æ–‡æ¡£æ¸…æ™°
- âœ… ä½¿ç”¨ç¤ºä¾‹å®Œæ•´

---

## åã€è®¾è®¡åº•çº¿å£°æ˜

> **å®æ—¶ä»·æ ¼è®¢é˜…æ¨¡å—å¿…é¡»ä¿æŒ"åªåšä¸€ä»¶äº‹"çš„æ´ç™–ã€‚**  
> **å®ƒæ˜¯ç³»ç»Ÿçš„ç¥ç»æœ«æ¢¢ï¼Œä¸æ˜¯å¤§è„‘ã€‚**

**è®¾è®¡çº¢çº¿**ï¼š
- âŒ ä¸æ·»åŠ æ•°æ®åº“å­˜å‚¨
- âŒ ä¸æ·»åŠ ç¼“å­˜å­˜å‚¨
- âŒ ä¸æ·»åŠ è®¡ç®—é€»è¾‘
- âŒ ä¸æ·»åŠ ç­–ç•¥é€»è¾‘
- âŒ ä¸æ·»åŠ é£æ§é€»è¾‘

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… åªç»´æŠ¤å†…å­˜çŠ¶æ€
- âœ… åªå‘å¸ƒäº‹ä»¶
- âœ… åªæä¾›æŸ¥è¯¢æ¥å£
- âœ… ä¿æŒæç®€ä¸é«˜æ€§èƒ½

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**ï¼š2025-01-05  
**åŸºäºäº§å“è§„èŒƒ**ï¼š`è®¢é˜…ä»·æ ¼.md`ï¼ˆPrice Subscription Specification v1.0ï¼‰
