# 行情模块架构档案

> **文档说明**：本文档记录行情模块的架构设计、业务实现和后续改动，作为系统的唯一事实来源（Source of Truth）。

**文档版本**：v1.0  
**最后更新**：2025-01-15  
**维护原则**：任何架构变更和功能调整必须在此文档中记录

---

## 📋 目录

1. [模块概述](#模块概述)
2. [架构设计](#架构设计)
3. [已实现功能](#已实现功能)
4. [架构文档映射](#架构文档映射)
5. [技术选型](#技术选型)
6. [后续改动记录](#后续改动记录)
7. [待解决问题](#待解决问题)

---

## 一、模块概述

### 1.1 模块定位

行情模块是**系统基础设施层（Infrastructure Layer）**，负责：
- **行情接入**：从交易所WebSocket接收实时行情数据
- **行情存储**：将行情数据持久化到QuestDB
- **行情查询**：提供REST API供前端和策略模块查询历史行情
- **行情校准**：检测和补全缺失的K线数据，保证数据完整性

### 1.2 模块边界

**行情模块负责**：
- ✅ WebSocket连接管理和消息解析
- ✅ 实时K线数据接收和存储
- ✅ 历史K线数据查询
- ✅ 数据完整性检测和补全

**行情模块不负责**：
- ❌ 策略决策
- ❌ 交易执行
- ❌ 资金风控
- ❌ 数据聚合计算（由策略模块自行处理）

---

## 二、架构设计

### 2.1 整体架构

系统采用**事件驱动**的分层架构：

```
┌─────────────────────────────────────────────────────────────┐
│                     行情订阅模块                              │
│  ExchangeWebSocketManager → ChannelRouter → KlineChannel    │
│                    ↓                                        │
│              MarketEventBus (事件总线)                       │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                 行情数据中心 (MarketDataCenter)               │
│  - 订阅EventBus接收KlineEvent                                │
│  - 去重处理                                                  │
│  - 写入QuestDB                                               │
│  - 分发到WebSocket客户端                                     │
└────────────────────┬────────────────────────────────────────┘
                     │
          ┌──────────┴──────────┐
          │                     │
          ↓                     ↓
    ┌──────────┐         ┌──────────────┐
    │ QuestDB  │         │ WebSocket    │
    │ (存储)   │         │ (实时分发)   │
    └──────────┘         └──────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     行情查询模块                              │
│  MarketDataController → MarketQueryService → QuestDB        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     行情校准模块                              │
│  MarketCalibrationScheduler → Executor → HistoricalFetcher  │
│                      ↓                                      │
│                补全到QuestDB                                 │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 行情订阅层

| 组件 | 类名 | 职责 | 状态 |
|------|------|------|------|
| WebSocket管理器 | `ExchangeWebSocketManager` | 管理WebSocket连接生命周期、心跳、重连 | ✅ 已实现 |
| 消息路由器 | `ChannelRouter` | 解析消息类型，路由到对应的Channel | ✅ 已实现 |
| K线频道 | `KlineChannel` | 解析OKX K线消息，转换为KlineEvent | ✅ 已实现 |
| 事件总线 | `MarketEventBus` (SimpleMarketEventBus) | 异步发布KlineEvent，解耦订阅和处理 | ✅ 已实现 |
| 行情采集器 | `OkxMarketIngestor` | 启动WebSocket连接，订阅交易对 | ✅ 已实现 |

**设计原则**：
- ✅ 单一职责：WebSocket管理、消息解析、事件分发完全解耦
- ✅ 事件驱动：使用EventBus实现发布-订阅模式
- ✅ 异步处理：EventBus使用线程池异步执行消费者，避免阻塞WebSocket IO线程
- ✅ 重连机制：维护`desiredSubscriptions`作为订阅状态唯一事实来源

#### 2.2.2 行情处理层

| 组件 | 类名 | 职责 | 状态 |
|------|------|------|------|
| 行情数据中心 | `MarketDataCenter` | 订阅EventBus，接收KlineEvent，写入存储 | ✅ 已实现 |
| 存储服务 | `QuestDbMarketStorageService` | 将K线数据写入QuestDB | ✅ 已实现 |
| 缓存服务 | `RedisMarketCacheService` | 缓存最新K线数据（可选） | ✅ 已实现 |
| 分发服务 | `WebSocketMarketDistributor` | 向WebSocket客户端推送实时行情 | ✅ 已实现 |

**设计原则**：
- ✅ 只接收最新K线，不处理历史数据
- ✅ 内存去重：使用`ConcurrentHashMap`防止并发插入
- ✅ 幂等写入：存储层检查是否存在再插入

#### 2.2.3 行情查询层

| 组件 | 类名 | 职责 | 状态 |
|------|------|------|------|
| 查询控制器 | `MarketDataController` | 提供REST API查询K线数据 | ✅ 已实现 |
| 查询服务 | `QuestDbMarketQueryService` | 从QuestDB查询K线数据 | ✅ 已实现 |
| 缓存查询服务 | `CachedMarketQueryService` | 带缓存的查询服务（可选） | ✅ 已实现 |

**支持的查询**：
- ✅ 时间范围查询：`GET /api/market/kline?symbol=xxx&interval=1m&from=xxx&to=xxx`
- ✅ 最新K线查询：`GET /api/market/kline/latest?symbol=xxx&interval=1m`
- ✅ 时间戳对齐查询：`GET /api/market/kline/timestamp?symbol=xxx&timestamp=xxx`
- ✅ 今日统计：`GET /api/market/kline/today-stats?symbol=xxx`

#### 2.2.4 行情校准层

| 组件 | 类名 | 职责 | 状态 |
|------|------|------|------|
| 任务配置 | `MarketCalibrationTaskConfig` | 存储校准任务配置（缺失检测/数据核对） | ✅ 已实现 |
| 缺失检测执行器 | `MissingDataExecutor` | 检测缺失K线并补全 | ✅ 已实现 |
| 数据核对执行器 | `DataVerifyExecutor` | 检测重复、错序、异常数据 | ✅ 已实现 |
| 定时调度器 | `MarketCalibrationScheduler` | 定时扫描并执行自动任务 | ✅ 已实现 |
| 历史数据拉取 | `HistoricalKlineFetcherImpl` | 从OKX API拉取历史K线 | ✅ 已实现 |
| 执行日志 | `MarketCalibrationTaskLog` | 记录每次执行的结果 | ✅ 已实现 |

**设计原则**：
- ✅ 与实时订阅完全解耦：校准模块不依赖订阅模块
- ✅ 幂等执行：支持重复执行，不会产生重复数据
- ✅ 可追溯：所有操作记录在执行日志中

---

## 三、已实现功能

### 3.1 行情订阅功能

**实现状态**：✅ 已完成（基于《统一行情订阅v1.0》架构）

**功能清单**：
- [x] WebSocket连接管理（连接、重连、心跳）
- [x] 多交易对订阅（基于`MarketSubscriptionConfig`配置）
- [x] OKX K线消息解析（`candle1m`频道）
- [x] 事件驱动架构（EventBus异步分发）
- [x] 自动重连机制（指数退避：5s, 10s, 20s, 40s, 80s）
- [x] 静默检测（60秒无消息强制重连）
- [x] 订阅状态管理（`desiredSubscriptions`作为唯一事实来源）

**当前周期支持**：
- ✅ 1分钟K线（`candle1m`）

**待扩展周期**（参考《多周期K线订阅方案.md》）：
- ⏳ 5分钟、15分钟、30分钟、1小时、4小时（需要扩展`MarketSubscriptionConfig.intervals`字段）

### 3.2 行情存储功能

**实现状态**：✅ 已完成

**功能清单**：
- [x] K线数据写入QuestDB（`kline_1m`表）
- [x] 去重处理（内存缓存 + 数据库检查）
- [x] 时间戳对齐（对齐到分钟起始点）
- [x] 幂等写入（相同timestamp不重复插入）

**数据库表结构**：
```sql
CREATE TABLE kline_1m (
    symbol SYMBOL,
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    exchange_ts TIMESTAMP
) TIMESTAMP(ts) PARTITION BY DAY;
```

### 3.3 行情查询功能

**实现状态**：✅ 已完成

**API接口**：
- [x] `GET /api/market/kline` - 时间范围查询
- [x] `GET /api/market/kline/latest` - 最新K线查询
- [x] `GET /api/market/kline/timestamp` - 时间戳对齐查询
- [x] `GET /api/market/kline/today-stats` - 今日统计

**支持的周期**：
- ✅ 1m（当前只存储1分钟K线，其他周期需要聚合或直接订阅）

### 3.4 行情校准功能

**实现状态**：✅ 已完成（基于《行情校准规范》和《行情校准实施方案》）

**功能清单**：
- [x] 任务配置管理（CRUD接口）
- [x] 缺失数据检测（检测指定时间范围内的缺失K线）
- [x] 历史数据补全（从OKX API拉取缺失的K线并写入QuestDB）
- [x] 数据核对（检测重复、错序、异常数据，仅记录不修正）
- [x] 手动执行（支持指定时间范围）
- [x] 自动执行（定时调度器每10分钟扫描一次）
- [x] 执行日志记录（记录每次执行的详细结果）

**API接口**：
- [x] `POST /api/market-calibration/config` - 创建任务配置
- [x] `PUT /api/market-calibration/config/{id}` - 更新任务配置
- [x] `DELETE /api/market-calibration/config/{id}` - 删除任务配置
- [x] `GET /api/market-calibration/config` - 查询任务配置列表
- [x] `GET /api/market-calibration/config/{id}` - 查询任务配置详情
- [x] `POST /api/market-calibration/config/{id}/toggle` - 启用/禁用任务
- [x] `POST /api/market-calibration/config/{id}/execute` - 手动执行任务
- [x] `GET /api/market-calibration/log` - 查询执行日志列表
- [x] `GET /api/market-calibration/log/{id}` - 查询执行日志详情

---

## 四、架构文档映射

### 4.1 已采用的架构文档

| 文档名称 | 采用状态 | 实现说明 |
|---------|---------|---------|
| **统一行情订阅v1.0.md** | ✅ 已采用 | 实现了事件驱动的WebSocket订阅架构，包含ExchangeWebSocketManager、ChannelRouter、KlineChannel、MarketEventBus等核心组件 |
| **统一行情订阅v1.0-实施计划.md** | ✅ 已采用 | 按照实施计划完成了Phase 1-7，删除了旧代码（OkxWebSocketClient），重构为新的架构 |
| **行情瘦身执行.md** | ✅ 已采用 | MarketDataCenter只负责接收最新K线并写入，不包含任何补拉逻辑 |
| **行情校准规范.md** | ✅ 已采用 | 实现了独立的行情校准模块，与实时订阅完全解耦 |
| **行情校准实施方案.md** | ✅ 已采用 | 实现了任务配置管理、缺失检测、数据核对、定时调度等功能 |
| **行情校准实现方案.md** | ✅ 已采用 | 按照方案实现了数据库表、Service层、Controller层、执行器等 |

### 4.2 待实现的架构文档

| 文档名称 | 采用状态 | 说明 |
|---------|---------|------|
| **多周期K线订阅方案.md** | ⏳ 待实现 | 当前只支持1分钟K线，需要扩展支持多周期（5m, 15m, 30m, 1h, 4h）。需要：1) 扩展`MarketSubscriptionConfig.intervals`字段；2) 扩展`KlineChannel`支持多周期订阅；3) 创建多周期表（kline_5m, kline_15m等） |
| **基于1分钟K线聚合的多周期方案.md** | ❌ 未采用 | 该方案是从1分钟K线聚合生成多周期，但当前架构已决定采用"直接订阅多周期"方案（参考《多周期K线订阅方案.md》） |
| **行情中心开发规划.md** | ⚠️ 部分采用 | 部分功能已实现（Phase 1-2），Phase 3-6待实现 |

### 4.3 已废弃的文档

| 文档名称 | 状态 | 说明 |
|---------|------|------|
| **行情中心定位与约束.md** | 📄 参考 | 架构原则参考，但具体实现以《统一行情订阅v1.0》为准 |
| **行情中心数据一致性与补拉策略.md** | 📄 参考 | 数据一致性策略已融入《行情校准规范》，补拉功能已实现 |

---

## 五、技术选型

### 5.1 核心技术栈

| 技术 | 版本/说明 | 用途 |
|------|----------|------|
| **Java** | 17+ | 后端开发语言 |
| **Spring Boot** | 3.x | 应用框架 |
| **MyBatis-Plus** | 最新版 | ORM框架（MySQL操作） |
| **QuestDB** | 最新版 | 时序数据库（K线存储） |
| **Redis** | 最新版 | 缓存（可选） |
| **OkHttp** | 最新版 | WebSocket客户端 |
| **Jackson** | 最新版 | JSON解析 |

### 5.2 数据库设计

**MySQL表**：
- `market_subscription_config` - 订阅配置表
- `market_calibration_task_config` - 校准任务配置表
- `market_calibration_task_log` - 校准执行日志表

**QuestDB表**：
- `kline_1m` - 1分钟K线表（分区表，按天分区）

### 5.3 时间处理规范

**系统唯一时间基准**：UTC  
**所有时间戳语义**：UTC epoch millis（毫秒）  
**用户输入处理**：用户输入的时间字符串直接当作UTC时间处理，不进行时区转换

**时间戳对齐规则**（1分钟K线）：
- 所有时间戳对齐到分钟起始点：`(timestamp / 60000) * 60000`
- 查询边界：左闭右开区间 `[startTimestamp, endTimestamp)`

---

## 六、后续改动记录

> **重要**：任何架构变更、功能调整、Bug修复必须在此处记录，包括：
> - 改动日期
> - 改动内容
> - 影响范围
> - 改动原因

### 改动记录格式

```
### YYYY-MM-DD - 改动标题

**改动类型**：[架构变更 / 功能调整 / Bug修复 / 性能优化]

**改动内容**：
- 具体改动点1
- 具体改动点2

**影响范围**：
- 影响的模块/类
- 需要同步调整的内容

**改动原因**：
- 为什么要做这个改动

**相关文档**：
- 如果参考了某个架构文档，请注明
```

---

## 七、待解决问题

> **说明**：记录已知问题、技术债务、待优化项，供后续迭代参考

### 问题清单

1. **多周期K线支持**
   - **问题**：当前只支持1分钟K线订阅和存储
   - **影响**：策略需要使用多周期K线时需要自行聚合
   - **解决方案**：参考《多周期K线订阅方案.md》实现多周期订阅
   - **优先级**：P1（重要但不紧急）

2. **等待K线完成逻辑**
   - **问题**：当前实现是实时写入，没有等待K线完成的逻辑
   - **影响**：可能写入未完成的K线，导致数据更新
   - **解决方案**：参考《多周期K线订阅方案.md》的等待时间计算逻辑
   - **优先级**：P2（可选优化）

3. **WebSocket分发功能**
   - **问题**：WebSocketMarketDistributor已实现但可能未充分测试
   - **影响**：前端实时行情推送可能不稳定
   - **解决方案**：完善测试和监控
   - **优先级**：P1（如前端需要实时推送）

---

## 八、模块依赖关系

### 8.1 依赖的其他模块

- **业务模块**（`com.qyl.v2trade.business`）：
  - `MarketSubscriptionConfig` - 订阅配置
  - `TradingPair` - 交易对信息
  - `ExchangeMarketPair` - 交易所交易对映射

- **客户端模块**（`com.qyl.v2trade.client`）：
  - `OkxApiClient` - OKX API客户端（用于历史数据拉取）

### 8.2 被其他模块依赖

- **策略模块**（未来）：通过`MarketQueryService`查询历史K线数据
- **前端模块**（未来）：通过REST API查询K线数据，通过WebSocket接收实时行情

---

## 九、代码结构

### 9.1 包结构

```
com.qyl.v2trade.market
├── model/                          # 数据模型
│   ├── event/                      # 事件模型（KlineEvent）
│   ├── dto/                        # DTO模型（请求/响应）
│   └── NormalizedKline.java        # 标准化K线模型
├── subscription/                   # 行情订阅模块
│   ├── collector/                  # 采集层
│   │   ├── channel/                # Channel实现
│   │   ├── eventbus/               # 事件总线
│   │   ├── ingestor/               # 采集器
│   │   ├── router/                 # 消息路由器
│   │   └── websocket/              # WebSocket管理
│   ├── processor/                  # 处理层
│   │   └── MarketDataCenter.java   # 行情数据中心
│   ├── persistence/                # 持久化层
│   │   ├── storage/                # 存储服务
│   │   └── cache/                  # 缓存服务
│   ├── delivery/                   # 分发层
│   │   └── distributor/            # 分发器
│   └── infrastructure/             # 基础设施
│       ├── config/                 # 配置类
│       └── monitor/                # 监控
├── calibration/                    # 行情校准模块
│   ├── config/                     # 任务配置
│   ├── executor/                   # 执行器
│   ├── log/                        # 执行日志
│   ├── scheduler/                  # 定时调度
│   ├── service/                    # 业务服务
│   ├── util/                       # 工具类
│   └── common/                     # 常量
└── web/                            # Web层
    ├── controller/                 # 控制器
    └── query/                      # 查询服务
```

---

**文档维护者**：系统架构组  
**最后审核日期**：2025-01-15

