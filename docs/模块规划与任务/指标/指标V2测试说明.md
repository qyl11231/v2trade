# 指标V2测试说明

> **版本**: V2.0  
> **创建日期**: 2024-01  
> **维护者**: qyl

---

## 一、测试范围

### 1.1 单元测试

**测试文件**：
- `IndicatorParamValidatorTest.java`：参数校验测试
- `IndicatorEvaluateServiceTest.java`：评估服务测试
- `IndicatorCacheManagerTest.java`：缓存管理器测试
- `IndicatorEngineRouterTest.java`：引擎路由测试

**测试覆盖要求**：
- 单元测试覆盖率 > 80%
- 所有校验场景都有测试覆盖
- 测试通过率达到 100%

### 1.2 集成测试

**测试文件**：
- `BarSeriesEvaluateIntegrationTest.java`：BarSeries 与 Evaluate 集成测试
- `BatchEvaluateIntegrationTest.java`：批量评估一致性测试

**测试场景**：
- BarClosedEvent 推进 bar window 后，evaluate(asOf=最新 bar) 得到可预期结果
- evaluateBatch 与单次 evaluate 结果一致
- 缓存命中/未命中场景
- 参数校验场景

### 1.3 回归测试

**测试场景**：
- `GET /api/indicator/latest` 接口不崩（兼容层）
- 前端页面正常显示
- 策略模块调用正常

---

## 二、压测与基准

### 2.1 压测场景

**单次评估（缓存命中）**：
- 目标 QPS > 1000
- 测试方法：使用相同参数多次调用 evaluate 接口

**单次评估（缓存未命中）**：
- 目标 QPS > 100
- 测试方法：使用不同参数调用 evaluate 接口

**批量评估（10个指标）**：
- 目标吞吐提升 > 2倍
- 测试方法：对比单次评估10次 vs 批量评估1次

**BarSeries append 延迟**：
- 目标 < 1ms
- 测试方法：测量 onBarClosed 事件处理时间

### 2.2 压测脚本示例

```bash
# 使用 Apache Bench 或 wrk 进行压测
# 示例：单次评估（缓存命中）
ab -n 10000 -c 100 -p evaluate_request.json -T application/json \
   http://localhost:8080/api/indicator/evaluate
```

---

## 三、Metrics 验证

### 3.1 Prometheus 端点

访问：`http://localhost:8080/actuator/prometheus`

### 3.2 关键指标

**评估耗时**：
- `indicator_evaluate_cost_ms`：P50/P95/P99 分位数

**缓存命中率**：
- `indicator_cache_hits_total`：缓存命中次数
- `indicator_cache_misses_total`：缓存未命中次数
- 计算命中率：`hits / (hits + misses)`

**批量评估大小**：
- `indicator_evaluate_batch_size`：批量评估大小分布

**评估失败**：
- `indicator_evaluate_failures_total`：评估失败次数

### 3.3 验证方法

```bash
# 查询缓存命中率
curl http://localhost:8080/actuator/prometheus | grep indicator_cache

# 查询评估耗时
curl http://localhost:8080/actuator/prometheus | grep indicator_evaluate_cost
```

---

## 四、功能验证清单

### 4.1 核心功能

- [ ] evaluate 能正确计算指标（无缓存也能跑）
- [ ] evaluateBatch 结果与单次一致
- [ ] 缓存命中时返回 source=CACHE
- [ ] 缓存未命中时返回 source=COMPUTED
- [ ] 参数校验正确（必填、类型、范围、枚举）
- [ ] 引擎路由正确（impl_key 优先，engine 回退）

### 4.2 边界验证

- [ ] Service 只做协调，不包含业务逻辑（职责边界）
- [ ] 输出不包含任何策略语义字段（输出边界）
- [ ] 关闭缓存不影响功能正确性（关键验收点）
- [ ] FeatureCache 关闭时功能仍然正常（关键验收点）

### 4.3 兼容性验证

- [ ] GET /api/indicator/latest 接口不崩
- [ ] 旧前端页面正常显示
- [ ] 旧策略模块调用正常

---

## 五、性能验收标准

- [ ] 缓存命中 QPS > 1000
- [ ] 缓存未命中 QPS > 100
- [ ] 批量评估吞吐提升 > 2倍
- [ ] BarSeries append 延迟 < 1ms
- [ ] 内存占用可控（无内存泄漏）

---

## 六、测试执行建议

1. **单元测试**：每次代码提交前执行
2. **集成测试**：每日构建时执行
3. **回归测试**：版本发布前执行
4. **压测**：版本发布前执行，记录基准数据
5. **Metrics 验证**：生产环境持续监控

---

**文档版本**：V2.0  
**最后更新**：2024-01  
**维护者**：qyl

