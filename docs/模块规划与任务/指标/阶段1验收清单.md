# 阶段1验收清单：BarSeries（历史加载 + 实时append）接入订阅驱动

## 验收标准

### 1.1 TradingPairResolver验收

- [ ] WS symbol 能映射到 pairId
- [ ] QuestDB 查询能从 pairId 得到 symbol
- [ ] 缓存生效（重复查询不访问数据库）

**验证方法**：
```java
TradingPairResolver resolver = ...;
Long pairId = resolver.symbolToTradingPairId("BTC-USDT-SWAP");
String symbol = resolver.tradingPairIdToSymbol(pairId);
assertEquals("BTC-USDT-SWAP", symbol);
```

### 1.2 QuestDbKlineReader验收

- [ ] 任意 pair/timeframe 返回升序 bars
- [ ] bars 的时间步长严格等于 timeframe duration

**验证方法**：运行 `QuestDbKlineReaderTest`

### 1.3 BarSeriesManager验收

- [ ] 订阅中出现的 pair/timeframe 才会被加载与维护
- [ ] 重放同一 BarClosedEvent 不产生重复 bar
- [ ] 启动时自动bootstrap（通过IndicatorBootstrapListener）
- [ ] 自动订阅BarClosedEvent

**验证方法**：运行 `BarSeriesManagerTest`

## 测试执行

### 运行阶段1验收测试

```bash
# 运行所有阶段1测试
mvn test -Dtest=BarSeriesManagerTest
mvn test -Dtest=QuestDbKlineReaderTest
```

## 手动验证步骤

### 1. 准备测试数据

```sql
-- 1. 确保有交易对
INSERT INTO trading_pair (symbol, base_currency, quote_currency, market_type, enabled) 
VALUES ('BTC-USDT-SWAP', 'BTC', 'USDT', 'SWAP', 1)
ON DUPLICATE KEY UPDATE enabled=1;

-- 2. 创建指标订阅
INSERT INTO indicator_subscription 
(user_id, trading_pair_id, symbol, market_type, timeframe, indicator_code, indicator_version, enabled)
SELECT 0, id, symbol, market_type, '5m', 'RSI', 'v1', 1
FROM trading_pair 
WHERE symbol = 'BTC-USDT-SWAP' AND market_type = 'SWAP'
LIMIT 1;
```

### 2. 验证启动加载

- 启动应用
- 查看日志：`BarSeries历史数据加载完成`
- 验证：BarSeriesManager中有对应的series

### 3. 验证实时append

- 等待BarClosedEvent发布
- 验证：series中的bars数量增加
- 验证：同一barTime不会重复

## 阶段1完成标准

✅ 所有验收项通过后才能进入阶段2

- [x] TradingPairResolver已存在且符合要求
- [x] QuestDbKlineReader已实现
- [x] BarSeriesManager已实现
- [x] BarSeriesView接口已创建
- [x] 启动器已创建
- [ ] 验收测试全部通过
- [ ] 手动验证启动加载成功

## 下一步

**阶段1完成后，进入阶段2：Definition/Registry 落库（indicator_definition）**

