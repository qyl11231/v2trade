# å‚æ•°æ ¡éªŒè§„èŒƒè¯´æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šV2.0  
> **æœ€åæ›´æ–°**ï¼š2024-01  
> **ç»´æŠ¤è€…**ï¼šqyl

---

## ğŸ“‹ ç›®å½•

1. [æ ¡éªŒä¾æ®](#æ ¡éªŒä¾æ®)
2. [paramSchema ç»“æ„è§„èŒƒ](#paramschema-ç»“æ„è§„èŒƒ)
3. [æ ¡éªŒè§„åˆ™è¯¦è§£](#æ ¡éªŒè§„åˆ™è¯¦è§£)
4. [ä»£ç å®ç°è¯´æ˜](#ä»£ç å®ç°è¯´æ˜)
5. [ç¤ºä¾‹è¯´æ˜](#ç¤ºä¾‹è¯´æ˜)

---

## æ ¡éªŒä¾æ®

**å‚æ•°æ ¡éªŒå™¨ï¼ˆ`IndicatorParamValidator`ï¼‰çš„ä¾æ®æ˜¯ `IndicatorDefinition` ä¸­çš„ `paramSchema` å­—æ®µã€‚**

### æ ¸å¿ƒåŸç†

```
æŒ‡æ ‡å®šä¹‰ï¼ˆIndicatorDefinitionï¼‰
  â””â”€â”€ paramSchemaï¼ˆå‚æ•°Schemaï¼ŒJSONæ ¼å¼ï¼‰
      â”œâ”€â”€ å‚æ•°å®šä¹‰ï¼ˆå¦‚ï¼šperiod, fast, slowï¼‰
      â””â”€â”€ å…ƒæ•°æ®å­—æ®µï¼ˆdata_source, impl_key, param_limitsï¼‰
```

**æ ¡éªŒæµç¨‹**ï¼š
1. æ ¹æ® `indicatorCode` å’Œ `version` æŸ¥æ‰¾æŒ‡æ ‡å®šä¹‰
2. è·å– `paramSchema`ï¼ˆå‚æ•°Schemaï¼‰
3. éå† `paramSchema` ä¸­çš„æ¯ä¸ªå‚æ•°å®šä¹‰
4. æ ¹æ®å‚æ•°å®šä¹‰ä¸­çš„ `type`ã€`required`ã€`min`ã€`max`ã€`enum` ç­‰å­—æ®µè¿›è¡Œæ ¡éªŒ
5. å•ç‹¬æ ¡éªŒ `param_limits`ï¼ˆå¦‚ `lookback_max`ã€`window_max`ï¼‰

---

## paramSchema ç»“æ„è§„èŒƒ

### 2.1 åŸºæœ¬ç»“æ„

`paramSchema` æ˜¯ä¸€ä¸ª **JSON å¯¹è±¡**ï¼ˆ`Map<String, Object>`ï¼‰ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "å‚æ•°å1": {
    "type": "å‚æ•°ç±»å‹",
    "required": true/false,
    "default": "é»˜è®¤å€¼",
    "min": æœ€å°å€¼,
    "max": æœ€å¤§å€¼,
    "enum": ["æšä¸¾å€¼1", "æšä¸¾å€¼2"]
  },
  "å‚æ•°å2": {
    "type": "å‚æ•°ç±»å‹",
    ...
  },
  "data_source": "BAR",           // å…ƒæ•°æ®ï¼Œä¸æ˜¯å‚æ•°
  "impl_key": "ta4j:rsi",         // å…ƒæ•°æ®ï¼Œä¸æ˜¯å‚æ•°
  "param_limits": {               // å…ƒæ•°æ®ï¼Œä¸æ˜¯å‚æ•°
    "lookback_max": 365,
    "window_max": 1000
  }
}
```

### 2.2 å‚æ•°å®šä¹‰å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `type` | string | å¦ | å‚æ•°ç±»å‹ï¼šintegerã€decimalã€stringã€boolean | `"integer"` |
| `required` | boolean | å¦ | æ˜¯å¦å¿…å¡«ï¼Œé»˜è®¤ `false` | `true` |
| `default` | any | å¦ | é»˜è®¤å€¼ | `14` |
| `min` | number | å¦ | æœ€å°å€¼ï¼ˆä»…ç”¨äºæ•°å€¼ç±»å‹ï¼‰ | `1` |
| `max` | number | å¦ | æœ€å¤§å€¼ï¼ˆä»…ç”¨äºæ•°å€¼ç±»å‹ï¼‰ | `100` |
| `enum` | array | å¦ | æšä¸¾å€¼åˆ—è¡¨ | `["5m", "15m", "1h"]` |

### 2.3 å…ƒæ•°æ®å­—æ®µï¼ˆéœ€è¦è·³è¿‡æ ¡éªŒï¼‰

ä»¥ä¸‹å­—æ®µæ˜¯**å…ƒæ•°æ®**ï¼Œä¸æ˜¯å‚æ•°ï¼Œæ ¡éªŒæ—¶éœ€è¦è·³è¿‡ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `data_source` | string | æ•°æ®æºï¼ˆBAR/TICK/SIGNAL/MIXEDï¼‰ |
| `impl_key` | string | å®ç°æ˜ å°„é”®ï¼ˆå¦‚ï¼šta4j:rsiï¼‰ |
| `param_limits` | object | å‚æ•°é™åˆ¶ï¼ˆå¦‚ï¼šlookback_maxã€window_maxï¼‰ |

---

## æ ¡éªŒè§„åˆ™è¯¦è§£

### 3.1 å¿…å¡«æ ¡éªŒ

**è§„åˆ™**ï¼šå¦‚æœ `required: true`ï¼Œåˆ™å‚æ•°å¿…é¡»å­˜åœ¨ã€‚

**ä»£ç é€»è¾‘**ï¼š
```java
if (Boolean.TRUE.equals(spec.get("required")) && 
    (params == null || !params.containsKey(paramName))) {
    throw new ValidationException("å‚æ•°ç¼ºå¤±: " + paramName + " (å¿…å¡«)");
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "period": {"type": "integer", "required": true}
}
```
- âœ… ä¼ å…¥ `{"period": 14}` â†’ é€šè¿‡
- âŒ ä¼ å…¥ `{}` â†’ å¤±è´¥ï¼šå‚æ•°ç¼ºå¤±: period (å¿…å¡«)

---

### 3.2 ç±»å‹æ ¡éªŒ

**æ”¯æŒçš„å‚æ•°ç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ | Javaç±»å‹ | ç¤ºä¾‹å€¼ |
|------|------|----------|--------|
| `integer` | æ•´æ•° | Integerã€Long | `14` |
| `decimal`/`number` | å°æ•° | Number | `14.5` |
| `string` | å­—ç¬¦ä¸² | String | `"1h"` |
| `boolean` | å¸ƒå°”å€¼ | Boolean | `true` |

**ä»£ç é€»è¾‘**ï¼š
```java
switch (expectedType.toLowerCase()) {
    case "integer":
        typeValid = value instanceof Integer || value instanceof Long;
        break;
    case "decimal":
    case "number":
        typeValid = value instanceof Number;
        break;
    case "string":
        typeValid = value instanceof String;
        break;
    case "boolean":
        typeValid = value instanceof Boolean;
        break;
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "period": {"type": "integer"}
}
```
- âœ… ä¼ å…¥ `{"period": 14}` â†’ é€šè¿‡
- âŒ ä¼ å…¥ `{"period": "14"}` â†’ å¤±è´¥ï¼šå‚æ•°ç±»å‹é”™è¯¯: period (æœŸæœ›: integer, å®é™…: String)

---

### 3.3 èŒƒå›´æ ¡éªŒï¼ˆmin/maxï¼‰

**è§„åˆ™**ï¼šä»…ç”¨äºæ•°å€¼ç±»å‹ï¼ˆintegerã€decimalï¼‰ï¼Œæ£€æŸ¥å€¼æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…ã€‚

**ä»£ç é€»è¾‘**ï¼š
```java
BigDecimal decimalValue = new BigDecimal(numValue.toString());
BigDecimal min = new BigDecimal(minObj.toString());
if (decimalValue.compareTo(min) < 0) {
    throw new ValidationException("å‚æ•°å€¼è¿‡å°: " + paramName + 
        " (æœ€å°å€¼: " + min + ", å®é™…: " + decimalValue + ")");
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "period": {"type": "integer", "min": 1, "max": 100}
}
```
- âœ… ä¼ å…¥ `{"period": 14}` â†’ é€šè¿‡
- âŒ ä¼ å…¥ `{"period": 0}` â†’ å¤±è´¥ï¼šå‚æ•°å€¼è¿‡å°: period (æœ€å°å€¼: 1, å®é™…: 0)
- âŒ ä¼ å…¥ `{"period": 200}` â†’ å¤±è´¥ï¼šå‚æ•°å€¼è¿‡å¤§: period (æœ€å¤§å€¼: 100, å®é™…: 200)

---

### 3.4 æšä¸¾å€¼æ ¡éªŒï¼ˆenumï¼‰

**è§„åˆ™**ï¼šå‚æ•°å€¼å¿…é¡»åœ¨æšä¸¾åˆ—è¡¨ä¸­ã€‚

**ä»£ç é€»è¾‘**ï¼š
```java
List<Object> enumValues = (List<Object>) spec.get("enum");
if (!enumValues.contains(value)) {
    throw new ValidationException("å‚æ•°å€¼ä¸åœ¨æšä¸¾èŒƒå›´å†…: " + paramName + 
        " (å…è®¸å€¼: " + enumValues + ", å®é™…: " + value + ")");
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "timeframe": {"type": "string", "enum": ["5m", "15m", "30m", "1h", "4h"]}
}
```
- âœ… ä¼ å…¥ `{"timeframe": "1h"}` â†’ é€šè¿‡
- âŒ ä¼ å…¥ `{"timeframe": "1d"}` â†’ å¤±è´¥ï¼šå‚æ•°å€¼ä¸åœ¨æšä¸¾èŒƒå›´å†…: timeframe (å…è®¸å€¼: [5m, 15m, 30m, 1h, 4h], å®é™…: 1d)

---

### 3.5 å‚æ•°é™åˆ¶æ ¡éªŒï¼ˆparam_limitsï¼‰

**è§„åˆ™**ï¼šå•ç‹¬æ ¡éªŒ `param_limits` ä¸­çš„é™åˆ¶ï¼ˆå¦‚ `lookback_max`ã€`window_max`ï¼‰ã€‚

**ä»£ç é€»è¾‘**ï¼š
```java
Map<String, Object> paramLimits = definition.getParamLimits();
if (paramLimits != null) {
    // æ ¡éªŒ lookback_max
    if (lookback > lookbackMax) {
        throw new ValidationException("lookback è¶…å‡ºé™åˆ¶: " + lookback + 
            " > " + lookbackMax + " (æœ€å¤§å€¼)");
    }
    // æ ¡éªŒ window_max
    ...
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "param_limits": {
    "lookback_max": 365,
    "window_max": 1000
  }
}
```
- âœ… ä¼ å…¥ `{"lookback": 100}` â†’ é€šè¿‡ï¼ˆ100 < 365ï¼‰
- âŒ ä¼ å…¥ `{"lookback": 500}` â†’ å¤±è´¥ï¼šlookback è¶…å‡ºé™åˆ¶: 500 > 365 (æœ€å¤§å€¼)

---

## ä»£ç å®ç°è¯´æ˜

### 4.1 æ ¡éªŒæµç¨‹

```java
public void validate(String indicatorCode, String version, Map<String, Object> params) {
    // 1. è·å–æŒ‡æ ‡å®šä¹‰
    IndicatorDefinition definition = definitionRepository.findByCodeAndVersion(...);
    
    // 2. è·å– param_schema
    Map<String, Object> paramSchema = definition.getParamSchema();
    
    // 3. éå† paramSchema ä¸­çš„æ¯ä¸ªå‚æ•°
    for (Map.Entry<String, Object> entry : paramSchema.entrySet()) {
        String paramName = entry.getKey();
        
        // è·³è¿‡å…ƒæ•°æ®å­—æ®µ
        if ("data_source".equals(paramName) || 
            "impl_key".equals(paramName) || 
            "param_limits".equals(paramName)) {
            continue;
        }
        
        // è·å–å‚æ•°è§„æ ¼è¯´æ˜
        Map<String, Object> spec = (Map<String, Object>) entry.getValue();
        
        // 4. æ ¡éªŒå¿…å¡«
        if (Boolean.TRUE.equals(spec.get("required")) && 
            !params.containsKey(paramName)) {
            throw new ValidationException("å‚æ•°ç¼ºå¤±: " + paramName + " (å¿…å¡«)");
        }
        
        // 5. å¦‚æœå‚æ•°å­˜åœ¨ï¼Œæ ¡éªŒç±»å‹ã€èŒƒå›´ã€æšä¸¾
        if (params.containsKey(paramName)) {
            Object value = params.get(paramName);
            validateType(paramName, value, spec);    // ç±»å‹æ ¡éªŒ
            validateRange(paramName, value, spec);   // èŒƒå›´æ ¡éªŒ
            validateEnum(paramName, value, spec);    // æšä¸¾æ ¡éªŒ
        }
    }
    
    // 6. å•ç‹¬æ ¡éªŒ param_limits
    validateParamLimits(definition, params);
}
```

### 4.2 å…³é”®ç‚¹

1. **è·³è¿‡å…ƒæ•°æ®å­—æ®µ**ï¼š`data_source`ã€`impl_key`ã€`param_limits` ä¸æ˜¯å‚æ•°ï¼Œä¸å‚ä¸æ ¡éªŒ
2. **å‚æ•°è§„æ ¼å¿…é¡»æ˜¯ Map**ï¼šå¦‚æœ `spec` ä¸æ˜¯ `Map` ç±»å‹ï¼Œè·³è¿‡è¯¥æ ¡éªŒ
3. **å¯é€‰å‚æ•°**ï¼šå¦‚æœå‚æ•°ä¸å­˜åœ¨ä¸” `required: false`ï¼Œåˆ™ä¸æ ¡éªŒ
4. **ç±»å‹å…¼å®¹æ€§**ï¼š`integer` ç±»å‹æ¥å— `Integer` å’Œ `Long`
5. **BigDecimal ç²¾åº¦**ï¼šä½¿ç”¨ `BigDecimal` è¿›è¡ŒèŒƒå›´æ¯”è¾ƒï¼Œé¿å…ç²¾åº¦é—®é¢˜

---

## ç¤ºä¾‹è¯´æ˜

### 5.1 RSI æŒ‡æ ‡ç¤ºä¾‹

**paramSchema**ï¼š
```json
{
  "period": {
    "type": "integer",
    "required": true,
    "default": 14,
    "min": 1,
    "max": 100
  },
  "data_source": "BAR",
  "impl_key": "ta4j:rsi"
}
```

**å‚æ•°æ ¡éªŒ**ï¼š
- âœ… `{"period": 14}` â†’ é€šè¿‡
- âœ… `{"period": 21}` â†’ é€šè¿‡
- âŒ `{}` â†’ å¤±è´¥ï¼šå‚æ•°ç¼ºå¤±: period (å¿…å¡«)
- âŒ `{"period": 0}` â†’ å¤±è´¥ï¼šå‚æ•°å€¼è¿‡å°: period (æœ€å°å€¼: 1, å®é™…: 0)
- âŒ `{"period": "14"}` â†’ å¤±è´¥ï¼šå‚æ•°ç±»å‹é”™è¯¯: period (æœŸæœ›: integer, å®é™…: String)

---

### 5.2 MACD æŒ‡æ ‡ç¤ºä¾‹

**paramSchema**ï¼š
```json
{
  "fast": {
    "type": "integer",
    "required": true,
    "default": 12,
    "min": 1,
    "max": 100
  },
  "slow": {
    "type": "integer",
    "required": true,
    "default": 26,
    "min": 1,
    "max": 100
  },
  "signal": {
    "type": "integer",
    "required": false,
    "default": 9,
    "min": 1,
    "max": 100
  },
  "data_source": "BAR",
  "impl_key": "ta4j:macd"
}
```

**å‚æ•°æ ¡éªŒ**ï¼š
- âœ… `{"fast": 12, "slow": 26, "signal": 9}` â†’ é€šè¿‡
- âœ… `{"fast": 12, "slow": 26}` â†’ é€šè¿‡ï¼ˆsignal æœ‰é»˜è®¤å€¼ï¼Œéå¿…å¡«ï¼‰
- âŒ `{"fast": 12}` â†’ å¤±è´¥ï¼šå‚æ•°ç¼ºå¤±: slow (å¿…å¡«)
- âŒ `{"fast": 12, "slow": 26, "signal": 200}` â†’ å¤±è´¥ï¼šå‚æ•°å€¼è¿‡å¤§: signal (æœ€å¤§å€¼: 100, å®é™…: 200)

---

### 5.3 å¸¦ param_limits çš„ç¤ºä¾‹

**paramSchema**ï¼š
```json
{
  "lookback": {
    "type": "integer",
    "required": true,
    "default": 50,
    "min": 1,
    "max": 1000
  },
  "param_limits": {
    "lookback_max": 365,
    "window_max": 1000
  },
  "data_source": "BAR"
}
```

**å‚æ•°æ ¡éªŒ**ï¼š
- âœ… `{"lookback": 100}` â†’ é€šè¿‡ï¼ˆ100 åœ¨ min/max èŒƒå›´å†…ï¼Œä¸” < 365ï¼‰
- âŒ `{"lookback": 500}` â†’ å¤±è´¥ï¼šlookback è¶…å‡ºé™åˆ¶: 500 > 365 (æœ€å¤§å€¼)
- âŒ `{"lookback": 0}` â†’ å¤±è´¥ï¼šå‚æ•°å€¼è¿‡å°: lookback (æœ€å°å€¼: 1, å®é™…: 0)

---

## æ€»ç»“

### æ ¡éªŒä¾æ®

**å‚æ•°æ ¡éªŒçš„ä¾æ®æ˜¯ `IndicatorDefinition.paramSchema` å­—æ®µã€‚**

### æ ¡éªŒå†…å®¹

1. **å¿…å¡«æ ¡éªŒ**ï¼šæ ¹æ® `required` å­—æ®µ
2. **ç±»å‹æ ¡éªŒ**ï¼šæ ¹æ® `type` å­—æ®µï¼ˆintegerã€decimalã€stringã€booleanï¼‰
3. **èŒƒå›´æ ¡éªŒ**ï¼šæ ¹æ® `min`ã€`max` å­—æ®µ
4. **æšä¸¾æ ¡éªŒ**ï¼šæ ¹æ® `enum` å­—æ®µ
5. **é™åˆ¶æ ¡éªŒ**ï¼šæ ¹æ® `param_limits` å­—æ®µï¼ˆlookback_maxã€window_maxç­‰ï¼‰

### æ³¨æ„äº‹é¡¹

- âœ… **å…ƒæ•°æ®å­—æ®µè·³è¿‡**ï¼š`data_source`ã€`impl_key`ã€`param_limits` ä¸å‚ä¸å‚æ•°æ ¡éªŒ
- âœ… **å¯é€‰å‚æ•°**ï¼š`required: false` æ—¶ï¼Œå‚æ•°ä¸å­˜åœ¨ä¸æŠ¥é”™
- âœ… **ç±»å‹å…¼å®¹**ï¼š`integer` ç±»å‹æ¥å— `Integer` å’Œ `Long`
- âœ… **ç²¾åº¦å¤„ç†**ï¼šä½¿ç”¨ `BigDecimal` è¿›è¡Œæ•°å€¼æ¯”è¾ƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV2.0  
**æœ€åæ›´æ–°**ï¼š2024-01  
**ç»´æŠ¤è€…**ï¼šqyl

