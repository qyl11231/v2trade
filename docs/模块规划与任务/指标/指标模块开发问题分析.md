# æŒ‡æ ‡æ¨¡å—å¼€å‘é—®é¢˜åˆ†æ

> åŸºäºã€ŠæŒ‡æ ‡æ¨¡å—äº§å“è§„èŒƒã€‹ã€ã€Šå·¥ç¨‹å¼€å‘è§„èŒƒ v1.2.1ã€‹ã€ã€Šåˆ†é˜¶æ®µä»»åŠ¡ã€‹ä¸ç°æœ‰ç³»ç»Ÿä»£ç çš„å¯¹æ¯”åˆ†æ

---

## ğŸ”´ P0 çº§åˆ«é—®é¢˜ï¼ˆé˜»å¡å¼€å‘ï¼Œå¿…é¡»è§£å†³ï¼‰

### 1. äº‹ä»¶ç³»ç»Ÿä¸åŒ¹é…ï¼šBAR_CLOSED vs KlineEvent.isFinal

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒè¦æ±‚ï¼šæ˜ç¡®çš„ `BarEventType.BAR_CLOSED` äº‹ä»¶ä½œä¸ºå”¯ä¸€è§¦å‘ç‚¹
- ç°æœ‰ç³»ç»Ÿï¼šåªæœ‰ `KlineEvent`ï¼ŒåŒ…å« `isFinal` å­—æ®µï¼Œä½†åœ¨ v1.0 é˜¶æ®µé»˜è®¤è®¾ä¸º `false`

**å½±å“**ï¼š
- æ— æ³•ç›´æ¥åˆ¤æ–­"å·²é—­åˆKçº¿"
- æŒ‡æ ‡è®¡ç®—å¯èƒ½åœ¨ forming bar æ—¶è§¦å‘
- è¿åè§„èŒƒä¸­"åªåœ¨ BAR_CLOSED è§¦å‘"çš„çº¦æŸ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ–¹æ¡ˆAï¼šæ‰©å±•ç°æœ‰äº‹ä»¶ç³»ç»Ÿï¼ˆæ¨èï¼‰
public enum BarEventType {
    FORMING_UPDATE,
    BAR_CLOSED
}

public record BarClosedEvent(
    String symbol,
    String timeframe,
    long barCloseTime,
    NormalizedBar bar,
    LocalDateTime eventTime
) {}

// æ–¹æ¡ˆBï¼šåŸºäºç°æœ‰KlineEventæ”¹é€ 
// åœ¨KlineAggregatorä¸­ï¼Œå½“èšåˆå®Œæˆæ—¶å‘å¸ƒBarClosedEvent
// æŒ‡æ ‡æ¨¡å—è®¢é˜…BarClosedEventè€ŒéKlineEvent
```

**éœ€è¦ä¿®æ”¹çš„ä»£ç **ï¼š
- `KlineAggregatorImpl`ï¼šå½“èšåˆå®Œæˆæ—¶å‘å¸ƒ `BarClosedEvent`
- `æŒ‡æ ‡æ¨¡å—`ï¼šè®¢é˜… `BarClosedEvent` è€Œéç›´æ¥è®¢é˜… `KlineEvent`

---

### 2. æ—¶é—´è¯­ä¹‰ä¸æ˜ç¡®ï¼šbar_time vs bar_close_timeï¼ˆâš ï¸ **æœ€å…³é”®é—®é¢˜**ï¼‰

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒè¦æ±‚ï¼šç»Ÿä¸€ä½¿ç”¨ `bar_close_time`ï¼ˆKçº¿æ”¶ç›˜æ—¶é—´ï¼‰
- ç°æœ‰ç³»ç»Ÿçš„å®é™…æƒ…å†µï¼š

#### 2.1 KlineEvent çš„æ—¶é—´è¯­ä¹‰ï¼ˆâœ… å·²ç¡®è®¤ï¼‰
- `KlineEvent.openTime`ï¼šå¼€ç›˜æ—¶é—´ï¼ˆä» OKX WebSocket æ¥æ”¶çš„ `timestamp`ï¼‰
- `KlineEvent.closeTime`ï¼šæ”¶ç›˜æ—¶é—´ = `openTime + interval_duration`ï¼ˆé€šè¿‡ `calculateCloseTime()` è®¡ç®—ï¼‰
- **ç»“è®º**ï¼š`KlineEvent.closeTime` å°±æ˜¯ `bar_close_time`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨

#### 2.2 QuestDB çš„ `ts` å­—æ®µè¯­ä¹‰ï¼ˆâ“ **å¾…ç¡®è®¤**ï¼‰
- ä»ä»£ç çœ‹ï¼š`ts` å­—æ®µå­˜å‚¨çš„æ˜¯ `NormalizedKline.timestamp`ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰
- ä» `MarketDataCenter` çœ‹ï¼š`NormalizedKline.timestamp` è¢«è®¾ç½®ä¸º `alignedTimestamp`ï¼ˆå¯¹é½åˆ°åˆ†é’Ÿå¼€å§‹ï¼‰
- ä»æ—¥å¿—çœ‹ï¼š`timestamp=1767672960000` â†’ `UTC: 2026-01-06 04:17:00`ï¼ˆåˆ†é’Ÿå¯¹é½ï¼‰
- **æ¨æµ‹**ï¼š`ts` å­—æ®µå¾ˆå¯èƒ½æ˜¯ **å¼€ç›˜æ—¶é—´**ï¼ˆopenTimeï¼‰ï¼Œè€Œä¸æ˜¯æ”¶ç›˜æ—¶é—´

#### 2.3 æ—¶é—´è¯­ä¹‰ä¸ä¸€è‡´çš„é£é™©
å¦‚æœ QuestDB çš„ `ts` æ˜¯å¼€ç›˜æ—¶é—´ï¼š
- æŒ‡æ ‡æ¨¡å—ä» QuestDB è¯»å–æ•°æ®æ—¶ï¼Œ`ts` â‰  `bar_close_time`
- éœ€è¦è½¬æ¢ï¼š`bar_close_time = ts + timeframe_duration`
- å¦‚æœé”™è¯¯åœ°ç›´æ¥ä½¿ç”¨ `ts` ä½œä¸º `bar_close_time`ï¼Œä¼šå¯¼è‡´ï¼š
  - æŒ‡æ ‡è®¡ç®—ç»“æœçš„æ—¶é—´åŸºå‡†é”™è¯¯
  - ç­–ç•¥åˆ¤æ–­æ—¶ä½¿ç”¨é”™è¯¯çš„ bar_time

**å½±å“**ï¼š
- âš ï¸ **æœ€ä¸¥é‡çš„é£é™©**ï¼šå¦‚æœæ—¶é—´è¯­ä¹‰æé”™ï¼Œæ‰€æœ‰æŒ‡æ ‡è®¡ç®—ç»“æœéƒ½æ˜¯é”™çš„
- ç­–ç•¥å¯èƒ½åŸºäºé”™è¯¯çš„ bar_time è¿›è¡Œåˆ¤æ–­

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// åœ¨TimeAlignmentAdapterä¸­æ˜ç¡®è½¬æ¢è§„åˆ™
public interface TimeAlignmentAdapter {
    /**
     * å°†ä¸Šæ¸¸çš„MarketBarè½¬æ¢ä¸ºæŒ‡æ ‡æ¨¡å—ä½¿ç”¨çš„NormalizedBar
     * 
     * @param rawBar ä¸Šæ¸¸Kçº¿ï¼ˆå¯èƒ½æ˜¯QuestDBè¯»å–çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯KlineEventï¼‰
     * @return æ ‡å‡†åŒ–çš„Barï¼ŒbarTimeå¿…é¡»æ˜¯bar_close_timeè¯­ä¹‰
     */
    NormalizedBar normalize(MarketBar rawBar);
    
    /**
     * åˆ¤æ–­ä¸Šæ¸¸bar_timeçš„è¯­ä¹‰å¹¶è½¬æ¢ä¸ºbar_close_time
     * 
     * å·²çŸ¥æƒ…å†µï¼š
     * - KlineEvent.closeTimeï¼šå·²ç»æ˜¯bar_close_timeï¼Œç›´æ¥ä½¿ç”¨
     * - QuestDB.tsï¼šå¯èƒ½æ˜¯openTimeï¼Œéœ€è¦è½¬æ¢ä¸ºbar_close_time
     * 
     * è½¬æ¢è§„åˆ™ï¼ˆéœ€è¦éªŒè¯ï¼‰ï¼š
     * - å¦‚æœ ts æ˜¯å¼€ç›˜æ—¶é—´ï¼šbar_close_time = ts + timeframe_duration
     * - å¦‚æœ ts æ˜¯æ”¶ç›˜æ—¶é—´ï¼šbar_close_time = ts
     */
    LocalDateTime extractBarCloseTime(MarketBar rawBar, Timeframe timeframe);
}

// å®ç°ç¤ºä¾‹
public class QuestDbTimeAdapter implements TimeAlignmentAdapter {
    @Override
    public LocalDateTime extractBarCloseTime(MarketBar rawBar, Timeframe timeframe) {
        // å‡è®¾QuestDBçš„tsæ˜¯å¼€ç›˜æ—¶é—´ï¼ˆéœ€è¦å®é™…éªŒè¯ï¼‰
        long openTime = rawBar.getTimestamp();
        long closeTime = openTime + timeframe.getDurationMillis();
        return Instant.ofEpochMilli(closeTime)
            .atZone(ZoneId.of("UTC"))
            .toLocalDateTime();
    }
}
```

**âš ï¸ éªŒè¯æ–¹æ³•**ï¼š
1. æŸ¥è¯¢ä¸€æ¡å®é™…çš„ QuestDB è®°å½•ï¼Œå¯¹æ¯” `ts` å’Œå®é™… K çº¿çš„å¼€ç›˜/æ”¶ç›˜æ—¶é—´
2. ä¸ OKX å®˜æ–¹æ–‡æ¡£å¯¹æ¯”ï¼Œç¡®è®¤æ—¶é—´è¯­ä¹‰
3. åœ¨é˜¶æ®µ 0 å¼€å‘æ—¶ï¼Œæ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯æ—¶é—´è½¬æ¢é€»è¾‘

---

### 3. æ•°æ®æ¥æºå·²ç¡®è®¤ï¼šQuestDB è¡¨ç»“æ„ï¼ˆâœ… å·²æŸ¥æ˜ï¼‰

**QuestDB è¡¨ç»“æ„**ï¼š

1. **åŸå§‹ 1m K çº¿è¡¨**ï¼š`kline_1m`
   ```sql
   CREATE TABLE kline_1m (
       symbol VARCHAR,
       ts TIMESTAMP,              -- æ—¶é—´æˆ³ï¼ˆUTCï¼Œepoch millisï¼‰
       open DOUBLE,
       high DOUBLE,
       low DOUBLE,
       close DOUBLE,
       volume DOUBLE,
       exchange_ts LONG           -- äº¤æ˜“æ‰€åŸå§‹æ—¶é—´æˆ³
   );
   ```

2. **èšåˆKçº¿è¡¨**ï¼š`kline_{period}` (å¦‚ `kline_5m`, `kline_15m`, `kline_30m`, `kline_1h`, `kline_4h`)
   ```sql
   CREATE TABLE kline_{period} (
       symbol VARCHAR,
       ts TIMESTAMP,              -- æ—¶é—´æˆ³ï¼ˆUTCï¼Œepoch millisï¼‰
       open DOUBLE,
       high DOUBLE,
       low DOUBLE,
       close DOUBLE,
       volume DOUBLE,
       source_kline_count INT     -- èšåˆä½¿ç”¨çš„æºKçº¿æ•°é‡
   );
   ```

**âš ï¸ å…³é”®é—®é¢˜ï¼šts å­—æ®µçš„è¯­ä¹‰ä¸æ˜ç¡®**

ä»ä»£ç å’Œæ—¥å¿—åˆ†æï¼š
- `ts` å­—æ®µå­˜å‚¨çš„æ˜¯ `epoch millis (UTC)`
- æ—¥å¿—æ˜¾ç¤ºï¼š`timestamp=1767672960000` â†’ `UTC: 2026-01-06 04:17:00`
- è¿™ä¸ªæ—¶é—´çœ‹èµ·æ¥æ˜¯ **Kçº¿çš„å¼€ç›˜æ—¶é—´**ï¼ˆåˆ†é’Ÿå¯¹é½ï¼‰ï¼Œè€Œä¸æ˜¯æ”¶ç›˜æ—¶é—´

**éœ€è¦ç¡®è®¤**ï¼š
- `ts` å­—æ®µåˆ°åº•è¡¨ç¤ºä»€ä¹ˆï¼Ÿ
  - é€‰é¡¹Aï¼šå¼€ç›˜æ—¶é—´ï¼ˆopenTimeï¼‰ï¼Ÿ
  - é€‰é¡¹Bï¼šæ”¶ç›˜æ—¶é—´ï¼ˆcloseTime = bar_close_timeï¼‰ï¼Ÿ
  - é€‰é¡¹Cï¼šä¸‹ä¸€å‘¨æœŸå¼€å§‹æ—¶é—´ï¼ˆNEXT_CLOSEï¼‰ï¼Ÿ

**âš ï¸ å¦‚æœ ts æ˜¯å¼€ç›˜æ—¶é—´ï¼Œåˆ™æŒ‡æ ‡æ¨¡å—éœ€è¦è½¬æ¢**ï¼š
```java
// å¦‚æœ ts æ˜¯å¼€ç›˜æ—¶é—´
bar_close_time = ts + timeframe_duration

// ä¾‹å¦‚ 5m Kçº¿ï¼šts = 04:17:00ï¼ˆå¼€ç›˜ï¼‰
// bar_close_time = 04:17:00 + 5åˆ†é’Ÿ = 04:22:00ï¼ˆæ”¶ç›˜ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// éœ€è¦åˆ›å»ºQuestDBæŸ¥è¯¢æœåŠ¡
public interface QuestDbKlineReader {
    /**
     * è¯»å–æŒ‡å®šäº¤æ˜“å¯¹å’Œå‘¨æœŸçš„æœ€æ–°Næ ¹Kçº¿
     * 
     * @param tradingPairId äº¤æ˜“å¯¹IDï¼ˆéœ€è¦è½¬æ¢ä¸ºsymbolï¼‰
     * @param timeframe å‘¨æœŸ
     * @param limit æ•°é‡
     * @return Kçº¿åˆ—è¡¨ï¼ŒæŒ‰æ—¶é—´å‡åºï¼ŒbarTimeå¿…é¡»æ˜¯bar_close_timeè¯­ä¹‰
     */
    List<NormalizedBar> loadLatestBars(
        Long tradingPairId, 
        Timeframe timeframe, 
        int limit
    );
}

// æ¨èï¼šç›´æ¥ä»èšåˆè¡¨è¯»å–ï¼ˆæ€§èƒ½å¥½ï¼Œé¿å…é‡å¤èšåˆï¼‰
// ä» kline_5m, kline_15m ç­‰è¡¨ç›´æ¥è¯»å–
```

---

## ğŸŸ  P1 çº§åˆ«é—®é¢˜ï¼ˆå…³é”®è®¾è®¡ï¼Œå½±å“æ¶æ„ï¼‰

### 4. trading_pair_id ä¸ symbol çš„æ˜ å°„å…³ç³»

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒè¦æ±‚ï¼šæŒ‡æ ‡æ¨¡å—ä½¿ç”¨ `trading_pair_id` ä½œä¸ºå”¯ä¸€æ ‡è¯†
- ç°æœ‰ç³»ç»Ÿï¼š
  - `KlineEvent` ä½¿ç”¨ `symbol`ï¼ˆå¦‚ "BTC-USDT-SWAP"ï¼‰
  - QuestDB å­˜å‚¨ä¹Ÿä½¿ç”¨ `symbol`
  - MySQL ä¸­æœ‰ `trading_pair` è¡¨ï¼Œä½†éœ€è¦ç¡®è®¤æ˜ å°„å…³ç³»

**å½±å“**ï¼š
- æŒ‡æ ‡æ¨¡å—éœ€è¦å»ºç«‹ `symbol` â†” `trading_pair_id` çš„æ˜ å°„
- æŸ¥è¯¢æŒ‡æ ‡æ—¶éœ€è¦å…ˆè½¬æ¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// åˆ›å»ºæ˜ å°„æœåŠ¡
public interface TradingPairMapper {
    Long symbolToTradingPairId(String symbol);
    String tradingPairIdToSymbol(Long tradingPairId);
    TradingPair getTradingPair(Long tradingPairId);
}
```

---

### 5. æŒ‡æ ‡è¡¨ç»“æ„ä¸ç°æœ‰æ•°æ®åº“çš„é›†æˆ

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒå®šä¹‰äº† `indicator_value` è¡¨ï¼Œå­˜å‚¨åœ¨ MySQL
- éœ€è¦ç¡®è®¤ï¼š
  - ä¸ç°æœ‰è¡¨ç»“æ„çš„ä¸€è‡´æ€§ï¼ˆå­—æ®µç±»å‹ã€ç´¢å¼•ç­–ç•¥ï¼‰
  - æ˜¯å¦éœ€è¦æ–°å¢æ•°æ®åº“è¿ç§»è„šæœ¬

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆ›å»º SQL è¿ç§»è„šæœ¬ï¼š`sql/indicator/001_create_indicator_value_table.sql`
- ç¡®ä¿å”¯ä¸€ç´¢å¼•ä¸è§„èŒƒä¸€è‡´
- è€ƒè™‘åˆ†åº“åˆ†è¡¨ç­–ç•¥ï¼ˆå¦‚æœæŒ‡æ ‡æ•°æ®é‡å¤§ï¼‰

---

### 6. ta4j BarSeries ä¸ç°æœ‰ NormalizedKline çš„è½¬æ¢ï¼ˆâœ… å·²æŸ¥æ˜ï¼‰

**ç°æœ‰æ•°æ®ç»“æ„**ï¼š
```java
public class NormalizedKline {
    private String symbol;           // äº¤æ˜“å¯¹ç¬¦å·
    private String interval;         // å‘¨æœŸï¼ˆå¦‚ï¼š1m, 5m, 15mï¼‰
    private Double open;
    private Double high;
    private Double low;
    private Double close;
    private Double volume;
    private Long timestamp;          // æ¯«ç§’æ—¶é—´æˆ³ï¼ˆéœ€è¦ç¡®è®¤è¯­ä¹‰ï¼‰
    private Long exchangeTimestamp;
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// åˆ›å»ºè½¬æ¢é€‚é…å™¨
public class Ta4jBarSeriesAdapter {
    /**
     * å°†NormalizedKlineåˆ—è¡¨è½¬æ¢ä¸ºta4j BarSeries
     * 
     * @param klines Kçº¿åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
     * @param symbol äº¤æ˜“å¯¹ç¬¦å·
     * @return ta4j BarSeries
     */
    public BarSeries toTa4jBarSeries(
        List<NormalizedKline> klines, 
        String symbol
    ) {
        BarSeries series = new BaseBarSeriesBuilder()
            .withName(symbol)
            .build();
            
        for (NormalizedKline kline : klines) {
            ZonedDateTime barTime = Instant.ofEpochMilli(kline.getTimestamp())
                .atZone(ZoneId.of("UTC"));
                
            series.addBar(
                barTime,
                kline.getOpen(),
                kline.getHigh(),
                kline.getLow(),
                kline.getClose(),
                kline.getVolume()
            );
        }
        
        return series;
    }
}
```

**âš ï¸ æ³¨æ„**ï¼š
- è½¬æ¢å‰å¿…é¡»ç¡®è®¤ `timestamp` çš„è¯­ä¹‰
- å¦‚æœ `timestamp` æ˜¯å¼€ç›˜æ—¶é—´ï¼Œéœ€è¦è½¬æ¢ä¸º ta4j çš„ bar timeï¼ˆé€šå¸¸æ˜¯å¼€ç›˜æ—¶é—´ï¼‰
- å¦‚æœ `timestamp` æ˜¯æ”¶ç›˜æ—¶é—´ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´

---

## ğŸŸ¡ P2 çº§åˆ«é—®é¢˜ï¼ˆå®ç°ç»†èŠ‚ï¼Œéœ€è¦æ˜ç¡®ï¼‰

### 7. æŒ‡æ ‡ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒè¦æ±‚æ”¯æŒæŒ‡æ ‡ç‰ˆæœ¬åŒ–ï¼ˆ`indicator_version`ï¼‰
- ä½†æœªæ˜ç¡®ï¼š
  - ç‰ˆæœ¬å·å¦‚ä½•ç”Ÿæˆï¼Ÿï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼Ÿè‡ªåŠ¨é€’å¢ï¼Ÿï¼‰
  - ç‰ˆæœ¬å˜æ›´æ—¶å¦‚ä½•å¤„ç†å†å²æ•°æ®ï¼Ÿ
  - ç­–ç•¥å¦‚ä½•é€‰æ‹©ç‰ˆæœ¬ï¼Ÿ

**å»ºè®®**ï¼š
- V1.2.1 é˜¶æ®µï¼šå›ºå®šä½¿ç”¨ "v1" ç‰ˆæœ¬
- åç»­ç‰ˆæœ¬ï¼šè€ƒè™‘å¼•å…¥ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

---

### 8. æ•°æ®è´¨é‡åˆ¤æ–­çš„è¾¹ç•Œæ¡ä»¶

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒå®šä¹‰äº† `DataQuality`ï¼ˆOK / PARTIAL / INVALIDï¼‰
- ä½†æœªæ˜ç¡®ï¼š
  - "æ•°æ®ä¸è¶³"çš„å…·ä½“åˆ¤æ–­æ ‡å‡†ï¼Ÿ
  - ä¾‹å¦‚ï¼šRSI(14) éœ€è¦è‡³å°‘ 14 æ ¹ K çº¿ï¼Œä½†å¦‚æœåªæœ‰ 13 æ ¹ï¼Œæ˜¯ PARTIAL è¿˜æ˜¯ INVALIDï¼Ÿ

**å»ºè®®**ï¼š
```java
// å®šä¹‰æ˜ç¡®è§„åˆ™
enum DataQualityRule {
    OK {
        boolean matches(int availableBars, int requiredBars) {
            return availableBars >= requiredBars;
        }
    },
    PARTIAL {
        boolean matches(int availableBars, int requiredBars) {
            return availableBars >= requiredBars * 0.8 && availableBars < requiredBars;
        }
    },
    INVALID {
        boolean matches(int availableBars, int requiredBars) {
            return availableBars < requiredBars * 0.8;
        }
    }
}
```

---

### 9. æŒ‡æ ‡è®¡ç®—å¤±è´¥æ—¶çš„å¤„ç†ç­–ç•¥

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒè¦æ±‚ï¼šå¼‚å¸¸æ—¶è·³è¿‡ + å‘Šè­¦
- ä½†æœªæ˜ç¡®ï¼š
  - ä»€ä¹ˆæƒ…å†µç®—"å¤±è´¥"ï¼Ÿï¼ˆå¼‚å¸¸ï¼Ÿè®¡ç®—ç»“æœä¸ºNaNï¼Ÿï¼‰
  - å‘Šè­¦çº§åˆ«ï¼Ÿï¼ˆERRORï¼ŸWARNï¼Ÿï¼‰
  - æ˜¯å¦éœ€è¦é‡è¯•ï¼Ÿ

**å»ºè®®**ï¼š
- è®¡ç®—å¼‚å¸¸ï¼šERROR æ—¥å¿— + Metrics
- ç»“æœä¸º NaNï¼šWARN æ—¥å¿— + æ ‡è®°ä¸º INVALID
- ä¸é‡è¯•ï¼ˆé¿å…é˜»å¡åç»­è®¡ç®—ï¼‰

---

### 10. Redis ç¼“å­˜ç­–ç•¥ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

**é—®é¢˜æè¿°**ï¼š
- è§„èŒƒæåˆ° Redis ç¼“å­˜æœ€æ–°æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰
- ä½†æœªæ˜ç¡®ï¼š
  - ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼Ÿ
  - ç¼“å­˜ä¸ MySQL çš„ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ

**å»ºè®®**ï¼š
- V1.2.1 é˜¶æ®µï¼šå…ˆä¸ä½¿ç”¨ Redisï¼Œç›´æ¥æŸ¥è¯¢ MySQL
- åç»­ä¼˜åŒ–ï¼šå¼•å…¥ç¼“å­˜ï¼Œä½¿ç”¨"å…ˆå†™ MySQLï¼Œååˆ ç¼“å­˜"ç­–ç•¥

---

## ğŸ“‹ å¾…ç¡®è®¤äº‹é¡¹æ¸…å•

### å¿…é¡»ç¡®è®¤ï¼ˆé˜»å¡å¼€å‘ï¼‰
- [x] QuestDB ä¸­ K çº¿æ•°æ®çš„è¡¨åå’Œè¡¨ç»“æ„ï¼ˆâœ… å·²ç¡®è®¤ï¼š`kline_1m`, `kline_{period}`ï¼‰
- [ ] **QuestDB ä¸­ `ts` å­—æ®µçš„è¯­ä¹‰**ï¼ˆâš ï¸ **æœ€å…³é”®**ï¼šæ˜¯å¼€ç›˜æ—¶é—´è¿˜æ˜¯æ”¶ç›˜æ—¶é—´ï¼Ÿï¼‰
- [ ] `KlineEvent.closeTime` çš„è®¡ç®—é€»è¾‘æ˜¯å¦ç¬¦åˆ `bar_close_time` è¯­ä¹‰
- [ ] `symbol` ä¸ `trading_pair_id` çš„æ˜ å°„å…³ç³»å’Œæ•°æ®æ¥æºï¼ˆéœ€è¦æŸ¥è¯¢ `trading_pair` å’Œ `exchange_market_pair` è¡¨ï¼‰
- [x] `NormalizedKline` çš„å®Œæ•´ç»“æ„å®šä¹‰ï¼ˆâœ… å·²ç¡®è®¤ï¼‰

### å»ºè®®ç¡®è®¤ï¼ˆå½±å“å®ç°ï¼‰
- [ ] æŒ‡æ ‡æ¨¡å—æ˜¯å¦åº”è¯¥ç›´æ¥è®¢é˜… `MarketEventBus`ï¼Ÿ
- [ ] è¿˜æ˜¯åº”è¯¥è®¢é˜…æ–°å¢çš„ `BarClosedEvent`ï¼Ÿ
- [ ] å¯åŠ¨æ¢å¤æ—¶ï¼Œæ˜¯å¦éœ€è¦è¡¥ç®—å†å²æŒ‡æ ‡ï¼Ÿ
- [ ] è¿˜æ˜¯åªç­‰å¾…æ–°çš„ BAR_CLOSED äº‹ä»¶ï¼Ÿ

---

## ğŸ¯ å¼€å‘å»ºè®®

### é˜¶æ®µ 0 ä¹‹å‰å¿…é¡»å®Œæˆ
1. **æ˜ç¡®äº‹ä»¶ç³»ç»Ÿ**ï¼šå†³å®šæ˜¯æ‰©å±• `KlineEvent` è¿˜æ˜¯æ–°å¢ `BarClosedEvent`
2. **ç¡®è®¤æ—¶é—´è¯­ä¹‰**ï¼šæ˜ç¡® QuestDB å’Œç°æœ‰ç³»ç»Ÿçš„æ—¶é—´è¯­ä¹‰ï¼Œå®ç° `TimeAlignmentAdapter`
3. **ç¡®è®¤æ•°æ®æ¥æº**ï¼šæ˜ç¡® BarSeries çš„æ•°æ®æ¥æºå’ŒæŸ¥è¯¢æ–¹å¼

### é˜¶æ®µ 1 ä¹‹å‰å¿…é¡»å®Œæˆ
1. å®ç° `QuestDbKlineReader` æ¥å£
2. å®ç° `TradingPairMapper` æ˜ å°„æœåŠ¡
3. åˆ›å»ºæŒ‡æ ‡è¡¨çš„æ•°æ®åº“è¿ç§»è„šæœ¬

### å¼€å‘é¡ºåºå»ºè®®
```
é˜¶æ®µ 0ï¼ˆå·¥ç¨‹éª¨æ¶ï¼‰
  â†“
ã€å¿…é¡»å…ˆè§£å†³P0é—®é¢˜ã€‘
  â†“
é˜¶æ®µ 1ï¼ˆBarSeriesç®¡ç†ï¼‰
  â†“
é˜¶æ®µ 2-7ï¼ˆæŒ‰è§„èŒƒæ¨è¿›ï¼‰
```

---

## âš ï¸ é£é™©æç¤º

1. **æ—¶é—´è¯­ä¹‰é”™è¯¯ä¼šå¯¼è‡´æŒ‡æ ‡è®¡ç®—ç»“æœé”™è¯¯**ï¼ˆæœ€ä¸¥é‡ï¼‰
   - å¦‚æœ QuestDB çš„ `ts` æ˜¯å¼€ç›˜æ—¶é—´ï¼Œä½†æŒ‡æ ‡æ¨¡å—å½“ä½œæ”¶ç›˜æ—¶é—´ä½¿ç”¨ï¼Œä¼šå¯¼è‡´æ‰€æœ‰æŒ‡æ ‡è®¡ç®—é”™è¯¯
   - å¦‚æœ `KlineEvent.closeTime` è®¡ç®—ä¸æ­£ç¡®ï¼Œä¹Ÿä¼šå¯¼è‡´é—®é¢˜
   - **å»ºè®®**ï¼šåœ¨é˜¶æ®µ 0 ä¹‹å‰ï¼Œå¿…é¡»é€šè¿‡å®é™…æ•°æ®éªŒè¯æ—¶é—´è¯­ä¹‰

2. **äº‹ä»¶ç³»ç»Ÿä¸åŒ¹é…å¯èƒ½å¯¼è‡´æŒ‡æ ‡é‡å¤è®¡ç®—æˆ–æ¼ç®—**
   - å½“å‰ `KlineEvent.isFinal` é»˜è®¤ falseï¼Œæ— æ³•å¯é åˆ¤æ–­é—­åˆ
   - **å»ºè®®**ï¼šæ˜ç¡®äº‹ä»¶ç±»å‹ï¼Œæˆ–åŸºäºæ—¶é—´åˆ¤æ–­æ˜¯å¦é—­åˆ

3. **æ•°æ®æ˜ å°„å…³ç³»ä¸æ˜ç¡®**
   - `symbol`ï¼ˆå¦‚ "BTC-USDT-SWAP"ï¼‰éœ€è¦æ˜ å°„åˆ° `trading_pair_id`
   - éœ€è¦æŸ¥è¯¢ `exchange_market_pair` è¡¨è·å–æ˜ å°„å…³ç³»

å»ºè®®åœ¨å¼€å§‹å¼€å‘å‰ï¼Œå…ˆèŠ± 1-2 å¤©æ—¶é—´ï¼š
- æ¢³ç†ç°æœ‰ç³»ç»Ÿçš„æ•°æ®æµ
- ç¡®è®¤ QuestDB è¡¨ç»“æ„å’Œæ—¶é—´è¯­ä¹‰
- è®¾è®¡äº‹ä»¶ç³»ç»Ÿçš„æ‰©å±•æ–¹æ¡ˆ
- ç¼–å†™ P0 é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ–‡æ¡£

