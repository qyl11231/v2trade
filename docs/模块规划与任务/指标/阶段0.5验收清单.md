# 阶段0.5验收清单：数据库迁移 + Repository骨架

## 验收标准

### 0.5.1 迁移脚本验收

- [ ] 本地启动后四张表存在
  - `indicator_definition`
  - `indicator_subscription`
  - `indicator_value`
  - `indicator_calc_log`

- [ ] 字段包含 user_id / created_at（value表含 updated_at）
- [ ] 唯一索引、关键索引存在
- [ ] 迁移可重复执行无报错

**验证方法**：
```sql
-- 检查表是否存在
SHOW TABLES LIKE 'indicator_%';

-- 检查表结构
DESC indicator_definition;
DESC indicator_subscription;
DESC indicator_value;
DESC indicator_calc_log;

-- 检查索引
SHOW INDEX FROM indicator_value;
```

### 0.5.2 Repository接口验收

- [ ] 四个repository可被Spring注入
  - `IndicatorDefinitionRepository`
  - `IndicatorSubscriptionRepository`
  - `IndicatorValueRepository`
  - `IndicatorCalcLogRepository`

- [ ] insertIgnore返回可判断是否插入（INSERTED/IGNORED）

**验证方法**：运行 `IndicatorRepositoryIntegrationTest`

## 测试执行

### 运行阶段0.5验收测试

```bash
# 运行所有阶段0.5测试
mvn test -Dtest=IndicatorRepositoryIntegrationTest

# 或运行特定测试
mvn test -Dtest=IndicatorRepositoryIntegrationTest#testRepositoriesInjected
mvn test -Dtest=IndicatorRepositoryIntegrationTest#testSaveSystemDefinitionsIdempotent
mvn test -Dtest=IndicatorRepositoryIntegrationTest#testInsertIgnoreReturnValue
mvn test -Dtest=IndicatorRepositoryIntegrationTest#testInsertRSI14ValueAndLog
```

### 手动验证数据库

```sql
-- 1. 检查表是否存在
SELECT TABLE_NAME 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'v2_trade' 
  AND TABLE_NAME LIKE 'indicator_%';

-- 2. 检查唯一索引
SELECT INDEX_NAME, COLUMN_NAME 
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'v2_trade' 
  AND TABLE_NAME = 'indicator_value' 
  AND NON_UNIQUE = 0;

-- 3. 执行测试后检查数据
SELECT COUNT(*) FROM indicator_definition WHERE user_id = 0;
SELECT COUNT(*) FROM indicator_value;
SELECT COUNT(*) FROM indicator_calc_log;
```

## 阶段0.5完成标准

✅ 所有验收项通过后才能进入阶段1

- [x] 迁移脚本已创建（sql/indicator/001-004.sql）
- [x] Repository接口符合文档要求
- [x] Repository实现完成
- [x] 集成测试已创建
- [ ] 手动执行迁移脚本并验证
- [ ] 运行集成测试全部通过

## 下一步

**阶段0.5完成后，进入阶段1：BarSeries（历史加载 + 实时append）接入订阅驱动**

