明白：**四张表都要**，并且你已经完成了**阶段0**（工程骨架/契约冻结）。
我现在给你两样东西，保证你能直接落地推进：

1. **四张表的迁移脚本（001~004，生产级，含索引/注释/一致字段）**
2. **从“阶段0 → 阶段1/2/5”怎么把这四张表接入的最小闭环验收清单**（让你排期用）

---

## 1) MySQL 迁移脚本（四张表）

> 约定：统一 `utf8mb4`，统一 `created_at/updated_at`，并保证每张表都有 `user_id`。
> 注意：`indicator_calc_log` 是审计表，不建议强行加外键（高吞吐写入）。

### 001_create_indicator_definition.sql

```sql
CREATE TABLE IF NOT EXISTS `indicator_definition` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID（0=系统内置；>0=用户自定义/企业定制预留）',

  `indicator_code` VARCHAR(64) NOT NULL COMMENT '指标编码（主名，如 RSI、MACD、BOLL）',
  `indicator_name` VARCHAR(128) NOT NULL COMMENT '指标名称（展示用）',
  `indicator_version` VARCHAR(16) NOT NULL DEFAULT 'v1' COMMENT '指标版本：v1（v1.2.1固定）',
  `category` VARCHAR(32) NOT NULL DEFAULT 'GENERAL' COMMENT '分类：TREND/MOMENTUM/VOLATILITY/VOLUME/GENERAL',
  `engine` VARCHAR(32) NOT NULL DEFAULT 'ta4j' COMMENT '计算引擎：ta4j/custom',

  `param_schema` JSON DEFAULT NULL COMMENT '参数Schema（ParameterSpec）',
  `return_schema` JSON DEFAULT NULL COMMENT '返回Schema（ReturnSpec）',
  `min_required_bars` INT NOT NULL DEFAULT 1 COMMENT '最小所需bar数量',
  `supported_timeframes` JSON DEFAULT NULL COMMENT '支持周期列表，如 ["1m","5m","1h"]',

  `enabled` TINYINT NOT NULL DEFAULT 1 COMMENT '是否启用',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_ind_def` (`user_id`,`indicator_code`,`indicator_version`),
  KEY `idx_ind_enabled` (`user_id`,`enabled`),
  KEY `idx_ind_code` (`user_id`,`indicator_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标定义表（元数据/文档/UI/版本预留）';
```

---

### 002_create_indicator_subscription.sql

```sql
CREATE TABLE IF NOT EXISTS `indicator_subscription` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID',

  `trading_pair_id` BIGINT NOT NULL COMMENT '交易对ID',
  `symbol` VARCHAR(64) NOT NULL COMMENT '交易对符号（冗余快照，便于查错）',
  `market_type` VARCHAR(16) NOT NULL DEFAULT 'SWAP' COMMENT '市场类型：SPOT/SWAP/FUTURES（冗余快照）',
  `timeframe` VARCHAR(16) NOT NULL COMMENT '周期：1m/5m/15m/30m/1h/4h...',

  `indicator_code` VARCHAR(64) NOT NULL COMMENT '指标编码（可含参数Key，如 RSI_14 或 RSI）',
  `indicator_version` VARCHAR(16) NOT NULL DEFAULT 'v1' COMMENT '指标版本',
  `params` JSON DEFAULT NULL COMMENT '指标参数快照（如 {"period":14}）',

  `enabled` TINYINT NOT NULL DEFAULT 1 COMMENT '是否启用',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_sub` (`user_id`,`trading_pair_id`,`timeframe`,`indicator_code`,`indicator_version`),
  KEY `idx_pair_tf` (`user_id`,`trading_pair_id`,`timeframe`),
  KEY `idx_ind` (`user_id`,`indicator_code`,`timeframe`),
  KEY `idx_enabled` (`user_id`,`enabled`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标订阅表（决定哪些交易对/周期需要计算哪些指标）';
```

---

### 003_create_indicator_value.sql

```sql
CREATE TABLE IF NOT EXISTS `indicator_value` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID（多租户隔离）',

  `trading_pair_id` BIGINT NOT NULL COMMENT '交易对ID',
  `symbol` VARCHAR(64) NOT NULL COMMENT '交易对符号（冗余快照，便于排查）',
  `market_type` VARCHAR(16) NOT NULL DEFAULT 'SWAP' COMMENT '市场类型：SPOT/SWAP/FUTURES（冗余快照）',

  `timeframe` VARCHAR(16) NOT NULL COMMENT 'K线周期：1m/5m/15m/30m/1h/4h...',
  `bar_time` DATETIME NOT NULL COMMENT 'K线收盘时间（UTC，bar_close_time语义）',

  `indicator_code` VARCHAR(64) NOT NULL COMMENT '指标编码：RSI/MACD/BOLL/MA 等',
  `indicator_version` VARCHAR(16) NOT NULL DEFAULT 'v1' COMMENT '指标版本：v1（v1.2.1固定）',

  `value` DECIMAL(28,12) DEFAULT NULL COMMENT '单值指标结果',
  `extra_values` JSON DEFAULT NULL COMMENT '多值指标结果（如BOLL上中下，MACD三线等）',

  `data_quality` VARCHAR(16) NOT NULL DEFAULT 'OK' COMMENT '数据质量：OK/PARTIAL/INVALID',
  `calc_engine` VARCHAR(32) NOT NULL DEFAULT 'ta4j' COMMENT '计算引擎：ta4j/custom',
  `calc_fingerprint` CHAR(64) NOT NULL COMMENT '计算指纹：hash(code+version+params+engine)',
  `calc_cost_ms` INT DEFAULT NULL COMMENT '计算耗时毫秒（用于观测）',

  `source` VARCHAR(32) NOT NULL DEFAULT 'OKX' COMMENT '数据源：OKX（预留多交易所）',

  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_ind_value` (
    `user_id`,`trading_pair_id`,`timeframe`,`bar_time`,`indicator_code`,`indicator_version`
  ),
  KEY `idx_pair_tf_time` (`user_id`,`trading_pair_id`,`timeframe`,`bar_time`),
  KEY `idx_code_time` (`user_id`,`indicator_code`,`timeframe`,`bar_time`),
  KEY `idx_symbol_time` (`user_id`,`symbol`,`timeframe`,`bar_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标事实表（每根bar闭合后的指标结果）';
```

---

### 004_create_indicator_calc_log.sql

```sql
CREATE TABLE IF NOT EXISTS `indicator_calc_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID',

  `trading_pair_id` BIGINT NOT NULL COMMENT '交易对ID',
  `symbol` VARCHAR(64) NOT NULL COMMENT '交易对符号',
  `market_type` VARCHAR(16) NOT NULL DEFAULT 'SWAP' COMMENT '市场类型：SPOT/SWAP/FUTURES（冗余快照）',
  `timeframe` VARCHAR(16) NOT NULL COMMENT '周期',
  `bar_time` DATETIME NOT NULL COMMENT 'bar收盘时间（UTC）',

  `indicator_code` VARCHAR(64) NOT NULL COMMENT '指标编码',
  `indicator_version` VARCHAR(16) NOT NULL DEFAULT 'v1' COMMENT '版本',
  `calc_engine` VARCHAR(32) NOT NULL COMMENT '引擎：ta4j/custom',

  `status` VARCHAR(16) NOT NULL COMMENT '状态：SUCCESS/FAILED/SKIPPED',
  `cost_ms` INT DEFAULT NULL COMMENT '耗时毫秒',
  `error_msg` VARCHAR(512) DEFAULT NULL COMMENT '失败原因摘要',

  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

  PRIMARY KEY (`id`),
  KEY `idx_bar` (`user_id`,`trading_pair_id`,`timeframe`,`bar_time`),
  KEY `idx_status_time` (`user_id`,`status`,`created_at`),
  KEY `idx_ind_time` (`user_id`,`indicator_code`,`timeframe`,`bar_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标计算日志表（审计与性能分析）';
```

---

## 2) 你已完成阶段0 → 下一步怎么排（最小闭环）

你阶段0完成了（接口、包结构、契约冻结）。
接下来建议你这样走，保证每一步都能验收：

### 阶段1（BarSeries）必须新增的验收点

* ✅ 启动加载 365 根：从 QuestDB `kline_{period}` 读
* ✅ 新 BarClosedEvent 来时 append
* ✅ 同一 bar_time 重复到达幂等忽略
* ✅ bar_time 统一为 **bar_close_time（UTC）**

### 阶段2（Definition/Subscription）必须新增的验收点

* ✅ 启动时将内置指标写入 `indicator_definition`（user_id=0）
* ✅ 根据你系统启用的交易对/周期生成 `indicator_subscription`

  * 先做系统默认：user_id=你的用户（或0系统级），enabled=1

### 阶段5（Repository）闭环验收点

* ✅ 每次计算成功：

  * 写 `indicator_value`（幂等）
  * 写 `indicator_calc_log` 一条 SUCCESS
* ✅ 计算失败：

  * 不写 value（或写 INVALID 由你定，v1.2.1推荐写 INVALID 结果也可）
  * 必写 calc_log FAILED
* ✅ 冲突（同唯一键不同值）：

  * 不覆盖
  * calc_log 写 FAILED + error_msg=CONFLICT

---



