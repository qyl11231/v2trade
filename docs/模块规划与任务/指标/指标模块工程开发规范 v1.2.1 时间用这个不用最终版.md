好，这一步我会**以“规范冻结修订”的方式来写**，而不是解释性文字。
你可以**直接把下面内容整体合并进《指标模块工程开发规范 v1.2.1》**，不需要再二次加工。

---

# 《指标模块工程开发规范 v1.2.1》

## 🔒 冻结修订补充条款（Time Semantics Amendment）

> **本补充条款为 v1.2.1 的组成部分，自发布之日起生效。**
> **优先级高于原 3.1 条款中的示例描述。**

---

## 3. 时间语义与事件模型（P0）【修订】

### 3.1 K线时间语义（冻结 · 修订版）

#### 3.1.1 指标模块内部时间语义（唯一标准）

指标模块内部 **统一使用以下时间语义**：

> **`bar_close_time` 表示当前 K 线周期的收盘时间（Close Time）**

其语义定义为：

```text
bar_close_time 表示区间 [bar_close_time - timeframe, bar_close_time)
```

示例（5m K 线）：

| bar_close_time | 实际区间                 |
| -------------- | -------------------- |
| 10:05:00       | [10:00:00, 10:05:00) |
| 10:10:00       | [10:05:00, 10:10:00) |

---

#### 3.1.2 上游行情存储语义兼容规则（重要）

指标模块 **不强制要求上游行情系统的时间存储语义**，
但 **必须在指标模块入口完成时间语义归一化**。

当上游行情系统（如 QuestDB）采用以下语义时：

> **存储的 `bar_time` 表示“下一周期结束时间（NEXT_CLOSE）”**

即：

```text
stored_bar_time = bar_close_time + timeframe
```

指标模块 **必须在接入层进行转换**：

```text
bar_close_time = stored_bar_time - timeframe
```

---

#### 3.1.3 时间语义归一化职责边界（冻结）

| 模块            | 职责                           |
| ------------- | ---------------------------- |
| 行情存储（QuestDB） | 可自由选择时间语义                    |
| 行情订阅 / 聚合     | 不做语义假设                       |
| **指标模块（入口层）** | **必须统一为 bar_close_time**     |
| 指标计算 / 存储     | 仅使用 bar_close_time           |
| 策略模块          | 假设 bar_time = bar_close_time |

> ❗ **禁止任何指标计算、指标存储、策略判断直接使用“未归一化的 bar_time”**

---

#### 3.1.4 BAR 事件触发约束（保持不变）

```java
enum BarEventType {
    FORMING_UPDATE,   // 形成中 K 线（禁止指标计算）
    BAR_CLOSED        // 已闭合 K 线（唯一合法计算点）
}
```

* 只有在 **BAR_CLOSED 且时间已完成语义归一化后**
* 才允许进入指标计算流程

---

#### 3.1.5 不允许的行为（新增 · 冻结）

以下行为被视为 **严重规范违规**：

* ❌ 指标模块假设行情存储时间语义
* ❌ 在指标内部同时存在多种 bar_time 语义
* ❌ 策略模块自行修正 bar_time
* ❌ 使用 forming bar 参与指标计算

---

## 3.1.6 工程实现建议（非规范性说明）

> 本条为实现建议，不影响规范冻结状态。

推荐在指标模块入口实现统一适配器：

```text
MarketBar
   ↓ (TimeAlignmentAdapter)
NormalizedBar(bar_close_time)
   ↓
IndicatorCalculator
```

该适配器 **是指标模块唯一允许处理时间语义的地方**。

---

## 3.1.7 冻结声明（关键）

> **自 v1.2.1 起，`bar_close_time` 是指标模块与策略模块之间的唯一时间语义。**
> **任何新增模块、功能或扩展，必须遵循该约定。**

---

## ✅ 修订完成声明

* 本修订 **不影响现有 QuestDB 表结构**
* 不影响行情订阅与聚合模块
* 不影响指标计算逻辑
* 仅在 **指标模块入口** 增加一次性时间归一化

---

## 🧠 专家级总结（一句话）

> **行情存储可以自由，
> 指标语义必须统一，
> 时间只允许在一个地方被“解释”。**

---

