# æŒ‡æ ‡æ¨¡å— V2 ç‰ˆæœ¬å¼€å‘ä»»åŠ¡è¯¦ç»†æ¸…å•

> **ç‰ˆæœ¬**ï¼šV2.0  
> **åˆ›å»ºæ—¥æœŸ**ï¼š2024-01  
> **ç»´æŠ¤è€…**ï¼šqyl  
> **åŸºäºè§„èŒƒ**ï¼š[æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md](./æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md)

---

## ğŸ“‹ ç›®å½•

1. [ä»»åŠ¡æ€»è§ˆ](#1-ä»»åŠ¡æ€»è§ˆ)
2. [é˜¶æ®µä¸€ï¼šè¾“å…¥äº‹å®å±‚æ”¹é€ ](#2-é˜¶æ®µä¸€è¾“å…¥äº‹å®å±‚æ”¹é€ )
3. [é˜¶æ®µäºŒï¼šå®šä¹‰æ³¨å†Œå±‚å®Œå–„](#3-é˜¶æ®µäºŒå®šä¹‰æ³¨å†Œå±‚å®Œå–„)
4. [é˜¶æ®µä¸‰ï¼šè¿è¡Œæ—¶è¯„ä¼°å±‚å¼€å‘](#4-é˜¶æ®µä¸‰è¿è¡Œæ—¶è¯„ä¼°å±‚å¼€å‘)
5. [é˜¶æ®µå››ï¼šç¼“å­˜å±‚å¼€å‘](#5-é˜¶æ®µå››ç¼“å­˜å±‚å¼€å‘)
6. [é˜¶æ®µäº”ï¼šAPIæ¥å£å¼€å‘](#6-é˜¶æ®µäº”apiæ¥å£å¼€å‘)
7. [é˜¶æ®µå…­ï¼šå‰ç«¯é¡µé¢æ”¹é€ ](#7-é˜¶æ®µå…­å‰ç«¯é¡µé¢æ”¹é€ )
8. [é˜¶æ®µä¸ƒï¼šé…ç½®ä¸ç›‘æ§](#8-é˜¶æ®µä¸ƒé…ç½®ä¸ç›‘æ§)
9. [é˜¶æ®µå…«ï¼šæµ‹è¯•ä¸éªŒæ”¶](#9-é˜¶æ®µå…«æµ‹è¯•ä¸éªŒæ”¶)
10. [é˜¶æ®µä¹ï¼šæ—§ä»£ç æ¸…ç†](#10-é˜¶æ®µä¹æ—§ä»£ç æ¸…ç†)

---

## 1. ä»»åŠ¡æ€»è§ˆ

### ğŸ”´ 1.0 äº§å“çº§èŒè´£è¾¹ç•Œï¼ˆå¿…é¡»å†»ç»“ï¼Œé¿å…è¿”å·¥ï¼‰

#### 1.0.1 IndicatorEvaluateService èŒè´£è¾¹ç•Œ

**äº§å“å®šä½ï¼ˆä¸€å¥è¯å®šä¹‰ï¼‰**ï¼š
> **IndicatorEvaluateService æ˜¯"çº¯è¿è¡Œæ—¶è¯„ä¼°æœåŠ¡"ï¼Œä¸å…³å¿ƒç­–ç•¥ã€ä¸å…³å¿ƒæŒä¹…åŒ–ã€ä¸å…³å¿ƒè®¢é˜…ï¼Œä»…å¯¹ definition + context + params è´Ÿè´£ã€‚**

**ç»„ä»¶æ‹†åˆ†åŸåˆ™ï¼ˆåˆ»æ„æ‹†åˆ†ï¼Œä¸å…è®¸å†å¡é€»è¾‘ï¼‰**ï¼š

```
IndicatorEvaluateServiceï¼ˆçº¯è¿è¡Œæ—¶è¯„ä¼°æœåŠ¡ï¼‰
 â”œâ”€â”€ IndicatorParamValidator      // schema + limits æ ¡éªŒ
 â”œâ”€â”€ IndicatorEngineRouter        // impl_key â†’ plugin è·¯ç”±
 â””â”€â”€ IndicatorCacheManager        // cacheKey + hit/miss ç¼“å­˜
```

**èŒè´£è¾¹ç•Œ**ï¼š
- âœ… **å¿…é¡»åš**ï¼šå‚æ•°æ ¡éªŒã€å¼•æ“è·¯ç”±ã€ç¼“å­˜ç®¡ç†ã€æ‰§è¡Œè®¡ç®—
- âŒ **ä¸¥ç¦åš**ï¼š
  - ä¸æ„ŸçŸ¥ `strategy_id`
  - ä¸æ„ŸçŸ¥ç­–ç•¥è§„åˆ™ï¼ˆentryRulesã€exitRulesç­‰ï¼‰
  - ä¸æŒä¹…åŒ–ç»“æœï¼ˆç»“æœå½’æ¡£ç”±ç­–ç•¥æ¨¡å—è´Ÿè´£ï¼‰
  - ä¸æ„ŸçŸ¥è®¢é˜…ï¼ˆsubscription ä¸å†é©±åŠ¨è®¡ç®—ï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
- ä¸å…è®¸å°†ä¸šåŠ¡é€»è¾‘å¡è¿› FeatureCache æˆ–å…¶ä»–ç»„ä»¶
- é¿å… God Serviceï¼šIndicatorEvaluateService åªåšåè°ƒï¼Œå…·ä½“é€»è¾‘åœ¨å­ç»„ä»¶

---

#### 1.0.2 FeatureCache å®šä½ï¼ˆPhase 2ï¼Œé MVPï¼‰

**âš ï¸ é‡è¦ï¼šFeatureCache ä¸å¾—ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„ä¾èµ–ï¼Œåªèƒ½ä½œä¸ºæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚**

**å®æ–½åŸåˆ™**ï¼š
- âœ… **MVP é˜¶æ®µ**ï¼šå¿…é¡»ä¸ä¾èµ– FeatureCacheï¼ŒåŠŸèƒ½å®Œå…¨å¯ç”¨
- âœ… **Phase 2 é˜¶æ®µ**ï¼šå‹æµ‹å CPU ä¸è¾¾æ ‡æ—¶ï¼Œä½œä¸ºæ€§èƒ½å¢å¼ºé¡¹å¼•å…¥
- âœ… **é™åˆ¶èŒƒå›´**ï¼šåªå…è®¸ cache çº¯å‡½æ•°ç‰¹å¾ï¼ˆSMAã€EMAã€TRã€æœ€é«˜ä½ç­‰åŸºç¡€åºåˆ—ï¼‰
- âŒ **ä¸¥ç¦**ï¼š
  - å°†ä¸šåŠ¡é€»è¾‘å¡è¿› FeatureCache
  - å°† FeatureCache ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„å‰ææ¡ä»¶
  - åœ¨ MVP é˜¶æ®µå¼ºåˆ¶ä¾èµ– FeatureCache

**å®æ–½é¡ºåº**ï¼š
1. **é‡Œç¨‹ç¢‘ 1-5**ï¼šä¸åŒ…å« FeatureCacheï¼ŒåŠŸèƒ½å®Œå…¨å¯ç”¨
2. **é‡Œç¨‹ç¢‘ 6**ï¼šæ€§èƒ½ä¼˜åŒ–é˜¶æ®µï¼Œæ ¹æ®å‹æµ‹ç»“æœå†³å®šæ˜¯å¦å¼•å…¥

---

#### 1.0.3 Evaluate è¾“å‡ºè¾¹ç•Œï¼ˆç¦æ­¢ç­–ç•¥è¯­ä¹‰ï¼‰

**æ ¸å¿ƒåŸåˆ™**ï¼š
> **evaluate åªè¿”å›"è®¡ç®—ç»“æœ"ï¼Œä¸è¿”å›"å¤š/ç©º/æ˜¯å¦æ»¡è¶³æ¡ä»¶"ç­‰ç­–ç•¥è¯­ä¹‰ã€‚**

**å…è®¸çš„è¾“å‡º**ï¼ˆIndicatorEvaluateResultï¼‰ï¼š
- âœ… `values` / `extraValues`ï¼šæŒ‡æ ‡è®¡ç®—å€¼ï¼ˆæ•°å€¼ç»“æœï¼‰
- âœ… `valid`ï¼šæ˜¯å¦æœ‰æ•ˆï¼ˆåŸºäº min_required_barsï¼‰
- âœ… `fingerprint`ï¼šè®¡ç®—æŒ‡çº¹ï¼ˆç”¨äºç­–ç•¥å½’æ¡£ï¼‰
- âœ… `source`ï¼šæ•°æ®æ¥æºï¼ˆCACHE/COMPUTEDï¼‰
- âœ… `costMs`ï¼šè®¡ç®—è€—æ—¶
- âœ… `errorMsg`ï¼šé”™è¯¯ä¿¡æ¯

**ç¦æ­¢çš„è¾“å‡º**ï¼ˆç­–ç•¥è¯­ä¹‰ï¼‰ï¼š
- âŒ `tradeAction`ï¼šäº¤æ˜“åŠ¨ä½œï¼ˆLONG/SHORT/CLOSEç­‰ï¼‰
- âŒ `positionSide`ï¼šæŒä»“æ–¹å‘
- âŒ `signalScore`ï¼šä¿¡å·è¯„åˆ†ï¼ˆç­–ç•¥çº§æ¦‚å¿µï¼‰
- âŒ `entryFlag` / `exitFlag`ï¼šå…¥åœº/å‡ºåœºæ ‡å¿—
- âŒ `weight`ï¼šæƒé‡ï¼ˆç­–ç•¥çº§æ¦‚å¿µï¼‰
- âŒ ä»»ä½•ä¸ç­–ç•¥è§„åˆ™ç›¸å…³çš„è¯­ä¹‰

**åŸå› **ï¼š
- ç­–ç•¥å¤§è„‘å·²æœ‰ `rules_type` / `entryRules` / `weight` ä½“ç³»
- å¦‚æœ indicator å¼€å§‹è¿”å›ç­–ç•¥è¯­ä¹‰ï¼Œä¼šå¯¼è‡´"è§„åˆ™ç®—ä¸€åŠåœ¨æŒ‡æ ‡ï¼Œä¸€åŠåœ¨ç­–ç•¥"çš„ç¾éš¾
- æŒ‡æ ‡æ¨¡å—å¿…é¡»ä¿æŒ"ç­–ç•¥æ— å…³"çš„è¾¹ç•Œ

---

### 1.1 V2 æ ¸å¿ƒå˜åŒ–

**äº§å“å®šä½å˜åŒ–**ï¼š
- âŒ V1.2ï¼šæŒ‡æ ‡ç»“æœäº‹å®åº“ + è‡ªåŠ¨è®¡ç®—è½åº“
- âœ… V2.0ï¼šæŒ‡æ ‡å®šä¹‰æ³¨å†Œä¸­å¿ƒ + è¿è¡Œæ—¶æŒ‰éœ€è¯„ä¼°èƒ½åŠ›ï¼Œç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“

**æ•°æ®æ¨¡å‹å˜åŒ–**ï¼š
- âœ… **ä¿ç•™**ï¼š`indicator_definition`ï¼ˆå•è¡¨ï¼‰
- âŒ **åºŸå¼ƒ**ï¼š`indicator_subscription`ï¼ˆä¸å†ä½œä¸ºäº§å“ä¸»è·¯å¾„ï¼‰
- âŒ **åºŸå¼ƒ**ï¼š`indicator_value`ï¼ˆä¸å†è½åº“ï¼‰
- âŒ **åºŸå¼ƒ**ï¼š`indicator_calc_log`ï¼ˆä¸å†ä½œä¸ºäº§å“ä¸»è·¯å¾„ï¼Œå¯é€‰ä¿ç•™ç”¨äºè°ƒè¯•ï¼‰

**è®¡ç®—æ¨¡å¼å˜åŒ–**ï¼š
- âŒ **åºŸå¼ƒ**ï¼šè®¢é˜…é©±åŠ¨çš„è‡ªåŠ¨è®¡ç®—ï¼ˆæ¯æ ¹barè‡ªåŠ¨è®¡ç®—ï¼‰
- âœ… **æ–°å¢**ï¼šæŒ‰éœ€è¯„ä¼°ï¼ˆevaluate/evaluateBatchï¼‰

---

## 2. é˜¶æ®µä¸€ï¼šè¾“å…¥äº‹å®å±‚æ”¹é€ 

### 2.1 ä»»åŠ¡ B1ï¼šæ–­å¼€ IndicatorCalculator çš„è‡ªåŠ¨è®¡ç®—é“¾è·¯

**ç›®æ ‡**ï¼šä¿ç•™ BarSeriesManager çš„ K çº¿ç»´æŠ¤åŠŸèƒ½ï¼Œæ–­å¼€è‡ªåŠ¨è®¡ç®—è§¦å‘

#### 2.1.1 ä¿®æ”¹ BarSeriesManager

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/series/BarSeriesManager.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **ä¿ç•™**ï¼š`bootstrap()` æ–¹æ³•ï¼ˆå¯åŠ¨æ—¶åŠ è½½å†å²æ•°æ®ï¼‰
2. âœ… **ä¿ç•™**ï¼š`onBarClosed()` æ–¹æ³•ï¼ˆè¿½åŠ æ–°baråˆ°Seriesï¼‰
3. âœ… **ä¿ç•™**ï¼š`getSeries()` æ–¹æ³•ï¼ˆè·å–åªè¯»è§†å›¾ï¼‰
4. âŒ **åˆ é™¤**ï¼šç§»é™¤æ‰€æœ‰ä¸ `IndicatorCalculator` çš„è€¦åˆä»£ç 
5. ğŸ”§ **éªŒè¯**ï¼šç¡®è®¤ä¸å†è§¦å‘ä»»ä½•æŒ‡æ ‡è®¡ç®—æµç¨‹

**ä»£ç å˜æ›´**ï¼š
```java
// åˆ é™¤æˆ–æ³¨é‡Šæ‰æ‰€æœ‰è§¦å‘ IndicatorCalculator çš„ä»£ç 
// ç¡®ä¿ onBarClosed() åªåšï¼š
// 1. å°† Bar è¿½åŠ åˆ°å¯¹åº”çš„ Seriesï¼ˆå»é‡ï¼‰
// 2. è‡ªåŠ¨ç»´æŠ¤æœ€æ–°365æ ¹ï¼Œå»é™¤æœ€æ—§çš„
// ä¸å†æœ‰ä»»ä½•è®¡ç®—ç›¸å…³çš„è°ƒç”¨
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] BarSeriesManager åœ¨ 5m/15m/30m/1h/4h å‘¨æœŸç»§ç»­ç»´æŠ¤ 365 æ ¹çª—å£
- [ ] `onBarClosed()` ä¸å†è§¦å‘ä»»ä½•"æŒ‰è®¢é˜…è®¡ç®—æŒ‡æ ‡"æµç¨‹
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ï¼š`BarSeriesManagerTest`
- [ ] é›†æˆæµ‹è¯•ï¼šBarClosedEvent åˆ°è¾¾åï¼Œåªæ›´æ–° Seriesï¼Œä¸è®¡ç®—æŒ‡æ ‡

---

#### 2.1.2 å…³é—­ IndicatorCalculatorï¼ˆFeature Flagï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/calculator/IndicatorCalculator.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼šæ·»åŠ  Feature Flag é…ç½®é¡¹
2. ğŸ”§ **ä¿®æ”¹**ï¼š`onBarClosed()` æ–¹æ³•å¢åŠ å¼€å…³åˆ¤æ–­
3. âœ… **ä¿ç•™**ï¼šä»£ç ä¿ç•™ä½œä¸ºå‚è€ƒï¼Œä½†ä¸æ‰§è¡Œ

**ä»£ç å˜æ›´**ï¼š
```java
@Value("${indicator.auto-calculate.enabled:false}")
private boolean autoCalculateEnabled;

@EventListener
@Async("indicatorCalculatorExecutor")
public void onBarClosed(BarClosedEvent event) {
    // V2: é»˜è®¤å…³é—­è‡ªåŠ¨è®¡ç®—
    if (!autoCalculateEnabled) {
        log.debug("è‡ªåŠ¨è®¡ç®—å·²å…³é—­ï¼Œè·³è¿‡æŒ‡æ ‡è®¡ç®—: pairId={}, timeframe={}", 
                event.tradingPairId(), event.timeframe());
        return;
    }
    // åŸæœ‰é€»è¾‘ä¿ç•™ï¼ˆä½†é»˜è®¤ä¸æ‰§è¡Œï¼‰
    // ...
}
```

**é…ç½®æ–‡ä»¶å˜æ›´**ï¼š`src/main/resources/application.yml`
```yaml
indicator:
  auto-calculate:
    enabled: false  # V2: é»˜è®¤å…³é—­
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é…ç½®é¡¹ `indicator.auto-calculate.enabled=false` æ—¶ï¼Œä¸æ‰§è¡Œè®¡ç®—
- [ ] æ—¥å¿—æ˜ç¡®è®°å½•"è‡ªåŠ¨è®¡ç®—å·²å…³é—­"
- [ ] è®¾ç½®ä¸º `true` æ—¶ä»èƒ½æ‰§è¡Œï¼ˆå‘åå…¼å®¹æµ‹è¯•ï¼‰

---

### 2.2 ä»»åŠ¡ B2ï¼šç»Ÿä¸€ bar_time è¯­ä¹‰éªŒè¯

**ç›®æ ‡**ï¼šç¡®ä¿æ‰€æœ‰ evaluate ä½¿ç”¨çš„ `asOfBarTime` éƒ½æ˜¯ `bar_close_time` UTC è¯­ä¹‰

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ” **æ£€æŸ¥**ï¼š`NormalizedBar` çš„æ—¶é—´è¯­ä¹‰
2. ğŸ” **æ£€æŸ¥**ï¼š`BarSeriesManager` çš„æ—¶é—´å¤„ç†
3. ğŸ” **æ£€æŸ¥**ï¼š`QuestDbTsSemanticsProbe` çš„æ£€æµ‹é€»è¾‘
4. ğŸ“ **æ–‡æ¡£**ï¼šæ˜ç¡®æ‰€æœ‰ evaluate æ¥å£çš„ `asOfBarTime` å‚æ•°å¿…é¡»æ˜¯ `bar_close_time` UTC

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ‰€æœ‰æ—¶é—´ç›¸å…³çš„ä»£ç æ³¨é‡Šæ˜ç¡®è¯´æ˜ä½¿ç”¨ `bar_close_time` UTC
- [ ] `NormalizedBar.getBarTime()` è¿”å›çš„æ˜¯æ”¶ç›˜æ—¶é—´
- [ ] evaluate æ¥å£çš„ `asOfBarTime` å‚æ•°æ–‡æ¡£æ˜ç¡®è¯´æ˜è¯­ä¹‰

---

## 3. é˜¶æ®µäºŒï¼šå®šä¹‰æ³¨å†Œå±‚å®Œå–„

### 3.1 ä»»åŠ¡ A2ï¼šæ‰©å±• indicator_definition è¡¨å­—æ®µ

**ç›®æ ‡**ï¼šæ”¯æŒ V2 éœ€è¦çš„å­—æ®µï¼ˆdata_sourceã€impl_key ç­‰ï¼‰

#### 3.1.1 æ•°æ®åº“è¡¨ç»“æ„æ‰©å±•

**æ–¹æ¡ˆé€‰æ‹©**ï¼š**ä¼˜å…ˆä½¿ç”¨ JSON å­—æ®µæ‰©å±•ï¼Œé¿å… ALTER TABLE**

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/sql/indicator/001_create_indicator_definition.sql`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ“ **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šæ‰©å±•ç°æœ‰ JSON å­—æ®µ
   - `param_schema` JSONï¼šæ·»åŠ  `param_limits` å­å­—æ®µ
   - `return_schema` JSONï¼šä¿æŒä¸å˜
   - æ–°å¢å­—æ®µæ”¾åˆ° JSON ä¸­ï¼Œæ— éœ€ ALTER TABLE

2. ğŸ“ **æ–¹æ¡ˆ2ï¼ˆå¤‡é€‰ï¼‰**ï¼šå¦‚æœå¿…é¡»ä½¿ç”¨ç‹¬ç«‹å­—æ®µï¼Œåˆ™ ALTER TABLEï¼š
   ```sql
   ALTER TABLE indicator_definition
   ADD COLUMN data_source VARCHAR(32) DEFAULT 'BAR' COMMENT 'æ•°æ®æºï¼šBAR/TICK/SIGNAL/MIXED',
   ADD COLUMN impl_key VARCHAR(128) DEFAULT NULL COMMENT 'å®ç°æ˜ å°„é”®ï¼ˆå¦‚ ta4j:rsiï¼‰';
   ```

**å»ºè®®**ï¼šä½¿ç”¨æ–¹æ¡ˆ1ï¼Œåœ¨ `param_schema` ä¸­æ‰©å±•ï¼š
```json
{
  "param_schema": {
    "period": {"type": "integer", "required": true, "default": 14, "min": 1, "max": 100},
    "param_limits": {"lookback_max": 365, "window_max": 1000}
  },
  "data_source": "BAR",
  "impl_key": "ta4j:rsi"
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] è¡¨ç»“æ„æ”¯æŒå­˜å‚¨ `data_source`ã€`impl_key`ã€`param_limits`
- [ ] ç°æœ‰æ•°æ®ä¸å—å½±å“ï¼ˆå‘åå…¼å®¹ï¼‰
- [ ] è¿ç§»è„šæœ¬å·²å‡†å¤‡ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆ2ï¼‰

---

#### 3.1.2 å®ä½“ç±»æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/entity/IndicatorDefinition.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–¹æ¡ˆ1**ï¼šæ‰©å±•ç°æœ‰ JSON å­—æ®µçš„ getter/setter
2. ğŸ”§ **æ–¹æ¡ˆ2**ï¼šå¦‚æœä½¿ç”¨ç‹¬ç«‹å­—æ®µï¼Œæ–°å¢å±æ€§ï¼š
   ```java
   private String dataSource;  // BAR / TICK / SIGNAL / MIXED
   private String implKey;     // ta4j:rsi / builtin:price_breakout
   ```

**ä»£ç ç¤ºä¾‹**ï¼ˆä½¿ç”¨ JSON æ‰©å±•ï¼‰ï¼š
```java
// ä» param_schema JSON ä¸­æå– param_limits
public Map<String, Object> getParamLimits() {
    if (paramSchema == null) return null;
    return (Map<String, Object>) paramSchema.get("param_limits");
}

public void setParamLimits(Map<String, Object> limits) {
    if (paramSchema == null) {
        paramSchema = new HashMap<>();
    }
    paramSchema.put("param_limits", limits);
}

// data_source å’Œ impl_key å¯ä»¥æ”¾åœ¨ param_schema çš„é¡¶å±‚ï¼Œæˆ–è€…ä½œä¸ºç‹¬ç«‹å­—æ®µ
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å®ä½“ç±»æ”¯æŒè¯»å–å’Œå†™å…¥æ–°å­—æ®µ
- [ ] MyBatis æ˜ å°„æ­£ç¡®ï¼ˆå¦‚æœä½¿ç”¨ç‹¬ç«‹å­—æ®µï¼‰
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

---

#### 3.1.3 Repository å±‚æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorDefinitionRepository.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼šæŒ‰ `data_source` æŸ¥è¯¢çš„æ–¹æ³•
2. ğŸ”§ **æ–°å¢**ï¼šæŒ‰ `impl_key` æŸ¥è¯¢çš„æ–¹æ³•
3. ğŸ”§ **æ–°å¢**ï¼šå‚æ•°æ ¡éªŒé€»è¾‘ï¼ˆåŸºäº `param_schema` å’Œ `param_limits`ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// æŒ‰ data_source æŸ¥è¯¢
List<IndicatorDefinition> findByDataSource(String dataSource);

// æŒ‰ impl_key æŸ¥è¯¢
Optional<IndicatorDefinition> findByImplKey(String implKey);

// å‚æ•°æ ¡éªŒ
ValidationResult validateParams(String indicatorCode, String version, Map<String, Object> params);
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ–°å¢æŸ¥è¯¢æ–¹æ³•å¯ç”¨
- [ ] å‚æ•°æ ¡éªŒé€»è¾‘å®Œæ•´ï¼ˆå¿…å¡«ã€ç±»å‹ã€èŒƒå›´ã€æšä¸¾ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¡éªŒåœºæ™¯

---

#### 3.1.4 å‚æ•°æ ¡éªŒæœåŠ¡

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/validation/IndicatorParamValidator.java`ï¼ˆæ–°å»ºï¼‰

**ğŸ”´ èŒè´£è¾¹ç•Œ**ï¼š
- IndicatorParamValidator æ˜¯ç‹¬ç«‹çš„æ ¡éªŒç»„ä»¶ï¼Œåªè´Ÿè´£å‚æ•°æ ¡éªŒ
- å¿…é¡»ä» IndicatorEvaluateService ä¸­æ‹†åˆ†å‡ºæ¥ï¼Œä¸å…è®¸åˆå¹¶
- åªæ ¡éªŒå‚æ•°æ ¼å¼ã€ç±»å‹ã€èŒƒå›´ï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼šå‚æ•°æ ¡éªŒæœåŠ¡ç±»ï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰
2. ğŸ”§ **å®ç°**ï¼šåŸºäº `param_schema` çš„æ ¡éªŒé€»è¾‘
3. ğŸ”§ **å®ç°**ï¼šåŸºäº `param_limits` çš„é™åˆ¶æ£€æŸ¥

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ ¡éªŒå¿…å¡«å‚æ•°
- æ ¡éªŒå‚æ•°ç±»å‹ï¼ˆintegerã€decimalã€stringã€booleanï¼‰
- æ ¡éªŒå‚æ•°èŒƒå›´ï¼ˆminã€maxï¼‰
- æ ¡éªŒæšä¸¾å€¼
- æ ¡éªŒ lookback ä¸Šé™ã€çª—å£ä¸Šé™ç­‰é™åˆ¶

**æ¥å£å®šä¹‰**ï¼š
```java
public interface IndicatorParamValidator {
    /**
     * æ ¡éªŒå‚æ•°
     * @param indicatorCode æŒ‡æ ‡ç¼–ç 
     * @param version ç‰ˆæœ¬
     * @param params å‚æ•°
     * @throws ValidationException æ ¡éªŒå¤±è´¥æ—¶æŠ›å‡º
     */
    void validate(String indicatorCode, String version, Map<String, Object> params);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å‰ç«¯èƒ½ä»…é  definition çš„ `param_schema` æ‹‰èµ·è¡¨å•
- [ ] åç«¯èƒ½æŒ‰ schema æ ¡éªŒ paramsï¼ˆå¿…å¡«ã€èŒƒå›´ã€æšä¸¾ï¼‰
- [ ] å‚æ•°è¶Šç•Œæ—¶è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¡éªŒåœºæ™¯

---

### 3.2 ä»»åŠ¡ï¼šIndicatorDefinitionController æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/api/IndicatorDefinitionController.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ‰©å±•**ï¼šæ”¯æŒæ–°å­—æ®µçš„ CRUD
2. ğŸ”§ **æ–°å¢**ï¼šå‚æ•°æ ¡éªŒæ¥å£ï¼ˆç”¨äºå‰ç«¯è¡¨å•æ ¡éªŒï¼‰
3. ğŸ”§ **ä¿®æ”¹**ï¼šä»"åªè¯»"å‡çº§ä¸º"å¯ç¼–è¾‘"ï¼ˆV1 UI æ˜¯åªè¯»ï¼‰

**æ¥å£æ‰©å±•**ï¼š
```java
// åŸæœ‰æ¥å£ä¿æŒä¸å˜ï¼Œæ–°å¢ï¼š
@PostMapping("/definitions/{id}/validate-params")
public Result<ValidationResult> validateParams(
    @PathVariable Long id,
    @RequestBody Map<String, Object> params);
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ”¯æŒåˆ›å»º/ç¼–è¾‘æŒ‡æ ‡å®šä¹‰ï¼ˆåŒ…æ‹¬æ–°å­—æ®µï¼‰
- [ ] å‚æ•°æ ¡éªŒæ¥å£å¯ç”¨
- [ ] å‰ç«¯å¯ä»¥è°ƒç”¨æ ¡éªŒæ¥å£è¿›è¡Œå®æ—¶æ ¡éªŒ

---

## 4. é˜¶æ®µä¸‰ï¼šè¿è¡Œæ—¶è¯„ä¼°å±‚å¼€å‘

### 4.1 ä»»åŠ¡ C1ï¼šæ–°å¢ IndicatorEvaluateService

**ç›®æ ‡**ï¼šæä¾›ç»Ÿä¸€çš„æŒ‰éœ€è¯„ä¼°å…¥å£

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/runtime/IndicatorEvaluateService.java`ï¼ˆæ–°å»ºï¼‰

**ğŸ”´ èŒè´£è¾¹ç•Œï¼ˆå¿…é¡»éµå®ˆï¼‰**ï¼š
- IndicatorEvaluateService æ˜¯"çº¯è¿è¡Œæ—¶è¯„ä¼°æœåŠ¡"ï¼Œåªè´Ÿè´£åè°ƒè°ƒç”¨
- å…·ä½“é€»è¾‘å¿…é¡»æ‹†åˆ†åˆ°å­ç»„ä»¶ï¼š
  - `IndicatorParamValidator`ï¼šå‚æ•°æ ¡éªŒ
  - `IndicatorEngineRouter`ï¼šå¼•æ“è·¯ç”±
  - `IndicatorCacheManager`ï¼šç¼“å­˜ç®¡ç†
- **ä¸¥ç¦**ï¼šå°†ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ IndicatorEvaluateService ä¸­

#### 4.1.1 åˆ›å»ºæ ¸å¿ƒæœåŠ¡ç±»

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼š`IndicatorEvaluateService` æ¥å£å’Œå®ç°ç±»
2. ğŸ”§ **å®ç°**ï¼š`evaluate()` å•æ¬¡è¯„ä¼°æ–¹æ³•ï¼ˆåªåšåè°ƒï¼Œå…·ä½“é€»è¾‘è°ƒç”¨å­ç»„ä»¶ï¼‰
3. ğŸ”§ **å®ç°**ï¼š`evaluateBatch()` æ‰¹é‡è¯„ä¼°æ–¹æ³•ï¼ˆåªåšåè°ƒï¼Œå…·ä½“é€»è¾‘è°ƒç”¨å­ç»„ä»¶ï¼‰
4. ğŸ”§ **é›†æˆ**ï¼šä¾èµ–æ³¨å…¥ `IndicatorParamValidator`ã€`IndicatorEngineRouter`ã€`IndicatorCacheManager`
5. âœ… **éªŒè¯**ï¼šç¡®ä¿æ²¡æœ‰ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ Service ä¸­

**æ¥å£å®šä¹‰**ï¼š
```java
public interface IndicatorEvaluateService {
    /**
     * å•æ¬¡è¯„ä¼°
     * @param indicatorCode æŒ‡æ ‡ç¼–ç 
     * @param version ç‰ˆæœ¬
     * @param params å‚æ•°
     * @param context è¯„ä¼°ä¸Šä¸‹æ–‡ï¼ˆpairIdã€timeframeã€asOfBarTimeï¼‰
     * @return è¯„ä¼°ç»“æœ
     */
    IndicatorEvaluateResult evaluate(
        String indicatorCode,
        String version,
        Map<String, Object> params,
        EvaluationContext context
    );
    
    /**
     * æ‰¹é‡è¯„ä¼°
     * @param context è¯„ä¼°ä¸Šä¸‹æ–‡
     * @param requests è¯„ä¼°è¯·æ±‚åˆ—è¡¨
     * @return è¯„ä¼°ç»“æœåˆ—è¡¨ï¼ˆä¸ requests é¡ºåºä¸€è‡´ï¼‰
     */
    List<IndicatorEvaluateResult> evaluateBatch(
        EvaluationContext context,
        List<EvaluationRequest> requests
    );
}
```

**EvaluationContext å®šä¹‰**ï¼š
```java
public class EvaluationContext {
    private Long userId;
    private Long tradingPairId;
    private String timeframe;
    private LocalDateTime asOfBarTime;  // bar_close_time UTC
}
```

**EvaluationRequest å®šä¹‰**ï¼š
```java
public class EvaluationRequest {
    private String indicatorCode;
    private String version;
    private Map<String, Object> params;
}
```

**IndicatorEvaluateResult å®šä¹‰**ï¼š
```java
/**
 * æŒ‡æ ‡è¯„ä¼°ç»“æœ
 * 
 * ğŸ”´ è¾“å‡ºè¾¹ç•Œï¼šåªè¿”å›è®¡ç®—ç»“æœï¼Œä¸è¿”å›ç­–ç•¥è¯­ä¹‰
 * - å…è®¸ï¼švaluesã€validã€fingerprintã€sourceã€costMsã€errorMsg
 * - ç¦æ­¢ï¼štradeActionã€positionSideã€signalScoreã€entryFlagã€exitFlagã€weight ç­‰ç­–ç•¥è¯­ä¹‰
 */
public class IndicatorEvaluateResult {
    private boolean valid;  // æ˜¯å¦æœ‰æ•ˆï¼ˆåŸºäº min_required_barsï¼‰
    private String source;  // CACHE / COMPUTED
    private Map<String, BigDecimal> values;  // å•å€¼æˆ–å¤šå€¼ï¼ˆæŒ‡æ ‡è®¡ç®—å€¼ï¼‰
    private String fingerprint;  // è®¡ç®—æŒ‡çº¹ï¼ˆç”¨äºç­–ç•¥å½’æ¡£ï¼‰
    private Integer costMs;  // è€—æ—¶
    private String errorMsg;  // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
    
    // âŒ ç¦æ­¢æ·»åŠ ä»¥ä¸‹å­—æ®µï¼ˆç­–ç•¥è¯­ä¹‰ï¼‰ï¼š
    // private String tradeAction;      // ç¦æ­¢
    // private String positionSide;     // ç¦æ­¢
    // private BigDecimal signalScore;  // ç¦æ­¢
    // private Boolean entryFlag;       // ç¦æ­¢
    // private Boolean exitFlag;        // ç¦æ­¢
    // private BigDecimal weight;       // ç¦æ­¢
}
```

**å®ç°é€»è¾‘**ï¼ˆå¿…é¡»æ‹†åˆ†åˆ°å­ç»„ä»¶ï¼‰ï¼š
```java
@Override
public IndicatorEvaluateResult evaluate(String indicatorCode, String version,
                                        Map<String, Object> params,
                                        EvaluationContext context) {
    // 1. å‚æ•°æ ¡éªŒï¼ˆè°ƒç”¨ IndicatorParamValidatorï¼‰
    paramValidator.validate(indicatorCode, version, params);
    
    // 2. ç”Ÿæˆç¼“å­˜é”®ï¼ˆè°ƒç”¨ IndicatorCacheManagerï¼‰
    String cacheKey = cacheManager.generateCacheKey(indicatorCode, version, 
                                                     context, params);
    
    // 3. æŸ¥è¯¢ç¼“å­˜ï¼ˆè°ƒç”¨ IndicatorCacheManagerï¼‰
    Optional<IndicatorEvaluateResult> cached = cacheManager.get(cacheKey);
    if (cached.isPresent()) {
        return cached.get();
    }
    
    // 4. ç¼“å­˜æœªå‘½ä¸­ï¼šæ‰§è¡Œè®¡ç®—
    //    - è·å–æŒ‡æ ‡å®šä¹‰ï¼ˆRepositoryï¼‰
    //    - è·å– BarSeriesï¼ˆBarSeriesManagerï¼‰
    //    - æ£€æŸ¥ min_required_bars
    //    - è·¯ç”±åˆ°å¯¹åº”å¼•æ“ï¼ˆè°ƒç”¨ IndicatorEngineRouterï¼‰
    IndicatorEngine engine = engineRouter.getEngine(definition);
    IndicatorResult result = engine.compute(request, series);
    
    //    - æ ¡éªŒè¿”å›ç»“æœï¼ˆreturn_schemaï¼‰
    //    - æ„å»º IndicatorEvaluateResult
    IndicatorEvaluateResult evaluateResult = buildResult(result, cacheKey);
    
    //    - å†™å…¥ç¼“å­˜ï¼ˆè°ƒç”¨ IndicatorCacheManagerï¼‰
    cacheManager.put(cacheKey, evaluateResult);
    
    // 5. è¿”å›ç»“æœ
    return evaluateResult;
}
```

**âš ï¸ å…³é”®åŸåˆ™**ï¼š
- Service åªåšåè°ƒè°ƒç”¨ï¼Œä¸åŒ…å«å…·ä½“ä¸šåŠ¡é€»è¾‘
- æ‰€æœ‰å…·ä½“é€»è¾‘éƒ½åœ¨å­ç»„ä»¶ä¸­å®ç°
- ä¸¥ç¦åœ¨ Service ä¸­ç›´æ¥å†™æ ¡éªŒã€è·¯ç”±ã€ç¼“å­˜é€»è¾‘

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ”¯æŒ ta4j/custom å¼•æ“ï¼ˆæ²¿ç”¨ç°æœ‰ engine æ¦‚å¿µï¼‰
- [ ] èƒ½æ ¹æ® `min_required_bars` åˆ¤å®š valid/invalid
- [ ] è¿”å›ç»“æ„æ”¯æŒå•å€¼/å¤šå€¼ï¼ˆå¯¹é½ value/extra_values çš„è¯­ä¹‰ï¼‰
- [ ] **èŒè´£è¾¹ç•ŒéªŒè¯**ï¼šService åªåšåè°ƒï¼Œå…·ä½“é€»è¾‘åœ¨å­ç»„ä»¶
- [ ] **è¾“å‡ºè¾¹ç•ŒéªŒè¯**ï¼šä¸åŒ…å«ä»»ä½•ç­–ç•¥è¯­ä¹‰å­—æ®µ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰åœºæ™¯
- [ ] é›†æˆæµ‹è¯•ï¼ševaluate èƒ½æ­£ç¡®è®¡ç®—æŒ‡æ ‡

---

#### 4.1.2 å¼•æ“è·¯ç”±é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/runtime/IndicatorEngineRouter.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ‰©å±•**ï¼šæ”¯æŒé€šè¿‡ `impl_key` è·¯ç”±åˆ°å¯¹åº”å¼•æ“
2. ğŸ”§ **ä¿ç•™**ï¼šç°æœ‰çš„é€šè¿‡ `engine` å­—æ®µè·¯ç”±çš„é€»è¾‘ï¼ˆå‘åå…¼å®¹ï¼‰
3. ğŸ”§ **æ–°å¢**ï¼š`impl_key` åˆ°å¼•æ“çš„æ˜ å°„è¡¨

**ä»£ç ç¤ºä¾‹**ï¼š
```java
public IndicatorEngine getEngine(IndicatorDefinition definition) {
    // ä¼˜å…ˆä½¿ç”¨ impl_key
    if (definition.getImplKey() != null) {
        IndicatorEngine engine = implKeyMap.get(definition.getImplKey());
        if (engine != null) {
            return engine;
        }
    }
    // å›é€€åˆ° engine å­—æ®µ
    return engineMap.get(definition.getEngine());
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åŒä¸€ `indicator_code+version` èƒ½æ­£ç¡®è·¯ç”±åˆ° `impl_key` å¯¹åº”ç¡¬ä»£ç 
- [ ] å‘åå…¼å®¹ï¼šæ²¡æœ‰ `impl_key` æ—¶ä½¿ç”¨ `engine` å­—æ®µ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–è·¯ç”±é€»è¾‘

---

#### 4.1.3 æ‰¹é‡è¯„ä¼°ä¼˜åŒ–

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **å®ç°**ï¼šæ‰¹é‡è¯„ä¼°çš„é€»è¾‘
2. ğŸ”§ **ä¼˜åŒ–**ï¼šæ‰¹é‡æŸ¥è¯¢ç¼“å­˜ï¼ˆå‡å°‘ç¼“å­˜æŸ¥è¯¢æ¬¡æ•°ï¼‰
3. ğŸ”§ **ä¼˜åŒ–**ï¼šæ‰¹é‡è®¡ç®—æ—¶çš„ä¸­é—´ç»“æœå¤ç”¨ï¼ˆè§ C3ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Override
public List<IndicatorEvaluateResult> evaluateBatch(
        EvaluationContext context,
        List<EvaluationRequest> requests) {
    // 1. æ‰¹é‡ç”Ÿæˆç¼“å­˜é”®
    // 2. æ‰¹é‡æŸ¥è¯¢ç¼“å­˜
    // 3. å¯¹äºç¼“å­˜æœªå‘½ä¸­çš„è¯·æ±‚ï¼Œæ‰¹é‡æ‰§è¡Œè®¡ç®—
    //    - æŒ‰ indicator_code åˆ†ç»„
    //    - å¤ç”¨ç›¸åŒçš„ BarSeries
    //    - å¤ç”¨ä¸­é—´ç»“æœï¼ˆè§ C3ï¼‰
    // 4. æ‰¹é‡å†™å…¥ç¼“å­˜
    // 5. è¿”å›ç»“æœåˆ—è¡¨ï¼ˆä¸ requests é¡ºåºä¸€è‡´ï¼‰
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] evaluateBatch ä¸å•æ¬¡ evaluate ç»“æœä¸€è‡´
- [ ] æ‰¹é‡è¯„ä¼°æ€§èƒ½ä¼˜äºå¤šæ¬¡å•æ¬¡è¯„ä¼°
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

### 4.2 ä»»åŠ¡ C3ï¼šä¸­é—´ç»“æœå¤ç”¨ï¼ˆâš ï¸ Phase 2ï¼Œé MVPï¼‰

**ğŸ”´ é‡è¦å®šä½**ï¼š
> **âš ï¸ FeatureCache ä¸å¾—ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„ä¾èµ–ï¼Œåªèƒ½ä½œä¸ºæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚**

**ç›®æ ‡**ï¼šåœ¨ batch evaluate ä¸­ï¼Œå¤šä¸ªæŒ‡æ ‡å…±ç”¨åŒä¸€ä»½ bar window / feature ç»“æœ

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/cache/FeatureCache.java`ï¼ˆæ–°å»ºï¼‰

**å®æ–½åŸåˆ™**ï¼š
- âœ… **MVP é˜¶æ®µ**ï¼šå¿…é¡»ä¸ä¾èµ– FeatureCacheï¼ŒåŠŸèƒ½å®Œå…¨å¯ç”¨
- âœ… **Phase 2 é˜¶æ®µ**ï¼šå‹æµ‹å CPU ä¸è¾¾æ ‡æ—¶ï¼Œä½œä¸ºæ€§èƒ½å¢å¼ºé¡¹å¼•å…¥
- âœ… **é™åˆ¶èŒƒå›´**ï¼šåªå…è®¸ cache çº¯å‡½æ•°ç‰¹å¾ï¼ˆSMAã€EMAã€TRã€æœ€é«˜ä½ç­‰åŸºç¡€åºåˆ—ï¼‰
- âŒ **ä¸¥ç¦**ï¼š
  - å°†ä¸šåŠ¡é€»è¾‘å¡è¿› FeatureCache
  - å°† FeatureCache ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„å‰ææ¡ä»¶
  - åœ¨ MVP é˜¶æ®µå¼ºåˆ¶ä¾èµ– FeatureCache

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼šFeatureCache ç±»ï¼ˆäºŒçº§ç¼“å­˜ï¼‰
2. ğŸ”§ **å®ç°**ï¼šåŸºç¡€åºåˆ—ç¼“å­˜ï¼ˆSMAã€EMAã€æœ€é«˜ä½ã€TR ç­‰çº¯å‡½æ•°ï¼‰
3. ğŸ”§ **é›†æˆ**ï¼šåœ¨æ‰¹é‡è¯„ä¼°æ—¶å¤ç”¨ç¼“å­˜çš„ç»“æœï¼ˆå¯é€‰ï¼Œä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼‰

**ç¼“å­˜é”®è®¾è®¡**ï¼š
- åŸºç¡€åºåˆ—ï¼š`feature:${featureType}:${pairId}:${timeframe}:${params}:${asOfBarTime}`
- ä¾‹å¦‚ï¼š`feature:sma:1:1h:period=20:2024-01-01T12:00:00`

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] **MVP éªŒæ”¶**ï¼šåŠŸèƒ½å®Œå…¨å¯ç”¨ï¼Œä¸ä¾èµ– FeatureCache
- [ ] **Phase 2 éªŒæ”¶**ï¼šåœ¨ batch evaluate ä¸­ï¼Œå¤šä¸ªæŒ‡æ ‡å…±ç”¨åŒä¸€ä»½ bar window / feature ç»“æœ
- [ ] **æ€§èƒ½éªŒæ”¶**ï¼šCPU ä½¿ç”¨æ˜æ˜¾ä¸‹é™ï¼ˆå‹æµ‹éªŒè¯ï¼‰
- [ ] **å•å…ƒæµ‹è¯•è¦†ç›–**ï¼šFeatureCache é€»è¾‘æµ‹è¯•é€šè¿‡
- [ ] **é›†æˆæµ‹è¯•**ï¼šFeatureCache å…³é—­æ—¶ï¼ŒåŠŸèƒ½ä»ç„¶æ­£å¸¸

---

## 5. é˜¶æ®µå››ï¼šç¼“å­˜å±‚å¼€å‘

### 5.1 ä»»åŠ¡ C2ï¼šIndicatorCacheManager å¼€å‘

**ç›®æ ‡**ï¼šå®ç°ç¼“å­˜æœºåˆ¶ï¼Œä¿è¯æ•ˆç‡

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/cache/IndicatorCacheManager.java`ï¼ˆæ–°å»ºï¼‰

#### 5.1.1 ç¼“å­˜é”®è§„èŒƒå®ç°

**ç¼“å­˜é”®æ ¼å¼**ï¼ˆå¿…é¡»å›ºå®šï¼‰ï¼š
```
indicatorCode + version + pairId + timeframe + asOfBarTime + hash(params)
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
public String generateCacheKey(String indicatorCode, String version,
                               Long pairId, String timeframe,
                               LocalDateTime asOfBarTime,
                               Map<String, Object> params) {
    // 1. å¯¹ params è¿›è¡Œæ’åºå’Œåºåˆ—åŒ–
    String paramsJson = objectMapper.writeValueAsString(
        params.entrySet().stream()
            .sorted(Map.Entry.comparingByKey())
            .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))
    );
    
    // 2. è®¡ç®— params çš„ hashï¼ˆSHA-256ï¼‰
    String paramsHash = DigestUtils.sha256Hex(paramsJson);
    
    // 3. æ‹¼æ¥ç¼“å­˜é”®
    return String.format("%s:%s:%d:%s:%s:%s",
        indicatorCode, version, pairId, timeframe,
        asOfBarTime.toString(), paramsHash);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘å›ºå®šä¸”å”¯ä¸€
- [ ] ç›¸åŒå‚æ•°ç”Ÿæˆç›¸åŒç¼“å­˜é”®
- [ ] ä¸åŒå‚æ•°ç”Ÿæˆä¸åŒç¼“å­˜é”®
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–å„ç§å‚æ•°ç»„åˆ

---

#### 5.1.2 ç¼“å­˜å®ç°

**æŠ€æœ¯é€‰å‹**ï¼š
- **æ–¹æ¡ˆ1**ï¼šCaffeineï¼ˆæœ¬åœ°ç¼“å­˜ï¼Œæ¨èï¼‰
- **æ–¹æ¡ˆ2**ï¼šRedisï¼ˆåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¦‚æœéœ€è¦å¤šå®ä¾‹ï¼‰

**é…ç½®æ–‡ä»¶**ï¼š`src/main/resources/application.yml`
```yaml
indicator:
  evaluate:
    cache:
      enabled: true
      ttl: 3600  # TTLï¼ˆç§’ï¼‰
      max-size: 10000  # æœ€å¤§å®¹é‡
      type: local  # local / redis
```

**ä»£ç å®ç°**ï¼ˆä½¿ç”¨ Caffeineï¼‰ï¼š
```java
@Component
@ConditionalOnProperty(name = "indicator.evaluate.cache.enabled", havingValue = "true")
public class IndicatorCacheManager {
    
    private final Cache<String, IndicatorEvaluateResult> cache;
    
    @Autowired
    public IndicatorCacheManager(
            @Value("${indicator.evaluate.cache.ttl:3600}") long ttl,
            @Value("${indicator.evaluate.cache.max-size:10000}") long maxSize) {
        this.cache = Caffeine.newBuilder()
            .expireAfterWrite(Duration.ofSeconds(ttl))
            .maximumSize(maxSize)
            .recordStats()  // è®°å½•ç»Ÿè®¡ä¿¡æ¯
            .build();
    }
    
    public Optional<IndicatorEvaluateResult> get(String cacheKey) {
        return Optional.ofNullable(cache.getIfPresent(cacheKey));
    }
    
    public void put(String cacheKey, IndicatorEvaluateResult result) {
        cache.put(cacheKey, result);
    }
    
    public CacheStats getStats() {
        return cache.stats();
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ç›¸åŒ key å¤šæ¬¡è°ƒç”¨åªç®—ä¸€æ¬¡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- [ ] cache TTL/å®¹é‡å¯é…ç½®
- [ ] ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡å¯ç”¨
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç¼“å­˜é€»è¾‘

---

#### 5.1.3 ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

**é›†æˆåˆ° Metrics**ï¼š
```java
// åœ¨ IndicatorEvaluateService ä¸­
if (cached != null) {
    metrics.recordCacheHit(indicatorCode);
    result.setSource("CACHE");
} else {
    metrics.recordCacheMiss(indicatorCode);
    result.setSource("COMPUTED");
    // æ‰§è¡Œè®¡ç®—...
    cacheManager.put(cacheKey, result);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] Metrics ä¸­èƒ½çœ‹åˆ°ç¼“å­˜å‘½ä¸­ç‡
- [ ] ç¼“å­˜å‘½ä¸­æ—¶è¿”å› `source=CACHE`
- [ ] ç¼“å­˜æœªå‘½ä¸­æ—¶è¿”å› `source=COMPUTED`

---

## 6. é˜¶æ®µäº”ï¼šAPI æ¥å£å¼€å‘

### 6.1 ä»»åŠ¡ï¼šIndicatorEvaluateController å¼€å‘

**ç›®æ ‡**ï¼šæä¾›è¯„ä¼° API æ¥å£

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/api/IndicatorEvaluateController.java`ï¼ˆæ–°å»ºï¼‰

#### 6.1.1 å•æ¬¡è¯„ä¼°æ¥å£

**æ¥å£å®šä¹‰**ï¼š
```java
@RestController
@RequestMapping("/api/indicator/evaluate")
public class IndicatorEvaluateController {
    
    @Autowired
    private IndicatorEvaluateService evaluateService;
    
    /**
     * å•æ¬¡è¯„ä¼°
     * POST /api/indicator/evaluate
     */
    @PostMapping
    public Result<IndicatorEvaluateResultDTO> evaluate(
            @RequestBody @Valid EvaluateRequestDTO request) {
        // 1. æ„å»º EvaluationContext
        // 2. è°ƒç”¨ evaluateService.evaluate()
        // 3. è½¬æ¢ä¸º DTO è¿”å›
    }
}
```

**è¯·æ±‚ DTO**ï¼š
```java
public class EvaluateRequestDTO {
    @NotNull
    private Long userId;
    
    @NotNull
    private Long tradingPairId;
    
    @NotBlank
    private String timeframe;
    
    @NotNull
    private LocalDateTime asOfBarTime;  // bar_close_time UTC
    
    @NotBlank
    private String indicatorCode;
    
    @NotBlank
    private String version;
    
    private Map<String, Object> params;
}
```

**å“åº” DTO**ï¼š
```java
public class IndicatorEvaluateResultDTO {
    private boolean valid;
    private String source;  // CACHE / COMPUTED
    private Map<String, BigDecimal> values;
    private String fingerprint;
    private Integer costMs;
    private String errorMsg;
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ¥å£å¯ç”¨ï¼Œè¿”å›æ­£ç¡®çš„è¯„ä¼°ç»“æœ
- [ ] å‚æ•°æ ¡éªŒå®Œæ•´
- [ ] è¿”å›çš„ `source` å­—æ®µæ­£ç¡®ï¼ˆCACHE/COMPUTEDï¼‰
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

#### 6.1.2 æ‰¹é‡è¯„ä¼°æ¥å£

**æ¥å£å®šä¹‰**ï¼š
```java
/**
 * æ‰¹é‡è¯„ä¼°
 * POST /api/indicator/evaluate/batch
 */
@PostMapping("/batch")
public Result<List<IndicatorEvaluateResultDTO>> evaluateBatch(
        @RequestBody @Valid BatchEvaluateRequestDTO request) {
    // 1. æ„å»º EvaluationContext
    // 2. è°ƒç”¨ evaluateService.evaluateBatch()
    // 3. è½¬æ¢ä¸º DTO åˆ—è¡¨è¿”å›
}
```

**è¯·æ±‚ DTO**ï¼š
```java
public class BatchEvaluateRequestDTO {
    @NotNull
    private Long userId;
    
    @NotNull
    private Long tradingPairId;
    
    @NotBlank
    private String timeframe;
    
    @NotNull
    private LocalDateTime asOfBarTime;
    
    @NotEmpty
    private List<EvaluationRequestItemDTO> requests;  // è¯„ä¼°è¯·æ±‚åˆ—è¡¨
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ¥å£å¯ç”¨ï¼Œè¿”å›ä¸è¯·æ±‚é¡ºåºä¸€è‡´çš„ç»“æœåˆ—è¡¨
- [ ] æ‰¹é‡è¯„ä¼°æ€§èƒ½ä¼˜äºå¤šæ¬¡å•æ¬¡è¯„ä¼°
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

### 6.2 ä»»åŠ¡ E1ï¼šæ”¹é€  GET /api/indicator/latestï¼ˆå…¼å®¹æ€§ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/api/IndicatorController.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **ä¿ç•™**ï¼šæ¥å£è·¯å¾„å’Œå‚æ•°ä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰
2. ğŸ”§ **æ”¹é€ **ï¼šæŸ¥è¯¢é€»è¾‘æ”¹ä¸ºï¼š
   - å¦‚æœæœ‰å¯¹åº”çš„ `indicator_value` è®°å½•ï¼ˆç™½åå•æŒ‡æ ‡ï¼‰ï¼šä»æ•°æ®åº“æŸ¥
   - å¦åˆ™ï¼šè°ƒç”¨ `evaluateService.evaluate()` æŒ‰éœ€è®¡ç®—
3. ğŸ”§ **æ–°å¢**ï¼šå“åº”é‡Œå¢åŠ  `source` å­—æ®µï¼ˆCACHE/ON_DEMAND/DBï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@GetMapping("/latest")
public Result<IndicatorValueDTO> getLatest(
        @RequestParam("userId") Long userId,
        @RequestParam("pairId") Long pairId,
        @RequestParam("timeframe") String timeframe,
        @RequestParam("code") String code,
        @RequestParam(value = "version", required = false, defaultValue = "v1") String version) {
    
    // 1. å…ˆå°è¯•ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆç™½åå•æŒ‡æ ‡ï¼‰
    Optional<IndicatorValue> valueOpt = valueRepository.findLatest(userId, pairId, timeframe, code, version);
    if (valueOpt.isPresent()) {
        IndicatorValueDTO dto = IndicatorValueDTO.fromEntity(valueOpt.get());
        dto.setSource("DB");
        return Result.success(dto);
    }
    
    // 2. æŒ‰éœ€è®¡ç®—
    EvaluationContext context = new EvaluationContext(userId, pairId, timeframe, LocalDateTime.now());
    IndicatorEvaluateResult result = evaluateService.evaluate(code, version, null, context);
    
    if (!result.isValid()) {
        return Result.success(null);  // ä¸å­˜åœ¨æˆ–æ— æ•ˆ
    }
    
    IndicatorValueDTO dto = IndicatorValueDTO.fromResult(result);
    return Result.success(dto);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] è€å‰ç«¯/è€ç­–ç•¥ä¸æ”¹ä¹Ÿèƒ½è·‘ï¼ˆå‘åå…¼å®¹ï¼‰
- [ ] å“åº”é‡Œæ˜ç¡® `source = CACHE/ON_DEMAND/DB`
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›å½’æµ‹è¯•ï¼šæ—§æ¥å£ä¸å´©

---

## 7. é˜¶æ®µå…­ï¼šå‰ç«¯é¡µé¢æ”¹é€ 

### 7.1 ä»»åŠ¡ï¼šæŒ‡æ ‡å®šä¹‰é¡µé¢æ”¹é€ ï¼ˆDefinitionsï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/static/indicator/definitions.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **å‡çº§**ï¼šä»"åªè¯»"å‡çº§ä¸º"å¯ç¼–è¾‘"
2. ğŸ”§ **æ–°å¢**ï¼šæ”¯æŒç¼–è¾‘ `data_source`ã€`impl_key`ã€`param_schema`ã€`return_schema`ã€`enabled`
3. ğŸ”§ **æ–°å¢**ï¼š`param_schema` ä»¥"schema ç¼–è¾‘å™¨ + è¡¨å•é¢„è§ˆ"å‘ˆç°
4. ğŸ”§ **é›†æˆ**ï¼šè°ƒç”¨å‚æ•°æ ¡éªŒæ¥å£è¿›è¡Œå®æ—¶æ ¡éªŒ

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ”¯æŒåˆ›å»ºæ–°æŒ‡æ ‡å®šä¹‰
- æ”¯æŒç¼–è¾‘ç°æœ‰æŒ‡æ ‡å®šä¹‰
- Schema ç¼–è¾‘å™¨ï¼ˆå¯ä»¥ä½¿ç”¨ JSON ç¼–è¾‘å™¨ç»„ä»¶ï¼‰
- è¡¨å•é¢„è§ˆï¼ˆåŸºäº param_schema åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] èƒ½åˆ›å»º/ç¼–è¾‘ä¸€ä¸ªæ–°æŒ‡æ ‡å®šä¹‰ï¼ˆè‡ªå®šä¹‰ param_schema/return_schemaï¼‰
- [ ] Schema ç¼–è¾‘å™¨å¯ç”¨
- [ ] è¡¨å•é¢„è§ˆåŠŸèƒ½æ­£å¸¸
- [ ] å‚æ•°æ ¡éªŒå®æ—¶æç¤º

---

### 7.2 ä»»åŠ¡ï¼šæŒ‰éœ€è¯„ä¼°é¡µé¢ï¼ˆEvaluate Playgroundï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/static/indicator/evaluate.html`ï¼ˆæ–°å»ºï¼‰æˆ–å¹¶å…¥ `values.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼šæ–°çš„è¯„ä¼°é¡µé¢
2. ğŸ”§ **å®ç°**ï¼šé€‰æ‹© pair/tf/barTime + indicatorCode/version
3. ğŸ”§ **å®ç°**ï¼šè‡ªåŠ¨æ¸²æŸ“ params è¡¨å•ï¼ˆåŸºäº param_schemaï¼‰
4. ğŸ”§ **å®ç°**ï¼šç‚¹å‡» Evaluateï¼ˆæˆ– Batch Evaluateï¼‰
5. ğŸ”§ **å®ç°**ï¼šå±•ç¤ºç»“æœ + `sourceï¼ˆCACHE/COMPUTEDï¼‰`

**åŠŸèƒ½è¦æ±‚**ï¼š
- äº¤æ˜“å¯¹é€‰æ‹©å™¨
- å‘¨æœŸé€‰æ‹©å™¨
- æ—¶é—´é€‰æ‹©å™¨ï¼ˆasOfBarTimeï¼‰
- æŒ‡æ ‡é€‰æ‹©å™¨ï¼ˆåŸºäº definitions æ¥å£ï¼‰
- å‚æ•°è¡¨å•åŠ¨æ€æ¸²æŸ“
- å•æ¬¡è¯„ä¼°æŒ‰é’®
- æ‰¹é‡è¯„ä¼°åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- ç»“æœå±•ç¤ºï¼ˆåŒ…æ‹¬ source å­—æ®µï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é¡µé¢å¯ç”¨ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- [ ] å‚æ•°è¡¨å•èƒ½æ­£ç¡®æ¸²æŸ“
- [ ] è¯„ä¼°ç»“æœæ­£ç¡®æ˜¾ç¤º
- [ ] source å­—æ®µæ­£ç¡®æ˜¾ç¤ºï¼ˆCACHE/COMPUTEDï¼‰

---

### 7.3 ä»»åŠ¡ï¼šæŒ‡æ ‡ç»“æœé¡µé¢é€‚é…ï¼ˆValuesï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/static/indicator/values.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **é€‚é…**ï¼šAPI è¿”å›çš„ `source` å­—æ®µï¼ˆCACHE/ON_DEMAND/DBï¼‰
2. ğŸ”§ **é€‚é…**ï¼šç™½åå•æŒ‡æ ‡å’Œè‡ªå®šä¹‰å‚æ•°æŒ‡æ ‡çš„å±•ç¤ºåŒºåˆ†
3. ğŸ”§ **å¯é€‰**ï¼šæ·»åŠ "æŒ‰éœ€è®¡ç®—"æŒ‰é’®ï¼ˆè°ƒç”¨ evaluate æ¥å£ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é¡µé¢æ­£å¸¸æ˜¾ç¤ºï¼Œsource å­—æ®µæ­£ç¡®å±•ç¤º
- [ ] ä¸åŒç±»å‹æŒ‡æ ‡çš„å±•ç¤ºåŒºåˆ†æ˜æ˜¾

---

### 7.4 ä»»åŠ¡ï¼šè®¢é˜…é¡µ/æ—¥å¿—é¡µé™çº§ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š
- `src/main/resources/static/indicator/subscriptions.html`
- `src/main/resources/static/indicator/logs.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **è°ƒæ•´**ï¼šä»æ ¸å¿ƒç”¨æˆ·è·¯å¾„é™çº§ä¸º"è¾“å…¥äº‹å®ç›‘æ§/è°ƒè¯•è¾…åŠ©"
2. ğŸ”§ **è¯´æ˜**ï¼šåœ¨é¡µé¢ä¸Šæ˜ç¡®è¯´æ˜è¿™äº›é¡µé¢çš„å®šä½

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é¡µé¢ä»å¯ç”¨ï¼ˆå‘åå…¼å®¹ï¼‰
- [ ] é¡µé¢è¯´æ˜æ¸…æ¥šï¼ˆè°ƒè¯•è¾…åŠ©ï¼‰

---

## 8. é˜¶æ®µä¸ƒï¼šé…ç½®ä¸ç›‘æ§

### 8.1 ä»»åŠ¡ï¼šåº”ç”¨é…ç½®

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/application.yml`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼šç¼“å­˜é…ç½®
2. ğŸ”§ **æ–°å¢**ï¼šFeature Flag é…ç½®

**é…ç½®å†…å®¹**ï¼š
```yaml
indicator:
  evaluate:
    cache:
      enabled: true
      ttl: 3600  # ç¼“å­˜TTLï¼ˆç§’ï¼‰
      max-size: 10000  # ç¼“å­˜æœ€å¤§å®¹é‡
      type: local  # local / redis
    auto-calculate:
      enabled: false  # Feature Flagï¼šæ˜¯å¦å¯ç”¨æ—§çš„è‡ªåŠ¨è®¡ç®—æ¨¡å¼
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é…ç½®é¡¹å®Œæ•´ä¸”æ­£ç¡®
- [ ] é…ç½®ç”Ÿæ•ˆï¼ˆé€šè¿‡æµ‹è¯•éªŒè¯ï¼‰

---

### 8.2 ä»»åŠ¡ F1ï¼šMetrics æŒ‡æ ‡

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/observability/IndicatorMetrics.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼ševaluate è€—æ—¶ Metrics
2. ğŸ”§ **æ–°å¢**ï¼šç¼“å­˜å‘½ä¸­ç‡ Metrics
3. ğŸ”§ **æ–°å¢**ï¼šbatch size åˆ†å¸ƒ Metrics

**æ–°å¢ Metrics**ï¼š
```java
// evaluate è€—æ—¶ï¼ˆTimerï¼ŒP50/P95/P99ï¼‰
private final Timer evaluateCostTimer;

// ç¼“å­˜å‘½ä¸­ç‡
private final Counter cacheHits;
private final Counter cacheMisses;

// batch size åˆ†å¸ƒ
private final Histogram batchSizeHistogram;
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æŒ‡æ ‡æ‰§è¡Œè€—æ—¶ P95/P99 å¯è§‚æµ‹
- [ ] cache hit ratioï¼ˆæŒ‰ indicatorCode èšåˆï¼‰å¯è§‚æµ‹
- [ ] batch size åˆ†å¸ƒå¯è§‚æµ‹
- [ ] Prometheus ç«¯ç‚¹å¯è®¿é—®

---

### 8.3 ä»»åŠ¡ F2ï¼šå‹æµ‹ä¸åŸºå‡†

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ“ **å‡†å¤‡**ï¼šå‹æµ‹è„šæœ¬
2. ğŸ”§ **æ‰§è¡Œ**ï¼šå•æŒ‡æ ‡ QPS åŸºå‡†æµ‹è¯•ï¼ˆå‘½ä¸­/ä¸å‘½ä¸­ï¼‰
3. ğŸ”§ **æ‰§è¡Œ**ï¼šbatch è¯„ä¼°ååæå‡æ¯”ä¾‹æµ‹è¯•
4. ğŸ”§ **æ‰§è¡Œ**ï¼šBarSeries append çš„å»¶è¿Ÿä¸å†…å­˜å ç”¨æµ‹è¯•

**å‹æµ‹åœºæ™¯**ï¼š
- å•æ¬¡è¯„ä¼°ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ï¼šç›®æ ‡ QPS > 1000
- å•æ¬¡è¯„ä¼°ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼šç›®æ ‡ QPS > 100
- æ‰¹é‡è¯„ä¼°ï¼ˆ10ä¸ªæŒ‡æ ‡ï¼‰ï¼šç›®æ ‡ååæå‡ > 2å€
- BarSeries append å»¶è¿Ÿï¼šç›®æ ‡ < 1ms

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å•æŒ‡æ ‡ QPS åŸºå‡†ï¼ˆå‘½ä¸­/ä¸å‘½ä¸­ï¼‰è¾¾åˆ°é¢„æœŸ
- [ ] batch è¯„ä¼°ååæå‡æ¯”ä¾‹ > 2å€
- [ ] BarSeries append çš„å»¶è¿Ÿ < 1msï¼Œå†…å­˜å ç”¨å¯æ§

---

## 9. é˜¶æ®µå…«ï¼šæµ‹è¯•ä¸éªŒæ”¶

### 9.1 ä»»åŠ¡ G1ï¼šå•å…ƒæµ‹è¯•

#### 9.1.1 Schema æ ¡éªŒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/test/java/com/qyl/v2trade/indicator/validation/IndicatorParamValidatorTest.java`

**æµ‹è¯•åœºæ™¯**ï¼š
- å‚æ•°è¶Šç•Œï¼ˆè¶…å‡º min/maxï¼‰
- å¿…å¡«å‚æ•°ç¼ºå¤±
- å‚æ•°ç±»å‹é”™è¯¯
- æšä¸¾å€¼æ ¡éªŒ
- lookback ä¸Šé™æ ¡éªŒ
- çª—å£ä¸Šé™æ ¡éªŒ

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ‰€æœ‰æ ¡éªŒåœºæ™¯éƒ½æœ‰æµ‹è¯•è¦†ç›–
- [ ] æµ‹è¯•é€šè¿‡ç‡è¾¾åˆ° 100%

---

#### 9.1.2 min_required_bars æ ¡éªŒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/test/java/com/qyl/v2trade/indicator/runtime/IndicatorEvaluateServiceTest.java`

**æµ‹è¯•åœºæ™¯**ï¼š
- BarSeries æ•°é‡ < min_required_bars æ—¶ï¼Œvalid=false
- BarSeries æ•°é‡ >= min_required_bars æ—¶ï¼Œvalid=true
- è¾¹ç•Œå€¼æµ‹è¯•

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] min_required_bars ä¸è¶³æ—¶ valid=false
- [ ] min_required_bars å……è¶³æ—¶ valid=true
- [ ] è¾¹ç•Œå€¼æµ‹è¯•é€šè¿‡

---

#### 9.1.3 ç¼“å­˜é”®ä¸€è‡´æ€§æµ‹è¯•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/test/java/com/qyl/v2trade/indicator/cache/IndicatorCacheManagerTest.java`

**æµ‹è¯•åœºæ™¯**ï¼š
- ç›¸åŒå‚æ•°ç”Ÿæˆç›¸åŒç¼“å­˜é”®
- ä¸åŒå‚æ•°ç”Ÿæˆä¸åŒç¼“å­˜é”®
- å‚æ•°é¡ºåºä¸å½±å“ç¼“å­˜é”®ï¼ˆMap æ’åºï¼‰
- params ä¸ºç©ºçš„æƒ…å†µ

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ç¼“å­˜ key ä¸€è‡´æ€§ï¼ˆåŒå‚åŒä¸Šä¸‹æ–‡å‘½ä¸­ï¼‰
- [ ] å„ç§å‚æ•°ç»„åˆæµ‹è¯•é€šè¿‡

---

### 9.2 ä»»åŠ¡ G2ï¼šé›†æˆæµ‹è¯•

#### 9.2.1 BarSeries ä¸ Evaluate é›†æˆæµ‹è¯•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/test/java/com/qyl/v2trade/indicator/integration/BarSeriesEvaluateIntegrationTest.java`

**æµ‹è¯•åœºæ™¯**ï¼š
- BarClosedEvent æ¨è¿› bar window åï¼Œevaluate(asOf=æœ€æ–° bar) å¾—åˆ°å¯é¢„æœŸç»“æœ
- å¤šä¸ª Bar è¿½åŠ åï¼Œevaluate ç»“æœæ­£ç¡®
- ä¸åŒå‘¨æœŸï¼ˆ5m/15m/30m/1h/4hï¼‰çš„é›†æˆæµ‹è¯•

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] BarClosedEvent æ¨è¿› bar window åï¼Œevaluate(asOf=æœ€æ–° bar) å¾—åˆ°å¯é¢„æœŸç»“æœ
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

---

#### 9.2.2 Batch Evaluate ä¸€è‡´æ€§æµ‹è¯•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/test/java/com/qyl/v2trade/indicator/integration/BatchEvaluateIntegrationTest.java`

**æµ‹è¯•åœºæ™¯**ï¼š
- evaluateBatch ä¸å•æ¬¡ evaluate ç»“æœä¸€è‡´
- æ‰¹é‡è¯„ä¼°çš„é¡ºåºä¸€è‡´æ€§
- æ‰¹é‡è¯„ä¼°çš„æ€§èƒ½ä¼˜åŠ¿

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] evaluateBatch ä¸å•æ¬¡ evaluate ç»“æœä¸€è‡´
- [ ] æ‰¹é‡è¯„ä¼°é¡ºåºæ­£ç¡®
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

### 9.3 ä»»åŠ¡ G3ï¼šå›å½’æµ‹è¯•

#### 9.3.1 æ—§æ¥å£å…¼å®¹æ€§æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
- `GET /api/indicator/latest` æ¥å£ä¸å´©
- æ—§å‰ç«¯é¡µé¢ä¸å´©
- æ—§ç­–ç•¥æ¨¡å—è°ƒç”¨æ­£å¸¸

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ—§æ¥å£ latest ä¸å´©ï¼ˆå…¼å®¹å±‚ï¼‰
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] ç­–ç•¥æ¨¡å—è°ƒç”¨æ­£å¸¸

---

### 9.4 ä»»åŠ¡ï¼šéªŒæ”¶æ ‡å‡†éªŒè¯ï¼ˆæ¥è‡ªäº§å“è§„èŒƒï¼‰

#### 9.4.1 Kçº¿è®¢é˜…éªŒè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] BarClosedEvent é¢‘ç‡ä¸çª—å£æ›´æ–°æ­£ç¡®ï¼ˆæ— é¢å¤–è®¡ç®—è´Ÿè½½ï¼‰
- [ ] 5m/15m/30m/1h/4h å‘¨æœŸç»´æŠ¤æ­£å¸¸
- [ ] 365 æ ¹çª—å£ç»´æŠ¤æ­£å¸¸

---

#### 9.4.2 å®šä¹‰è¡¨å¯é…ç½®éªŒè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½åˆ›å»º/ç¼–è¾‘ä¸€ä¸ªæ–°æŒ‡æ ‡å®šä¹‰ï¼ˆè‡ªå®šä¹‰ param_schema/return_schemaï¼‰
- [ ] å‰ç«¯èƒ½ä»…é  definition æ‹‰èµ·è¡¨å•
- [ ] åç«¯èƒ½æŒ‰ schema æ ¡éªŒ params

---

#### 9.4.3 æ’ä»¶æ˜ å°„éªŒè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] åŒä¸€ indicator_code+version èƒ½æ­£ç¡®è·¯ç”±åˆ° impl_key å¯¹åº”ç¡¬ä»£ç 
- [ ] æ²¡æœ‰ impl_key æ—¶èƒ½å›é€€åˆ° engine å­—æ®µ
- [ ] è·¯ç”±é€»è¾‘æµ‹è¯•é€šè¿‡

---

#### 9.4.4 ç¼“å­˜å‘½ä¸­éªŒè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] åŒä¸€ `(code,version,pair,tf,barTime,params)` è¿ç»­è¯„ä¼°ï¼Œç¬¬äºŒæ¬¡è¿”å› `source=CACHE`
- [ ] ç¼“å­˜å‘½ä¸­æ—¶è€—æ—¶æ˜¾è‘—ä¸‹é™ï¼ˆ< 1msï¼‰
- [ ] cacheKey è§„èŒƒæŒ‰å½±å“æ¸…å•æ­£ç¡®å®ç°

---

#### 9.4.5 ç­–ç•¥ä¾§å½’æ¡£éªŒè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ç­–ç•¥è¿è¡Œåï¼Œ`strategy_rules_record` èƒ½çœ‹åˆ°æŒ‡æ ‡è¾“å‡ºä¸ fingerprint
- [ ] å¯ç”¨äºè§£é‡Šå½“æ—¶å†³ç­–
- [ ] fingerprint åŒ…å«å®Œæ•´çš„è®¡ç®—é…ç½®ä¿¡æ¯

**æ³¨æ„**ï¼šæ­¤éªŒæ”¶æ ‡å‡†éœ€è¦ä¸ç­–ç•¥æ¨¡å—é…åˆéªŒè¯ï¼Œä¸å±äºæŒ‡æ ‡æ¨¡å—å•ç‹¬éªŒæ”¶èŒƒå›´ã€‚

---

## 10. é˜¶æ®µä¹ï¼šæ—§ä»£ç æ¸…ç†

### 10.1 ä»»åŠ¡ï¼šåºŸå¼ƒä»£ç æ ‡è®°

**ç›®æ ‡**ï¼šæ ‡è®°ä¸å†ä½¿ç”¨çš„ä»£ç ï¼Œä¸ºåç»­åˆ é™¤åšå‡†å¤‡

#### 10.1.1 åºŸå¼ƒ IndicatorCalculator çš„è‡ªåŠ¨è®¡ç®—é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/calculator/IndicatorCalculator.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ ‡è®°**ï¼šåœ¨ç±»å’Œæ–¹æ³•ä¸Šæ·»åŠ  `@Deprecated` æ³¨è§£
2. ğŸ“ **æ³¨é‡Š**ï¼šè¯´æ˜åºŸå¼ƒåŸå› å’Œæ›¿ä»£æ–¹æ¡ˆ
3. âœ… **ä¿ç•™**ï¼šä»£ç æš‚æ—¶ä¿ç•™ï¼ˆFeature Flag æ§åˆ¶ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
/**
 * @deprecated V2: è‡ªåŠ¨è®¡ç®—å·²åºŸå¼ƒï¼Œä½¿ç”¨ IndicatorEvaluateService è¿›è¡ŒæŒ‰éœ€è¯„ä¼°
 * æ­¤ç±»çš„è‡ªåŠ¨è®¡ç®—åŠŸèƒ½é€šè¿‡ Feature Flag æ§åˆ¶ï¼Œé»˜è®¤å…³é—­
 * 
 * @see IndicatorEvaluateService
 */
@Deprecated
@Component
public class IndicatorCalculator {
    // ...
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åºŸå¼ƒä»£ç å·²æ ‡è®°
- [ ] æœ‰æ˜ç¡®çš„æ›¿ä»£æ–¹æ¡ˆè¯´æ˜

---

#### 10.1.2 åºŸå¼ƒ IndicatorValueRepository çš„å†™å…¥é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorValueRepository.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ ‡è®°**ï¼š`insertIgnore()` æ–¹æ³•æ·»åŠ  `@Deprecated`
2. ğŸ“ **æ³¨é‡Š**ï¼šè¯´æ˜ V2 ä¸å†è½åº“ï¼Œç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“

**ä»£ç ç¤ºä¾‹**ï¼š
```java
/**
 * @deprecated V2: æŒ‡æ ‡å€¼ä¸å†è½åº“åˆ° indicator_value è¡¨
 * æŒ‡æ ‡ç»“æœå½’æ¡£åˆ°ç­–ç•¥å¤§è„‘çš„ strategy_rules_record
 * 
 * @see IndicatorEvaluateService
 */
@Deprecated
WriteResult insertIgnore(IndicatorValue value);
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åºŸå¼ƒæ–¹æ³•å·²æ ‡è®°
- [ ] æœ‰æ˜ç¡®çš„æ›¿ä»£æ–¹æ¡ˆè¯´æ˜

---

#### 10.1.3 åºŸå¼ƒ IndicatorSubscriptionRepository çš„é©±åŠ¨è®¡ç®—é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorSubscriptionRepository.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ“ **æ³¨é‡Š**ï¼šè¯´æ˜ subscription ä¸å†ä½œä¸ºè®¡ç®—é©±åŠ¨æº
2. âœ… **ä¿ç•™**ï¼šCRUD æ–¹æ³•ä¿ç•™ï¼ˆç”¨äºè°ƒè¯•/ç›‘æ§ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ä»£ç æ³¨é‡Šæ˜ç¡®è¯´æ˜å®šä½å˜åŒ–

---

### 10.2 ä»»åŠ¡ï¼šæ— ç”¨æ–‡ä»¶æ¸…ç†ï¼ˆå¯é€‰ï¼Œè°¨æ…æ‰§è¡Œï¼‰

**æ³¨æ„**ï¼šä»¥ä¸‹æ–‡ä»¶å»ºè®®åœ¨ V2 ç¨³å®šè¿è¡Œä¸€æ®µæ—¶é—´åå†åˆ é™¤

#### 10.2.1 å¯åˆ é™¤çš„æ–‡ä»¶æ¸…å•

1. **æµ‹è¯•æ–‡ä»¶**ï¼ˆå¦‚æœä¸å†éœ€è¦ï¼‰ï¼š
   - `IndicatorCalculatorTest.java`ï¼ˆå¦‚æœå®Œå…¨åºŸå¼ƒï¼‰
   - ä¸è‡ªåŠ¨è®¡ç®—ç›¸å…³çš„é›†æˆæµ‹è¯•

2. **å‰ç«¯é¡µé¢**ï¼ˆå¦‚æœä¸å†ä½¿ç”¨ï¼‰ï¼š
   - `subscriptions.html`ï¼ˆé™çº§ä¸ºè°ƒè¯•è¾…åŠ©ï¼Œä¿ç•™ä½†æ˜ç¡®è¯´æ˜ï¼‰
   - `logs.html`ï¼ˆé™çº§ä¸ºè°ƒè¯•è¾…åŠ©ï¼Œä¿ç•™ä½†æ˜ç¡®è¯´æ˜ï¼‰

3. **æ–‡æ¡£æ–‡ä»¶**ï¼ˆæ ‡è®°ä¸ºå†å²ç‰ˆæœ¬ï¼‰ï¼š
   - V1.2 ç›¸å…³çš„è¿‡æ—¶æ–‡æ¡£å¯ä»¥æ ‡è®°ä¸ºå†å²ç‰ˆæœ¬

**åˆ é™¤å‰æ£€æŸ¥**ï¼š
- [ ] ç¡®è®¤ä¸å†æœ‰ä»£ç å¼•ç”¨
- [ ] ç¡®è®¤ä¸å†æœ‰å‰ç«¯é¡µé¢ä½¿ç”¨
- [ ] å¤‡ä»½é‡è¦ä»£ç ï¼ˆGit å†å²ä¿ç•™ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åˆ é™¤å‰å·²ç¡®è®¤æ— å¼•ç”¨
- [ ] é‡è¦ä»£ç å·²å¤‡ä»½
- [ ] åˆ é™¤åç³»ç»Ÿæ­£å¸¸è¿è¡Œ

---

## 11. å®æ–½é¡ºåºä¸é‡Œç¨‹ç¢‘

### 11.1 æ¨èå®æ–½é¡ºåºï¼ˆæœ€å°é—­ç¯ä¼˜å…ˆï¼‰

#### é‡Œç¨‹ç¢‘ 1ï¼šè¾“å…¥å±‚æ”¹é€ å®Œæˆï¼ˆ1-2å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… B1ï¼šæ–­å¼€ IndicatorCalculator çš„è‡ªåŠ¨è®¡ç®—é“¾è·¯
2. âœ… B2ï¼šç»Ÿä¸€ bar_time è¯­ä¹‰éªŒè¯

**éªŒæ”¶**ï¼š
- BarSeriesManager æ­£å¸¸å·¥ä½œ
- è‡ªåŠ¨è®¡ç®—å·²å…³é—­
- å•å…ƒæµ‹è¯•é€šè¿‡

---

#### é‡Œç¨‹ç¢‘ 2ï¼šè¯„ä¼°å±‚åŸºç¡€åŠŸèƒ½å®Œæˆï¼ˆ3-5å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… C1ï¼šæ–°å¢ IndicatorEvaluateServiceï¼ˆåŸºç¡€åŠŸèƒ½ï¼Œåªåšåè°ƒï¼‰
2. âœ… C2ï¼šIndicatorCacheManager å¼€å‘ï¼ˆåŸºç¡€åŠŸèƒ½ï¼‰
3. âœ… IndicatorParamValidator å¼€å‘ï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰
4. âœ… IndicatorEngineRouter æ‰©å±•ï¼ˆæ”¯æŒ impl_keyï¼‰

**éªŒæ”¶**ï¼š
- evaluate æ¥å£å¯ç”¨
- ç¼“å­˜æœºåˆ¶å·¥ä½œæ­£å¸¸
- **èŒè´£è¾¹ç•ŒéªŒè¯**ï¼šService åªåšåè°ƒï¼Œå…·ä½“é€»è¾‘åœ¨å­ç»„ä»¶
- **è¾“å‡ºè¾¹ç•ŒéªŒè¯**ï¼šResult ä¸åŒ…å«ç­–ç•¥è¯­ä¹‰
- å•å…ƒæµ‹è¯•é€šè¿‡

---

#### é‡Œç¨‹ç¢‘ 3ï¼šAPI æ¥å£å®Œæˆï¼ˆ2-3å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… IndicatorEvaluateController å¼€å‘
2. âœ… E1ï¼šæ”¹é€  GET /api/indicator/latest

**éªŒæ”¶**ï¼š
- æ–°æ¥å£å¯ç”¨
- æ—§æ¥å£å‘åå…¼å®¹
- é›†æˆæµ‹è¯•é€šè¿‡

---

#### é‡Œç¨‹ç¢‘ 4ï¼šå®šä¹‰å±‚å®Œå–„ï¼ˆ2-3å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… A2ï¼šæ‰©å±• indicator_definition è¡¨å­—æ®µ
2. âœ… IndicatorDefinitionController æ‰©å±•

**éªŒæ”¶**ï¼š
- è¡¨ç»“æ„æ”¯æŒæ–°å­—æ®µ
- å‚æ•°æ ¡éªŒåŠŸèƒ½æ­£å¸¸
- å•å…ƒæµ‹è¯•é€šè¿‡

---

#### é‡Œç¨‹ç¢‘ 5ï¼šå‰ç«¯é¡µé¢æ”¹é€ ï¼ˆ3-5å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… æŒ‡æ ‡å®šä¹‰é¡µé¢æ”¹é€ 
2. âœ… æŒ‰éœ€è¯„ä¼°é¡µé¢å¼€å‘
3. âœ… æŒ‡æ ‡ç»“æœé¡µé¢é€‚é…

**éªŒæ”¶**ï¼š
- æ‰€æœ‰é¡µé¢åŠŸèƒ½æ­£å¸¸
- ç”¨æˆ·ä½“éªŒè‰¯å¥½
- åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

#### é‡Œç¨‹ç¢‘ 6ï¼šæ€§èƒ½ä¼˜åŒ–ä¸æµ‹è¯•ï¼ˆ3-5å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… F1-F2ï¼šMetrics å’Œå‹æµ‹ï¼ˆå¿…é¡»ï¼‰
2. âœ… C3ï¼šä¸­é—´ç»“æœå¤ç”¨ï¼ˆå¯é€‰ï¼Œä»…å½“å‹æµ‹ä¸è¾¾æ ‡æ—¶å¼•å…¥ï¼‰
3. âœ… G1-G3ï¼šå®Œæ•´æµ‹è¯•è¦†ç›–

**éªŒæ”¶**ï¼š
- æ€§èƒ½è¾¾åˆ°é¢„æœŸï¼ˆä¸ä¾èµ– FeatureCacheï¼‰
- æµ‹è¯•è¦†ç›–å……åˆ†
- å‹æµ‹é€šè¿‡
- **FeatureCache å…³é—­æ—¶åŠŸèƒ½ä»ç„¶æ­£å¸¸**ï¼ˆå…³é”®éªŒæ”¶ç‚¹ï¼‰

---

#### é‡Œç¨‹ç¢‘ 7ï¼šæ¸…ç†ä¸æ–‡æ¡£ï¼ˆ1-2å¤©ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… åºŸå¼ƒä»£ç æ ‡è®°
2. âœ… æ–‡æ¡£æ›´æ–°
3. âœ… ä»£ç å®¡æŸ¥

**éªŒæ”¶**ï¼š
- ä»£ç æ•´æ´
- æ–‡æ¡£å®Œæ•´
- é€šè¿‡ä»£ç å®¡æŸ¥

---

### 11.2 æ€»æ—¶é—´ä¼°ç®—

- **æœ€å°é—­ç¯**ï¼ˆé‡Œç¨‹ç¢‘ 1-3ï¼‰ï¼š6-10å¤©
- **å®Œæ•´åŠŸèƒ½**ï¼ˆé‡Œç¨‹ç¢‘ 1-6ï¼‰ï¼š14-23å¤©
- **æœ€ç»ˆäº¤ä»˜**ï¼ˆé‡Œç¨‹ç¢‘ 1-7ï¼‰ï¼š15-25å¤©

---

## 12. å…³é”®å†³ç­–ä¸æ³¨æ„äº‹é¡¹

### 12.1 å…³é”®å†³ç­–ç‚¹

#### ğŸ”´ å†³ç­– 0ï¼šäº§å“çº§èŒè´£è¾¹ç•Œï¼ˆå¿…é¡»å†»ç»“ï¼‰

**å†³ç­–å†…å®¹**ï¼š
1. **IndicatorEvaluateService èŒè´£è¾¹ç•Œ**ï¼šçº¯è¿è¡Œæ—¶è¯„ä¼°æœåŠ¡ï¼Œåªåšåè°ƒï¼Œå…·ä½“é€»è¾‘æ‹†åˆ†åˆ°å­ç»„ä»¶
2. **FeatureCache å®šä½**ï¼šPhase 2 æ€§èƒ½ä¼˜åŒ–é¡¹ï¼ŒMVP å¿…é¡»ä¸ä¾èµ–
3. **Evaluate è¾“å‡ºè¾¹ç•Œ**ï¼šåªè¿”å›è®¡ç®—ç»“æœï¼Œç¦æ­¢ç­–ç•¥è¯­ä¹‰

**å†³ç­–ä¾æ®**ï¼š
- é¿å… God Service
- é¿å…åŠŸèƒ½æ­£ç¡®æ€§ä¾èµ–æ€§èƒ½ä¼˜åŒ–é¡¹
- é¿å…æŒ‡æ ‡æ¨¡å—ä¸ç­–ç•¥æ¨¡å—èŒè´£æ··ä¹±

**å®æ–½è¦æ±‚**ï¼š
- ä»£ç å®¡æŸ¥æ—¶å¿…é¡»éªŒè¯èŒè´£è¾¹ç•Œ
- éªŒæ”¶æ—¶å¿…é¡»éªŒè¯è¾“å‡ºè¾¹ç•Œ
- FeatureCache å…³é—­æ—¶åŠŸèƒ½å¿…é¡»æ­£å¸¸

---

#### å†³ç­– 1ï¼šæ•°æ®åº“è¡¨æ‰©å±•æ–¹æ¡ˆ

**é€‰é¡¹**ï¼š
- æ–¹æ¡ˆ Aï¼šä½¿ç”¨ JSON å­—æ®µæ‰©å±•ï¼ˆæ¨èï¼‰
  - ä¼˜ç‚¹ï¼šæ— éœ€ ALTER TABLEï¼Œå‘åå…¼å®¹å¥½
  - ç¼ºç‚¹ï¼šæŸ¥è¯¢å’Œç´¢å¼•å—é™
- æ–¹æ¡ˆ Bï¼šALTER TABLE æ–°å¢å­—æ®µ
  - ä¼˜ç‚¹ï¼šæŸ¥è¯¢å’Œç´¢å¼•æ–¹ä¾¿
  - ç¼ºç‚¹ï¼šéœ€è¦æ•°æ®åº“è¿ç§»ï¼Œå¯èƒ½å½±å“ç°æœ‰æ•°æ®

**å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨æ–¹æ¡ˆ Aï¼Œå¦‚æœåç»­æŸ¥è¯¢éœ€æ±‚å¼ºçƒˆå†è€ƒè™‘æ–¹æ¡ˆ B

---

#### å†³ç­– 2ï¼šç¼“å­˜æŠ€æœ¯é€‰å‹

**é€‰é¡¹**ï¼š
- æ–¹æ¡ˆ Aï¼šCaffeineï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
  - ä¼˜ç‚¹ï¼šæ€§èƒ½é«˜ï¼Œæ— ç½‘ç»œå¼€é”€ï¼Œç®€å•
  - ç¼ºç‚¹ï¼šå¤šå®ä¾‹ä¸å…±äº«ç¼“å­˜
- æ–¹æ¡ˆ Bï¼šRedisï¼ˆåˆ†å¸ƒå¼ç¼“å­˜ï¼‰
  - ä¼˜ç‚¹ï¼šå¤šå®ä¾‹å…±äº«ï¼Œå¯æŒä¹…åŒ–
  - ç¼ºç‚¹ï¼šç½‘ç»œå¼€é”€ï¼Œéœ€è¦ Redis æœåŠ¡

**å»ºè®®**ï¼šå•å®ä¾‹ä½¿ç”¨ Caffeineï¼Œå¤šå®ä¾‹éƒ¨ç½²æ—¶ä½¿ç”¨ Redis

---

#### å†³ç­– 3ï¼šFeature Flag ç­–ç•¥

**é€‰é¡¹**ï¼š
- æ–¹æ¡ˆ Aï¼šé…ç½®é¡¹å¼€å…³ï¼ˆæ¨èï¼‰
  - ä¼˜ç‚¹ï¼šç®€å•ï¼Œé‡å¯ç”Ÿæ•ˆ
  - ç¼ºç‚¹ï¼šéœ€è¦é‡å¯åº”ç”¨
- æ–¹æ¡ˆ Bï¼šåŠ¨æ€é…ç½®ä¸­å¿ƒ
  - ä¼˜ç‚¹ï¼šæ— éœ€é‡å¯ï¼Œå®æ—¶ç”Ÿæ•ˆ
  - ç¼ºç‚¹ï¼šå¤æ‚åº¦é«˜

**å»ºè®®**ï¼šåˆæœŸä½¿ç”¨é…ç½®é¡¹å¼€å…³ï¼Œåç»­å¦‚éœ€å®æ—¶åˆ‡æ¢å†å‡çº§

---

### 12.2 æ³¨æ„äº‹é¡¹

#### æ³¨æ„äº‹é¡¹ 1ï¼šå‘åå…¼å®¹

- âœ… **å¿…é¡»**ï¼šæ—§æ¥å£ `/api/indicator/latest` å¿…é¡»ä¿æŒå…¼å®¹
- âœ… **å¿…é¡»**ï¼šå‰ç«¯é¡µé¢ä¸èƒ½å› ä¸º API å˜æ›´è€Œå´©æºƒ
- âœ… **å¿…é¡»**ï¼šç­–ç•¥æ¨¡å—è°ƒç”¨æŒ‡æ ‡æ¥å£å¿…é¡»æ­£å¸¸å·¥ä½œ

---

#### æ³¨æ„äº‹é¡¹ 2ï¼šæ€§èƒ½è¦æ±‚

- âœ… **å¿…é¡»**ï¼šç¼“å­˜å‘½ä¸­æ—¶å“åº”æ—¶é—´ < 1ms
- âœ… **å¿…é¡»**ï¼šç¼“å­˜æœªå‘½ä¸­æ—¶å“åº”æ—¶é—´ < 100msï¼ˆå•æŒ‡æ ‡ï¼‰
- âœ… **å»ºè®®**ï¼šæ‰¹é‡è¯„ä¼°ååæå‡ > 2å€

---

#### æ³¨æ„äº‹é¡¹ 3ï¼šæ•°æ®ä¸€è‡´æ€§

- âœ… **å¿…é¡»**ï¼šç›¸åŒå‚æ•°çš„è®¡ç®—ç»“æœå¿…é¡»ä¸€è‡´
- âœ… **å¿…é¡»**ï¼šç¼“å­˜é”®ç”Ÿæˆé€»è¾‘å¿…é¡»å›ºå®šä¸”å”¯ä¸€
- âœ… **å¿…é¡»**ï¼šç¼“å­˜å¤±æ•ˆç­–ç•¥è¦åˆç†ï¼ˆé¿å…è„æ•°æ®ï¼‰

---

#### æ³¨æ„äº‹é¡¹ 4ï¼šé”™è¯¯å¤„ç†

- âœ… **å¿…é¡»**ï¼šå‚æ•°æ ¡éªŒå¤±è´¥è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- âœ… **å¿…é¡»**ï¼šè®¡ç®—å¤±è´¥ä¸å½±å“å…¶ä»–æŒ‡æ ‡çš„è®¡ç®—
- âœ… **å¿…é¡»**ï¼šç¼“å­˜å¼‚å¸¸ä¸å½±å“è®¡ç®—åŠŸèƒ½

---

#### æ³¨æ„äº‹é¡¹ 5ï¼šèŒè´£è¾¹ç•Œï¼ˆğŸ”´ å…³é”®ï¼‰

- âœ… **å¿…é¡»**ï¼šIndicatorEvaluateService åªåšåè°ƒï¼Œå…·ä½“é€»è¾‘åœ¨å­ç»„ä»¶
- âœ… **å¿…é¡»**ï¼šä¸å…è®¸å°†ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ Service ä¸­
- âœ… **å¿…é¡»**ï¼šValidatorã€Routerã€CacheManager å¿…é¡»ç‹¬ç«‹ï¼Œä¸å…è®¸åˆå¹¶
- âœ… **å¿…é¡»**ï¼šä»£ç å®¡æŸ¥æ—¶éªŒè¯èŒè´£è¾¹ç•Œ

---

#### æ³¨æ„äº‹é¡¹ 6ï¼šè¾“å‡ºè¾¹ç•Œï¼ˆğŸ”´ å…³é”®ï¼‰

- âœ… **å¿…é¡»**ï¼šIndicatorEvaluateResult åªè¿”å›è®¡ç®—ç»“æœï¼Œä¸è¿”å›ç­–ç•¥è¯­ä¹‰
- âœ… **ç¦æ­¢**ï¼štradeActionã€positionSideã€signalScoreã€entryFlagã€exitFlagã€weight ç­‰ç­–ç•¥è¯­ä¹‰å­—æ®µ
- âœ… **å¿…é¡»**ï¼šä»£ç å®¡æŸ¥æ—¶éªŒè¯è¾“å‡ºè¾¹ç•Œ
- âœ… **å¿…é¡»**ï¼šç­–ç•¥è¯­ä¹‰ç”±ç­–ç•¥æ¨¡å—è´Ÿè´£ï¼ŒæŒ‡æ ‡æ¨¡å—ä¸æ„ŸçŸ¥

---

#### æ³¨æ„äº‹é¡¹ 7ï¼šFeatureCache å®šä½ï¼ˆğŸ”´ å…³é”®ï¼‰

- âœ… **å¿…é¡»**ï¼šMVP é˜¶æ®µåŠŸèƒ½å®Œå…¨å¯ç”¨ï¼Œä¸ä¾èµ– FeatureCache
- âœ… **å¿…é¡»**ï¼šFeatureCache åªèƒ½ä½œä¸ºæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œä¸èƒ½ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„å‰æ
- âœ… **å¿…é¡»**ï¼šFeatureCache å…³é—­æ—¶åŠŸèƒ½ä»ç„¶æ­£å¸¸ï¼ˆå…³é”®éªŒæ”¶ç‚¹ï¼‰
- âœ… **é™åˆ¶**ï¼šåªå…è®¸ cache çº¯å‡½æ•°ç‰¹å¾ï¼ˆSMAã€EMAã€TRç­‰ï¼‰ï¼Œä¸å…è®¸ä¸šåŠ¡é€»è¾‘

---

## 13. é£é™©ä¸åº”å¯¹

### 13.1 é«˜é£é™©é¡¹

| é£é™©é¡¹ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|------|---------|
| æ—§æ¥å£ä¸å…¼å®¹å¯¼è‡´å‰ç«¯/ç­–ç•¥æ¨¡å—å´©æºƒ | ğŸ”´ é«˜ | ä¼˜å…ˆä¿è¯å‘åå…¼å®¹ï¼Œå……åˆ†æµ‹è¯• |
| ç¼“å­˜æœºåˆ¶ Bug å¯¼è‡´è®¡ç®—ç»“æœé”™è¯¯ | ğŸ”´ é«˜ | å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œç¼“å­˜å¤±æ•ˆç­–ç•¥ |
| **IndicatorEvaluateService å˜æˆ God Service** | ğŸ”´ é«˜ | **ä¸¥æ ¼èŒè´£è¾¹ç•Œï¼Œä»£ç å®¡æŸ¥éªŒè¯ï¼Œå…·ä½“é€»è¾‘å¿…é¡»åœ¨å­ç»„ä»¶** |
| **FeatureCache æˆä¸ºåŠŸèƒ½ä¾èµ–** | ğŸ”´ é«˜ | **MVP å¿…é¡»ä¸ä¾èµ–ï¼Œå…³é—­æ—¶åŠŸèƒ½æ­£å¸¸ï¼Œåªä½œä¸ºæ€§èƒ½ä¼˜åŒ–** |
| **æŒ‡æ ‡æ¨¡å—è¿”å›ç­–ç•¥è¯­ä¹‰** | ğŸ”´ é«˜ | **ä¸¥æ ¼è¾“å‡ºè¾¹ç•Œï¼Œä»£ç å®¡æŸ¥éªŒè¯ï¼Œç¦æ­¢ç­–ç•¥è¯­ä¹‰å­—æ®µ** |
| æ€§èƒ½ä¸è¾¾æ ‡ï¼ˆæŒ‰éœ€è®¡ç®—å¤ªæ…¢ï¼‰ | ğŸŸ¡ ä¸­ | æ‰¹é‡è¯„ä¼°ã€ç¼“å­˜ä¼˜åŒ–ã€ä¸­é—´ç»“æœå¤ç”¨ï¼ˆPhase 2ï¼‰ |

---

### 13.2 ä¸­é£é™©é¡¹

| é£é™©é¡¹ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|------|---------|
| æ•°æ®åº“è¡¨å˜æ›´å½±å“ç°æœ‰æ•°æ® | ğŸŸ¡ ä¸­ | ä¼˜å…ˆä½¿ç”¨ JSON å­—æ®µæ‰©å±•ï¼Œé¿å… ALTER TABLE |
| ç­–ç•¥æ¨¡å—éœ€è¦å¤§é‡é€‚é…å·¥ä½œ | ğŸŸ¡ ä¸­ | ä¿æŒæ¥å£å‘åå…¼å®¹ï¼Œæä¾›è¿ç§»æŒ‡å— |
| å‰ç«¯é¡µé¢æ”¹é€ å·¥ä½œé‡å¤§ | ğŸŸ¡ ä¸­ | åˆ†é˜¶æ®µå®æ–½ï¼Œä¼˜å…ˆæ ¸å¿ƒé¡µé¢ |

---

## 14. æ€»ç»“

### 14.1 V2 æ ¸å¿ƒå˜åŒ–æ€»ç»“

1. **äº§å“å®šä½**ï¼šä»"æŒ‡æ ‡ç»“æœäº‹å®åº“"æ”¹ä¸º"æŒ‡æ ‡å®šä¹‰æ³¨å†Œä¸­å¿ƒ + è¿è¡Œæ—¶æŒ‰éœ€è¯„ä¼°èƒ½åŠ›"
2. **æ•°æ®æ¨¡å‹**ï¼šåªä¿ç•™ `indicator_definition` å•è¡¨ï¼Œç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“
3. **è®¡ç®—æ¨¡å¼**ï¼šä»"è®¢é˜…é©±åŠ¨è‡ªåŠ¨è®¡ç®—"æ”¹ä¸º"æŒ‰éœ€è¯„ä¼° + ç¼“å­˜"
4. **æ ¸å¿ƒèƒ½åŠ›**ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å‚æ•°ã€æŒ‰éœ€è®¡ç®—ã€é«˜æ•ˆç¼“å­˜

---

### 14.2 å…³é”®æ–‡ä»¶æ¸…å•

**æ–°å»ºæ–‡ä»¶**ï¼š
- `IndicatorEvaluateService.java`
- `IndicatorCacheManager.java`
- `IndicatorParamValidator.java`
- `IndicatorEvaluateController.java`
- `FeatureCache.java`ï¼ˆå¯é€‰ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `BarSeriesManager.java`
- `IndicatorCalculator.java`
- `IndicatorDefinition.java`
- `IndicatorDefinitionController.java`
- `IndicatorController.java`

**åºŸå¼ƒæ–‡ä»¶**ï¼š
- æ— ï¼ˆä»£ç ä¿ç•™ä½†æ ‡è®°ä¸ºåºŸå¼ƒï¼‰

---

### 14.3 éªŒæ”¶æ¸…å•ï¼ˆChecklistï¼‰

#### åŠŸèƒ½éªŒæ”¶
- [ ] Kçº¿è®¢é˜…ä»æ­£å¸¸ï¼ˆBarSeriesManagerï¼‰
- [ ] å®šä¹‰è¡¨å¯é…ç½®ï¼ˆåˆ›å»º/ç¼–è¾‘æŒ‡æ ‡å®šä¹‰ï¼‰
- [ ] æ’ä»¶æ˜ å°„ç”Ÿæ•ˆï¼ˆimpl_key è·¯ç”±æ­£ç¡®ï¼‰
- [ ] ç¼“å­˜å‘½ä¸­æœ‰æ•ˆï¼ˆç›¸åŒå‚æ•°ç¬¬äºŒæ¬¡å‘½ä¸­ï¼‰
- [ ] æŒ‰éœ€è¯„ä¼°å¯ç”¨ï¼ˆevaluate/evaluateBatchï¼‰
- [ ] å‚æ•°æ ¡éªŒå®Œæ•´ï¼ˆåŸºäº param_schemaï¼‰
- [ ] æ—§æ¥å£å‘åå…¼å®¹ï¼ˆ/api/indicator/latestï¼‰
- [ ] **ğŸ”´ èŒè´£è¾¹ç•ŒéªŒè¯**ï¼šIndicatorEvaluateService åªåšåè°ƒï¼Œå…·ä½“é€»è¾‘åœ¨å­ç»„ä»¶ï¼ˆValidatorã€Routerã€CacheManagerï¼‰
- [ ] **ğŸ”´ è¾“å‡ºè¾¹ç•ŒéªŒè¯**ï¼šIndicatorEvaluateResult ä¸åŒ…å«ç­–ç•¥è¯­ä¹‰å­—æ®µï¼ˆtradeActionã€positionSideã€signalScoreç­‰ï¼‰
- [ ] **ğŸ”´ FeatureCache éªŒè¯**ï¼šå…³é—­ FeatureCache æ—¶åŠŸèƒ½ä»ç„¶æ­£å¸¸ï¼ˆMVP å¿…é¡»ï¼Œä¸ä¾èµ– FeatureCacheï¼‰

#### æ€§èƒ½éªŒæ”¶
- [ ] ç¼“å­˜å‘½ä¸­å“åº”æ—¶é—´ < 1ms
- [ ] ç¼“å­˜æœªå‘½ä¸­å“åº”æ—¶é—´ < 100ms
- [ ] æ‰¹é‡è¯„ä¼°ååæå‡ > 2å€
- [ ] BarSeries append å»¶è¿Ÿ < 1ms

#### æµ‹è¯•éªŒæ”¶
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›å½’æµ‹è¯•é€šè¿‡
- [ ] å‹æµ‹è¾¾åˆ°é¢„æœŸ

#### æ–‡æ¡£éªŒæ”¶
- [ ] API æ–‡æ¡£å®Œæ•´
- [ ] ä»£ç æ³¨é‡Šå®Œæ•´
- [ ] å¼€å‘æ–‡æ¡£æ›´æ–°
- [ ] ç”¨æˆ·æ‰‹å†Œæ›´æ–°

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV2.0  
**æœ€åæ›´æ–°**ï¼š2024-01  
**ç»´æŠ¤è€…**ï¼šqyl  
**åŸºäºè§„èŒƒ**ï¼š[æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md](./æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md)