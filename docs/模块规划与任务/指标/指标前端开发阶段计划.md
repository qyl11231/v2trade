# 指标模块前端UI开发阶段计划

> 基于《指标前端UI开发指令书》的分阶段开发计划

---

## 📋 开发阶段概览

### 阶段1：后端API接口实现（优先）
**目标**：提供前端所需的全部API接口

### 阶段2：前端页面实现
**目标**：实现5个前端页面，接入后端API

---

## 🔨 阶段1：后端API接口（必须优先完成）

### 1.1 指标定义列表API ✅

**接口**：`GET /api/indicator/definitions`

**任务**：
- 扩展`IndicatorDefinitionRepository`，添加分页查询方法
- 实现Controller：支持keyword、category、engine、enabled筛选
- 返回分页结果

**验收**：
- [ ] 支持分页（page、size）
- [ ] 支持keyword模糊搜索（code/name）
- [ ] 支持category、engine、enabled筛选
- [ ] 返回字段完整（包含paramSchema、returnSchema）

---

### 1.2 订阅管理API ✅

#### 1.2.1 订阅列表查询
**接口**：`GET /api/indicator/subscriptions`

**任务**：
- 扩展`IndicatorSubscriptionRepository`，添加分页查询方法
- 实现Controller：支持userId、tradingPairId、symbolKeyword、timeframe、indicatorCode、enabled筛选

#### 1.2.2 创建订阅
**接口**：`POST /api/indicator/subscriptions`

**任务**：
- 实现创建逻辑
- 处理唯一键冲突（返回409）

#### 1.2.3 启停订阅
**接口**：`PATCH /api/indicator/subscriptions/{id}`

**任务**：
- 实现enabled字段更新
- 只允许更新enabled字段

**验收**：
- [ ] 列表查询支持所有筛选条件
- [ ] 创建订阅正确处理冲突（409）
- [ ] 启停功能正常

---

### 1.3 指标结果查询API ✅

#### 1.3.1 Latest查询
**接口**：`GET /api/indicator/values/latest`

**任务**：
- 扩展`IndicatorValueRepository`，添加查询最新值方法（按bar_time desc limit 1）
- 支持多维度筛选

#### 1.3.2 History查询
**接口**：`GET /api/indicator/values`

**任务**：
- 扩展`IndicatorValueRepository`，添加分页查询方法
- 支持时间范围筛选

**验收**：
- [ ] Latest接口返回每个key的最新一条
- [ ] History接口支持分页和时间范围
- [ ] 返回字段完整

---

### 1.4 计算日志查询API ✅

**接口**：`GET /api/indicator/calc-logs`

**任务**：
- 扩展`IndicatorCalcLogRepository`，添加分页查询方法
- 实现Controller：支持userId、tradingPairId、timeframe、indicatorCode、status筛选
- 检查calcFingerprint字段是否存在，如不存在需要添加

**验收**：
- [ ] 支持所有筛选条件
- [ ] 支持分页
- [ ] 支持status筛选（SUCCESS/FAILED/CONFLICT）

---

## 🎨 阶段2：前端页面实现

### 2.1 菜单和路由注册

**任务**：
1. 在所有现有HTML页面添加"指标管理"菜单
2. 在`PageController`中添加5个路由方法

**文件修改**：
- 所有`src/main/resources/static/*.html`（添加菜单）
- `src/main/java/com/qyl/v2trade/business/system/controller/PageController.java`

**验收**：
- [ ] 所有页面菜单一致
- [ ] 5个路由可访问

---

### 2.2 指标定义页面（最简单，优先）

**文件**：`src/main/resources/static/indicator/definitions.html`

**功能**：
- 列表展示（表格）
- 筛选（keyword、category、engine）
- 点击"查看"按钮打开抽屉展示schema

**验收**：
- [ ] 列表正常显示
- [ ] 筛选功能正常
- [ ] 抽屉正常打开

---

### 2.3 指标订阅页面（核心功能）

**文件**：`src/main/resources/static/indicator/subscriptions.html`

**功能**：
- 订阅列表（表格）
- 筛选功能
- 新建订阅弹窗
- 启停功能

**验收**：
- [ ] 列表正常显示
- [ ] 创建订阅成功
- [ ] 启停功能正常
- [ ] 409错误提示正确

---

### 2.4 计算日志页面

**文件**：`src/main/resources/static/indicator/logs.html`

**功能**：
- 日志列表（表格）
- 筛选（userId、symbol、timeframe、status）
- 点击行打开抽屉

**验收**：
- [ ] 列表正常显示
- [ ] 筛选功能正常
- [ ] 抽屉正常打开

---

### 2.5 指标结果页面

**文件**：`src/main/resources/static/indicator/values.html`

**功能**：
- Latest/History视图切换
- 列表展示
- 筛选功能
- 点击行打开抽屉

**验收**：
- [ ] Latest视图正常（每个key最新一条）
- [ ] History视图正常（分页）
- [ ] 筛选功能正常

---

### 2.6 仪表盘页面

**文件**：`src/main/resources/static/indicator/dashboard.html`

**功能**：
- 统计卡片（4个）
- 最近20条日志表格
- 手动刷新按钮

**验收**：
- [ ] 统计卡片数据正确
- [ ] 日志表格正常显示
- [ ] 刷新功能正常

---

## 📊 开发顺序建议

### 第一阶段（后端API）
1. ✅ 1.1 指标定义列表API
2. ✅ 1.2.1 订阅列表查询
3. ✅ 1.2.2 创建订阅
4. ✅ 1.2.3 启停订阅
5. ✅ 1.3.1 Latest查询
6. ✅ 1.3.2 History查询
7. ✅ 1.4 计算日志查询

### 第二阶段（前端页面）
1. ✅ 2.1 菜单和路由
2. ✅ 2.2 指标定义页面（最简单）
3. ✅ 2.3 指标订阅页面（核心）
4. ✅ 2.4 计算日志页面
5. ✅ 2.5 指标结果页面
6. ✅ 2.6 仪表盘页面

---

## ✅ 验收标准

### 后端API验收
- [ ] 所有接口可正常调用
- [ ] 分页功能正常
- [ ] 筛选功能正常
- [ ] 错误处理正确（409、5xx）

### 前端页面验收
- [ ] 5个页面全部可访问
- [ ] 菜单正确显示
- [ ] 所有页面不使用mock数据
- [ ] 闭环用例可跑通（创建订阅→查看日志→查看结果）

---

## 🔍 注意事项

1. **先完成后端API**：前端需要真实接口才能测试
2. **API优先实现分页**：避免数据量大时前端卡顿
3. **JSON字段统一**：确保paramSchema、returnSchema、params、extraValues都是JSON对象
4. **时间格式统一**：所有时间显示为UTC格式
5. **周期限制**：前端绝对不出现1m周期

