# 指标模块重构影响范围清单

> **重构目标**：从"订阅→每根bar自动计算→落库"改为"订阅只维护K线输入；输出值改为按需evaluate；用缓存与batch保证效率；落库只对白名单指标保留"

---

## 📋 影响范围总览

本重构将对以下7个方面产生影响：

1. ✅ **代码模块**（核心影响）
2. ✅ **数据库表结构**（部分调整）
3. ✅ **API接口**（兼容性改造）
4. ✅ **前端页面**（需要适配）
5. ✅ **文档**（需要更新）
6. ✅ **依赖模块**（策略模块、回测模块）
7. ✅ **配置与监控**（新增配置和指标）

---

## 1. 代码模块影响范围

### 1.1 核心计算模块（⚠️ **重大变更**）

#### 1.1.1 IndicatorCalculator（需要重构/关闭）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/calculator/IndicatorCalculator.java`

**影响程度**：🔴 **重大变更**

**变更内容**：
- ❌ **删除/关闭**：现有的`onBarClosed()`事件监听和自动计算逻辑
- ❌ **删除/关闭**：`computeForPairTfBar()`批量计算逻辑
- ❌ **删除/关闭**：`computeIndicator()`自动计算单个指标的逻辑
- ✅ **保留**：可作为参考，但不再作为主要计算入口
- 🔧 **新增**：Feature Flag控制开关，默认关闭

**影响代码行数**：~460行（需要重构或禁用）

**相关依赖**：
- `@EventListener` 事件监听
- `@Async("indicatorCalculatorExecutor")` 异步处理
- `IndicatorSubscriptionRepository` 订阅查询
- `IndicatorValueRepository` 指标值写入

---

#### 1.1.2 新增 IndicatorEvaluateService（🆕 **新增模块**）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/service/IndicatorEvaluateService.java`（新建）

**影响程度**：🟢 **新增**

**功能职责**：
- 提供统一执行入口：`evaluate()` 和 `evaluateBatch()`
- 支持按需计算（on-demand evaluation）
- 集成缓存机制
- 支持批量评估

**关键方法**：
```java
// 单次评估
IndicatorResult evaluate(String indicatorCode, String version, 
                        Map<String, Object> params, 
                        EvaluationContext context);

// 批量评估
List<IndicatorResult> evaluateBatch(EvaluationContext context, 
                                   List<EvaluationRequest> requests);
```

**依赖关系**：
- `IndicatorEngineRouter`：路由到对应引擎
- `BarSeriesManager`：获取K线数据
- `IndicatorRegistry`：获取指标定义
- `CacheManager`：缓存管理（新增）

---

### 1.2 事件与数据输入层（🟡 **部分调整**）

#### 1.2.1 BarSeriesManager（保留但职责简化）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/series/BarSeriesManager.java`

**影响程度**：🟡 **部分调整**

**变更内容**：
- ✅ **保留**：`bootstrap()` 启动时加载历史数据
- ✅ **保留**：`onBarClosed()` 追加新bar到Series
- ✅ **保留**：`getSeries()` 获取只读视图
- ❌ **删除**：不再触发`IndicatorCalculator`的计算流程
- 🔧 **修改**：移除与`IndicatorCalculator`的耦合

**相关代码行数**：~374行（需移除部分逻辑）

---

### 1.3 存储层（🟡 **逻辑调整**）

#### 1.3.1 IndicatorValueRepository（写入逻辑调整）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorValueRepository.java`
**实现类**：`src/main/java/com/qyl/v2trade/indicator/repository/impl/IndicatorValueRepositoryImpl.java`

**影响程度**：🟡 **逻辑调整**

**变更内容**：
- ✅ **保留**：查询方法（`findLatest()`等）
- 🔧 **修改**：`insertIgnore()` 方法增加白名单判断
- 🔧 **新增**：只对`FACT_PERSISTED`模式的指标写入
- ❌ **禁止**：用户自定义参数的on-demand结果不写库

---

#### 1.3.2 IndicatorSubscriptionRepository（定位调整）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorSubscriptionRepository.java`
**实现类**：`src/main/java/com/qyl/v2trade/indicator/repository/impl/IndicatorSubscriptionRepositoryImpl.java`

**影响程度**：🟡 **定位调整**

**变更内容**：
- ✅ **保留**：CRUD操作（兼容旧逻辑/平台白名单）
- ❌ **取消**：不再作为"驱动计算器"的默认执行路径
- 🔧 **新增**：增加`evalMode`字段支持，只对`FACT_PERSISTED`生效

---

#### 1.3.3 IndicatorCalcLogRepository（写入逻辑调整）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorCalcLogRepository.java`
**实现类**：`src/main/java/com/qyl/v2trade/indicator/repository/impl/IndicatorCalcLogRepositoryImpl.java`

**影响程度**：🟡 **写入逻辑调整**

**变更内容**：
- ✅ **保留**：`append()` 追加写入方法
- 🔧 **修改**：从"每根bar自动计算写入"改为"按需计算时写入"
- 🔧 **新增**：支持`SKIPPED`状态（缓存命中时不写或标记为SKIPPED）

---

### 1.4 定义层（🟡 **扩展字段**）

#### 1.4.1 IndicatorDefinition（表结构扩展）

**实体类**：`src/main/java/com/qyl/v2trade/indicator/repository/entity/IndicatorDefinition.java`
**Mapper**：`src/main/java/com/qyl/v2trade/indicator/repository/mapper/IndicatorDefinitionMapper.java`

**影响程度**：🟡 **字段扩展**

**变更内容**：
- ✅ **保留**：现有字段（`param_schema`、`return_schema`、`engine`等）
- 🔧 **新增字段**
  - `data_source`：BAR / TICK / SIGNAL / MIXED
  - `eval_mode`：FACT_PERSISTED / RUNTIME_ON_DEMAND
  - `param_limits`：lookback上限、窗口上限等（防止资源打爆）

**数据库表变更**：`indicator_definition` 表可能需要ALTER TABLE（如果新增字段）

---

#### 1.4.2 IndicatorDefinitionRepository（支持新字段）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorDefinitionRepository.java`

**影响程度**：🟢 **小幅调整**

**变更内容**：
- 🔧 **新增**：支持按`eval_mode`查询的方法
- 🔧 **新增**：参数校验逻辑（基于`param_schema`和`param_limits`）

---

### 1.5 API层（🟡 **兼容性改造**）

#### 1.5.1 IndicatorController（语义改造）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/api/IndicatorController.java`

**影响程度**：🟡 **兼容性改造**

**变更内容**：
- ✅ **保留**：`GET /api/indicator/latest` 接口（兼容老前端/老策略）
- 🔧 **改造**：查询逻辑改为：
  - 白名单指标：仍从`indicator_value`查
  - 用户自定义params：走`evaluate(on-demand)`并返回
- 🔧 **新增**：响应里增加`source`字段（CACHE/ON_DEMAND/DB）

**影响范围**：所有调用此接口的客户端（前端、策略模块）

---

#### 1.5.2 IndicatorValueController（可能需要调整）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/api/IndicatorValueController.java`

**影响程度**：🟢 **可能小幅调整**

**变更内容**：
- 确认是否需要支持批量查询接口

---

#### 1.5.3 IndicatorSubscriptionController（功能保留）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/api/IndicatorSubscriptionController.java`

**影响程度**：🟢 **基本不变**

**变更内容**：
- ✅ **保留**：CRUD功能
- 🔧 **新增**：支持`evalMode`字段的配置

---

#### 1.5.4 IndicatorDefinitionController（扩展功能）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/api/IndicatorDefinitionController.java`

**影响程度**：🟢 **功能扩展**

**变更内容**：
- 🔧 **新增**：支持新字段的CRUD
- 🔧 **新增**：参数校验接口（用于前端表单校验）

---

#### 1.5.5 🆕 新增 IndicatorEvaluateController（新增）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/api/IndicatorEvaluateController.java`（新建）

**影响程度**：🟢 **新增**

**功能职责**：
- 提供评估API接口
- 支持单次评估和批量评估

**接口设计**：
```java
POST /api/indicator/evaluate
POST /api/indicator/evaluate/batch
```

---

### 1.6 缓存层（🆕 **新增模块**）

#### 1.6.1 🆕 IndicatorCacheManager（新增）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/cache/IndicatorCacheManager.java`（新建）

**影响程度**：🟢 **新增**

**功能职责**：
- 缓存键规范：`indicatorCode + version + pairId + timeframe + asOfBarTime + hash(params)`
- 缓存TTL/容量配置
- 缓存命中率统计

**依赖关系**：
- 可能需要集成Redis或Caffeine缓存

---

### 1.7 配置层（🟡 **新增配置**）

#### 1.7.1 AsyncConfig（可能需要调整）

**文件路径**：`src/main/java/com/qyl/v2trade/config/AsyncConfig.java`

**影响程度**：🟢 **可能需要调整**

**变更内容**：
- 🔧 **调整**：`indicatorCalculatorExecutor`线程池可能需要减小或移除（如果完全关闭自动计算）

---

#### 1.7.2 🆕 IndicatorEvaluateConfig（新增）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/config/IndicatorEvaluateConfig.java`（新建）

**影响程度**：🟢 **新增**

**配置内容**：
- 缓存TTL配置
- 缓存容量限制
- Feature Flag：是否启用旧的自动计算模式
- 白名单指标列表

---

## 2. 数据库表影响范围

### 2.1 indicator_definition（🟡 **可能ALTER TABLE**）

**影响程度**：🟡 **可能ALTER TABLE**

**变更内容**：
- 方案1：直接在表上新增字段
  - `data_source` VARCHAR(32) DEFAULT 'BAR'
  - `eval_mode` VARCHAR(32) DEFAULT 'RUNTIME_ON_DEMAND'
  - `param_limits` JSON


**建议**：优先使用方案2，避免数据库变更

---

### 2.2 indicator_subscription（🟢 **无需变更**）

**影响程度**：🟢 **无需变更**

**变更内容**：
- 保留表结构不变
- 只调整使用逻辑（不再作为计算驱动源，仅用于白名单指标）

---

### 2.3 indicator_value（🟢 **无需变更**）

**影响程度**：🟢 **无需变更**

**变更内容**：
- 保留表结构不变
- 只调整写入逻辑（只对FACT_PERSISTED模式写入）

---

### 2.4 indicator_calc_log（🟡 **可能扩展status枚举**）

**影响程度**：🟡 **可能需要扩展**

**变更内容**：
- 可能需要新增`SKIPPED`状态（缓存命中时使用）
- 或保持现状，缓存命中时不写日志

---

## 3. API接口影响范围

### 3.1 现有接口（🟡 **兼容性改造**）

| 接口 | 路径 | 影响程度 | 变更内容 |
|------|------|---------|---------|
| GET /api/indicator/latest | `IndicatorController.getLatest()` | 🟡 改造 | 查询逻辑改为：白名单查DB，自定义走evaluate |
| POST /api/indicator/subscription | `IndicatorSubscriptionController.create()` | 🟢 扩展 | 支持`evalMode`字段 |
| PUT /api/indicator/subscription | `IndicatorSubscriptionController.update()` | 🟢 扩展 | 支持`evalMode`字段 |
| GET /api/indicator/subscription/list | `IndicatorSubscriptionController.list()` | 🟢 扩展 | 支持按`evalMode`筛选 |
| GET /api/indicator/definition/list | `IndicatorDefinitionController.list()` | 🟢 扩展 | 返回新字段 |

**影响客户端**：
- 前端页面：`indicator/values.html`、`indicator/subscriptions.html`等
- 策略模块：调用`/api/indicator/latest`的地方

---

### 3.2 新增接口（🟢 **新增**）

| 接口 | 路径 | 用途 | 影响 |
|------|------|------|------|
| POST /api/indicator/evaluate | `IndicatorEvaluateController.evaluate()` | 单次评估 | 策略模块、回测模块 |
| POST /api/indicator/evaluate/batch | `IndicatorEvaluateController.evaluateBatch()` | 批量评估 | 策略模块、回测模块 |

---

## 4. 前端页面影响范围

### 4.1 指标结果页面（🟡 **需要适配**）

**文件路径**：`src/main/resources/static/indicator/values.html`

**影响程度**：🟡 **需要适配**

**变更内容**：
- 🔧 **适配**：API返回的`source`字段（CACHE/ON_DEMAND/DB）
- 🔧 **新增**：可能需要支持"按需计算"按钮（调用evaluate接口）
- 🔧 **适配**：白名单指标和自定义参数指标的展示区分

---

### 4.2 指标订阅页面（🟡 **需要扩展**）

**文件路径**：`src/main/resources/static/indicator/subscriptions.html`

**影响程度**：🟡 **需要扩展**

**变更内容**：
- 🔧 **新增**：`evalMode`字段的选择（FACT_PERSISTED / RUNTIME_ON_DEMAND）
- 🔧 **新增**：参数表单渲染（基于`param_schema`）
- 🔧 **新增**：参数校验（前端校验 + 后端校验）

---

### 4.3 指标定义页面（🟡 **需要扩展**）

**文件路径**：`src/main/resources/static/indicator/definitions.html`

**影响程度**：🟡 **需要扩展**

**变更内容**：
- 🔧 **新增**：`data_source`、`eval_mode`、`param_limits`字段的编辑
- 🔧 **新增**：参数Schema的可视化编辑

---

### 4.4 指标仪表盘（🟡 **可能需要调整**）

**文件路径**：`src/main/resources/static/indicator/dashboard.html`

**影响程度**：🟡 **可能需要调整**

**变更内容**：
- 🔧 **调整**：统计指标可能需要区分FACT_PERSISTED和RUNTIME_ON_DEMAND
- 🔧 **新增**：缓存命中率展示

---

### 4.5 指标计算日志页面（🟢 **基本不变**）

**文件路径**：`src/main/resources/static/indicator/logs.html`

**影响程度**：🟢 **基本不变**

**变更内容**：
- 可能新增`SKIPPED`状态的展示

---

## 5. 文档影响范围

### 5.1 产品规范文档（🔴 **重大更新**）

**文件路径**：`docs/模块规划与任务/指标/指标模块产品规范.md`

**影响程度**：🔴 **重大更新**

**变更内容**：
- ❌ **删除/修改**：删除"必须：按周期计算并持久化指标结果"的要求
- 🔧 **新增**：明确双模式：
  - FACT模式（平台白名单/系统指标）：仍可按周期计算并持久化
  - RUNTIME模式（用户自定义参数）：默认不持久化，只按需计算
- 🔧 **新增**：明确哪些指标/哪些场景允许落库
- 🔧 **新增**：Tick级实时指标仍然不做（保持原则）

---

### 5.2 架构说明文档（🟡 **需要更新**）

**文件路径**：`docs/模块规划与任务/指标/指标模块架构说明.md`

**影响程度**：🟡 **需要更新**

**变更内容**：
- 🔧 **更新**：数据流转图（移除自动计算链路，新增按需计算链路）
- 🔧 **更新**：核心业务流程说明
- 🔧 **新增**：缓存机制说明
- 🔧 **新增**：evaluate服务说明

---

### 5.3 总体设计文档（🟡 **需要更新**）

**文件路径**：`docs/模块规划与任务/指标/指标模块总体设计.md`

**影响程度**：🟡 **需要更新**

**变更内容**：
- 🔧 **更新**：核心职责说明
- 🔧 **更新**：数据流转架构图
- 🔧 **更新**：关键组件设计（移除IndicatorCalculator的自动计算职责）
- 🔧 **新增**：IndicatorEvaluateService设计说明
- 🔧 **新增**：缓存机制设计说明

---

### 5.4 快速入门文档（🟡 **需要更新**）

**文件路径**：`docs/模块规划与任务/指标/指标模块快速入门.md`

**影响程度**：🟡 **需要更新**

**变更内容**：
- 🔧 **更新**：核心流程说明（从"自动计算"改为"按需计算"）
- 🔧 **更新**：使用示例

---

### 5.5 API文档（🟡 **需要更新**）

**影响程度**：🟡 **需要更新**

**变更内容**：
- 🔧 **更新**：现有接口的变更说明
- 🔧 **新增**：新增接口的文档

---

## 6. 依赖模块影响范围

### 6.1 策略模块（🟡 **需要适配**）

**影响程度**：🟡 **需要适配**

**影响内容**：
- 如果策略模块直接调用`/api/indicator/latest`：
  - ✅ **向后兼容**：接口保持兼容，但返回结果可能包含`source`字段
- 如果策略模块需要按需计算自定义参数指标：
  - 🔧 **需要适配**：调用新的`/api/indicator/evaluate`接口
  - 🔧 **需要适配**：可能需要调用`evaluateBatch`接口提升性能

**影响代码位置**（需要搜索）：
- 策略模块中调用指标API的地方
- 策略运行时（Strategy Runtime）使用指标的地方

---

### 6.2 回测模块（🟡 **可能需要适配**）

**影响程度**：🟡 **可能需要适配**

**影响内容**：
- 回测模块可能需要批量评估指标
- 🔧 **建议**：使用`evaluateBatch`接口提升回测性能

---

### 6.3 风控模块（🟢 **可能影响**）

**影响程度**：🟢 **可能影响**

**影响内容**：
- 如果风控模块依赖指标值，可能需要适配新的查询方式

---

## 7. 配置与监控影响范围

### 7.1 应用配置（🟡 **新增配置项**）

**配置文件**：`src/main/resources/application.yml`

**影响程度**：🟡 **新增配置项**

**新增配置**：
```yaml
indicator:
  evaluate:
    cache:
      enabled: true
      ttl: 3600  # 缓存TTL（秒）
      max-size: 10000  # 缓存最大容量
    auto-calculate:
      enabled: false  # Feature Flag：是否启用旧的自动计算模式
    whitelist:
      # FACT_PERSISTED模式的指标列表
      persisted-indicators:
        - RSI
        - MACD
```

---

### 7.2 Metrics指标（🟡 **新增指标**）

**文件路径**：`src/main/java/com/qyl/v2trade/indicator/observability/IndicatorMetrics.java`

**影响程度**：🟡 **新增指标**

**新增Metrics**：
- `evaluate_cost_ms`：评估耗时（Timer，P50/P95/P99）
- `cache_hit_ratio`：缓存命中率（Gauge）
- `cache_hits_total`：缓存命中次数（Counter）
- `cache_misses_total`：缓存未命中次数（Counter）
- `evaluate_batch_size`：批量评估大小分布（Histogram）

**保留Metrics**：
- `calc_cost_ms`：可能保留用于白名单指标的自动计算
- `calc_failures_total`：可能保留
- `calc_conflicts_total`：可能保留（如果白名单仍有冲突检测）

---

### 7.3 日志（🟢 **基本不变**）

**影响程度**：🟢 **基本不变**

**变更内容**：
- 结构化日志字段可能需要新增`source`字段（CACHE/ON_DEMAND/DB）

---

## 8. 测试影响范围

### 8.1 单元测试（🟡 **需要大量更新**）

**影响程度**：🟡 **需要大量更新**

**需要更新的测试**：
- `IndicatorCalculatorTest`：需要更新或删除（如果关闭自动计算）
- 🆕 `IndicatorEvaluateServiceTest`：新增测试
- 🆕 `IndicatorCacheManagerTest`：新增测试
- `IndicatorDefinitionTest`：需要测试新字段
- `BarSeriesManagerTest`：需要确认测试是否仍有效

---

### 8.2 集成测试（🟡 **需要更新**）

**影响程度**：🟡 **需要更新**

**需要更新的测试**：
- `IndicatorRepositoryIntegrationTest`：需要更新
- 🆕 `IndicatorEvaluateIntegrationTest`：新增测试
- API接口测试：需要测试新接口和改造后的接口

---

### 8.3 回归测试（🟡 **需要重点保障**）

**影响程度**：🟡 **需要重点保障**

**测试重点**：
- ✅ 旧接口`/api/indicator/latest`必须向后兼容
- ✅ 前端页面不能因为API变更而崩溃
- ✅ 策略模块调用指标接口必须正常工作

---

## 9. 实施优先级建议

### 9.1 第一阶段（最小闭环）

1. ✅ **B1**：保留BarSeriesManager，但断开IndicatorCalculator的计算触发
2. ✅ **C1**：新增IndicatorEvaluateService，实现基础evaluate功能
3. ✅ **C2**：实现缓存机制

**验收标准**：
- BarSeriesManager正常工作
- evaluate接口可用
- 缓存机制工作正常

---

### 9.2 第二阶段（兼容性）

4. ✅ **E1**：改造`/api/indicator/latest`接口，支持按需计算
5. ✅ **E2**：Feature Flag控制旧IndicatorCalculator的开关

**验收标准**：
- 旧接口向后兼容
- 前端页面正常工作

---

### 9.3 第三阶段（完整功能）

6. ✅ **A2**：扩展IndicatorDefinition，支持新字段
7. ✅ **C3**：实现批量评估和中间结果复用
8. ✅ **D1-D3**：存储层重构（白名单持久化）

**验收标准**：
- 所有新功能正常工作
- 性能达到预期

---

### 9.4 第四阶段（优化与完善）

9. ✅ **F1-F2**：性能监控和压测
10. ✅ **G1-G3**：完整测试覆盖

**验收标准**：
- 性能达标
- 测试覆盖充分

---

## 10. 风险评估

### 10.1 高风险项

| 风险项 | 影响 | 缓解措施 |
|--------|------|---------|
| 旧接口不兼容导致前端/策略模块崩溃 | 🔴 高 | 优先保证向后兼容，使用Feature Flag灰度发布 |
| 缓存机制Bug导致计算结果错误 | 🔴 高 | 充分的单元测试和集成测试，缓存失效策略 |
| 性能不达标（按需计算太慢） | 🟡 中 | 批量评估、缓存优化、中间结果复用 |

---

### 10.2 中风险项

| 风险项 | 影响 | 缓解措施 |
|--------|------|---------|
| 数据库表变更影响现有数据 | 🟡 中 | 优先使用JSON字段扩展，避免ALTER TABLE |
| 策略模块需要大量适配工作 | 🟡 中 | 保持接口向后兼容，提供迁移指南 |

---

## 11. 总结

### 11.1 影响统计

- **代码文件**：约20+个文件需要修改/新建
- **数据库表**：1个表可能需要ALTER（或使用JSON扩展）
- **API接口**：5+个接口需要改造/新增
- **前端页面**：4+个页面需要适配
- **文档**：5+个文档需要更新
- **依赖模块**：策略模块、回测模块可能需要适配

### 11.2 关键决策点

1. **Feature Flag策略**：如何灰度关闭旧的计算链路
2. **缓存策略**：使用Redis还是本地缓存（Caffeine）
3. **数据库扩展**：使用ALTER TABLE还是JSON字段扩展
4. **向后兼容**：如何保证旧接口和旧客户端正常工作

---

**文档版本**：v1.0  
**创建日期**：2024-01  
**维护者**：qyl

