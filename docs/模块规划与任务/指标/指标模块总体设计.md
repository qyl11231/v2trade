# 指标模块总体设计文档（V2.0）

> **版本**: V2.0  
> **创建日期**: 2024-01  
> **维护者**: qyl  
> **文档目标**: 基于代码实现、表结构和业务需求，提供指标模块 V2 版本的完整总体设计说明
> **基于规范**: [指标v2版本重构产品规范.md](./指标v2版本重构产品规范.md)

---

## 📋 目录

1. [模块概述](#1-模块概述)
2. [系统定位与边界](#2-系统定位与边界)
3. [架构设计](#3-架构设计)
4. [数据模型设计](#4-数据模型设计)
5. [核心业务流程](#5-核心业务流程)
6. [关键组件设计](#6-关键组件设计)
7. [技术实现细节](#7-技术实现细节)
8. [接口设计](#8-接口设计)
9. [可观测性与监控](#9-可观测性与监控)
10. [扩展性与演进](#10-扩展性与演进)

---

## 1. 模块概述

### 1.1 模块定义（V2 一句话定义）

> **指标模块 V2 是"指标定义注册中心 + 运行时按需评估能力"，以 K线闭合作为输入事实流维护 BarSeries；指标结果不在指标模块落库，而归档在策略大脑的 rules_record（strategy_rules_record）里。**

**与 V1.2 的区别**：
- ❌ V1.2：指标结果事实库 + 自动计算落库
- ✅ V2.0：指标定义注册中心 + 运行时按需评估能力，结果归档到策略规则体

### 1.2 核心职责（V2）

1. **K线输入维护**：监听K线闭合事件（BarClosedEvent），只维护K线时间序列数据（BarSeries），**不触发任何指标计算**
2. **指标定义管理**：提供指标定义表的 CRUD、查询、版本管理，支持用户自定义 schema
3. **运行时按需评估**：提供 `evaluate()` / `evaluateBatch()` 统一入口，支持策略/回测/页面按需调用
4. **缓存命中保障**：同参同上下文（indicatorCode+version+pair+tf+barTime+params）结果可复用
5. **结果归档**：指标模块不做 value 落库；策略大脑把评估结果写入 `strategy_rules_record`

### 1.3 核心特性（V2）

- ✅ **K线订阅不变**：继续接收 BarClosedEvent，只维护 BarSeries（输入窗口）
- ✅ **按需评估**：谁用谁算，不自动计算
- ✅ **运行时缓存**：同参同上下文必须缓存命中，保证效率
- ✅ **单表设计**：只保留 `indicator_definition` 一张表
- ✅ **策略无关**：不感知策略语义，不返回交易动作/权重/打分
- ✅ **可扩展性**：支持多种计算引擎（ta4j、custom），易于添加新指标
- ✅ **可观测性**：集成Metrics和结构化日志

### 🔴 1.4 产品级职责边界（必须冻结）

#### 1.4.1 IndicatorEvaluateService 职责边界

**产品定位（一句话定义）**：
> **IndicatorEvaluateService 是"纯运行时评估服务"，不关心策略、不关心持久化、不关心订阅，仅对 definition + context + params 负责。**

**组件拆分原则（刻意拆分，不允许再塞逻辑）**：
```
IndicatorEvaluateService（纯运行时评估服务）
 ├── IndicatorParamValidator      // schema + limits 校验
 ├── IndicatorEngineRouter        // impl_key → plugin 路由
 └── IndicatorCacheManager        // cacheKey + hit/miss 缓存
```

#### 1.4.2 Evaluate 输出边界（禁止策略语义）

**核心原则**：
> **evaluate 只返回"计算结果"，不返回"多/空/是否满足条件"等策略语义。**

**允许的输出**：
- ✅ `values` / `extraValues`：指标计算值（数值结果）
- ✅ `valid`：是否有效（基于 min_required_bars）
- ✅ `fingerprint`：计算指纹（用于策略归档）
- ✅ `source`：数据来源（CACHE/COMPUTED）
- ✅ `costMs`：计算耗时

**禁止的输出**：
- ❌ `tradeAction`、`positionSide`、`signalScore`、`entryFlag`、`exitFlag`、`weight` 等策略语义

---

## 2. 系统定位与边界

### 2.1 系统层级关系

```
交易所行情（OKX）
    ↓
行情接入层（WebSocket / REST）
    ↓
行情标准化层（价格 / K线聚合）
    ↓
【指标模块 ← 本文档】
    ↓
策略模块（阶段2：条件判断）
    ↓
交易执行 / 回测 / 风控
```

### 2.2 依赖关系

| 方向 | 关系 | 说明 |
|------|------|------|
| 指标 → 行情 | ✅ 允许 | 指标模块依赖行情系统的K线数据 |
| 策略 → 指标 | ✅ 允许（只读） | 策略模块可以查询指标值 |
| 指标 → 策略 | ❌ 禁止 | 指标模块不得感知策略逻辑 |
| 指标 → 交易 | ❌ 禁止 | 指标模块不得直接触发交易 |

### 2.3 模块边界（V2）

**必须做的事：**
- 接收标准化K线数据（BarClosedEvent）
- 维护K线时间序列（BarSeries），每个交易对的5个周期（5m、15m、30m、1h、4h）各自维护365根
- 提供指标定义管理（CRUD、查询、版本管理）
- 提供运行时按需评估能力（evaluate/evaluateBatch）
- 提供缓存命中保障（同参同上下文可复用）

**严禁做的事（V2 绝对禁止）**：
- ❌ **不允许在 `BarClosedEvent` 中计算指标**
- ❌ **不允许新增指标结果表**（`indicator_value`、`indicator_subscription`、`indicator_calc_log` 不再使用）
- ❌ **不允许根据订阅自动计算指标**
- ❌ **不允许在指标层输出交易语义**（多/空/打分/权重等）
- ❌ **不允许把缓存作为功能正确性的依赖**（FeatureCache 只能作为性能优化）
- ❌ 感知`strategy_id`
- ❌ 感知入场/出场逻辑
- ❌ Tick级随意更新指标值

### 2.4 支持的周期

指标模块**只支持以下5个周期**（不包含1m）：
- `5m`：5分钟
- `15m`：15分钟
- `30m`：30分钟
- `1h`：1小时
- `4h`：4小时

**原因**：
- 1m周期数据量太大，不适合指标计算
- 聚合后的周期更稳定，更适合技术分析
- 所有周期都从QuestDB的聚合表（`kline_5m`、`kline_15m`等）读取

---

## 3. 架构设计

### 3.1 分层架构

指标模块采用分层架构设计，各层职责清晰：

```
┌─────────────────────────────────────────────────────────────┐
│                      API层 (对外接口)                          │
│  IndicatorController / IndicatorValueController / ...        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    业务层 (计算逻辑)                            │
│  IndicatorCalculator / IndicatorEngineRouter                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    领域层 (核心概念)                            │
│  IndicatorDefinition / IndicatorRegistry / BarSeriesManager   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  基础设施层 (数据访问)                           │
│  Repository / Mapper / QuestDbKlineReader                     │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 目录结构

```
indicator/
├── api/                          # API层（对外接口）
│   ├── dto/                      # 数据传输对象
│   │   ├── IndicatorValueDTO.java
│   │   ├── IndicatorEvaluateResultDTO.java
│   │   └── EvaluateRequestDTO.java
│   ├── IndicatorController.java  # 只读API控制器（兼容旧接口）
│   ├── IndicatorEvaluateController.java  # 评估API控制器（V2新增）
│   ├── IndicatorDefinitionController.java
│   └── IndicatorSubscriptionController.java  # 降级为调试辅助
│
├── bootstrap/                    # 启动初始化
│   ├── IndicatorBootstrapListener.java  # 监听应用启动
│   └── IndicatorBootstrapper.java      # 注册内置指标定义
│
├── calculator/                   # 计算核心（V2：已废弃，Feature Flag控制）
│   ├── IndicatorCalculator.java        # 指标计算器（默认关闭）
│   └── IndicatorEngineRouter.java      # 引擎路由器（保留）
│
├── runtime/                      # 运行时评估层（V2新增）
│   ├── IndicatorEvaluateService.java   # 运行时评估服务（核心）
│   ├── EvaluationContext.java          # 评估上下文
│   └── IndicatorEvaluateResult.java   # 评估结果
│
├── validation/                   # 参数校验（V2新增）
│   └── IndicatorParamValidator.java    # 参数校验器
│
├── cache/                        # 缓存层（V2新增）
│   ├── IndicatorCacheManager.java     # 缓存管理器
│   └── FeatureCache.java              # 特征缓存（Phase 2，可选）
│
├── config/                       # 配置类
│   └── IndicatorEngineConfig.java      # 引擎自动注册配置
│
├── definition/                   # 指标定义
│   ├── builtin/
│   │   └── BuiltinIndicatorDefinitions.java  # 内置指标定义
│   ├── impl/
│   │   ├── SimpleIndicatorDefinition.java
│   │   └── SimpleIndicatorRegistry.java
│   ├── IndicatorDefinition.java
│   ├── IndicatorRegistry.java
│   ├── IndicatorCategory.java
│   ├── ParameterSpec.java
│   └── ReturnSpec.java
│
├── domain/                       # 领域模型
│   ├── event/
│   │   ├── BarClosedEvent.java
│   │   ├── BarClosedEventPublisher.java
│   │   └── impl/
│   └── model/
│       └── NormalizedBar.java
│
├── engine/                       # 计算引擎
│   ├── custom/
│   │   └── SimpleSmaEngine.java
│   ├── ta4j/
│   │   └── Ta4jIndicatorEngine.java
│   ├── IndicatorEngine.java
│   ├── IndicatorComputeRequest.java
│   └── IndicatorResult.java
│
├── infrastructure/               # 基础设施
│   ├── converter/
│   ├── resolver/
│   └── time/
│
├── observability/                # 可观测性
│   ├── IndicatorMetrics.java
│   └── SubscriptionMetricsUpdater.java
│
├── persistence/                  # 持久化工具
│   └── CalcFingerprint.java
│
├── repository/                   # 数据访问层
│   ├── entity/
│   ├── impl/
│   └── mapper/
│
└── series/                       # Bar系列管理
    ├── BarSeriesManager.java
    ├── BarSeriesView.java
    └── QuestDbKlineReader.java
```

### 3.3 数据流转架构（V2）

```
┌─────────────────────────────────────────────────────────────┐
│                     启动阶段（Bootstrap）                       │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                    │
        ┌───────────▼──────────┐  ┌─────▼────────────┐
        │ QuestDbTsSemanticsProbe│  │IndicatorBootstrapper│
        │   检测QuestDB时间语义    │  │  注册内置指标定义   │
        └───────────┬──────────┘  └─────┬────────────┘
                    │                    │
                    └─────────┬──────────┘
                              ▼
        ┌─────────────────────────────────────┐
        │ IndicatorBootstrapListener          │
        │ 触发 BarSeriesManager.bootstrap()    │
        │ 从行情订阅配置获取交易对                │
        │ 为每个交易对的5个周期加载历史数据        │
        │ (5m/15m/30m/1h/4h，不包含1m)        │
        └─────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│             运行时阶段（K线输入维护，不触发计算）                  │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────────────────────┐
        │ K线聚合完成                         │
        │ 发布 BarClosedEvent                 │
        └─────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │ BarSeriesManager     │
                    │ 只维护K线数据        │
                    │ - 追加Bar（去重）    │
                    │ - 维护365根窗口      │
                    │ ❌ 不触发任何计算    │
                    └─────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│             按需评估阶段（策略/回测/页面调用）                      │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────────────────────┐
        │ 策略大脑/回测/页面调用                │
        │ POST /api/indicator/evaluate        │
        │ POST /api/indicator/evaluate/batch │
        └─────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │ IndicatorEvaluate    │
                    │ Service              │
                    │ (纯运行时评估服务)    │
                    └─────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                    │
        ┌───────────▼────────┐  ┌───────▼──────────┐
        │ IndicatorParam     │  │ IndicatorCache   │
        │ Validator          │  │ Manager          │
        │ (参数校验)         │  │ (查询缓存)        │
        └────────────────────┘  └──────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │ 缓存未命中：执行计算  │
                    │ - 获取指标定义       │
                    │ - 获取BarSeries     │
                    │ - 路由到引擎        │
                    │ - 执行计算          │
                    │ - 写入缓存          │
                    └─────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │ 返回评估结果         │
                    │ - values/fingerprint │
                    │ - source (CACHE/     │
                    │   COMPUTED)         │
                    │ ❌ 不包含策略语义     │
                    └─────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │ 策略模块归档         │
                    │ 写入 strategy_rules  │
                    │ _record              │
                    └─────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│             兼容查询阶段（向后兼容）                            │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────────────────────┐
        │ 策略模块调用API（兼容）               │
        │ GET /api/indicator/latest          │
        └─────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │ IndicatorController  │
                    │ - 先查DB（白名单）    │
                    │ - 否则按需评估       │
                    │ - 返回source字段     │
                    └─────────────────────┘
```

---

## 4. 数据模型设计（V2）

### 4.1 数据表设计（V2：只保留一张表）

**V2 核心变化**：
- ✅ **保留**：`indicator_definition`（单表，指标定义注册中心）
- ❌ **废弃**：`indicator_subscription`（不再作为产品主路径）
- ❌ **废弃**：`indicator_value`（不再落库，结果归档到策略规则体）
- ❌ **废弃**：`indicator_calc_log`（不再作为产品主路径，可选保留用于调试）

#### 4.1.1 indicator_definition（指标定义表，V2 唯一表）

**作用**：存储指标的定义信息，包括参数规范、返回值结构等元数据。

**关键字段**（V2 扩展）：
- `user_id`：所属用户ID（0=系统内置；>0=用户自定义）
- `indicator_code`：指标编码（如"RSI"、"MACD"）
- `indicator_version`：版本号（如"v1"）
- `indicator_name`：指标名称（展示用）
- `description`：指标描述
- `category`：指标分类（TREND/MOMENTUM/VOLATILITY/VOLUME/GENERAL）
- `data_source`：数据源（BAR/TICK/SIGNAL/MIXED，V2新增）
- `impl_key`：实现映射键（如`ta4j:rsi`/`builtin:price_breakout`，V2新增）
- `engine`：计算引擎（ta4j/custom，向后兼容）
- `param_schema`：参数Schema（JSON格式，用于前端表单渲染+后端校验）
- `return_schema`：返回Schema（JSON格式，用于输出校验+前端展示）
- `min_required_bars`：最小所需bar数量
- `supported_timeframes`：支持周期列表（JSON格式）
- `enabled`：是否启用

**唯一索引**：`(user_id, indicator_code, indicator_version)`

**设计要点**（V2）：
- **单表设计**：只依赖 `indicator_definition` 就能描述一个完整指标
- 支持多版本并存（同一指标可以有v1、v2等版本）
- 系统内置指标使用`user_id=0`标识
- 通过JSON字段存储灵活的参数和返回值结构
- `param_schema` 支持前端自动生成表单
- `impl_key` 支持插件硬代码映射

#### 4.1.2 V2 废弃的表（不再作为产品主路径）

**indicator_subscription**：
- V1.2：决定要算哪些指标
- V2：不再作为计算驱动源，可选保留用于调试/监控

**indicator_value**：
- V1.2：存储指标事实数据
- V2：不再落库，结果归档到策略大脑的 `strategy_rules_record`

**indicator_calc_log**：
- V1.2：记录每次计算的详细日志
- V2：不再作为产品主路径，可选保留用于调试/性能分析

### 4.2 实体关系图（V2）

```
indicator_definition (指标定义，V2唯一表)
    │
    │ (直接使用)
    ▼
IndicatorEvaluateService (运行时评估)
    │
    │ (结果归档)
    ▼
strategy_rules_record (策略规则体，策略模块)
```

**关系说明**（V2）：
- 指标定义直接用于运行时评估
- 评估结果归档到策略规则体（`strategy_rules_record`），不属于指标模块
- 不再有订阅、值、日志的复杂关系

### 4.3 数据一致性保障（V2）

1. **缓存一致性**：通过固定缓存键规范保证相同参数结果一致
2. **参数校验**：基于 `param_schema` 和 `param_limits` 进行严格校验
3. **结果校验**：基于 `return_schema` 校验返回结果格式
4. **计算指纹**：通过 `fingerprint` 标识计算配置，用于策略归档和可解释性

---

## 5. 核心业务流程

### 5.1 系统启动流程

**目标**：初始化系统，加载历史数据

**流程步骤**：

1. **时间语义检测**（`QuestDbTsSemanticsProbe`）
   - 应用启动时，自动检测QuestDB的`ts`字段是开盘时间还是收盘时间
   - 将结果保存在内存中，供后续适配器使用
   - 如果检测失败，系统无法启动（fail fast）

2. **注册内置指标**（`IndicatorBootstrapper`）
   - 读取`BuiltinIndicatorDefinitions`中定义的10个内置指标
   - 注册到内存中的`IndicatorRegistry`
   - 持久化到`indicator_definition`表（`user_id=0`表示系统内置）
   - 如果已存在，自动忽略（去重）

3. **加载历史数据**（`BarSeriesManager.bootstrap()`）
   - **从行情订阅配置获取交易对**：查询`market_subscription_config`表，获取所有启用的交易对
   - **为每个交易对的5个周期加载K线**：对每个交易对，为5个周期（5m、15m、30m、1h、4h）都加载最近365根历史K线
     - 从QuestDB对应的聚合表加载（`kline_5m`、`kline_15m`等，不加载`kline_1m`）
     - 转换为`NormalizedBar`（统一时间语义）
     - 构建内存中的`BarSeries`（按时间排序）
   - **K线数据独立维护**：K线维护与指标订阅解耦，确保基础数据始终可用
   - 订阅`BarClosedEvent`，准备接收实时数据

### 5.2 K线闭合流程（V2：只维护输入，不触发计算）

**目标**：当一根K线完成时，只维护K线数据，不触发任何指标计算

**流程步骤**：

1. **事件发布**（`AggregationConfig`）
   - K线聚合完成后，发布`BarClosedEvent`
   - 事件包含：symbol、timeframe、bar数据、barCloseTime

2. **事件接收**（`BarSeriesManager`）
   - **BarSeriesManager**：接收事件，将Bar追加到对应的内存Series（去重）
     - 自动维护对应周期（5m、15m、30m、1h、4h）的K线数据
     - 如果BarSeries不存在，动态创建（支持运行时添加新交易对）
     - 自动维护最新365根，去除最旧的（防止内存泄漏）
   - ❌ **禁止**：不再触发任何指标计算流程
   - ❌ **禁止**：`IndicatorCalculator` 默认关闭（Feature Flag控制）

3. **验证**
   - CPU 使用率不随指标数量变化
   - 日志明确记录"只维护K线，不计算指标"

---

### 5.3 按需评估流程（V2：新主链路）

**目标**：策略/回测/页面按需调用评估接口，计算指标结果

**流程步骤**：

1. **API调用**
   ```
   POST /api/indicator/evaluate
   POST /api/indicator/evaluate/batch
   ```

2. **参数校验**（`IndicatorParamValidator`）
   - 基于 `param_schema` 校验参数格式、类型、范围
   - 基于 `param_limits` 校验 lookback 上限、窗口上限等限制

3. **生成缓存键**（`IndicatorCacheManager`）
   - 固定格式：`indicatorCode + version + pairId + timeframe + asOfBarTime + hash(params)`
   - params 排序和序列化，保证一致性

4. **查询缓存**（`IndicatorCacheManager`）
   - 如果缓存命中，直接返回结果（`source=CACHE`）
   - 如果缓存未命中，继续执行计算

5. **执行计算**（缓存未命中时）
   - 获取指标定义（`IndicatorDefinitionRepository`）
   - 获取 BarSeries（`BarSeriesManager.getSeries()`）
   - 检查 `min_required_bars`（不足则返回 `valid=false`）
   - 路由到对应引擎（`IndicatorEngineRouter`，优先使用 `impl_key`）
   - 执行计算（调用引擎的 `compute()` 方法）
   - 校验返回结果（基于 `return_schema`）

6. **写入缓存**（`IndicatorCacheManager`）
   - 将计算结果写入缓存（TTL 可配置）

7. **返回结果**（`IndicatorEvaluateResult`）
   - `values` / `extraValues`：指标计算值
   - `valid`：是否有效
   - `fingerprint`：计算指纹（用于策略归档）
   - `source`：CACHE / COMPUTED
   - `costMs`：计算耗时
   - ❌ **禁止**：不包含任何策略语义字段

8. **策略归档**（策略模块负责）
   - 策略模块将评估结果写入 `strategy_rules_record`
   - 包含 `fingerprint`、`paramsHash`、`source`、`costMs` 等信息

### 5.4 兼容查询流程（V2：向后兼容）

**目标**：兼容旧接口，支持策略模块查询指标值

**流程步骤**：

1. **API调用**（兼容旧接口）
   ```
   GET /api/indicator/latest?userId=1&pairId=1&timeframe=1h&code=RSI&version=v1
   ```

2. **查询逻辑**（V2改造）
   - **先查数据库**（如果有白名单指标的历史数据）：
     - `IndicatorValueRepository.findLatest()`（可选，向后兼容）
     - 如果找到，返回结果（`source=DB`）
   - **按需评估**（如果数据库没有）：
     - 调用 `IndicatorEvaluateService.evaluate()`
     - 返回评估结果（`source=CACHE` 或 `COMPUTED`）

3. **返回结果**
   - 转换为`IndicatorValueDTO`
   - 封装为`Result<IndicatorValueDTO>`
   - **新增**：`source` 字段（CACHE/COMPUTED/DB）
   - 如果不存在，返回`null`（不报错）

**关键点**（V2）：
- ✅ **向后兼容**：旧接口仍然可用
- ✅ **按需计算**：如果数据库没有，自动调用评估服务
- ✅ **明确来源**：通过 `source` 字段明确数据来源

### 5.5 K线数据管理流程（V2：保持不变）

**核心原则**：K线数据是市场数据，对所有用户相同。

**数据共享机制**：
- BarSeries的key格式为`pairId:timeframe`（不包含userId）
- 同一交易对同一周期的K线对所有用户共享
- 节省内存、提高效率、简化维护

**数据维护机制**：
- 启动时从QuestDB加载最近365根K线（5m/15m/30m/1h/4h）
- 实时追加新K线时，自动去除最旧的，保持最新365根
- 支持动态创建BarSeries（新交易对运行时添加）
- ❌ **禁止**：不再触发任何指标计算

---

## 6. 关键组件设计（V2）

### 6.1 IndicatorEvaluateService（运行时评估服务，V2核心）

**职责**（纯运行时评估服务）：
- 提供统一的按需评估入口（`evaluate()` / `evaluateBatch()`）
- 只做协调，具体逻辑在子组件
- 不关心策略、不关心持久化、不关心订阅

**组件拆分**（刻意拆分，不允许再塞逻辑）：
```
IndicatorEvaluateService（纯运行时评估服务）
 ├── IndicatorParamValidator      // schema + limits 校验
 ├── IndicatorEngineRouter        // impl_key → plugin 路由
 └── IndicatorCacheManager         // cacheKey + hit/miss 缓存
```

**关键方法**：
```java
public IndicatorEvaluateResult evaluate(
        String indicatorCode, String version,
        Map<String, Object> params,
        EvaluationContext context) {
    // 1. 参数校验（调用 IndicatorParamValidator）
    // 2. 生成缓存键（调用 IndicatorCacheManager）
    // 3. 查询缓存（调用 IndicatorCacheManager）
    // 4. 缓存未命中：执行计算
    //    - 获取指标定义
    //    - 获取BarSeries
    //    - 路由到引擎（调用 IndicatorEngineRouter）
    //    - 执行计算
    //    - 写入缓存
    // 5. 返回结果
}
```

**设计要点**：
- **单一职责**：只做协调，不包含业务逻辑
- **组件拆分**：Validator、Router、CacheManager 必须独立
- **输出边界**：不返回策略语义字段

---

### 6.2 IndicatorCalculator（V2：已废弃，Feature Flag控制）

**职责**（V2变化）：
- ❌ **默认关闭**：通过 Feature Flag 控制，默认 `enabled=false`
- ✅ **保留代码**：作为参考，但不执行
- 🔧 **标记废弃**：添加 `@Deprecated` 注解

**关键方法**：
```java
@Deprecated  // V2: 自动计算已废弃
@Value("${indicator.auto-calculate.enabled:false}")
private boolean autoCalculateEnabled;

@EventListener
@Async("indicatorCalculatorExecutor")
public void onBarClosed(BarClosedEvent event) {
    // V2: 默认关闭自动计算
    if (!autoCalculateEnabled) {
        log.debug("自动计算已关闭，跳过指标计算");
        return;
    }
    // 原有逻辑保留（但默认不执行）
}
```

**设计要点**（V2）：
- 默认关闭，不触发任何计算
- 可通过配置开关回滚（向后兼容）
- 代码保留但标记为废弃

### 6.3 BarSeriesManager（Bar系列管理器，V2保持不变）

**职责**（V2）：
- 管理内存中的`BarSeries`（每个pair+timeframe一个）
- 启动时从QuestDB加载历史数据
- 实时追加新的Bar（去重）
- ❌ **禁止**：不再触发任何指标计算

**关键方法**：
```java
public void bootstrap() {
    // 启动时：
    // 1. 从行情订阅配置获取交易对
    // 2. 为每个交易对的5个周期（5m、15m、30m、1h、4h）都加载历史数据
    // 3. K线维护独立于指标订阅
}

public void onBarClosed(BarClosedEvent event) {
    // 实时：
    // 1. 追加Bar到对应的Series（去重）
    // 2. 自动维护最新365根，去除最旧的
    // 3. 支持动态创建BarSeries（新交易对）
    // ❌ 禁止：不再触发任何指标计算流程
}

public BarSeriesView getSeries(long pairId, String timeframe) {
    // 获取只读视图（K线数据是共享的，不区分用户）
}
```

**设计要点**（V2）：
- K线数据共享（不区分用户）
- 自动维护最新365根，防止内存泄漏
- 支持动态创建（运行时添加新交易对）
- **职责单一**：只维护K线数据，不触发计算

### 6.4 IndicatorEngineRouter（引擎路由器，V2扩展）

**职责**（V2扩展）：
- 路由到对应的计算引擎
- 优先使用 `impl_key` 映射，回退到 `engine` 字段（向后兼容）

**接口定义**：
```java
IndicatorEngine getEngine(IndicatorDefinition definition);
```

**路由逻辑**：
```java
// 优先使用 impl_key
if (definition.getImplKey() != null) {
    IndicatorEngine engine = implKeyMap.get(definition.getImplKey());
    if (engine != null) {
        return engine;
    }
}
// 回退到 engine 字段
return engineMap.get(definition.getEngine());
```

**实现**：
- `Ta4jIndicatorEngine`：基于ta4j库，支持标准指标（RSI、MACD、BOLL等）
- `SimpleSmaEngine`：自定义SMA实现示例

**设计要点**（V2）：
- 支持 `impl_key` 到引擎的映射（如 `ta4j:rsi`）
- 向后兼容：没有 `impl_key` 时使用 `engine` 字段
- 接口与实现分离，易于扩展

---

### 6.5 IndicatorParamValidator（参数校验器，V2新增）

**职责**（V2新增）：
- 基于 `param_schema` 校验参数格式、类型、范围
- 基于 `param_limits` 校验 lookback 上限、窗口上限等限制
- 独立组件，不允许合并到 Service

**接口定义**：
```java
void validate(String indicatorCode, String version, Map<String, Object> params);
```

**校验内容**：
- 必填参数校验
- 参数类型校验（integer、decimal、string、boolean）
- 参数范围校验（min、max）
- 枚举值校验
- lookback 上限、窗口上限等限制

**设计要点**：
- 独立组件，必须从 Service 中拆分
- 只负责参数校验，不涉及业务逻辑

---

### 6.6 IndicatorCacheManager（缓存管理器，V2新增）

**职责**（V2新增）：
- 生成缓存键（固定规范）
- 缓存查询和写入
- 缓存命中率统计

**缓存键规范**（必须固定）：
```
indicatorCode + version + pairId + timeframe + asOfBarTime + hash(params)
```

**关键方法**：
```java
String generateCacheKey(...);
Optional<IndicatorEvaluateResult> get(String cacheKey);
void put(String cacheKey, IndicatorEvaluateResult result);
CacheStats getStats();
```

**设计要点**：
- 缓存键生成逻辑必须固定且唯一
- 支持 TTL 和容量配置
- 缓存命中率统计可用

---

### 6.7 IndicatorRegistry（指标注册表，V2保持不变）

**职责**（V2）：
- 内存中管理所有指标定义
- 启动时从数据库加载
- 提供查询接口

**关键方法**：
```java
void register(IndicatorDefinition definition);
Optional<IndicatorDefinition> get(String code, String version);
```

**设计要点**：
- 内存缓存，提高查询效率
- 支持运行时注册（新增指标定义）

---

## 7. 技术实现细节

### 7.1 事件驱动机制（V2：只维护输入）

**事件类型**：`BarClosedEvent`

**事件发布**：由K线聚合模块发布

**事件订阅**（V2）：
- `BarSeriesManager`：订阅事件，**只维护K线数据**
- ❌ `IndicatorCalculator`：**默认关闭**，不再触发指标计算

**事件处理**（V2）：
- `BarSeriesManager.onBarClosed()`：只做K线追加和维护，不触发计算
- 使用Spring的`@EventListener`机制
- 不再使用异步处理（因为不计算）

### 7.2 按需评估机制（V2：新机制）

**评估触发**：
- 策略模块调用 `evaluate()` / `evaluateBatch()`
- 回测模块调用批量评估
- 前端页面调用评估接口

**评估流程**：
1. 参数校验（`IndicatorParamValidator`）
2. 缓存查询（`IndicatorCacheManager`）
3. 缓存未命中：执行计算
4. 写入缓存
5. 返回结果

**设计要点**：
- 同步处理（按需调用，不阻塞）
- 缓存命中时响应时间 < 1ms
- 缓存未命中时响应时间 < 100ms（单指标）

### 7.3 缓存机制（V2：新机制）

**缓存键规范**（必须固定）：
```
indicatorCode + version + pairId + timeframe + asOfBarTime + hash(params)
```

**实现方式**：
- 使用 Caffeine（本地缓存）或 Redis（分布式缓存）
- TTL 和容量可配置
- 支持缓存命中率统计

**缓存一致性**：
- 相同参数生成相同缓存键
- 相同缓存键返回相同结果
- 缓存失效策略合理（避免脏数据）

### 7.4 计算指纹机制（V2：用于策略归档）

**生成方式**：
- 拼接：`code:version:params:engine`
- 计算SHA-256哈希
- 得到64位十六进制字符串

**用途**（V2）：
- 唯一标识一次计算配置
- 用于策略归档（写入 `strategy_rules_record`）
- 用于可解释性和复盘

### 7.5 时间语义统一

**问题**：QuestDB的`ts`字段可能是开盘时间或收盘时间

**解决方案**：
- `QuestDbTsSemanticsProbe`：启动时检测时间语义
- `TimeAlignmentAdapter`：统一转换为收盘时间（bar_close_time）
- `NormalizedBar`：统一的Bar模型，时间语义为收盘时间

### 7.6 数据源适配

**当前数据源**：OKX（通过QuestDB聚合表）

**扩展性设计**：
- `source`字段预留多交易所支持
- 通过适配器模式支持不同数据源
- `QuestDbKlineReader`：当前实现，可从QuestDB读取K线

---

## 8. 接口设计

### 8.1 运行时评估接口（V2：新主链路）

#### 8.1.1 单次评估

**接口**：`POST /api/indicator/evaluate`

**请求体**：
```json
{
  "userId": 1,
  "tradingPairId": 1,
  "timeframe": "1h",
  "asOfBarTime": "2024-01-01T12:00:00",
  "indicatorCode": "RSI",
  "indicatorVersion": "v1",
  "params": {"period": 14}
}
```

**返回**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "valid": true,
    "source": "CACHE",
    "values": {"value": 65.5},
    "fingerprint": "abc123...",
    "costMs": 1
  }
}
```

#### 8.1.2 批量评估

**接口**：`POST /api/indicator/evaluate/batch`

**请求体**：
```json
{
  "userId": 1,
  "tradingPairId": 1,
  "timeframe": "1h",
  "asOfBarTime": "2024-01-01T12:00:00",
  "requests": [
    {"indicatorCode": "RSI", "indicatorVersion": "v1", "params": {"period": 14}},
    {"indicatorCode": "MACD", "indicatorVersion": "v1", "params": {"fast": 12, "slow": 26}}
  ]
}
```

**返回**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {"valid": true, "source": "CACHE", "values": {...}},
    {"valid": true, "source": "COMPUTED", "values": {...}}
  ]
}
```

---

### 8.2 兼容查询接口（V2：向后兼容）

#### 8.2.1 查询最新指标值

**接口**：`GET /api/indicator/latest`

**参数**：
- `userId`：用户ID（必填）
- `pairId`：交易对ID（必填）
- `timeframe`：周期（必填）
- `code`：指标编码（必填）
- `version`：版本号（可选，默认v1）

**返回**（V2扩展）：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1,
    "tradingPairId": 1,
    "symbol": "BTC-USDT",
    "timeframe": "1h",
    "indicatorCode": "RSI",
    "indicatorVersion": "v1",
    "barTime": "2024-01-01T12:00:00",
    "value": 65.5,
    "extraValues": null,
    "source": "CACHE",
    "calcEngine": "ta4j",
    "calcCostMs": 1
  }
}
```

**查询逻辑**（V2）：
- 先查数据库（如果有白名单指标的历史数据）
- 如果数据库没有，调用 `evaluate()` 按需计算
- 返回结果包含 `source` 字段（CACHE/COMPUTED/DB）

### 8.3 定义管理接口（V2：核心接口）

#### 8.3.1 指标定义 CRUD

**接口**：
- `GET /api/indicator/definitions`：列表/筛选
- `POST /api/indicator/definitions`：创建
- `PUT /api/indicator/definitions/{id}`：更新
- `PATCH /api/indicator/definitions/{id}`：启停

**请求体示例**（创建）：
```json
{
  "indicatorCode": "CUSTOM_RSI",
  "indicatorVersion": "v1",
  "indicatorName": "自定义RSI",
  "dataSource": "BAR",
  "implKey": "ta4j:rsi",
  "paramSchema": {
    "period": {"type": "integer", "required": true, "default": 14, "min": 1, "max": 100}
  },
  "returnSchema": {
    "type": "SINGLE_VALUE",
    "valueType": "decimal"
  },
  "enabled": true
}
```

#### 8.3.2 参数校验接口

**接口**：`POST /api/indicator/definitions/{id}/validate-params`

**请求体**：
```json
{
  "params": {"period": 14}
}
```

**返回**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "valid": true,
    "errors": []
  }
}
```

---

## 9. 可观测性与监控

### 9.1 Metrics指标（V2）

**指标定义**（`IndicatorMetrics`）：
- `evaluate_cost_ms`：评估耗时（Timer，自动计算P50/P95/P99）
- `cache_hit_ratio`：缓存命中率（Gauge）
- `cache_hits_total`：缓存命中次数（Counter）
- `cache_misses_total`：缓存未命中次数（Counter）
- `evaluate_batch_size`：批量评估大小分布（Histogram）
- `evaluate_failures_total`：评估失败次数（Counter）

**暴露方式**：
- Spring Boot Actuator + Prometheus
- 访问路径：`/actuator/prometheus`

### 9.2 结构化日志

**日志字段**（使用MDC）：
- `user_id`：用户ID
- `trading_pair_id`：交易对ID
- `symbol`：交易对符号
- `timeframe`：周期
- `bar_time`：K线收盘时间
- `indicator_code`：指标编码
- `indicator_version`：版本号
- `engine`：计算引擎
- `cost_ms`：计算耗时
- `data_quality`：数据质量
- `calc_fingerprint`：计算指纹
- `error_msg`：错误信息（如果有）

**日志级别**：
- INFO：计算成功
- WARN：计算失败
- ERROR：系统异常

### 9.3 数据库监控

**关键查询**：
```sql
-- 查看最新计算的指标值
SELECT * FROM indicator_value 
ORDER BY created_at DESC LIMIT 10;

-- 查看失败的计算
SELECT * FROM indicator_calc_log 
WHERE status = 'FAILED' 
ORDER BY created_at DESC LIMIT 10;

-- 查看冲突日志
SELECT * FROM indicator_calc_log 
WHERE status = 'FAILED' AND error_msg LIKE '%CONFLICT%';

-- 查看计算性能统计
SELECT 
    indicator_code,
    AVG(cost_ms) as avg_cost_ms,
    MAX(cost_ms) as max_cost_ms,
    COUNT(*) as total_count
FROM indicator_calc_log
WHERE status = 'SUCCESS'
GROUP BY indicator_code;
```

---

## 10. 扩展性与演进

### 10.1 添加新指标（V2）

**方式1：系统内置指标**
1. 在`BuiltinIndicatorDefinitions`中添加定义
2. 设置 `impl_key`（如 `ta4j:rsi`）
3. 重启应用，自动注册到数据库

**方式2：用户自定义指标**
1. 通过API创建指标定义（`POST /api/indicator/definitions`）
2. 设置 `user_id` 不为0
3. 配置 `param_schema` 和 `return_schema`
4. 设置 `impl_key` 或使用现有 `engine`
5. 系统会自动加载到内存注册表

### 10.2 添加新计算引擎

**步骤**：
1. 实现`IndicatorEngine`接口
2. 添加`@Component`注解，指定`engineName`
3. `IndicatorEngineConfig`会自动注册到路由器

**示例**：
```java
@Component("myCustomEngine")
public class MyCustomEngine implements IndicatorEngine {
    @Override
    public String getEngineName() {
        return "myCustomEngine";
    }
    
    @Override
    public IndicatorResult compute(IndicatorComputeRequest request, BarSeriesView series) {
        // 实现计算逻辑
    }
}
```

### 10.3 支持新周期

**当前限制**：只支持5m、15m、30m、1h、4h

**扩展方式**：
1. 在`QuestDbTsSemanticsProbe.getSupportedTimeframes()`中添加新周期
2. 确保QuestDB有对应的聚合表（`kline_{period}`）
3. 更新`BarSeriesManager`的周期列表

### 10.4 支持多数据源

**当前实现**：只支持OKX（通过QuestDB）

**扩展设计**：
- `source`字段已预留
- 通过适配器模式支持不同数据源
- 可以实现`KlineReader`接口，支持不同数据库

### 10.5 性能优化方向（V2）

1. **批量评估**：`evaluateBatch()` 支持批量评估，减少缓存查询次数
2. **缓存优化**：运行时缓存（IndicatorCacheManager）保证同参同上下文命中
3. **中间结果复用**：FeatureCache（Phase 2，可选）支持基础序列缓存
4. **并行计算**：批量评估时可以并行计算多个指标

---

## 11. V2 版本核心变化总结

### 11.1 产品定位变化

- ❌ **V1.2**：指标结果事实库 + 自动计算落库
- ✅ **V2.0**：指标定义注册中心 + 运行时按需评估能力，结果归档到策略规则体

### 11.2 数据模型变化

- ✅ **保留**：`indicator_definition`（单表，指标定义注册中心）
- ❌ **废弃**：`indicator_subscription`、`indicator_value`、`indicator_calc_log`（不再作为产品主路径）

### 11.3 计算模式变化

- ❌ **废弃**：订阅驱动的自动计算（每根bar自动计算）
- ✅ **新增**：按需评估（evaluate/evaluateBatch）+ 运行时缓存

### 11.4 核心组件变化

- ❌ **废弃**：`IndicatorCalculator` 的自动计算功能（默认关闭，Feature Flag控制）
- ✅ **新增**：`IndicatorEvaluateService`（运行时评估服务，V2核心）
- ✅ **新增**：`IndicatorParamValidator`（参数校验器，独立组件）
- ✅ **新增**：`IndicatorCacheManager`（缓存管理器，保证效率）

### 11.5 职责边界（V2 必须遵守）

1. **IndicatorEvaluateService**：纯运行时评估服务，只做协调，具体逻辑在子组件
2. **Evaluate 输出**：只返回计算结果，不返回策略语义（tradeAction、positionSide、signalScore等）
3. **FeatureCache**：Phase 2 性能优化项，MVP 必须不依赖

### 11.6 绝对禁止事项（V2）

- ❌ **不允许在 `BarClosedEvent` 中计算指标**
- ❌ **不允许新增指标结果表**
- ❌ **不允许根据订阅自动计算指标**
- ❌ **不允许在指标层输出交易语义**
- ❌ **不允许把缓存作为功能正确性的依赖**

---

## 附录

### A. 内置指标列表

当前支持的内置指标（基于ta4j引擎）：
- RSI（相对强弱指标）
- MACD（指数平滑异同移动平均线）
- SMA（简单移动平均）
- EMA（指数移动平均）
- BOLL（布林带）
- ATR（平均真实波幅）
- Stochastic（随机指标）
- Momentum（动量指标）
- WMA（加权移动平均）
- KDJ（随机指标KDJ）

### B. 相关文档索引（V2）

- [指标v2版本重构产品规范.md](./指标v2版本重构产品规范.md) - V2 产品规范
- [指标V2版本开发任务详细清单.md](./指标V2版本开发任务详细清单.md) - V2 详细开发任务
- [指标V2分阶段开发执行计划.md](./指标V2分阶段开发执行计划.md) - V2 分阶段执行计划
- [指标模块架构说明.md](./指标模块架构说明.md) - 详细的架构和流程说明（V1.2，历史参考）
- [指标模块快速入门.md](./指标模块快速入门.md) - 快速上手指南（V1.2，历史参考）
- [指标表设计.md](./指标表设计.md) - 数据库表设计详细说明

### C. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| v1.2.1 | 2024-01 | 初始版本，指标结果事实库 + 自动计算落库 |
| V2.0 | 2024-01 | 重构版本，指标定义注册中心 + 运行时按需评估，结果归档到策略规则体 |

---

**文档版本**：V2.0  
**最后更新**：2024-01  
**维护者**：qyl  
**基于规范**：[指标v2版本重构产品规范.md](./指标v2版本重构产品规范.md)

