非常好，这一轮我会**完全站在“产品 + 系统架构负责人”的视角**来写，而不是“策略实现者”的视角。
你这句话本身已经给了**正确的方法论**：

> **定义是什么 → 在系统什么位置 → 有什么功能 → 如何帮助交易 → 用户能直观感受到什么**

下面是我给你的 **《指标模块产品规范 V1.2（完整版）》**。
这是一份**可以直接进入评审 / 立项 / 开发的规范**，不是概念说明。

---

# 指标模块产品规范 V1.2

## 1. 模块定义（What）

### 1.1 模块名称

**指标模块（Indicator Service）**

### 1.2 模块一句话定义（必须能背下来）

> **指标模块是行情系统的派生计算层，用于将标准化行情（K线）转化为稳定、可复用、可审计的技术分析指标事实数据。**

### 1.3 核心定位关键词

* 行情派生（Derived from Market Data）
* 客观事实（Deterministic Facts）
* 策略无关（Strategy-Agnostic）
* 可复用（Multi-Consumer）

---

## 2. 系统中的位置（Where）

### 2.1 所处系统层级

```text
交易所行情
   ↓
行情接入层（WS / REST）
   ↓
行情标准化层（价格 / K线）
   ↓
【指标模块 ← 本规范】
   ↓
策略模块（阶段2条件判断）
   ↓
交易执行 / 回测 / 风控
```

### 2.2 系统依赖关系（强约束）

| 方向      | 规则     |
| ------- | ------ |
| 指标 → 行情 | 允许     |
| 策略 → 指标 | 允许（只读） |
| 指标 → 策略 | ❌ 禁止   |
| 指标 → 交易 | ❌ 禁止   |

> **指标模块是“行情系统的一部分”，不是策略模块的子模块。**

---

## 3. 模块存在的业务价值（Why）

### 3.1 没有指标模块会发生什么？

* 每个策略各自计算指标
* 结果不一致
* 无法复盘
* 无法对账
* 无法解释“为什么当时会交易”

### 3.2 指标模块解决的核心问题

| 问题       | 指标模块的价值   |
| -------- | --------- |
| 指标重复计算   | 统一计算、统一存储 |
| 指标口径不一致  | 指标版本化     |
| 回测与实盘不一致 | 指标事实可回放   |
| 策略不可解释   | 指标作为可审计输入 |

---

## 4. 模块职责边界（Must / Must Not）

### 4.1 指标模块 **必须做的事**

1. 接收标准化 K 线数据
2. 维护指标所需时间序列
3. 按周期计算指标
4. 持久化指标结果
5. 提供统一查询接口

### 4.2 指标模块 **严禁做的事**

| 禁止项            | 原因    |
| -------------- | ----- |
| 感知 strategy_id | 破坏解耦  |
| 感知入场/出场        | 决策语义  |
| 根据策略参数算指标      | 不可复用  |
| Tick 级随意更新     | 结果不稳定 |

---

## 5. 功能定义（What Can It Do）

### 5.1 指标计算能力（V1.2）

**支持指标类型**

#### A. 趋势类

* SMA
* EMA
* WMA

#### B. 动量类

* RSI
* Stochastic
* Momentum

#### C. 波动率

* ATR
* Bollinger Bands

#### D. 复合指标

* MACD
* KDJ

> 指标计算基于 **ta4j**，作为内部计算引擎。

---

### 5.2 时间与触发模型（关键）

| 项    | 说明         |
| ---- | ---------- |
| 触发点  | K线 Close   |
| 更新频率 | 每个周期一根     |
| 不支持  | Tick 内反复更新 |

**示例：**

* 5m K线 close → 更新 5m 指标
* 1h K线 close → 更新 1h 指标

---

## 6. 数据模型（Indicator as Market Fact）

### 6.1 指标事实定义

> **指标 =（交易对 + 周期 + 时间点）→ 确定性结果**

### 6.2 数据库设计（核心）

```sql
CREATE TABLE indicator_value (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  trading_pair_id BIGINT NOT NULL,
  timeframe VARCHAR(16) NOT NULL,
  bar_time DATETIME NOT NULL,

  indicator_code VARCHAR(64) NOT NULL,
  indicator_version VARCHAR(16) NOT NULL,

  value DECIMAL(20,8),
  extra_values JSON,

  data_quality VARCHAR(16) NOT NULL COMMENT 'OK / PARTIAL',
  created_at DATETIME NOT NULL,

  UNIQUE KEY uk_indicator (
    trading_pair_id,
    timeframe,
    bar_time,
    indicator_code,
    indicator_version
  )
);
```

### 6.3 指标版本机制（必须）

* 同一指标允许多版本并存
* 策略选择使用哪个版本
* 旧版本永不覆盖

---

## 7. 对策略模块的“帮助方式”（How It Helps）

### 7.1 策略如何使用指标

* **只读**
* **不触发**
* **不计算**

```text
策略阶段2：
  读取指标
  ↓
  判断条件
  ↓
  生成意图
```

### 7.2 指标在策略阶段2中的角色

> **指标不是信号，也不是决策
> 指标是策略判断的“环境输入”**

---

## 8. 用户可感知的产品能力（User Value）

### 8.1 用户能“看到”的能力

| 能力    | 说明      |
| ----- | ------- |
| 指标一致  | 回测与实盘一致 |
| 策略可解释 | 能看到当时指标 |
| 策略可复盘 | 指标可回放   |
| 多策略共享 | 不重复计算   |

### 8.2 用户体验示例

> “当时 RSI=72，价格突破布林上轨，策略选择不入场”

这句话成立的前提：
👉 **指标是事实，而不是临时算的**

---

## 9. 可靠性与生产环境要求（Production Grade）

### 9.1 一致性保障

* 同一 K 线 → 同一指标结果
* 幂等写入
* 不允许回写历史值

### 9.2 异常处理

| 场景     | 行为         |
| ------ | ---------- |
| K线缺失   | 标记 PARTIAL |
| 指标计算失败 | 跳过 + 告警    |
| 系统重启   | 重算最近 N 根   |

---

## 10. V1.2 明确不做的事（Scope Control）

* ❌ 指标告警
* ❌ 指标直接生成交易信号
* ❌ 用户自定义公式
* ❌ Tick 级实时指标

---

## 11. 与阶段二的关系（最终澄清）

| 模块   | 角色     |
| ---- | ------ |
| 指标模块 | 行情派生事实 |
| 阶段二  | 条件判断   |
| 决策模块 | 意图生成   |

**这是清晰、稳定、可扩展的工业级分层。**

---

## 12. 最终总结（一句话）

> **指标模块 V1.2 是行情系统的派生计算层，
> 它不思考、不判断、不决策，
> 它只负责把行情变成“可信赖的技术事实”。**

