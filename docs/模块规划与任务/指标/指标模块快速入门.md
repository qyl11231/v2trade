# 指标模块快速入门（5分钟上手）

> 给新手的最快速入门指南，帮助理解指标模块的核心概念和工作流程

## 🎯 一句话概括

**指标模块**：当K线完成时，自动计算用户订阅的技术指标（如RSI、MACD），并将结果存储到数据库供策略使用。

---

## 🔄 核心流程（3步理解）

### 1️⃣ 启动阶段：初始化

```
应用启动
  ↓
注册内置指标（RSI、MACD等）→ 写入数据库
  ↓
从行情订阅配置获取交易对
  ↓
为每个交易对的5个周期加载历史K线
  (5m、15m、30m、1h、4h，不包含1m)
  ↓
构建内存中的BarSeries（每个周期维护365根）
  ↓
等待K线闭合事件
```

### 2️⃣ 运行时：事件触发计算

```
K线聚合完成
  ↓
发布 BarClosedEvent（K线闭合事件）
  ↓
IndicatorCalculator 接收事件
  ↓
查询订阅 → 找到需要计算的指标
  ↓
使用引擎计算（如ta4j）→ 生成指标值
  ↓
写入数据库（indicator_value + indicator_calc_log）
```

### 3️⃣ 查询阶段：策略使用

```
策略模块调用API
  ↓
GET /api/indicator/latest?userId=1&pairId=1&timeframe=1h&code=RSI
  ↓


  ↓
返回给策略模块
```

---

## 📦 核心组件（5个）

### 1. **BarClosedEvent**（事件）
- **作用**：K线完成时的通知
- **包含**：交易对、周期、K线数据、收盘时间

### 2. **BarSeriesManager**（数据管理）
- **作用**：管理K线时间序列数据
- **功能**：
  - 从行情订阅配置获取交易对
  - 为每个交易对的5个周期（5m、15m、30m、1h、4h）都维护K线
  - 启动时从QuestDB加载历史数据（每个周期365根）
  - 实时追加新的K线（自动维护最新365根，去除最旧的）
  - **K线数据共享**：不区分用户，同一交易对同一周期的K线对所有用户相同

### 3. **IndicatorCalculator**（计算器）
- **作用**：计算指标的核心组件
- **流程**：
  1. 监听事件
  2. 查询订阅
  3. 调用引擎计算
  4. 写入数据库

### 4. **IndicatorEngine**（引擎）
- **作用**：实际执行计算的组件
- **类型**：
  - `Ta4jIndicatorEngine`：标准指标（RSI、MACD等）
  - `SimpleSmaEngine`：自定义引擎示例

### 5. **IndicatorController**（API）
- **作用**：提供查询接口
- **接口**：`GET /api/indicator/latest`

---

## 💾 数据库表（4张）

### 1. `indicator_definition`（指标定义）
- **作用**：存储指标的定义信息
- **示例**：RSI，参数period=14

### 2. `indicator_subscription`（订阅配置）
- **作用**：用户订阅的指标
- **示例**：用户1订阅BTC-USDT的1h周期RSI指标

### 3. `indicator_value`（指标值）
- **作用**：存储计算好的指标值
- **示例**：RSI=65.5（在某个时间点）

### 4. `indicator_calc_log`（计算日志）
- **作用**：记录每次计算的日志（审计用）
- **示例**：2024-01-01 12:00，RSI计算成功，耗时15ms

---

## 🚀 快速体验流程

### 步骤1：创建订阅

```sql
INSERT INTO indicator_subscription 
(user_id, trading_pair_id, timeframe, indicator_code, indicator_version, enabled)
VALUES 
(1, 1, '1h', 'RSI', 'v1', 1);
```

### 步骤2：等待K线完成

系统会自动：
- 检测到K线完成
- 发布BarClosedEvent
- 触发指标计算
- 写入数据库

### 步骤3：查询结果

```bash
# 方式1：API查询
curl "http://localhost:8080/api/indicator/latest?userId=1&pairId=1&timeframe=1h&code=RSI"

# 方式2：直接查数据库
SELECT * FROM indicator_value 
WHERE user_id=1 AND trading_pair_id=1 AND timeframe='1h' AND indicator_code='RSI'
ORDER BY bar_time DESC LIMIT 1;
```

---

## 🔍 关键概念（5分钟理解）

### 1. Bar（K线）
一根K线 = 一个时间段的市场数据（开高低收）

### 2. BarClosedEvent（K线闭合事件）
K线完成时的通知 = 触发计算的唯一入口
- **支持的周期**：5m、15m、30m、1h、4h（不包含1m）

### 3. 行情订阅配置（MarketSubscriptionConfig）
定义哪些交易对需要采集行情数据
- **作用**：指标模块从行情订阅配置获取需要维护K线的交易对列表
- **与指标订阅的关系**：K线维护独立于指标订阅，确保基础数据始终可用

### 4. Subscription（指标订阅）
用户配置：我要计算哪个交易对的哪个周期的哪个指标
- **与K线维护的关系**：K线数据已经维护好，指标订阅只是决定计算哪些指标

### 5. Engine（引擎）
计算指标的组件，就像计算器，输入K线数据，输出指标值

### 6. Fingerprint（指纹）
唯一标识一次计算的配置，用于检测冲突

### 7. K线数据共享
同一交易对同一周期的K线对所有用户相同
- **好处**：节省内存，提高效率，简化维护
- **实现**：BarSeries的key格式为`pairId:timeframe`（不包含userId）

---

## ❓ 常见疑问

### Q: 指标什么时候计算？
**A**: 当K线完成时自动计算，不需要手动触发。

### Q: 如何添加新指标？
**A**: 
1. 在`BuiltinIndicatorDefinitions`中添加定义（系统内置）
2. 或插入`indicator_definition`表（用户自定义）

### Q: 计算失败怎么办？
**A**: 失败会记录到`indicator_calc_log`表，不会影响下次计算。

### Q: 如何查看计算性能？
**A**: 访问`/actuator/prometheus`查看metrics，或查询`indicator_calc_log`表。

### Q: 指标模块支持哪些周期？
**A**: 只支持5个聚合周期：5m、15m、30m、1h、4h。不支持1m，因为数据量太大，不适合指标计算。

### Q: K线数据会无限增长吗？
**A**: 不会。系统自动维护每个周期的最新365根K线，新K线追加时自动去除最旧的。

### Q: 为什么K线数据不按用户区分？
**A**: K线数据是市场数据，对所有用户相同。这样可以节省内存、提高效率、简化维护。

---

## 📚 深入学习

看完快速入门后，建议阅读：
- [指标模块架构说明.md](./指标模块架构说明.md) - 详细的架构和流程说明

---

**提示**：如果想深入了解某个组件，直接查看对应源码，代码注释很详细！

