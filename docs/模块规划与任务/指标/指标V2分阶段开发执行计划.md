# æŒ‡æ ‡æ¨¡å— V2 åˆ†é˜¶æ®µå¼€å‘æ‰§è¡Œè®¡åˆ’

> **ç‰ˆæœ¬**ï¼šV2.0  
> **åˆ›å»ºæ—¥æœŸ**ï¼š2024-01  
> **ç»´æŠ¤è€…**ï¼šqyl  
> **åŸºäºæ–‡æ¡£**ï¼š
> - [æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md](./æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md)
> - [æŒ‡æ ‡V2ç‰ˆæœ¬å¼€å‘ä»»åŠ¡è¯¦ç»†æ¸…å•.md](./æŒ‡æ ‡V2ç‰ˆæœ¬å¼€å‘ä»»åŠ¡è¯¦ç»†æ¸…å•.md)
> - [æŒ‡æ ‡v2åˆ†é˜¶æ®µåˆ’åˆ†ä»»åŠ¡.md](./æŒ‡æ ‡v2åˆ†é˜¶æ®µåˆ’åˆ†ä»»åŠ¡.md)

---

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

1. **æŒ‰é˜¶æ®µæ‰§è¡Œ**ï¼šæ¯ä¸ªé˜¶æ®µç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éªŒæ”¶
2. **é˜¶æ®µéªŒæ”¶**ï¼šå¿…é¡»æ‰€æœ‰éªŒæ”¶æ ‡å‡†é€šè¿‡ï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
3. **ç¦æ­¢äº‹é¡¹**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½å¿…é¡»éµå®ˆç»å¯¹ç¦æ­¢äº‹é¡¹
4. **éªŒæ”¶ç¡®è®¤**ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œéœ€è¦æ˜ç¡®ç¡®è®¤"åŒæ„"æ‰èƒ½å¼€å¯ä¸‹ä¸€é˜¶æ®µ

---

## ğŸ”´ ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼ˆæ‰€æœ‰é˜¶æ®µå¿…é¡»éµå®ˆï¼‰

> **è¿åä»¥ä¸‹ä»»ä½•ä¸€æ¡ï¼Œç«‹å³è¿”å·¥ï¼Œä¸å…è®¸è¿›å…¥ä¸‹ä¸€é˜¶æ®µ**

- âŒ **ä¸å…è®¸åœ¨ `BarClosedEvent` ä¸­è®¡ç®—æŒ‡æ ‡**
- âŒ **ä¸å…è®¸æ–°å¢æŒ‡æ ‡ç»“æœè¡¨**ï¼ˆ`indicator_value`ã€`indicator_subscription`ã€`indicator_calc_log` ä¸å†ä½¿ç”¨ï¼‰
- âŒ **ä¸å…è®¸æ ¹æ®è®¢é˜…è‡ªåŠ¨è®¡ç®—æŒ‡æ ‡**
- âŒ **ä¸å…è®¸åœ¨æŒ‡æ ‡å±‚è¾“å‡ºäº¤æ˜“è¯­ä¹‰**ï¼ˆå¤š/ç©º/æ‰“åˆ†/æƒé‡ç­‰ï¼‰
- âŒ **ä¸å…è®¸æŠŠç¼“å­˜ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„ä¾èµ–**ï¼ˆFeatureCache åªèƒ½ä½œä¸ºæ€§èƒ½ä¼˜åŒ–ï¼‰

---

## ğŸ¯ ç³»ç»Ÿä¸€å¥è¯å®šä¹‰ï¼ˆå¿…é¡»ç†è§£ï¼‰

> **æŒ‡æ ‡æ¨¡å—æ˜¯"æŒ‡æ ‡å®šä¹‰æ³¨å†Œä¸­å¿ƒ + è¿è¡Œæ—¶è¯„ä¼°å™¨"ï¼Œä¸æ˜¯æŒ‡æ ‡äº‹å®è®¡ç®—ç³»ç»Ÿã€‚**

**æ ¸å¿ƒåŸåˆ™**ï¼š
- K çº¿åªç®¡è¾“å…¥ï¼ˆBarSeriesï¼‰
- æŒ‡æ ‡åªç®¡è®¡ç®—ï¼ˆæŒ‰éœ€è¯„ä¼°ï¼‰
- ç­–ç•¥åªç®¡å†³ç­–ï¼ˆç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“ï¼‰

---

# é˜¶æ®µä¸€ï¼šè¾“å…¥äº‹å®å±‚å†»ç»“ï¼ˆé‡Œç¨‹ç¢‘ M1ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**å½»åº•æ–­å¼€"è®¢é˜… â†’ è‡ªåŠ¨ç®—æŒ‡æ ‡"é“¾è·¯ï¼Œä»…ä¿ç•™ K çº¿è¾“å…¥äº‹å®ç»´æŠ¤**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 1.1ï¼šä¿®æ”¹ BarSeriesManagerï¼ˆæ–­å¼€è®¡ç®—è§¦å‘ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/series/BarSeriesManager.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **ä¿ç•™**ï¼š`bootstrap()` æ–¹æ³•ï¼ˆå¯åŠ¨æ—¶ä»è¡Œæƒ…è®¢é˜…é…ç½®è·å–äº¤æ˜“å¯¹ï¼Œä¸ºæ¯ä¸ªäº¤æ˜“å¯¹çš„5ä¸ªå‘¨æœŸåŠ è½½å†å²æ•°æ®ï¼‰
2. âœ… **ä¿ç•™**ï¼š`onBarClosed()` æ–¹æ³•ï¼ˆè¿½åŠ æ–°baråˆ°Seriesï¼Œå»é‡ï¼Œç»´æŠ¤365æ ¹çª—å£ï¼‰
3. âœ… **ä¿ç•™**ï¼š`getSeries()` æ–¹æ³•ï¼ˆè·å–åªè¯»è§†å›¾ï¼‰
4. âŒ **åˆ é™¤**ï¼šç§»é™¤æ‰€æœ‰ä¸ `IndicatorCalculator` çš„è€¦åˆä»£ç 
5. ğŸ”§ **éªŒè¯**ï¼šç¡®è®¤ `onBarClosed()` ä¸å†è§¦å‘ä»»ä½•æŒ‡æ ‡è®¡ç®—æµç¨‹

**ä»£ç å˜æ›´ç¤ºä¾‹**ï¼š
```java
// ç¡®ä¿ onBarClosed() åªåšï¼š
public void onBarClosed(BarClosedEvent event) {
    // 1. è·å–æˆ–åˆ›å»º BarSeries
    String key = event.tradingPairId() + ":" + event.timeframe();
    BarSeriesImpl series = seriesMap.computeIfAbsent(key, k -> new BarSeriesImpl());
    
    // 2. è¿½åŠ  Barï¼ˆå»é‡ï¼‰
    series.appendBar(event.bar(), event.barCloseTime());
    
    // 3. ç»´æŠ¤çª—å£ï¼ˆä¿æŒæœ€æ–°365æ ¹ï¼‰
    series.trimToSize(365);
    
    // âŒ ç¦æ­¢ï¼šä¸å†æœ‰ä»»ä½•è®¡ç®—ç›¸å…³çš„è°ƒç”¨
    // âŒ ç¦æ­¢ï¼šä¸å†è§¦å‘ IndicatorCalculator
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] BarSeriesManager åœ¨ 5m/15m/30m/1h/4h å‘¨æœŸç»§ç»­ç»´æŠ¤ 365 æ ¹çª—å£
- [ ] `onBarClosed()` æ–¹æ³•ä¸­æ²¡æœ‰ä»»ä½•è®¡ç®—ç›¸å…³çš„ä»£ç 
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ï¼š`BarSeriesManagerTest`
- [ ] é›†æˆæµ‹è¯•ï¼šBarClosedEvent åˆ°è¾¾åï¼Œåªæ›´æ–° Seriesï¼Œä¸è®¡ç®—æŒ‡æ ‡
- [ ] CPU ä½¿ç”¨ç‡ä¸éšæŒ‡æ ‡æ•°é‡å˜åŒ–ï¼ˆéªŒè¯æ— è‡ªåŠ¨è®¡ç®—ï¼‰

---

### ä»»åŠ¡ 1.2ï¼šå…³é—­ IndicatorCalculatorï¼ˆFeature Flagï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/calculator/IndicatorCalculator.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼šæ·»åŠ  Feature Flag é…ç½®é¡¹
2. ğŸ”§ **ä¿®æ”¹**ï¼š`onBarClosed()` æ–¹æ³•å¢åŠ å¼€å…³åˆ¤æ–­ï¼Œé»˜è®¤å…³é—­
3. âœ… **ä¿ç•™**ï¼šä»£ç ä¿ç•™ä½œä¸ºå‚è€ƒï¼Œä½†ä¸æ‰§è¡Œï¼ˆæ ‡è®°ä¸º `@Deprecated`ï¼‰

**ä»£ç å˜æ›´ç¤ºä¾‹**ï¼š
```java
@Deprecated
@Component
public class IndicatorCalculator {
    
    @Value("${indicator.auto-calculate.enabled:false}")
    private boolean autoCalculateEnabled;
    
    @EventListener
    @Async("indicatorCalculatorExecutor")
    public void onBarClosed(BarClosedEvent event) {
        // V2: é»˜è®¤å…³é—­è‡ªåŠ¨è®¡ç®—
        if (!autoCalculateEnabled) {
            log.debug("è‡ªåŠ¨è®¡ç®—å·²å…³é—­ï¼ˆV2ï¼‰ï¼Œè·³è¿‡æŒ‡æ ‡è®¡ç®—: pairId={}, timeframe={}", 
                    event.tradingPairId(), event.timeframe());
            return;  // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä»»ä½•è®¡ç®—
        }
        
        // åŸæœ‰é€»è¾‘ä¿ç•™ï¼ˆä½†é»˜è®¤ä¸æ‰§è¡Œï¼Œä»…ç”¨äºå‘åå…¼å®¹ï¼‰
        // ... åŸæœ‰ä»£ç  ...
    }
}
```

**é…ç½®æ–‡ä»¶å˜æ›´**ï¼š`src/main/resources/application.yml`
```yaml
indicator:
  auto-calculate:
    enabled: false  # V2: é»˜è®¤å…³é—­ï¼Œç¦æ­¢è‡ªåŠ¨è®¡ç®—
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é…ç½®é¡¹ `indicator.auto-calculate.enabled=false` æ—¶ï¼Œ`onBarClosed()` ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œè®¡ç®—
- [ ] æ—¥å¿—æ˜ç¡®è®°å½•"è‡ªåŠ¨è®¡ç®—å·²å…³é—­ï¼ˆV2ï¼‰"
- [ ] è®¾ç½®ä¸º `true` æ—¶ä»èƒ½æ‰§è¡Œï¼ˆå‘åå…¼å®¹æµ‹è¯•ï¼Œä½†V2ä¸å…è®¸å¯ç”¨ï¼‰
- [ ] ä»£ç å·²æ ‡è®° `@Deprecated`ï¼Œæœ‰æ˜ç¡®çš„åºŸå¼ƒè¯´æ˜

---

### ä»»åŠ¡ 1.3ï¼šéªŒè¯ bar_time è¯­ä¹‰ç»Ÿä¸€

**ç›®æ ‡**ï¼šç¡®ä¿æ‰€æœ‰æ—¶é—´ç›¸å…³çš„ä»£ç éƒ½ä½¿ç”¨ `bar_close_time` UTC è¯­ä¹‰

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ” **æ£€æŸ¥**ï¼š`NormalizedBar.getBarTime()` è¿”å›çš„æ˜¯æ”¶ç›˜æ—¶é—´
2. ğŸ” **æ£€æŸ¥**ï¼š`BarSeriesManager` çš„æ—¶é—´å¤„ç†é€»è¾‘
3. ğŸ” **æ£€æŸ¥**ï¼š`QuestDbTsSemanticsProbe` çš„æ£€æµ‹é€»è¾‘
4. ğŸ“ **æ–‡æ¡£**ï¼šåœ¨ä»£ç æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜æ—¶é—´è¯­ä¹‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ‰€æœ‰æ—¶é—´ç›¸å…³çš„ä»£ç æ³¨é‡Šæ˜ç¡®è¯´æ˜ä½¿ç”¨ `bar_close_time` UTC
- [ ] `NormalizedBar.getBarTime()` è¿”å›çš„æ˜¯æ”¶ç›˜æ—¶é—´
- [ ] æ—¶é—´è¯­ä¹‰ç»Ÿä¸€ï¼Œæ— æ··ä¹±

---

## âœ… é˜¶æ®µä¸€éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] BarClosedEvent åˆ°è¾¾å **ä¸è§¦å‘ä»»ä½•æŒ‡æ ‡è®¡ç®—**
- [ ] 5m / 15m / 30m / 1h / 4h å‘¨æœŸ BarSeries æ­£å¸¸æ¨è¿›ï¼ˆ365æ ¹çª—å£ï¼‰
- [ ] CPU ä½¿ç”¨ç‡ä¸éšæŒ‡æ ‡æ•°é‡å˜åŒ–ï¼ˆéªŒè¯æ— è‡ªåŠ¨è®¡ç®—ï¼‰
- [ ] è‡ªåŠ¨è®¡ç®—é€»è¾‘é»˜è®¤å…³é—­ä¸”å¯å›æ»šï¼ˆFeature Flag ç”Ÿæ•ˆï¼‰
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ“¦ é˜¶æ®µä¸€äº§å‡ºç‰©

- âœ… å¯è¿è¡Œç³»ç»Ÿï¼ˆæ— æŒ‡æ ‡è®¡ç®—ï¼Œåªç»´æŠ¤Kçº¿è¾“å…¥ï¼‰
- âœ… è¾“å…¥äº‹å®å±‚ç¨³å®šï¼ˆBarSeriesManager æ­£å¸¸å·¥ä½œï¼‰
- âœ… ä¸ºåç»­é˜¶æ®µæä¾› **å”¯ä¸€å¯ä¿¡è¾“å…¥**ï¼ˆKçº¿æ•°æ®ï¼‰

---

## ğŸš¦ é˜¶æ®µä¸€å®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„è¿›å…¥é˜¶æ®µäºŒ

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

# é˜¶æ®µäºŒï¼šæŒ‡æ ‡å®šä¹‰æ³¨å†Œå±‚ï¼ˆé‡Œç¨‹ç¢‘ M2ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**å»ºç«‹"æŒ‡æ ‡ = å®šä¹‰ + schema + å®ç°æ˜ å°„"çš„å”¯ä¸€äº‹å®æ¥æº**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 2.1ï¼šæ‰©å±• indicator_definition è¡¨ç»“æ„

**ç›®æ ‡**ï¼šæ”¯æŒ V2 éœ€è¦çš„å­—æ®µï¼ˆdata_sourceã€impl_keyã€param_limitsç­‰ï¼‰

**æ–¹æ¡ˆé€‰æ‹©**ï¼š**ä¼˜å…ˆä½¿ç”¨ JSON å­—æ®µæ‰©å±•ï¼Œé¿å… ALTER TABLE**

#### 2.1.1 æ•°æ®åº“è¡¨ç»“æ„æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/sql/indicator/001_create_indicator_definition.sql`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ“ **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šæ‰©å±•ç°æœ‰ JSON å­—æ®µ
   - `param_schema` JSONï¼šæ·»åŠ  `param_limits` å­å­—æ®µ
   - åœ¨ JSON ä¸­å­˜å‚¨ `data_source`ã€`impl_key`
   - æ— éœ€ ALTER TABLEï¼Œå‘åå…¼å®¹

2. ğŸ“ **æ–¹æ¡ˆ2ï¼ˆå¤‡é€‰ï¼‰**ï¼šå¦‚æœå¿…é¡»ä½¿ç”¨ç‹¬ç«‹å­—æ®µï¼Œåˆ™ ALTER TABLEï¼š
   ```sql
   ALTER TABLE indicator_definition
   ADD COLUMN data_source VARCHAR(32) DEFAULT 'BAR' COMMENT 'æ•°æ®æºï¼šBAR/TICK/SIGNAL/MIXED',
   ADD COLUMN impl_key VARCHAR(128) DEFAULT NULL COMMENT 'å®ç°æ˜ å°„é”®ï¼ˆå¦‚ ta4j:rsiï¼‰';
   ```

**å»ºè®® JSON ç»“æ„**ï¼š
```json
{
  "param_schema": {
    "period": {"type": "integer", "required": true, "default": 14, "min": 1, "max": 100},
    "param_limits": {"lookback_max": 365, "window_max": 1000}
  },
  "data_source": "BAR",
  "impl_key": "ta4j:rsi"
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] è¡¨ç»“æ„æ”¯æŒå­˜å‚¨ `data_source`ã€`impl_key`ã€`param_limits`
- [ ] ç°æœ‰æ•°æ®ä¸å—å½±å“ï¼ˆå‘åå…¼å®¹ï¼‰
- [ ] å¦‚æœä½¿ç”¨æ–¹æ¡ˆ2ï¼Œè¿ç§»è„šæœ¬å·²å‡†å¤‡

---

#### 2.1.2 å®ä½“ç±»æ‰©å±•

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/entity/IndicatorDefinition.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–¹æ¡ˆ1**ï¼šæ‰©å±•ç°æœ‰ JSON å­—æ®µçš„ getter/setter
2. ğŸ”§ **æ–¹æ¡ˆ2**ï¼šå¦‚æœä½¿ç”¨ç‹¬ç«‹å­—æ®µï¼Œæ–°å¢å±æ€§

**ä»£ç ç¤ºä¾‹**ï¼ˆä½¿ç”¨ JSON æ‰©å±•ï¼‰ï¼š
```java
@Data
@TableName(value = "indicator_definition", autoResultMap = true)
public class IndicatorDefinition {
    
    // ç°æœ‰å­—æ®µ...
    
    @TableField(typeHandler = JacksonTypeHandler.class)
    private Map<String, Object> paramSchema;
    
    // ä» param_schema JSON ä¸­æå–å­—æ®µçš„ä¾¿æ·æ–¹æ³•
    public String getDataSource() {
        if (paramSchema == null) return "BAR";
        return (String) paramSchema.getOrDefault("data_source", "BAR");
    }
    
    public void setDataSource(String dataSource) {
        if (paramSchema == null) {
            paramSchema = new HashMap<>();
        }
        paramSchema.put("data_source", dataSource);
    }
    
    public String getImplKey() {
        if (paramSchema == null) return null;
        return (String) paramSchema.get("impl_key");
    }
    
    public void setImplKey(String implKey) {
        if (paramSchema == null) {
            paramSchema = new HashMap<>();
        }
        paramSchema.put("impl_key", implKey);
    }
    
    public Map<String, Object> getParamLimits() {
        if (paramSchema == null) return null;
        Map<String, Object> schema = (Map<String, Object>) paramSchema.get("param_schema");
        if (schema == null) return null;
        return (Map<String, Object>) schema.get("param_limits");
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å®ä½“ç±»æ”¯æŒè¯»å–å’Œå†™å…¥æ–°å­—æ®µ
- [ ] MyBatis æ˜ å°„æ­£ç¡®ï¼ˆå¦‚æœä½¿ç”¨ç‹¬ç«‹å­—æ®µï¼‰
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡

---

### ä»»åŠ¡ 2.2ï¼šåˆ›å»º IndicatorParamValidatorï¼ˆå‚æ•°æ ¡éªŒæœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/validation/IndicatorParamValidator.java`ï¼ˆæ–°å»ºï¼‰

**ğŸ”´ èŒè´£è¾¹ç•Œ**ï¼š
- IndicatorParamValidator æ˜¯ç‹¬ç«‹çš„æ ¡éªŒç»„ä»¶ï¼Œåªè´Ÿè´£å‚æ•°æ ¡éªŒ
- å¿…é¡»ä» IndicatorEvaluateService ä¸­æ‹†åˆ†å‡ºæ¥ï¼Œä¸å…è®¸åˆå¹¶
- åªæ ¡éªŒå‚æ•°æ ¼å¼ã€ç±»å‹ã€èŒƒå›´ï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼šå‚æ•°æ ¡éªŒæœåŠ¡ç±»ï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰
2. ğŸ”§ **å®ç°**ï¼šåŸºäº `param_schema` çš„æ ¡éªŒé€»è¾‘
3. ğŸ”§ **å®ç°**ï¼šåŸºäº `param_limits` çš„é™åˆ¶æ£€æŸ¥

**æ¥å£å®šä¹‰**ï¼š
```java
public interface IndicatorParamValidator {
    /**
     * æ ¡éªŒå‚æ•°
     * @param indicatorCode æŒ‡æ ‡ç¼–ç 
     * @param version ç‰ˆæœ¬
     * @param params å‚æ•°
     * @throws ValidationException æ ¡éªŒå¤±è´¥æ—¶æŠ›å‡ºï¼ŒåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯
     */
    void validate(String indicatorCode, String version, Map<String, Object> params);
}
```

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ ¡éªŒå¿…å¡«å‚æ•°ï¼ˆrequired=trueï¼‰
- æ ¡éªŒå‚æ•°ç±»å‹ï¼ˆintegerã€decimalã€stringã€booleanï¼‰
- æ ¡éªŒå‚æ•°èŒƒå›´ï¼ˆminã€maxï¼‰
- æ ¡éªŒæšä¸¾å€¼ï¼ˆenumï¼‰
- æ ¡éªŒ lookback ä¸Šé™ã€çª—å£ä¸Šé™ç­‰é™åˆ¶ï¼ˆparam_limitsï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Component
public class IndicatorParamValidatorImpl implements IndicatorParamValidator {
    
    @Autowired
    private IndicatorDefinitionRepository definitionRepository;
    
    @Override
    public void validate(String indicatorCode, String version, Map<String, Object> params) {
        // 1. è·å–æŒ‡æ ‡å®šä¹‰
        IndicatorDefinition definition = definitionRepository.findByCodeAndVersion(
                indicatorCode, version)
                .orElseThrow(() -> new ValidationException("æŒ‡æ ‡å®šä¹‰ä¸å­˜åœ¨"));
        
        // 2. è·å– param_schema
        Map<String, Object> paramSchema = definition.getParamSchema();
        if (paramSchema == null) {
            return;  // æ— å‚æ•°è¦æ±‚
        }
        
        // 3. æ ¡éªŒæ¯ä¸ªå‚æ•°
        for (Map.Entry<String, Object> entry : paramSchema.entrySet()) {
            String paramName = entry.getKey();
            Map<String, Object> spec = (Map<String, Object>) entry.getValue();
            
            // 3.1 æ ¡éªŒå¿…å¡«
            if (Boolean.TRUE.equals(spec.get("required")) && !params.containsKey(paramName)) {
                throw new ValidationException("å‚æ•°ç¼ºå¤±: " + paramName);
            }
            
            // 3.2 æ ¡éªŒç±»å‹
            if (params.containsKey(paramName)) {
                validateType(paramName, params.get(paramName), spec);
                validateRange(paramName, params.get(paramName), spec);
                validateEnum(paramName, params.get(paramName), spec);
            }
        }
        
        // 4. æ ¡éªŒ param_limitsï¼ˆlookbackã€windowç­‰ï¼‰
        validateParamLimits(definition, params);
    }
    
    private void validateType(String paramName, Object value, Map<String, Object> spec) {
        String expectedType = (String) spec.get("type");
        // ç±»å‹æ ¡éªŒé€»è¾‘...
    }
    
    private void validateRange(String paramName, Object value, Map<String, Object> spec) {
        // èŒƒå›´æ ¡éªŒé€»è¾‘ï¼ˆminã€maxï¼‰...
    }
    
    private void validateEnum(String paramName, Object value, Map<String, Object> spec) {
        // æšä¸¾å€¼æ ¡éªŒé€»è¾‘...
    }
    
    private void validateParamLimits(IndicatorDefinition definition, Map<String, Object> params) {
        Map<String, Object> paramLimits = definition.getParamLimits();
        if (paramLimits == null) return;
        
        // æ ¡éªŒ lookback_maxã€window_max ç­‰é™åˆ¶
        // ...
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å‰ç«¯èƒ½ä»…é  definition çš„ `param_schema` æ‹‰èµ·è¡¨å•
- [ ] åç«¯èƒ½æŒ‰ schema æ ¡éªŒ paramsï¼ˆå¿…å¡«ã€ç±»å‹ã€èŒƒå›´ã€æšä¸¾ï¼‰
- [ ] å‚æ•°è¶Šç•Œæ—¶è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¡éªŒåœºæ™¯ï¼ˆå¿…å¡«ç¼ºå¤±ã€ç±»å‹é”™è¯¯ã€èŒƒå›´è¶Šç•Œã€æšä¸¾é”™è¯¯ã€limitsè¶…é™ï¼‰

---

### ä»»åŠ¡ 2.3ï¼šæ‰©å±• IndicatorDefinitionControllerï¼ˆæ”¯æŒç¼–è¾‘ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/api/IndicatorDefinitionController.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ‰©å±•**ï¼šæ”¯æŒæ–°å­—æ®µçš„ CRUDï¼ˆdata_sourceã€impl_keyã€param_schemaã€return_schemaï¼‰
2. ğŸ”§ **æ–°å¢**ï¼šå‚æ•°æ ¡éªŒæ¥å£ï¼ˆç”¨äºå‰ç«¯è¡¨å•æ ¡éªŒï¼‰
3. ğŸ”§ **ä¿®æ”¹**ï¼šä»"åªè¯»"å‡çº§ä¸º"å¯ç¼–è¾‘"ï¼ˆV1 UI æ˜¯åªè¯»ï¼‰

**æ¥å£æ‰©å±•**ï¼š
```java
@RestController
@RequestMapping("/api/indicator/definitions")
public class IndicatorDefinitionController {
    
    // åŸæœ‰æ¥å£ä¿æŒä¸å˜ï¼Œæ–°å¢ï¼š
    
    /**
     * åˆ›å»ºæŒ‡æ ‡å®šä¹‰
     * POST /api/indicator/definitions
     */
    @PostMapping
    public Result<IndicatorDefinitionDTO> create(@RequestBody @Valid IndicatorDefinitionCreateRequest request) {
        // åˆ›å»ºé€»è¾‘...
    }
    
    /**
     * æ›´æ–°æŒ‡æ ‡å®šä¹‰
     * PUT /api/indicator/definitions/{id}
     */
    @PutMapping("/{id}")
    public Result<IndicatorDefinitionDTO> update(
            @PathVariable Long id,
            @RequestBody @Valid IndicatorDefinitionUpdateRequest request) {
        // æ›´æ–°é€»è¾‘...
    }
    
    /**
     * å‚æ•°æ ¡éªŒæ¥å£
     * POST /api/indicator/definitions/{id}/validate-params
     */
    @PostMapping("/{id}/validate-params")
    public Result<ValidationResult> validateParams(
            @PathVariable Long id,
            @RequestBody Map<String, Object> params) {
        // è°ƒç”¨ IndicatorParamValidator è¿›è¡Œæ ¡éªŒ
        // è¿”å›æ ¡éªŒç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼‰
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ”¯æŒåˆ›å»º/ç¼–è¾‘æŒ‡æ ‡å®šä¹‰ï¼ˆåŒ…æ‹¬æ–°å­—æ®µ data_sourceã€impl_keyã€param_schemaã€return_schemaï¼‰
- [ ] å‚æ•°æ ¡éªŒæ¥å£å¯ç”¨ï¼ˆå‰ç«¯å¯ä»¥è°ƒç”¨è¿›è¡Œå®æ—¶æ ¡éªŒï¼‰
- [ ] å‰ç«¯å¯ä»¥è°ƒç”¨æ ¡éªŒæ¥å£è¿›è¡Œå®æ—¶æ ¡éªŒ

---

### ä»»åŠ¡ 2.4ï¼šæ‰©å±• IndicatorDefinitionRepository

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorDefinitionRepository.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼šæŒ‰ `data_source` æŸ¥è¯¢çš„æ–¹æ³•
2. ğŸ”§ **æ–°å¢**ï¼šæŒ‰ `impl_key` æŸ¥è¯¢çš„æ–¹æ³•
3. ğŸ”§ **æ–°å¢**ï¼šæ”¯æŒæ–°å­—æ®µçš„æŸ¥è¯¢å’Œæ›´æ–°

**ä»£ç ç¤ºä¾‹**ï¼š
```java
public interface IndicatorDefinitionRepository {
    
    // ç°æœ‰æ–¹æ³•...
    
    // æ–°å¢æ–¹æ³•
    List<IndicatorDefinition> findByDataSource(String dataSource);
    
    Optional<IndicatorDefinition> findByImplKey(String implKey);
    
    Optional<IndicatorDefinition> findByCodeAndVersion(String code, String version);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ–°å¢æŸ¥è¯¢æ–¹æ³•å¯ç”¨
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–

---

## âœ… é˜¶æ®µäºŒéªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] åªä¾èµ– `indicator_definition` å°±èƒ½æè¿°ä¸€ä¸ªå®Œæ•´æŒ‡æ ‡ï¼ˆåŒ…å« data_sourceã€impl_keyã€param_schemaã€return_schemaï¼‰
- [ ] å‰ç«¯å¯æ ¹æ® `param_schema` è‡ªåŠ¨ç”Ÿæˆè¡¨å•
- [ ] åç«¯å¯æ ¹æ® schema æ ¡éªŒå‚æ•°ï¼ˆå¿…å¡«ã€ç±»å‹ã€èŒƒå›´ã€æšä¸¾ã€limitsï¼‰
- [ ] ä¸æ–°å¢ä»»ä½•æŒ‡æ ‡ç›¸å…³ä¸šåŠ¡è¡¨ï¼ˆåªä½¿ç”¨ indicator_definitionï¼‰
- [ ] æŒ‡æ ‡å®šä¹‰æ”¯æŒ CRUDï¼ˆå¯åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ“¦ é˜¶æ®µäºŒäº§å‡ºç‰©

- âœ… æŒ‡æ ‡å®šä¹‰æ³¨å†Œä¸­å¿ƒï¼ˆindicator_definition å•è¡¨ï¼‰
- âœ… schema æˆä¸ºå‰åç«¯å¥‘çº¦ï¼ˆparam_schemaã€return_schemaï¼‰
- âœ… å‚æ•°æ ¡éªŒæœåŠ¡ï¼ˆIndicatorParamValidatorï¼‰

---

## ğŸš¦ é˜¶æ®µäºŒå®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„è¿›å…¥é˜¶æ®µä¸‰

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

# é˜¶æ®µä¸‰ï¼šè¿è¡Œæ—¶è¯„ä¼°æ ¸å¿ƒï¼ˆé‡Œç¨‹ç¢‘ M3ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**æä¾›ç»Ÿä¸€ evaluate / evaluateBatch èƒ½åŠ›ï¼ˆæ— ç¼“å­˜ä¹Ÿèƒ½è·‘ï¼‰**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 3.1ï¼šåˆ›å»º IndicatorEvaluateServiceï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/runtime/IndicatorEvaluateService.java`ï¼ˆæ–°å»ºï¼‰

**ğŸ”´ èŒè´£è¾¹ç•Œï¼ˆå¿…é¡»éµå®ˆï¼‰**ï¼š
- IndicatorEvaluateService æ˜¯"çº¯è¿è¡Œæ—¶è¯„ä¼°æœåŠ¡"ï¼Œåªè´Ÿè´£åè°ƒè°ƒç”¨
- å…·ä½“é€»è¾‘å¿…é¡»æ‹†åˆ†åˆ°å­ç»„ä»¶ï¼š
  - `IndicatorParamValidator`ï¼šå‚æ•°æ ¡éªŒ
  - `IndicatorEngineRouter`ï¼šå¼•æ“è·¯ç”±
  - `IndicatorCacheManager`ï¼šç¼“å­˜ç®¡ç†ï¼ˆé˜¶æ®µä¸‰å¯å…ˆç©ºå®ç°ï¼‰
- **ä¸¥ç¦**ï¼šå°†ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ IndicatorEvaluateService ä¸­

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼š`IndicatorEvaluateService` æ¥å£å’Œå®ç°ç±»
2. ğŸ”§ **å®ç°**ï¼š`evaluate()` å•æ¬¡è¯„ä¼°æ–¹æ³•ï¼ˆåªåšåè°ƒï¼Œå…·ä½“é€»è¾‘è°ƒç”¨å­ç»„ä»¶ï¼‰
3. ğŸ”§ **å®ç°**ï¼š`evaluateBatch()` æ‰¹é‡è¯„ä¼°æ–¹æ³•ï¼ˆåªåšåè°ƒï¼Œå…·ä½“é€»è¾‘è°ƒç”¨å­ç»„ä»¶ï¼‰
4. ğŸ”§ **é›†æˆ**ï¼šä¾èµ–æ³¨å…¥ `IndicatorParamValidator`ã€`IndicatorEngineRouter`ã€`IndicatorCacheManager`ï¼ˆå¯å…ˆç©ºå®ç°ï¼‰
5. âœ… **éªŒè¯**ï¼šç¡®ä¿æ²¡æœ‰ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ Service ä¸­

**æ¥å£å®šä¹‰**ï¼š
```java
public interface IndicatorEvaluateService {
    /**
     * å•æ¬¡è¯„ä¼°
     * @param indicatorCode æŒ‡æ ‡ç¼–ç 
     * @param version ç‰ˆæœ¬
     * @param params å‚æ•°
     * @param context è¯„ä¼°ä¸Šä¸‹æ–‡ï¼ˆpairIdã€timeframeã€asOfBarTimeï¼‰
     * @return è¯„ä¼°ç»“æœ
     */
    IndicatorEvaluateResult evaluate(
        String indicatorCode,
        String version,
        Map<String, Object> params,
        EvaluationContext context
    );
    
    /**
     * æ‰¹é‡è¯„ä¼°
     * @param context è¯„ä¼°ä¸Šä¸‹æ–‡
     * @param requests è¯„ä¼°è¯·æ±‚åˆ—è¡¨
     * @return è¯„ä¼°ç»“æœåˆ—è¡¨ï¼ˆä¸ requests é¡ºåºä¸€è‡´ï¼‰
     */
    List<IndicatorEvaluateResult> evaluateBatch(
        EvaluationContext context,
        List<EvaluationRequest> requests
    );
}
```

**EvaluationContext å®šä¹‰**ï¼š
```java
public class EvaluationContext {
    private Long userId;
    private Long tradingPairId;
    private String timeframe;
    private LocalDateTime asOfBarTime;  // bar_close_time UTC
}
```

**EvaluationRequest å®šä¹‰**ï¼š
```java
public class EvaluationRequest {
    private String indicatorCode;
    private String version;
    private Map<String, Object> params;
}
```

**IndicatorEvaluateResult å®šä¹‰**ï¼š
```java
/**
 * æŒ‡æ ‡è¯„ä¼°ç»“æœ
 * 
 * ğŸ”´ è¾“å‡ºè¾¹ç•Œï¼šåªè¿”å›è®¡ç®—ç»“æœï¼Œä¸è¿”å›ç­–ç•¥è¯­ä¹‰
 * - å…è®¸ï¼švaluesã€validã€fingerprintã€sourceã€costMsã€errorMsg
 * - ç¦æ­¢ï¼štradeActionã€positionSideã€signalScoreã€entryFlagã€exitFlagã€weight ç­‰ç­–ç•¥è¯­ä¹‰
 */
public class IndicatorEvaluateResult {
    private boolean valid;  // æ˜¯å¦æœ‰æ•ˆï¼ˆåŸºäº min_required_barsï¼‰
    private String source;  // CACHE / COMPUTED
    private Map<String, BigDecimal> values;  // å•å€¼æˆ–å¤šå€¼ï¼ˆæŒ‡æ ‡è®¡ç®—å€¼ï¼‰
    private String fingerprint;  // è®¡ç®—æŒ‡çº¹ï¼ˆç”¨äºç­–ç•¥å½’æ¡£ï¼‰
    private Integer costMs;  // è€—æ—¶
    private String errorMsg;  // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
    
    // âŒ ç¦æ­¢æ·»åŠ ä»¥ä¸‹å­—æ®µï¼ˆç­–ç•¥è¯­ä¹‰ï¼‰ï¼š
    // private String tradeAction;      // ç¦æ­¢
    // private String positionSide;     // ç¦æ­¢
    // private BigDecimal signalScore;  // ç¦æ­¢
    // private Boolean entryFlag;       // ç¦æ­¢
    // private Boolean exitFlag;        // ç¦æ­¢
    // private BigDecimal weight;       // ç¦æ­¢
}
```

**å®ç°é€»è¾‘**ï¼ˆå¿…é¡»æ‹†åˆ†åˆ°å­ç»„ä»¶ï¼‰ï¼š
```java
@Override
public IndicatorEvaluateResult evaluate(String indicatorCode, String version,
                                        Map<String, Object> params,
                                        EvaluationContext context) {
    // 1. å‚æ•°æ ¡éªŒï¼ˆè°ƒç”¨ IndicatorParamValidatorï¼‰
    paramValidator.validate(indicatorCode, version, params);
    
    // 2. ç”Ÿæˆç¼“å­˜é”®ï¼ˆè°ƒç”¨ IndicatorCacheManagerï¼Œé˜¶æ®µä¸‰å¯å…ˆç©ºå®ç°ï¼‰
    String cacheKey = cacheManager.generateCacheKey(indicatorCode, version, 
                                                     context, params);
    
    // 3. æŸ¥è¯¢ç¼“å­˜ï¼ˆè°ƒç”¨ IndicatorCacheManagerï¼Œé˜¶æ®µä¸‰å¯å…ˆç©ºå®ç°ï¼‰
    Optional<IndicatorEvaluateResult> cached = cacheManager.get(cacheKey);
    if (cached.isPresent()) {
        return cached.get();
    }
    
    // 4. ç¼“å­˜æœªå‘½ä¸­ï¼šæ‰§è¡Œè®¡ç®—
    //    - è·å–æŒ‡æ ‡å®šä¹‰ï¼ˆRepositoryï¼‰
    IndicatorDefinition definition = definitionRepository.findByCodeAndVersion(
            indicatorCode, version)
            .orElseThrow(() -> new IllegalArgumentException("æŒ‡æ ‡å®šä¹‰ä¸å­˜åœ¨"));
    
    //    - è·å– BarSeriesï¼ˆBarSeriesManagerï¼‰
    BarSeriesView series = barSeriesManager.getSeries(
            context.getTradingPairId(), context.getTimeframe());
    
    //    - æ£€æŸ¥ min_required_bars
    if (series.getBarCount() < definition.getMinRequiredBars()) {
        return IndicatorEvaluateResult.invalid("Baræ•°é‡ä¸è¶³: " + series.getBarCount() 
                + " < " + definition.getMinRequiredBars());
    }
    
    //    - è·¯ç”±åˆ°å¯¹åº”å¼•æ“ï¼ˆè°ƒç”¨ IndicatorEngineRouterï¼‰
    IndicatorEngine engine = engineRouter.getEngine(definition);
    IndicatorComputeRequest request = buildRequest(definition, params, context);
    IndicatorResult result = engine.compute(request, series);
    
    //    - æ ¡éªŒè¿”å›ç»“æœï¼ˆreturn_schemaï¼‰
    validateReturnSchema(result, definition);
    
    //    - æ„å»º IndicatorEvaluateResult
    IndicatorEvaluateResult evaluateResult = buildResult(result, "COMPUTED");
    
    //    - å†™å…¥ç¼“å­˜ï¼ˆè°ƒç”¨ IndicatorCacheManagerï¼Œé˜¶æ®µä¸‰å¯å…ˆç©ºå®ç°ï¼‰
    cacheManager.put(cacheKey, evaluateResult);
    
    // 5. è¿”å›ç»“æœ
    return evaluateResult;
}
```

**âš ï¸ å…³é”®åŸåˆ™**ï¼š
- Service åªåšåè°ƒè°ƒç”¨ï¼Œä¸åŒ…å«å…·ä½“ä¸šåŠ¡é€»è¾‘
- æ‰€æœ‰å…·ä½“é€»è¾‘éƒ½åœ¨å­ç»„ä»¶ä¸­å®ç°
- ä¸¥ç¦åœ¨ Service ä¸­ç›´æ¥å†™æ ¡éªŒã€è·¯ç”±ã€ç¼“å­˜é€»è¾‘
- é˜¶æ®µä¸‰ï¼šç¼“å­˜å¯ä»¥å…ˆç©ºå®ç°ï¼ˆè¿”å› Optional.empty()ï¼‰ï¼Œé˜¶æ®µå››å†å®Œå–„

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ”¯æŒ ta4j/custom å¼•æ“ï¼ˆæ²¿ç”¨ç°æœ‰ engine æ¦‚å¿µï¼‰
- [ ] èƒ½æ ¹æ® `min_required_bars` åˆ¤å®š valid/invalid
- [ ] è¿”å›ç»“æ„æ”¯æŒå•å€¼/å¤šå€¼ï¼ˆå¯¹é½ value/extra_values çš„è¯­ä¹‰ï¼‰
- [ ] **èŒè´£è¾¹ç•ŒéªŒè¯**ï¼šService åªåšåè°ƒï¼Œå…·ä½“é€»è¾‘åœ¨å­ç»„ä»¶
- [ ] **è¾“å‡ºè¾¹ç•ŒéªŒè¯**ï¼šä¸åŒ…å«ä»»ä½•ç­–ç•¥è¯­ä¹‰å­—æ®µ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰åœºæ™¯
- [ ] é›†æˆæµ‹è¯•ï¼ševaluate èƒ½æ­£ç¡®è®¡ç®—æŒ‡æ ‡ï¼ˆæ— ç¼“å­˜ä¹Ÿèƒ½è·‘ï¼‰

---

### ä»»åŠ¡ 3.2ï¼šæ‰©å±• IndicatorEngineRouterï¼ˆæ”¯æŒ impl_keyï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/runtime/IndicatorEngineRouter.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ‰©å±•**ï¼šæ”¯æŒé€šè¿‡ `impl_key` è·¯ç”±åˆ°å¯¹åº”å¼•æ“
2. ğŸ”§ **ä¿ç•™**ï¼šç°æœ‰çš„é€šè¿‡ `engine` å­—æ®µè·¯ç”±çš„é€»è¾‘ï¼ˆå‘åå…¼å®¹ï¼‰
3. ğŸ”§ **æ–°å¢**ï¼š`impl_key` åˆ°å¼•æ“çš„æ˜ å°„è¡¨

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Component
public class IndicatorEngineRouter {
    
    private final Map<String, IndicatorEngine> engineMap = new HashMap<>();
    private final Map<String, IndicatorEngine> implKeyMap = new HashMap<>();
    
    @Autowired
    public IndicatorEngineRouter(List<IndicatorEngine> engines) {
        // æ³¨å†Œå¼•æ“ï¼ˆæŒ‰ engine åç§°ï¼‰
        for (IndicatorEngine engine : engines) {
            engineMap.put(engine.getEngineName(), engine);
        }
        
        // æ³¨å†Œ impl_key æ˜ å°„ï¼ˆå¦‚ ta4j:rsi -> Ta4jIndicatorEngineï¼‰
        registerImplKeys();
    }
    
    public IndicatorEngine getEngine(IndicatorDefinition definition) {
        // ä¼˜å…ˆä½¿ç”¨ impl_key
        if (definition.getImplKey() != null) {
            IndicatorEngine engine = implKeyMap.get(definition.getImplKey());
            if (engine != null) {
                return engine;
            }
        }
        // å›é€€åˆ° engine å­—æ®µ
        return engineMap.get(definition.getEngine());
    }
    
    private void registerImplKeys() {
        // æ³¨å†Œ impl_key æ˜ å°„
        // ä¾‹å¦‚ï¼šta4j:rsi -> Ta4jIndicatorEngine
        // ä¾‹å¦‚ï¼šta4j:macd -> Ta4jIndicatorEngine
        // ...
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åŒä¸€ `indicator_code+version` èƒ½æ­£ç¡®è·¯ç”±åˆ° `impl_key` å¯¹åº”ç¡¬ä»£ç 
- [ ] å‘åå…¼å®¹ï¼šæ²¡æœ‰ `impl_key` æ—¶ä½¿ç”¨ `engine` å­—æ®µ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–è·¯ç”±é€»è¾‘

---

### ä»»åŠ¡ 3.3ï¼šå®ç° evaluateBatchï¼ˆæ‰¹é‡è¯„ä¼°ï¼‰

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **å®ç°**ï¼šæ‰¹é‡è¯„ä¼°çš„é€»è¾‘
2. ğŸ”§ **ä¼˜åŒ–**ï¼šæ‰¹é‡æŸ¥è¯¢ç¼“å­˜ï¼ˆå‡å°‘ç¼“å­˜æŸ¥è¯¢æ¬¡æ•°ï¼‰
3. ğŸ”§ **ä¼˜åŒ–**ï¼šæ‰¹é‡è®¡ç®—æ—¶å¤ç”¨ç›¸åŒçš„ BarSeries

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Override
public List<IndicatorEvaluateResult> evaluateBatch(
        EvaluationContext context,
        List<EvaluationRequest> requests) {
    // 1. æ‰¹é‡ç”Ÿæˆç¼“å­˜é”®
    List<String> cacheKeys = requests.stream()
            .map(req -> cacheManager.generateCacheKey(
                    req.getIndicatorCode(), req.getVersion(), context, req.getParams()))
            .collect(Collectors.toList());
    
    // 2. æ‰¹é‡æŸ¥è¯¢ç¼“å­˜
    Map<String, IndicatorEvaluateResult> cachedResults = new HashMap<>();
    for (int i = 0; i < cacheKeys.size(); i++) {
        Optional<IndicatorEvaluateResult> cached = cacheManager.get(cacheKeys.get(i));
        if (cached.isPresent()) {
            cachedResults.put(cacheKeys.get(i), cached.get());
        }
    }
    
    // 3. å¯¹äºç¼“å­˜æœªå‘½ä¸­çš„è¯·æ±‚ï¼Œæ‰¹é‡æ‰§è¡Œè®¡ç®—
    List<IndicatorEvaluateResult> results = new ArrayList<>();
    BarSeriesView series = barSeriesManager.getSeries(
            context.getTradingPairId(), context.getTimeframe());
    
    for (int i = 0; i < requests.size(); i++) {
        String cacheKey = cacheKeys.get(i);
        EvaluationRequest request = requests.get(i);
        
        // å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥ä½¿ç”¨
        if (cachedResults.containsKey(cacheKey)) {
            results.add(cachedResults.get(cacheKey));
            continue;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼šæ‰§è¡Œè®¡ç®—
        IndicatorEvaluateResult result = evaluate(
                request.getIndicatorCode(),
                request.getVersion(),
                request.getParams(),
                context);
        results.add(result);
    }
    
    // 4. è¿”å›ç»“æœåˆ—è¡¨ï¼ˆä¸ requests é¡ºåºä¸€è‡´ï¼‰
    return results;
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] evaluateBatch ä¸å•æ¬¡ evaluate ç»“æœä¸€è‡´
- [ ] æ‰¹é‡è¯„ä¼°é¡ºåºæ­£ç¡®ï¼ˆä¸ requests é¡ºåºä¸€è‡´ï¼‰
- [ ] æ‰¹é‡è¯„ä¼°æ€§èƒ½ä¼˜äºå¤šæ¬¡å•æ¬¡è¯„ä¼°ï¼ˆå¤ç”¨ BarSeriesï¼‰
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

## âœ… é˜¶æ®µä¸‰éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] evaluate èƒ½æ­£ç¡®è®¡ç®—æŒ‡æ ‡ï¼ˆæ— ç¼“å­˜ä¹Ÿèƒ½è·‘ï¼‰
- [ ] evaluateBatch ç»“æœä¸å•æ¬¡ä¸€è‡´
- [ ] Service åªåšåè°ƒï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆèŒè´£è¾¹ç•ŒéªŒè¯ï¼‰
- [ ] è¾“å‡ºä¸åŒ…å«ä»»ä½•ç­–ç•¥è¯­ä¹‰å­—æ®µï¼ˆè¾“å‡ºè¾¹ç•ŒéªŒè¯ï¼‰
- [ ] æ”¯æŒ impl_key è·¯ç”±åˆ°å¯¹åº”å¼•æ“
- [ ] å‘åå…¼å®¹ï¼šæ²¡æœ‰ impl_key æ—¶ä½¿ç”¨ engine å­—æ®µ
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ“¦ é˜¶æ®µä¸‰äº§å‡ºç‰©

- âœ… å¯è¢«ç­–ç•¥ç›´æ¥è°ƒç”¨çš„è¿è¡Œæ—¶è¯„ä¼°å¼•æ“ï¼ˆIndicatorEvaluateServiceï¼‰
- âœ… æŒ‡æ ‡æ’ä»¶ä½“ç³»è·‘é€šï¼ˆimpl_key è·¯ç”±ï¼‰
- âœ… æ‰¹é‡è¯„ä¼°èƒ½åŠ›ï¼ˆevaluateBatchï¼‰

---

## ğŸš¦ é˜¶æ®µä¸‰å®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„è¿›å…¥é˜¶æ®µå››

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

# é˜¶æ®µå››ï¼šè¿è¡Œæ—¶ç¼“å­˜èƒ½åŠ›ï¼ˆé‡Œç¨‹ç¢‘ M4ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**ä¿è¯"åŒå‚åŒä¸Šä¸‹æ–‡åªç®—ä¸€æ¬¡"**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 4.1ï¼šå®ç° IndicatorCacheManagerï¼ˆç¼“å­˜ç®¡ç†å™¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/cache/IndicatorCacheManager.java`ï¼ˆæ–°å»ºï¼‰

**ç›®æ ‡**ï¼šå®ç°ç¼“å­˜æœºåˆ¶ï¼Œä¿è¯æ•ˆç‡

#### 4.1.1 ç¼“å­˜é”®è§„èŒƒå®ç°

**ç¼“å­˜é”®æ ¼å¼**ï¼ˆå¿…é¡»å›ºå®šï¼‰ï¼š
```
indicatorCode + version + pairId + timeframe + asOfBarTime + hash(params)
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Component
public class IndicatorCacheManager {
    
    private final ObjectMapper objectMapper;
    
    public String generateCacheKey(String indicatorCode, String version,
                                   Long pairId, String timeframe,
                                   LocalDateTime asOfBarTime,
                                   Map<String, Object> params) {
        // 1. å¯¹ params è¿›è¡Œæ’åºå’Œåºåˆ—åŒ–
        String paramsJson = objectMapper.writeValueAsString(
            params.entrySet().stream()
                .sorted(Map.Entry.comparingByKey())
                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))
        );
        
        // 2. è®¡ç®— params çš„ hashï¼ˆSHA-256ï¼‰
        String paramsHash = DigestUtils.sha256Hex(paramsJson);
        
        // 3. æ‹¼æ¥ç¼“å­˜é”®
        return String.format("%s:%s:%d:%s:%s:%s",
            indicatorCode, version, pairId, timeframe,
            asOfBarTime.toString(), paramsHash);
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘å›ºå®šä¸”å”¯ä¸€
- [ ] ç›¸åŒå‚æ•°ç”Ÿæˆç›¸åŒç¼“å­˜é”®
- [ ] ä¸åŒå‚æ•°ç”Ÿæˆä¸åŒç¼“å­˜é”®
- [ ] å‚æ•°é¡ºåºä¸å½±å“ç¼“å­˜é”®ï¼ˆMap æ’åºï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–å„ç§å‚æ•°ç»„åˆ

---

#### 4.1.2 ç¼“å­˜å®ç°ï¼ˆCaffeineï¼‰

**æŠ€æœ¯é€‰å‹**ï¼š
- **æ–¹æ¡ˆ1**ï¼šCaffeineï¼ˆæœ¬åœ°ç¼“å­˜ï¼Œæ¨èï¼‰
- **æ–¹æ¡ˆ2**ï¼šRedisï¼ˆåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¦‚æœéœ€è¦å¤šå®ä¾‹ï¼‰

**é…ç½®æ–‡ä»¶**ï¼š`src/main/resources/application.yml`
```yaml
indicator:
  evaluate:
    cache:
      enabled: true
      ttl: 3600  # TTLï¼ˆç§’ï¼‰
      max-size: 10000  # æœ€å¤§å®¹é‡
      type: local  # local / redis
```

**ä»£ç å®ç°**ï¼ˆä½¿ç”¨ Caffeineï¼‰ï¼š
```java
@Component
@ConditionalOnProperty(name = "indicator.evaluate.cache.enabled", havingValue = "true")
public class IndicatorCacheManager {
    
    private final Cache<String, IndicatorEvaluateResult> cache;
    
    @Autowired
    public IndicatorCacheManager(
            @Value("${indicator.evaluate.cache.ttl:3600}") long ttl,
            @Value("${indicator.evaluate.cache.max-size:10000}") long maxSize) {
        this.cache = Caffeine.newBuilder()
            .expireAfterWrite(Duration.ofSeconds(ttl))
            .maximumSize(maxSize)
            .recordStats()  // è®°å½•ç»Ÿè®¡ä¿¡æ¯
            .build();
    }
    
    public Optional<IndicatorEvaluateResult> get(String cacheKey) {
        return Optional.ofNullable(cache.getIfPresent(cacheKey));
    }
    
    public void put(String cacheKey, IndicatorEvaluateResult result) {
        cache.put(cacheKey, result);
    }
    
    public CacheStats getStats() {
        return cache.stats();
    }
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ç›¸åŒ key å¤šæ¬¡è°ƒç”¨åªç®—ä¸€æ¬¡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- [ ] cache TTL/å®¹é‡å¯é…ç½®
- [ ] ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡å¯ç”¨
- [ ] å…³é—­ç¼“å­˜ä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼ˆå…³é”®éªŒæ”¶ç‚¹ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç¼“å­˜é€»è¾‘

---

#### 4.1.3 ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

**é›†æˆåˆ° Metrics**ï¼š
```java
// åœ¨ IndicatorEvaluateService ä¸­
if (cached != null) {
    metrics.recordCacheHit(indicatorCode);
    result.setSource("CACHE");
} else {
    metrics.recordCacheMiss(indicatorCode);
    result.setSource("COMPUTED");
    // æ‰§è¡Œè®¡ç®—...
    cacheManager.put(cacheKey, result);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] Metrics ä¸­èƒ½çœ‹åˆ°ç¼“å­˜å‘½ä¸­ç‡
- [ ] ç¼“å­˜å‘½ä¸­æ—¶è¿”å› `source=CACHE`
- [ ] ç¼“å­˜æœªå‘½ä¸­æ—¶è¿”å› `source=COMPUTED`

---

## âœ… é˜¶æ®µå››éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] ç¬¬ä¸€æ¬¡ evaluate â†’ COMPUTED
- [ ] ç¬¬äºŒæ¬¡ evaluateï¼ˆç›¸åŒå‚æ•°ï¼‰â†’ CACHE
- [ ] ç¼“å­˜å‘½ä¸­æ—¶è€—æ—¶ < 1ms
- [ ] **å…³é—­ç¼“å­˜ä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§**ï¼ˆå…³é”®éªŒæ”¶ç‚¹ï¼‰
- [ ] ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘å›ºå®šä¸”å”¯ä¸€
- [ ] ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡å¯ç”¨
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ“¦ é˜¶æ®µå››äº§å‡ºç‰©

- âœ… é«˜æ•ˆã€å¯æ§çš„è¿è¡Œæ—¶ç¼“å­˜å±‚ï¼ˆIndicatorCacheManagerï¼‰
- âœ… ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡ï¼ˆMetricsï¼‰

---

## ğŸš¦ é˜¶æ®µå››å®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„è¿›å…¥é˜¶æ®µäº”

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

# é˜¶æ®µäº”ï¼šAPI ä¸ç­–ç•¥æ¥å…¥ï¼ˆé‡Œç¨‹ç¢‘ M5ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**è®©æŒ‡æ ‡èƒ½åŠ›çœŸæ­£è¢«"ç­–ç•¥å¤§è„‘"ä½¿ç”¨**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 5.1ï¼šåˆ›å»º IndicatorEvaluateControllerï¼ˆè¯„ä¼°APIï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/api/IndicatorEvaluateController.java`ï¼ˆæ–°å»ºï¼‰

#### 5.1.1 å•æ¬¡è¯„ä¼°æ¥å£

**æ¥å£å®šä¹‰**ï¼š
```java
@RestController
@RequestMapping("/api/indicator/evaluate")
public class IndicatorEvaluateController {
    
    @Autowired
    private IndicatorEvaluateService evaluateService;
    
    /**
     * å•æ¬¡è¯„ä¼°
     * POST /api/indicator/evaluate
     */
    @PostMapping
    public Result<IndicatorEvaluateResultDTO> evaluate(
            @RequestBody @Valid EvaluateRequestDTO request) {
        // 1. æ„å»º EvaluationContext
        EvaluationContext context = new EvaluationContext(
                request.getUserId(),
                request.getTradingPairId(),
                request.getTimeframe(),
                request.getAsOfBarTime()
        );
        
        // 2. è°ƒç”¨ evaluateService.evaluate()
        IndicatorEvaluateResult result = evaluateService.evaluate(
                request.getIndicatorCode(),
                request.getIndicatorVersion(),
                request.getParams(),
                context
        );
        
        // 3. è½¬æ¢ä¸º DTO è¿”å›
        return Result.success(IndicatorEvaluateResultDTO.fromResult(result));
    }
}
```

**è¯·æ±‚ DTO**ï¼š
```java
public class EvaluateRequestDTO {
    @NotNull
    private Long userId;
    
    @NotNull
    private Long tradingPairId;
    
    @NotBlank
    private String timeframe;
    
    @NotNull
    private LocalDateTime asOfBarTime;  // bar_close_time UTC
    
    @NotBlank
    private String indicatorCode;
    
    @NotBlank
    private String indicatorVersion;
    
    private Map<String, Object> params;
}
```

**å“åº” DTO**ï¼š
```java
public class IndicatorEvaluateResultDTO {
    private boolean valid;
    private String source;  // CACHE / COMPUTED
    private Map<String, BigDecimal> values;
    private String fingerprint;
    private Integer costMs;
    private String errorMsg;
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ¥å£å¯ç”¨ï¼Œè¿”å›æ­£ç¡®çš„è¯„ä¼°ç»“æœ
- [ ] å‚æ•°æ ¡éªŒå®Œæ•´
- [ ] è¿”å›çš„ `source` å­—æ®µæ­£ç¡®ï¼ˆCACHE/COMPUTEDï¼‰
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

#### 5.1.2 æ‰¹é‡è¯„ä¼°æ¥å£

**æ¥å£å®šä¹‰**ï¼š
```java
/**
 * æ‰¹é‡è¯„ä¼°
 * POST /api/indicator/evaluate/batch
 */
@PostMapping("/batch")
public Result<List<IndicatorEvaluateResultDTO>> evaluateBatch(
        @RequestBody @Valid BatchEvaluateRequestDTO request) {
    // 1. æ„å»º EvaluationContext
    EvaluationContext context = new EvaluationContext(
            request.getUserId(),
            request.getTradingPairId(),
            request.getTimeframe(),
            request.getAsOfBarTime()
    );
    
    // 2. æ„å»º EvaluationRequest åˆ—è¡¨
    List<EvaluationRequest> requests = request.getRequests().stream()
            .map(item -> new EvaluationRequest(
                    item.getIndicatorCode(),
                    item.getIndicatorVersion(),
                    item.getParams()
            ))
            .collect(Collectors.toList());
    
    // 3. è°ƒç”¨ evaluateService.evaluateBatch()
    List<IndicatorEvaluateResult> results = evaluateService.evaluateBatch(context, requests);
    
    // 4. è½¬æ¢ä¸º DTO åˆ—è¡¨è¿”å›
    return Result.success(results.stream()
            .map(IndicatorEvaluateResultDTO::fromResult)
            .collect(Collectors.toList()));
}
```

**è¯·æ±‚ DTO**ï¼š
```java
public class BatchEvaluateRequestDTO {
    @NotNull
    private Long userId;
    
    @NotNull
    private Long tradingPairId;
    
    @NotBlank
    private String timeframe;
    
    @NotNull
    private LocalDateTime asOfBarTime;
    
    @NotEmpty
    private List<EvaluationRequestItemDTO> requests;  // è¯„ä¼°è¯·æ±‚åˆ—è¡¨
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ¥å£å¯ç”¨ï¼Œè¿”å›ä¸è¯·æ±‚é¡ºåºä¸€è‡´çš„ç»“æœåˆ—è¡¨
- [ ] æ‰¹é‡è¯„ä¼°æ€§èƒ½ä¼˜äºå¤šæ¬¡å•æ¬¡è¯„ä¼°
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡

---

### ä»»åŠ¡ 5.2ï¼šæ”¹é€  GET /api/indicator/latestï¼ˆå…¼å®¹æ€§ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/api/IndicatorController.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **ä¿ç•™**ï¼šæ¥å£è·¯å¾„å’Œå‚æ•°ä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰
2. ğŸ”§ **æ”¹é€ **ï¼šæŸ¥è¯¢é€»è¾‘æ”¹ä¸ºï¼š
   - å¦‚æœæœ‰å¯¹åº”çš„ `indicator_value` è®°å½•ï¼ˆç™½åå•æŒ‡æ ‡ï¼‰ï¼šä»æ•°æ®åº“æŸ¥
   - å¦åˆ™ï¼šè°ƒç”¨ `evaluateService.evaluate()` æŒ‰éœ€è®¡ç®—
3. ğŸ”§ **æ–°å¢**ï¼šå“åº”é‡Œå¢åŠ  `source` å­—æ®µï¼ˆCACHE/ON_DEMAND/DBï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@GetMapping("/latest")
public Result<IndicatorValueDTO> getLatest(
        @RequestParam("userId") Long userId,
        @RequestParam("pairId") Long pairId,
        @RequestParam("timeframe") String timeframe,
        @RequestParam("code") String code,
        @RequestParam(value = "version", required = false, defaultValue = "v1") String version) {
    
    // 1. å…ˆå°è¯•ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆç™½åå•æŒ‡æ ‡ï¼‰
    Optional<IndicatorValue> valueOpt = valueRepository.findLatest(userId, pairId, timeframe, code, version);
    if (valueOpt.isPresent()) {
        IndicatorValueDTO dto = IndicatorValueDTO.fromEntity(valueOpt.get());
        dto.setSource("DB");
        return Result.success(dto);
    }
    
    // 2. æŒ‰éœ€è®¡ç®—
    EvaluationContext context = new EvaluationContext(
            userId, pairId, timeframe, LocalDateTime.now());
    IndicatorEvaluateResult result = evaluateService.evaluate(code, version, null, context);
    
    if (!result.isValid()) {
        return Result.success(null);  // ä¸å­˜åœ¨æˆ–æ— æ•ˆ
    }
    
    IndicatorValueDTO dto = IndicatorValueDTO.fromResult(result);
    return Result.success(dto);
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] è€å‰ç«¯/è€ç­–ç•¥ä¸æ”¹ä¹Ÿèƒ½è·‘ï¼ˆå‘åå…¼å®¹ï¼‰
- [ ] å“åº”é‡Œæ˜ç¡® `source = CACHE/ON_DEMAND/DB`
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›å½’æµ‹è¯•ï¼šæ—§æ¥å£ä¸å´©

---

### ä»»åŠ¡ 5.3ï¼šç­–ç•¥ä¾§æ¥å…¥ï¼ˆç­–ç•¥æ¨¡å—è´Ÿè´£ï¼‰

**è¯´æ˜**ï¼šæ­¤ä»»åŠ¡ç”±ç­–ç•¥æ¨¡å—è´Ÿè´£ï¼ŒæŒ‡æ ‡æ¨¡å—æä¾›æ¥å£æ”¯æŒ

**ç­–ç•¥æ¨¡å—éœ€è¦åšçš„**ï¼š
1. è°ƒç”¨ `evaluateBatch()` æ‰¹é‡è¯„ä¼°æŒ‡æ ‡
2. å°†è¯„ä¼°ç»“æœå†™å…¥ `strategy_rules_record`
3. åŒ…å« `fingerprint`ã€`paramsHash`ã€`source`ã€`costMs` ç­‰ä¿¡æ¯

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ç­–ç•¥è¿è¡Œåï¼ŒæŒ‡æ ‡ç»“æœåªå­˜åœ¨äº `strategy_rules_record`
- [ ] `strategy_rules_record` èƒ½çœ‹åˆ°æŒ‡æ ‡è¾“å‡ºä¸ fingerprint
- [ ] å¯ç”¨äºè§£é‡Šå½“æ—¶å†³ç­–

---

## âœ… é˜¶æ®µäº”éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] æ–°æ¥å£å‡å¯ç”¨ï¼ˆevaluateã€evaluateBatchï¼‰
- [ ] æ—§æ¥å£å‘åå…¼å®¹ï¼ˆlatestï¼‰
- [ ] ç­–ç•¥è¿è¡ŒåæŒ‡æ ‡ç»“æœåªå­˜åœ¨äº `strategy_rules_record`
- [ ] `source` å­—æ®µæ­£ç¡®ï¼ˆCACHE / COMPUTED / DBï¼‰
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ“¦ é˜¶æ®µäº”äº§å‡ºç‰©

- âœ… æŒ‡æ ‡èƒ½åŠ›æ­£å¼æœåŠ¡ç­–ç•¥å¤§è„‘ï¼ˆAPI æ¥å£ï¼‰
- âœ… å‘åå…¼å®¹çš„æŸ¥è¯¢æ¥å£ï¼ˆlatestï¼‰

---

## ğŸš¦ é˜¶æ®µäº”å®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„è¿›å…¥é˜¶æ®µå…­

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

# é˜¶æ®µå…­ï¼šå‰ç«¯é…ç½®ä¸å¯è§†åŒ–ï¼ˆé‡Œç¨‹ç¢‘ M6ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**é‡åŒ–åˆ†æå¸ˆå¯ä»¥"è‡ªå·±é…æŒ‡æ ‡ã€è‡ªå·±ç®—æŒ‡æ ‡"**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 6.1ï¼šæŒ‡æ ‡å®šä¹‰é¡µé¢æ”¹é€ ï¼ˆDefinitionsï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/static/indicator/definitions.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **å‡çº§**ï¼šä»"åªè¯»"å‡çº§ä¸º"å¯ç¼–è¾‘"
2. ğŸ”§ **æ–°å¢**ï¼šæ”¯æŒç¼–è¾‘ `data_source`ã€`impl_key`ã€`param_schema`ã€`return_schema`ã€`enabled`
3. ğŸ”§ **æ–°å¢**ï¼š`param_schema` ä»¥"schema ç¼–è¾‘å™¨ + è¡¨å•é¢„è§ˆ"å‘ˆç°
4. ğŸ”§ **é›†æˆ**ï¼šè°ƒç”¨å‚æ•°æ ¡éªŒæ¥å£è¿›è¡Œå®æ—¶æ ¡éªŒ

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ”¯æŒåˆ›å»ºæ–°æŒ‡æ ‡å®šä¹‰
- æ”¯æŒç¼–è¾‘ç°æœ‰æŒ‡æ ‡å®šä¹‰
- Schema ç¼–è¾‘å™¨ï¼ˆå¯ä»¥ä½¿ç”¨ JSON ç¼–è¾‘å™¨ç»„ä»¶ï¼‰
- è¡¨å•é¢„è§ˆï¼ˆåŸºäº param_schema åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] èƒ½åˆ›å»º/ç¼–è¾‘ä¸€ä¸ªæ–°æŒ‡æ ‡å®šä¹‰ï¼ˆè‡ªå®šä¹‰ param_schema/return_schemaï¼‰
- [ ] Schema ç¼–è¾‘å™¨å¯ç”¨
- [ ] è¡¨å•é¢„è§ˆåŠŸèƒ½æ­£å¸¸
- [ ] å‚æ•°æ ¡éªŒå®æ—¶æç¤º

---

### ä»»åŠ¡ 6.2ï¼šæŒ‰éœ€è¯„ä¼°é¡µé¢ï¼ˆEvaluate Playgroundï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/static/indicator/evaluate.html`ï¼ˆæ–°å»ºï¼‰æˆ–å¹¶å…¥ `values.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼šæ–°çš„è¯„ä¼°é¡µé¢
2. ğŸ”§ **å®ç°**ï¼šé€‰æ‹© pair/tf/barTime + indicatorCode/version
3. ğŸ”§ **å®ç°**ï¼šè‡ªåŠ¨æ¸²æŸ“ params è¡¨å•ï¼ˆåŸºäº param_schemaï¼‰
4. ğŸ”§ **å®ç°**ï¼šç‚¹å‡» Evaluateï¼ˆæˆ– Batch Evaluateï¼‰
5. ğŸ”§ **å®ç°**ï¼šå±•ç¤ºç»“æœ + `sourceï¼ˆCACHE/COMPUTEDï¼‰`

**åŠŸèƒ½è¦æ±‚**ï¼š
- äº¤æ˜“å¯¹é€‰æ‹©å™¨
- å‘¨æœŸé€‰æ‹©å™¨
- æ—¶é—´é€‰æ‹©å™¨ï¼ˆasOfBarTimeï¼‰
- æŒ‡æ ‡é€‰æ‹©å™¨ï¼ˆåŸºäº definitions æ¥å£ï¼‰
- å‚æ•°è¡¨å•åŠ¨æ€æ¸²æŸ“
- å•æ¬¡è¯„ä¼°æŒ‰é’®
- æ‰¹é‡è¯„ä¼°åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- ç»“æœå±•ç¤ºï¼ˆåŒ…æ‹¬ source å­—æ®µï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é¡µé¢å¯ç”¨ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- [ ] å‚æ•°è¡¨å•èƒ½æ­£ç¡®æ¸²æŸ“
- [ ] è¯„ä¼°ç»“æœæ­£ç¡®æ˜¾ç¤º
- [ ] source å­—æ®µæ­£ç¡®æ˜¾ç¤ºï¼ˆCACHE/COMPUTEDï¼‰

---

### ä»»åŠ¡ 6.3ï¼šæŒ‡æ ‡ç»“æœé¡µé¢é€‚é…ï¼ˆValuesï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/resources/static/indicator/values.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **é€‚é…**ï¼šAPI è¿”å›çš„ `source` å­—æ®µï¼ˆCACHE/ON_DEMAND/DBï¼‰
2. ğŸ”§ **é€‚é…**ï¼šç™½åå•æŒ‡æ ‡å’Œè‡ªå®šä¹‰å‚æ•°æŒ‡æ ‡çš„å±•ç¤ºåŒºåˆ†
3. ğŸ”§ **å¯é€‰**ï¼šæ·»åŠ "æŒ‰éœ€è®¡ç®—"æŒ‰é’®ï¼ˆè°ƒç”¨ evaluate æ¥å£ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é¡µé¢æ­£å¸¸æ˜¾ç¤ºï¼Œsource å­—æ®µæ­£ç¡®å±•ç¤º
- [ ] ä¸åŒç±»å‹æŒ‡æ ‡çš„å±•ç¤ºåŒºåˆ†æ˜æ˜¾

---

### ä»»åŠ¡ 6.4ï¼šè®¢é˜…é¡µ/æ—¥å¿—é¡µé™çº§ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š
- `src/main/resources/static/indicator/subscriptions.html`
- `src/main/resources/static/indicator/logs.html`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **è°ƒæ•´**ï¼šä»æ ¸å¿ƒç”¨æˆ·è·¯å¾„é™çº§ä¸º"è¾“å…¥äº‹å®ç›‘æ§/è°ƒè¯•è¾…åŠ©"
2. ğŸ”§ **è¯´æ˜**ï¼šåœ¨é¡µé¢ä¸Šæ˜ç¡®è¯´æ˜è¿™äº›é¡µé¢çš„å®šä½

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] é¡µé¢ä»å¯ç”¨ï¼ˆå‘åå…¼å®¹ï¼‰
- [ ] é¡µé¢è¯´æ˜æ¸…æ¥šï¼ˆè°ƒè¯•è¾…åŠ©ï¼‰

---

## âœ… é˜¶æ®µå…­éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] å‰ç«¯æ— éœ€å†™æ­»å‚æ•°å³å¯é…ç½®æŒ‡æ ‡
- [ ] å¯æ‰‹åŠ¨è§¦å‘ evaluate / batch
- [ ] ç»“æœå±•ç¤ºæ¸…æ™°ï¼Œå« source
- [ ] æ‰€æœ‰é¡µé¢åŠŸèƒ½æ­£å¸¸

---

## ğŸ“¦ é˜¶æ®µå…­äº§å‡ºç‰©

- âœ… å®Œæ•´çš„æŒ‡æ ‡é…ç½®ä¸éªŒè¯ä½“éªŒï¼ˆå‰ç«¯é¡µé¢ï¼‰

---

## ğŸš¦ é˜¶æ®µå…­å®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„è¿›å…¥é˜¶æ®µä¸ƒ

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

# é˜¶æ®µä¸ƒï¼šæ€§èƒ½ã€æµ‹è¯•ä¸æ¸…ç†ï¼ˆé‡Œç¨‹ç¢‘ M7ï¼‰

## ğŸ¯ é˜¶æ®µç›®æ ‡

**ç³»ç»Ÿç¨³å®šã€å¯è§‚æµ‹ã€å¯ç»´æŠ¤**

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 7.1ï¼šMetrics æŒ‡æ ‡

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/observability/IndicatorMetrics.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ–°å¢**ï¼ševaluate è€—æ—¶ Metrics
2. ğŸ”§ **æ–°å¢**ï¼šç¼“å­˜å‘½ä¸­ç‡ Metrics
3. ğŸ”§ **æ–°å¢**ï¼šbatch size åˆ†å¸ƒ Metrics

**æ–°å¢ Metrics**ï¼š
```java
// evaluate è€—æ—¶ï¼ˆTimerï¼ŒP50/P95/P99ï¼‰
private final Timer evaluateCostTimer;

// ç¼“å­˜å‘½ä¸­ç‡
private final Counter cacheHits;
private final Counter cacheMisses;

// batch size åˆ†å¸ƒ
private final Histogram batchSizeHistogram;
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æŒ‡æ ‡æ‰§è¡Œè€—æ—¶ P95/P99 å¯è§‚æµ‹
- [ ] cache hit ratioï¼ˆæŒ‰ indicatorCode èšåˆï¼‰å¯è§‚æµ‹
- [ ] batch size åˆ†å¸ƒå¯è§‚æµ‹
- [ ] Prometheus ç«¯ç‚¹å¯è®¿é—®

---

### ä»»åŠ¡ 7.2ï¼šå‹æµ‹ä¸åŸºå‡†

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ“ **å‡†å¤‡**ï¼šå‹æµ‹è„šæœ¬
2. ğŸ”§ **æ‰§è¡Œ**ï¼šå•æŒ‡æ ‡ QPS åŸºå‡†æµ‹è¯•ï¼ˆå‘½ä¸­/ä¸å‘½ä¸­ï¼‰
3. ğŸ”§ **æ‰§è¡Œ**ï¼šbatch è¯„ä¼°ååæå‡æ¯”ä¾‹æµ‹è¯•
4. ğŸ”§ **æ‰§è¡Œ**ï¼šBarSeries append çš„å»¶è¿Ÿä¸å†…å­˜å ç”¨æµ‹è¯•

**å‹æµ‹åœºæ™¯**ï¼š
- å•æ¬¡è¯„ä¼°ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ï¼šç›®æ ‡ QPS > 1000
- å•æ¬¡è¯„ä¼°ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼šç›®æ ‡ QPS > 100
- æ‰¹é‡è¯„ä¼°ï¼ˆ10ä¸ªæŒ‡æ ‡ï¼‰ï¼šç›®æ ‡ååæå‡ > 2å€
- BarSeries append å»¶è¿Ÿï¼šç›®æ ‡ < 1ms

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å•æŒ‡æ ‡ QPS åŸºå‡†ï¼ˆå‘½ä¸­/ä¸å‘½ä¸­ï¼‰è¾¾åˆ°é¢„æœŸ
- [ ] batch è¯„ä¼°ååæå‡æ¯”ä¾‹ > 2å€
- [ ] BarSeries append çš„å»¶è¿Ÿ < 1msï¼Œå†…å­˜å ç”¨å¯æ§

---

### ä»»åŠ¡ 7.3ï¼šFeatureCacheï¼ˆPhase 2ï¼Œå¯é€‰ï¼‰

**âš ï¸ é‡è¦å®šä½**ï¼š
> **FeatureCache ä¸å¾—ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„ä¾èµ–ï¼Œåªèƒ½ä½œä¸ºæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚**

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/cache/FeatureCache.java`ï¼ˆæ–°å»ºï¼‰

**å®æ–½åŸåˆ™**ï¼š
- âœ… **MVP é˜¶æ®µ**ï¼šå¿…é¡»ä¸ä¾èµ– FeatureCacheï¼ŒåŠŸèƒ½å®Œå…¨å¯ç”¨
- âœ… **Phase 2 é˜¶æ®µ**ï¼šå‹æµ‹å CPU ä¸è¾¾æ ‡æ—¶ï¼Œä½œä¸ºæ€§èƒ½å¢å¼ºé¡¹å¼•å…¥
- âœ… **é™åˆ¶èŒƒå›´**ï¼šåªå…è®¸ cache çº¯å‡½æ•°ç‰¹å¾ï¼ˆSMAã€EMAã€TRã€æœ€é«˜ä½ç­‰åŸºç¡€åºåˆ—ï¼‰
- âŒ **ä¸¥ç¦**ï¼š
  - å°†ä¸šåŠ¡é€»è¾‘å¡è¿› FeatureCache
  - å°† FeatureCache ä½œä¸ºåŠŸèƒ½æ­£ç¡®æ€§çš„å‰ææ¡ä»¶
  - åœ¨ MVP é˜¶æ®µå¼ºåˆ¶ä¾èµ– FeatureCache

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. âœ… **åˆ›å»º**ï¼šFeatureCache ç±»ï¼ˆäºŒçº§ç¼“å­˜ï¼‰
2. ğŸ”§ **å®ç°**ï¼šåŸºç¡€åºåˆ—ç¼“å­˜ï¼ˆSMAã€EMAã€æœ€é«˜ä½ã€TR ç­‰çº¯å‡½æ•°ï¼‰
3. ğŸ”§ **é›†æˆ**ï¼šåœ¨æ‰¹é‡è¯„ä¼°æ—¶å¤ç”¨ç¼“å­˜çš„ç»“æœï¼ˆå¯é€‰ï¼Œä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼‰

**ç¼“å­˜é”®è®¾è®¡**ï¼š
- åŸºç¡€åºåˆ—ï¼š`feature:${featureType}:${pairId}:${timeframe}:${params}:${asOfBarTime}`
- ä¾‹å¦‚ï¼š`feature:sma:1:1h:period=20:2024-01-01T12:00:00`

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] **MVP éªŒæ”¶**ï¼šåŠŸèƒ½å®Œå…¨å¯ç”¨ï¼Œä¸ä¾èµ– FeatureCache
- [ ] **Phase 2 éªŒæ”¶**ï¼šåœ¨ batch evaluate ä¸­ï¼Œå¤šä¸ªæŒ‡æ ‡å…±ç”¨åŒä¸€ä»½ bar window / feature ç»“æœ
- [ ] **æ€§èƒ½éªŒæ”¶**ï¼šCPU ä½¿ç”¨æ˜æ˜¾ä¸‹é™ï¼ˆå‹æµ‹éªŒè¯ï¼‰
- [ ] **å•å…ƒæµ‹è¯•è¦†ç›–**ï¼šFeatureCache é€»è¾‘æµ‹è¯•é€šè¿‡
- [ ] **é›†æˆæµ‹è¯•**ï¼šFeatureCache å…³é—­æ—¶ï¼ŒåŠŸèƒ½ä»ç„¶æ­£å¸¸ï¼ˆå…³é”®éªŒæ”¶ç‚¹ï¼‰

---

### ä»»åŠ¡ 7.4ï¼šåºŸå¼ƒä»£ç æ ‡è®°

**ç›®æ ‡**ï¼šæ ‡è®°ä¸å†ä½¿ç”¨çš„ä»£ç ï¼Œä¸ºåç»­åˆ é™¤åšå‡†å¤‡

#### 7.4.1 åºŸå¼ƒ IndicatorCalculator çš„è‡ªåŠ¨è®¡ç®—é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/calculator/IndicatorCalculator.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ ‡è®°**ï¼šåœ¨ç±»å’Œæ–¹æ³•ä¸Šæ·»åŠ  `@Deprecated` æ³¨è§£
2. ğŸ“ **æ³¨é‡Š**ï¼šè¯´æ˜åºŸå¼ƒåŸå› å’Œæ›¿ä»£æ–¹æ¡ˆ
3. âœ… **ä¿ç•™**ï¼šä»£ç æš‚æ—¶ä¿ç•™ï¼ˆFeature Flag æ§åˆ¶ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
/**
 * @deprecated V2: è‡ªåŠ¨è®¡ç®—å·²åºŸå¼ƒï¼Œä½¿ç”¨ IndicatorEvaluateService è¿›è¡ŒæŒ‰éœ€è¯„ä¼°
 * æ­¤ç±»çš„è‡ªåŠ¨è®¡ç®—åŠŸèƒ½é€šè¿‡ Feature Flag æ§åˆ¶ï¼Œé»˜è®¤å…³é—­
 * 
 * @see IndicatorEvaluateService
 */
@Deprecated
@Component
public class IndicatorCalculator {
    // ...
}
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åºŸå¼ƒä»£ç å·²æ ‡è®°
- [ ] æœ‰æ˜ç¡®çš„æ›¿ä»£æ–¹æ¡ˆè¯´æ˜

---

#### 7.4.2 åºŸå¼ƒ IndicatorValueRepository çš„å†™å…¥é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorValueRepository.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ”§ **æ ‡è®°**ï¼š`insertIgnore()` æ–¹æ³•æ·»åŠ  `@Deprecated`
2. ğŸ“ **æ³¨é‡Š**ï¼šè¯´æ˜ V2 ä¸å†è½åº“ï¼Œç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“

**ä»£ç ç¤ºä¾‹**ï¼š
```java
/**
 * @deprecated V2: æŒ‡æ ‡å€¼ä¸å†è½åº“åˆ° indicator_value è¡¨
 * æŒ‡æ ‡ç»“æœå½’æ¡£åˆ°ç­–ç•¥å¤§è„‘çš„ strategy_rules_record
 * 
 * @see IndicatorEvaluateService
 */
@Deprecated
WriteResult insertIgnore(IndicatorValue value);
```

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] åºŸå¼ƒæ–¹æ³•å·²æ ‡è®°
- [ ] æœ‰æ˜ç¡®çš„æ›¿ä»£æ–¹æ¡ˆè¯´æ˜

---

#### 7.4.3 åºŸå¼ƒ IndicatorSubscriptionRepository çš„é©±åŠ¨è®¡ç®—é€»è¾‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/main/java/com/qyl/v2trade/indicator/repository/IndicatorSubscriptionRepository.java`

**ä»»åŠ¡æ­¥éª¤**ï¼š
1. ğŸ“ **æ³¨é‡Š**ï¼šè¯´æ˜ subscription ä¸å†ä½œä¸ºè®¡ç®—é©±åŠ¨æº
2. âœ… **ä¿ç•™**ï¼šCRUD æ–¹æ³•ä¿ç•™ï¼ˆç”¨äºè°ƒè¯•/ç›‘æ§ï¼‰

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] ä»£ç æ³¨é‡Šæ˜ç¡®è¯´æ˜å®šä½å˜åŒ–

---

### ä»»åŠ¡ 7.5ï¼šå®Œæ•´æµ‹è¯•è¦†ç›–

#### 7.5.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**ï¼š
- `IndicatorParamValidatorTest.java`ï¼šå‚æ•°æ ¡éªŒæµ‹è¯•
- `IndicatorEvaluateServiceTest.java`ï¼šè¯„ä¼°æœåŠ¡æµ‹è¯•
- `IndicatorCacheManagerTest.java`ï¼šç¼“å­˜ç®¡ç†å™¨æµ‹è¯•
- `IndicatorEngineRouterTest.java`ï¼šå¼•æ“è·¯ç”±æµ‹è¯•

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰æ ¡éªŒåœºæ™¯éƒ½æœ‰æµ‹è¯•è¦†ç›–
- [ ] æµ‹è¯•é€šè¿‡ç‡è¾¾åˆ° 100%

---

#### 7.5.2 é›†æˆæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**ï¼š
- `BarSeriesEvaluateIntegrationTest.java`ï¼šBarSeries ä¸ Evaluate é›†æˆæµ‹è¯•
- `BatchEvaluateIntegrationTest.java`ï¼šæ‰¹é‡è¯„ä¼°ä¸€è‡´æ€§æµ‹è¯•

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] BarClosedEvent æ¨è¿› bar window åï¼Œevaluate(asOf=æœ€æ–° bar) å¾—åˆ°å¯é¢„æœŸç»“æœ
- [ ] evaluateBatch ä¸å•æ¬¡ evaluate ç»“æœä¸€è‡´
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

---

#### 7.5.3 å›å½’æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
- `GET /api/indicator/latest` æ¥å£ä¸å´©
- æ—§å‰ç«¯é¡µé¢ä¸å´©
- æ—§ç­–ç•¥æ¨¡å—è°ƒç”¨æ­£å¸¸

**éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰**ï¼š
- [ ] æ—§æ¥å£ latest ä¸å´©ï¼ˆå…¼å®¹å±‚ï¼‰
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] ç­–ç•¥æ¨¡å—è°ƒç”¨æ­£å¸¸

---

## âœ… é˜¶æ®µä¸ƒéªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

- [ ] ç¼“å­˜å‘½ä¸­ QPS è¾¾æ ‡ï¼ˆ> 1000 QPSï¼‰
- [ ] **FeatureCache å…³é—­æ—¶åŠŸèƒ½å®Œå…¨æ­£å¸¸**ï¼ˆå…³é”®éªŒæ”¶ç‚¹ï¼‰
- [ ] æ— è‡ªåŠ¨è®¡ç®—æŒ‡æ ‡åå°ä»»åŠ¡ï¼ˆFeature Flag é»˜è®¤å…³é—­ï¼‰
- [ ] åºŸå¼ƒä»£ç å·²æ ‡è®°ï¼ˆ@Deprecatedï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•å’Œå›å½’æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] Metrics æŒ‡æ ‡å¯è§‚æµ‹ï¼ˆè€—æ—¶ã€ç¼“å­˜å‘½ä¸­ç‡ã€batch sizeï¼‰

---

## ğŸ“¦ é˜¶æ®µä¸ƒäº§å‡ºç‰©

- âœ… ç³»ç»Ÿç¨³å®šã€å¯è§‚æµ‹ã€å¯ç»´æŠ¤ï¼ˆMetricsã€æµ‹è¯•è¦†ç›–ï¼‰
- âœ… æ€§èƒ½ä¼˜åŒ–é¡¹ï¼ˆFeatureCacheï¼Œå¯é€‰ï¼‰
- âœ… åºŸå¼ƒä»£ç æ ‡è®°ï¼ˆä¸ºåç»­æ¸…ç†åšå‡†å¤‡ï¼‰

---

## ğŸš¦ é˜¶æ®µä¸ƒå®Œæˆç¡®è®¤

**éªŒæ”¶äººç¡®è®¤**ï¼šâ–¡ åŒæ„å®Œæˆ V2 ç‰ˆæœ¬

**éªŒæ”¶æ—¥æœŸ**ï¼š__________

**å¤‡æ³¨**ï¼š__________

---

## ğŸ“‹ æœ€ç»ˆäº¤ä»˜ç‰©æ€»ç»“

### V2 æ ¸å¿ƒå˜åŒ–

1. **äº§å“å®šä½**ï¼šä»"æŒ‡æ ‡ç»“æœäº‹å®åº“"æ”¹ä¸º"æŒ‡æ ‡å®šä¹‰æ³¨å†Œä¸­å¿ƒ + è¿è¡Œæ—¶æŒ‰éœ€è¯„ä¼°èƒ½åŠ›"
2. **æ•°æ®æ¨¡å‹**ï¼šåªä¿ç•™ `indicator_definition` å•è¡¨ï¼Œç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“
3. **è®¡ç®—æ¨¡å¼**ï¼šä»"è®¢é˜…é©±åŠ¨è‡ªåŠ¨è®¡ç®—"æ”¹ä¸º"æŒ‰éœ€è¯„ä¼° + ç¼“å­˜"
4. **æ ¸å¿ƒèƒ½åŠ›**ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å‚æ•°ã€æŒ‰éœ€è®¡ç®—ã€é«˜æ•ˆç¼“å­˜

### å…³é”®æ–‡ä»¶æ¸…å•

**æ–°å»ºæ–‡ä»¶**ï¼š
- `IndicatorEvaluateService.java`ï¼ˆè¿è¡Œæ—¶è¯„ä¼°æœåŠ¡ï¼‰
- `IndicatorCacheManager.java`ï¼ˆç¼“å­˜ç®¡ç†å™¨ï¼‰
- `IndicatorParamValidator.java`ï¼ˆå‚æ•°æ ¡éªŒå™¨ï¼‰
- `IndicatorEvaluateController.java`ï¼ˆè¯„ä¼°APIæ§åˆ¶å™¨ï¼‰
- `FeatureCache.java`ï¼ˆå¯é€‰ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `BarSeriesManager.java`ï¼ˆåªç»´æŠ¤Kçº¿ï¼Œä¸è§¦å‘è®¡ç®—ï¼‰
- `IndicatorCalculator.java`ï¼ˆé»˜è®¤å…³é—­ï¼Œæ ‡è®°åºŸå¼ƒï¼‰
- `IndicatorDefinition.java`ï¼ˆæ‰©å±•å­—æ®µï¼‰
- `IndicatorDefinitionController.java`ï¼ˆæ”¯æŒç¼–è¾‘ï¼‰
- `IndicatorController.java`ï¼ˆå…¼å®¹æŸ¥è¯¢ï¼‰

**åºŸå¼ƒæ–‡ä»¶**ï¼š
- æ— ï¼ˆä»£ç ä¿ç•™ä½†æ ‡è®°ä¸ºåºŸå¼ƒï¼‰

---

## ğŸ¯ V2 æˆåŠŸæ ‡å‡†

> **æŒ‡æ ‡ V2 çš„æˆåŠŸæ ‡å‡†ä¸æ˜¯"åŠŸèƒ½å¤š"ï¼Œè€Œæ˜¯ï¼š  
> K çº¿åªç®¡è¾“å…¥ï¼ŒæŒ‡æ ‡åªç®¡è®¡ç®—ï¼Œç­–ç•¥åªç®¡å†³ç­–ã€‚**

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… K çº¿è®¢é˜…ä¸å˜ï¼ˆBarSeries ç»´æŠ¤ï¼‰
- âœ… æŒ‡æ ‡æŒ‰éœ€è¯„ä¼°ï¼ˆè°ç”¨è°ç®—ï¼‰
- âœ… ç»“æœå½’æ¡£åˆ°ç­–ç•¥è§„åˆ™ä½“ï¼ˆä¸è½åº“ï¼‰
- âœ… èŒè´£è¾¹ç•Œæ¸…æ™°ï¼ˆä¸æ„ŸçŸ¥ç­–ç•¥è¯­ä¹‰ï¼‰
- âœ… æ€§èƒ½é«˜æ•ˆï¼ˆç¼“å­˜å‘½ä¸­ä¿éšœï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md](./æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md) - V2 äº§å“è§„èŒƒ
- [æŒ‡æ ‡V2ç‰ˆæœ¬å¼€å‘ä»»åŠ¡è¯¦ç»†æ¸…å•.md](./æŒ‡æ ‡V2ç‰ˆæœ¬å¼€å‘ä»»åŠ¡è¯¦ç»†æ¸…å•.md) - V2 è¯¦ç»†å¼€å‘ä»»åŠ¡
- [æŒ‡æ ‡æ¨¡å—æ€»ä½“è®¾è®¡.md](./æŒ‡æ ‡æ¨¡å—æ€»ä½“è®¾è®¡.md) - V2 æ€»ä½“è®¾è®¡
- [æŒ‡æ ‡v2åˆ†é˜¶æ®µåˆ’åˆ†ä»»åŠ¡.md](./æŒ‡æ ‡v2åˆ†é˜¶æ®µåˆ’åˆ†ä»»åŠ¡.md) - V2 åˆ†é˜¶æ®µåˆ’åˆ†

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV2.0  
**æœ€åæ›´æ–°**ï¼š2024-01  
**ç»´æŠ¤è€…**ï¼šqyl  
**åŸºäºè§„èŒƒ**ï¼š[æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md](./æŒ‡æ ‡v2ç‰ˆæœ¬é‡æ„äº§å“è§„èŒƒ.md)