# 指标模块 V2 重构 —— 分阶段开发与验收计划（冻结版）

> 本文档用于 **开发执行与阶段验收**  
> 每一阶段都可 **独立上线 / 回滚 / 验收**  
> 未通过当前阶段验收，**禁止进入下一阶段**

---

## 总体原则（所有阶段必须遵守）

1. **K 线订阅不变**
   - BarClosedEvent 只维护 BarSeries
   - 禁止触发任何指标计算

2. **只保留一张表：indicator_definition**
   - 指标 = 定义（schema）+ 插件实现映射
   - 指标模块不落指标结果

3. **指标按需评估 + 运行时缓存**
   - 谁用谁算
   - 同参同上下文必须缓存命中

4. **指标模块不感知策略语义**
   - 不返回多/空/权重/打分
   - 结果只归档到 strategy_rules_record

---

# 阶段一：输入事实层冻结（里程碑 M1）

## 🎯 阶段目标
**彻底断开“订阅 → 自动算指标”链路，仅保留 K 线输入事实维护**

---

## 任务清单
- 断开 `IndicatorCalculator` 与 `BarClosedEvent` 的耦合
- `BarSeriesManager` 只做：
  - K 线追加
  - ring buffer 窗口维护
- 新增 Feature Flag：
  - `indicator.auto-calculate.enabled=false`

---

## 验收标准（必须全部满足）
- [ ] BarClosedEvent 到达后 **不触发任何指标计算**
- [ ] 5m / 15m / 30m / 1h / 4h 周期 BarSeries 正常推进
- [ ] CPU 使用率不随指标数量变化
- [ ] 自动计算逻辑默认关闭且可回滚

---

## 产出物
- 可运行系统（无指标计算）
- 输入事实层稳定
- 为后续阶段提供 **唯一可信输入**

✅ **通过后才能进入阶段二**

---

# 阶段二：指标定义注册层（里程碑 M2）

## 🎯 阶段目标
**建立“指标 = 定义 + schema + 实现映射”的唯一事实来源**

---

## 任务清单
- 扩展 `indicator_definition`：
  - data_source
  - impl_key
  - param_schema
  - return_schema
- Definition 支持 CRUD（前端可编辑）
- 参数 schema 支持：
  - 必填 / 类型 / 范围 / 枚举
  - lookback / window 限制

---

## 验收标准
- [ ] 只依赖 indicator_definition 就能描述一个完整指标
- [ ] 前端可根据 param_schema 自动生成表单
- [ ] 后端可根据 schema 校验参数
- [ ] 不新增任何指标相关业务表

---

## 产出物
- 指标定义注册中心
- schema 成为前后端契约

✅ **通过后才能进入阶段三**

---

# 阶段三：运行时评估核心（里程碑 M3）

## 🎯 阶段目标
**提供统一 evaluate / evaluateBatch 能力（无缓存也能跑）**

---

## 任务清单
- 新增 `IndicatorEvaluateService`
- 强制组件拆分：
  - IndicatorParamValidator
  - IndicatorEngineRouter
  - IndicatorCacheManager（可先空实现）
- 支持：
  - 单次 evaluate
  - 批量 evaluateBatch
- 支持 impl_key → 插件硬代码映射

---

## 验收标准
- [ ] evaluate 能正确计算指标
- [ ] evaluateBatch 结果与单次一致
- [ ] Service 只做协调，不包含业务逻辑
- [ ] 输出不包含任何策略语义字段

---

## 产出物
- 可被策略直接调用的运行时评估引擎
- 指标插件体系跑通

✅ **通过后才能进入阶段四**

---

# 阶段四：运行时缓存能力（里程碑 M4）

## 🎯 阶段目标
**保证“同参同上下文只算一次”**

---

## 任务清单
- 实现 IndicatorCacheManager
- 固定 cacheKey 规则：
- indicatorCode + version + pairId + timeframe + asOfBarTime + paramsHash
- paramsHash 规范化（排序 / 精度一致）
- TTL / maxSize 配置化

---

## 验收标准
- [ ] 第一次 evaluate → COMPUTED
- [ ] 第二次 evaluate → CACHE
- [ ] 缓存命中时耗时 < 1ms
- [ ] 关闭缓存不影响功能正确性

---

## 产出物
- 高效、可控的运行时缓存层

✅ **通过后才能进入阶段五**

---

# 阶段五：API 与策略接入（里程碑 M5）

## 🎯 阶段目标
**让指标能力真正被“策略大脑”使用**

---

## 任务清单
- 新增：
- POST `/api/indicator/evaluate`
- POST `/api/indicator/evaluate/batch`
- 改造 `/api/indicator/latest`：
- DB → evaluate fallback
- 返回 source 字段
- 策略侧接入：
- evaluateBatch
- 结果写入 `strategy_rules_record`

---

## 验收标准
- [ ] 新老接口均可用
- [ ] 策略运行后指标结果只存在于 strategy_rules_record
- [ ] source 字段正确（CACHE / COMPUTED / DB）

---

## 产出物
- 指标能力正式服务策略大脑

✅ **通过后才能进入阶段六**

---

# 阶段六：前端配置与可视化（里程碑 M6）

## 🎯 阶段目标
**量化分析师可以“自己配指标、自己算指标”**

---

## 任务清单
- 指标定义页（可编辑 schema）
- 按需评估 Playground
- Values 页展示 source
- 订阅/日志页降级为调试辅助

---

## 验收标准
- [ ] 前端无需写死参数即可配置指标
- [ ] 可手动触发 evaluate / batch
- [ ] 结果展示清晰，含 source

---

## 产出物
- 完整的指标配置与验证体验

---

# 阶段七：性能、测试与清理（里程碑 M7）

## 🎯 阶段目标
**系统稳定、可观测、可维护**

---

## 任务清单
- Metrics（耗时 / cache hit / batch size）
- 压测（命中 / 未命中 / batch）
- FeatureCache（Phase 2，可选）
- 废弃代码标记（Calculator / Value 写入）

---

## 验收标准
- [ ] 缓存命中 QPS 达标
- [ ] FeatureCache 关闭时功能完全正常
- [ ] 无自动计算指标后台任务
- [ ] 废弃代码已标记

---

## 最终交付物
- 指标 V2 模块（可长期维护）
- 明确边界、低复杂度、高性能

---

## TL;DR（给所有人看的最后一句）

> **指标 V2 的成功标准不是“功能多”，而是：  
> K 线只管输入，指标只管计算，策略只管决策。**
