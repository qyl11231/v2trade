# V2-Trade ç³»ç»Ÿæ¶æ„æ ¡å‡†ä¸è‡´å‘½ç¼ºå£æ¸…å•

> **æ–‡æ¡£ç›®æ ‡**ï¼šæ ¡å‡†å½“å‰ç³»ç»Ÿæ¶æ„æ–‡æ¡£ä¸­çš„ä¸ä¸€è‡´æ€§ï¼Œå¹¶æ˜ç¡®è‡´å‘½ç¼ºå£æ¸…å•ï¼Œç¡®ä¿åç»­ç ”å‘ä¸è¸©å‘ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2026-01-06  
**æ ¡å‡†ä¾æ®**ï¼šä»£ç å®é™…å®ç° + æ¶æ„è®¾è®¡åŸåˆ™

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ ¡å‡†ï¼ˆè§£å†³ä¸ä¸€è‡´ï¼‰](#ä¸€æ¶æ„æ ¡å‡†è§£å†³ä¸ä¸€è‡´)
2. [è‡´å‘½ç¼ºå£æ¸…å•](#äºŒè‡´å‘½ç¼ºå£æ¸…å•)
3. [äº‹ä»¶å¥‘çº¦å®šä¹‰](#ä¸‰äº‹ä»¶å¥‘çº¦å®šä¹‰)
4. [æ—¶é—´è¯­ä¹‰è§„èŒƒ](#å››æ—¶é—´è¯­ä¹‰è§„èŒƒ)
5. [æŒ‡æ ‡è®¡ç®—å†²çªç­–ç•¥](#äº”æŒ‡æ ‡è®¡ç®—å†²çªç­–ç•¥)
6. [æŒ‡æ ‡è®¢é˜…ä¸èšåˆç»‘å®šè§„åˆ™](#å…­æŒ‡æ ‡è®¢é˜…ä¸èšåˆç»‘å®šè§„åˆ™)

---

## ä¸€ã€æ¶æ„æ ¡å‡†ï¼ˆè§£å†³ä¸ä¸€è‡´ï¼‰

### 1.1 æŒ‡æ ‡æ¨¡å—è¿›åº¦æ ¡å‡†

**é—®é¢˜**ï¼šå†»ç»“ç‰ˆæ˜¾ç¤ºæŒ‡æ ‡æ¨¡å—é˜¶æ®µ3/4/5æœªå®Œæˆï¼Œæ–°äººæŒ‡å—æ˜¾ç¤ºå·²å®Œæˆ

**å®é™…ä»£ç æ£€æŸ¥ç»“æœ**ï¼š
- âœ… `IndicatorCalculator`å·²å®Œæ•´å®ç°ï¼ˆç›‘å¬BarClosedEventã€æŸ¥è¯¢è®¢é˜…ã€è®¡ç®—ã€æŒä¹…åŒ–ï¼‰
- âœ… `IndicatorValueRepository`å·²å®ç°å¹‚ç­‰å†™å…¥ï¼ˆinsert ignoreï¼‰
- âœ… `CalcFingerprint`å·²å®ç°å†²çªæ£€æµ‹
- âœ… `IndicatorEngineRouter`å·²å®ç°å¼•æ“è·¯ç”±
- âœ… `BarSeriesManager`å·²å®ç°Barç³»åˆ—ç®¡ç†

**æ ¡å‡†ç»“è®º**ï¼š
- **æŒ‡æ ‡æ¨¡å—æ ¸å¿ƒåŠŸèƒ½å·²é—­ç¯**ï¼ˆé˜¶æ®µ0.5ã€1ã€2ã€3ã€4ã€5å·²å®Œæˆï¼‰
- **é˜¶æ®µ6ï¼ˆå¯è§‚æµ‹æ€§ï¼‰éƒ¨åˆ†å®Œæˆ**ï¼šMetricså·²å®ç°ï¼Œæ—¥å¿—å·²ç»“æ„åŒ–
- **é˜¶æ®µ7ï¼ˆAPIæŸ¥è¯¢ï¼‰å·²å®Œæˆ**ï¼š`IndicatorController`æä¾›åªè¯»API

**æ›´æ–°å»ºè®®**ï¼š
- å†»ç»“ç‰ˆæ–‡æ¡£éœ€è¦æ›´æ–°é˜¶æ®µ3/4/5çŠ¶æ€ä¸ºâœ…å·²å®Œæˆ
- æ–°äººæŒ‡å—çš„æè¿°æ˜¯æ­£ç¡®çš„ï¼Œä½†éœ€è¦è¡¥å……è¯´æ˜"é˜¶æ®µ6éƒ¨åˆ†å®Œæˆ"

---

### 1.2 è¡Œæƒ…è®¢é˜…ç²’åº¦æ ¡å‡†

**é—®é¢˜**ï¼š1mè®¢é˜… vs å¤šå‘¨æœŸè®¢é˜…çš„æ··æ·†

**å®é™…å®ç°æƒ…å†µ**ï¼š
1. **WebSocketè®¢é˜…**ï¼šå½“å‰åªè®¢é˜…1åˆ†é’ŸKçº¿ï¼ˆ`candle1m`é¢‘é“ï¼‰
2. **Kçº¿èšåˆ**ï¼šä»1mèšåˆç”Ÿæˆ5mã€15mã€30mã€1hã€4h
3. **æŒ‡æ ‡è®¡ç®—**ï¼šåªå“åº”5mã€15mã€30mã€1hã€4hçš„`BarClosedEvent`ï¼ˆä¸å¤„ç†1mï¼‰

**æ ¡å‡†ç»“è®º**ï¼š
```
è®¢é˜…é“¾è·¯ï¼šOKX WebSocket â†’ åªè®¢é˜…1m â†’ QuestDB kline_1m
èšåˆé“¾è·¯ï¼škline_1m â†’ èšåˆå¼•æ“ â†’ QuestDB kline_5m/15m/30m/1h/4h â†’ å‘å¸ƒBarClosedEvent
æŒ‡æ ‡é“¾è·¯ï¼šBarClosedEvent (5m/15m/30m/1h/4h) â†’ IndicatorCalculator â†’ è®¡ç®—æŒ‡æ ‡
```

**BarClosedEventå‘å¸ƒç­–ç•¥ï¼ˆå·²å†»ç»“ï¼‰**ï¼š
- âœ… **ä»…èšåˆå‘¨æœŸå‘å¸ƒ**ï¼š5mã€15mã€30mã€1hã€4h
- âŒ **1mä¸å‘å¸ƒ**ï¼šæŒ‡æ ‡æ¨¡å—ä¸å¤„ç†1må‘¨æœŸï¼ˆä»£ç ç¬¬84-90è¡Œæ˜ç¡®è¿‡æ»¤ï¼‰
- âœ… **å‘å¸ƒæ—¶æœº**ï¼šèšåˆå®Œæˆåç«‹å³å‘å¸ƒ

**æ›´æ–°å»ºè®®**ï¼š
- æ–°äººæŒ‡å—æ˜ç¡®è¯´æ˜ï¼šè®¢é˜…åªæ”¯æŒ1mï¼Œå¤šå‘¨æœŸé€šè¿‡èšåˆç”Ÿæˆ
- æ¶æ„æ–‡æ¡£æ˜ç¡®ï¼šBarClosedEventåªç”±èšåˆå‘¨æœŸè§¦å‘

---

### 1.3 æ—¶é—´è¯­ä¹‰æ ¡å‡†

**é—®é¢˜**ï¼šQuestDB tsæ˜¯å¼€ç›˜æ—¶é—´è¿˜æ˜¯æ”¶ç›˜æ—¶é—´ä¸æ˜ç¡®

**å®é™…ä»£ç æ£€æŸ¥ç»“æœ**ï¼š
- `BarClosedEvent.barCloseTime`ï¼šæ˜ç¡®æ³¨é‡Šä¸º"bar_close_timeï¼ŒUTC"
- `NormalizedBar.barTime`ï¼šæ˜ç¡®æ³¨é‡Šä¸º"bar_close_timeï¼ŒUTC"
- ä»£ç ä¸­ä½¿ç”¨äº†`QuestDbTsSemanticsProbe`æ¢é’ˆæ£€æµ‹QuestDBæ—¶é—´è¯­ä¹‰

**æ ¡å‡†ç»“è®º**ï¼ˆåŸºäºä»£ç æ¨æ–­å’Œæ¶æ„è®¾è®¡ï¼‰ï¼š

```
QuestDBè¡¨ï¼ˆkline_1m/kline_5mç­‰ï¼‰ï¼š
- tså­—æ®µï¼šbar_open_timeï¼ˆå¼€ç›˜æ—¶é—´ï¼ŒUTCï¼‰
- è¯­ä¹‰ï¼šKçº¿å‘¨æœŸçš„èµ·å§‹æ—¶é—´ç‚¹

æŒ‡æ ‡æ¨¡å—å†…éƒ¨ï¼ˆNormalizedBar/BarClosedEventï¼‰ï¼š
- barTime/barCloseTimeï¼šbar_close_timeï¼ˆæ”¶ç›˜æ—¶é—´ï¼ŒUTCï¼‰
- è¯­ä¹‰ï¼šKçº¿å‘¨æœŸçš„ç»“æŸæ—¶é—´ç‚¹

è½¬æ¢è§„åˆ™ï¼š
- bar_close_time = bar_open_time + å‘¨æœŸæ—¶é•¿
- ä¾‹å¦‚ï¼š1må‘¨æœŸï¼Œbar_open_time = 2026-01-06 10:00:00ï¼Œåˆ™bar_close_time = 2026-01-06 10:01:00
```

**æ›´æ–°å»ºè®®**ï¼š
- æ–°äººæŒ‡å—æ˜ç¡®è¯´æ˜ï¼šQuestDB ts = bar_open_time
- è¡¥å……æ—¶é—´è¯­ä¹‰è½¬æ¢æ–‡æ¡£ï¼ˆè§ç¬¬4èŠ‚ï¼‰

---

### 1.4 å¯†ç å®‰å…¨æ ¡å‡†
**é—®é¢˜**ï¼šMD5ä¸é€‚åˆå¯†ç å­˜å‚¨

**å½“å‰çŠ¶æ€**ï¼š
- SQLè„šæœ¬ä½¿ç”¨MD5ï¼š`0192023a7bbd73250516f069df18b500`ï¼ˆadmin123ï¼‰
- ç”Ÿäº§ç¯å¢ƒå­˜åœ¨å®‰å…¨éšæ‚£

**æ ¡å‡†ç»“è®º**ï¼š
- âŒ **å¿…é¡»æ”¹ä¸ºBCrypt**ï¼šä½¿ç”¨Spring Securityçš„`BCryptPasswordEncoder`
- âš ï¸ **è¿ç§»è®¡åˆ’**ï¼š
  1. ä¿®æ”¹`UserService`ä½¿ç”¨BCryptåŠ å¯†
  2. æä¾›æ•°æ®è¿ç§»è„šæœ¬ï¼ˆå°†ç°æœ‰MD5å¯†ç é‡ç½®æˆ–è¿ç§»ï¼‰
  3. æ›´æ–°ç™»å½•é€»è¾‘

**æ›´æ–°å»ºè®®**ï¼š
- æ–°äººæŒ‡å—æ ‡æ³¨"MD5å¯†ç å­˜å‚¨éœ€è¦æ”¹ä¸ºBCrypt"
- åˆ›å»ºæŠ€æœ¯å€ºåŠ¡æ¸…å•ï¼Œæ ‡è®°ä¸ºP0

---

### 1.5 ç­–ç•¥åŸŸè¾¹ç•Œæ ¡å‡†

**é—®é¢˜**ï¼šsignal_intent vs strategy_intent_recordçš„å…³ç³»ä¸æ˜ç¡®

**è¡¨è®¾è®¡åˆ†æ**ï¼š

```
signal_intentï¼ˆä¿¡å·æ„å›¾è¡¨ï¼‰ï¼š
- ä½œç”¨ï¼šå°†Signalè½¬æ¢ä¸ºIntentï¼ˆLATEST_ONLYæ¨¡å‹ï¼‰
- çŠ¶æ€ï¼šACTIVE/CONSUMED/EXPIRED/IGNORED
- æ—¶æœºï¼šSignalæ¥æ”¶åï¼Œç­–ç•¥æ¶ˆè´¹å‰

strategy_intent_recordï¼ˆç­–ç•¥å†³ç­–æµæ°´è¡¨ï¼‰ï¼š
- ä½œç”¨ï¼šè®°å½•ç­–ç•¥çš„æœ€ç»ˆå†³ç­–ï¼ˆ"æˆ‘å†³å®šåšä»€ä¹ˆ"ï¼‰
- åŠ¨ä½œï¼šOPEN/CLOSE/ADD/REDUCE/REVERSE/HOLD
- æ—¶æœºï¼šç­–ç•¥è¿è¡Œæ—¶å†³ç­–å

å…³ç³»ï¼š
Signal â†’ signal_intent â†’ StrategyRuntime â†’ strategy_intent_record
```

**æ ¡å‡†ç»“è®º**ï¼š
- âœ… **è®¾è®¡æ­£ç¡®**ï¼šä¿¡å·æ„å›¾å’Œç­–ç•¥å†³ç­–æ˜¯ä¸¤å±‚ï¼Œåˆ†ç¦»æ˜¯åˆç†çš„
- âš ï¸ **å®ç°çŠ¶æ€**ï¼šä¸¤ä¸ªè¡¨éƒ½å·²åˆ›å»ºï¼Œä½†ç­–ç•¥è¿è¡Œæ—¶æœªå®ç°
- âœ… **å¼€å‘é¡ºåº**ï¼šåº”å…ˆå®ç°Signal â†’ signal_intentï¼Œå†å®ç°StrategyRuntime

**æ›´æ–°å»ºè®®**ï¼š
- æ˜ç¡®è¯´æ˜ï¼šsignal_intentæ˜¯"é˜¶æ®µ2"è¦å®ç°çš„ï¼ˆä¿¡å·æ¶ˆè´¹å±‚ï¼‰
- strategy_intent_recordæ˜¯"é˜¶æ®µ2ç­–ç•¥è¿è¡Œæ—¶"è¦å®ç°çš„ï¼ˆå†³ç­–è®°å½•å±‚ï¼‰

---

## äºŒã€è‡´å‘½ç¼ºå£æ¸…å•

### 2.1 P0ï¼ˆå¿…é¡»é—­ç¯ï¼Œå¦åˆ™ç³»ç»Ÿåªæ˜¯æ‹¼å›¾ï¼‰

#### ç¼ºå£1ï¼šBarClosedEventçš„å®Œæ•´è¯­ä¹‰ä¸å‘å¸ƒç­–ç•¥

**å½“å‰çŠ¶æ€**ï¼š
- âœ… äº‹ä»¶ç±»å·²å®šä¹‰ï¼ˆ`BarClosedEvent.java`ï¼‰
- âœ… å­—æ®µå·²æ˜ç¡®ï¼ˆtradingPairId, symbol, timeframe, barCloseTimeç­‰ï¼‰
- âš ï¸ **ç¼ºå°‘**ï¼šå¹‚ç­‰é”®å®šä¹‰ã€äº‹ä»¶åºåˆ—å·ã€å‘å¸ƒç­–ç•¥æ–‡æ¡£

**å¿…é¡»è¡¥é½**ï¼š
1. **å¹‚ç­‰é”®å®šä¹‰**ï¼šå¦‚ä½•å”¯ä¸€æ ‡è¯†ä¸€ä¸ªBarClosedEventï¼Ÿ
   - å»ºè®®ï¼š`(tradingPairId, timeframe, barCloseTime)` ä¸‰å…ƒç»„
2. **äº‹ä»¶åºåˆ—å·**ï¼šæ˜¯å¦éœ€è¦sequenceå­—æ®µé˜²æ­¢ä¹±åºï¼Ÿ
   - å»ºè®®ï¼šå¯é€‰ï¼Œä½†å»ºè®®æ·»åŠ ç”¨äºè°ƒè¯•
3. **å‘å¸ƒç­–ç•¥æ–‡æ¡£**ï¼šæ˜ç¡®å“ªäº›å‘¨æœŸå‘å¸ƒã€å‘å¸ƒæ—¶æœºã€é‡å¤å‘å¸ƒå¤„ç†

**å½±å“**ï¼šå¦‚æœä¸æ˜ç¡®ï¼ŒæŒ‡æ ‡è®¡ç®—å¯èƒ½å‡ºç°é‡å¤è®¡ç®—æˆ–é—æ¼

---

#### ç¼ºå£2ï¼šæŒ‡æ ‡è®¡ç®—çš„å¹‚ç­‰è½åº“ä¸å†²çªæ£€æµ‹ç­–ç•¥

**å½“å‰çŠ¶æ€**ï¼š
- âœ… `indicator_value`è¡¨æœ‰å”¯ä¸€ç´¢å¼•
- âœ… `CalcFingerprint`å·²å®ç°
- âœ… `IndicatorCalculator`å·²å®ç°å†²çªæ£€æµ‹é€»è¾‘

**å¿…é¡»è¡¥é½**ï¼š
1. **å†²çªæ£€æµ‹ç­–ç•¥æ–‡æ¡£**ï¼šè¯¦ç»†è¯´æ˜ä»€ä¹ˆæƒ…å†µä¸‹ç®—CONFLICT
2. **å†²çªå¤„ç†è§„åˆ™**ï¼šæ˜¯å¦è¦†ç›–ï¼Ÿæ˜¯å¦è®°å½•æ—¥å¿—ï¼Ÿæ˜¯å¦å‘Šè­¦ï¼Ÿ
3. **æ•°æ®è´¨é‡æ ‡è®°è§„åˆ™**ï¼šä½•æ—¶æ ‡è®°PARTIAL/INVALIDï¼Ÿ

**å½“å‰ä»£ç é€»è¾‘**ï¼ˆåŸºäºIndicatorCalculator.javaï¼‰ï¼š
```java
// å†™å…¥ä½¿ç”¨insert ignore
WriteResult result = valueRepository.insertIgnore(value);

// å¦‚æœå†™å…¥å¤±è´¥ï¼ˆå†²çªï¼‰ï¼Œæ£€æµ‹æŒ‡çº¹
if (result == WriteResult.IGNORED) {
    IndicatorValue existing = valueRepository.findOneKey(...);
    if (!fingerprint.equals(existing.getCalcFingerprint())) {
        // è®°å½•CONFLICTæ—¥å¿—
        calcLog.setCalcStatus(FAILED);
        calcLog.setErrorMsg("CONFLICT: fingerprint mismatch");
    }
}
```

**å¿…é¡»æ–‡æ¡£åŒ–**ï¼šè¿™ä¸ªé€»è¾‘éœ€è¦å†™å…¥æ–‡æ¡£ï¼Œæ˜ç¡®å†²çªç­–ç•¥

---

#### ç¼ºå£3ï¼šBarSeriesManagerçš„å†…å­˜ç”Ÿå‘½å‘¨æœŸè§„åˆ™
**å½“å‰çŠ¶æ€**ï¼š
- âœ… `BarSeriesManager`å·²å®ç°
- âš ï¸ **ç¼ºå°‘**ï¼šå†…å­˜ä¸Šé™ã€æ·˜æ±°ç­–ç•¥ã€ç¼ºBarå¤„ç†è§„åˆ™

**å¿…é¡»è¡¥é½**ï¼š
1. **å†·å¯åŠ¨åŠ è½½è§„åˆ™**ï¼š
   - å½“å‰ä»£ç ï¼šåŠ è½½æœ€è¿‘365æ ¹ï¼ˆ`QuestDbKlineReader`ï¼‰
   - æ˜¯å¦å¯é…ç½®ï¼Ÿæ˜¯å¦éœ€è¦æ ¹æ®æŒ‡æ ‡min_required_barsåŠ¨æ€è°ƒæ•´ï¼Ÿ
2. **å†…å­˜ä¸Šé™è§„åˆ™**ï¼š
   - æ¯ä¸ªpair+timeframeä¿ç•™å¤šå°‘æ ¹Barï¼Ÿ
   - æ˜¯å¦å®ç°LRUæ·˜æ±°ï¼Ÿ
3. **ç¼ºBarå¤„ç†è§„åˆ™**ï¼š
   - å¦‚æœQuestDBç¼ºå°‘æŸæ ¹Barï¼Œ`data_quality`å¦‚ä½•æ ‡è®°ï¼Ÿ
   - æ˜¯å¦è§¦å‘æ ¡å‡†ä»»åŠ¡ï¼Ÿ

**å½±å“**ï¼šå¦‚æœä¸æ˜ç¡®ï¼Œå¯èƒ½å‡ºç°å†…å­˜æº¢å‡ºæˆ–æŒ‡æ ‡è®¡ç®—é”™è¯¯

---

### 2.2 P1ï¼ˆç³»ç»Ÿå¯è§‚æµ‹ã€å¯è¿ç»´ï¼‰

#### ç¼ºå£4ï¼šæŒ‡æ ‡è®¡ç®—Metricsä¸æ—¥å¿—ç»“æ„åŒ–

**å½“å‰çŠ¶æ€**ï¼š
- âœ… `IndicatorMetrics`å·²å®šä¹‰ï¼ˆcost_ms, fail_count, conflict_countï¼‰
- âœ… ç»“æ„åŒ–æ—¥å¿—å·²ä½¿ç”¨MDC
- âš ï¸ **ç¼ºå°‘**ï¼šMetricså¯¼å‡ºé…ç½®æ–‡æ¡£ã€æ—¥å¿—å­—æ®µæ¸…å•

**å¿…é¡»è¡¥é½**ï¼š
1. **Metricså¯¼å‡º**ï¼šå¦‚ä½•æŸ¥çœ‹ï¼ŸPrometheusç«¯ç‚¹ï¼ŸGrafanaé¢æ¿ï¼Ÿ
2. **æ—¥å¿—å­—æ®µæ¸…å•**ï¼šMDCä¸­åŒ…å«å“ªäº›å­—æ®µï¼Ÿæ ¼å¼è§„èŒƒï¼Ÿ

---

#### ç¼ºå£5ï¼šæ ¡å‡†ä»»åŠ¡ä¸æŒ‡æ ‡æ•°æ®è´¨é‡è”åŠ¨

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æ ¡å‡†ä»»åŠ¡å·²å®ç°ï¼ˆç¼ºå¤±æ£€æµ‹ã€æ•°æ®æ ¸å¯¹ï¼‰
- âŒ **ç¼ºå°‘**ï¼šæ ¡å‡†å‘ç°ç¼ºå£åï¼Œå¦‚ä½•è”åŠ¨æŒ‡æ ‡æ¨¡å—ï¼Ÿ

**å¿…é¡»è¡¥é½**ï¼š
1. **è”åŠ¨è§„åˆ™**ï¼šæ ¡å‡†å‘ç°ç¼ºå¤±Kçº¿ â†’ è¡¥å…¨å â†’ æ˜¯å¦è§¦å‘æŒ‡æ ‡é‡ç®—ï¼Ÿ
2. **è´¨é‡æ ‡è®°**ï¼šæ ¡å‡†å‘ç°çš„å¼‚å¸¸æ•°æ®ï¼Œå¦‚ä½•æ ‡è®°åˆ°`indicator_value.data_quality`ï¼Ÿ
3. **è¡¥ç®—ä»»åŠ¡**ï¼šæ˜¯å¦éœ€è¦ç‹¬ç«‹çš„"æŒ‡æ ‡è¡¥ç®—ä»»åŠ¡"ï¼Ÿ

---

### 2.3 P2ï¼ˆç­–ç•¥é˜¶æ®µ2ï¼šå†³ç­–ç”Ÿæˆï¼‰

#### ç¼ºå£6ï¼šStrategyRuntimeçš„æ¶ˆè´¹è§„åˆ™

**å½“å‰çŠ¶æ€**ï¼š
- âŒ StrategyRuntimeæœªå®ç°

**å¿…é¡»æ˜ç¡®**ï¼š
1. **æ¶ˆè´¹æ¨¡å¼**ï¼šå¦‚ä½•æ¶ˆè´¹Signalå’ŒIndicatorï¼Ÿ
   - è½®è¯¢ï¼Ÿäº‹ä»¶é©±åŠ¨ï¼Ÿ
2. **æ•°æ®æº**ï¼š
   - Signalï¼šä»`signal`è¡¨æŸ¥è¯¢ï¼Ÿè¿˜æ˜¯è®¢é˜…SignalReceivedEventï¼Ÿ
   - Indicatorï¼šè°ƒç”¨`IndicatorController` APIï¼Ÿè¿˜æ˜¯ç›´æ¥æŸ¥è¡¨ï¼Ÿ
3. **å†³ç­–æ—¶æœº**ï¼šä½•æ—¶è§¦å‘å†³ç­–ï¼Ÿå®šæ—¶ï¼Ÿäº‹ä»¶è§¦å‘ï¼Ÿ

---

## ä¸‰ã€äº‹ä»¶å¥‘çº¦å®šä¹‰

### 3.1 BarClosedEventå¥‘çº¦

**äº‹ä»¶ç±»**ï¼š`com.qyl.v2trade.indicator.domain.event.BarClosedEvent`

**å­—æ®µåˆ—è¡¨**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `tradingPairId` | Long | âœ… | äº¤æ˜“å¯¹IDï¼ˆç³»ç»Ÿå†…éƒ¨å¼•ç”¨ï¼‰ |
| `symbol` | String | âœ… | äº¤æ˜“å¯¹ç¬¦å·ï¼ˆå¦‚ï¼šBTC-USDT-SWAPï¼‰ |
| `timeframe` | String | âœ… | Kçº¿å‘¨æœŸï¼ˆ5m/15m/30m/1h/4hï¼Œä¸æ”¯æŒ1mï¼‰ |
| `barCloseTime` | LocalDateTime | âœ… | Kçº¿æ”¶ç›˜æ—¶é—´ï¼ˆbar_close_timeï¼ŒUTCï¼‰ |
| `open` | BigDecimal | âœ… | å¼€ç›˜ä»· |
| `high` | BigDecimal | âœ… | æœ€é«˜ä»· |
| `low` | BigDecimal | âœ… | æœ€ä½ä»· |
| `close` | BigDecimal | âœ… | æ”¶ç›˜ä»· |
| `volume` | BigDecimal | âœ… | æˆäº¤é‡ |
| `sourceCount` | int | âœ… | èšåˆä½¿ç”¨çš„æºKçº¿æ•°é‡ï¼ˆ5m=5ï¼Œ15m=15ç­‰ï¼‰ |
| `eventTime` | LocalDateTime | âœ… | äº‹ä»¶äº§ç”Ÿæ—¶é—´ï¼ˆæœ¬åœ°æ—¶é—´ï¼Œç”¨äºè°ƒè¯•ï¼‰ |

**å¹‚ç­‰é”®å®šä¹‰**ï¼š
```
å”¯ä¸€æ ‡è¯†ï¼š(tradingPairId, timeframe, barCloseTime)
```

**å‘å¸ƒç­–ç•¥**ï¼š
1. **å‘å¸ƒæ—¶æœº**ï¼šKçº¿èšåˆå®Œæˆåç«‹å³å‘å¸ƒ
2. **å‘å¸ƒå‘¨æœŸ**ï¼šä»…5mã€15mã€30mã€1hã€4hï¼ˆä¸æ”¯æŒ1mï¼‰
3. **é‡å¤å‘å¸ƒ**ï¼šç†è®ºä¸Šä¸åº”é‡å¤ï¼Œä½†å¹‚ç­‰é”®ä¿è¯ä¸ä¼šé‡å¤è®¡ç®—
4. **å‘å¸ƒé¡ºåº**ï¼šæŒ‰æ—¶é—´é¡ºåºå‘å¸ƒï¼ˆbarCloseTimeé€’å¢ï¼‰

**äº‹ä»¶åºåˆ—**ï¼ˆå¯é€‰ï¼Œå»ºè®®æ·»åŠ ï¼‰ï¼š
- å½“å‰æœªå®ç°sequenceå­—æ®µ
- å»ºè®®ï¼šæ·»åŠ `long sequence`å­—æ®µï¼Œç”¨äºè°ƒè¯•å’Œä¹±åºæ£€æµ‹

---

### 3.2 KlineEventå¥‘çº¦
**äº‹ä»¶ç±»**ï¼š`com.qyl.v2trade.market.model.event.KlineEvent`

**å­—æ®µåˆ—è¡¨**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `symbol` | String | âœ… | äº¤æ˜“å¯¹ç¬¦å· |
| `interval` | String | âœ… | å‘¨æœŸï¼ˆå½“å‰åªæ”¯æŒ1mï¼‰ |
| `timestamp` | Long | âœ… | Kçº¿æ—¶é—´æˆ³ï¼ˆUTCæ¯«ç§’ï¼‰ |
| `open` | BigDecimal | âœ… | å¼€ç›˜ä»· |
| `high` | BigDecimal | âœ… | æœ€é«˜ä»· |
| `low` | BigDecimal | âœ… | æœ€ä½ä»· |
| `close` | BigDecimal | âœ… | æ”¶ç›˜ä»· |
| `volume` | BigDecimal | âœ… | æˆäº¤é‡ |

**å¹‚ç­‰é”®å®šä¹‰**ï¼š
```
å”¯ä¸€æ ‡è¯†ï¼š(symbol, interval, timestamp)
```

**å‘å¸ƒç­–ç•¥**ï¼š
1. **å‘å¸ƒæ—¶æœº**ï¼šWebSocketæ¥æ”¶åˆ°Kçº¿æ•°æ®åç«‹å³å‘å¸ƒ
2. **å‘å¸ƒå‘¨æœŸ**ï¼šå½“å‰åªæ”¯æŒ1m
3. **æ¶ˆè´¹è€…**ï¼šMarketDataCenterï¼ˆå†™å…¥QuestDBï¼‰

---

## å››ã€æ—¶é—´è¯­ä¹‰è§„èŒƒ

### 4.1 æ—¶é—´åŸºå‡†

**ç³»ç»Ÿå”¯ä¸€æ—¶é—´åŸºå‡†**ï¼šUTCï¼ˆåè°ƒä¸–ç•Œæ—¶ï¼‰

- æ‰€æœ‰æ•°æ®åº“æ—¶é—´å­—æ®µä½¿ç”¨UTC
- æ‰€æœ‰äº‹ä»¶æ—¶é—´æˆ³ä½¿ç”¨UTC
- ç”¨æˆ·è¾“å…¥çš„æ—¶é—´å­—ç¬¦ä¸²ç›´æ¥å½“ä½œUTCå¤„ç†ï¼ˆä¸è¿›è¡Œæ—¶åŒºè½¬æ¢ï¼‰

---

### 4.2 QuestDBæ—¶é—´è¯­ä¹‰

**è¡¨ç»“æ„**ï¼š`kline_1m`, `kline_5m`, `kline_15m`, `kline_30m`, `kline_1h`, `kline_4h`

**tså­—æ®µè¯­ä¹‰**ï¼š
```
ts = bar_open_timeï¼ˆKçº¿å¼€ç›˜æ—¶é—´ï¼ŒUTCï¼‰
```

**ç¤ºä¾‹**ï¼š
```
1åˆ†é’ŸKçº¿ï¼š
- ts = 2026-01-06 10:00:00ï¼ˆUTCï¼‰â†’ è¡¨ç¤º10:00:00-10:01:00è¿™æ ¹Kçº¿

5åˆ†é’ŸKçº¿ï¼š
- ts = 2026-01-06 10:00:00ï¼ˆUTCï¼‰â†’ è¡¨ç¤º10:00:00-10:05:00è¿™æ ¹Kçº¿

1å°æ—¶Kçº¿ï¼š
- ts = 2026-01-06 10:00:00ï¼ˆUTCï¼‰â†’ è¡¨ç¤º10:00:00-11:00:00è¿™æ ¹Kçº¿
```

---

### 4.3 MySQLæ—¶é—´è¯­ä¹‰

**indicator_value.bar_timeå­—æ®µè¯­ä¹‰**ï¼š
```
bar_time = bar_close_timeï¼ˆKçº¿æ”¶ç›˜æ—¶é—´ï¼ŒUTCï¼‰
```

**è½¬æ¢å…¬å¼**ï¼š

```
å¯¹äº1åˆ†é’ŸKçº¿ï¼š
bar_close_time = bar_open_time + 1åˆ†é’Ÿ

å¯¹äº5åˆ†é’ŸKçº¿ï¼š
bar_close_time = bar_open_time + 5åˆ†é’Ÿ

å¯¹äº15åˆ†é’ŸKçº¿ï¼š
bar_close_time = bar_open_time + 15åˆ†é’Ÿ

å¯¹äº30åˆ†é’ŸKçº¿ï¼š
bar_close_time = bar_open_time + 30åˆ†é’Ÿ

å¯¹äº1å°æ—¶Kçº¿ï¼š
bar_close_time = bar_open_time + 1å°æ—¶

å¯¹äº4å°æ—¶Kçº¿ï¼š
bar_close_time = bar_open_time + 4å°æ—¶
```

**Javaä»£ç å®ç°**ï¼ˆç¤ºä¾‹ï¼‰ï¼š
```java
// ä»QuestDB tsï¼ˆå¼€ç›˜æ—¶é—´ï¼‰è½¬æ¢ä¸ºæ”¶ç›˜æ—¶é—´
public static LocalDateTime toBarCloseTime(LocalDateTime barOpenTime, String timeframe) {
    int minutes = parseTimeframeToMinutes(timeframe);
    return barOpenTime.plusMinutes(minutes);
}

// è§£æå‘¨æœŸä¸ºåˆ†é’Ÿæ•°
private static int parseTimeframeToMinutes(String timeframe) {
    return switch (timeframe) {
        case "1m" -> 1;
        case "5m" -> 5;
        case "15m" -> 15;
        case "30m" -> 30;
        case "1h" -> 60;
        case "4h" -> 240;
        default -> throw new IllegalArgumentException("Unsupported timeframe: " + timeframe);
    };
}
```

---

### 4.4 æ—¶é—´å¯¹é½è§„åˆ™
**Kçº¿æ—¶é—´å¿…é¡»å¯¹é½åˆ°å‘¨æœŸèµ·å§‹ç‚¹**ï¼š

```
1åˆ†é’ŸKçº¿ï¼šå¯¹é½åˆ°åˆ†é’Ÿï¼ˆç§’ã€æ¯«ç§’ä¸º0ï¼‰
- æ­£ç¡®ï¼š2026-01-06 10:00:00
- é”™è¯¯ï¼š2026-01-06 10:00:15

5åˆ†é’ŸKçº¿ï¼šå¯¹é½åˆ°5åˆ†é’Ÿå€æ•°ï¼ˆåˆ†é’Ÿ%5=0ï¼Œç§’ã€æ¯«ç§’ä¸º0ï¼‰
- æ­£ç¡®ï¼š2026-01-06 10:00:00, 10:05:00, 10:10:00
- é”™è¯¯ï¼š2026-01-06 10:03:00

1å°æ—¶Kçº¿ï¼šå¯¹é½åˆ°å°æ—¶ï¼ˆåˆ†é’Ÿã€ç§’ã€æ¯«ç§’ä¸º0ï¼‰
- æ­£ç¡®ï¼š2026-01-06 10:00:00, 11:00:00
- é”™è¯¯ï¼š2026-01-06 10:30:00
```

**ä»£ç å®ç°**ï¼ˆPeriodCalculator.alignTimestampï¼‰ï¼š
```java
public static LocalDateTime alignTimestamp(LocalDateTime timestamp, String timeframe) {
    int minutes = parseTimeframeToMinutes(timeframe);
    LocalDateTime aligned = timestamp
        .withSecond(0)
        .withNano(0);
    
    if (minutes >= 60) {
        // å°æ—¶çº§åˆ«ï¼šå¯¹é½åˆ°å°æ—¶
        aligned = aligned.withMinute(0);
    } else {
        // åˆ†é’Ÿçº§åˆ«ï¼šå¯¹é½åˆ°å‘¨æœŸå€æ•°
        int minute = aligned.getMinute();
        int alignedMinute = (minute / minutes) * minutes;
        aligned = aligned.withMinute(alignedMinute);
    }
    
    return aligned;
}
```

---

### 4.5 æ—¶é—´è¯­ä¹‰è½¬æ¢ç¤ºä¾‹

**åœºæ™¯**ï¼šä»QuestDBè¯»å–1å°æ—¶Kçº¿ï¼Œç”¨äºæŒ‡æ ‡è®¡ç®—

```
1. QuestDBæŸ¥è¯¢ç»“æœï¼š
   symbol: BTC-USDT
   ts: 2026-01-06 10:00:00ï¼ˆUTCï¼Œå¼€ç›˜æ—¶é—´ï¼‰
   open: 50000.0
   high: 51000.0
   low: 49000.0
   close: 50500.0
   volume: 100.5

2. è½¬æ¢ä¸ºNormalizedBarï¼š
   tradingPairId: 1
   symbol: BTC-USDT
   timeframe: "1h"
   barTime: 2026-01-06 11:00:00ï¼ˆUTCï¼Œæ”¶ç›˜æ—¶é—´ = å¼€ç›˜æ—¶é—´ + 1å°æ—¶ï¼‰
   open: 50000.0
   high: 51000.0
   low: 49000.0
   close: 50500.0
   volume: 100.5

3. å‘å¸ƒBarClosedEventï¼š
   barCloseTime: 2026-01-06 11:00:00ï¼ˆUTCï¼‰
   ï¼ˆå…¶ä»–å­—æ®µåŒä¸Šï¼‰

4. å†™å…¥indicator_valueï¼š